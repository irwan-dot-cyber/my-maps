<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Order Desain Kaos â€¢ List</title>
<style>
  :root{--bg:#0f1115;--card:#171922;--fg:#e8eefc;--muted:#9aa7c7;--line:#23283a}
  *{box-sizing:border-box} body{margin:0;background:#0f1115;color:var(--fg);font:500 15px/1.55 system-ui,Segoe UI,Inter,Arial}
  .wrap{max-width:1200px;margin:auto;padding:22px}
  h1{font:800 20px/1.2;margin:0}
  .formbox{background:#171922;border:1px solid var(--line);border-radius:12px;padding:12px;margin:16px 0;display:flex;flex-wrap:wrap;gap:12px}
  .formbox input{flex:1;min-width:180px;padding:10px 12px;border-radius:8px;border:1px solid #26304f;background:#0f1320;color:var(--fg)}
  .btn{border:1px solid #26304f;background:#0f1320;color:#dce6ff;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.4;cursor:not-allowed}
  .card{background:#171922;border:1px solid var(--line);border-radius:14px;padding:10px 12px}
  .table{width:100%;border-collapse:collapse}
  .th,.td{padding:12px;border-bottom:1px solid var(--line);vertical-align:middle}
  .th{color:#aab6da;text-transform:uppercase;font-size:12px}
  .row:last-child .td{border-bottom:none}
  .no{width:56px;text-align:center}
  .title{font-weight:800}
  .thumb{width:120px;height:120px;border-radius:10px;overflow:hidden;background:#0e1018;border:1px solid var(--line);display:grid;place-items:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .pick{text-align:center;width:90px}
  .disabled-note{font-size:12px;color:#ff9b9b;margin-top:6px}
  /* keranjang */
  .cart-panel{position:fixed;inset:0 0 0 auto;max-width:420px;transform:translateX(110%);transition:.25s ease;background:#0f1115;border-left:1px solid #26304f;box-shadow:-10px 0 30px rgba(0,0,0,.5);z-index:50;display:flex;flex-direction:column}
  .cart-panel.open{transform:translateX(0)}
  .cart-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid #26304f}
  .cart-body{padding:12px;overflow:auto;flex:1}
  .cart-row{display:grid;grid-template-columns:64px 1fr 70px;gap:10px;align-items:center;padding:10px 0;border-bottom:1px dashed #2b3350}
  .cart-thumb{width:64px;height:64px;border-radius:10px;overflow:hidden;border:1px solid #26304f;background:#101422}
  .cart-thumb img{width:100%;height:100%;object-fit:cover}
  .cart-foot{padding:12px;border-top:1px solid #26304f}
  .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;margin-bottom:10px}
  .btn-primary{background:linear-gradient(135deg,#3b82f6,#22c55e);border:none;color:#fff;width:100%}
  .xbtn{cursor:pointer;color:#ff9b9b;border:1px solid #5b2b2b;background:#1a0d0d;border-radius:8px;padding:6px 8px;width:100%}
  @media (max-width:760px){
    thead{display:none}
    .table, tbody, .row, .td{display:block;width:100%}
    .row{border:1px solid var(--line);border-radius:12px;margin:10px 0}
    .td{border-bottom:1px solid var(--line)}
    .td:last-child{border-bottom:none}
    .td[data-label]::before{content:attr(data-label);display:block;color:#aab6da;font-size:12px;margin-bottom:6px}
    .thumb{width:100%;height:0;padding-bottom:60%;position:relative}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Order Desain Kaos</h1>

  <!-- form identitas -->
  <div class="formbox">
    <input id="nama" placeholder="Nama Pemesan" />
    <input id="telp" placeholder="No. Telp / WA" />
    <button id="cartBtn" class="btn" style="margin-left:auto">ðŸ§º Keranjang</button>
  </div>

  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th class="th no">No</th>
          <th class="th">Judul</th>
          <th class="th">Gambar Belakang</th>
          <th class="th pick">Pilih</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</div>

<!-- panel keranjang -->
<aside id="cartPanel" class="cart-panel">
  <div class="cart-head">
    <strong>Pesanan</strong>
    <button id="closeCart" class="btn">Tutup</button>
  </div>
  <div id="cartBody" class="cart-body"></div>
  <div class="cart-foot">
    <div class="total"><span>Total</span><span id="grand">Rp 0</span></div>
    <button id="submitBtn" class="btn btn-primary">Submit & Cetak PDF + WA</button>
  </div>
</aside>

<script>
const SETS=[
  {id:"set-nothing", title:"Nothing is Imposible", back:"./gambar/Nothing_Back.png"},
  {id:"set-zenius", title:"Zenius Street Logo", back:"./gambar/Zenius_Back.png"}
];
const PRICE=30000;
const SCRIPT_URL="https://script.google.com/macros/s/AKfycby20E4jQz5pGqSn0atadu1QGSVaUVXStt8GYiNnBlKvr-eyU-fz7cJJXRxxQqKkMLDSLw/exec"; // ganti URL Apps Script kamu
let USER_KEY=null;

const lsKey=()=>`orderCart_${USER_KEY}`;
const loadCart=()=>JSON.parse(localStorage.getItem(lsKey())||"{}");
const saveCart=(c)=>localStorage.setItem(lsKey(),JSON.stringify(c));
const formatIDR=n=>new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n);

/* render list */
const tbody=document.getElementById("tbody");
function render(){
  const cart=USER_KEY?loadCart():{};
  tbody.innerHTML="";
  SETS.forEach((s,i)=>{
    if(cart[s.id]) return;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="td no">${i+1}</td>
      <td class="td"><div class="title">${s.title}</div><div style="color:#9aa7c7">ID: ${s.id}</div></td>
      <td class="td"><div class="thumb"><img src="${s.back}"></div></td>
      <td class="td pick">
        <input type="checkbox" data-id="${s.id}" ${USER_KEY?"":"disabled"}>
        ${USER_KEY?"":"<div class='disabled-note'>Isi identitas dulu</div>"}
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    cb.onchange=()=>{
      const id=cb.dataset.id;
      const cart=loadCart();
      if(cb.checked){cart[id]={qty:1,price:PRICE};saveCart(cart);render();}
    };
  });
}

/* validasi identitas */
function validTelp(t){return /^\d{10,15}$/.test(t);}
document.getElementById("nama").oninput=document.getElementById("telp").oninput=()=>{
  const nama=document.getElementById("nama").value.trim();
  const telp=document.getElementById("telp").value.trim();
  if(nama && validTelp(telp)){
    USER_KEY=nama.replace(/\s+/g,"_")+"_"+telp;
  }else{USER_KEY=null;}
  render();
};

/* keranjang */
const cartPanel=document.getElementById("cartPanel");
document.getElementById("cartBtn").onclick=()=>{renderCart();cartPanel.classList.add("open");};
document.getElementById("closeCart").onclick=()=>cartPanel.classList.remove("open");

function renderCart(){
  const cart=USER_KEY?loadCart():{};
  const body=document.getElementById("cartBody"); body.innerHTML=""; let total=0;
  Object.entries(cart).forEach(([id,{qty,price}])=>{
    const s=SETS.find(x=>x.id===id); total+=qty*price;
    const div=document.createElement("div"); div.className="cart-row";
    div.innerHTML=`
      <div class="cart-thumb"><img src="${s.back}"></div>
      <div><div style="font-weight:800">${s.title}</div><div style="color:#9aa7c7">Qty: ${qty} Ã— ${formatIDR(price)}</div></div>
      <div><button class="xbtn" data-del="${id}">Hapus</button></div>`;
    body.appendChild(div);
  });
  if(!Object.keys(cart).length) body.innerHTML="<p style='color:#9aa7c7'>Keranjang kosong</p>";
  document.getElementById("grand").textContent=formatIDR(total);
  body.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>{const id=b.dataset.del;const cart=loadCart();delete cart[id];saveCart(cart);render();renderCart();});
}

/* submit */
document.getElementById("submitBtn").onclick=()=>{
  if(!USER_KEY){alert("Isi identitas dulu!");return;}
  const cart=loadCart(); if(!Object.keys(cart).length){alert("Keranjang kosong");return;}
  const [nama,telp]=USER_KEY.split("_");
  const now=new Date();
  const grand=Object.values(cart).reduce((a,c)=>a+c.qty*c.price,0);
  const noBon="BON-"+now.getFullYear().toString().slice(-2)+(now.getMonth()+1).toString().padStart(2,"0")+now.getDate().toString().padStart(2,"0")+"-"+Math.random().toString(36).slice(2,7).toUpperCase();

  // 1) WA message
  let pesan=`Pesanan Baru ðŸš¨%0ANama: ${nama}%0ATelp: ${telp}%0ATanggal: ${now.toLocaleString('id-ID')}%0A%0A`;
  Object.entries(cart).forEach(([id,{qty,price}],i)=>{
    const s=SETS.find(x=>x.id===id);
    pesan+=`${i+1}. ${s.title} â€“ ${qty} x ${formatIDR(price)}%0A`;
  });
  pesan+=`%0ATotal: ${formatIDR(grand)}`;
  window.open(`https://wa.me/6281219929245?text=${pesan}`,"_blank"); // ganti nomor WA kamu

  // 2) Bon PDF
  let rows=Object.entries(cart).map(([id,{qty,price}],i)=>{
    const s=SETS.find(x=>x.id===id);
    return `<tr><td>${i+1}</td><td>${s.title}</td><td>${qty}</td><td>${formatIDR(price)}</td><td>${formatIDR(qty*price)}</td></tr>`;
  }).join("");
  const html=`<!doctype html><html><head><meta charset="utf-8"><title>${noBon}</title>
  <style>body{font-family:Arial;margin:24px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:6px}</style>
  </head><body><h2>Bon Pesanan</h2><p>No: ${noBon}<br>Nama: ${nama}<br>Telp: ${telp}<br>Tanggal: ${now.toLocaleString('id-ID')}</p>
  <table><tr><th>No</th><th>Judul</th><th>Qty</th><th>Harga</th><th>Subtotal</th></tr>${rows}
  <tr><td colspan=4 style="text-align:right"><b>Total</b></td><td><b>${formatIDR(grand)}</b></td></tr></table>
  <script>window.print();<\/script></body></html>`;
  const w=window.open("","_blank"); w.document.write(html); w.document.close();

  // 3) Save ke Google Sheet
  const items=Object.entries(cart).map(([id,{qty,price}])=>{
    const s=SETS.find(x=>x.id===id);
    return {id,title:s.title,qty,price,subtotal:qty*price};
  });
  fetch(SCRIPT_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({noBon,nama,telp,items,total:grand,source:"order_design.html"})
  }).then(r=>r.json()).then(res=>{if(!res.ok)console.warn("GAS save fail",res);})
  .catch(err=>console.warn("GAS error",err))
  .finally(()=>{
    localStorage.removeItem(lsKey()); render(); renderCart();
  });
};

render();
</script>
</body>
</html>
