<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Jaringan Jalan Kabupaten Bombana</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0}
  #header { background:#FFD700; color:#000; padding:10px; display:flex; align-items:center; font-weight:700; font-size:14px }
  #header img {height:40px; margin-right:10px}
  #map {height:calc(100% - 120px)}
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc }
  #hit { background:#fff; padding:8px; font-size:12px; border-top:1px solid #eee; color:#444 }

  .top-controls { position:absolute; top:60px; left:60px; right:10px; display:flex; gap:10px; z-index:1000; flex-wrap:wrap }
  .search-box { background:#fff; padding:6px 36px 6px 6px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.25); position:relative }
  .search-box input { width:300px; max-width:60vw; padding:6px 8px; border:1px solid #ddd; border-radius:4px }
  .search-box button.clear-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:22px; height:22px; border:none; border-radius:999px; cursor:pointer;
    background:#eee; font-weight:700; line-height:1; display:none;
  }
  .search-box button.clear-btn:hover{ background:#e2e2e2 }
  #suggestions { position:absolute; top:46px; left:0; right:0; background:#fff; border:1px solid #ddd; max-height:240px; overflow-y:auto; display:none; z-index:2000 }
  #suggestions div { padding:6px 8px; cursor:pointer }
  #suggestions div:hover { background:#eee }

  /* legend swatches */
  .swatch { display:inline-block; width:18px; height:0; margin-right:6px; vertical-align:middle; border-bottom:4px solid #e53935; }
  .swatch-box{display:inline-block; width:14px; height:14px; border-radius:3px; margin-right:6px; border:1px solid rgba(0,0,0,.15); vertical-align:middle}
  .badge{display:inline-block; min-width:18px; padding:0 6px; margin-left:6px; border-radius:999px;
         font-weight:700; font-size:11px; line-height:18px; text-align:center; color:#111; background:#ffd86a}

  /* labels */
  .leaflet-tooltip.label-road{
    font-weight:700; color:#111;
    background:rgba(255,255,255,.9);
    border:1px solid #ddd; padding:2px 4px;
  }
  .leaflet-tooltip.label-forest{
    font-weight:700; color:#9aa3ad;
    background:transparent; border:none; padding:0 2px;
    text-shadow:
      -1px  0   2px #fff,
       1px  0   2px #fff,
       0    1px 2px #fff,
       0   -1px 2px #fff,
       0    0   4px rgba(0,0,0,.25);
  }

  /* layer control pos a bit lower (mobile friendly) */
  .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 70px; }

  /* unified legend panel (bottom-right) */
  .legend-unified{
    background:rgba(33,33,33,.92); color:#fff;
    border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.35);
    font-size:12px; line-height:1.6; max-width:300px; overflow:hidden;
  }
  .legend-unified .head{
    display:flex; align-items:center; justify-content:space-between;
    gap:8px; padding:8px 10px; background:rgba(0,0,0,.25); font-weight:800;
  }
  .legend-unified .btn{
    width:24px; height:24px; border-radius:6px; border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08); color:#fff; cursor:pointer; font-weight:900;
    display:flex; align-items:center; justify-content:center;
  }
  .legend-unified .body{ padding:8px 10px; max-height:280px; overflow:auto; }
  .legend-unified .grp{ margin-bottom:8px; }
  .legend-unified .grp b{ display:block; margin-bottom:4px; color:#ffd86a; }
  .legend-unified .row{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* FAB show legend */
  .legend-fab{
    position:absolute; right:16px; bottom:16px; z-index:900;
    background:rgba(33,33,33,.92); color:#fff; border:1px solid rgba(255,255,255,.25);
    border-radius:999px; padding:10px 14px; font-weight:800; font-size:12px;
    display:none; box-shadow:0 6px 20px rgba(0,0,0,.35); cursor:pointer;
  }

  /* LAYERS toggle button (top-right) */
  .layers-fab{
    position:absolute; right:10px; top:60px; z-index:1001;
    background:rgba(33,33,33,.92); color:#fff; border:1px solid rgba(255,255,255,.25);
    border-radius:8px; padding:6px 10px; font-weight:800; font-size:12px;
    cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,.35);
  }

  /* default collapsed on narrow screens */
  @media (max-width: 640px){
    .legend-unified .body{ display:none; }
  }

  .error-banner{position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#ffefef; color:#b00020; padding:6px 10px; border:1px solid #f5c2c2; border-radius:6px; z-index:2000; display:none}
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  WEBGIS JARINGAN JALAN - DINAS PEKERJAAN UMUM KABUPATEN BOMBANA
</div>

<div class="top-controls">
  <div class="search-box">
    <input id="search" placeholder="Cari ruas (Nm_Ruas)..." oninput="onSearchInput(this.value)"/>
    <button id="clearBtn" class="clear-btn" title="Bersihkan" onclick="clearSearch()">×</button>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>
<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>
<div id="hit">Kunjungan halaman ini: <span id="hitCount">0</span> kali</div>
<div id="err" class="error-banner"></div>

<!-- floating buttons -->
<button id="legendFab" class="legend-fab">Legenda</button>
<button id="layersFab" class="layers-fab">Layer</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===== CONFIG =====
const URL_JALAN  = "KabupatenBombana_JaringanJalan.json";
const URL_HUTAN  = "Hutan_Bombana.geojson";
const DEFAULT_VIEW = [-4.74, 121.70];
const DEFAULT_ZOOM = 10;

// label rules
const ROAD_SHOW_SOME_ZOOM = 10, ROAD_SHOW_ALL_ZOOM = 16, ROAD_MAX_LABELS = 12;
const FOREST_SHOW_SOME_ZOOM = 9, FOREST_SHOW_ALL_ZOOM = 15, FOREST_MAX_LABELS = 8;
const MIN_LABEL_DIST_PX = 120, MIN_SCREEN_LEN_PX = 140;

// ===== MAP =====
const map = L.map('map', { zoomControl:true }).setView(DEFAULT_VIEW, DEFAULT_ZOOM);

// basemaps (default imagery)
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; OpenStreetMap'});
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'&copy; Esri, Maxar'}).addTo(map);
const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'&copy; Esri'});
const esriLabels  = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'&copy; Esri'});

// control (TOP-RIGHT)
const layerCtl = L.control.layers(
  { "Esri World Imagery (Citra)": esriImagery, "OSM Standard": osm, "Esri Topographic": esriTopo },
  {},
  { position:'topright', collapsed:false }
).addTo(map);
layerCtl.addOverlay(esriLabels, "Esri Labels (nama tempat)");

// panes: jalan di atas hutan
map.createPane('forestPane'); map.getPane('forestPane').style.zIndex = 410;
map.createPane('roadPane');   map.getPane('roadPane').style.zIndex   = 420;

// ===== UTIL =====
const prop = (o,k)=> (o&&o[k]!=null&&String(o[k]).trim()!=="")? String(o[k]).trim() : "";
function fetchJSON(url){ return fetch(url).then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status} — ${url}`); return r.json(); }); }
function showErr(msg){ const el=document.getElementById('err'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',4000); }
function weightByFungsi(f){ if(!f) return 3.5; const s=String(f).toLowerCase();
  if(/arteri\s*primer/.test(s)) return 6; if(/kolektor/.test(s)) return 4.5;
  if(/lingkungan\s*primer/.test(s)) return 4; if(/lokal\s*sekunder/.test(s)) return 3.5;
  if(/lingkungan\s*sekunder/.test(s)) return 2.8; return 3.5; }
function colorFromName(name){ const s=String(name||"Hutan").toLowerCase(); let h=0; for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))>>>0; return `hsl(${h%360} 60% 45%)`; }
function pickForestName(p){ return prop(p,"name")||prop(p,"Name")||prop(p,"NAMA")||"Hutan"; }
function haversine(lat1,lon1,lat2,lon2){ const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a)); }

// ===== LAYERS =====
const index = [];
let fullBounds = null;
const metas = [];        // jalan
const forestMetas = [];  // hutan
let roadLegendItems = [];   // strings with counts
let forestLegendItems = []; // strings with counts

const lines = L.geoJSON(null, {
  pane:'roadPane',
  style: f => ({ pane:'roadPane', color:"#e53935", weight:weightByFungsi((f.properties||{}).Fungsi), opacity:0.95 }),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    let nama = prop(p,"Nm_Ruas") || prop(p,"Nama") || prop(p,"name") || "Tanpa Nama";
    if(!/^(\s*Jl\.|\s*Jalan)/i.test(nama)) nama = "Jl. " + nama;

    const propinsi = prop(p,"Propinsi") || prop(p,"Provinsi") || "-";
    const status   = prop(p,"Status")   || "-";
    const fungsi   = prop(p,"Fungsi")   || "-";
    const panjang  = prop(p,"Panjang")  || prop(p,"Panjang_Km") || "";
    const thn      = prop(p,"Thn_Data") || "-";
    const mendukung= prop(p,"Mendukung")|| "-";
    const ura      = prop(p,"Ura_Dukung") || "-";
    const kabkot   = prop(p,"Kab_Kot") || "-";
    const kec      = prop(p,"Kecamatan") || "-";
    const desa     = prop(p,"Desa_Kel") || "-";

    let cLat=DEFAULT_VIEW[0], cLng=DEFAULT_VIEW[1];
    try{ const c=layer.getBounds().getCenter(); cLat=c.lat; cLng=c.lng; }catch(e){}
    const sv=`https://www.google.com/maps?cbll=${cLat},${cLng}&layer=c`;
    const mapUrl=`https://www.google.com/maps?q=${cLat},${cLng}&z=18`;

    layer.bindPopup(`
      <b>${nama}</b><br>
      Kabupaten/Kota: ${kabkot}<br>
      Propinsi: ${propinsi}<br>
      Status: ${status}<br>
      Fungsi: ${fungsi}<br>
      Panjang: ${panjang ? (Number(panjang).toLocaleString('id-ID')+' km') : "-"}<br>
      Tahun Data: ${thn}<br>
      Mendukung: ${mendukung}<br>
      Uraian: ${ura}<br>
      Kecamatan: ${kec}<br>
      Desa/Kel: ${desa}<br>
      <hr style="border:none;border-top:1px solid #eee; margin:6px 0">
      <a href="${sv}" target="_blank" rel="noopener">Buka Street View</a> &middot;
      <a href="${mapUrl}" target="_blank" rel="noopener">Lihat Peta</a>
    `, {maxWidth:360});

    // panjang utk prioritas label
    const coords = (feature.geometry && feature.geometry.coordinates) || [];
    let len = 0; function sumLine(arr){ for(let i=1;i<arr.length;i++){ const [lon1,lat1]=arr[i-1],[lon2,lat2]=arr[i]; len += haversine(lat1,lon1,lat2,lon2); } }
    if(feature.geometry.type==="LineString") sumLine(coords);
    else if(feature.geometry.type==="MultiLineString") coords.forEach(sumLine);

    metas.push({ layer, name:nama, lengthM:len, tooltipCreated:false });

    layer.on({
      mouseover: e => { const l=e.target; l.setStyle({weight: Math.max((l.options.weight||3.5)+2, 6.5), opacity:1}); l.bringToFront(); },
      mouseout:  e => { const l=e.target; lines.resetStyle(l); },
      click: () => { try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(e){} }
    });

    index.push({ name:nama, layer });
  }
}).addTo(map);
layerCtl.addOverlay(lines, "Jaringan Jalan");

// points ada tapi tidak didaftarkan ke control
const points = L.geoJSON(null, { pane:'roadPane' }).addTo(map);

const forest = L.geoJSON(null, {
  pane:'forestPane',
  style: f=>{
    const nm = pickForestName(f.properties||{}); const c = colorFromName(nm);
    const isPoly = ["Polygon","MultiPolygon"].includes((f.geometry||{}).type);
    return isPoly ? { pane:'forestPane', color:c, weight:1.2, fillColor:c, fillOpacity:0.28 }
                  : { pane:'forestPane', color:c, weight:2.0, opacity:0.9 };
  },
  onEachFeature: (feature, layer)=>{
    const nm  = pickForestName(feature.properties||{});
    const kab = prop(feature.properties,"kabupaten") || prop(feature.properties,"Kab_Kot") || "Kab. Bombana";
    layer.bindPopup(`<b>Hutan: ${nm}</b><br>Kabupaten: ${kab}`);
    forestMetas.push({ layer, name:nm, tooltipCreated:false });
  }
});
layerCtl.addOverlay(forest, "Hutan Bombana");

// ===== LOAD =====
function applyGeoJSON_Jalan(gj){
  lines.clearLayers(); points.clearLayers(); metas.length=0; index.length=0; roadLegendItems=[];
  const feats=(gj&&gj.features)?gj.features:[];
  const lineFeats=feats.filter(f=>["LineString","MultiLineString"].includes((f.geometry||{}).type));
  const pointFeats=feats.filter(f=>(f.geometry||{}).type==="Point");
  lines.addData({type:"FeatureCollection", features:lineFeats});
  points.addData({type:"FeatureCollection", features:pointFeats});

  // item legenda jalan + count
  const counts = {};
  lineFeats.forEach(f=>{ const k=(f.properties||{}).Fungsi||"Lainnya"; counts[k]=(counts[k]||0)+1; });
  roadLegendItems = Object.keys(counts).map(k=>{
    const w = weightByFungsi(String(k));
    return `<div class="row"><span class="swatch" style="border-bottom:${w}px solid #e53935"></span>${k}<span class="badge">${counts[k]}</span></div>`;
  });

  const group = L.featureGroup([lines, points]);
  try { fullBounds = group.getBounds(); map.fitBounds(fullBounds, {padding:[20,20]}); }
  catch(e){ map.setView(DEFAULT_VIEW, DEFAULT_ZOOM); }

  updateRoadLabels();
  renderUnifiedLegend(); // refresh
}
function applyGeoJSON_Hutan(gj){
  forest.clearLayers(); forestMetas.length=0; forestLegendItems=[];
  const feats=(gj&&gj.features)?gj.features:[];
  const ok=feats.filter(f=>["Polygon","MultiPolygon","LineString","MultiLineString"].includes((f.geometry||{}).type));
  if(!ok.length){ showErr("GeoJSON Hutan tidak berisi geometri yang didukung."); return; }
  forest.addData({type:"FeatureCollection", features:ok});

  // item legenda hutan + count
  const counts = {};
  ok.forEach(f=>{ const k = pickForestName(f.properties||{}); counts[k]=(counts[k]||0)+1; });
  forestLegendItems = Object.keys(counts).sort((a,b)=>a.localeCompare(b,'id')).map(k=>{
    const c = colorFromName(k);
    return `<div class="row"><span class="swatch-box" style="background:${c}"></span>${k}<span class="badge">${counts[k]}</span></div>`;
  });

  try{ const g=L.featureGroup([lines, points, forest]); fullBounds=g.getBounds(); map.fitBounds(fullBounds,{padding:[20,20]}); }catch(e){}
  updateForestLabels();
  renderUnifiedLegend();
}

fetchJSON(URL_JALAN).then(applyGeoJSON_Jalan).catch(e=>{console.error(e); showErr("GeoJSON Jalan tidak ditemukan (404).");});
fetchJSON(URL_HUTAN).then(applyGeoJSON_Hutan).catch(e=>{console.error(e); showErr("GeoJSON Hutan tidak ditemukan (404).");});

// ===== UNIFIED LEGEND (bottom-right) =====
let unifiedLegendCtl=null, legendBodyEl=null, legendBtnEl=null, legendWrapEl=null;
const LEGEND_KEY='legend-collapsed';
function renderUnifiedLegend(){
  if(unifiedLegendCtl){ map.removeControl(unifiedLegendCtl); unifiedLegendCtl=null; }
  unifiedLegendCtl = L.control({position:"bottomright"});
  unifiedLegendCtl.onAdd = function(){
    const wrap = L.DomUtil.create('div','legend-unified');
    wrap.innerHTML = `
      <div class="head">
        <span>Legenda</span>
        <button class="btn" id="lgToggle" title="Ciut/Buka">−</button>
      </div>
      <div class="body" id="lgBody">
        <div class="grp">
          <b>Fungsi Jalan</b>
          ${roadLegendItems.join("") || '<div class="row">–</div>'}
        </div>
        <div class="grp">
          <b>Hutan (berdasarkan <i>name</i>)</b>
          ${forestLegendItems.join("") || '<div class="row">–</div>'}
        </div>
      </div>
    `;
    L.DomEvent.disableClickPropagation(wrap); L.DomEvent.disableScrollPropagation(wrap);
    const body = wrap.querySelector('#lgBody');
    const btn  = wrap.querySelector('#lgToggle');
    legendBodyEl = body; legendWrapEl = wrap;

    // restore collapsed state (default collapsed on mobile)
    let collapsed = (localStorage.getItem(LEGEND_KEY) ?? (window.matchMedia('(max-width: 640px)').matches ? '1':'0')) === '1';
    const applyState = ()=>{
      body.style.display = collapsed ? 'none' : 'block';
      btn.textContent = collapsed ? '+' : '−';
      document.getElementById('legendFab').style.display = collapsed ? 'block' : 'none';
    };
    btn.addEventListener('click', ()=>{ collapsed = !collapsed; localStorage.setItem(LEGEND_KEY, collapsed?'1':'0'); applyState(); });
    applyState();
    return wrap;
  };
  unifiedLegendCtl.addTo(map);

  // hook FAB
  const fab = document.getElementById('legendFab');
  legendBtnEl = fab;
  fab.onclick = ()=>{ setLegendCollapsed(false); };
}
function setLegendCollapsed(state){
  const collapsed = state;
  localStorage.setItem(LEGEND_KEY, collapsed ? '1':'0');
  if(legendBodyEl) legendBodyEl.style.display = collapsed ? 'none' : 'block';
  const fab = document.getElementById('legendFab');
  if(fab) fab.style.display = collapsed ? 'block' : 'none';
  if(legendWrapEl){ const t=legendWrapEl.querySelector('#lgToggle'); if(t) t.textContent = collapsed ? '+' : '−'; }
}
// Auto-hide legend saat user geser/zoom peta
map.on('movestart zoomstart', ()=>{ setLegendCollapsed(true); });

// ===== LAYERS TOGGLER (top-right) =====
const LAYERS_KEY='layers-collapsed';
const layersFab = document.getElementById('layersFab');
layersFab.addEventListener('click', toggleLayersPanel);

function getLayersContainer(){ return layerCtl && layerCtl.getContainer ? layerCtl.getContainer() : null; }
function applyLayersState(){
  const box = getLayersContainer(); if(!box) return;
  const collapsed = (localStorage.getItem(LAYERS_KEY) ?? (window.matchMedia('(max-width: 640px)').matches ? '1':'0')) === '1';
  box.style.display = collapsed ? 'none' : 'block';
  layersFab.textContent = collapsed ? 'Layer' : 'Layer ×';
}
function toggleLayersPanel(){
  const box = getLayersContainer(); if(!box) return;
  const collapsedNow = box.style.display === 'none';
  localStorage.setItem(LAYERS_KEY, collapsedNow ? '0':'1'); // if visible -> set 0
  applyLayersState();
}
// apply initial state after control exists
setTimeout(applyLayersState, 0);

// ===== LABELS (declutter) =====
map.on('zoomend moveend', ()=>{ updateRoadLabels(); updateForestLabels(); });
map.on('zoomstart', ()=>{ removeAllRoadLabels(); removeAllForestLabels(); });

// ROAD
function removeAllRoadLabels(){ metas.forEach(m=>{ if(m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated=false; } }); }
function updateRoadLabels(){
  const z = map.getZoom(), bounds = map.getBounds();
  if(z < ROAD_SHOW_SOME_ZOOM){ removeAllRoadLabels(); return; }

  const candidates = metas.filter(m=>{
    if(!m.layer.getBounds || !bounds.intersects(m.layer.getBounds())) return false;
    return estimateScreenLengthPx(m.layer) >= MIN_SCREEN_LEN_PX;
  }).sort((a,b)=> b.lengthM - a.lengthM);

  const limit = (z >= ROAD_SHOW_ALL_ZOOM) ? Infinity : ROAD_MAX_LABELS;
  const chosen=[], occupied=[];
  for(const m of candidates){
    if(chosen.length>=limit) break;
    const pt = layerCenterPx(m.layer); if(!pt) continue;
    let ok=true; for(const p of occupied){ if(dist(pt,p)<MIN_LABEL_DIST_PX){ ok=false; break; } }
    if(ok){ occupied.push(pt); chosen.push(m); }
  }
  const chosenSet = new Set(chosen);
  metas.forEach(m=>{
    const on = chosenSet.has(m);
    if(on && !m.tooltipCreated){ m.layer.bindTooltip(m.name,{direction:"center", permanent:true, className:"label-road"}); m.tooltipCreated=true; }
    else if(!on && m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated=false; }
  });
}

// FOREST
function removeAllForestLabels(){ forestMetas.forEach(m=>{ if(m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated=false; } }); }
function updateForestLabels(){
  const z = map.getZoom(), bounds = map.getBounds();
  if(z < FOREST_SHOW_SOME_ZOOM){ removeAllForestLabels(); return; }

  const candidates = forestMetas.filter(m=> m.layer.getBounds && bounds.intersects(m.layer.getBounds()));
  const scored = candidates.map(m=>{
    let s=0; try{ const b=m.layer.getBounds(); const p1=map.latLngToLayerPoint(b.getNorthWest()); const p2=map.latLngToLayerPoint(b.getSouthEast()); s=Math.abs((p2.x-p1.x)*(p2.y-p1.y)); }catch(e){}
    return {m,score:s};
  }).sort((a,b)=> b.score-a.score).map(o=>o.m);

  const limit = (z >= FOREST_SHOW_ALL_ZOOM) ? Infinity : FOREST_MAX_LABELS;
  const chosen=[], occupied=[];
  for(const m of scored){
    if(chosen.length>=limit) break;
    const pt = layerCenterPx(m.layer); if(!pt) continue;
    let ok=true; for(const p of occupied){ if(dist(pt,p)<MIN_LABEL_DIST_PX){ ok=false; break; } }
    if(ok){ occupied.push(pt); chosen.push(m); }
  }
  const chosenSet = new Set(chosen);
  forestMetas.forEach(m=>{
    const on = chosenSet.has(m);
    if(on && !m.tooltipCreated){ m.layer.bindTooltip(m.name,{direction:"center", permanent:true, className:"label-forest"}); m.tooltipCreated=true; }
    else if(!on && m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated=false; }
  });
}

// Helpers
function estimateScreenLengthPx(layer){
  const latlngs = layer.getLatLngs(); if(!latlngs||!latlngs.length) return 0;
  const flat = []; (function walk(a){ if(!a) return; if(Array.isArray(a)&&a.length&&'lat' in a[0]) a.forEach(v=>flat.push(v)); else if(Array.isArray(a)) a.forEach(walk); })(latlngs);
  let pxLen=0; for(let i=1;i<flat.length;i++){ const p1=map.latLngToLayerPoint(flat[i-1]); const p2=map.latLngToLayerPoint(flat[i]); pxLen+=Math.hypot(p2.x-p1.x,p2.y-p1.y); }
  return pxLen;
}
function layerCenterPx(layer){ try{ const c=layer.getBounds().getCenter(); return map.latLngToLayerPoint(c); }catch(e){ return null; } }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

// ===== SEARCH =====
function onSearchInput(q){
  document.getElementById('clearBtn').style.display = q && q.length ? 'block' : 'none';
  showSuggestions(q);
}
function clearSearch(){
  const inp=document.getElementById('search'), box=document.getElementById('suggestions');
  inp.value=""; box.innerHTML=""; box.style.display="none";
  document.getElementById('clearBtn').style.display='none';
  if(fullBounds) map.fitBounds(fullBounds,{padding:[20,20]});
}
function showSuggestions(q){
  const box=document.getElementById('suggestions'); box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index.filter(it=>it.name && it.name.toLowerCase().includes(q.toLowerCase())).slice(0,100);
  hits.forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{
      document.getElementById('search').value=it.name;
      document.getElementById('clearBtn').style.display='block'; box.style.display="none";
      try{ map.fitBounds(it.layer.getBounds(),{padding:[20,20]}); }catch(e){ if(it.layer.getLatLng) map.setView(it.layer.getLatLng(),14); }
      it.layer.openPopup && it.layer.openPopup();
    };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}

// ===== HIT COUNTER =====
(function(){
  const KEY="bombana-webgis-hit";
  let n=parseInt(localStorage.getItem(KEY)||"0",10); n=isNaN(n)?0:n; n+=1;
  localStorage.setItem(KEY,String(n));
  document.getElementById('hitCount').textContent = n.toLocaleString('id-ID');
})();
</script>
</body>
</html>
