<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>PUPR • Produksi Padi per Provinsi (BPS 2024)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root{--Hpx:60px;--Tpx:60px;--bd:#eee;--r:12px;--shadow:0 6px 22px rgba(0,0,0,.08);--font:system-ui,Segoe UI,Roboto,Arial}
  html,body{height:100%;margin:0;font-family:var(--font)}
  #header{position:fixed;top:0;left:0;right:0;z-index:900;display:flex;align-items:center;gap:10px;padding:6px 12px;background:#fff;border-bottom:1px solid var(--bd)}
  #header img{height:36px}
  .header-text{display:flex;flex-direction:column;line-height:1.1}
  .line1{font-weight:800;font-size:14px;text-transform:uppercase}
  .line2,.line3{font-weight:700;font-size:13px}
  .top{position:fixed;top:var(--Hpx);left:0;right:0;z-index:900;display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--bd);flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid #dcdcdc;border-radius:999px;background:#fff;cursor:pointer;font-size:13px}
  .pill:hover{background:#f6f6f6}
  .muted{color:#666;font-size:12px}
  .search{position:relative;display:flex;align-items:center;gap:6px}
  .search input{padding:6px 8px;border:1px solid #ccc;border-radius:8px;min-width:220px}
  .suggestions{position:absolute;top:36px;left:0;background:#fff;border:1px solid #ccc;border-radius:8px;box-shadow:var(--shadow);max-height:220px;overflow:auto;z-index:1000;min-width:220px}
  .suggestions div{padding:8px 10px;cursor:pointer}
  .suggestions div:hover{background:#f0f0f0}
  #map{position:absolute;top:calc(var(--Hpx) + var(--Tpx));left:0;right:0;bottom:0}
  .panel{position:absolute;right:10px;bottom:10px;width:340px;background:rgba(255,255,255,.96);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:10px 12px;font-size:13px;z-index:800}
  .panel h3{margin:4px 0 8px}
  .legend{margin:8px 0}
  .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
  .sw{width:22px;height:12px;border:1px solid #777;border-radius:3px}
  .infobox{position:absolute;left:10px;bottom:10px;background:rgba(255,255,255,.9);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:6px 8px;font-size:11px;z-index:800}
  .source-note{color:#666;font-size:12px;margin-left:4px}
  @media(max-width:740px){.panel{width:calc(100% - 20px);left:10px;right:10px}}
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  <div class="header-text">
    <div class="line1">Kementerian Pekerjaan Umum</div>
    <div class="line2">Direktorat Jenderal Sumber Daya Air</div>
    <div class="line3">Direktorat Irigasi dan Rawa</div>
  </div>
</div>

<div class="top" id="topbar">
  <button class="pill" id="btnReset">Reset</button>
  <div class="search">
    <input id="q" type="text" placeholder="Cari provinsi… " autocomplete="off" oninput="showSuggestions(this.value)"/>
    <div id="suggestions" class="suggestions" style="display:none"></div>
  </div>
  <button class="pill" id="btnCari">Cari</button>
  <span class="muted" id="status">Memuat data…</span>
</div>

<div id="map"></div>

<div class="infobox">
  <b>Sumber:</b> BPS (2024) & Boundary (GeoJSON dari repo ini).<br/>
  <span style="color:#555">Angka produksi: ton GKG</span>
</div>

<div class="panel">
  <h3>Legenda Produksi Padi (ton GKG)</h3>
  <div id="legend" class="legend"></div>
  <div>
    <b>Tahun:</b> <span id="tahun">2024</span>
    <em class="source-note">(Sumber data: BPS)</em>
  </div>
</div>

<script>
/* ===== Konfigurasi (pakai file lokal—anti CORS/TLS) ===== */
const PROV_GEOJSON_URL = "Polygon_Admin__SimplifyPolyg.geojson";
const CSV_38 = "produksi_padi_2024_38prov.csv";
const CSV_BPS = "produksi_padi_2024_BPS_per_provinsi.csv";
const useBps = /[?&]csv=bps\b/i.test(location.search);
const CSV_URL = useBps ? CSV_BPS : CSV_38;
const TAHUN_DATA = "2024";

/* ===== Layout ===== */
function syncOffsets(){
  const h=header.offsetHeight, t=topbar.offsetHeight;
  document.documentElement.style.setProperty('--Hpx', h+'px');
  document.documentElement.style.setProperty('--Tpx', t+'px');
}
addEventListener('load', syncOffsets);
addEventListener('resize', syncOffsets);

/* ===== Map ===== */
const map=L.map('map',{minZoom:3,maxZoom:18});
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
map.fitBounds([[-11,94],[6,141]]);

/* ===== Util ===== */
function withBuster(url){ const sep=url.includes("?")?"&":"?"; return `${url}${sep}t=${Date.now()}`; }

function num(x){
  if (x === null || x === undefined) return null;
  if (typeof x === "number") return isFinite(x) ? x : null;
  let s = String(x).trim();
  if (s === "") return null; // jangan jadikan 0
  s = s.replace(/\s/g,"").re
