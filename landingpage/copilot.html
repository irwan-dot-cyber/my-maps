
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Si-Irwan — Sistem Informasi Irigasi & Rawa Nasional</title>

  <!-- Leaflet Map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- Icons (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --panel-2:#0b1220;     /* darker */
      --text:#e5e7eb;        /* gray-200 */
      --muted:#94a3b8;       /* slate-400 */
      --primary:#2E86C1;     /* Biru air */
      --success:#27AE60;     /* Hijau layanan */
      --warn:#F39C12;        /* Kuning waspada */
      --danger:#C0392B;      /* Merah kritis */
      --neutral:#6b7280;     /* gray-500 */
      --card:#0b1328;
      --chip:#172554;        /* indigo-950 */
      --border:#1f2937;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#0b1020, #0f172a 40%, #0b1220);
      color:var(--text);
    }

    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 20px; border-bottom:1px solid var(--border);
      background:rgba(15,23,42,0.7); backdrop-filter: blur(6px); position:sticky; top:0; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .brand .logo{
      width:36px; height:36px; border-radius:8px;
      background: radial-gradient(120px 120px at 20% 20%, #2E86C1, transparent 35%),
                  radial-gradient(160px 160px at 80% 80%, #27AE60, transparent 35%),
                  linear-gradient(135deg,#1b3b63,#0f172a);
      box-shadow: 0 0 0 1px #1f2c46 inset, 0 8px 20px rgba(46,134,193,.35);
    }
    .brand span{font-size:18px}
    .subtitle{font-size:12px; color:var(--muted)}
    .toolbar{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}

    .layout{
      display:grid; grid-template-columns: 300px 1fr; gap:16px; padding:16px; align-items:start;
    }
    aside{
      background:linear-gradient(180deg,#0b1328,#0a1020 60%,#0a0f1e);
      border:1px solid var(--border); border-radius:14px; padding:14px; position:sticky; top:74px;
    }
    main{display:grid; gap:16px}

    .section{background:linear-gradient(180deg,#0b1328,#0a1020); border:1px solid var(--border); border-radius:14px;}
    .section .head{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border)}
    .section .body{padding:12px}

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      background:var(--chip); color:#c7d2fe; border:1px solid #1f2a55; border-radius:999px;
      padding:6px 10px; font-size:12px; cursor:pointer; user-select:none;
    }
    .chip.active{outline:1px solid #3b82f6; background:#0b1c43}

    .kpis{display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px}
    .kpi{
      background:var(--card); border-radius:12px; border:1px solid var(--border);
      padding:12px; display:flex; flex-direction:column; gap:6px; min-height:84px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:22px; font-weight:700}
    .kpi .trend{font-size:11px; color:var(--muted)}

    #map{height:420px; border-bottom-left-radius:14px; border-bottom-right-radius:14px}
    .legend{display:flex; gap:8px; font-size:12px; color:var(--muted)}
    .legend .dot{width:10px; height:10px; border-radius:2px; display:inline-block}
    .legend .g{background:var(--success)} .legend .y{background:var(--warn)} .legend .r{background:var(--danger)}

    .grid-2{display:grid; grid-template-columns: 1.3fr .7fr; gap:16px}
    .grid-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px}

    .alerts{display:flex; flex-direction:column; gap:8px}
    .alert{border:1px solid var(--border); background:#0c152c; padding:10px; border-radius:10px; font-size:13px}
    .alert .tag{font-size:11px; padding:2px 6px; border-radius:999px; margin-right:6px}
    .tag.red{background:#3b1111; color:#ffb4b4; border:1px solid #5a1b1b}
    .tag.yellow{background:#3b2b11; color:#ffd59e; border:1px solid #5a451b}
    .tag.blue{background:#0b2643; color:#a7d7ff; border:1px solid #1c3b5f}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:8px 10px; border-bottom:1px solid var(--border)}
    th{color:var(--muted); font-weight:600; text-align:left}
    tr:hover{background:#0c1a33}

    .muted{color:var(--muted)}
    .small{font-size:12px}

    .sim-wrap{display:flex; align-items:center; gap:10px}
    input[type="range"]{width:220px}

    @media (max-width:1100px){
      .layout{grid-template-columns:1fr}
      .kpis{grid-template-columns: repeat(2, minmax(0,1fr))}
      .grid-2, .grid-3{grid-template-columns:1fr}
      aside{position:static}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div><span>Si‑Irwan</span> <span class="subtitle"> — Sistem Informasi Irigasi & Rawa Nasional</span></div>
        <div class="subtitle">“10 detik paham kondisi, 1 klik aksi.”</div>
      </div>
    </div>
    <div class="toolbar">
      <span id="now"></span>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar / Filters -->
    <aside>
      <div class="section">
        <div class="head"><strong>Filter & Mode</strong></div>
        <div class="body">
          <div class="small muted" style="margin-bottom:6px;">Provinsi</div>
          <div id="chip-prov" class="chips"></div>

          <div class="small muted" style="margin:12px 0 6px;">Status</div>
          <div id="chip-status" class="chips">
            <div class="chip" data-status="all">Semua</div>
            <div class="chip" data-status="green">Hijau</div>
            <div class="chip" data-status="yellow">Kuning</div>
            <div class="chip" data-status="red">Merah</div>
          </div>

          <div class="small muted" style="margin:12px 0 6px;">Simulasi Supply</div>
          <div class="sim-wrap">
            <input id="simSupply" type="range" min="-40" max="40" value="0" />
            <span class="small"><span id="simSupplyVal">0</span>%</span>
          </div>
          <div class="small muted" style="margin-top:6px;">Geser untuk lihat dampaknya ke IAR & Alerts</div>
        </div>
      </div>

      <div class="section" style="margin-top:12px;">
        <div class="head"><strong>Top Alerts</strong> <span class="small muted">otomatis</span></div>
        <div class="body">
          <div id="alertBox" class="alerts"></div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main>
      <!-- MAP -->
      <section class="section">
        <div class="head">
          <div><strong>Peta Daerah Irigasi</strong> <span class="small muted">— klik poligon untuk detail</span></div>
          <div class="legend">
            <span class="dot g"></span> Hijau (≥80)
            <span class="dot y"></span> Kuning (60–79)
            <span class="dot r"></span> Merah (&lt;60)
          </div>
        </div>
        <div id="map"></div>
      </section>

      <!-- KPIs -->
      <section class="section">
        <div class="head"><strong>Ringkasan Kinerja</strong> <span class="small muted" id="scopeLabel">Nasional</span></div>
        <div class="body">
          <div class="kpis">
            <div class="kpi">
              <div class="label">Luas Terlayani (ha)</div>
              <div id="kpiLuas" class="value">-</div>
              <div class="trend muted small">Arah kebijakan: perluas layanan berkelanjutan</div>
            </div>
            <div class="kpi">
              <div class="label">IAR (Adequacy)</div>
              <div id="kpiIAR" class="value">-</div>
              <div class="trend muted small">≥1 ideal; &lt;0.8 waspada</div>
            </div>
            <div class="kpi">
              <div class="label">Reliability (%)</div>
              <div id="kpiRel" class="value">-</div>
              <div class="trend muted small">Hari terpenuhi / total hari</div>
            </div>
            <div class="kpi">
              <div class="label">IP (Indeks Pertanaman)</div>
              <div id="kpiIP" class="value">-</div>
              <div class="trend muted small">Target nasional ≥ 2.5</div>
            </div>
            <div class="kpi">
              <div class="label">SLA Operasional (%)</div>
              <div id="kpiSLA" class="value">-</div>
              <div class="trend muted small">Waktu respon & penyelesaian</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section class="section">
        <div class="head"><strong>Water Balance</strong> <span class="small muted">Demand vs Supply</span></div>
        <div class="body grid-2">
          <div>
            <canvas id="chartDemand" height="150"></canvas>
          </div>
          <div>
            <canvas id="chartHS" height="150"></canvas>
          </div>
        </div>
      </section>

      <!-- Ranking -->
      <section class="section">
        <div class="head"><strong>Ranking DI</strong> <span class="small muted">berdasarkan Health Score</span></div>
        <div class="body">
          <table id="tblRank">
            <thead>
              <tr>
                <th>DI</th>
                <th>Provinsi</th>
                <th>Luas (ha)</th>
                <th>HS</th>
                <th>IAR</th>
                <th>Reliability</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="small muted" style="margin-top:8px;">Klik baris untuk fokus ke DI di peta.</div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ============ UTIL & STATE ============
    const fmt = new Intl.NumberFormat('id-ID');
    const state = {
      provFilter: 'Semua',
      statusFilter: 'all',
      simSupplyPct: 0,  // %-change supply
      selectedDI: null
    };

    function colorByHS(hs){
      if(hs >= 80) return getAlphaColor("--success");
      if(hs >= 60) return getAlphaColor("--warn");
      return getAlphaColor("--danger");
    }
    function getAlphaColor(varName, alpha=0.75){
      const tmp = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
      // Convert HEX to rgba
      const hex = tmp.replace('#','');
      const bigint = parseInt(hex, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    document.getElementById('now').textContent =
      new Date().toLocaleString('id-ID',{weekday:'long', day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});

    // ============ DATA MOCKUP ============
    // CATATAN: Ganti data ini dengan data asli dari basis data kamu.
    // Struktur ringkas per DI.
    const weeks = ['M1','M2','M3','M4','M5','M6','M7','M8'];
    const diData = [
      {
        id:'DI-001', name:'DI Contoh Barat', prov:'Jawa Barat', luas: 15500,
        health: 78, IAR: 0.93, reliability: 0.86, IP: 2.6, SLA: 0.88,
        demand: [92,110,128,140,135,120,100,95], // l/dt x 100 (skala relatif)
        supply: [100,120,130,132,125,115,95,90],
        hsTrend: [76,77,78,80,79,78,78,78],
        // polygon sederhana (sekadar mock, koordinat fiktif di sekitar Jawa Barat)
        geojson:{
          "type":"Feature","properties":{},"geometry":{
            "type":"Polygon","coordinates":[[
              [107.2,-6.4],[107.6,-6.4],[107.8,-6.6],[107.4,-6.8],[107.1,-6.6],[107.2,-6.4]
            ]]
          }
        }
      },
      {
        id:'DI-002', name:'DI Rawa Timur', prov:'Kalimantan Selatan', luas: 21000,
        health: 61, IAR: 0.81, reliability: 0.72, IP: 2.3, SLA: 0.74,
        demand: [70,85,100,115,125,130,120,110],
        supply: [68,80,92,96,98,100,95,90],
        hsTrend: [63,62,61,62,60,61,61,61],
        geojson:{
          "type":"Feature","properties":{},"geometry":{
            "type":"Polygon","coordinates":[[
              [114.5,-3.1],[114.9,-3.1],[115.0,-3.4],[114.7,-3.6],[114.4,-3.3],[114.5,-3.1]
            ]]
          }
        }
      },
      {
        id:'DI-003', name:'DI Delta Nusantara', prov:'Jawa Timur', luas: 18200,
        health: 85, IAR: 1.05, reliability: 0.92, IP: 2.7, SLA: 0.91,
        demand: [80,96,115,130,132,125,110,95],
        supply: [90,110,120,138,140,135,115,100],
        hsTrend: [82,83,84,85,86,85,85,85],
        geojson:{
          "type":"Feature","properties":{},"geometry":{
            "type":"Polygon","coordinates":[[
              [112.4,-7.3],[112.8,-7.3],[113.0,-7.6],[112.6,-7.8],[112.3,-7.5],[112.4,-7.3]
            ]]
          }
        }
      }
    ];

    // ============ MAP ============
    const map = L.map('map',{minZoom:4, maxZoom:12, zoomControl:false}).setView([-3.5, 114], 5);
    L.control.zoom({position:'topright'}).addTo(map);
    const basemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap'
    }).addTo(map);

    const layerGroup = L.geoJSON(null,{
      style: feature => {
        const di = diData.find(d=>d.id===feature.properties.id);
        return {
          color: '#1f2a44',
          weight: 1.2,
          fillColor: colorByHS(di.health),
          fillOpacity: .75
        };
      },
      onEachFeature: (feature, layer)=>{
        const di = diData.find(d=>d.id===feature.properties.id);
        layer.bindTooltip(`${di.name} — HS ${di.health}`);
        layer.on('click', ()=> selectDI(di.id, true));
      }
    }).addTo(map);

    function refreshMap(){
      layerGroup.clearLayers();
      diData.forEach(d=>{
        if(state.provFilter!=='Semua' && d.prov !== state.provFilter) return;
        if(state.statusFilter!=='all'){
          const status = d.health>=80?'green':(d.health>=60?'yellow':'red');
          if(status !== state.statusFilter) return;
        }
        const feat = JSON.parse(JSON.stringify(d.geojson));
        feat.properties.id = d.id;
        layerGroup.addData(feat);
      });
    }

    // ============ FILTER UI ============
    // Provinsi chips
    const uniqProv = ['Semua', ...Array.from(new Set(diData.map(d=>d.prov)))];
    const chipProvWrap = document.getElementById('chip-prov');
    uniqProv.forEach(p=>{
      const el = document.createElement('div');
      el.className = 'chip'+(p==='Semua'?' active':'');
      el.textContent = p;
      el.onclick = ()=>{
        [...chipProvWrap.children].forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        state.provFilter = p;
        state.selectedDI = null;
        document.getElementById('scopeLabel').textContent = p==='Semua'?'Nasional':p;
        refreshMap(); refreshKPIs(); refreshCharts(); refreshTable(); refreshAlerts();
      };
      chipProvWrap.appendChild(el);
    });

    // Status chips
    const chipStatusWrap = document.getElementById('chip-status');
    [...chipStatusWrap.children].forEach(el=>{
      el.onclick = ()=>{
        [...chipStatusWrap.children].forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        state.statusFilter = el.dataset.status;
        state.selectedDI = null;
        refreshMap(); refreshKPIs(); refreshCharts(); refreshTable(); refreshAlerts();
      }
    });
    chipStatusWrap.children[0].classList.add('active');

    // Simulasi slider
    const simRange = document.getElementById('simSupply');
    const simVal = document.getElementById('simSupplyVal');
    simRange.addEventListener('input', ()=>{
      state.simSupplyPct = parseInt(simRange.value||0, 10);
      simVal.textContent = state.simSupplyPct;
      refreshKPIs(); refreshCharts(); refreshAlerts();
    });

    // ============ CHARTS ============
    const ctxDemand = document.getElementById('chartDemand').getContext('2d');
    const ctxHS     = document.getElementById('chartHS').getContext('2d');
    const chartDemand = new Chart(ctxDemand, {
      type:'line',
      data:{labels:weeks, datasets:[
        {label:'Demand', data:[], borderColor:getAlphaColor('--warn',1), backgroundColor:getAlphaColor('--warn',.15), fill:true, tension:.35},
        {label:'Supply', data:[], borderColor:getAlphaColor('--primary',1), backgroundColor:getAlphaColor('--primary',.15), fill:true, tension:.35}
      ]},
      options:{
        plugins:{legend:{labels:{color:'#cbd5e1'}}},
        scales:{x:{ticks:{color:'#94a3b8'}}, y:{ticks:{color:'#94a3b8'}}}
      }
    });
    const chartHS = new Chart(ctxHS, {
      type:'bar',
      data:{labels:weeks, datasets:[
        {label:'Health Score', data:[], backgroundColor:getAlphaColor('--success',.8), borderColor:getAlphaColor('--success',1)}
      ]},
      options:{
        plugins:{legend:{labels:{color:'#cbd5e1'}}},
        scales:{x:{ticks:{color:'#94a3b8'}}, y:{ticks:{color:'#94a3b8'}, suggestedMin:40, suggestedMax:100}}
      }
    });

    // ============ KPI & TABLE ============
    function aggregate(scopeItems){
      // Aggregate simple: sum luas, avg metric terimbangkan luas (opsional)
      const luas = scopeItems.reduce((s,d)=>s+d.luas,0);
      // hitung IAR & reliability dengan supply simulasi
      let demandSum=0, supplySum=0, relDays=0, totalDays=0, ipSum=0, slaSum=0;
      scopeItems.forEach(d=>{
        const k = 1 + state.simSupplyPct/100;
        const supAdj = d.supply.map(v=>v*k);
        demandSum += d.demand.reduce((a,b)=>a+b,0);
        supplySum += supAdj.reduce((a,b)=>a+b,0);
        // reliability sederhana (hari supply >= demand)
        for(let i=0;i<d.demand.length;i++){
          totalDays += 1;
          if(supAdj[i] >= d.demand[i]) relDays += 1;
        }
        ipSum += d.IP;
        slaSum += d.SLA;
      });
      const IAR = demandSum>0 ? (supplySum/demandSum) : 0;
      const Reliability = totalDays>0 ? (relDays/totalDays) : 0;
      const IP = scopeItems.length>0 ? (ipSum/scopeItems.length) : 0;
      const SLA = scopeItems.length>0 ? (slaSum/scopeItems.length) : 0;

      return {luas, IAR, Reliability, IP, SLA};
    }

    function refreshKPIs(){
      const scope = getScopeItems();
      const agg = aggregate(scope);
      document.getElementById('kpiLuas').textContent = fmt.format(agg.luas);
      document.getElementById('kpiIAR').textContent = agg.IAR.toFixed(2);
      document.getElementById('kpiRel').textContent = (agg.Reliability*100).toFixed(0)+'%';
      document.getElementById('kpiIP').textContent  = agg.IP.toFixed(2);
      document.getElementById('kpiSLA').textContent = (agg.SLA*100).toFixed(0)+'%';
    }

    function refreshCharts(){
      const scope = getScopeItems();
      // Untuk grafik, kalau 1 DI terpilih pakai data DI; kalau tidak, pakai agregasi rata-rata
      if(state.selectedDI){
        const d = scope.find(x=>x.id===state.selectedDI) || diData.find(x=>x.id===state.selectedDI);
        const k = 1 + state.simSupplyPct/100;
        const supAdj = d.supply.map(v=>v*k);
        chartDemand.data.datasets[0].data = d.demand;
        chartDemand.data.datasets[1].data = supAdj;
        chartDemand.update();

        chartHS.data.datasets[0].data = d.hsTrend;
        chartHS.update();
      }else{
        // Rerata demand/supply per minggu untuk scope
        const n = Math.max(...scope.map(d=>d.demand.length), 0);
        const avgDemand = Array(n).fill(0);
        const avgSupply = Array(n).fill(0);
        const k = 1 + state.simSupplyPct/100;

        scope.forEach(d=>{
          d.demand.forEach((v,i)=> avgDemand[i] += v);
          d.supply.forEach((v,i)=> avgSupply[i] += v*k);
        });
        for(let i=0;i<n;i++){
          avgDemand[i] = scope.length? +(avgDemand[i]/scope.length).toFixed(1) : 0;
          avgSupply[i] = scope.length? +(avgSupply[i]/scope.length).toFixed(1) : 0;
        }
        chartDemand.data.datasets[0].data = avgDemand;
        chartDemand.data.datasets[1].data = avgSupply;
        chartDemand.update();

        // Health score trend rata-rata
        const avgHS = Array(n).fill(0);
        scope.forEach(d=>{
          d.hsTrend.forEach((v,i)=> avgHS[i] += v);
        });
        for(let i=0;i<n;i++){
          avgHS[i] = scope.length? +(avgHS[i]/scope.length).toFixed(1) : 0;
        }
        chartHS.data.datasets[0].data = avgHS;
        chartHS.update();
      }
    }

    function refreshTable(){
      const tbody = document.querySelector('#tblRank tbody');
      tbody.innerHTML = '';
      const scope = getScopeItems();
      const list = [...scope].sort((a,b)=> b.health - a.health);
      list.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.name}</td>
          <td class="muted">${d.prov}</td>
          <td>${fmt.format(d.luas)}</td>
          <td><strong>${d.health}</strong></td>
          <td>${d.IAR.toFixed(2)}</td>
          <td>${(d.reliability*100).toFixed(0)}%</td>
          <td>${d.IP.toFixed(1)}</td>
        `;
        tr.onclick = ()=> selectDI(d.id, true);
        tbody.appendChild(tr);
      });
    }

    function statusFromHS(hs){ return hs>=80?'green':(hs>=60?'yellow':'red'); }

    function refreshAlerts(){
      const box = document.getElementById('alertBox');
      box.innerHTML = '';
      const scope = getScopeItems();
      const items = [];
      scope.forEach(d=>{
        const k = 1 + state.simSupplyPct/100;
        const supAdj = d.supply.map(v=>v*k);
        // Defisit beruntun >=3
        let streak=0, maxStreak=0;
        for(let i=0;i<d.demand.length;i++){
          if(supAdj[i] < d.demand[i]){ streak++; maxStreak=Math.max(maxStreak, streak); }
          else streak=0;
        }
        if(maxStreak>=3) items.push({sev:'red', text:`Defisit air beruntun (${maxStreak} hari/minggu) — ${d.name}`});

        // Penurunan supply >30% vs awal
        const drop = (supAdj[0] && supAdj[0]>0) ? (supAdj[supAdj.length-1]/supAdj[0]) : 1;
        if(drop < 0.7) items.push({sev:'yellow', text:`Tren supply menurun >30% — ${d.name}`});

        // SLA rendah
        if(d.SLA < 0.8) items.push({sev:'blue', text:`SLA operasional rendah (${(d.SLA*100).toFixed(0)}%) — ${d.name}`});
      });

      // Ambil top 5
      items.slice(0,5).forEach(a=>{
        const div = document.createElement('div');
        div.className='alert';
        const tagClass = a.sev==='red'?'red':(a.sev==='yellow'?'yellow':'blue');
        div.innerHTML = `<span class="tag ${tagClass}">${a.sev.toUpperCase()}</span> ${a.text}`;
        box.appendChild(div);
      });
      if(items.length===0){
        const div = document.createElement('div');
        div.className='alert';
        div.innerHTML = `<span class="tag blue">INFO</span> Tidak ada alert kritis pada scope saat ini.`;
        box.appendChild(div);
      }
    }

    function getScopeItems(){
      let items = diData.filter(d=>{
        const passProv = (state.provFilter==='Semua' || d.prov===state.provFilter);
        const passStatus = (state.statusFilter==='all' || statusFromHS(d.health)===state.statusFilter);
        return passProv && passStatus;
      });
      if(state.selectedDI){
        const sel = diData.find(d=>d.id===state.selectedDI);
        if(sel && !items.some(x=>x.id===sel.id)) items = [sel]; // jika DI selected di luar filter, tetap tampilkan
      }
      return items;
    }

    function selectDI(id, fly=false){
      state.selectedDI = id;
      const d = diData.find(x=>x.id===id);
      document.getElementById('scopeLabel').textContent = d.name;
      refreshKPIs(); refreshCharts(); refreshAlerts();
      // zoom to polygon
      layerGroup.eachLayer(layer=>{
        if(layer.feature && layer.feature.properties.id===id){
          if(fly) map.fitBounds(layer.getBounds(), {maxZoom:9, padding:[20,20]});
          layer.openTooltip();
        }
      });
    }

    // ============ INIT ============
    // Set chips default
    refreshMap(); refreshKPIs(); refreshCharts(); refreshTable(); refreshAlerts();

  </script>
</body>
</html>
