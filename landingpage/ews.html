
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Si-Irwan — Modul 3: Early Warning System</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --primary:#2E86C1; --success:#27AE60; --warn:#F39C12; --danger:#C0392B; --border:#1f2937; --card:#0b1328;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0f172a 40%,#0b1220);color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);background:rgba(15,23,42,.7);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:12px;align-items:center;font-weight:700}
    .logo{width:36px;height:36px;border-radius:8px;background:radial-gradient(120px 120px at 20% 20%,#2E86C1,transparent 35%),radial-gradient(160px 160px at 80% 80%,#27AE60,transparent 35%),linear-gradient(135deg,#1b3b63,#0f172a)}
    .subtitle{font-size:12px;color:var(--muted)}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
    aside{background:linear-gradient(180deg,#0b1328,#0a1020 60%,#0a0f1e);border:1px solid var(--border);border-radius:14px;padding:14px;position:sticky;top:74px}
    main{display:grid;gap:16px}
    .section{background:linear-gradient(180deg,#0b1328,#0a1020);border:1px solid var(--border);border-radius:14px}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border)}
    .body{padding:12px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#172554;color:#c7d2fe;border:1px solid #1f2a55;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .chip.active{outline:1px solid #3b82f6;background:#0b1c43}
    .alerts{display:flex;flex-direction:column;gap:8px}
    .alert{border:1px solid var(--border);background:#0c152c;padding:10px;border-radius:10px;font-size:13px}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;margin-right:6px}
    .red{background:#3b1111;color:#ffb4b4;border:1px solid #5a1b1b}
    .yellow{background:#3b2b11;color:#ffd59e;border:1px solid #5a451b}
    .blue{background:#0b2643;color:#a7d7ff;border:1px solid #1c3b5f}
    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    #map{height:320px;border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border)} th{color:var(--muted);text-align:left}
    tr:hover{background:#0c1a33}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:1100px){.layout{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>
      <div>Si‑Irwan <span class="subtitle">— Modul 3: Early Warning System</span></div>
      <div class="subtitle">“Deteksi dini & rekomendasi aksi.”</div>
    </div>
  </div>
  <div class="subtitle" id="now"></div>
</header>

<div class="layout">
  <aside>
    <div class="section">
      <div class="head"><strong>Filter</strong></div>
      <div class="body">
        <div class="small" style="margin-bottom:6px;">Provinsi</div>
        <div id="chip-prov" class="chips"></div>

        <div class="small" style="margin:12px 0 6px;">Severity</div>
        <div id="chip-sev" class="chips">
          <div class="chip" data-s="all">Semua</div>
          <div class="chip" data-s="red">Kritis</div>
          <div class="chip" data-s="yellow">Waspada</div>
          <div class="chip" data-s="blue">Info</div>
        </div>
      </div>
    </div>

    <div class="section" style="margin-top:12px;">
      <div class="head"><strong>Rekomendasi Cepat</strong></div>
      <div class="body small" id="recoBox">
        - Defisit beruntun: review jadwal bagi air, aktifkan pompa portable, koordinasi lintas DI.<br>
        - Kekeringan: prioritas fase generatif, siapkan sumur dangkal/pompa komunitas.<br>
        - Hujan ekstrem: buka/drainase cepat, bersihkan kantong lumpur, inspeksi bangunan.<br>
        - SLA rendah: tambah tim reaksi cepat, otomasi notifikasi ke juru.<br>
        - Health rendah: schedule inspeksi & perbaikan darurat.
      </div>
    </div>
  </aside>

  <main>
    <section class="section">
      <div class="head"><strong>Daftar Alert</strong> <span class="small" id="scope">— Nasional</span></div>
      <div class="body">
        <div id="alertBox" class="alerts"></div>
      </div>
    </section>

    <section class="section">
      <div class="head"><strong>Timeline IAR</strong> <span class="small">klik DI untuk fokus</span></div>
      <div class="body grid-2">
        <div><canvas id="chartIAR" height="140"></canvas></div>
        <div>
          <div id="map"></div>
          <div class="small" style="margin-top:6px;">Tabel ringkas</div>
          <table id="tblDI">
            <thead><tr><th>DI</th><th>Prov</th><th>Health</th><th>SLA</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  document.getElementById('now').textContent =
    new Date().toLocaleString('id-ID',{weekday:'long', day:'2-digit', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});

  // ===== MOCK DATA
  const weeks = ['M1','M2','M3','M4','M5','M6','M7','M8'];
  const diData = [
    { id:'DI-001', name:'DI Contoh Barat', prov:'Jawa Barat', health:78, SLA:0.88,
      demand:[92,110,128,140,135,120,100,95], supply:[100,120,130,132,125,115,95,90], rain_mm:[40,55,65,80,120,90,60,30] },
    { id:'DI-002', name:'DI Rawa Timur',  prov:'Kalimantan Selatan', health:61, SLA:0.74,
      demand:[70,85,100,115,125,130,120,110], supply:[68,80,92,96,98,100,95,90],    rain_mm:[15,10,8,5,12,18,9,6] },
    { id:'DI-003', name:'DI Delta Nusantara', prov:'Jawa Timur', health:85, SLA:0.91,
      demand:[80,96,115,130,132,125,110,95], supply:[90,110,120,138,140,135,115,100], rain_mm:[25,30,35,45,50,40,30,20] }
  ];
  diData.forEach(d=> d.IAR = d.demand.map((v,i)=> v>0? d.supply[i]/v : 1));

  // ===== MAP
  const map = L.map('map',{minZoom:4,maxZoom:12,zoomControl:false}).setView([-3.5,114],5);
  L.control.zoom({position:'topright'}).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
  const mk1 = L.marker([-6.6,107.5]).addTo(map).bindTooltip('DI-001');
  const mk2 = L.marker([-3.3,114.7]).addTo(map).bindTooltip('DI-002');
  const mk3 = L.marker([-7.6,112.7]).addTo(map).bindTooltip('DI-003');
  const markers = {'DI-001':mk1,'DI-002':mk2,'DI-003':mk3};

  // ===== STATE & FILTER
  const state = {prov:'Semua', sev:'all', selected:null};
  const provs = ['Semua', ...Array.from(new Set(diData.map(d=>d.prov)))];
  const chipProvWrap = document.getElementById('chip-prov');
  provs.forEach(p=>{
    const el = document.createElement('div'); el.className='chip'+(p==='Semua'?' active':''); el.textContent=p;
    el.onclick=()=>{ [...chipProvWrap.children].forEach(c=>c.classList.remove('active')); el.classList.add('active'); state.prov=p; state.selected=null; document.getElementById('scope').textContent=p==='Semua'?'— Nasional':`— ${p}`; rerender(); };
    chipProvWrap.appendChild(el);
  });
  const chipSevWrap = document.getElementById('chip-sev');
  [...chipSevWrap.children].forEach(el=>{
    el.onclick=()=>{ [...chipSevWrap.children].forEach(c=>c.classList.remove('active')); el.classList.add('active'); state.sev=el.dataset.s; state.selected=null; rerender(); }
  });
  chipSevWrap.children[0].classList.add('active');

  // ===== ALERT ENGINE
  function genAlerts(d){
    const items=[];
    // Defisit beruntun (IAR<0.8) >=3
    let streak=0,maxStreak=0; d.IAR.forEach(x=>{if(x<0.8){streak++;maxStreak=Math.max(maxStreak,streak);}else streak=0;});
    if(maxStreak>=3) items.push({sev:'red', text:`Defisit air beruntun (${maxStreak} pekan)`});

    // Tren supply turun >30%
    const drop = (d.supply[0]>0)? d.supply.at(-1)/d.supply[0] : 1;
    if(drop<0.7) items.push({sev:'yellow', text:'Tren supply menurun >30%'});

    // Hujan ekstrem / kekeringan
    const lastRain = d.rain_mm.at(-1);
    const last2Avg = d.rain_mm.slice(-2).reduce((a,b)=>a+b,0)/2;
    if(lastRain>=150) items.push({sev:'red', text:`Hujan ekstrem ${lastRain} mm`});
    else if(last2Avg<10) items.push({sev:'yellow', text:'Kekeringan meteorologis (2 pekan <10 mm)'});

    // Health rendah
    if(d.health<60) items.push({sev:'yellow', text:`Health rendah (${d.health})`});

    // SLA rendah
    if(d.SLA<0.8) items.push({sev:'blue', text:`SLA rendah (${(d.SLA*100).toFixed(0)}%)`});

    return items;
  }
  diData.forEach(d=> d.alerts = genAlerts(d));

  function sevMatch(s){ return state.sev==='all'||s===state.sev; }
  function passFilter(d){ return (state.prov==='Semua'||d.prov===state.prov); }

  // ===== RENDER ALERTS
  function renderAlerts(){
    const box = document.getElementById('alertBox'); box.innerHTML='';
    const list = diData.filter(passFilter).flatMap(d=> d.alerts.map(a=>({di:d, ...a})));
    const filtered = list.filter(x=> sevMatch(x.sev));
    const sorted = filtered.sort((a,b)=> a.sev===b.sev ? 0 : (a.sev==='red'? -1 : (a.sev==='yellow' && b.sev!=='red' ? -1 : 1)));

    if(sorted.length===0){
      box.innerHTML = `<div class="alert"><span class="tag blue">INFO</span> Tidak ada alert pada filter saat ini.</div>`;
      return;
    }

    sorted.forEach(a=>{
      const div = document.createElement('div'); div.className='alert';
      const tag = a.sev==='red'?'red':(a.sev==='yellow'?'yellow':'blue');
      div.innerHTML = `<span class="tag ${tag}">${a.sev.toUpperCase()}</span> <strong>${a.di.name}</strong> — ${a.text}`;
      div.onclick = ()=> focusDI(a.di.id);
      box.appendChild(div);
    });
  }

  // ===== TIMELINE CHART
  const cIAR = new Chart(document.getElementById('chartIAR').getContext('2d'),{
    type:'line',
    data:{labels:weeks, datasets: diData.map((d,idx)=>({
      label:d.name, data:d.IAR.map(x=> +(x.toFixed(2))), tension:.35, fill:false,
      borderColor:['#2E86C1','#F39C12','#27AE60','#C0392B'][idx%4]
    }))},
    options:{
      plugins:{legend:{labels:{color:'#cbd5e1'}}},
      scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'},suggestedMin:0.4,suggestedMax:1.4}}
    }
  });

  // ===== TABEL
  function renderTable(){
    const tbody = document.querySelector('#tblDI tbody'); tbody.innerHTML='';
    diData.filter(passFilter).forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.name}</td><td class="small">${d.prov}</td><td>${d.health}</td><td>${(d.SLA*100).toFixed(0)}%</td>`;
      tr.onclick=()=> focusDI(d.id);
      tbody.appendChild(tr);
    });
  }

  // ===== FOCUS DI
  function focusDI(id){
    state.selected=id;
    const idx = diData.findIndex(x=>x.id===id);
    if(idx>=0){
      // highlight pada chart: tampilkan dataset terpilih paling tebal
      cIAR.data.datasets.forEach((ds,i)=>{
        ds.borderWidth = (i===idx)? 3:1.5;
        ds.borderColor = (i===idx)? '#C0392B' : ds.borderColor;
      });
      cIAR.update();
      // map focus
      const mk = markers[id]; if(mk){ mk.openTooltip(); }
    }
  }

  function rerender(){ renderAlerts(); renderTable(); }
  rerender();

  // ===== OPTIONAL: load dari file eksternal
  // fetch('siirwan_ews_input.json').then(r=>r.json()).then(js=>{
  //   // Struktur: array DI {id,name,prov,health,SLA,demand[],supply[],rain_mm[]}
  //   // diData.splice(0, diData.length, ...js); diData.forEach(d=> d.IAR = d.demand.map((v,i)=> v>0? d.supply[i]/v : 1)); diData.forEach(d=> d.alerts=genAlerts(d));
  //   // cIAR.data.datasets = diData.map((d,idx)=>({label:d.name,data:d.IAR.map(x=>+(x.toFixed(2))),tension:.35,fill:false,borderColor:['#2E86C1','#F39C12','#27AE60','#C0392B'][idx%4]})); cIAR.update();
  //   // rerender();
  // });
</script>
</body>
</html>
