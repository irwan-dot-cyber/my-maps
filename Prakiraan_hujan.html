<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>PUPR â€¢ Nowcasting Hujan BMKG â€” Sumatera & Kalimantan</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>
<style>
  :root{--H:74px;--T:56px;--card:#fff;--bd:#eee;--r:12px;--shadow:0 6px 22px rgba(0,0,0,.08);--font:system-ui,Segoe UI,Roboto,Arial}
  html,body{height:100%;margin:0;font-family:var(--font)}
  #header{position:fixed;top:0;left:0;right:0;height:var(--H);display:flex;align-items:center;gap:12px;padding:10px 14px;background:#fff;border-bottom:1px solid var(--bd);font-weight:700}
  #header img{height:48px}
  .top{position:fixed;top:var(--H);left:0;right:0;height:var(--T);display:flex;align-items:center;gap:12px;padding:8px 14px;background:#fff;border-bottom:1px solid var(--bd)}
  .pill{padding:6px 10px;border:1px solid #dcdcdc;border-radius:999px;background:#fff;cursor:pointer}
  .pill:hover{background:#f6f6f6}
  .muted{color:#666;font-size:12px}
  #map{position:absolute;top:calc(var(--H) + var(--T));left:0;right:0;bottom:0}
  .panel{position:absolute;right:12px;bottom:12px;width:340px;background:rgba(255,255,255,.97);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:10px 12px;font-size:13px}
  .panel h3{margin:4px 0 6px}
  .row{margin:4px 0}
  .legend{margin-bottom:6px}
  .legend .item{display:flex;align-items:center;gap:6px;margin:2px 0}
  .sw{width:18px;height:12px;border:1px solid #777}
  .status{font-size:12px;color:#555;margin:6px 0}
  .infobox{position:absolute;left:12px;top:calc(var(--H)+var(--T)+10px);background:rgba(255,255,255,.97);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:8px 10px;font-size:12px;max-width:360px}
  @media (max-width:720px){.panel{width:300px}}
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="">
  KEMENTERIAN PEKERJAAN UMUM DIREKTORAT JENDERAL SUMBER DAYA AIR  DIREKTORAT IRIGASI DAN RAWA
</div>

<div class="top">
  <button class="pill" id="btnSumatera">Sumatera</button>
  <button class="pill" id="btnKalimantan">Kalimantan</button>
  <button class="pill" id="btnAll">Indonesia</button>
  <button class="pill" id="btnReload">Reload Peringatan</button>
</div>

<div id="map"></div>

<div class="infobox">
  <b>Sumber:</b> BMKG Nowcasting Phase 2 (real-time).  
  <div class="muted">Update tiap Â±1 jam. Cantumkan kredit BMKG.</div>
</div>

<div class="panel">
  <h3>Legenda</h3>
  <div class="legend">
    <div class="item"><div class="sw" style="background:#FFA800"></div> Hujan Lebat Terjadi</div>
    <div class="item"><div class="sw" style="background:#FFFF00"></div> Potensi / Meluas</div>
  </div>
  <div class="status" id="statusTanggal">Status waktu berlaku: â€”</div>
  <b>Kabupaten/Kota terdampak:</b>
  <div id="impactList" class="muted">Memuatâ€¦</div>
</div>

<script>
const NOWCAST_URL="https://nowcasting.bmkg.go.id/arcgis/rest/services/production/nowcasting_publik_phase2/MapServer/2";
const map=L.map('map',{minZoom:4,maxZoom:18});
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);

const bSum=L.latLngBounds([[-6.6,94.8],[6.5,105.8]]);
const bKal=L.latLngBounds([[-4.8,108],[7.5,119.8]]);
const bAll=L.latLngBounds(bSum).extend(bKal);
map.fitBounds(bAll);

btnSumatera.onclick=()=>map.fitBounds(bSum);
btnKalimantan.onclick=()=>map.fitBounds(bKal);
btnAll.onclick=()=>map.fitBounds(bAll);

const nowcast=L.esri.featureLayer({
  url:NOWCAST_URL,
  style:f=>{
    const t=(f.properties?.tipearea||"");
    const c=/Terjadi/i.test(t)?'#FFA800':'#FFFF00';
    return {color:'#666',weight:1,fillColor:c,fillOpacity:.45};
  }
}).addTo(map);

function pad(n){return String(n).padStart(2,'0')}
function fmt(ms){try{const d=new Date(ms);return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())} WIB`}catch{return "â€”"}}
function centroidRing(r){let sx=0,sy=0;for(const c of r){sx+=c[0];sy+=c[1]}return L.latLng(sy/r.length,sx/r.length);}
function inSumKal(ll){return bAll.contains(ll);}

function refreshImpact(){
  impactList.textContent="Memuatâ€¦";
  nowcast.query().fields(["namakotakab","namaprovinsi","waktuberlaku","waktuberakhir","tipearea"]).returnGeometry(true).run((err,fc)=>{
    if(err||!fc.features?.length){impactList.innerHTML="<span class='muted'>Tidak ada peringatan aktif saat ini.</span>";statusTanggal.textContent="Status waktu berlaku: â€”";return;}
    const rows=[];let minS=null,maxE=null;
    fc.features.forEach(f=>{
      const p=f.properties||{};const ring=f.geometry?.coordinates?.[0];if(!ring)return;
      const ctr=centroidRing(ring);if(!inSumKal(ctr))return;
      rows.push({kab:(p.namakotakab||"").trim(),prov:(p.namaprovinsi||"").trim(),tipe:(p.tipearea||"").trim()});
      if(p.waktuberlaku)minS=minS?Math.min(minS,p.waktuberlaku):p.waktuberlaku;
      if(p.waktuberakhir)maxE=maxE?Math.max(maxE,p.waktuberakhir):p.waktuberakhir;
    });
    if(!rows.length){impactList.innerHTML="<span class='muted'>Tidak ada peringatan aktif di Sumatera/Kalimantan.</span>";statusTanggal.textContent="Status waktu berlaku: â€”";return;}
    const uniq=new Map();
    for(const r of rows){const k=r.kab+"#"+r.prov;const prev=uniq.get(k);if(!prev||(/Terjadi/i.test(r.tipe)&&!/Terjadi/i.test(prev.tipe)))uniq.set(k,r);}
    impactList.innerHTML=[...uniq.values()].sort((a,b)=>a.prov.localeCompare(b.prov)||a.kab.localeCompare(b.kab))
      .map(r=>`<div class="row">â€¢ <b>${r.kab}</b>, ${r.prov} <span class="muted">(${/Terjadi/i.test(r.tipe)?"ðŸŸ§ Terjadi":"ðŸŸ¨ Potensi"})</span></div>`).join("");
    statusTanggal.textContent=`Status waktu berlaku: ${minS?fmt(minS):"â€”"} s.d. ${maxE?fmt(maxE):"â€”"}`;
  });
}
nowcast.on('load',refreshImpact);
btnReload.onclick=refreshImpact;
setInterval(refreshImpact,5*60*1000);
</script>
</body>
</html>
