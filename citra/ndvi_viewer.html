<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDVI Viewer - Sawah Jawa Barat</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }
        
        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .month-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .month-btn {
            padding: 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .month-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .month-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .slider-container {
            margin-top: 10px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .legend-scale {
            display: flex;
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .legend-scale div {
            flex: 1;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .analyze-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 15px;
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info-panel {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 15px;
        }
        
        .info-panel h3 {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .info-panel p {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.5;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-label {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåæ NDVI Viewer - Area Sawah Jawa Barat</h1>
        <p>Monitoring Normalized Difference Vegetation Index untuk lahan pertanian</p>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <label>üìÖ Pilih Bulan</label>
                <div class="month-selector">
                    <button class="month-btn" data-month="0">Jan</button>
                    <button class="month-btn" data-month="1">Feb</button>
                    <button class="month-btn" data-month="2">Mar</button>
                    <button class="month-btn" data-month="3">Apr</button>
                    <button class="month-btn" data-month="4">Mei</button>
                    <button class="month-btn active" data-month="5">Jun</button>
                    <button class="month-btn" data-month="6">Jul</button>
                    <button class="month-btn" data-month="7">Agu</button>
                    <button class="month-btn" data-month="8">Sep</button>
                    <button class="month-btn" data-month="9">Okt</button>
                    <button class="month-btn" data-month="10">Nov</button>
                    <button class="month-btn" data-month="11">Des</button>
                </div>
            </div>
            
            <div class="control-group">
                <label>üé® Transparansi Layer</label>
                <div class="slider-container">
                    <input type="range" id="opacity-slider" min="0" max="100" value="70">
                </div>
            </div>
            
            <div class="control-group">
                <div class="legend">
                    <div class="legend-title">NDVI Scale</div>
                    <div class="legend-scale">
                        <div style="background: #8B4513;"></div>
                        <div style="background: #CD853F;"></div>
                        <div style="background: #DEB887;"></div>
                        <div style="background: #F0E68C;"></div>
                        <div style="background: #FFFF00;"></div>
                        <div style="background: #ADFF2F;"></div>
                        <div style="background: #7FFF00;"></div>
                        <div style="background: #00FF00;"></div>
                        <div style="background: #006400;"></div>
                    </div>
                    <div class="legend-labels">
                        <span>-1.0</span>
                        <span>0.0</span>
                        <span>1.0</span>
                    </div>
                    <p style="font-size: 11px; color: #7f8c8d; margin-top: 8px;">
                        Hijau tua = Vegetasi sehat<br>
                        Kuning/Coklat = Tanah/vegetasi kering
                    </p>
                </div>
            </div>
            
            <button class="analyze-btn" id="analyze-btn">
                üîç Analisis NDVI
            </button>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Rata-rata NDVI</div>
                    <div class="stat-value" id="avg-ndvi">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Kesehatan</div>
                    <div class="stat-value" id="health-status">-</div>
                </div>
            </div>
            
            <div class="info-panel">
                <h3>‚ÑπÔ∏è Tentang NDVI</h3>
                <p>NDVI mengukur kesehatan vegetasi berdasarkan refleksi cahaya. Nilai 0.6-0.9 menunjukkan vegetasi sangat sehat, cocok untuk sawah produktif.</p>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Menganalisis data satelit...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize map centered on West Java rice fields (Karawang area)
        const map = L.map('map').setView([-6.3, 107.5], 11);
        
        // Add base map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Sample rice field areas in Karawang/Subang
        const riceFieldAreas = [
            {
                name: "Area Sawah Karawang Timur",
                coords: [
                    [-6.28, 107.48],
                    [-6.28, 107.52],
                    [-6.32, 107.52],
                    [-6.32, 107.48]
                ],
                ndvi: 0.75
            },
            {
                name: "Area Sawah Karawang Barat",
                coords: [
                    [-6.28, 107.44],
                    [-6.28, 107.48],
                    [-6.32, 107.48],
                    [-6.32, 107.44]
                ],
                ndvi: 0.68
            },
            {
                name: "Area Sawah Subang Utara",
                coords: [
                    [-6.24, 107.48],
                    [-6.24, 107.52],
                    [-6.28, 107.52],
                    [-6.28, 107.48]
                ],
                ndvi: 0.82
            }
        ];
        
        let currentMonth = 5; // June
        let polygons = [];
        
        function getNDVIColor(ndvi) {
            if (ndvi < 0) return '#8B4513';
            if (ndvi < 0.1) return '#CD853F';
            if (ndvi < 0.2) return '#DEB887';
            if (ndvi < 0.3) return '#F0E68C';
            if (ndvi < 0.4) return '#FFFF00';
            if (ndvi < 0.5) return '#ADFF2F';
            if (ndvi < 0.6) return '#7FFF00';
            if (ndvi < 0.7) return '#00FF00';
            return '#006400';
        }
        
        function updateNDVILayer() {
            // Clear existing polygons
            polygons.forEach(p => map.removeLayer(p));
            polygons = [];
            
            // Simulate seasonal variation
            const seasonalFactor = Math.sin((currentMonth / 12) * Math.PI * 2) * 0.15;
            
            riceFieldAreas.forEach(area => {
                const adjustedNDVI = Math.max(0, Math.min(1, area.ndvi + seasonalFactor + (Math.random() * 0.1 - 0.05)));
                
                const polygon = L.polygon(area.coords, {
                    color: getNDVIColor(adjustedNDVI),
                    fillColor: getNDVIColor(adjustedNDVI),
                    fillOpacity: 0.7,
                    weight: 2
                }).addTo(map);
                
                polygon.bindPopup(`
                    <strong>${area.name}</strong><br>
                    NDVI: ${adjustedNDVI.toFixed(3)}<br>
                    Status: ${adjustedNDVI > 0.6 ? 'üü¢ Sehat' : adjustedNDVI > 0.4 ? 'üü° Sedang' : 'üî¥ Perlu Perhatian'}
                `);
                
                polygons.push(polygon);
            });
        }
        
        // Month selector
        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMonth = parseInt(this.dataset.month);
                updateNDVILayer();
            });
        });
        
        // Opacity slider
        document.getElementById('opacity-slider').addEventListener('input', function() {
            const opacity = this.value / 100;
            polygons.forEach(p => p.setStyle({ fillOpacity: opacity }));
        });
        
        // Analyze button with AI
        document.getElementById('analyze-btn').addEventListener('click', async function() {
            const loading = document.getElementById('loading');
            const statsDiv = document.getElementById('stats');
            const btn = this;
            
            btn.disabled = true;
            loading.classList.add('active');
            statsDiv.style.display = 'none';
            
            try {
                // Calculate average NDVI
                const seasonalFactor = Math.sin((currentMonth / 12) * Math.PI * 2) * 0.15;
                const avgNDVI = riceFieldAreas.reduce((sum, area) => {
                    return sum + Math.max(0, Math.min(1, area.ndvi + seasonalFactor));
                }, 0) / riceFieldAreas.length;
                
                // Simulate AI analysis with Anthropic API
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `Analisis singkat kondisi sawah dengan NDVI rata-rata ${avgNDVI.toFixed(3)} pada bulan ke-${currentMonth + 1}. Berikan status kesehatan dalam 1-2 kata dan insight singkat dalam bahasa Indonesia.`
                        }]
                    })
                });
                
                const data = await response.json();
                const analysis = data.content[0].text;
                
                // Extract health status (simple parsing)
                let healthStatus = avgNDVI > 0.7 ? "Sangat Sehat" : avgNDVI > 0.5 ? "Sehat" : avgNDVI > 0.3 ? "Sedang" : "Lemah";
                
                // Update stats
                document.getElementById('avg-ndvi').textContent = avgNDVI.toFixed(3);
                document.getElementById('health-status').textContent = healthStatus;
                statsDiv.style.display = 'grid';
                
                // Show analysis in popup
                setTimeout(() => {
                    alert(`üìä Hasil Analisis AI:\n\n${analysis}\n\nNDVI Rata-rata: ${avgNDVI.toFixed(3)}\nStatus: ${healthStatus}`);
                }, 500);
                
            } catch (error) {
                console.error('Error:', error);
                // Fallback without AI
                const seasonalFactor = Math.sin((currentMonth / 12) * Math.PI * 2) * 0.15;
                const avgNDVI = riceFieldAreas.reduce((sum, area) => {
                    return sum + Math.max(0, Math.min(1, area.ndvi + seasonalFactor));
                }, 0) / riceFieldAreas.length;
                
                let healthStatus = avgNDVI > 0.7 ? "Sangat Sehat" : avgNDVI > 0.5 ? "Sehat" : avgNDVI > 0.3 ? "Sedang" : "Lemah";
                
                document.getElementById('avg-ndvi').textContent = avgNDVI.toFixed(3);
                document.getElementById('health-status').textContent = healthStatus;
                statsDiv.style.display = 'grid';
                
                alert(`üìä Hasil Analisis:\n\nNDVI Rata-rata: ${avgNDVI.toFixed(3)}\nStatus: ${healthStatus}\n\n${avgNDVI > 0.6 ? 'Kondisi vegetasi sangat baik, sawah dalam fase pertumbuhan optimal.' : 'Perlu monitoring lebih lanjut untuk optimalisasi hasil panen.'}`);
            } finally {
                loading.classList.remove('active');
                btn.disabled = false;
            }
        });
        
        // Initialize with current month
        updateNDVILayer();
        
        // Add scale bar
        L.control.scale().addTo(map);
    </script>
</body>
</html>
