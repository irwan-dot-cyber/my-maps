<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Pelaksanaan Inpres 2/2025 Tahap 1 ‚Äî Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
  :root{
    --brand:#FFD700; --ink:#111827; --mut:#6b7280;
    --ok1:#16a34a; --ok2:#86efac; --card:#ffffff; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
  #header{background:var(--brand);color:#000;padding:10px 12px;font-weight:800;font-size:14px;display:flex;align-items:center;gap:10px}
  #header img{height:40px}
  .top-controls{position:sticky;top:0;z-index:999;background:#fff;border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .filters{display:flex;gap:8px;flex:1;flex-wrap:wrap}
  .filters select,.search-box input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;min-width:160px;background:#fff}
  .search-box{position:relative}
  #suggestions{position:absolute;top:42px;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;max-height:220px;overflow:auto;display:none}
  #suggestions div{padding:8px 10px;cursor:pointer}
  #suggestions div:hover{background:#f3f4f6}
  #map{height:54vh}
  .floating-btns{position:fixed;left:10px;bottom:calc(34vh + 10px);display:flex;flex-direction:column;gap:8px;z-index:900}
  .btn{color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.12);text-decoration:none;display:inline-block}
  .btn-home{background:linear-gradient(135deg,#2196F3,#1b7ed0)}
  .btn-reset{background:linear-gradient(135deg,#ff5722,#e24a18)}
  .btn-locate{background:linear-gradient(135deg,#4CAF50,#3f8f44)}
  #stats{background:#fafafa;border-top:1px solid var(--line);padding:12px 12px}
  .bar{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok1),var(--ok2))}
  .pill{display:inline-block;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
  .stats-row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:8px 0}
  table.stats{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;border:1px solid var(--line)}
  table.stats th,table.stats td{border-top:1px solid var(--line);padding:8px 10px;font-size:13px;text-align:left}
  table.stats th{background:#f9fafb}
  .btn-small{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .chart-wrap{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin:10px 0}
  .chart-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:10px;flex-wrap:wrap}
  .chart-title{font-weight:800}
  .btn-xsmall{padding:4px 8px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  @media (max-width:560px){
    #map{height:50vh}
    .floating-btns{bottom:calc(38vh + 10px)}
  }
</style>
</head>
<body>

<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU"/>
  <div>KEMENTERIAN PEKERJAAN UMUM ‚Ä¢ DITJEN SDA ‚Äî DIREKTORAT IRIGASI & RAWA</div>
</div>

<div class="top-controls">
  <div class="filters">
    <select id="f-bbws"><option value="">‚Äî Semua B/BWS ‚Äî</option></select>
    <select id="f-di" style="min-width:220px"><option value="">‚Äî Semua DI ‚Äî</option></select>
  </div>
  <div class="search-box">
    <input id="search" type="text" placeholder="Cari DI‚Ä¶" />
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<!-- tombol mengambang diposisikan di atas statistik agar tidak menimpa -->
<div class="floating-btns">
  <a class="btn btn-home" href="https://s.pu.go.id/MTI4OA/Pelaksanaan_INPRES2_Tahap1" target="_blank" rel="noopener">Beranda</a>
  <button class="btn btn-reset" id="btnResetRoute" type="button">Reset Rute</button>
  <button class="btn btn-locate" id="btnLocate" type="button">Posisi Saya</button>
</div>

<div id="stats">Memuat statistik‚Ä¶</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
/* ===== CONFIG ===== */
const SHEET_ID = "1LrRWGns6d68uQ7sNy2F7ecGsBrBgGbiO9S4lVXEkpXQ";
const URL_BASELINE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
const URL_LOG      = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Log_Progres`;

/* ===== Helpers ===== */
const norm = s => (s==null?'':String(s)).trim();
const canon = s => norm(s).toLowerCase();   // kunci gabungan
const $ = sel => document.querySelector(sel);

function parseGviz(text){
  text = String(text||'').replace(/^\)\]\}'\s*/, '');
  const m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+?)\)\s*;?\s*$/);
  if(!m) throw new Error('GViz payload tidak dikenali');
  const j = JSON.parse(m[1]);
  const cols = (j.table.cols||[]).map(c=>c.label || c.id || '');
  const out = [];
  (j.table.rows||[]).forEach(r=>{
    const o={};
    (r.c||[]).forEach((cell,i)=> o[cols[i] || ('C'+i)] = cell ? cell.v : '');
    out.push(o);
  });
  return out;
}

function fillSelect(el, items, placeholder){
  const cur = el.value;
  el.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent=placeholder;
  el.appendChild(opt0);
  items.sort((a,b)=> a.localeCompare(b)).forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o);
  });
  if ([...items,''].includes(cur)) el.value=cur;
}

/* ===== Map ===== */
const map = L.map('map').setView([-2.5,117],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const cluster = L.markerClusterGroup(); map.addLayer(cluster);

function markerIcon(kind){
  const url = kind==='you' ? 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
                           : 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
  return L.icon({iconUrl:url,iconSize:[25,41],iconAnchor:[12,41],
                 shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png',shadowSize:[41,41]});
}
$('#btnLocate').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation tidak didukung');
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    L.marker([lat,lng],{icon:markerIcon('you')}).addTo(map).bindPopup('Lokasi Anda').openPopup();
    map.setView([lat,lng],13);
  }, ()=>alert('Tidak dapat mengakses lokasi.'));
});
$('#btnResetRoute').addEventListener('click', ()=> map.setView([-2.5,117],5) );

/* ===== Data Loader (dua tab) ===== */
async function loadBaseline(){
  const t = await (await fetch(URL_BASELINE+'&t='+Date.now(),{cache:'no-store'})).text();
  const rows = parseGviz(t);
  // normalisasi field penting
  return rows.map(r=>{
    const bb = r['B/BWS PELAKSANA'] || r['B/BWS'] || r['BBWS'] || r['BWS'] || '';
    const di = r['NAMA DI/DIR'] || r['Nama DI/DIR'] || r['Nama DI'] || r['DI'] || '';
    const prov = r['PROVINSI'] || r['Provinsi'] || '';
    const kab  = r['KABUPATEN'] || r['Kabupaten'] || '';
    return {bbws:norm(bb), di:norm(di), prov:norm(prov), kab:norm(kab)};
  }).filter(r=>r.di);
}

async function loadLog(){
  const t = await (await fetch(URL_LOG+'&t='+Date.now(),{cache:'no-store'})).text();
  const rows = parseGviz(t);
  // normalisasi + marker (kalau ada lat/lng)
  const out = rows.map(r=>{
    const bws = r['BWS'] || r['B/BWS'] || r['BBWS'] || '';
    const di  = r['NAMA_DI'] || r['Nama DI'] || r['DI'] || '';
    const lat = parseFloat(r['LAT'] || r['Lat'] || r['Latitude'] || r['lat']);
    const lng = parseFloat(r['LNG'] || r['Long'] || r['Longitude'] || r['lng']);
    const stage = Number(r['STAGE'] || r['Stage'] || 0);
    return {bbws:norm(bws), di:norm(di), lat, lng, stage};
  }).filter(r=>r.di);

  // markers dari Log_Progres
  cluster.clearLayers();
  const markers=[];
  out.forEach(r=>{
    if(Number.isFinite(r.lat) && Number.isFinite(r.lng)){
      const pop = `<b>${r.di}</b><div style="font-size:12px;color:#555;margin:4px 0">
        B/BWS: ${r.bbws || '-'}<br/>üìç ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}<br/>Progres: ${r.stage||0}%</div>`;
      const m=L.marker([r.lat,r.lng],{icon:markerIcon('log')}).bindPopup(pop);
      cluster.addLayer(m); markers.push(m);
    }
  });
  if(markers.length){
    const g=L.featureGroup(markers); map.fitBounds(g.getBounds(),{padding:[20,20]});
  }

  return out;
}

/* ===== Stats ===== */
function buildStatsUI({totalBaseline,totalFilled,percent,byBBWS,missing}){
  const bar = `<div class="bar"><span style="width:${percent}%"></span></div>`;
  const head = `
    <div class="stats-row">
      <div class="pill">Baseline: ${totalBaseline} DI</div>
      <div class="pill">Terisi: ${totalFilled} DI</div>
      <div style="font-weight:800">${percent}% lengkap</div>
    </div>
  `;

  const rows = byBBWS
    .sort((a,b)=> a.bbws.localeCompare(b.bbws))
    .map(r=>`<tr><td>${r.bbws||'-'}</td><td>${r.filled}/${r.total}</td><td>${r.pct}%</td></tr>`)
    .join('');

  const table = `
    <table class="stats">
      <thead><tr><th>B/BWS</th><th>Terisi / Total</th><th>%</th></tr></thead>
      <tbody>${rows || '<tr><td colspan="3">Tidak ada data</td></tr>'}</tbody>
    </table>
  `;

    const exportBtn = `<button class="btn-small" id="btnExportMissing">‚¨áÔ∏è Unduh DI yang belum upload (CSV)</button>`;

  $('#stats').innerHTML = `<b>Statistik Keterisian Data (Sheet1 vs Log_Progres)</b>${head}${bar}${table}${exportBtn}`;

  // export CSV
  $('#btnExportMissing').onclick = ()=>{
    const header = ["B/BWS","DI","Provinsi","Kabupaten"];
    const lines = [header.join(",")].concat(
      missing.map(m=>[m.bbws,m.di,m.prov,m.kab].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(","))
    );
    const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='di-belum-upload.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  // mini chart (canvas)
  const canvas = $('#statsChart'); const ctx = canvas.getContext('2d');
  function draw(order='desc'){
    const data = [...byBBWS].sort((a,b)=> order==='desc' ? (b.pct-a.pct) : (a.pct-b.pct)).slice(0,8);
    const dpr=window.devicePixelRatio||1, cssW=canvas.clientWidth, cssH=canvas.clientHeight;
    canvas.width=Math.round(cssW*dpr); canvas.height=Math.round(cssH*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,cssW,cssH);
    const padL=10,padR=10,padT=10,padB=20,gap=6,w=Math.max(12,(cssW-padL-padR-gap*(data.length-1))/data.length);
    const hMax=cssH-padT-padB;
    // guides
    ctx.strokeStyle="#e5e7eb"; [0,100].forEach(p=>{const y=padT+hMax*(1-p/100);ctx.beginPath();ctx.moveTo(padL,y);ctx.lineTo(cssW-padR,y);ctx.stroke();});
    data.forEach((r,i)=>{
      const x=padL+i*(w+gap), h=Math.max(2,(r.pct/100)*hMax), y=padT+(hMax-h);
      const grd = ctx.createLinearGradient(0,y,0,y+h); grd.addColorStop(0,"#16a34a"); grd.addColorStop(1,"#86efac");
      ctx.fillStyle=grd; ctx.fillRect(x,y,w,h);
      ctx.fillStyle="#111"; ctx.font="12px system-ui,Segoe UI,Roboto,Arial"; ctx.textAlign="center";
      ctx.fillText(r.pct+"%", x+w/2, y-4);
      const short=(r.bbws||'-'); ctx.save(); ctx.translate(x+w/2, cssH-6); ctx.rotate(-Math.PI/6);
      ctx.fillStyle="#6b7280"; ctx.fillText(short.length>12?short.slice(0,11)+"‚Ä¶":short, 0, 0); ctx.restore();
    });
  }
  draw('desc');
  }

/* ===== Build ===== */
async function build(){
  try{
    $('#stats').textContent='Memuat statistik‚Ä¶';
    const [baseline, logrows] = await Promise.all([loadBaseline(), loadLog()]);

    // set untuk DI yang sudah upload (kunci: bbws|di) -> DI dihitung 1x per B/BWS
    const filledSet = new Set(
      logrows.map(r => `${canon(r.bbws)}|${canon(r.di)}`)
    );

    // agregasi baseline per B/BWS
    const mapBB = new Map();
    baseline.forEach(b=>{
      const key = b.bbws || '-';
      if(!mapBB.has(key)) mapBB.set(key,{bbws:key, diSet:new Set(), total:0, filled:0});
      const acc=mapBB.get(key);
      const diKey = `${canon(b.bbws)}|${canon(b.di)}`;
      if(!acc._seen) acc._seen=new Set();
      if(!acc._seen.has(diKey)){ acc._seen.add(diKey); acc.total++; acc.diSet.add(diKey); }
      if(filledSet.has(diKey)) acc.filled++;
    });
    const byBBWS = [...mapBB.values()].map(x=>({bbws:x.bbws,total:x.total,filled:x.filled,pct: x.total?Math.round(x.filled/x.total*100):0}));

    const totalBaseline = baseline.reduce((s, b, i, arr)=>{
      // hitung unik per B/BWS+DI
      return s;
    }, 0);
    // total baseline unik:
    const uniqBaseline = new Set(baseline.map(b => `${canon(b.bbws)}|${canon(b.di)}`));
    const totalBL = uniqBaseline.size;
    const totalFilled = [...uniqBaseline].filter(k => filledSet.has(k)).length;
    const percent = totalBL ? Math.round(totalFilled/totalBL*100) : 0;

    // missing list untuk export
    const missing = baseline.filter(b => !filledSet.has(`${canon(b.bbws)}|${canon(b.di)}`));

    buildStatsUI({totalBaseline: totalBL, totalFilled, percent, byBBWS, missing});

    // isi filter dari data LOG (yang ada markernya)
    const uniqBB = Array.from(new Set(logrows.map(r=>r.bbws).filter(Boolean)));
    const uniqDI = Array.from(new Set(logrows.map(r=>r.di).filter(Boolean)));
    fillSelect($('#f-bbws'), uniqBB, '‚Äî Semua B/BWS ‚Äî');
    fillSelect($('#f-di'),   uniqDI, '‚Äî Semua DI ‚Äî');

  }catch(e){
    console.error(e);
    $('#stats').innerHTML = `<div style="color:#b91c1c">Gagal memuat data. Pastikan kedua sheet bisa diakses publik (Anyone with the link - Viewer).</div>
                             <div style="font-size:12px;color:#6b7280">Detail: ${e.message||e}</div>`;
  }
}
build();

/* ===== Filter & Search (berbasis marker dari Log_Progres) ===== */
const index=[]; // {name, marker}
function rebuildIndex(){
  index.length=0;
  cluster.eachLayer(m=>{
    const n = (m && m.getPopup && (m.getPopup()?.getContent()||'').match(/<b>(.*?)<\/b>/));
    const diName = n ? n[1] : '';
    index.push({name: diName, marker: m});
  });
}
map.on('layeradd', rebuildIndex);

function applyFilters(){
  const fBBWS = canon($('#f-bbws').value);
  const fDI   = canon($('#f-di').value);
  const visible=[];
  cluster.clearLayers();
  // rebuild from stored markers (simple cache via window.__allMarkers if needed)
  (window.__allMarkers||[]).forEach(m=>{
    const meta=m.__meta||{};
    const passB = !fBBWS || canon(meta.bbws)===fBBWS;
    const passD = !fDI   || canon(meta.di)===fDI;
    if(passB && passD){ cluster.addLayer(m); visible.push(m); }
  });
  if(visible.length){ const g=L.featureGroup(visible); map.fitBounds(g.getBounds(),{padding:[20,20]}); }
}
$('#f-bbws').addEventListener('change', applyFilters);
$('#f-di').addEventListener('change', applyFilters);

// simpan marker saat loadLog:
(function patchClusterAdd(){
  const _add = cluster.addLayer.bind(cluster);
  window.__allMarkers = [];
  cluster.addLayer = function(m){ window.__allMarkers.push(m); return _add(m); };
})();

// search box
function showSuggestions(q){
  const box=$('#suggestions'); box.innerHTML='';
  if(!q){ box.style.display='none'; return; }
  const hits=index.filter(it=>it.name && it.name.toLowerCase().includes(q.toLowerCase())).slice(0,100);
  hits.forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ $('#search').value=it.name; box.style.display='none'; map.setView(it.marker.getLatLng(),14); it.marker.openPopup(); };
    box.appendChild(d);
  });
  box.style.display = hits.length ? 'block':'none';
}
$('#search').addEventListener('input', e=> showSuggestions(e.currentTarget.value));
$('#search').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q=e.currentTarget.value.trim().toLowerCase();
    const hit=index.find(it=>it.name && it.name.toLowerCase()===q) || index.find(it=>it.name && it.name.toLowerCase().includes(q));
    if(hit){ map.setView(hit.marker.getLatLng(),14); hit.marker.openPopup(); $('#suggestions').style.display='none'; }
  }
});
</script>
</body>
</html>
