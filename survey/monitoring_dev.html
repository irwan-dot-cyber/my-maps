<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Pelaksanaan Inpres 2/2025 Tahap 2 ‚Äî Monitoring</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
  :root{
    --brand:#FFD700; --ink:#111827; --mut:#6b7280;
    --ok1:#16a34a; --ok2:#86efac; --card:#ffffff; --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
  #header{background:var(--brand);color:#000;padding:10px 12px;font-weight:800;font-size:14px;display:flex;align-items:center;gap:10px}
  #header img{height:40px}
  .top-controls{position:sticky;top:0;z-index:999;background:#fff;border-bottom:1px solid var(--line);padding:8px 10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .filters{display:flex;gap:8px;flex:1;flex-wrap:wrap}
  .filters select,.search-box input{padding:8px 10px;border:1px solid var(--line);border-radius:10px;min-width:160px;background:#fff}
  .search-box{position:relative}
  #suggestions{position:absolute;top:42px;left:0;right:0;background:#fff;border:1px solid var(--line);border-radius:10px;max-height:220px;overflow:auto;display:none;z-index:1000}
  #suggestions div{padding:8px 10px;cursor:pointer}
  #suggestions div:hover{background:#f3f4f6}

  #map{height:54vh}
  .floating-btns{position:fixed;left:10px;bottom:calc(34vh + 10px);display:flex;flex-direction:column;gap:8px;z-index:900}
  .btn{color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;box-shadow:0 6px 14px rgba(0,0,0,.12);text-decoration:none;display:inline-block}
  .btn-home{background:linear-gradient(135deg,#2196F3,#1b7ed0)}
  .btn-reset{background:linear-gradient(135deg,#ff5722,#e24a18)}
  .btn-locate{background:linear-gradient(135deg,#4CAF50,#3f8f44)}

  #stats{background:#fafafa;border-top:1px solid var(--line);padding:12px 12px}
  .bar{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok1),var(--ok2))}
  .pill{display:inline-block;background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-weight:700}
  .stats-row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:8px 0}
  table.stats{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;border:1px solid var(--line)}
  table.stats th,table.stats td{border-top:1px solid var(--line);padding:8px 10px;font-size:13px;text-align:left}
  table.stats th{background:#f9fafb}
  .btn-small{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}

  /* label tooltip permanen */
  .di-label{
    background:rgba(255,255,255,.95);
    border:1px solid #d1d5db;
    border-radius:999px;
    padding:2px 8px;
    font-size:12px;
    color:#111827;
    white-space:nowrap;
    box-shadow:0 2px 6px rgba(0,0,0,.08);
    pointer-events:none;
  }

  @media (max-width:560px){
    #map{height:50vh}
    .floating-btns{bottom:calc(38vh + 10px)}
  }
</style>
</head>
<body>

<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU"/>
  <div>KEMENTERIAN PEKERJAAN UMUM ‚Ä¢ DITJEN SDA ‚Äî DIREKTORAT IRIGASI & RAWA ‚Äî MONITORING INPRES TAHAP 2</div>
</div>

<div class="top-controls">
  <div class="filters">
    <select id="f-bbws"><option value="">‚Äî Semua B/BWS ‚Äî</option></select>
    <select id="f-di" style="min-width:220px"><option value="">‚Äî Semua DI ‚Äî</option></select>
  </div>
  <div class="search-box">
    <input id="search" type="text" placeholder="Cari DI‚Ä¶" />
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div class="floating-btns">
  <a class="btn btn-home" href="https://s.pu.go.id/MTI4OA/Pelaksanaan_INPRES2_Tahap1" target="_blank" rel="noopener">Beranda</a>
  <button class="btn btn-reset" id="btnResetRoute" type="button">Reset Tampilan</button>
  <button class="btn btn-locate" id="btnLocate" type="button">Posisi Saya</button>
</div>

<div id="stats">Memuat statistik‚Ä¶</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const SHEET_ID="1LrRWGns6d68uQ7sNy2F7ecGsBrBgGbiO9S4lVXEkpXQ";
const URL_BASELINE=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Sheet1`;
const URL_LOG=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Log_Progres`;

const norm=s=>(s==null?'':String(s)).trim();
const canon=s=>norm(s).toLowerCase();
const $=sel=>document.querySelector(sel);

function parseGviz(text){
  text=String(text||'').replace(/^\)\]\}'\s*/,'');
  const m=text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+?)\)\s*;?\s*$/);
  if(!m) throw new Error('GViz payload tidak dikenali');
  const j=JSON.parse(m[1]);
  const cols=(j.table.cols||[]).map(c=>c.label||c.id||'');
  const out=[];
  (j.table.rows||[]).forEach(r=>{
    const o={}; (r.c||[]).forEach((cell,i)=>o[cols[i]||(i)] = cell?cell.v:'');
    out.push(o);
  });
  return out;
}

function fillSelect(el,items,placeholder){
  const cur=el.value;
  el.innerHTML='';
  const opt0=document.createElement('option');
  opt0.value=''; opt0.textContent=placeholder;
  el.appendChild(opt0);
  items.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o);
  });
  if([...items,''].includes(cur)) el.value=cur;
}

/* Map & basemap */
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
const img=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19});
const map=L.map('map',{layers:[osm]}).setView([-2.5,117],5);
L.control.layers({"OSM":osm,"Esri Imagery":img},{}).addTo(map);

let cluster=L.markerClusterGroup({disableClusteringAtZoom:15});
map.addLayer(cluster);

window.__allMarkers=[];
const origAdd=cluster.addLayer.bind(cluster);
cluster.addLayer=function(l){window.__allMarkers.push(l);return origAdd(l);};

/* tombol */
$('#btnLocate').onclick=()=>{
  if(!navigator.geolocation) return alert('Geolocation tidak didukung');
  navigator.geolocation.getCurrentPosition(p=>{
    const lat=p.coords.latitude,lng=p.coords.longitude;
    L.marker([lat,lng],{icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[25,41],iconAnchor:[12,41]})})
      .addTo(map).bindPopup('Lokasi Anda').openPopup();
    map.setView([lat,lng],13);
  },()=>alert('Tidak dapat mengakses lokasi'));
};
$('#btnResetRoute').onclick=()=>map.setView([-2.5,117],5);

async function loadBaseline(){
  const t=await (await fetch(URL_BASELINE+'&t='+Date.now())).text();
  const r=parseGviz(t);
  return r.map(x=>({
    bbws:norm(x['B/BWS PELAKSANA']||x['B/BWS']||x['BBWS']||x['BWS']||''),
    di:norm(x['NAMA DI/DIR']||x['Nama DI']||x['DI']||''),
    prov:norm(x['PROVINSI']||x['Provinsi']||''),
    kab:norm(x['KABUPATEN']||x['Kabupaten']||'')
  })).filter(a=>a.di);
}

async function loadLog(){
  const t=await (await fetch(URL_LOG+'&t='+Date.now())).text();
  const r=parseGviz(t);
  const out=r.map(x=>({
    bbws:norm(x['BWS']||x['BBWS']||x['B/BWS PELAKSANA']||''),
    di:norm(x['NAMA_DI']||x['Nama DI']||x['DI']||''),
    lat:parseFloat(x['LAT']||x['Latitude']||x['lat']),
    lng:parseFloat(x['LNG']||x['Longitude']||x['lng']),
    stage:Number(x['STAGE']||x['Progress']||0),
    file:norm(x['FILE_URL']||x['Foto_URL']||x['URL']||''),
    kec:norm(x['KECAMATAN']||x['Kecamatan']||''),
    desa:norm(x['DESA']||x['Desa']||'')
  })).filter(x=>x.di);

  cluster.clearLayers();
  const markers=[];
  out.forEach(r=>{
    if(!isFinite(r.lat)||!isFinite(r.lng)) return;
    const gmaps=`https://www.google.com/maps?q=${r.lat},${r.lng}`;
    const foto=r.file?`<div style="margin-top:6px"><a href="${r.file}" target="_blank"><img src="${r.file}" style="width:220px;height:150px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb"/></a></div>`:'';
    const popup=`<b>${r.di}</b><div style="font-size:12px;color:#555;margin:4px 0">
      B/BWS: ${r.bbws}<br>Progres: <b>${r.stage}%</b><br>Lokasi: ${r.kec}, ${r.desa}<br>üìç ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}
    </div><a href="${gmaps}" target="_blank">Buka di Google Maps</a>${foto}`;
    const iconUrl=r.stage>=100?'https://maps.google.com/mapfiles/ms/icons/red-dot.png':'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
    const m=L.marker([r.lat,r.lng],{icon:L.icon({iconUrl,iconSize:[25,41],iconAnchor:[12,41]})})
      .bindPopup(popup)
      .bindTooltip(`${r.di} ${r.stage}%`,{
        permanent:true,
        direction:'top',
        offset:[0,-25],   // geser lebih ke atas biar gak nutup marker
        className:'di-label'
      });
    m.__meta={bbws:r.bbws,di:r.di,stage:r.stage};
    cluster.addLayer(m);
    markers.push(m);
  });
  if(markers.length){
    const g=L.featureGroup(markers);map.fitBounds(g.getBounds(),{padding:[20,20]});
  }
  return out;
}

function buildStatsUI({totalBaseline,totalFilled,percent,byBBWS,missing}){
  const bar=`<div class="bar"><span style="width:${percent}%"></span></div>`;
  const head=`<div class="stats-row"><div class="pill">Baseline: ${totalBaseline} DI</div><div class="pill">Terisi: ${totalFilled} DI</div><div style="font-weight:800">${percent}% lengkap</div></div>`;
  const rows=byBBWS.sort((a,b)=>a.bbws.localeCompare(b.bbws)).map(r=>`<tr><td>${r.bbws}</td><td>${r.filled}/${r.total}</td><td>${r.pct}%</td></tr>`).join('');
  const table=`<table class="stats"><thead><tr><th>B/BWS</th><th>Terisi / Total</th><th>%</th></tr></thead><tbody>${rows||'<tr><td colspan="3">Tidak ada data</td></tr>'}</tbody></table>`;
  $('#stats').innerHTML=`<b>Statistik Keterisian Data (Sheet1 vs Log_Progres)</b>${head}${bar}${table}`;
}

async function build(){
  const [base,log]=await Promise.all([loadBaseline(),loadLog()]);
  const set=new Set(log.map(r=>`${canon(r.bbws)}|${canon(r.di)}`));
  const mapBB=new Map();
  base.forEach(b=>{
    const k=b.bbws||'-'; if(!mapBB.has(k)) mapBB.set(k,{bbws:k,total:0,filled:0});
    mapBB.get(k).total++;
    if(set.has(`${canon(b.bbws)}|${canon(b.di)}`)) mapBB.get(k).filled++;
  });
  const by=[...mapBB.values()].map(x=>({bbws:x.bbws,total:x.total,filled:x.filled,pct:x.total?Math.round(x.filled/x.total*100):0}));
  const uniqBase=new Set(base.map(b=>`${canon(b.bbws)}|${canon(b.di)}`));
  const totalBL=uniqBase.size,totalFilled=[...uniqBase].filter(k=>set.has(k)).length;
  const percent=totalBL?Math.round(totalFilled/totalBL*100):0;
  buildStatsUI({totalBaseline:totalBL,totalFilled,percent,byBBWS:by,missing:[]});
  fillSelect($('#f-bbws'),[...new Set(log.map(r=>r.bbws).filter(Boolean))],'‚Äî Semua B/BWS ‚Äî');
  fillSelect($('#f-di'),[...new Set(log.map(r=>r.di).filter(Boolean))],'‚Äî Semua DI ‚Äî');
}
build();

/* Filter */
function applyFilters(){
  const fb=canon($('#f-bbws').value),fd=canon($('#f-di').value);
  cluster.clearLayers();const v=[];
  window.__allMarkers.forEach(m=>{
    const meta=m.__meta||{};const passB=!fb||canon(meta.bbws)===fb;const passD=!fd||canon(meta.di)===fd;
    if(passB&&passD){cluster.addLayer(m);v.push(m);}
  });
  if(v.length){const g=L.featureGroup(v);map.fitBounds(g.getBounds(),{padding:[20,20]});}
}
$('#f-bbws').onchange=applyFilters;$('#f-di').onchange=applyFilters;

/* Search */
const idx=[];
setTimeout(()=>{window.__allMarkers.forEach(m=>{const n=(m.getPopup()?.getContent()||'').match(/<b>(.*?)<\/b>/);if(n)idx.push({name:n[1],marker:m});});},1500);
function showSuggestions(q){
  const box=$('#suggestions');box.innerHTML='';if(!q){box.style.display='none';return;}
  const h=idx.filter(it=>it.name&&it.name.toLowerCase().includes(q.toLowerCase())).slice(0,100);
  h.forEach(it=>{const d=document.createElement('div');d.textContent=it.name;d.onclick=()=>{map.setView(it.marker.getLatLng(),14);it.marker.openPopup();box.style.display='none';};box.appendChild(d);});
  box.style.display=h.length?'block':'none';
}
$('#search').oninput=e=>showSuggestions(e.target.value);
$('#search').onkeydown=e=>{if(e.key==='Enter'){const q=e.target.value.trim().toLowerCase();const hit=idx.find(it=>it.name.toLowerCase()===q)||idx.find(it=>it.name.toLowerCase().includes(q));if(hit){map.setView(hit.marker.getLatLng(),14);hit.marker.openPopup();$('#suggestions').style.display='none';}}};
</script>
</body>
</html>
