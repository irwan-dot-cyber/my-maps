<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pelaksanaan Inpres 2/2025 Tahap 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #header { background:#FFD700; color:black; padding:10px; display:flex; align-items:center; font-weight:bold; font-size:14px; }
  #header img { height:40px; margin-right:10px; }
  #map { height:calc(100% - 110px); }
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc; }

  .top-controls { position:absolute; top:60px; right:10px; left:10px; display:flex; justify-content:space-between; gap:10px; z-index:1000; }
  .filters { display:flex; gap:8px; flex-wrap:wrap; }
  .filters select { padding:6px; min-width:180px; }

  .search-box { background:white; padding:5px; border-radius:4px; box-shadow:0 0 4px rgba(0,0,0,.3); position:relative; }
  .search-box input { width:240px; padding:6px; }
  #suggestions { position:absolute; top:40px; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:220px; overflow-y:auto; display:none; z-index:2000; }
  #suggestions div { padding:6px; cursor:pointer; }
  #suggestions div:hover { background:#eee; }

  .bottom-buttons { position:absolute; bottom:40px; left:10px; display:flex; flex-direction:column; gap:6px; z-index:1000; }
  .custom-button{ position:relative; overflow:hidden; border-radius:10px; transition:.2s; box-shadow:0 6px 14px rgba(0,0,0,.12); font-weight:700; text-align:center; text-decoration:none; padding:8px 12px; cursor:pointer; color:#fff; }
  #home       { background: linear-gradient(135deg,#2196F3,#1b7ed0); }
  #reset-route{ background: linear-gradient(135deg,#ff5722,#e24a18); }
  #locate-me  { background: linear-gradient(135deg,#4CAF50,#3f8f44); }

  .custom-button::after{content:"";position:absolute;top:0;left:-150%;width:130%;height:100%;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.25) 50%,transparent 100%);transform:skewX(-20deg);transition:left .6s}
  .custom-button:hover::after{left:120%}
  #locate-me::before{content:"";position:absolute;inset:-4px;border-radius:10px;border:2px solid rgba(255,255,255,.65);opacity:0;transform:scale(.9);pointer-events:none;animation:pulse-ring 4s ease-out infinite}
  @keyframes pulse-ring{0%{opacity:0;transform:scale(.9)}8%{opacity:.9;transform:scale(1.02)}35%{opacity:.35;transform:scale(1.25)}60%{opacity:0;transform:scale(1.35)}100%{opacity:0;transform:scale(1.35)}}

  .leaflet-marker-icon.bounce{animation:marker-bounce 600ms cubic-bezier(.28,.84,.42,1) 1;transform-origin:bottom center}
  @keyframes marker-bounce{0%{transform:translateY(0)}25%{transform:translateY(-14px)}55%{transform:translateY(0)}75%{transform:translateY(-7px)}100%{transform:translateY(0)}}
</style>
</head>
<body>

<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  KEMENTERIAN PEKERJAAN UMUM DIREKTORAT JENDERAL SUMBER DAYA AIR ‚Äî DIREKTORAT IRIGASI & RAWA
</div>

<div class="top-controls">
  <div class="filters">
    <select id="f-bbws">
      <option value="">‚Äî Semua B/BWS ‚Äî</option>
    </select>
    <select id="f-di" style="min-width:220px">
      <option value="">‚Äî Semua DI ‚Äî</option>
    </select>
  </div>

  <div class="search-box">
    <input type="text" id="search" placeholder="Cari lokasi..." oninput="showSuggestions(this.value)"/>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div class="bottom-buttons">
  <a href="https://s.pu.go.id/MTI4OA/Pelaksanaan_INPRES2_Tahap1" target="_blank" id="home" class="custom-button">Beranda</a>
  <div id="reset-route" class="custom-button" onclick="resetRoute()">Reset Rute</div>
  <div id="locate-me" class="custom-button" onclick="locateMe()">Posisi Saya</div>
</div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
// ====== KONFIG ======
const DATA_URL  = "https://script.google.com/macros/s/AKfycbw2SaLuw0wR9TzAHIR8bo0RE7yx0LNgKVwjBfiFTjXXYeKqu1cJOgMYbAVVzMnN8gfTaw/exec";
const FOTO_BASE = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/data/images/";

// ====== PETA ======
const map = L.map('map').setView([-2.5,117],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// (opsi) placeholder info rute
function resetRoute(){
  document.getElementById('route-info').innerHTML="Jarak &amp; Waktu tempuh akan muncul di sini";
}

function locateMe(){
  if(!navigator.geolocation) return alert("Geolocation tidak didukung di browser ini.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    L.marker([lat,lng],{icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[25,41],iconAnchor:[12,41]})})
      .addTo(map).bindPopup("Lokasi Anda").openPopup();
    map.setView([lat,lng],13);
  }, ()=>alert("Tidak dapat mengakses lokasi Anda."));
}

function getIcon(name){
  const url = (name && name.startsWith('D.I.R.')) ? 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
            : 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
  return L.icon({
    iconUrl:url, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png', shadowSize:[41,41]
  });
}

// ====== DATA & MARKERS ======
const cluster = L.markerClusterGroup();
const index   = [];        // untuk search
const allMarkers = [];     // semua marker
const uniqBBWS = new Set();
const uniqDI   = new Set();

const norm = s => (s||"").toString().trim();

function fillSelect(el, items, placeholder){
  const cur = el.value;
  el.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.textContent = placeholder;
  el.appendChild(opt0);
  items.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
    const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o);
  });
  if ([...items,''].includes(cur)) el.value = cur;
}

async function loadFromGAS(){
  try{
    const res = await fetch(DATA_URL + (DATA_URL.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
    let text = await res.text();
    text = text.replace(/^\)\]\}'\s*/, ''); // strip JSONP prefix jika ada
    const payload = JSON.parse(text);
    // dukung format: array langsung atau {data:[...]}
    const rows = Array.isArray(payload) ? payload : (Array.isArray(payload.data) ? payload.data : []);
    if(!Array.isArray(rows)) throw new Error('Format respons bukan array');

    rows.forEach(r=>{
      const diName = norm(r.nama_di || r.Nama || r.DI || r['Nama DI'] || r['NAMA DI/DIR'] || r['Nama DI/DIR'] || r['Nama'] );
      const lat = parseFloat(r.y||r.lat||r.latitude||r.Latitude||r.LAT||r.lat_dd);
      const lng = parseFloat(r.x||r.lng||r.longitude||r.Longitude||r.LNG||r.long_dd);
      if(isNaN(lat)||isNaN(lng)) return;

      const prov= norm(r.provinsi||r.Provinsi||r.PROVINSI);
      const kab = norm(r.kabupaten||r.Kabupaten||r.KABUPATEN);
      const bbws= norm(r.bbws||r.BBWS||r['B/BWS']||r['BWS']||r['B/BWS PELAKSANA']);
      const note= norm(r.catatan||r.Catatan||r.Note||r.Keterangan);

      if (bbws) uniqBBWS.add(bbws);
      if (diName) uniqDI.add(diName);

      // foto (opsional)
      const list = [];
      const f1   = norm(r.foto||r.Foto||r['Foto 1']||r.Foto1);
      const f2   = norm(r['Foto 2']||r.Foto2);
      const fmul = norm(r.foto_urls||r.FotoURLs||r['Foto URLs']);
      if(f1) list.push(f1);
      if(f2) list.push(f2);
      if(fmul){ fmul.split(/[;,\n]/).forEach(u=>{ const v=norm(u); if(v) list.push(v); }); }
      const fotoList = list.map(u=>/^https?:\/\//i.test(u)? u : (FOTO_BASE+encodeURIComponent(u)));
      const imgHtml = fotoList.length
        ? `<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;max-width:240px;">
             ${fotoList.slice(0,4).map(u=>`<a href="${u}" target="_blank" rel="noopener">
               <img src="${u}" alt="foto ${diName}" style="width:110px;height:80px;object-fit:cover;border:1px solid #ddd;border-radius:6px"/>
             </a>`).join("")}
           </div>` : "";

      const popupHtml = `
        <b>${diName || '-'}</b><br>
        <div style="color:#555;font-size:12px;margin:2px 0;">üìç <b>Koordinat:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
        Provinsi: ${prov || '-'}<br>
        Kabupaten: ${kab || '-'}<br>
        BBWS: ${bbws || '-'}<br>
        Catatan: ${note || '-'}<br>
        <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">Buka di Google Maps</a><br>
        <a href="sentinel.html?lat=${lat}&lng=${lng}" target="_blank" rel="noopener">Bandingkan Sentinel</a>
        ${imgHtml}
      `;

      const m = L.marker([lat,lng],{icon:getIcon(diName)}).bindPopup(popupHtml);
      m.__meta = { diName, bbws, prov, kab, lat, lng };
      m.on('popupopen',()=>{ const el=m.getElement(); if(el){ el.classList.remove('bounce'); void el.offsetWidth; el.classList.add('bounce'); }});
      cluster.addLayer(m);
      index.push({name: diName, marker:m});
      allMarkers.push(m);
    });

    map.addLayer(cluster);
    if(allMarkers.length){
      const g=L.featureGroup(allMarkers);
      map.fitBounds(g.getBounds(), {padding:[20,20]});
    }

    fillSelect(document.getElementById('f-bbws'), [...uniqBBWS], '‚Äî Semua B/BWS ‚Äî');
    fillSelect(document.getElementById('f-di'),   [...uniqDI],   '‚Äî Semua DI ‚Äî');

  }catch(err){
    console.error(err);
    alert("Gagal memuat data dari GAS. Cek CORS/format respons.");
  }
}

// panggil saat load
loadFromGAS();

// ====== FILTER ======
function applyFilters(){
  const fBBWS = norm(document.getElementById('f-bbws').value);
  const fDI   = norm(document.getElementById('f-di').value);

  cluster.clearLayers();
  const visible = [];

  allMarkers.forEach(m=>{
    const {bbws, diName} = m.__meta || {};
    const passBBWS = !fBBWS || norm(bbws) === fBBWS;
    const passDI   = !fDI   || norm(diName) === fDI;
    if (passBBWS && passDI){
      cluster.addLayer(m);
      visible.push(m);
    }
  });

  if(visible.length){
    const g=L.featureGroup(visible);
    map.fitBounds(g.getBounds(), {padding:[20,20]});
  }
  rebuildSuggestions();
}

document.getElementById('f-bbws').addEventListener('change', applyFilters);
document.getElementById('f-di').addEventListener('change', applyFilters);

// rebuild index search sesuai filter aktif
function rebuildSuggestions(){
  const fBBWS = norm(document.getElementById('f-bbws').value);
  const fDI   = norm(document.getElementById('f-di').value);
  index.length = 0;
  allMarkers.forEach(m=>{
    const {bbws, diName} = m.__meta || {};
    const passBBWS = !fBBWS || norm(bbws) === fBBWS;
    const passDI   = !fDI   || norm(diName) === fDI;
    if (passBBWS && passDI){
      index.push({name: diName, marker: m});
    }
  });
}

// ====== PENCARIAN ======
function showSuggestions(q){
  const box=document.getElementById('suggestions');
  box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index.filter(it=>it.name && it.name.toLowerCase().includes(q.toLowerCase()));
  hits.slice(0,100).forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ document.getElementById('search').value=it.name; box.style.display="none";
      map.setView(it.marker.getLatLng(),14); it.marker.openPopup(); };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}

// enter untuk langsung zoom ke hasil terdekat
document.getElementById('search').addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const q = e.currentTarget.value.trim().toLowerCase();
    const hit = index.find(it=>it.name && it.name.toLowerCase()===q)
            || index.find(it=>it.name && it.name.toLowerCase().includes(q));
    if(hit){
      map.setView(hit.marker.getLatLng(),14); hit.marker.openPopup();
      document.getElementById('suggestions').style.display='none';
    }
  }
});
</script>

</body>
</html>
