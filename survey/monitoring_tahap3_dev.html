<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoring Tahap 3 ‚Äî Popup Foto Progres</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1222;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
    }

    html,body{ height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map{ height:100vh; width:100vw; background:var(--bg); }

    /* Popup */
    .popup-wrap{ min-width: 290px; max-width: 360px; }
    .popup-title{ font-weight:800; font-size:18px; margin:0 0 6px 0; }
    .popup-row{ margin:2px 0; color:var(--text); }
    .popup-row .lbl{ color:var(--muted); }
    .popup-hr{ border:0; border-top:1px solid var(--line); margin:10px 0; }

    .btn-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .btn-photo{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:14px;
      border:1px solid var(--line);
      text-decoration:none;
      user-select:none;
      transition:transform .05s ease, background .15s ease;
    }
    .btn-photo.active{
      background: var(--blue);
      border-color: var(--blue);
      color:#fff;
      cursor:pointer;
    }
    .btn-photo.active:hover{ background: var(--blue2); transform: translateY(-1px); }
    .btn-photo.disabled{
      background: #f3f4f6;
      border-color: var(--line);
      color:#9ca3af;
      cursor:not-allowed;
    }

    .gmaps-link{
      color:var(--blue);
      font-weight:700;
      text-decoration:none;
    }
    .gmaps-link:hover{ text-decoration:underline; }

    .leaflet-popup-content{ margin:14px 14px 12px 14px; }
    .leaflet-popup-content-wrapper{ border-radius:16px; }

    /* Marker style (circle) */
    .marker-circle{
      width:14px; height:14px;
      border-radius:999px;
      background:#60a5fa;
      border:2px solid #2563eb;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
/** =========================
 *  KONFIG
 *  ========================= */
const SHEET_ID   = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY";
const SHEET_LOG  = "log_tahap3";

// Proxy untuk anti CORS (kalau nggak perlu, kosongin "")
const PROXY_PREFIX = "https://gas-proxy3.tuic1677.workers.dev/?url=";

/** =========================
 *  UTIL
 *  ========================= */
function wrapProxy(url){
  return PROXY_PREFIX ? (PROXY_PREFIX + encodeURIComponent(url)) : url;
}
function pickAny(obj, keys){
  for (const k of keys){
    if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
  }
  return "";
}
function normText(s){
  return String(s ?? "")
    .toLowerCase()
    .trim()
    .replace(/\s+/g,' ')
    .replace(/[^\w\s]/g,'')
    .replace(/^di\s+/,'')
    .replace(/^daerah irigasi\s+/,'');
}
function bucketizeProgress(p){
  p = Number(p) || 0;
  if (p >= 100) return 100;
  if (p >= 75)  return 75;
  if (p >= 50)  return 50;
  if (p >= 25)  return 25;
  return 0;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function gmapsLink(lat,lng){
  if (!lat || !lng) return "";
  const u = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}`;
  return `<a class="gmaps-link" href="${u}" target="_blank" rel="noopener">Google Maps</a>`;
}

/** =========================
 *  GVIZ FETCH
 *  ========================= */
async function fetchGVizRows(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`;
  const res = await fetch(wrapProxy(url));
  const txt = await res.text();

  const m = txt.match(/setResponse\((.*)\);?\s*$/s);
  if (!m) throw new Error("Respon bukan GViz. Potongan awal: " + txt.slice(0,120));

  const json = JSON.parse(m[1]);
  const table = json.table;
  const cols = table.cols.map(c => (c.label || "").trim());

  return table.rows.map(r => {
    const o = {};
    r.c.forEach((cell, i) => {
      const v = cell ? (cell.f ?? cell.v) : "";
      o[cols[i] || ("col"+i)] = v;
    });
    return o;
  });
}

/** =========================
 *  MAP INIT
 *  ========================= */
const map = L.map("map", { zoomControl:true }).setView([-2.5, 118], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

/** =========================
 *  LOG INDEX
 *  ========================= */
window.__LOG_T3_INDEX__ = {};     // key -> rec
window.__LOG_T3_READY__ = false;  // bool

function buildLogIndex(rows){
  const idx = {};

  for (const r of rows){
    const di   = r.di || r["Nama DI"] || r["Nama_DI"] || r["nama_di"] || r["namadi"];
    const prov = r.provinsi || r["Provinsi"] || r["provinsi"];
    const kab  = r.kabupaten || r["Kabupaten"] || r["kabupaten"] || r["Kab/Kota"];
    const kec  = r.kecamatan || r["Kecamatan"] || r["kecamatan"] || r["Kec"];
    const desa = r.desa || r["Desa"] || r["desa"];

    const p = Number(r.progress ?? r["progress"] ?? 0) || 0;
    const foto = r.foto_url || r["foto_url"] || r["foto"] || "";

    const bucket = bucketizeProgress(p);
    const diN = normText(di);
    if (!diN) continue;

    const keys = [
      `di:${diN}`,
      `di:${diN}|kab:${normText(kab)}`,
      `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}`,
      `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}|desa:${normText(desa)}`
    ];

    for (const k of keys){
      if (!idx[k]){
        idx[k] = {
          di, provinsi:prov, kabupaten:kab, kecamatan:kec, desa,
          latestProgress: 0,
          stages: {} // {25:url, 50:url,...}
        };
      }
      if (foto) idx[k].stages[bucket] = foto;
      if (p > idx[k].latestProgress) idx[k].latestProgress = p;
    }
  }

  window.__LOG_T3_INDEX__ = idx;
  window.__LOG_T3_READY__ = true;
}

/** =========================
 *  DEDUP MARKER PER DI
 *  ========================= */
function pickLatestPointPerDI(rows){
  // 1 DI = 1 titik, ambil row terbaru berdasar timestamp (string compare cukup untuk format sheet timestamp)
  const byDI = new Map();

  for (const r of rows){
    const di = r.di || r["Nama DI"] || r["Nama_DI"] || r["nama_di"] || r["namadi"];
    const diN = normText(di);
    if (!diN) continue;

    const lat = Number(r.lat ?? r.latitude ?? r.Lat ?? r.LAT);
    const lng = Number(r.lng ?? r.longitude ?? r.Long ?? r.LNG ?? r.lon);
    if (!isFinite(lat) || !isFinite(lng)) continue;

    const ts = String(r.timestamp ?? r["timestamp"] ?? "");

    const old = byDI.get(diN);
    if (!old){
      byDI.set(diN, { r, lat, lng, ts });
    }else{
      const oldTs = String(old.ts ?? "");
      if (ts && ts > oldTs){
        byDI.set(diN, { r, lat, lng, ts });
      }
    }
  }

  return Array.from(byDI.values());
}

/** =========================
 *  POPUP: cari record log untuk props
 *  ========================= */
function getLogRecForRow(row){
  const di   = row.di || row["Nama DI"] || row["Nama_DI"] || row["nama_di"] || row["namadi"];
  const kab  = row.kabupaten || row["Kabupaten"] || row["kabupaten"] || row["Kab/Kota"];
  const kec  = row.kecamatan || row["Kecamatan"] || row["kecamatan"] || row["Kec"];
  const desa = row.desa || row["Desa"] || row["desa"];

  const diN = normText(di);
  const idx = window.__LOG_T3_INDEX__ || {};

  const k1 = `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}|desa:${normText(desa)}`;
  const k2 = `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}`;
  const k3 = `di:${diN}|kab:${normText(kab)}`;
  const k4 = `di:${diN}`;

  return idx[k1] || idx[k2] || idx[k3] || idx[k4] || null;
}

function buildPopupHtmlFromRow(row, lat, lng){
  const di   = row.di || row["Nama DI"] || row["Nama_DI"] || row["nama_di"] || row["namadi"] || "(Tanpa nama)";
  const balai= row.balai || row["Balai"] || row["BWS"] || row["bws"] || "-";
  const prov = row.provinsi || row["Provinsi"] || "-";
  const kab  = row.kabupaten || row["Kabupaten"] || row["Kab/Kota"] || "-";
  const kec  = row.kecamatan || row["Kecamatan"] || row["Kec"] || "-";
  const desa = row.desa || row["Desa"] || "-";

  const rec = getLogRecForRow(row);
  const prog = rec ? (Number(rec.latestProgress)||0) : 0;

  const stagesList = [25,50,75,100];
  const btns = stagesList.map(s=>{
    const url = rec?.stages?.[s];
    if (!url) return `<span class="btn-photo disabled">Foto ${s}%</span>`;
    return `<a class="btn-photo active" href="${url}" target="_blank" rel="noopener">Foto ${s}%</a>`;
  }).join("");

  return `
    <div class="popup-wrap">
      <div class="popup-title">${escapeHtml(di)}</div>
      <div class="popup-row"><span class="lbl">Balai:</span> ${escapeHtml(balai)}</div>
      <div class="popup-row"><span class="lbl">Provinsi:</span> ${escapeHtml(prov)}</div>
      <div class="popup-row"><span class="lbl">Kabupaten:</span> ${escapeHtml(kab)}</div>
      <div class="popup-row"><span class="lbl">Kecamatan:</span> ${escapeHtml(kec)}</div>
      <div class="popup-row"><span class="lbl">Desa:</span> ${escapeHtml(desa)}</div>
      <div class="popup-row"><span class="lbl">Progress:</span> ${prog.toFixed(0)}%</div>
      <div class="popup-row">üìç ${escapeHtml(lat)} , ${escapeHtml(lng)} &nbsp; ${gmapsLink(lat,lng)}</div>
      <hr class="popup-hr"/>
      <div class="btn-grid">${btns}</div>
    </div>
  `;
}

/** =========================
 *  LOAD + RENDER MARKERS
 *  ========================= */
async function loadAll(){
  // 1) ambil semua rows log
  const rows = await fetchGVizRows(SHEET_LOG);

  // 2) bikin index log (buat progress max + foto per bucket)
  buildLogIndex(rows);

  // 3) buat marker 1 DI 1 titik (ambil terbaru)
  const points = pickLatestPointPerDI(rows);

  markersLayer.clearLayers();

  for (const item of points){
    const r = item.r;
    const lat = item.lat;
    const lng = item.lng;

    const icon = L.divIcon({ className:"", html:`<div class="marker-circle"></div>`, iconSize:[14,14], iconAnchor:[7,7] });
    const m = L.marker([lat,lng], { icon }).addTo(markersLayer);

    m.on("click", ()=>{
      if (!window.__LOG_T3_READY__){
        m.bindPopup(`<b>${escapeHtml(r.di || r["Nama DI"] || "DI")}</b><br>Memuat log tahap 3...`).openPopup();
        const t = setInterval(()=>{
          if (window.__LOG_T3_READY__){
            clearInterval(t);
            m.setPopupContent(buildPopupHtmlFromRow(r, lat, lng));
          }
        }, 200);
        setTimeout(()=>{ try{ clearInterval(t); }catch(e){} }, 8000);
        return;
      }
      m.bindPopup(buildPopupHtmlFromRow(r, lat, lng)).openPopup();
    });
  }

  // Fit bounds
  try{
    const b = markersLayer.getBounds();
    if (b && b.isValid()) map.fitBounds(b, { padding:[20,20] });
  }catch(e){}
}

/** =========================
 *  BOOT
 *  ========================= */
loadAll().catch(err => {
  console.error(err);
  alert("Gagal memuat data. Cek console. " + (err?.message || err));
});
</script>
</body>
</html>
