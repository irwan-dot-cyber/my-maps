<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pelaksanaan Inpres 2/2025 Tahap 3 - Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet & MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    :root{
      --brand:#FFD700; --ink:#111827; --mut:#6b7280;
      --ok1:#16a34a; --ok2:#86efac; --card:#ffffff; --line:#e5e7eb;
      --btn:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
    #header{
      background:var(--brand);color:#000;padding:10px 12px;
      font-weight:800;font-size:14px;display:flex;align-items:center;gap:10px
    }
    #header img{height:40px}

    .top-controls{
      position:sticky;top:0;z-index:999;
      background:#fff;border-bottom:1px solid var(--line);
      padding:8px 10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    .filters{display:flex;gap:8px;flex:1;flex-wrap:wrap}
    .filters select,.search-box input{
      padding:8px 10px;border:1px solid var(--line);border-radius:10px;
      min-width:160px;background:#fff
    }
    .search-box{position:relative}
    #suggestions{
      position:absolute;top:42px;left:0;right:0;background:#fff;
      border:1px solid var(--line);border-radius:10px;
      max-height:220px;overflow:auto;display:none;z-index:1000
    }
    #suggestions div{padding:8px 10px;cursor:pointer}
    #suggestions div:hover{background:#f3f4f6}

    #map{height:54vh}

    #stats{background:#fafafa;border-top:1px solid var(--line);padding:12px}
    .stats-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-bottom:8px
    }
    .stats-title{font-weight:800;font-size:15px}
    .stats-actions{display:flex;gap:6px;flex-wrap:wrap}
    .btn-mini{
      display:inline-block;font-size:12px;font-weight:700;
      padding:6px 10px;border-radius:10px;border:1px solid var(--line);
      background:#fff;color:#1f2937;text-decoration:none;line-height:1
    }
    .btn-mini.primary{background:var(--btn);color:#fff;border-color:var(--btn)}
    .btn-mini.success{background:#4CAF50;color:#fff;border-color:#4CAF50}
    .btn-mini.warn{background:#ff5722;color:#fff;border-color:#ff5722}

    .bar{height:12px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok1),var(--ok2))}
    .pill{
      display:inline-block;background:#fff;border:1px solid var(--line);
      border-radius:999px;padding:4px 10px;font-weight:700
    }
    .stats-row{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      flex-wrap:wrap;margin:8px 0
    }
    table.stats{
      width:100%;border-collapse:collapse;margin-top:8px;
      background:#fff;border:1px solid var(--line)
    }
    table.stats th,table.stats td{
      border-top:1px solid var(--line);padding:8px 10px;
      font-size:13px;text-align:left
    }
    table.stats th{background:#f9fafb}

    .di-label{
      background:rgba(255,255,255,.92);
      border:1px solid #d1d5db;
      border-radius:999px;
      padding:2px 8px;font-size:12px;color:#111827;
      white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.08);
      transform: translateY(-28px);pointer-events:none;display:none;
    }

    .stage-grid{
      display:grid;grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;margin-top:6px
    }
    .btn-photo{
      display:inline-block;text-align:center;
      padding:6px 4px;border-radius:10px;
      border:1px solid var(--line);
      background:#f3f4f6;color:#6b7280;
      font-size:11px;font-weight:700;
      text-decoration:none;line-height:1.2;
      cursor:pointer;
    }
    .btn-photo.active{
      background:var(--btn);color:#fff;border-color:var(--btn)
    }
    .btn-photo.disabled{
      cursor:not-allowed;background:#f3f4f6;
      color:#9ca3af;border-color:#e5e7eb;text-decoration:none
    }

    @media (max-width:560px){
      #map{height:50vh}
      .stats-title{font-size:14px}
      .btn-mini{font-size:11px;padding:6px 8px}
    }
  </style>
</head>
<body>

<div id="header">
  <img src="https://irwan-dot-cyber.github.io/my-maps/assets/LogoPUPR.png" alt="Logo PU"/>
  <div>KEMENTERIAN PEKERJAAN UMUM â€¢ DITJEN SDA â€¢ DIREKTORAT IRIGASI DAN RAWA â€¢ MONITORING INPRES 2/2025 TAHAP 3</div>
</div>

<div class="top-controls">
  <div class="filters">
    <select id="f-bbws"><option value="">â€” Semua B/BWS (yang sudah upload) â€”</option></select>
    <select id="f-di" style="min-width:220px" disabled><option value="">â€” Pilih B/BWS dulu â€”</option></select>
  </div>
  <div class="search-box">
    <input id="search" type="text" placeholder="Cari Nama DI / kabupaten / desaâ€¦" />
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div id="stats">Memuat statistikâ€¦</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function(){
  "use strict";

  const SHEET_ID     = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY";
  const GID_BASELINE = "466754170";
  const GID_LOG      = "732855223";

  const URL_BASELINE = "https://docs.google.com/spreadsheets/d/" + SHEET_ID + "/export?format=csv&gid=" + GID_BASELINE;
  const URL_LOG      = "https://docs.google.com/spreadsheets/d/" + SHEET_ID + "/export?format=csv&gid=" + GID_LOG;

  const ZOOM_LABEL   = 14;

  function $(sel){ return document.querySelector(sel); }
  function norm(s){ return (s == null ? "" : String(s)).trim(); }
  function canon(s){ return norm(s).toLowerCase(); }

  /* helper buka foto di tab baru; Drive â†’ viewer */
  function openPhotoInWindow(url, title){
    let u = String(url || "").trim();
    if (!u) return;

    if (u.indexOf("drive.google.com") !== -1){
      const m = u.match(/[\?&]id=([^&]+)/);
      if (m){
        u = "https://drive.google.com/uc?export=view&id=" + m[1];
      }
    }
    window.open(u, "_blank", "noopener");
  }

  /* CSV parser */
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (inQuotes) {
        if (c === '"' && next === '"') {
          cur += '"'; i++;
        } else if (c === '"') {
          inQuotes = false;
        } else {
          cur += c;
        }
      } else {
        if (c === '"') {
          inQuotes = true;
        } else if (c === ",") {
          row.push(cur); cur = "";
        } else if (c === "\r") {
          // skip
        } else if (c === "\n") {
          row.push(cur); rows.push(row); row = []; cur = "";
        } else {
          cur += c;
        }
      }
    }
    if (cur.length > 0 || row.length > 0) {
      row.push(cur);
      rows.push(row);
    }

    if (!rows.length) return [];
    const headers = rows[0].map(h => h.trim());
    return rows.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h] = (r[idx] || "").trim();
      });
      return obj;
    });
  }

  /* baca progress: kolom yg mengandung "progress" */
  function readProgress(row){
    let val = null;
    Object.keys(row).forEach(k => {
      const clean = k.toLowerCase().replace(/[^a-z0-9]/g,"");
      if (clean.indexOf("progress") !== -1 && val === null){
        val = row[k];
      }
    });
    if (val == null || val === "") return 0;
    val = String(val).trim();
    const m = val.match(/[\d.,]+/);
    if (!m) return 0;
    const num = parseFloat(m[0].replace(",", "."));
    return isFinite(num) ? num : 0;
  }

  /* baca url foto: kolom yg mengandung "foto" & "url" */
  function readFotoUrl(row){
    let url = null;
    Object.keys(row).forEach(k => {
      const clean = k.toLowerCase().replace(/[^a-z0-9]/g,"");
      if (clean.indexOf("foto") !== -1 && clean.indexOf("url") !== -1 && url === null){
        url = row[k];
      }
    });
    if (!url) return "";
    url = String(url).trim();
    if (!/^https?:\/\//i.test(url)) return "";
    return url;
  }

  function uniqueList(arr){
    const set = {};
    const out = [];
    arr.forEach(v => {
      if (v && !set[v]){ set[v] = true; out.push(v); }
    });
    return out;
  }

  /* Leaflet */
  const osm  = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:"Â© OpenStreetMap"});
  const img  = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19, attribution:"Tiles Â© Esri/Maxar"});

  const map  = L.map("map",{layers:[osm]}).setView([-2.5,117],5);
  L.control.layers({"OSM":osm,"Esri Imagery":img}, {}, {position:"topright"}).addTo(map);

  const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 15 });
  map.addLayer(cluster);

  const labelsLayer = L.layerGroup().addTo(map);
  let allMarkers  = [];

  const oldAdd = cluster.addLayer.bind(cluster);
  cluster.addLayer = function(layer){
    allMarkers.push(layer);
    return oldAdd(layer);
  };

  let baselineData = [];
  let logGroups    = [];
  let balaiToLokasiUploaded = {};
  let searchIndex  = [];

  function refreshLabels(){
    const show = map.getZoom() >= ZOOM_LABEL;
    allMarkers.forEach(m => {
      const lbl = m.__label;
      if (!lbl) return;
      const el = lbl.getElement() || lbl._icon;
      if (!el) return;
      const vp = cluster.getVisibleParent(m);
      const visible = (vp === m) && show;
      el.style.display = visible ? "block" : "none";
    });
  }

  map.on("zoomend moveend", refreshLabels);
  cluster.on("animationend spiderfied unspiderfied", refreshLabels);

  function makeKey(b){
    if (b.key) return "key:" + canon(b.key);
    return "loc:" + [
      canon(b.balai || ""),
      canon(b.prov  || ""),
      canon(b.kab   || ""),
      canon(b.desa  || "")
    ].join("|");
  }

  function makeKeyFromLog(r){
    if (r.key) return "key:" + canon(r.key);
    return "loc:" + [
      canon(r.balai || ""),
      canon(r.prov  || ""),
      canon(r.kab   || ""),
      canon(r.desa  || "")
    ].join("|");
  }

  function loadBaseline(){
    return fetch(URL_BASELINE + "&t=" + Date.now(), {cache:"no-store"})
      .then(res => {
        if (!res.ok) throw new Error("HTTP "+res.status+" baseline");
        return res.text();
      })
      .then(text => {
        const rows = parseCSV(text);
        return rows.map(r => {
          const rawBalai = norm(
            r["B/BWS"] || r["BWS"] || r["BBWS"] || r["Balai"] || r["balai"] || ""
          );
          let balai = rawBalai;
          if (!balai || /^[0-9.,\-\s]+$/.test(balai) || !/bws/i.test(balai)){
            balai = "";
          }
          return {
            key   : norm(r["key"] || r["Key"] || ""),
            balai : balai,
            prov  : norm(r["provinsi"] || r["Provinsi"] || ""),
            kab   : norm(r["kabupate di"] || r["kabupaten di"] || r["kabupaten"] || r["KABUPATEN"] || ""),
            desa  : norm(r["kecamata desa"] || r["desa"] || r["DESA"] || ""),
            namaDi: norm(r["Nama DI"]  || r["nama_di"]  || r["Nama_DI"]  || r["DI"] || "")
          };
        });
      });
  }

  function loadLogTahap3(baseline){
    return fetch(URL_LOG + "&t=" + Date.now(), {cache:"no-store"})
      .then(res => {
        if (!res.ok) throw new Error("HTTP "+res.status+" log_tahap3");
        return res.text();
      })
      .then(text => {
        const rows = parseCSV(text);

        const baselineKeyMap = {};
        const baselineLocMap = {};
        baseline.forEach(b => {
          if (b.key){
            baselineKeyMap[canon(b.key)] = b;
          }
          const locKey = [
            canon(b.balai || ""),
            canon(b.prov  || ""),
            canon(b.kab   || ""),
            canon(b.desa  || "")
          ].join("|");
          if (locKey !== "|||"){
            baselineLocMap[locKey] = b;
          }
        });

        allMarkers = [];
        cluster.clearLayers();
        labelsLayer.clearLayers();
        balaiToLokasiUploaded = {};

        const groupMap = {};

        rows.forEach(r => {
          const keyVal = norm(r["key"]);
          const latNum = parseFloat(r["lat"]);
          const lngNum = parseFloat(r["lng"]);
          if (!isFinite(latNum) || !isFinite(lngNum)) return;

          const balai = norm(r["balai"] || r["BWS"] || r["B/BWS"] || "");
          const prov  = norm(r["provinsi"]);
          const kab   = norm(r["kabupate di"] || r["kabupaten di"] || r["kabupaten"]);
          const desa  = norm(r["desa"]);
          const kec   = norm(r["kecamatan"] || r["kecamata"] || r["kec"]);

          let namaDi = norm(
            r["di"] || r["DI"] || r["Nama DI"] || r["nama_di"] || r["Nama_DI"] || ""
          );
          if (!namaDi && keyVal){
            const b1 = baselineKeyMap[canon(keyVal)];
            if (b1 && b1.namaDi) namaDi = b1.namaDi;
          }
          if (!namaDi){
            const locKey = [
              canon(balai || ""),
              canon(prov  || ""),
              canon(kab   || ""),
              canon(desa  || "")
            ].join("|");
            const b2 = baselineLocMap[locKey];
            if (b2 && b2.namaDi) namaDi = b2.namaDi;
          }

          const progressVal = readProgress(r);
          const fotoUrlRaw  = readFotoUrl(r);
          const hasFoto     = /^https?:\/\//i.test(fotoUrlRaw);

          const groupId = keyVal ? "key:" + canon(keyVal)
                                 : "coord:" + latNum.toFixed(6) + "," + lngNum.toFixed(6);

          let g = groupMap[groupId];
          if (!g){
            g = {
              groupId: groupId,
              key: keyVal,
              balai: balai,
              prov:  prov,
              kab:   kab,
              kec:   kec,
              desa:  desa,
              lat:   latNum,
              lng:   lngNum,
              namaDi: namaDi,
              stages: {25:"",50:"",75:"",100:""},
              latestProgress: 0
            };
            groupMap[groupId] = g;
          } else {
            if (!g.namaDi && namaDi) g.namaDi = namaDi;
          }

          if (hasFoto && progressVal > 0){
            const stages = [25,50,75,100];
            let bucket = stages[0];
            let minDiff = Math.abs(progressVal - bucket);
            for (let i = 1; i < stages.length; i++){
              const d = Math.abs(progressVal - stages[i]);
              if (d < minDiff){
                minDiff = d;
                bucket = stages[i];
              }
            }
            g.stages[bucket] = fotoUrlRaw;
          }

          if (progressVal > g.latestProgress){
            g.latestProgress = progressVal;
          }
        });

        const groups = Object.keys(groupMap).map(id => groupMap[id]);
        const markers = [];

        groups.forEach(rec => {
          const prog   = isFinite(rec.latestProgress) ? rec.latestProgress : 0;
          const stagesList = [25,50,75,100];
          const lokasiPendek = (rec.kab || "-") + " / " + (rec.desa || rec.kec || "-");
          const title = rec.namaDi ? ("DI. " + rec.namaDi) : lokasiPendek;

          const keyBalai = rec.balai || "-";
          if (!balaiToLokasiUploaded[keyBalai]) balaiToLokasiUploaded[keyBalai] = {};
          balaiToLokasiUploaded[keyBalai][lokasiPendek] = true;

          const gmaps = "https://www.google.com/maps?q=" + rec.lat + "," + rec.lng;

          const popupDiv = document.createElement("div");

          const titleEl = document.createElement("b");
          titleEl.textContent = title;
          popupDiv.appendChild(titleEl);

          const infoDiv = document.createElement("div");
          infoDiv.style.fontSize = "12px";
          infoDiv.style.color = "#555";
          infoDiv.style.margin = "4px 0";

          function addLine(label, value){
            const p = document.createElement("div");
            p.textContent = label + ": " + (value || "-");
            infoDiv.appendChild(p);
          }

          addLine("Balai", rec.balai || "-");
          addLine("Provinsi", rec.prov || "-");
          addLine("Kabupaten", rec.kab || "-");
          addLine("Kecamatan", rec.kec || "-");
          addLine("Desa", rec.desa || "-");

          const pProg = document.createElement("div");
          const bProg = document.createElement("b");
          bProg.textContent = Math.round(prog) + "%";
          pProg.textContent = "Progress: ";
          pProg.appendChild(bProg);
          infoDiv.appendChild(pProg);

          const pCoord = document.createElement("div");
          const spanCoord = document.createElement("span");
          spanCoord.textContent = "ðŸ“ " + rec.lat.toFixed(6) + ", " + rec.lng.toFixed(6) + " â€” ";
          pCoord.appendChild(spanCoord);
          const aMap = document.createElement("a");
          aMap.href = gmaps;
          aMap.target = "_blank";
          aMap.rel = "noopener";
          aMap.textContent = "Google Maps";
          pCoord.appendChild(aMap);
          infoDiv.appendChild(pCoord);

          popupDiv.appendChild(infoDiv);

          const grid = document.createElement("div");
          grid.className = "stage-grid";

          stagesList.forEach(stage => {
            const url = rec.stages[stage];
            if (url && /^https?:\/\//i.test(url)){
              const ab = document.createElement("a");
              ab.className = "btn-photo active";
              ab.href = "#";
              ab.textContent = "Foto " + stage + "%";
              ab.onclick = function(e){
                e.preventDefault();
                openPhotoInWindow(url, title + " " + stage + "%");
              };
              grid.appendChild(ab);
            } else {
              const span = document.createElement("span");
              span.className = "btn-photo disabled";
              span.textContent = "Foto " + stage + "%";
              grid.appendChild(span);
            }
          });

          popupDiv.appendChild(grid);

          const iconUrl = (prog >= 100)
            ? "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
            : "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";

          const marker = L.marker([rec.lat, rec.lng], {
            icon: L.icon({
              iconUrl: iconUrl,
              iconSize: [25,41],
              iconAnchor: [12,41],
              shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
              shadowSize: [41,41]
            })
          }).bindPopup(popupDiv);

          marker.__meta = { bbws: rec.balai, di: title, stage: prog };
          cluster.addLayer(marker);
          markers.push(marker);

          const labelMarker = L.marker([rec.lat, rec.lng], {
            icon: L.divIcon({
              className: "di-label",
              html: title + " " + Math.round(prog) + "%",
              iconSize: null
            }),
            interactive: false,
            zIndexOffset: 1000
          }).addTo(labelsLayer);
          marker.__label = labelMarker;
        });

        if (markers.length){
          const fg = L.featureGroup(markers);
          map.fitBounds(fg.getBounds(), {padding:[20,20]});
        }

        setTimeout(refreshLabels, 0);

        return groups;
      });
  }

  function buildStats(data){
    const baseline = data.baseline;
    const logs     = data.logs;

    const logKeys = {};
    logs.forEach(g => {
      const k = makeKeyFromLog(g);
      logKeys[k] = true;
    });

    const totalBaseline = baseline.length;
    const totalFilled   = Object.keys(logKeys).length;
    const percent       = totalBaseline ? Math.round(totalFilled/totalBaseline*100) : 0;

    const mapBalaiBase   = {};
    const mapBalaiFilled = {};

    baseline.forEach(b => {
      const balai = b.balai || "-";
      if (!mapBalaiBase[balai]) mapBalaiBase[balai] = {balai: balai, total:0, filled:0};
      mapBalaiBase[balai].total += 1;
    });

    logs.forEach(g => {
      const balai = g.balai || "-";
      if (!mapBalaiFilled[balai]) mapBalaiFilled[balai] = {};
      mapBalaiFilled[balai][makeKeyFromLog(g)] = true;
    });

    Object.keys(mapBalaiBase).forEach(balai => {
      const filledSet = mapBalaiFilled[balai];
      const filled = filledSet ? Object.keys(filledSet).length : 0;
      mapBalaiBase[balai].filled = filled;
      mapBalaiBase[balai].pct    = mapBalaiBase[balai].total ?
        Math.round(filled / mapBalaiBase[balai].total * 100) : 0;
    });

    const rowsArr = Object.keys(mapBalaiBase).map(k => mapBalaiBase[k]);

    const missing = baseline.filter(b => !logKeys[makeKey(b)]);

    const statsDiv = $("#stats");

    let html = "";
    html += '<div class="stats-head">';
    html +=   '<div class="stats-actions">';
    html +=     '<a class="btn-mini" href="https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html" target="_blank" rel="noopener">Beranda</a>';
    html +=     '<button id="btnResetView" class="btn-mini warn" type="button">Reset Tampilan</button>';
    html +=     '<button id="btnLocateMini" class="btn-mini success" type="button">Posisi Saya</button>';
    html +=   '</div>';
    html +=   '<div class="stats-title">Statistik Keterisian Log Tahap 3</div>';
    html += '</div>';

    html += '<div class="stats-row">';
    html +=   '<div class="pill">Baseline: ' + totalBaseline + ' lokasi</div>';
    html +=   '<div class="pill">Sudah terisi: ' + totalFilled + ' lokasi</div>';
    html +=   '<div class="pill">Keterisian: ' + percent + '%</div>';
    html += '</div>';

    html += '<div class="bar"><span style="width:'+percent+'%"></span></div>';

    html += '<table class="stats">';
    html +=   '<thead><tr><th>Balai</th><th>Baseline lokasi</th><th>Sudah terisi</th><th>%</th></tr></thead>';
    html +=   '<tbody>';
    if (rowsArr.length){
      rowsArr.forEach(r => {
        html += '<tr><td>'+r.balai+'</td><td>'+r.total+'</td><td>'+r.filled+'</td><td>'+r.pct+'%</td></tr>';
      });
    } else {
      html += '<tr><td colspan="4">Belum ada data</td></tr>';
    }
    html +=   '</tbody>';
    html += '</table>';

    html += '<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">';
    html +=   '<button class="btn-mini primary" id="btnExportCSV">Unduh data log (CSV)</button>';
    html +=   '<button class="btn-mini" id="btnExportMissing">Unduh baseline belum terisi</button>';
    html += '</div>';

    statsDiv.innerHTML = html;

    $("#btnResetView").onclick = function(){
      map.setView([-2.5,117],5);
    };

    $("#btnLocateMini").onclick = function(){
      if (!navigator.geolocation){
        alert("Geolocation tidak didukung");
        return;
      }
      navigator.geolocation.getCurrentPosition(function(pos){
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        L.marker([lat,lng],{
          icon:L.icon({
            iconUrl:"https://maps.google.com/mapfiles/ms/icons/green-dot.png",
            iconSize:[25,41],
            iconAnchor:[12,41],
            shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
            shadowSize:[41,41]
          })
        }).addTo(map).bindPopup("Lokasi Anda").openPopup();
        map.setView([lat,lng],13);
      }, function(){
        alert("Tidak dapat mengakses lokasi.");
      });
    };

    $("#btnExportCSV").onclick = function(){
      const header = ["key","balai","provinsi","nama_di","kabupaten","desa","lat","lng","progress_terakhir","foto_25","foto_50","foto_75","foto_100"];
      const lines = [header.join(",")];

      logGroups.forEach(g => {
        const row = [
          g.key || "",
          g.balai || "",
          g.prov || "",
          g.namaDi || "",
          g.kab || "",
          g.desa || "",
          g.lat || "",
          g.lng || "",
          g.latestProgress || 0,
          g.stages[25] || "",
          g.stages[50] || "",
          g.stages[75] || "",
          g.stages[100] || ""
        ];
        const csvRow = row.map(v => {
          const s = String(v == null ? "" : v);
          return '"' + s.replace(/"/g,'""') + '"';
        }).join(",");
        lines.push(csvRow);
      });

      const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href   = url;
      a.download = "log_tahap3_grouped.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    $("#btnExportMissing").onclick = function(){
      const header = ["Balai","Provinsi","Nama DI","Kabupaten","Desa"];
      const lines = [header.join(",")];

      missing.forEach(m => {
        const row = [
          m.balai || "",
          m.prov || "",
          m.namaDi || "",
          m.kab || "",
          m.desa || ""
        ];
        const csvRow = row.map(v => {
          const s = String(v || "");
          return '"' + s.replace(/"/g,'""') + '"';
        }).join(",");
        lines.push(csvRow);
      });

      const blob = new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href   = url;
      a.download = "baseline-belum-terisi-tahap3.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    return {missing:missing};
  }

  function updateDiOptions(){
    const fBbws = $("#f-bbws");
    const diSel = $("#f-di");
    const bb = fBbws.value;

    if (!bb){
      diSel.innerHTML = '<option value="">â€” Pilih B/BWS dulu â€”</option>';
      diSel.disabled = true;
      return;
    }

    const mapLok = balaiToLokasiUploaded[bb] || {};
    const list = Object.keys(mapLok);

    diSel.disabled = false;

    const cur = diSel.value;
    let html = '<option value="">â€” Semua lokasi â€”</option>';
    list.sort().forEach(v => {
      html += '<option value="'+v+'">'+v+'</option>';
    });
    diSel.innerHTML = html;
    if (list.indexOf(cur) >= 0) diSel.value = cur;
  }

  function applyFilters(){
    const fBbws = $("#f-bbws").value;
    const fDi   = $("#f-di").value;
    const fB = canon(fBbws);
    const fD = canon(fDi);

    cluster.clearLayers();
    const visible = [];

    allMarkers.forEach(m => {
      const meta = m.__meta || {};
      const passB = !fB || canon(meta.bbws || "") === fB;
      const passD = !fD || canon(meta.di   || "") === fD;
      if (passB && passD){
        cluster.addLayer(m);
        visible.push(m);
      }
    });

    if (visible.length){
      const fg = L.featureGroup(visible);
      map.fitBounds(fg.getBounds(), {padding:[20,20]});
    }
    refreshLabels();
  }

  function rebuildSearchIndex(){
    searchIndex = [];
    allMarkers.forEach(m => {
      const meta = m.__meta || {};
      if (meta.di){
        searchIndex.push({name: meta.di, marker: m});
      }
    });
  }

  function showSuggestions(q){
    const box = $("#suggestions");
    box.innerHTML = "";
    if (!q){
      box.style.display = "none";
      return;
    }
    const lower = q.toLowerCase();
    const hits = searchIndex.filter(it =>
      it.name && it.name.toLowerCase().indexOf(lower) !== -1
    ).slice(0,100);

    hits.forEach(it => {
      const d = document.createElement("div");
      d.textContent = it.name;
      d.onclick = function(){
        $("#search").value = it.name;
        box.style.display = "none";
        map.setView(it.marker.getLatLng(),14);
        it.marker.openPopup();
      };
      box.appendChild(d);
    });

    box.style.display = hits.length ? "block" : "none";
  }

  $("#f-bbws").addEventListener("change", function(){
    updateDiOptions();
    applyFilters();
  });

  $("#f-di").addEventListener("change", function(){
    applyFilters();
  });

  $("#search").addEventListener("input", function(e){
    showSuggestions(e.currentTarget.value);
  });

  $("#search").addEventListener("keydown", function(e){
    if (e.key === "Enter"){
      const q = e.currentTarget.value.trim().toLowerCase();
      let hit = searchIndex.find(it =>
        it.name && it.name.toLowerCase() === q
      );
      if (!hit){
        hit = searchIndex.find(it =>
          it.name && it.name.toLowerCase().indexOf(q) !== -1
        );
      }
      if (hit){
        map.setView(hit.marker.getLatLng(),14);
        hit.marker.openPopup();
        $("#suggestions").style.display = "none";
      }
    }
  });

  function buildAll(){
    $("#stats").textContent = "Memuat statistik...";

    loadBaseline()
      .then(baseline => {
        baselineData = baseline;
        return loadLogTahap3(baseline);
      })
      .then(groups => {
        logGroups = groups;

        const uniqBalai = uniqueList(groups.map(g => g.balai || "-"));
        const fBbws = $("#f-bbws");
        let html = '<option value="">â€” Semua B/BWS (yang sudah upload) â€”</option>';
        uniqBalai.sort().forEach(v => {
          html += '<option value="'+v+'">'+v+'</option>';
        });
        fBbws.innerHTML = html;
        updateDiOptions();

        buildStats({baseline:baselineData, logs:logGroups});
        rebuildSearchIndex();
        refreshLabels();
      })
      .catch(err => {
        console.error(err);
        $("#stats").innerHTML =
          '<div style="color:#b91c1c">Gagal memuat data Tahap 3.</div>' +
          '<div style="font-size:12px;color:#6b7280">Detail: ' + (err.message || err) + '</div>';
      });
  }

  buildAll();
})();
</script>

</body>
</html>
