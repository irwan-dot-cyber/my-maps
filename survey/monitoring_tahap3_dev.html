<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoring Tahap 3 ‚Äî Popup Foto Progres</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1222;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --disabled:#e5e7eb;
    }

    html,body{ height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #map{ height:100vh; width:100vw; background:var(--bg); }

    /* Popup */
    .popup-wrap{ min-width: 280px; max-width: 340px; }
    .popup-title{ font-weight:800; font-size:18px; margin:0 0 6px 0; }
    .popup-row{ margin:2px 0; color:var(--text); }
    .popup-row .lbl{ color:var(--muted); }
    .popup-hr{ border:0; border-top:1px solid var(--line); margin:10px 0; }

    .btn-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    .btn-photo{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:14px;
      border:1px solid var(--line);
      text-decoration:none;
      user-select:none;
      transition:transform .05s ease, background .15s ease;
    }
    .btn-photo.active{
      background: var(--blue);
      border-color: var(--blue);
      color:#fff;
      cursor:pointer;
    }
    .btn-photo.active:hover{ background: var(--blue2); transform: translateY(-1px); }
    .btn-photo.disabled{
      background: #f3f4f6;
      border-color: var(--line);
      color:#9ca3af;
      cursor:not-allowed;
    }

    .gmaps-link{
      color:var(--blue);
      font-weight:700;
      text-decoration:none;
    }
    .gmaps-link:hover{ text-decoration:underline; }

    /* Leaflet popup style tweaks */
    .leaflet-popup-content{ margin:14px 14px 12px 14px; }
    .leaflet-popup-content-wrapper{ border-radius:16px; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
/** =========================
 *  KONFIG (ganti di sini)
 *  ========================= */
const SHEET_ID = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY"; // ganti kalau beda
const SHEET_BASELINE = "baseline";   // sheet geojson / data DI (yang jadi layer)
const SHEET_LOG = "log_tahap3";      // sheet log foto progres

// Proxy (opsional) untuk anti-CORS. Kalau tanpa proxy bisa, set PROXY_PREFIX = "".
const PROXY_PREFIX = "https://gas-proxy3.tuic1677.workers.dev/?url=";

// Kalau baseline kamu bukan dari sheet (misal file geojson), isi URL GEOJSON-nya di sini:
const BASELINE_GEOJSON_URL = ""; // contoh: "https://.../DI.geojson"

// Nama field DI di GeoJSON/baseline (akan dicoba beberapa nama juga).
const PROP_KEYS = {
  di:   ["di","DI","Nama DI","nama_di","namadi","NAMA_DI","Nama_DI","name","Name"],
  balai:["balai","Balai","BWS","bws"],
  prov: ["provinsi","Provinsi"],
  kab:  ["kabupaten","Kabupaten","kab","Kab"],
  kec:  ["kecamatan","Kecamatan","kec","Kec"],
  desa: ["desa","Desa"]
};

/** =========================
 *  UTIL
 *  ========================= */
function pickProp(obj, keys){
  for (const k of keys){
    if (obj && obj[k] != null && String(obj[k]).trim() !== "") return obj[k];
  }
  return "";
}

function normText(s){
  return String(s ?? "")
    .toLowerCase()
    .trim()
    .replace(/\s+/g,' ')
    .replace(/[^\w\s]/g,'')           // buang titik/koma/dll
    .replace(/^di\s+/,'')             // buang prefix "di "
    .replace(/^daerah irigasi\s+/,'');
}

function bucketizeProgress(p){
  p = Number(p) || 0;
  if (p >= 100) return 100;
  if (p >= 75)  return 75;
  if (p >= 50)  return 50;
  if (p >= 25)  return 25;
  return 0;
}

function gmapsLink(lat,lng){
  if (!lat || !lng) return "";
  const u = `https://www.google.com/maps?q=${encodeURIComponent(lat + "," + lng)}`;
  return `<a class="gmaps-link" href="${u}" target="_blank" rel="noopener">Google Maps</a>`;
}

function wrapProxy(url){
  if (!PROXY_PREFIX) return url;
  return PROXY_PREFIX + encodeURIComponent(url);
}

/** =========================
 *  GVIZ PARSER (Google Sheets gviz/tq)
 *  ========================= */
async function fetchGVizRows(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`;
  const res = await fetch(wrapProxy(url));
  const txt = await res.text();

  // Extract JSON from "google.visualization.Query.setResponse({...});"
  const m = txt.match(/setResponse\\((.*)\\);?\\s*$/s);
  if (!m) throw new Error("Respon bukan format GViz. Potongan awal: " + txt.slice(0,120));
  const json = JSON.parse(m[1]);
  const table = json.table;
  const cols = table.cols.map(c => (c.label || "").trim());
  const rows = table.rows.map(r => {
    const o = {};
    r.c.forEach((cell, i) => {
      const v = cell ? (cell.f ?? cell.v) : "";
      o[cols[i] || ("col"+i)] = v;
    });
    return o;
  });
  return rows;
}

/** =========================
 *  MAP INIT
 *  ========================= */
const map = L.map("map", { zoomControl:true }).setView([-2.5, 118], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const layerDI = L.geoJSON(null, {
  style: () => ({ weight: 1.2, color: "#2563eb", fillColor:"#93c5fd", fillOpacity: 0.18 }),
  onEachFeature: (feature, layer) => {
    layer.on("click", () => onClickDI(feature, layer));
  }
}).addTo(map);

/** =========================
 *  LOG INDEX (global)
 *  ========================= */
window.__LOG_T3_INDEX__ = {};
window.__LOG_T3_READY__ = false;

/** =========================
 *  LOADERS
 *  ========================= */
async function loadBaseline(){
  // 1) Kalau BASELINE_GEOJSON_URL diisi, pakai itu
  if (BASELINE_GEOJSON_URL){
    const res = await fetch(BASELINE_GEOJSON_URL);
    const gj = await res.json();
    layerDI.addData(gj);
    try { map.fitBounds(layerDI.getBounds(), { padding:[20,20] }); } catch(e){}
    return;
  }

  // 2) Kalau baseline ada di Google Sheet, ini asumsi: ada kolom lat,lng atau geojson string.
  // Kalau baseline kamu sudah berbentuk geojson di sheet lain, bilang gue ya, nanti gue sesuaikan parsernya.
  // Untuk sementara: coba load dari sheet baseline sebagai POINT marker (lat/lng).
  const rows = await fetchGVizRows(SHEET_BASELINE);
  const feats = [];

  for (const r of rows){
    const lat = Number(r.lat ?? r.latitude ?? r.Lat ?? r.LAT);
    const lng = Number(r.lng ?? r.longitude ?? r.Long ?? r.LNG ?? r.lon);
    if (!isFinite(lat) || !isFinite(lng)) continue;

    const props = { ...r };
    feats.push({
      type:"Feature",
      geometry:{ type:"Point", coordinates:[lng, lat] },
      properties: props
    });
  }

  if (!feats.length){
    console.warn("Baseline tidak menghasilkan fitur. Kalau baseline kamu polygon/geojson, isi BASELINE_GEOJSON_URL atau kasih format sheet-nya.");
  }

  layerDI.clearLayers();
  layerDI.addData({ type:"FeatureCollection", features: feats });
  try { map.fitBounds(layerDI.getBounds(), { padding:[20,20] }); } catch(e){}
}

async function loadLogTahap3(){
  const rows = await fetchGVizRows(SHEET_LOG);

  const logIndex = {};

  for (const r of rows){
    const di   = r.di || r["di"] || r["Nama DI"] || r["nama_di"] || r["Nama_DI"];
    const prov = r.provinsi || r["provinsi"] || r["Provinsi"];
    const kab  = r.kabupaten || r["kabupaten"] || r["Kabupaten"] || r["kab"];
    const kec  = r.kecamatan || r["kecamatan"] || r["Kecamatan"] || r["kec"];
    const desa = r.desa || r["desa"] || r["Desa"];

    const pRaw = r.progress ?? r["progress"] ?? 0;
    const p = Number(pRaw) || 0;

    const foto = r.foto_url || r["foto_url"] || r["foto"] || r["Foto"] || "";
    const bucket = bucketizeProgress(p);

    const diN = normText(di);
    if (!diN) continue;

    // Multi-key fallback biar match makin besar peluangnya
    const keys = [
      `di:${diN}`,
      `di:${diN}|kab:${normText(kab)}`,
      `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}`,
      `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}|desa:${normText(desa)}`
    ];

    for (const k of keys){
      if (!logIndex[k]){
        logIndex[k] = {
          di, provinsi:prov, kabupaten:kab, kecamatan:kec, desa,
          latestProgress: 0,
          stages: {} // {25:url, 50:url, ...}
        };
      }
      if (foto) logIndex[k].stages[bucket] = foto;
      if (p > logIndex[k].latestProgress) logIndex[k].latestProgress = p;
    }
  }

  window.__LOG_T3_INDEX__ = logIndex;
  window.__LOG_T3_READY__ = true;

  console.log("LOG TAHAP3 READY. keys:", Object.keys(logIndex).length);
}

/** =========================
 *  POPUP BUILDER
 *  ========================= */
function getLogRecForProps(props){
  const di   = pickProp(props, PROP_KEYS.di);
  const kab  = pickProp(props, PROP_KEYS.kab);
  const kec  = pickProp(props, PROP_KEYS.kec);
  const desa = pickProp(props, PROP_KEYS.desa);

  const diN = normText(di);
  const idx = window.__LOG_T3_INDEX__ || {};

  const k1 = `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}|desa:${normText(desa)}`;
  const k2 = `di:${diN}|kab:${normText(kab)}|kec:${normText(kec)}`;
  const k3 = `di:${diN}|kab:${normText(kab)}`;
  const k4 = `di:${diN}`;

  return idx[k1] || idx[k2] || idx[k3] || idx[k4] || null;
}

function buildPopupHtml(feature){
  const props = feature.properties || {};

  const di   = pickProp(props, PROP_KEYS.di) || "(Tanpa nama)";
  const balai= pickProp(props, PROP_KEYS.balai) || "-";
  const prov = pickProp(props, PROP_KEYS.prov) || "-";
  const kab  = pickProp(props, PROP_KEYS.kab) || "-";
  const kec  = pickProp(props, PROP_KEYS.kec) || "-";
  const desa = pickProp(props, PROP_KEYS.desa) || "-";

  const lat = props.lat ?? props.latitude ?? props.Lat ?? "";
  const lng = props.lng ?? props.longitude ?? props.Long ?? props.lon ?? "";

  const rec = getLogRecForProps(props);
  const prog = rec ? (Number(rec.latestProgress)||0) : 0;

  const stagesList = [25,50,75,100];
  const btns = stagesList.map(s=>{
    const url = rec?.stages?.[s];
    if (!url) return `<span class="btn-photo disabled">Foto ${s}%</span>`;
    return `<a class="btn-photo active" href="${url}" target="_blank" rel="noopener">Foto ${s}%</a>`;
  }).join("");

  return `
    <div class="popup-wrap">
      <div class="popup-title">${escapeHtml(di)}</div>
      <div class="popup-row"><span class="lbl">Balai:</span> ${escapeHtml(balai)}</div>
      <div class="popup-row"><span class="lbl">Provinsi:</span> ${escapeHtml(prov)}</div>
      <div class="popup-row"><span class="lbl">Kabupaten:</span> ${escapeHtml(kab)}</div>
      <div class="popup-row"><span class="lbl">Kecamatan:</span> ${escapeHtml(kec)}</div>
      <div class="popup-row"><span class="lbl">Desa:</span> ${escapeHtml(desa)}</div>
      <div class="popup-row"><span class="lbl">Progress:</span> ${prog.toFixed(0)}%</div>
      <div class="popup-row">üìç ${escapeHtml(lat)} , ${escapeHtml(lng)} &nbsp; ${gmapsLink(lat,lng)}</div>
      <hr class="popup-hr"/>
      <div class="btn-grid">${btns}</div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================
 *  CLICK HANDLER (anti keburu)
 *  ========================= */
function onClickDI(feature, layer){
  const props = feature.properties || {};
  const di = pickProp(props, PROP_KEYS.di) || "(Tanpa nama)";

  // kalau log belum ready -> tampilkan loading, lalu auto refresh
  if (!window.__LOG_T3_READY__){
    layer.bindPopup(`<b>${escapeHtml(di)}</b><br>Memuat log tahap 3...`).openPopup();

    const t = setInterval(()=>{
      if (window.__LOG_T3_READY__){
        clearInterval(t);
        layer.setPopupContent(buildPopupHtml(feature));
      }
    }, 200);

    // safety stop
    setTimeout(()=>{ try{ clearInterval(t); }catch(e){} }, 8000);
    return;
  }

  layer.bindPopup(buildPopupHtml(feature)).openPopup();
}

/** =========================
 *  BOOT
 *  ========================= */
(async function boot(){
  try{
    // baseline dulu supaya layer tampil cepat
    await loadBaseline();
  }catch(e){
    console.error("Gagal load baseline:", e);
  }

  try{
    await loadLogTahap3();
  }catch(e){
    console.error("Gagal load log_tahap3:", e);
    window.__LOG_T3_READY__ = false;
  }
})();
</script>
</body>
</html>
