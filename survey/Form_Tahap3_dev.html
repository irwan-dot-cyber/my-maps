<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Tahap 3 ‚Äî INPRES 2/2025</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1224;
      --panel:#0f172a;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9aa3b2;
      --accent:#22c55e;
      --accent2:#3b82f6;
      --warn:#f59e0b;
      --bad:#fb7185;
      --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      padding:14px 18px;border-bottom:1px solid var(--border);background:#0c1326;
      position:sticky;top:0;z-index:20;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .hdr-left{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .btn-home{
      display:inline-block;text-decoration:none;
      padding:8px 12px;border-radius:10px;
      background:#0b1224;color:var(--text);border:1px solid #334155;
      font-weight:700;font-size:13px;line-height:1;
    }
    .btn-home:hover{filter:brightness(1.05)}

    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--muted)}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:var(--text)}
    select:disabled,input:disabled{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}

    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px;font-weight:800}
    .primary{background:var(--accent);color:#01250f}
    .ghost{background:#0b1224;color:var(--text);border:1px solid #334155}
    button:disabled{opacity:.55;cursor:not-allowed}

    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #334155;border-radius:999px;background:#0b1224;font-size:12px}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:#22c55e}.dot.orange{background:#f59e0b}.dot.gray{background:#94a3b8}.dot.red{background:#fb7185}

    /* Map style: samain Tahap 2 */
    #map{height:56vh}
    .mapwrap{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#071024}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}

    .leaflet-control-layers{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.18)}
    .leaflet-control-layers, .leaflet-control-zoom a{background:rgba(11,18,36,.92) !important;color:#e5e7eb !important}
    .leaflet-control-zoom a{border-color:rgba(255,255,255,.14) !important}
    .leaflet-control-attribution{background:rgba(0,0,0,.25) !important;color:rgba(255,255,255,.75) !important;border-radius:10px;padding:2px 8px !important;border:1px solid rgba(255,255,255,.12);margin:8px !important}

    /* marker bump */
    .leaflet-marker-icon.bump{animation:bump .6s ease;transform-origin:bottom center}
    @keyframes bump{0%{transform:translateY(0)}30%{transform:translateY(-10px)}60%{transform:translateY(0)}80%{transform:translateY(-5px)}100%{transform:translateY(0)}}

    /* History gallery */
    .history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .hcard{border:1px solid var(--border);border-radius:12px;background:#0b1224;overflow:hidden}
    .hcard .top{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:8px;align-items:center}
    .hcard .top b{font-size:13px}
    .hcard .body{padding:10px 12px}
    .hcard img{width:100%;height:180px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#071024}
    .hmeta{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-top:8px}
    .link{color:#60a5fa;text-decoration:none;font-weight:800;font-size:12px}
    .muted{opacity:.7}

    /* Collapsible info paket */
    .proj{border:1px solid var(--border);border-radius:12px;background:#0b1224;overflow:hidden}
    .proj-h{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border)}
    .proj-h b{font-size:14px}
    .proj-h button{padding:6px 10px;border-radius:999px}
    .proj-b{padding:10px 12px;display:none}
    .proj-b.show{display:block}
    .kv{display:grid;grid-template-columns:170px 1fr;gap:8px 10px;font-size:13px}
    @media (max-width:820px){.kv{grid-template-columns:1fr}}
    .k{color:var(--muted)}
    .v{font-weight:700}

    /* Upload overlay */
    #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999}
    .uBox{background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
    .uTitle{font-weight:900;margin-bottom:6px}
    .uBar{height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
    #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)}
    .uHint{font-size:12px;color:#a1a1aa;margin-top:8px}
  </style>
</head>

<body>
<header>
  <div class="hdr-left">
    <strong>Form Tahap 3</strong>
    <span class="hint">INPRES 2/2025 ‚Ä¢ Pelaksanaan Tahap 3</span>
  </div>
  <a class="btn-home" id="btnHome" href="#">Beranda</a>
</header>

<main>
  <div class="card">
    <h2>Data Survey</h2>
    <div id="toast" class="toast"></div>

    <form id="surveyForm" autocomplete="on">
      <div class="row">
        <div>
          <label for="balai">B/BWS</label>
          <select id="balai" name="balai" required title="Pilih B/BWS"></select>
        </div>
        <div>
          <label for="prov">Provinsi</label>
          <select id="prov" name="provinsi" required disabled title="Pilih Provinsi"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="kab">Kabupaten/Kota</label>
          <select id="kab" name="kabupaten" required disabled title="Pilih Kabupaten/Kota"></select>
        </div>
        <div>
          <label for="di">Daerah Irigasi (DI)</label>
          <select id="di" name="di" required disabled title="Pilih Daerah Irigasi"></select>
        </div>
      </div>

      <div class="actions" style="gap:10px;margin-top:-4px">
        <span class="badge"><span class="dot green"></span>Progres terakhir: <b id="lastStage">0%</b></span>
        <span class="badge" id="coordBadge"><span class="dot gray"></span><span id="coordBadgeText">Koordinat: -</span></span>
      </div>

      <div class="row">
        <div>
          <label for="kecamatan">Kecamatan</label>
          <input id="kecamatan" name="kecamatan" placeholder="(otomatis/isi manual)" required title="Isi Kecamatan"/>
        </div>
        <div>
          <label for="desa">Desa/Kelurahan</label>
          <input id="desa" name="desa" placeholder="(otomatis/isi manual)" required title="Isi Desa/Kelurahan"/>
        </div>
      </div>

      <!-- INFO PAKET (COLLAPSE) -->
      <div class="proj">
        <div class="proj-h">
          <b>Informasi Paket</b>
          <button type="button" class="ghost" id="btnToggleProj">Ciutkan</button>
        </div>
        <div class="proj-b show" id="projBody">
          <div class="hint muted">Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.</div>
          <div class="kv" id="projKV" style="margin-top:10px"></div>
        </div>
      </div>

      <div>
        <label>Peta Lokasi</label>
        <div class="mapwrap">
          <div id="map"></div>
          <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
          <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
          <span class="hint" id="coords">Lat: -, Lng: -</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="lat">Latitude</label>
          <input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required title="Isi Latitude"/>
        </div>
        <div>
          <label for="lng">Longitude</label>
          <input type="number" step="0.000001" id="lng" name="lng" required title="Isi Longitude"/>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="card" style="border-radius:12px;margin-top:6px">
        <h2 style="font-size:14px">Riwayat Foto Progres</h2>
        <div id="historyGals" style="padding:12px 14px">
          <div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>
        </div>
      </div>

      <!-- UPLOAD -->
      <div class="card" style="border-radius:12px">
        <h2 style="font-size:14px">Upload Foto Progres</h2>
        <div style="padding:12px 14px; display:grid; gap:10px">
          <div class="actions" id="stageBtns"></div>

          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>

          <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
          <div class="hint">Foto akan dikompresi + ditempel timestamp otomatis sebelum dikirim.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="nama">Nama Pengirim</label>
          <input id="nama" name="nama" placeholder="Nama lengkap" required title="Isi Nama"/>
        </div>
        <div>
          <label for="telepon">Nomor WA/HP</label>
          <input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required title="Isi Nomor HP"/>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="primary" id="btnSubmit" disabled>Kirim</button>
        <button type="reset" class="ghost" id="btnReset">Reset</button>
      </div>
    </form>
  </div>
</main>

<!-- Overlay Upload -->
<div id="uploadOverlay">
  <div class="uBox" role="alert" aria-live="assertive">
    <div class="uTitle" id="uploadTitle">Mengunggah data‚Ä¶</div>
    <div class="uBar"><div id="progressBar"></div></div>
    <div class="uHint" id="uploadHint">Jangan tutup halaman ini.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== CONFIG ===== */
const DATA_URL  = "https://gas-proxy3.tuic1677.workers.dev/"; // Worker -> GAS
const HOME_URL  = "https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html";

/* ===== Utils ===== */
const toast = (m)=>{
  const t=document.getElementById('toast');
  t.textContent=m; t.style.display='block';
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>t.style.display='none',4200);
};

function fillSelect(el, items, ph='-- pilih --'){
  el.innerHTML='';
  if(ph && !el.multiple){
    const o=document.createElement('option');
    o.value=''; o.textContent=ph;
    el.appendChild(o);
  }
  (items||[]).forEach(v=>{
    const o=document.createElement('option');
    o.value=o.textContent=v;
    el.appendChild(o);
  });
  el.disabled = !(items && items.length);
}

const titleCase = s => String(s||'').split(/(\s+|[-/])/).map(tok=>{
  if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok;
  const up = tok.toUpperCase();
  if (up==='BBWS'||up==='BWS') return up;
  if (/^(D\.?I\.?|DI)$/.test(up)) return 'D.I.';
  return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
}).join('');

function norm(s){ return String(s||'').trim(); }

function normalizeDriveImgUrl(url){
  if(!url) return '';
  url = String(url).trim();

  if (url.includes('drive.google.com/uc?') && url.includes('export=view')) return url;

  const m = url.match(/drive\.google\.com\/uc\?id=([^&]+)/i);
  if (m && m[1]) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

  const m2 = url.match(/drive\.google\.com\/file\/d\/([^\/]+)/i);
  if (m2 && m2[1]) return `https://drive.google.com/uc?export=view&id=${m2[1]}`;

  return url;
}

/* ===== Upload overlay ===== */
const $overlay=document.getElementById('uploadOverlay');
const $bar=document.getElementById('progressBar');
function setUploadingUI({show,percent}){
  if(typeof percent==='number'){
    $bar.style.width=Math.max(0,Math.min(100,Math.round(percent)))+'%';
  }
  $overlay.style.display = show ? 'flex' : 'none';
}
function disableForm(b){
  document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button')
    .forEach(e=>e.disabled=!!b);
}

/* ===== Map ===== */
const baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImg=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
const map=L.map('map',{zoomControl:true,layers:[baseOSM]});
L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5);

const coordsTxt=document.getElementById('coords');
function upd(){ const c=map.getCenter(); coordsTxt.textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`; }
map.on('move',upd); map.whenReady(upd);

let pickedMarker=null;
const pickedIcon=L.icon({
  iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
  iconSize:[25,41], iconAnchor:[12,41],
  shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
  shadowSize:[41,41]
});
function showPicked(lat,lng,{bounce=true,zoom=null}={}){
  if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;
  const ll=L.latLng(lat,lng);
  if(!pickedMarker) pickedMarker=L.marker(ll,{icon:pickedIcon}).addTo(map);
  else pickedMarker.setLatLng(ll);

  const el=pickedMarker._icon;
  if(bounce && el){ el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump'); }
  if(zoom!=null) map.setView(ll, zoom);
}

/* ===== DOM ===== */
document.getElementById('btnHome').href = HOME_URL;

const balai=document.getElementById('balai');
const prov=document.getElementById('prov');
const kab=document.getElementById('kab');
const di=document.getElementById('di');

const lat=document.getElementById('lat');
const lng=document.getElementById('lng');
const form=document.getElementById('surveyForm');
const btnSubmit=document.getElementById('btnSubmit');

const coordBadge=document.getElementById('coordBadge');
const coordBadgeText=document.getElementById('coordBadgeText');
const btnPick=document.getElementById('btnPick');
const btnPan=document.getElementById('btnPan');
const btnLocate=document.getElementById('btnLocate');

const lastStageEl=document.getElementById('lastStage');
const historyGals=document.getElementById('historyGals');

const projBody=document.getElementById('projBody');
const projKV=document.getElementById('projKV');
document.getElementById('btnToggleProj').addEventListener('click', ()=>{
  const shown = projBody.classList.contains('show');
  projBody.classList.toggle('show', !shown);
  document.getElementById('btnToggleProj').textContent = shown ? 'Buka' : 'Ciutkan';
});

/* ===== tombol map ===== */
btnLocate.addEventListener('click', ()=> map.locate({setView:true,maxZoom:17,enableHighAccuracy:true}) );
map.on('locationfound',(e)=>{
  lat.value = e.latitude.toFixed(6);
  lng.value = e.longitude.toFixed(6);
  showPicked(e.latitude,e.longitude,{bounce:true,zoom:17});
  updateSubmitState();
});
map.on('locationerror',()=>toast('Izin lokasi ditolak. Geser peta manual.'));

btnPick.addEventListener('click',()=>{
  const c=map.getCenter();
  lat.value=c.lat.toFixed(6);
  lng.value=c.lng.toFixed(6);
  showPicked(c.lat,c.lng,{bounce:true});
  updateSubmitState();
});
btnPan.addEventListener('click',()=>{
  const la=+lat.value, lo=+lng.value;
  if(!Number.isNaN(la)&&!Number.isNaN(lo)){
    showPicked(la,lo,{bounce:true,zoom:Math.max(map.getZoom(),16)});
  }
});

function tryUpdateFromInputs(){
  const la=parseFloat(lat.value), lo=parseFloat(lng.value);
  if(Number.isFinite(la)&&Number.isFinite(lo)) showPicked(la,lo,{bounce:false});
}
lat.addEventListener('change', tryUpdateFromInputs);
lng.addEventListener('change', tryUpdateFromInputs);

/* ===== Badge & Lock ===== */
function setCoordBadge(type,text){
  coordBadge.querySelector('.dot')?.classList.remove('green','orange','gray','red');
  const dot = coordBadge.querySelector('.dot') || document.createElement('span');
  dot.className='dot ' + (type==='locked'?'green':type==='none'?'orange':type==='bad'?'red':'gray');
  if(!coordBadge.contains(dot)) coordBadge.prepend(dot);
  coordBadgeText.textContent=text;
}
function setCoordLock(locked, la, ln){
  if(locked){
    if(Number.isFinite(la)&&Number.isFinite(ln)){
      lat.value=Number(la).toFixed(6);
      lng.value=Number(ln).toFixed(6);
      showPicked(Number(la),Number(ln),{bounce:false,zoom:17});
    }
    lat.disabled=true; lng.disabled=true;
    btnPick.disabled=true; btnPan.disabled=true; btnLocate.disabled=true;
    btnPick.classList.remove('primary'); btnPick.classList.add('ghost');
  }else{
    lat.disabled=false; lng.disabled=false;
    btnPick.disabled=false; btnPan.disabled=false; btnLocate.disabled=false;
    btnPick.classList.add('primary'); btnPick.classList.remove('ghost');
  }
}

/* ===== Baseline indexing ===== */
let RAW_BASELINE=[];
let INDEX={}; // bws->prov->kab->di->{row, kecSet, desaSet}

async function loadBaseline(){
  try{
    const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + 'fn=baseline&t='+Date.now();
    const res = await fetch(url,{cache:'no-store'});
    const j = await res.json();
    if(!j || !j.ok || !Array.isArray(j.items)) throw new Error('Baseline invalid');

    RAW_BASELINE = j.items || [];
    INDEX={};

    RAW_BASELINE.forEach(row=>{
      const BWS = titleCase(row['B/BWS PELAKSANA']||row['B/BWS']||row['Balai']||row['BWS']);
      const PROV= titleCase(row['PROVINSI']||row['Provinsi']);
      const KAB = titleCase(row['KABUPATEN']||row['Kabupaten']||row['Kab/Kota']);
      const DI  = titleCase(row['NAMA DI/DIR']||row['Nama DI']||row['DI']||row['Paket']||row['di']);

      if(!(BWS&&PROV&&KAB&&DI)) return;

      INDEX[BWS] ??= {};
      INDEX[BWS][PROV] ??= {};
      INDEX[BWS][PROV][KAB] ??= {};
      INDEX[BWS][PROV][KAB][DI] ??= { row, kecamatan:new Set(), desa:new Set() };

      const KEC = row['KECAMATAN']||row['Kecamatan']||row['Kec']||'';
      const DES = row['DESA']||row['Desa']||row['Desa/Kelurahan']||'';

      String(KEC).split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean).forEach(k=>INDEX[BWS][PROV][KAB][DI].kecamatan.add(titleCase(k)));
      String(DES).split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean).forEach(d=>INDEX[BWS][PROV][KAB][DI].desa.add(titleCase(d)));
    });

    fillSelect(balai, Object.keys(INDEX).sort(), '-- pilih B/BWS --');
    prov.disabled=kab.disabled=di.disabled=true;
    setCoordBadge('none','Koordinat: -');
  }catch(e){
    console.error(e);
    toast('‚ö†Ô∏è Gagal memuat baseline.');
  }
}

/* ===== Cascade dropdown ===== */
balai.addEventListener('change', ()=>{
  const b=balai.value;
  if(!b){ fillSelect(prov,[], '-- pilih Provinsi --'); prov.disabled=true; return; }
  fillSelect(prov, Object.keys(INDEX[b]||{}).sort(), '-- pilih Provinsi --');
  prov.disabled=false;
  fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  clearProjectInfo();
  resetHistoryUI();
  updateSubmitState();
});
prov.addEventListener('change', ()=>{
  const b=balai.value,p=prov.value;
  if(!p){ fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true; return; }
  fillSelect(kab, Object.keys((INDEX[b]||{})[p]||{}).sort(), '-- pilih Kab/Kota --');
  kab.disabled=false;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  clearProjectInfo();
  resetHistoryUI();
  updateSubmitState();
});
kab.addEventListener('change', ()=>{
  const b=balai.value,p=prov.value,k=kab.value;
  if(!k){ fillSelect(di,[], '-- pilih DI --'); di.disabled=true; return; }
  fillSelect(di, Object.keys((((INDEX[b]||{})[p]||{})[k]||{})).sort(), '-- pilih DI --');
  di.disabled=false;
  clearProjectInfo();
  resetHistoryUI();
  updateSubmitState();
});

/* ===== Project info (exclude Total Alokasi Usulan) ===== */
function clearProjectInfo(){
  projKV.innerHTML='';
  projBody.querySelector('.hint')?.classList.remove('muted');
}
function renderProjectInfo(entry){
  projKV.innerHTML='';
  if(!entry || !entry.row){
    projKV.innerHTML='';
    return;
  }
  const r = entry.row;

  // mapping dari kolom referensi (pakai beberapa kemungkinan nama kolom)
  const getv = (...keys)=>{
    for(const k of keys){
      const v = r[k];
      if(v!==undefined && v!==null && String(v).trim()!=='') return String(v).trim();
    }
    return '-';
  };

  const fields = [
    ['Jenis Usulan Kegiatan', getv('Jenis Usulan Kegiatan','JENIS USULAN KEGIATAN','jenis_usulan')],
    ['Urutan Prioritas',      getv('Urutan Prioritas','URUTAN PRIORITAS','prioritas')],
    ['IP Padi Semula (%)',    getv('IP Padi Semula (%)','IP Padi Semula','ip_semula')],
    ['IP Padi Menjadi (%)',   getv('IP Padi Menjadi (%)','IP Padi Menjadi','ip_menjadi')],
    ['Outcome (Ha)',          getv('Outcome (Ha)','OUTCOME (HA)','outcome_ha')],
    ['Masa Pelaksanaan',      getv('Masa Pelaksanaan','MASA PELAKSANAAN','masa')],
    ['B/BBWS Pelaksana',      getv('B/BBWS PELAKSANA','B/BWS PELAKSANA','B/BWS')],
  ];

  let html='';
  fields.forEach(([k,v])=>{
    html += `<div class="k">${k}</div><div class="v">${v}</div>`;
  });
  projKV.innerHTML = html;
}

/* ===== History / Stage ===== */
let currentStage=null;
function renderStageButtons(maxStage){
  const wrap=document.getElementById('stageBtns');
  wrap.innerHTML='';
  const stages=[25,50,75,100];
  const nextStage = (maxStage>=100) ? null : (maxStage===0 ? 25 : (maxStage+25));

  stages.forEach(st=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.textContent=`Progres ${st}%`;
    const enabled = (st===nextStage);
    btn.className = enabled ? 'primary' : 'ghost';
    btn.disabled = !enabled;
    btn.addEventListener('click', ()=>{
      currentStage=st;
      toast(`Stage dipilih: ${st}%`);
      updateSubmitState();
    });
    wrap.appendChild(btn);
  });

  currentStage = nextStage;
  updateSubmitState();
}

function resetHistoryUI(){
  lastStageEl.textContent='0%';
  historyGals.innerHTML = `<div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>`;
  renderStageButtons(0);
  setCoordLock(false);
  setCoordBadge('none','Koordinat: -');
}

function renderHistoryPhotos(photos){
  const order=[25,50,75,100];
  let has=false;

  let html = `<div class="history-grid">`;
  order.forEach(st=>{
    const p = photos[String(st)];
    if(p && p.url){
      has=true;
      const imgUrl = normalizeDriveImgUrl(p.url);
      const fname = p.name || `Stage ${st}`;
      html += `
        <div class="hcard">
          <div class="top">
            <b>Foto Progres ${st}%</b>
            <span class="badge"><span class="dot green"></span>${st}%</span>
          </div>
          <div class="body">
            <a href="${p.url}" target="_blank" class="link" title="Buka di tab baru">
              <img loading="lazy" src="${imgUrl}" alt="Progres ${st}%">
            </a>
            <div class="hmeta">
              <span class="hint muted">${fname}</span>
              <a class="link" href="${p.url}" target="_blank">Buka</a>
            </div>
          </div>
        </div>
      `;
    }
  });
  html += `</div>`;

  historyGals.innerHTML = has ? html : `<div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>`;
}

async function fetchHistory(bws, p, k, d){
  const qs = new URLSearchParams({fn:'history', bws, prov:p, kab:k, di:d});
  const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + qs.toString() + '&t=' + Date.now();
  const res = await fetch(url, {cache:'no-store'});
  try{
    const j=await res.json();
    return (j && j.ok) ? j : {ok:false,maxStage:0,coords:null,photos:{}};
  }catch{
    return {ok:false,maxStage:0,coords:null,photos:{}};
  }
}

/* === DI selected: fill kec/desa, project info, history, lock coord === */
di.addEventListener('change', async ()=>{
  const b=balai.value, p=prov.value, k=kab.value, d=di.value;
  const entry = (((INDEX[b]||{})[p]||{})[k]||{})[d];

  // auto kec/desa
  const kecEl=document.getElementById('kecamatan');
  const desaEl=document.getElementById('desa');
  const kecs = entry ? [...entry.kecamatan] : [];
  const des  = entry ? [...entry.desa] : [];
  kecEl.value  = (kecs[0] || '');
  desaEl.value = (des[0]  || '');
  kecEl.placeholder  = kecs.length>1 ? `Opsi: ${kecs.join(', ')}` : '(otomatis/isi manual)';
  desaEl.placeholder = des.length>1  ? `Opsi: ${des.join(', ')}`  : '(otomatis/isi manual)';

  // info paket
  renderProjectInfo(entry);

  // history
  const hist = await fetchHistory(b,p,k,d);
  lastStageEl.textContent = (hist.maxStage||0) + '%';
  renderHistoryPhotos(hist.photos||{});
  renderStageButtons(hist.maxStage||0);

  // coord lock
  const hasCoord = hist.coords && Number.isFinite(hist.coords.lat) && Number.isFinite(hist.coords.lng);
  if(hasCoord){
    setCoordLock(true, hist.coords.lat, hist.coords.lng);
    setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
    map.setView([hist.coords.lat, hist.coords.lng], 17);
  }else{
    setCoordLock(false);
    setCoordBadge('none','Koordinat: belum ada, silakan pilih titik');
  }

  updateSubmitState();
});

/* ===== Foto: pilih + kompres + tempel timestamp ===== */
let selectedFile=null;
const fileInput=document.getElementById('fileInput');
const photoMeta=document.getElementById('photoMeta');

document.getElementById('btnCamera').addEventListener('click',()=>{
  fileInput.setAttribute('capture','environment');
  fileInput.click();
});
document.getElementById('btnGallery').addEventListener('click',()=>{
  fileInput.removeAttribute('capture');
  fileInput.click();
});
fileInput.addEventListener('change',()=>{
  selectedFile = fileInput.files?.[0] || null;
  photoMeta.textContent = selectedFile ? `Dipilih: ${selectedFile.name} ‚Ä¢ ${(selectedFile.size/1024).toFixed(1)} KB` : '';
  updateSubmitState();
});

async function compressImage(file,{maxDim=2000,quality=0.82,mime='image/jpeg'}={}){
  try{
    if(!(file && file.type && file.type.startsWith('image/'))) return file;
    const bitmap = await createImageBitmap(file,{imageOrientation:'from-image'});
    const W=bitmap.width,H=bitmap.height;
    const s=Math.min(1, maxDim/Math.max(W,H));
    const w=Math.round(W*s), h=Math.round(H*s);
    const c=document.createElement('canvas'); c.width=w; c.height=h;
    const ctx=c.getContext('2d');
    ctx.drawImage(bitmap,0,0,w,h);
    const blob=await new Promise(r=>c.toBlob(r,mime,quality));
    if(!blob) return file;
    const name=(file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto')+'.jpg';
    return new File([blob],name,{type:mime});
  }catch(e){
    console.warn('compress fail',e);
    return file;
  }
}

function formatNowID(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

async function stampTimestampToDataUrl(file, stampText){
  const bitmap = await createImageBitmap(file,{imageOrientation:'from-image'});
  const W=bitmap.width,H=bitmap.height;
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.drawImage(bitmap,0,0,W,H);

  // stamp di pojok kanan bawah
  const margin=Math.round(Math.max(12, W*0.015));
  const fontSize=Math.round(Math.max(18, W*0.02));
  ctx.font = `800 ${fontSize}px Inter, system-ui, Arial`;
  ctx.textBaseline='bottom';
  ctx.textAlign='right';

  const text = stampText;
  const metrics = ctx.measureText(text);
  const boxW = Math.round(metrics.width + margin*1.2);
  const boxH = Math.round(fontSize + margin*0.9);

  const x=W - margin;
  const y=H - margin;

  // background box semi transparan
  ctx.fillStyle='rgba(0,0,0,0.45)';
  ctx.strokeStyle='rgba(255,255,255,0.25)';
  ctx.lineWidth=Math.max(2, Math.round(fontSize*0.08));
  const bx = x - boxW;
  const by = y - boxH;
  roundRect(ctx, bx, by, boxW, boxH, Math.round(fontSize*0.35));
  ctx.fill();
  ctx.stroke();

  // text
  ctx.fillStyle='rgba(255,255,255,0.95)';
  ctx.fillText(text, x - Math.round(margin*0.35), y - Math.round(margin*0.25));

  const blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.9));
  const b64 = await blobToDataURL(blob);
  return { blob, dataUrl: b64 };
}

function roundRect(ctx,x,y,w,h,r){
  const rr=Math.min(r,w/2,h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}

function blobToDataURL(blob){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(String(r.result));
    r.onerror=rej;
    r.readAsDataURL(blob);
  });
}

/* ===== Submit state ===== */
function missingList(){
  const m=[];
  if(!balai.value) m.push('B/BWS');
  if(!prov.value)  m.push('Provinsi');
  if(!kab.value)   m.push('Kab/Kota');
  if(!di.value)    m.push('DI');
  if(!document.getElementById('kecamatan').value) m.push('Kecamatan');
  if(!document.getElementById('desa').value)      m.push('Desa/Kelurahan');
  if(!lat.value || !lng.value) m.push('Koordinat');
  if(!document.getElementById('nama').value)    m.push('Nama');
  if(!document.getElementById('telepon').value) m.push('Nomor WA/HP');
  if(!currentStage) m.push('Stage Progres');
  if(!selectedFile) m.push('Foto');
  return m;
}
function updateSubmitState(){
  btnSubmit.disabled = (missingList().length !== 0);
}
form.addEventListener('input', updateSubmitState);
form.addEventListener('change', updateSubmitState);

/* ===== Submit ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const miss=missingList();
  if(miss.length){
    toast('‚ö†Ô∏è Harus diisi dulu: ' + miss.join(', '));
    updateSubmitState();
    return;
  }

  const b=balai.value,p=prov.value,k=kab.value,d=di.value;

  // compress file
  let photo = await compressImage(selectedFile,{maxDim:2000,quality:0.82});
  const stampText = `${formatNowID()} ‚Ä¢ ${d} ‚Ä¢ ${currentStage}%`;
  const stamped = await stampTimestampToDataUrl(photo, stampText);

  // rename file for preview (backend tetap rename final)
  const safeDI = String(d).replace(/[^\w\-]+/g,'_');
  const stagedName = `${safeDI}_${currentStage}.jpg`;

  const fd = new FormData();
  // field form
  fd.set('balai', b);
  fd.set('provinsi', p);
  fd.set('kabupaten', k);
  fd.set('di', d);
  fd.set('kecamatan', document.getElementById('kecamatan').value);
  fd.set('desa', document.getElementById('desa').value);
  fd.set('lat', lat.value);
  fd.set('lng', lng.value);
  fd.set('nama', document.getElementById('nama').value);
  fd.set('telepon', document.getElementById('telepon').value);
  fd.set('progress_stage', String(currentStage));

  // base64 fallback (dipakai backend)
  fd.set('foto_b64', stamped.dataUrl);
  fd.set('foto_name', stagedName);
  fd.set('foto_type', 'image/jpeg');

  disableForm(true);
  setUploadingUI({show:true,percent:6});

  try{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', DATA_URL, true);

    xhr.upload.onprogress = (ev)=>{
      if(ev.lengthComputable){
        setUploadingUI({show:true,percent:(ev.loaded/ev.total)*100});
      }
    };
    xhr.onloadstart = ()=>setUploadingUI({show:true,percent:5});
    xhr.onreadystatechange = ()=>{
      if(xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED) setUploadingUI({show:true,percent:95});
    };

    xhr.onerror = ()=>{
      setUploadingUI({show:false});
      disableForm(false);
      toast('‚ùå Gagal kirim (jaringan/proxy).');
    };

    xhr.onload = async ()=>{
      let data={};
      try{ data=JSON.parse(xhr.responseText||'{}'); }catch{}

      if(xhr.status>=200 && xhr.status<300 && data && data.ok){
        setUploadingUI({show:true,percent:100});
        toast('‚úÖ Terkirim!');

        // refresh history
        const hist = await fetchHistory(b,p,k,d);
        lastStageEl.textContent=(hist.maxStage||0)+'%';
        renderHistoryPhotos(hist.photos||{});
        renderStageButtons(hist.maxStage||0);

        if(hist.coords){
          setCoordLock(true, hist.coords.lat, hist.coords.lng);
          setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
        }

        // reset selectedFile biar user pilih ulang stage berikutnya
        selectedFile=null;
        fileInput.value='';
        photoMeta.textContent='';

        setTimeout(()=>setUploadingUI({show:false}),600);
      }else{
        setUploadingUI({show:false});
        toast('‚ùå Gagal kirim. ' + (data && data.error ? data.error : ''));
      }

      disableForm(false);
      updateSubmitState();
    };

    xhr.send(fd);
  }catch(err){
    console.error(err);
    setUploadingUI({show:false});
    disableForm(false);
    toast('‚ùå Error submit: ' + String(err));
  }
});

/* ===== Reset ===== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  selectedFile=null; fileInput.value=''; photoMeta.textContent='';
  fillSelect(prov,[], '-- pilih Provinsi --'); prov.disabled=true;
  fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  clearProjectInfo();
  resetHistoryUI();
  if(pickedMarker){ map.removeLayer(pickedMarker); pickedMarker=null; }
  updateSubmitState();
});

/* ===== start ===== */
setCoordBadge('none','Koordinat: -');
resetHistoryUI();
loadBaseline();
</script>
</body>
</html>
