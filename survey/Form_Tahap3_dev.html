<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Tahap 2 — INPRES 2/2025</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">

  <style>
    :root{
      --bg0:#050914;
      --bg1:#070c1a;
      --panel: rgba(9, 16, 36, .78);
      --panel2: rgba(10, 18, 42, .62);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text:#e5e7eb;
      --muted:#a8b1c7;
      --muted2:#7f8aa5;
      --accent:#3b82f6;
      --accent2:#60a5fa;
      --good:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 14px;
      --hdrH: 68px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(700px 420px at 90% 0%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 40% 120%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    /* Top header */
    .topbar{
      position: sticky;
      top:0;
      z-index: 10;
      height: var(--hdrH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 22px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      background: rgba(4, 8, 20, .72);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:baseline; gap:14px;
      white-space:nowrap;
    }
    .brand .title{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 22px;
    }
    .brand .sub{
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      background: rgba(255,255,255,.04);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 700;
      cursor:pointer;
      transition:.15s ease;
    }
    .btn:hover{ filter: brightness(1.08); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(1px); }

    /* Page layout */
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px;
    }
    .card{
      margin-top: 18px;
      border: 1px solid var(--border);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{
      background: var(--panel);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      margin: 14px;
      padding: 18px;
    }
    .card-title{
      font-size: 20px;
      font-weight: 800;
      margin: 2px 0 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ flex-wrap:wrap; }
      .brand .title{ font-size: 20px; }
    }

    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 2px 0 8px;
    }

    .field{
      position:relative;
    }
    select, input{
      width:100%;
      padding: 14px 14px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.14);
      outline: none;
      background: rgba(3, 8, 22, .55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    select:disabled, input:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    input::placeholder{ color: rgba(168,177,199,.55); }

    .chips{
      display:flex;
      gap: 12px;
      align-items:center;
      margin: 6px 0 2px;
      flex-wrap: wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight: 700;
      font-size: 13px;
    }
    .chip small{
      color: var(--muted2);
      font-weight: 700;
      font-size: 13px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(245,158,11,.12);
    }
    .dot.good{
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(34,197,94,.14);
    }

    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.45;
    }

    /* tiny footer status */
    .statusline{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      color: var(--muted2);
      font-size: 12px;
    }
    .spinner{
      width:14px; height:14px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: var(--accent2);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .err{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(248,113,113,.45);
      background: rgba(248,113,113,.08);
      color: #fecaca;
      display:none;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">Form Tahap 2</div>
      <div class="sub">INPRES 2/2025 · Pelaksanaan Tahap 2</div>
    </div>
    <button class="btn" id="btnHome">Beranda</button>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-inner">
        <div class="card-title">Data Survey</div>

        <div class="grid">
          <div class="field">
            <label for="bws">B/BWS</label>
            <select id="bws">
              <option value="">-- pilih B/BWS --</option>
            </select>
          </div>

          <div class="field">
            <label for="prov">Provinsi</label>
            <select id="prov" disabled>
              <option value="">-- pilih Provinsi --</option>
            </select>
          </div>

          <div class="field">
            <label for="kab">Kabupaten/Kota</label>
            <select id="kab" disabled>
              <option value="">-- pilih Kabupaten/Kota --</option>
            </select>
          </div>

          <div class="field">
            <label for="di">Daerah Irigasi (DI)</label>
            <select id="di" disabled>
              <option value="">-- pilih Daerah Irigasi --</option>
            </select>
          </div>
        </div>

        <div class="chips" style="margin-top:14px">
          <div class="chip">
            <span class="dot good" id="dotProg"></span>
            Progres terakhir: <span id="progVal">0%</span>
          </div>
          <div class="chip">
            <span class="dot" id="dotKoord"></span>
            Koordinat: <small id="koordVal">-</small>
          </div>
        </div>

        <div class="grid" style="margin-top:14px">
          <div class="field">
            <label for="kec">Kecamatan</label>
            <input id="kec" placeholder="(otomatis/isi manual)" />
          </div>
          <div class="field">
            <label for="desa">Desa/Kelurahan</label>
            <input id="desa" placeholder="(otomatis/isi manual)" />
          </div>
        </div>

        <div class="statusline" id="statusline">
          <span class="spinner" id="spin"></span>
          <span id="statusText">Mengambil data…</span>
        </div>

        <div class="err" id="errBox"></div>

        <div class="hint">
          Catatan: Dropdown ini ngikutin data dari proxy. Kalau ada kolom “Kec” / “Desa” di data, dia bakal auto isi saat DI dipilih.
        </div>
      </div>
    </section>
  </main>

<script>
  // === CONFIG ===
  const DATA_URL = "https://gas-proxy3.tuic1677.workers.dev/";
  const HOME_URL = "#"; // ganti misal: "index.html" atau "https://irwan-dot-cyber.github.io/my-maps/"
  // ==============

  const $ = (id) => document.getElementById(id);
  const bwsSel  = $("bws");
  const provSel = $("prov");
  const kabSel  = $("kab");
  const diSel   = $("di");

  const kecInp  = $("kec");
  const desaInp = $("desa");

  const statusLine = $("statusline");
  const statusText = $("statusText");
  const spin = $("spin");
  const errBox = $("errBox");

  const progVal = $("progVal");
  const koordVal = $("koordVal");

  let raw = [];

  // Helper untuk key yang ada spasi / tanda baca
  const get = (o, k, fb="") => (o && o[k] !== undefined && o[k] !== null) ? o[k] : fb;

  const uniq = (arr) => Array.from(new Set(arr));
  const norm = (s) => String(s ?? "").trim();
  const byAlpha = (a,b) => norm(a).localeCompare(norm(b), "id");

  function setStatus(msg, loading=true){
    statusText.textContent = msg;
    spin.style.display = loading ? "inline-block" : "none";
    statusLine.style.opacity = msg ? 1 : 0;
  }

  function showError(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function hideError(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function resetSelect(sel, placeholder){
    sel.innerHTML = `<option value="">${placeholder}</option>`;
    sel.value = "";
  }
  function fillSelect(sel, values, placeholder){
    resetSelect(sel, placeholder);
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
  }

  function setProgressFromSelection(){
    // Simple indikator progress (biar kerasa kayak form beneran)
    let p = 0;
    if (bwsSel.value) p += 25;
    if (provSel.value) p += 25;
    if (kabSel.value) p += 25;
    if (diSel.value)  p += 25;
    progVal.textContent = p + "%";
  }

  function setKoordinatDummy(){
    // Karena halaman ini cuma viewer dropdown, koordinat belum diambil.
    // Kalau bro mau: bisa gue tambahin tombol "Ambil GPS" pakai navigator.geolocation.
    koordVal.textContent = "-";
  }

  function populateBWS(){
    const list = uniq(raw.map(x => norm(get(x,"B/BWS",""))).filter(Boolean)).sort(byAlpha);
    fillSelect(bwsSel, list, "-- pilih B/BWS --");
  }

  function filteredBy(selKey, selVal){
    if (!selVal) return raw;
    return raw.filter(x => norm(get(x, selKey, "")) === selVal);
  }

  function onBwsChange(){
    setProgressFromSelection();
    setKoordinatDummy();
    resetSelect(provSel, "-- pilih Provinsi --");
    resetSelect(kabSel, "-- pilih Kabupaten/Kota --");
    resetSelect(diSel, "-- pilih Daerah Irigasi --");
    provSel.disabled = true; kabSel.disabled = true; diSel.disabled = true;

    const bws = bwsSel.value;
    if (!bws) return;

    const rows = filteredBy("B/BWS", bws);
    const provs = uniq(rows.map(x => norm(get(x,"Provinsi",""))).filter(Boolean)).sort(byAlpha);
    fillSelect(provSel, provs, "-- pilih Provinsi --");
    provSel.disabled = false;
  }

  function onProvChange(){
    setProgressFromSelection();
    setKoordinatDummy();
    resetSelect(kabSel, "-- pilih Kabupaten/Kota --");
    resetSelect(diSel, "-- pilih Daerah Irigasi --");
    kabSel.disabled = true; diSel.disabled = true;

    const bws = bwsSel.value;
    const prov = provSel.value;
    if (!bws || !prov) return;

    const rows = raw.filter(x =>
      norm(get(x,"B/BWS","")) === bws &&
      norm(get(x,"Provinsi","")) === prov
    );

    const kabs = uniq(rows.map(x => norm(get(x,"Kab/Kota",""))).filter(Boolean)).sort(byAlpha);
    fillSelect(kabSel, kabs, "-- pilih Kabupaten/Kota --");
    kabSel.disabled = false;
  }

  function onKabChange(){
    setProgressFromSelection();
    setKoordinatDummy();
    resetSelect(diSel, "-- pilih Daerah Irigasi --");
    diSel.disabled = true;

    const bws = bwsSel.value;
    const prov = provSel.value;
    const kab = kabSel.value;
    if (!bws || !prov || !kab) return;

    const rows = raw.filter(x =>
      norm(get(x,"B/BWS","")) === bws &&
      norm(get(x,"Provinsi","")) === prov &&
      norm(get(x,"Kab/Kota","")) === kab
    );

    const dis = uniq(rows.map(x => norm(get(x,"Nama DI",""))).filter(Boolean)).sort(byAlpha);
    fillSelect(diSel, dis, "-- pilih Daerah Irigasi --");
    diSel.disabled = false;
  }

  function onDiChange(){
    setProgressFromSelection();
    setKoordinatDummy();

    const bws  = bwsSel.value;
    const prov = provSel.value;
    const kab  = kabSel.value;
    const di   = diSel.value;
    if (!bws || !prov || !kab || !di) return;

    const row = raw.find(x =>
      norm(get(x,"B/BWS","")) === bws &&
      norm(get(x,"Provinsi","")) === prov &&
      norm(get(x,"Kab/Kota","")) === kab &&
      norm(get(x,"Nama DI","")) === di
    );

    // auto fill if present (beberapa dataset pakai "Kec" / "Desa")
    const kec = norm(get(row, "Kec", "")) || norm(get(row, "Kecamatan", ""));
    const desa = norm(get(row, "Desa", "")) || norm(get(row, "Desa/Kelurahan", "")) || norm(get(row, "Kel", ""));
    if (kec)  kecInp.value  = kec;
    if (desa) desaInp.value = desa;
  }

  async function load(){
    hideError();
    setStatus("Mengambil data…", true);

    try{
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      if(!json || json.ok !== true || !Array.isArray(json.items)){
        throw new Error("Format JSON tidak sesuai. Butuh { ok:true, items:[...] }");
      }

      raw = json.items || [];
      populateBWS();
      setStatus("Data siap ✅  Pilih B/BWS untuk mulai.", false);

      // reset state
      resetSelect(provSel, "-- pilih Provinsi --");
      resetSelect(kabSel, "-- pilih Kabupaten/Kota --");
      resetSelect(diSel, "-- pilih Daerah Irigasi --");
      provSel.disabled = true; kabSel.disabled = true; diSel.disabled = true;

      setProgressFromSelection();
      setKoordinatDummy();
    }catch(err){
      console.error(err);
      setStatus("Gagal mengambil data", false);
      showError(String(err.message || err));
    }
  }

  // events
  $("btnHome").addEventListener("click", () => {
    if (HOME_URL === "#") return;
    window.location.href = HOME_URL;
  });

  bwsSel.addEventListener("change", onBwsChange);
  provSel.addEventListener("change", onProvChange);
  kabSel.addEventListener("change", onKabChange);
  diSel.addEventListener("change", onDiChange);

  // boot
  load();
</script>
</body>
</html>
