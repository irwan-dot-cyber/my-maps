<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Tahap 3 ‚Äî INPRES 2/2025</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1224;
      --panel:#0f172a;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.14);
      --text:#e5e7eb;
      --muted:#9aa3b2;
      --muted2:#7f8aa5;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#fb7185;
      --accent:#3b82f6;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
      --hdrH:68px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(700px 420px at 90% 0%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 40% 120%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(180deg, #050914, #070c1a);
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:10;
      height:var(--hdrH);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:0 22px;
      border-bottom:1px solid rgba(255,255,255,.07);
      background: rgba(4, 8, 20, .72);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:baseline;gap:14px;flex-wrap:wrap}
    .brand .title{font-weight:800;font-size:22px;letter-spacing:.2px}
    .brand .sub{font-size:13px;color:var(--muted);font-weight:600}

    .btn{
      appearance:none; cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 16px;
      border-radius:999px;
      font-weight:800;
      transition:.15s ease;
    }
    .btn:hover{filter:brightness(1.08);border-color:rgba(255,255,255,.22)}
    .btn:active{transform:translateY(1px)}

    main{max-width:1180px;margin:0 auto;padding:22px}
    .card{
      margin-top:18px;
      border:1px solid var(--border);
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{
      background: rgba(9, 16, 36, .78);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      margin: 14px;
      padding: 18px;
    }
    .card-title{font-size:20px;font-weight:800;margin:2px 0 16px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}.brand .title{font-size:20px}}

    label{display:block;font-size:13px;color:var(--muted);margin:2px 0 8px}
    .field{position:relative}
    select,input{
      width:100%;
      padding:14px 14px;
      border-radius:var(--r2);
      border:1px solid rgba(255,255,255,.14);
      outline:none;
      background: rgba(3, 8, 22, .55);
      color:var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    select:disabled,input:disabled{opacity:.55;cursor:not-allowed}
    input::placeholder{color:rgba(168,177,199,.55)}

    .chips{display:flex;gap:12px;align-items:center;margin:10px 0 2px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      font-weight:800;font-size:13px;
    }
    .chip small{color:var(--muted2);font-weight:800}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.12)}
    .dot.good{background:var(--good);box-shadow:0 0 0 4px rgba(34,197,94,.14)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(251,113,133,.14)}

    .statusline{margin-top:12px;display:flex;gap:10px;align-items:center;color:var(--muted2);font-size:12px}
    .spinner{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color:#60a5fa;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .err{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(248,113,113,.45);
      background: rgba(248,113,113,.08);
      color:#fecaca;
      display:none;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* ===================== MAP STYLE (samain kayak contoh) ===================== */
    .mapwrap{
      margin-top:16px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .mapbox{
      position:relative;
      height: 56vh;           /* mirip contoh */
      min-height: 360px;
      width: 100%;
    }
    #map{height:100%; width:100%}

    /* crosshair */
    .crosshair{
      position:absolute; inset:0;
      pointer-events:none;
      display:grid; place-items:center;
      z-index:1000;
    }
    .reticle{
      width:30px; height:30px;
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
    }
    .reticle::before{
      content:"";
      position:absolute; inset:0;
      border:2px solid rgba(229,231,235,.75);
      border-radius:50%;
      box-shadow:0 0 10px rgba(0,0,0,.55);
      background: transparent;
    }
    .reticle .h, .reticle .v{
      position:absolute;
      background: rgba(229,231,235,.75);
      box-shadow:0 0 8px rgba(0,0,0,.55);
    }
    .reticle .h{width:16px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .reticle .v{width:2px;height:16px;left:50%;top:50%;transform:translate(-50%,-50%)}

    .map-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    .btn3{
      appearance:none; cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 14px;
      border-radius: 12px;
      font-weight:900;
      transition:.15s ease;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn3:hover{filter:brightness(1.06)}
    .btn3.primary{
      border-color: rgba(34,197,94,.45);
      background: linear-gradient(180deg, rgba(34,197,94,.38), rgba(34,197,94,.16));
    }
    .btn3:disabled{opacity:.6;cursor:not-allowed}

    .coordsline{
      margin-left:auto;
      color: rgba(229,231,235,.85);
      font-size: 13px;
      font-weight: 700;
      opacity:.9;
      white-space: nowrap;
    }

    .coordRow{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.08);
    }
    @media(max-width:900px){
      .coordRow{grid-template-columns:1fr}
      .coordsline{margin-left:0}
    }

    /* Leaflet: layer control & zoom kaya contoh */
    .leaflet-control-layers{
      border-radius: 10px !important;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.25) !important;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .leaflet-control-layers-expanded{
      background: rgba(255,255,255,.90) !important;
      color:#0b1224 !important;
    }
    .leaflet-control-zoom a{
      background: rgba(255,255,255,.92) !important;
      color:#0b1224 !important;
      border-color: rgba(0,0,0,.18) !important;
    }
    /* ======================================================================== */

    .debug{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(229,231,235,.92);
      font-size:12px;
      display:none;
      white-space:pre-wrap;
    }
  </style>

</head>

<body>
<header>
  <div class="brand">
    <div class="title">Form Tahap 3</div>
    <div class="sub">INPRES 2/2025 ¬∑ Pelaksanaan Tahap 3</div>
  </div>
  <button class="btn" id="btnHome" type="button">Beranda</button>
</header>

<main>
  <section class="card">
    <div class="card-inner">
      <div class="card-title">Data Survey</div>

```
  <div class="grid">
    <div class="field">
      <label for="bws">B/BWS</label>
      <select id="bws" title="B/BWS">
        <option value="">-- pilih B/BWS --</option>
      </select>
    </div>

    <div class="field">
      <label for="prov">Provinsi</label>
      <select id="prov" title="Provinsi" disabled>
        <option value="">-- pilih Provinsi --</option>
      </select>
    </div>

    <div class="field">
      <label for="kab">Kabupaten/Kota</label>
      <select id="kab" title="Kabupaten/Kota" disabled>
        <option value="">-- pilih Kabupaten/Kota --</option>
      </select>
    </div>

    <div class="field">
      <label for="di">Daerah Irigasi (DI)</label>
      <select id="di" title="Daerah Irigasi" disabled>
        <option value="">-- pilih Daerah Irigasi --</option>
      </select>
    </div>
  </div>

  <div class="chips">
    <div class="chip">
      <span class="dot good"></span>
      Progres terakhir: <span id="progVal">0%</span>
    </div>
    <div class="chip">
      <span class="dot" id="dotKoord"></span>
      Koordinat: <small id="koordVal">-</small>
    </div>
  </div>

  <div class="grid" style="margin-top:14px">
    <div class="field">
      <label for="kec">Kecamatan</label>
      <input id="kec" placeholder="(otomatis/isi manual)" title="Kecamatan"/>
    </div>
    <div class="field">
      <label for="desa">Desa/Kelurahan</label>
      <input id="desa" placeholder="(otomatis/isi manual)" title="Desa/Kelurahan"/>
    </div>
  </div>

  <!-- MAP (model Tahap 2: crosshair + tombol bawah) -->
  <div class="mapwrap">
    <div class="mapbox">
      <div id="map"></div>
      <div class="crosshair">
        <div class="reticle"><span class="h"></span><span class="v"></span></div>
      </div>
    </div>

    <div class="map-actions">
      <button class="btn3" id="btnLocate" type="button">üìç Lokasi saya</button>
      <button class="btn3 primary" id="btnPick" type="button">‚úÖ Pilih lokasi (ambil dari tanda +)</button>
      <button class="btn3" id="btnPan" type="button">üß≠ Pan ke koordinat</button>

      <div class="coordsline" id="coordsLine">Lat: -, Lng: -</div>
    </div>

    <div class="coordRow">
      <div class="field">
        <label for="lat">Latitude</label>
        <input id="lat" inputmode="decimal" placeholder="Klik 'Pilih lokasi' atau isi manual" title="Latitude"/>
      </div>
      <div class="field">
        <label for="lng">Longitude</label>
        <input id="lng" inputmode="decimal" placeholder="Klik 'Pilih lokasi' atau isi manual" title="Longitude"/>
      </div>
    </div>
  </div>

  <div class="statusline" id="statusline">
    <span class="spinner" id="spin"></span>
    <span id="statusText">Mengambil data‚Ä¶</span>
  </div>

  <div class="err" id="errBox"></div>
  <div class="debug" id="debugBox"></div>
</div>
```

  </section>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= CONFIG ================= */
const DATA_URL = "https://gas-proxy3.tuic1677.workers.dev/";
const HOME_URL = "https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html";
/* ========================================= */

const $ = (id) => document.getElementById(id);

const bwsSel  = $("bws");
const provSel = $("prov");
const kabSel  = $("kab");
const diSel   = $("di");

const kecInp  = $("kec");
const desaInp = $("desa");

const statusLine = $("statusline");
const statusText = $("statusText");
const spin = $("spin");
const errBox = $("errBox");
const debugBox = $("debugBox");

const progVal = $("progVal");
const koordVal = $("koordVal");
const dotKoord = $("dotKoord");

const latInp = $("lat");
const lngInp = $("lng");
const btnLocate = $("btnLocate");
const btnPick = $("btnPick");
const btnPan = $("btnPan");
const coordsLine = $("coordsLine");

let raw = [];

/* ---------- utils ---------- */
const norm = (s) => String(s ?? "").trim();
const uniq = (arr) => Array.from(new Set(arr));
const byAlpha = (a,b) => norm(a).localeCompare(norm(b), "id");

function setStatus(msg, loading=true){
  statusText.textContent = msg;
  spin.style.display = loading ? "inline-block" : "none";
  statusLine.style.opacity = msg ? 1 : 0;
}
function showError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function hideError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}
function showDebug(msg){
  debugBox.style.display = "block";
  debugBox.textContent = msg;
}
function hideDebug(){
  debugBox.style.display = "none";
  debugBox.textContent = "";
}

function resetSelect(sel, placeholder){
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  sel.value = "";
}
function fillSelect(sel, values, placeholder){
  resetSelect(sel, placeholder);
  values.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}
function setProgressFromSelection(){
  let p = 0;
  if (bwsSel.value) p += 25;
  if (provSel.value) p += 25;
  if (kabSel.value) p += 25;
  if (diSel.value)  p += 25;
  progVal.textContent = p + "%";
}

/* ---------- MAP (samain Tahap 2) ---------- */
const baseOSM = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20, attribution: "&copy; OpenStreetMap"
});
const baseImg = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
  maxZoom: 20, attribution: "Tiles &copy; Esri/Maxar"
});

const map = L.map("map", { zoomControl:true, layers:[baseOSM] }).setView([-2.5, 118.0], 5);
L.control.layers({OSM: baseOSM, "Esri Imagery": baseImg}, {}, {position:"topright", collapsed:false}).addTo(map);

let pickedMarker = null;
const pickedIcon = L.icon({
  iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
  iconSize: [25,41],
  iconAnchor: [12,41],
  shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  shadowSize: [41,41]
});

function isValidLatLng(lat, lng){
  return Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat) <= 90 && Math.abs(lng) <= 180;
}

function updateCenterReadout(){
  const c = map.getCenter();
  coordsLine.textContent = `Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;
}
map.on("move", updateCenterReadout);
map.whenReady(updateCenterReadout);

function setKoordinatChip(lat, lng){
  if (!isValidLatLng(lat,lng)){
    koordVal.textContent = "-";
    dotKoord.className = "dot";
    return;
  }
  koordVal.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  dotKoord.className = "dot good";
}

function showPicked(lat, lng, {zoom=null, pan=true}={}){
  if (!isValidLatLng(lat,lng)) return;
  const ll = L.latLng(lat,lng);
  if(!pickedMarker){
    pickedMarker = L.marker(ll, {icon:pickedIcon}).addTo(map);
  }else{
    pickedMarker.setLatLng(ll);
  }
  if (zoom !== null){
    map.setView(ll, zoom);
  } else if (pan){
    map.panTo(ll);
  }
}

/* Tombol: Lokasi saya */
btnLocate.addEventListener("click", () => {
  if (!("geolocation" in navigator)){
    showError("Perangkat ini tidak mendukung Geolocation.");
    return;
  }
  hideError();
  setStatus("Mengambil GPS‚Ä¶ (izin lokasi diperlukan)", true);

  map.locate({setView:true, maxZoom:17, enableHighAccuracy:true});
});

map.on("locationfound", (e) => {
  const la = e.latitude, lo = e.longitude;
  latInp.value = la.toFixed(6);
  lngInp.value = lo.toFixed(6);
  setKoordinatChip(la, lo);
  showPicked(la, lo, {zoom:17});
  setStatus("GPS didapat ‚úÖ", false);
});
map.on("locationerror", () => {
  showError("Izin lokasi ditolak / lokasi tidak tersedia. Geser peta manual lalu klik 'Pilih lokasi'.");
  setStatus("GPS gagal ‚ùå", false);
  dotKoord.className = "dot bad";
});

/* Tombol: ambil dari crosshair (tengah peta) */
btnPick.addEventListener("click", () => {
  const c = map.getCenter();
  latInp.value = c.lat.toFixed(6);
  lngInp.value = c.lng.toFixed(6);
  setKoordinatChip(c.lat, c.lng);
  showPicked(c.lat, c.lng, {zoom:null, pan:false});
});

/* Tombol: pan ke koordinat dari input */
btnPan.addEventListener("click", () => {
  const la = Number(String(latInp.value||"").replace(",","."));
  const lo = Number(String(lngInp.value||"").replace(",","."));
  if (isValidLatLng(la,lo)){
    setKoordinatChip(la,lo);
    showPicked(la,lo,{zoom:Math.max(map.getZoom(), 16)});
  }
});

/* Update marker kalau user ketik manual */
function onCoordInputs(){
  const la = Number(String(latInp.value||"").replace(",","."));
  const lo = Number(String(lngInp.value||"").replace(",","."));
  if (isValidLatLng(la,lo)){
    setKoordinatChip(la,lo);
    showPicked(la,lo,{zoom:null, pan:false});
  } else if (!latInp.value && !lngInp.value){
    setKoordinatChip(NaN,NaN);
  }
}
latInp.addEventListener("change", onCoordInputs);
lngInp.addEventListener("change", onCoordInputs);

/* ---------- AUTO DETECT KEYS ---------- */
function detectKey(items, patterns){
  if (!items || !items.length) return null;
  const keys = Object.keys(items[0] || {});
  const normKey = (k) => k.toLowerCase().replace(/\s+/g,' ').trim();
  let best = {k:null, score:-1};

  for (const k of keys){
    const nk = normKey(k);
    let score = 0;
    for (const re of patterns){
      if (re.test(nk)) score += 10;
    }
    if (/(^| )bws( |$)/.test(nk)) score += 8;
    if (/(^| )prov(insi)?( |$)/.test(nk)) score += 6;
    if (/(kab|kota)/.test(nk)) score += 6;
    if (/(^| )di( |$)/.test(nk)) score += 6;

    if (score > 0){
      let hasVal = 0;
      const n = Math.min(60, items.length);
      for (let i=0;i<n;i++){
        const v = items[i]?.[k];
        if (v !== undefined && v !== null && String(v).trim() !== "") { hasVal++; if (hasVal >= 2) break; }
      }
      score += Math.min(8, hasVal * 4);
    }
    if (score > best.score) best = {k, score};
  }
  return best.k;
}

let KEY = { bws:null, prov:null, kab:null, di:null, kec:null, desa:null, lat:null, lng:null };

function detectAllKeys(items){
  KEY.bws  = detectKey(items, [/b\/?bws/, /\bbws\b/, /balai/]);
  KEY.prov = detectKey(items, [/\bprov\b/, /provinsi/]);
  KEY.kab  = detectKey(items, [/kab/, /kabupaten/, /kota/, /kab\/kota/]);
  KEY.di   = detectKey(items, [/\bnama di\b/, /daerah irigasi/, /\bdi\b/, /dir/]);
  KEY.kec  = detectKey(items, [/kec/, /kecamatan/]);
  KEY.desa = detectKey(items, [/desa/, /kelurahan/, /desa\/kel/]);
  KEY.lat  = detectKey(items, [/\blat\b/, /latitude/]);
  KEY.lng  = detectKey(items, [/\blng\b/, /\blon\b/, /longitude/]);
}
function val(row, key){
  if (!key) return "";
  const v = row?.[key];
  return (v === undefined || v === null) ? "" : String(v).trim();
}

/* ---------- dropdown logic ---------- */
function populateBWS(){
  const list = uniq(raw.map(r => val(r, KEY.bws)).filter(Boolean)).sort(byAlpha);
  fillSelect(bwsSel, list, "-- pilih B/BWS --");
}
function onBwsChange(){
  setProgressFromSelection();
  resetSelect(provSel, "-- pilih Provinsi --");
  resetSelect(kabSel, "-- pilih Kabupaten/Kota --");
  resetSelect(diSel, "-- pilih Daerah Irigasi --");
  provSel.disabled = true; kabSel.disabled = true; diSel.disabled = true;

  const bws = bwsSel.value;
  if (!bws) return;

  const rows = raw.filter(r => val(r, KEY.bws) === bws);
  const provs = uniq(rows.map(r => val(r, KEY.prov)).filter(Boolean)).sort(byAlpha);
  fillSelect(provSel, provs, "-- pilih Provinsi --");
  provSel.disabled = false;
}
function onProvChange(){
  setProgressFromSelection();
  resetSelect(kabSel, "-- pilih Kabupaten/Kota --");
  resetSelect(diSel, "-- pilih Daerah Irigasi --");
  kabSel.disabled = true; diSel.disabled = true;

  const bws = bwsSel.value, prov = provSel.value;
  if (!bws || !prov) return;

  const rows = raw.filter(r => val(r, KEY.bws)===bws && val(r, KEY.prov)===prov);
  const kabs = uniq(rows.map(r => val(r, KEY.kab)).filter(Boolean)).sort(byAlpha);
  fillSelect(kabSel, kabs, "-- pilih Kabupaten/Kota --");
  kabSel.disabled = false;
}
function onKabChange(){
  setProgressFromSelection();
  resetSelect(diSel, "-- pilih Daerah Irigasi --");
  diSel.disabled = true;

  const bws = bwsSel.value, prov = provSel.value, kab = kabSel.value;
  if (!bws || !prov || !kab) return;

  const rows = raw.filter(r => val(r, KEY.bws)===bws && val(r, KEY.prov)===prov && val(r, KEY.kab)===kab);
  const dis = uniq(rows.map(r => val(r, KEY.di)).filter(Boolean)).sort(byAlpha);
  fillSelect(diSel, dis, "-- pilih Daerah Irigasi --");
  diSel.disabled = false;
}
function onDiChange(){
  setProgressFromSelection();

  const bws = bwsSel.value, prov = provSel.value, kab = kabSel.value, di = diSel.value;
  if (!bws || !prov || !kab || !di) return;

  const row = raw.find(r => val(r, KEY.bws)===bws && val(r, KEY.prov)===prov && val(r, KEY.kab)===kab && val(r, KEY.di)===di);
  if (!row) return;

  const kec  = val(row, KEY.kec);
  const desa = val(row, KEY.desa);
  if (kec)  kecInp.value  = kec;
  if (desa) desaInp.value = desa;

  const la = Number(val(row, KEY.lat).replace(",",
