<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viewer Data Usulan DI (Proxy)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <style>
    :root{
      --bg:#0b1222;
      --panel:rgba(15,23,42,.86);
      --panel2:rgba(15,23,42,.62);
      --border:rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#60a5fa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 14px 38px rgba(0,0,0,.35);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(52,211,153,.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:16px 18px; border:1px solid var(--border); border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:5; backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--border);
      border-radius:999px; background:rgba(255,255,255,.04);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:50%;}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .topbar{flex-wrap:wrap} }
    .card{
      border:1px solid var(--border); border-radius:var(--r);
      background:var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px 10px 14px; border-bottom:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }
    .card .hd h2{margin:0; font-size:14px}
    .card .bd{padding:14px}
    .controls{
      display:grid; grid-template-columns: 1.2fr .7fr .7fr .6fr .6fr; gap:10px;
      align-items:center;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr 1fr; }
      .controls .span2{grid-column: span 2;}
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(156,163,175,.7)}
    button{
      cursor:pointer; font-weight:700;
      background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.10));
      border-color: rgba(96,165,250,.35);
    }
    button:hover{filter:brightness(1.07)}
    button.ghost{
      background: rgba(255,255,255,.04);
      border-color: var(--border);
      font-weight:600;
    }
    .stats{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    }
    .stat{
      border:1px solid var(--border); border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:800; margin-top:6px}
    .mini{font-size:12px; color:var(--muted); margin-top:6px}
    .tablewrap{overflow:auto}
    table{width:100%; border-collapse:collapse; min-width:980px}
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
      font-size:12px;
    }
    th{
      position:sticky; top:0;
      background: rgba(8,13,25,.9);
      backdrop-filter: blur(8px);
      text-align:left;
      font-size:12px;
      color:#cfe1ff;
      z-index:2;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .tag{
      display:inline-flex; align-items:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-size:11px;
      white-space:nowrap;
    }
    .pager{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-top:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .pager .btns{display:flex; gap:8px; align-items:center}
    .pager button{width:auto; padding:8px 10px; border-radius:12px}
    .toast{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      padding:12px 14px;
      color:var(--muted);
      display:flex; gap:10px; align-items:flex-start;
    }
    .spinner{
      width:18px; height:18px; border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
      margin-top:1px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{
      border-color: rgba(251,113,133,.5);
      background: rgba(251,113,133,.08);
      color:#fecdd3;
    }
    .footer{
      margin:16px 0 6px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }
    .kartu{
      display:flex; flex-direction:column; gap:10px;
    }
    .itemcard{
      border:1px solid var(--border);
      border-radius:14px;
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    .itemtop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{font-weight:800; font-size:13px; margin:0}
    .subtitle{font-size:12px; color:var(--muted); margin-top:4px}
    .row{
      margin-top:10px;
      display:grid; grid-template-columns: repeat(2, 1fr); gap:8px;
    }
    .kv{font-size:12px}
    .kv .k{color:var(--muted)}
    .kv .v{margin-top:2px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>üì° Viewer Data Usulan DI (via Proxy)</h1>
        <div class="sub">Sumber: <span class="muted" id="srcUrl"></span></div>
      </div>
      <div class="pill" id="statusPill">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Siap menarik data‚Ä¶</span>
      </div>
      <div class="pill">
        <span class="muted">Update:</span>
        <span id="lastUpdate">-</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Table -->
      <div class="card">
        <div class="hd">
          <h2>üìã Tabel Data</h2>
          <span class="tag" id="countTag">0 item</span>
        </div>
        <div class="bd">
          <div class="controls">
            <div class="span2">
              <label>Search (nama DI / kab / prov / pengusul / BWS)</label>
              <input id="q" placeholder="misal: Brantas, Jawa Timur, Kediri, Rehabilitasi‚Ä¶" />
            </div>
            <div>
              <label>Provinsi</label>
              <select id="prov">
                <option value="">Semua</option>
              </select>
            </div>
            <div>
              <label>Sort</label>
              <select id="sortBy">
                <option value="Tanggal Usulan|desc">Tanggal (baru)</option>
                <option value="Tanggal Usulan|asc">Tanggal (lama)</option>
                <option value="Total Alokasi Usulan (Rp)|desc">Alokasi (besar)</option>
                <option value="Total Alokasi Usulan (Rp)|asc">Alokasi (kecil)</option>
                <option value="Outcome (Ha)|desc">Outcome (besar)</option>
                <option value="Outcome (Ha)|asc">Outcome (kecil)</option>
                <option value="Urutan Prioritas|asc">Prioritas (1 dulu)</option>
                <option value="Urutan Prioritas|desc">Prioritas (besar)</option>
              </select>
            </div>
            <div>
              <label>Per halaman</label>
              <select id="pageSize">
                <option>10</option>
                <option selected>25</option>
                <option>50</option>
                <option>100</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="reloadBtn" title="Ambil ulang data">‚Üª Reload</button>
            </div>
          </div>

          <div class="toast" id="toast">
            <div class="spinner" id="spin"></div>
            <div>
              <div id="toastTitle" style="font-weight:800;color:#dbeafe">Mengambil data‚Ä¶</div>
              <div id="toastMsg">Kalau datanya banyak, ini bakal kerasa kayak nyeduh kopi drip: pelan tapi pasti ‚òï</div>
            </div>
          </div>

          <div class="tablewrap" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">No</th>
                  <th class="nowrap">Tanggal</th>
                  <th>Nama DI</th>
                  <th>Provinsi</th>
                  <th>Kab/Kota</th>
                  <th>Menu</th>
                  <th class="nowrap">Prioritas</th>
                  <th class="nowrap">Outcome (Ha)</th>
                  <th class="nowrap">Alokasi (Rp)</th>
                  <th class="nowrap">B/BWS</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <!-- rows here -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="pager">
          <div class="muted" id="pagerInfo">-</div>
          <div class="btns">
            <button class="ghost" id="prevBtn">‚óÄ Prev</button>
            <button class="ghost" id="nextBtn">Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Summary + Cards -->
      <div class="card">
        <div class="hd">
          <h2>üßæ Ringkasan</h2>
          <button class="ghost" id="toggleViewBtn" style="width:auto">Tampilkan Kartu</button>
        </div>
        <div class="bd">
          <div class="stats">
            <div class="stat">
              <div class="k">Total item</div>
              <div class="v" id="statTotal">-</div>
              <div class="mini" id="statProv">-</div>
            </div>
            <div class="stat">
              <div class="k">Total alokasi</div>
              <div class="v" id="statSumRp">-</div>
              <div class="mini">Dari hasil filter</div>
            </div>
            <div class="stat">
              <div class="k">Total outcome</div>
              <div class="v" id="statSumHa">-</div>
              <div class="mini">Ha (hasil filter)</div>
            </div>
          </div>

          <div style="margin-top:14px" class="muted">
            Tips: ketik ‚ÄúBrantas‚Äù, ‚ÄúBengawan‚Äù, ‚ÄúRehabilitasi‚Äù, atau nama kab buat nyaring data cepat.
          </div>

          <div id="cardsWrap" style="margin-top:14px; display:none">
            <div class="kartu" id="cards">
              <!-- cards here -->
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="footer">Built for: Kang Irwan ‚öôÔ∏è | Viewer cuma baca data, nggak nulis apa-apa.</div>
  </div>

<script>
  const DATA_URL = "https://gas-proxy3.tuic1677.workers.dev/";
  const els = (id) => document.getElementById(id);

  // state
  let raw = [];
  let filtered = [];
  let page = 1;
  let showCards = false;

  // key helpers (karena banyak key pakai spasi / tanda kurung)
  const get = (obj, key, fallback="") => (obj && obj[key] !== undefined && obj[key] !== null) ? obj[key] : fallback;

  const num = (v) => {
    if (v === null || v === undefined || v === "") return 0;
    if (typeof v === "number") return v;
    // handle "1,234,567" or "1.234.567" just in case
    const s = String(v).replace(/[^\d.-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };

  const fmtRp = (n) => {
    const x = Math.round(num(n));
    return x.toLocaleString("id-ID");
  };

  const fmtHa = (n) => {
    const x = num(n);
    // keep 2 decimals if needed
    return (Math.round(x * 100) / 100).toLocaleString("id-ID");
  };

  const setStatus = (kind, text) => {
    const dot = els("statusDot");
    dot.className = "dot " + (kind || "warn");
    els("statusText").textContent = text;
  };

  const setToast = (mode, title, msg) => {
    const t = els("toast");
    const sp = els("spin");
    els("toastTitle").textContent = title || "";
    els("toastMsg").textContent = msg || "";
    t.classList.toggle("error", mode === "error");
    sp.style.display = (mode === "loading") ? "block" : "none";
    if (mode === "hidden") t.style.display = "none";
    else t.style.display = "flex";
  };

  async function fetchData() {
    setStatus("warn", "Mengambil data‚Ä¶");
    setToast("loading", "Mengambil data‚Ä¶", "Narik data dari proxy, sabar sebentar ya bro.");
    try {
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();

      if (!json || json.ok !== true || !Array.isArray(json.items)) {
        throw new Error("Format JSON tidak sesuai (butuh {ok:true, items:[...]})");
      }

      raw = json.items;
      els("lastUpdate").textContent = new Date().toLocaleString("id-ID");
      setStatus("ok", "Data siap ‚úÖ");
      setToast("hidden");

      hydrateFilters();
      applyFilters(true);
    } catch (e) {
      console.error(e);
      setStatus("bad", "Gagal ambil data");
      setToast("error", "Gagal ambil data ‚ùå", String(e.message || e));
      raw = [];
      filtered = [];
      render();
    }
  }

  function hydrateFilters() {
    // prov options from raw
    const provSel = els("prov");
    const provs = Array.from(new Set(raw.map(x => String(get(x, "Provinsi", "")).trim()).filter(Boolean))).sort();
    provSel.innerHTML = '<option value="">Semua</option>' + provs.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function applyFilters(resetPage=false) {
    const q = els("q").value.trim().toLowerCase();
    const prov = els("prov").value.trim();
    const [sortKey, sortDir] = els("sortBy").value.split("|");

    filtered = raw.filter(it => {
      if (prov && String(get(it,"Provinsi","")).trim() !== prov) return false;

      if (!q) return true;
      const hay = [
        get(it,"Pengusul",""),
        get(it,"Nama DI",""),
        get(it,"Provinsi",""),
        get(it,"Kab/Kota",""),
        get(it,"Menu Kegiatan",""),
        get(it,"Jenis Usulan Kegiatan",""),
        get(it,"B/BWS",""),
        get(it,"Jenis DI",""),
        get(it,"DI Permen",""),
      ].join(" | ").toLowerCase();
      return hay.includes(q);
    });

    // sort
    filtered.sort((a,b)=>{
      const va = get(a, sortKey, "");
      const vb = get(b, sortKey, "");
      let cmp = 0;

      if (sortKey.includes("(Rp)") || sortKey.includes("(Ha)") || sortKey === "Urutan Prioritas" || sortKey.includes("IP ")) {
        cmp = num(va) - num(vb);
      } else if (sortKey === "Tanggal Usulan") {
        cmp = String(va).localeCompare(String(vb)); // YYYY-MM-DD ok lexicographically
      } else {
        cmp = String(va).localeCompare(String(vb));
      }

      return sortDir === "desc" ? -cmp : cmp;
    });

    if (resetPage) page = 1;
    render();
  }

  function render() {
    const pageSize = parseInt(els("pageSize").value, 10) || 25;
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    page = Math.min(page, totalPages);

    const start = (page - 1) * pageSize;
    const end = Math.min(total, start + pageSize);
    const slice = filtered.slice(start, end);

    els("countTag").textContent = `${total.toLocaleString("id-ID")} item`;

    // stats (based on filtered)
    const sumRp = filtered.reduce((acc,it)=>acc + num(get(it,"Total Alokasi Usulan (Rp)",0)), 0);
    const sumHa = filtered.reduce((acc,it)=>acc + num(get(it,"Outcome (Ha)",0)), 0);
    els("statTotal").textContent = total.toLocaleString("id-ID");
    const provCount = new Set(filtered.map(x=>String(get(x,"Provinsi","")).trim()).filter(Boolean)).size;
    els("statProv").textContent = provCount ? `${provCount} provinsi (hasil filter)` : `-`;
    els("statSumRp").textContent = "Rp " + Math.round(sumRp).toLocaleString("id-ID");
    els("statSumHa").textContent = fmtHa(sumHa) + " Ha";

    // pager info
    els("pagerInfo").textContent = total
      ? `Menampilkan ${ (start+1).toLocaleString("id-ID") }‚Äì${ end.toLocaleString("id-ID") } dari ${ total.toLocaleString("id-ID") }`
      : "Tidak ada data (cek filter/search atau sumber).";

    els("prevBtn").disabled = page <= 1;
    els("nextBtn").disabled = page >= totalPages;

    // table rows
    const tbody = els("tbody");
    tbody.innerHTML = slice.map(it => {
      const no = get(it,"No.","");
      const tgl = get(it,"Tanggal Usulan","-");
      const nama = get(it,"Nama DI","-");
      const prov = get(it,"Provinsi","-");
      const kab = get(it,"Kab/Kota","-");
      const menu = get(it,"Menu Kegiatan","-");
      const prio = get(it,"Urutan Prioritas","-");
      const ha = get(it,"Outcome (Ha)",0);
      const rp = get(it,"Total Alokasi Usulan (Rp)",0);
      const bws = get(it,"B/BWS","-");

      return `
        <tr>
          <td class="nowrap">${escapeHtml(no)}</td>
          <td class="nowrap">${escapeHtml(tgl)}</td>
          <td>
            <div style="font-weight:800">${escapeHtml(nama)}</div>
            <div class="muted" style="margin-top:3px">
              ${escapeHtml(get(it,"Jenis DI",""))}
              ${get(it,"DI Permen","") ? " ‚Ä¢ " + escapeHtml(get(it,"DI Permen","")) : ""}
            </div>
          </td>
          <td>${escapeHtml(prov)}</td>
          <td>${escapeHtml(kab)}</td>
          <td>
            <span class="tag">${escapeHtml(menu)}</span>
            ${get(it,"Jenis Usulan Kegiatan","") ? `<div class="muted" style="margin-top:6px">${escapeHtml(get(it,"Jenis Usulan Kegiatan",""))}</div>` : ""}
          </td>
          <td class="nowrap">${escapeHtml(prio)}</td>
          <td class="nowrap">${fmtHa(ha)}</td>
          <td class="nowrap">Rp ${fmtRp(rp)}</td>
          <td class="nowrap">${escapeHtml(bws)}</td>
        </tr>
      `;
    }).join("");

    // cards
    const cards = els("cards");
    cards.innerHTML = slice.map(it => {
      const nama = get(it,"Nama DI","-");
      const tgl = get(it,"Tanggal Usulan","-");
      const prov = get(it,"Provinsi","-");
      const kab = get(it,"Kab/Kota","-");
      const kec = get(it,"Kec","-");
      const desa = get(it,"Desa","-");
      const menu = get(it,"Menu Kegiatan","-");
      const jenis = get(it,"Jenis Usulan Kegiatan","-");
      const bws = get(it,"B/BWS","-");
      const rp = get(it,"Total Alokasi Usulan (Rp)",0);
      const ha = get(it,"Outcome (Ha)",0);
      const prio = get(it,"Urutan Prioritas","-");

      return `
        <div class="itemcard">
          <div class="itemtop">
            <div>
              <p class="title">${escapeHtml(nama)}</p>
              <div class="subtitle">${escapeHtml(prov)} ‚Ä¢ ${escapeHtml(kab)} ‚Ä¢ ${escapeHtml(tgl)}</div>
            </div>
            <span class="tag">Prioritas: ${escapeHtml(prio)}</span>
          </div>
          <div class="row">
            <div class="kv"><div class="k">Lokasi</div><div class="v">${escapeHtml(kec)} ‚Ä¢ ${escapeHtml(desa)}</div></div>
            <div class="kv"><div class="k">B/BWS</div><div class="v">${escapeHtml(bws)}</div></div>
            <div class="kv"><div class="k">Menu</div><div class="v">${escapeHtml(menu)}</div></div>
            <div class="kv"><div class="k">Jenis Usulan</div><div class="v">${escapeHtml(jenis)}</div></div>
            <div class="kv"><div class="k">Outcome</div><div class="v">${fmtHa(ha)} Ha</div></div>
            <div class="kv"><div class="k">Alokasi</div><div class="v">Rp ${fmtRp(rp)}</div></div>
          </div>
        </div>
      `;
    }).join("");

    els("cardsWrap").style.display = showCards ? "block" : "none";
  }

  // events
  els("srcUrl").textContent = DATA_URL;

  els("q").addEventListener("input", () => applyFilters(true));
  els("prov").addEventListener("change", () => applyFilters(true));
  els("sortBy").addEventListener("change", () => applyFilters(false));
  els("pageSize").addEventListener("change", () => applyFilters(true));

  els("reloadBtn").addEventListener("click", fetchData);

  els("prevBtn").addEventListener("click", () => { page = Math.max(1, page-1); render(); });
  els("nextBtn").addEventListener("click", () => { page = page+1; render(); });

  els("toggleViewBtn").addEventListener("click", () => {
    showCards = !showCards;
    els("toggleViewBtn").textContent = showCards ? "Sembunyikan Kartu" : "Tampilkan Kartu";
    render();
  });

  // boot
  fetchData();
</script>
</body>
</html>
