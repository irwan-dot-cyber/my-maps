<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Form Tahap 3 â€“ INPRES 2/2025</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;
  --accent:#22c55e;--warn:#f59e0b
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);color:#e5e7eb}
header{padding:14px;border-bottom:1px solid #1f2937;background:#0c1326;
display:flex;justify-content:space-between;align-items:center}
main{max-width:900px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:14px}
.card h2{margin:0;padding:12px;border-bottom:1px solid #1f2937;font-size:15px}
form{padding:14px;display:grid;gap:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--mut)}
input,select{width:100%;padding:10px;border-radius:10px;
border:1px solid #334155;background:#0b1224;color:#e5e7eb}
button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
.primary{background:var(--accent);color:#022c13;font-weight:700}
.ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
.badge{display:inline-flex;gap:6px;align-items:center;
padding:4px 8px;border-radius:999px;border:1px solid #334155;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%}
.green{background:#22c55e}.gray{background:#94a3b8}.orange{background:#f59e0b}
.actions{display:flex;gap:8px;flex-wrap:wrap}
#map{height:50vh;border-radius:12px}
pre{background:#020617;padding:10px;border-radius:10px;overflow:auto;font-size:12px}
details.debug{border:1px dashed #334155;padding:10px;border-radius:10px}
</style>
</head>

<body>
<header>
  <b>Form Tahap 3</b>
  <a href="https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html"
     style="color:#e5e7eb;text-decoration:none">Beranda</a>
</header>

<main>
<div class="card">
<h2>Data Survey</h2>

<form id="surveyForm">

<div class="row">
  <div><label>B/BWS</label><select id="balai"></select></div>
  <div><label>Provinsi</label><select id="prov" disabled></select></div>
</div>

<div class="row">
  <div><label>Kab/Kota</label><select id="kab" disabled></select></div>
  <div><label>DI</label><select id="di" disabled></select></div>
</div>

<div class="actions">
  <span class="badge"><span class="dot gray"></span>
    <span id="baselineStatus">Baseline: belum dicek</span>
  </span>
</div>

<label>Peta Lokasi</label>
<div id="map"></div>
<div class="actions">
  <button type="button" id="btnPick" class="primary">Ambil titik tengah</button>
  <span id="coordText" class="badge"><span class="dot gray"></span>Lat:- Lng:-</span>
</div>

<div class="row">
  <div><label>Latitude</label><input id="lat"/></div>
  <div><label>Longitude</label><input id="lng"/></div>
</div>

<div class="row">
  <div><label>Nama</label><input id="nama"/></div>
  <div><label>WA/HP</label><input id="telepon"/></div>
</div>

<div class="actions">
  <button type="submit" class="primary">Kirim</button>
  <button type="reset" class="ghost">Reset</button>
</div>

<details class="debug">
<summary>Debug</summary>
<div class="actions" style="margin-top:6px">
  <button type="button" id="btnTestBaseline" class="ghost">Test Baseline</button>
</div>
<pre id="debugOut">---</pre>
</details>

</form>
</div>
</main>

<script>
/* ================= CONFIG ================= */
const BASELINE_URL =
'https://gas-proxy3.tuic1677.workers.dev/';

/* ================= MAP ================= */
const map=L.map('map').setView([-2.5,118],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

const marker=L.marker(map.getCenter()).addTo(map);
map.on('move',()=>{
  const c=map.getCenter();
  marker.setLatLng(c);
  document.getElementById('coordText').innerHTML=
    '<span class="dot green"></span>Lat:'+c.lat.toFixed(6)+' Lng:'+c.lng.toFixed(6);
});

/* ================= BASELINE ================= */
async function loadBaseline(){
  const out=document.getElementById('debugOut');
  out.textContent='Loading baseline...';
  try{
    const r=await fetch(BASELINE_URL,{cache:'no-store'});
    const j=await r.json();

    if(!j || !Array.isArray(j.data)){
      throw 'Format salah';
    }

    document.getElementById('baselineStatus').textContent=
      'Baseline OK ('+j.data.length+' baris)';

    document.getElementById('baselineStatus').previousElementSibling
      .className='dot green';

    out.textContent=JSON.stringify(j.data[0],null,2);

    // isi dropdown aman
    const balai=[...new Set(j.data.map(x=>x['B/BWS']).filter(Boolean))];
    fill('balai',balai);

  }catch(e){
    document.getElementById('baselineStatus').textContent='Baseline ERROR';
    out.textContent=String(e);
  }
}

function fill(id,list){
  const s=document.getElementById(id);
  s.innerHTML='<option value="">-- pilih --</option>';
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=o.textContent=v;
    s.appendChild(o);
  });
  s.disabled=false;
}

/* ================= EVENT ================= */
document.getElementById('btnPick').onclick=()=>{
  const c=map.getCenter();
  lat.value=c.lat.toFixed(6);
  lng.value=c.lng.toFixed(6);
};

document.getElementById('btnTestBaseline').onclick=loadBaseline;

/* auto load */
loadBaseline();
</script>

</body>
</html>
