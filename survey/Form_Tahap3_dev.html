<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Tahap 3 (Koordinat Auto-Lock)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1224;
      --card:#0f172a;
      --mut:#9aa3b2;
      --accent:#22c55e;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#e5e7eb;
    }

    header{
      padding:14px 18px;
      border-bottom:1px solid #1f2937;
      background:#0c1326;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .hdr-left{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn-home{
      display:inline-block;
      text-decoration:none;
      padding:8px 12px;
      border-radius:10px;
      background:#0b1224;
      color:#e5e7eb;
      border:1px solid #334155;
      font-weight:600;
      font-size:13px;
      line-height:1;
    }
    .btn-home:hover{filter:brightness(1.05)}

    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{
      background:var(--card);
      border:1px solid #1f2937;
      border-radius:14px;
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:12px 14px;
      border-bottom:1px solid #1f2937;
      font-size:16px;
    }
    form{
      padding:12px 14px;
      display:grid;
      gap:12px;
    }
    label{
      font-size:12px;
      color:var(--mut);
    }
    select,input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1224;
      color:#e5e7eb;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    button{
      cursor:pointer;
      border:0;
      padding:10px 14px;
      border-radius:10px;
    }
    .primary{
      background:var(--accent);
      color:#022c16;
      font-weight:600;
    }
    .ghost{
      background:#0b1224;
      color:#e5e7eb;
      border:1px solid #334155;
    }
    .hint{font-size:12px;color:var(--mut)}
    #map{height:56vh}
    .mapwrap{position:relative}
    .crosshair{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:grid;
      place-items:center;
      z-index:1000;
    }
    .crosshair .reticle{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      width:28px;
      height:28px;
    }
    .crosshair .reticle::before{
      content:"";
      position:absolute;
      inset:0;
      border:2px solid #e5e7ebcc;
      border-radius:50%;
      box-shadow:0 0 8px #000a;
    }
    .crosshair .reticle .h,
    .crosshair .reticle .v{
      position:absolute;
      background:#e5e7ebaa;
      box-shadow:0 0 6px #0008;
    }
    .crosshair .reticle .h{
      width:14px;
      height:2px;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
    }
    .crosshair .reticle .v{
      width:2px;
      height:14px;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
    }

    .toast{
      margin:10px 14px;
      padding:10px 12px;
      border-radius:10px;
      background:#052e1a;
      border:1px solid #14532d;
      color:#bbf7d0;
      display:none;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border:1px solid #334155;
      border-radius:999px;
      background:#0b1224;
      font-size:12px;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:#22c55e}
    .dot.orange{background:#f59e0b}
    .dot.gray{background:#94a3b8}

    .gallery{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
    }
    .gallery a{
      display:block;
      border:1px solid #1f2937;
      border-radius:10px;
      overflow:hidden;
      background:#0b1224;
    }
    .gallery img{
      display:block;
      width:100%;
      height:140px;
      object-fit:cover;
    }
    .muted{opacity:.7}

    .leaflet-marker-icon.bump{
      animation:bump .6s ease;
      transform-origin:bottom center;
    }
    @keyframes bump{
      0%{transform:translateY(0)}
      30%{transform:translateY(-10px)}
      60%{transform:translateY(0)}
      80%{transform:translateY(-5px)}
      100%{transform:translateY(0)}
    }

    @media (max-width:820px){
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>
  <div class="hdr-left">
    <strong>Form Tahap 3</strong>
    <span class="hint">INPRES 2/2025 ‚Ä¢ Pelaksanaan Tahap 3</span>
  </div>
  <a class="btn-home" href="https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html">Beranda</a>
</header>

<main>
  <div class="card">
    <h2>Data Survey</h2>
    <div id="toast" class="toast"></div>

    <form id="surveyForm">
      <div class="row">
        <div>
          <label>B/BWS</label>
          <select id="balai" name="balai" required></select>
        </div>
        <div>
          <label>Provinsi</label>
          <select id="prov" name="provinsi" required disabled></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Kabupaten/Kota</label>
          <select id="kab" name="kabupaten" required disabled></select>
        </div>
        <div>
          <label>Daerah Irigasi (DI)</label>
          <select id="di" name="di" required disabled></select>
        </div>
      </div>

      <!-- hidden supaya ikut ke log -->
      <input type="hidden" id="kecamatan" name="kecamatan">
      <input type="hidden" id="desa" name="desa">

      <div class="actions" id="statusBar" style="gap:10px;margin-top:-4px">
        <span class="badge">
          <span class="dot green"></span>Progres terakhir:
          <b id="lastStage">0%</b>
        </span>
        <span class="badge" id="coordBadge">
          <span class="dot gray"></span>
          <span id="coordBadgeText">Koordinat: -</span>
        </span>
      </div>

      <!-- Informasi Paket -->
      <div id="infoBlock" class="card" style="border-radius:12px;margin-top:6px">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #1f2937">
          <div style="font-size:14px;font-weight:600">Informasi Paket</div>
          <button type="button" id="btnInfoToggle" class="ghost" style="padding:4px 10px;font-size:11px">Ciutkan</button>
        </div>
        <div id="infoBody" style="padding:10px 14px;font-size:12px;">
          <div class="hint muted">Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.</div>
        </div>
      </div>

      <div>
        <label>Peta Lokasi</label>
        <div class="mapwrap">
          <div id="map"></div>
          <div class="crosshair">
            <div class="reticle">
              <span class="h"></span><span class="v"></span>
            </div>
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
          <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
          <span class="hint" id="coords">Lat: -, Lng: -</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Latitude</label>
          <input type="number" step="0.000001" id="lat" name="lat" required/>
        </div>
        <div>
          <label>Longitude</label>
          <input type="number" step="0.000001" id="lng" name="lng" required/>
        </div>
      </div>

      <div id="historyBlock" class="card" style="border-radius:12px;margin-top:6px">
        <h2 style="font-size:14px">Riwayat Foto Progres</h2>
        <div id="historyGals" style="padding:12px 14px">
          <div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>
        </div>
      </div>

      <div class="card" style="border-radius:12px">
        <h2 style="font-size:14px">Upload Foto Progres</h2>
        <div style="padding:12px 14px; display:grid; gap:10px">
          <div class="actions" id="stageBtns"></div>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
          <div class="hint">
            Pilih kamera/galeri. Foto dikompresi otomatis & dikirim juga sebagai base64 fallback.
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Nama Pengirim</label>
          <input id="nama" name="nama" placeholder="Nama lengkap" required/>
        </div>
        <div>
          <label>Nomor WA/HP</label>
          <input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required/>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="primary" id="btnSubmit" disabled>Kirim</button>
        <button type="reset" class="ghost" id="btnReset">Reset</button>
      </div>
    </form>
  </div>
</main>

<!-- Overlay Upload -->
<div id="uploadOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999">
  <div class="u-box" role="alert" aria-live="assertive" style="background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw">
    <div class="u-title" id="uploadTitle" style="font-weight:800;margin-bottom:6px">Mengunggah data‚Ä¶</div>
    <div class="u-progress" style="height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222">
      <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)"></div>
    </div>
    <div class="u-hint" id="uploadHint" style="font-size:12px;color:#a1a1aa;margin-top:8px">Jangan tutup halaman ini.</div>
  </div>
</div>

<script>
/* ===== CONFIG endpoint (Cloudflare Worker) ===== */
var DATA_URL = 'https://gas-proxy3.tuic1677.workers.dev';
var ENDPOINT = DATA_URL;

/* ===== Utils ===== */
function toast(m){
  var t=document.getElementById('toast');
  t.textContent=m;
  t.style.display='block';
  clearTimeout(window.__t);
  window.__t=setTimeout(function(){t.style.display='none';},4200);
}
function fillSelect(el, items, ph){
  if(typeof ph==='undefined') ph='-- pilih --';
  el.innerHTML='';
  if(ph && !el.multiple){
    var o=document.createElement('option');
    o.value=''; o.textContent=ph; el.appendChild(o);
  }
  (items||[]).forEach(function(v){
    var o=document.createElement('option');
    o.value=v; o.textContent=v;
    el.appendChild(o);
  });
  el.disabled=!(items&&items.length);
}
function titleCase(s){
  return String(s||'').split(/(\s+|[-/])/).map(function(tok){
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok;
    var up = tok.toUpperCase();
    if (up==='BBWS'||up==='BWS') return up;
    if (/^(D\.?I\.?|DI)$/.test(up)) return 'D.I.';
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join(' ');
}

// cari field berdasarkan kata kunci di nama kolom
function pickFieldLike(row, substrings){
  substrings = (substrings || []).map(function(s){
    return String(s).toLowerCase();
  });
  for (var key in row){
    if (!row.hasOwnProperty(key)) continue;
    var norm = String(key).toLowerCase().replace(/\s+/g,' ').trim();
    for (var i=0;i<substrings.length;i++){
      if (norm.indexOf(substrings[i]) !== -1){
        return row[key];
      }
    }
  }
  return '';
}

var $overlay=document.getElementById('uploadOverlay');
var $bar=document.getElementById('progressBar');
function setUploadingUI(opts){
  var show=opts.show;
  var percent=opts.percent;
  if(typeof percent==='number'){
    var w=Math.max(0,Math.min(100,Math.round(percent)))+'%';
    $bar.style.width=w;
  }
  $overlay.style.display=show?'flex':'none';
}
function disableForm(b){
  var els=document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button');
  els.forEach(function(e){ e.disabled=!!b; });
}

/* ===== Map ===== */
var baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:20, attribution:'¬© OpenStreetMap'
});
var baseImg=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'
});
var map=L.map('map',{zoomControl:true,layers:[baseOSM]});
L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5);
var coordsTxt=document.getElementById('coords');
function upd(){
  var c=map.getCenter();
  coordsTxt.textContent='Lat: '+c.lat.toFixed(6)+', Lng: '+c.lng.toFixed(6);
}
map.on('move',upd);
map.whenReady(upd);

/* ===== Marker utk titik terpilih ===== */
var pickedMarker = null;
var pickedIcon = L.icon({
  iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
  iconSize: [25,41],
  iconAnchor: [12,41],
  shadowUrl: 'https://unpkg.com/leaflet/dist/images/marker-shadow.png',
  shadowSize: [41,41]
});
function showPicked(lat, lng, opts){
  opts = opts || {};
  var bounce = (typeof opts.bounce==='undefined')?true:opts.bounce;
  var zoom   = (typeof opts.zoom==='undefined')?null:opts.zoom;
  if(!isFinite(lat) || !isFinite(lng)) return;
  var ll = L.latLng(lat, lng);
  if(!pickedMarker){
    pickedMarker = L.marker(ll, {icon:pickedIcon}).addTo(map);
  }else{
    pickedMarker.setLatLng(ll);
  }
  var el = pickedMarker._icon;
  if (bounce && el){
    el.classList.remove('bump');
    void el.offsetWidth;
    el.classList.add('bump');
  }
  if(zoom!==null){
    map.setView(ll, zoom);
  }
}

/* ===== DOM refs ===== */
var balai=document.getElementById('balai'),
    prov=document.getElementById('prov'),
    kab=document.getElementById('kab'),
    di=document.getElementById('di');
var lat=document.getElementById('lat'),
    lng=document.getElementById('lng'),
    form=document.getElementById('surveyForm'),
    btnSubmit=document.getElementById('btnSubmit');
var coordBadge=document.getElementById('coordBadge'),
    coordBadgeText=document.getElementById('coordBadgeText');
var btnPick   = document.getElementById('btnPick');
var btnPan    = document.getElementById('btnPan');
var btnLocate = document.getElementById('btnLocate');
var kecInput  = document.getElementById('kecamatan');
var desaInput = document.getElementById('desa');

var infoBody = document.getElementById('infoBody');
var btnInfoToggle = document.getElementById('btnInfoToggle');

/* ===== Toggle info ===== */
if(btnInfoToggle){
  btnInfoToggle.addEventListener('click', function(){
    if(!infoBody) return;
    var hidden = infoBody.style.display === 'none';
    infoBody.style.display = hidden ? 'block' : 'none';
    btnInfoToggle.textContent = hidden ? 'Ciutkan' : 'Tampilkan';
  });
}

/* helper untuk panel info */
function safeText(v){
  if(v===undefined || v===null) return '-';
  var s=String(v).trim();
  return s? s : '-';
}
function setInfoPanelFromEntry(entry){
  if(!infoBody) return;
  if(!entry){
    infoBody.innerHTML = '<div class="hint muted">Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.</div>';
    return;
  }
  var meta = entry.meta || {};
  var kecs = entry.kecamatan ? Array.from(entry.kecamatan) : [];
  var desas= entry.desa ? Array.from(entry.desa) : [];
  var html =
    '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px 16px">' +
      '<div><div class="hint">Kecamatan</div><div>'+safeText(kecs[0])+'</div></div>' +
      '<div><div class="hint">Desa</div><div>'+safeText(desas[0])+'</div></div>' +
      '<div><div class="hint">Menu Kegiatan</div><div>'+safeText(meta.menuKegiatan)+'</div></div>' +
      '<div><div class="hint">Jenis Usulan Kegiatan</div><div>'+safeText(meta.jenisUsulan)+'</div></div>' +
      '<div><div class="hint">Urutan Prioritas</div><div>'+safeText(meta.urutanPrioritas)+'</div></div>' +
      '<div><div class="hint">IP Padi Semula (%)</div><div>'+safeText(meta.ipSemula)+'</div></div>' +
      '<div><div class="hint">IP Padi Menjadi (%)</div><div>'+safeText(meta.ipMenjadi)+'</div></div>' +
      '<div><div class="hint">Outcome (Ha)</div><div>'+safeText(meta.outcome)+'</div></div>' +
      '<div><div class="hint">Masa Pelaksanaan</div><div>'+safeText(meta.masa)+'</div></div>' +
    '</div>';
  infoBody.innerHTML = html;
}

/* ===== Tombol map ===== */
btnLocate.addEventListener('click',function(){
  map.locate({setView:true,maxZoom:17,enableHighAccuracy:true});
});
map.on('locationfound', function(e){
  lat.value = e.latitude.toFixed(6);
  lng.value = e.longitude.toFixed(6);
  showPicked(e.latitude, e.longitude, {bounce:true, zoom:17});
});
map.on('locationerror',function(){
  alert('Izin lokasi ditolak. Geser peta manual.');
});

btnPick.addEventListener('click',function(){
  var c=map.getCenter();
  lat.value=c.lat.toFixed(6);
  lng.value=c.lng.toFixed(6);
  showPicked(c.lat, c.lng, {bounce:true});
});

btnPan.addEventListener('click',function(){
  var la=+lat.value, lo=+lng.value;
  if(!isNaN(la)&&!isNaN(lo)){
    showPicked(la, lo, {bounce:true, zoom:Math.max(map.getZoom(),16)});
  }
});

/* update marker jika user ketik koordinat manual */
function tryUpdateFromInputs(){
  var la = parseFloat(lat.value),
      lo = parseFloat(lng.value);
  if(isFinite(la) && isFinite(lo)){
    showPicked(la, lo, {bounce:false});
  }
}
lat.addEventListener('change', tryUpdateFromInputs);
lng.addEventListener('change', tryUpdateFromInputs);

/* ===== Baseline INDEX ===== */
var INDEX={};

async function loadData(){
  try{
    var url = DATA_URL + '?t=' + Date.now();
    var resp = await fetch(url,{cache:'no-store'});
    var raw = await resp.text();
    var cleaned = raw.replace(/^\)\]\}'\s*/, '');

    var parsed;
    try{
      parsed = JSON.parse(cleaned);
    }catch(e){
      console.error('Gagal parse baseline (bukan JSON):', raw);
      toast('‚ö†Ô∏è Gagal membaca baseline (JSON error).');
      return;
    }

    var rows = null;

    // 1) Sudah berupa array
    if (Array.isArray(parsed)) {
      rows = parsed;
    }
    // 2) Bentuk { items: [...] }
    else if (parsed && Array.isArray(parsed.items)) {
      rows = parsed.items;
    }
    // 3) Bentuk { data: [...] }
    else if (parsed && Array.isArray(parsed.data)) {
      rows = parsed.data;
    }
    // 4) Bentuk { rows: [...] }
    else if (parsed && Array.isArray(parsed.rows)) {
      rows = parsed.rows;
    }
    // 5) Bentuk objek ‚Äúdictionary‚Äù: { key1:{...}, key2:{...}, ... }
    else if (parsed && typeof parsed === 'object') {
      var vals = Object.values(parsed);
      if (vals.length && vals.every(function(v){ return typeof v === 'object'; })) {
        rows = vals;
      }
    }

    if (!rows || !rows.length){
      console.error('Baseline tidak dalam format yang diharapkan:', parsed);
      toast('‚ö†Ô∏è Baseline kosong / format tidak dikenali.');
      return;
    }

    INDEX={};
    rows.forEach(function(row){
      var BWS = titleCase(
        row['B/BWS'] ||
        row['B/BWS PELAKSANA'] ||
        row['BWS'] ||
        row['Balai']
      );
      var PROV = titleCase(
        row['Provinsi'] ||
        row['PROVINSI'] ||
        row['Prov']
      );
      var KAB = titleCase(
        row['Kab/Kota'] ||
        row['Kabupaten'] ||
        row['KABUPATEN'] ||
        row['Kabupaten/Kota']
      );
      var DI  = titleCase(
        row['Nama DI'] ||
        row['NAMA DI/DIR'] ||
        row['nama di'] ||
        row['DI'] ||
        row['Paket']
      );
      var KEC  = row['Kec']  || row['KECAMATAN'] || row['Kecamatan'] || '';
      var DESA = row['Desa'] || row['DESA']      || '';

      var MENU  = row['Menu Kegiatan'] || pickFieldLike(row, ['menu kegiatan','menu keg']);
      var JENUS = row['Jenis Usulan Kegiatan'] || pickFieldLike(row, ['jenis usulan kegiatan','jenis usulan']);
      var URUT  = row['Urutan Prioritas'] || pickFieldLike(row, ['urutan prioritas','prioritas']);

      var IPSEM = row['IP Padi Semula (%)']  || row['IP Padi Semula']  || pickFieldLike(row, ['ip padi semula','ip semula']);
      var IPMEN = row['IP Padi Menjadi (%)'] || row['IP Padi Menjadi'] || pickFieldLike(row, ['ip padi menjadi','ip menjadi']);
      var OUT   = row['Outcome (Ha)']        || row['Outcome']         || pickFieldLike(row, ['outcome']);
      var MASA  = row['Masa Pelaksanaan']    || pickFieldLike(row, ['masa pelaksanaan']);

      if(!(BWS && PROV && KAB && DI)) return;

      if(!INDEX[BWS]) INDEX[BWS]={};
      if(!INDEX[BWS][PROV]) INDEX[BWS][PROV]={};
      if(!INDEX[BWS][PROV][KAB]) INDEX[BWS][PROV][KAB]={};
      if(!INDEX[BWS][PROV][KAB][DI]) INDEX[BWS][PROV][KAB][DI]={kecamatan:new Set(), desa:new Set(), meta:null};

      var entry = INDEX[BWS][PROV][KAB][DI];

      String(KEC).split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean)
        .forEach(function(kec){
          entry.kecamatan.add(titleCase(kec));
        });
      String(DESA).split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean)
        .forEach(function(desa){
          entry.desa.add(titleCase(desa));
        });

      entry.meta = {
        menuKegiatan:    MENU,
        jenisUsulan:     JENUS,
        urutanPrioritas: URUT,
        ipSemula:        IPSEM,
        ipMenjadi:       IPMEN,
        outcome:         OUT,
        masa:            MASA
      };
    });

    fillSelect(balai, Object.keys(INDEX).sort(), '-- pilih B/BWS --');
    prov.disabled=true; kab.disabled=true; di.disabled=true;
  }catch(e){
    console.error(e);
    toast('‚ö†Ô∏è Gagal memuat baseline (network/worker).');
  }
}


/* ===== Badge & kunci koordinat ===== */
function setCoordBadge(type, text){
  var dotEl = coordBadge.querySelector('.dot');
  if(dotEl){
    dotEl.classList.remove('green','orange','gray');
    if(type==='locked') dotEl.classList.add('green');
    else if(type==='none') dotEl.classList.add('orange');
    else dotEl.classList.add('gray');
  }
  coordBadgeText.textContent = text;
}
function setCoordLock(locked, la, ln){
  if (locked) {
    if (isFinite(la) && isFinite(ln)) {
      lat.value = Number(la).toFixed(6);
      lng.value = Number(ln).toFixed(6);
      showPicked(Number(la), Number(ln), {bounce:false, zoom:17});
    }
    lat.disabled = true; lng.disabled = true;
    btnPick.disabled = true; btnPan.disabled = true; btnLocate.disabled = true;
    btnPick.classList.remove('primary'); btnPick.classList.add('ghost');
  } else {
    lat.disabled = false; lng.disabled = false;
    btnPick.disabled = false; btnPan.disabled = false; btnLocate.disabled = false;
    btnPick.classList.add('primary'); btnPick.classList.remove('ghost');
  }
}

/* ===== Cascade dropdown ===== */
balai.addEventListener('change', function(){
  var b=balai.value;
  if(!b){
    fillSelect(prov,[], '-- pilih Provinsi --');
    prov.disabled=true;
    fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
    fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
    setInfoPanelFromEntry(null);
    kecInput.value=''; desaInput.value='';
    return;
  }
  fillSelect(prov, Object.keys(INDEX[b]||{}).sort(),'-- pilih Provinsi --');
  prov.disabled=false;
  fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  setInfoPanelFromEntry(null);
  kecInput.value=''; desaInput.value='';
});
prov.addEventListener('change', function(){
  var b=balai.value, p=prov.value;
  if(!p){
    fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
    fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
    setInfoPanelFromEntry(null);
    kecInput.value=''; desaInput.value='';
    return;
  }
  fillSelect(kab, Object.keys((INDEX[b]||{})[p]||{}).sort(),'-- pilih Kab/Kota --');
  kab.disabled=false;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  setInfoPanelFromEntry(null);
  kecInput.value=''; desaInput.value='';
});
kab.addEventListener('change', function(){
  var b=balai.value, p=prov.value, k=kab.value;
  if(!k){
    fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
    setInfoPanelFromEntry(null);
    kecInput.value=''; desaInput.value='';
    return;
  }
  fillSelect(di, Object.keys((((INDEX[b]||{})[p]||{})[k]||{})).sort(),'-- pilih DI --');
  di.disabled=false;
  setInfoPanelFromEntry(null);
  kecInput.value=''; desaInput.value='';
});

di.addEventListener('change', async function(){
  var b=balai.value, p=prov.value, k=kab.value, d=di.value;
  var entry = (((INDEX[b]||{})[p]||{})[k]||{})[d];

  setInfoPanelFromEntry(entry || null);

  // isi hidden kecamatan & desa
  if(entry){
    var kecs = entry.kecamatan ? Array.from(entry.kecamatan) : [];
    var desas = entry.desa ? Array.from(entry.desa) : [];
    kecInput.value = kecs[0] || '';
    desaInput.value = desas[0] || '';
  }else{
    kecInput.value='';
    desaInput.value='';
  }

  if(!(b && p && k && d)) return;

  var hist = await fetchHistory(b,p,k,d);
  lastStageEl.textContent = (hist.maxStage||0) + '%';
  renderHistoryPhotos(hist.photos||{});
  renderStageButtons(hist.maxStage||0);

  var hasCoord = hist.coords && isFinite(hist.coords.lat) && isFinite(hist.coords.lng);
  if (hasCoord){
    setCoordLock(true, hist.coords.lat, hist.coords.lng);
    setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
    map.setView([hist.coords.lat, hist.coords.lng], 17);
  } else {
    setCoordLock(false);
    setCoordBadge('none','Koordinat: belum ada, silakan pilih titik');
  }
});

/* ===== History / Stage ===== */
var currentStage=null;
var lastStageEl=document.getElementById('lastStage');
var historyGals=document.getElementById('historyGals');

function renderStageButtons(maxStage){
  var wrap=document.getElementById('stageBtns');
  wrap.innerHTML='';
  var stages=[25,50,75,100];
  var nextStage = (maxStage>=100) ? null : (maxStage===0 ? 25 : (maxStage+25));
  stages.forEach(function(st){
    var btn=document.createElement('button');
    btn.type='button';
    btn.textContent='Progres '+st+'%';
    var enabled = (st===nextStage);
    btn.className = enabled ? 'primary' : 'ghost';
    btn.disabled = !enabled;
    btn.addEventListener('click', function(){
      currentStage=st;
      toast('Stage dipilih: '+st+'%');
      updateSubmitState();
    });
    wrap.appendChild(btn);
  });
  currentStage = nextStage;
  btnSubmit.disabled = !nextStage;
  updateSubmitState();
}

function renderHistoryPhotos(photos){
  var order=[25,50,75,100];
  var html='', has=false;
  order.forEach(function(st){
    var p=photos[String(st)];
    if(p&&p.url){
      has=true;
      html+=
        '<div style="margin-bottom:10px">'+
          '<div class="hint">Foto Progres '+st+'%:</div>'+
          '<div class="gallery">'+
            '<a href="'+p.url+'" target="_blank" title="'+(p.name||('Stage '+st))+'">'+
              '<img loading="lazy" src="'+p.url+'" alt="Progres '+st+'%"/>'+
            '</a>'+
          '</div>'+
        '</div>';
    }
  });
  historyGals.innerHTML = has
    ? html
    : '<div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>';
}

async function fetchHistory(bws, p, k, d){
  var qs = 'fn=history'
    +'&bws='+encodeURIComponent(bws)
    +'&prov='+encodeURIComponent(p)
    +'&kab='+encodeURIComponent(k)
    +'&di='+encodeURIComponent(d)
    +'&t='+Date.now();
  var url = DATA_URL + '?' + qs;
  var res = await fetch(url, {cache:'no-store'});
  try{
    var j=await res.json();
    if(j && j.ok) return j;
    return {ok:false,maxStage:0,coords:null,photos:{}};
  }catch(e){
    return {ok:false,maxStage:0,coords:null,photos:{}};
  }
}

/* ===== Foto + kompresi ===== */
var selectedFile=null;
var fileInput=document.getElementById('fileInput');
var photoMeta=document.getElementById('photoMeta');

document.getElementById('btnCamera').addEventListener('click',function(){
  fileInput.setAttribute('capture','environment');
  fileInput.click();
});
document.getElementById('btnGallery').addEventListener('click',function(){
  fileInput.removeAttribute('capture');
  fileInput.click();
});
fileInput.addEventListener('change',function(){
  selectedFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
  photoMeta.textContent = selectedFile
    ? 'Dipilih: '+selectedFile.name+' ‚Ä¢ '+(selectedFile.size/1024).toFixed(1)+' KB'
    : '';
});

async function compressImage(file,opts){
  opts = opts || {};
  var maxDim = (typeof opts.maxDim==='number')?opts.maxDim:2000;
  var quality = (typeof opts.quality==='number')?opts.quality:0.82;
  var mime = opts.mime || 'image/jpeg';
  try{
    if(!(file&&file.type&&file.type.startsWith('image/'))) return file;
    var bitmap = await createImageBitmap(file,{imageOrientation:'from-image'});
    var W=bitmap.width,H=bitmap.height;
    var s=Math.min(1,maxDim/Math.max(W,H));
    var w=Math.round(W*s), h=Math.round(H*s);
    if(s===1 && file.type==='image/jpeg' && file.size<700*1024) return file;
    var c=document.createElement('canvas');
    c.width=w; c.height=h;
    var ctx=c.getContext('2d');
    ctx.drawImage(bitmap,0,0,w,h);
    var blob=await new Promise(function(r){c.toBlob(r,mime,quality);});
    if(!blob||blob.size>=file.size) return file;
    var baseName=file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto';
    var name=baseName+'.jpg';
    return new File([blob],name,{type:mime});
  }catch(e){
    console.warn('compress fail',e);
    return file;
  }
}

/* ===== Validasi tombol Kirim ===== */
function missingList(){
  var m = [];
  if(!balai.value) m.push('B/BWS');
  if(!prov.value) m.push('Provinsi');
  if(!kab.value)  m.push('Kab/Kota');
  if(!di.value)   m.push('DI');
  if(!lat.value || !lng.value)                    m.push('Koordinat');
  if(!document.getElementById('nama').value)      m.push('Nama');
  if(!document.getElementById('telepon').value)   m.push('Nomor WA/HP');
  if(!currentStage)                               m.push('Stage Progres');
  return m;
}
function updateSubmitState(){
  var ok = missingList().length === 0;
  document.getElementById('btnSubmit').disabled = !ok;
}
document.getElementById('surveyForm').addEventListener('input', updateSubmitState);
document.getElementById('surveyForm').addEventListener('change', updateSubmitState);
btnPick.addEventListener('click', function(){ setTimeout(updateSubmitState, 0); });
btnPan.addEventListener('click',  function(){ setTimeout(updateSubmitState, 0); });

/* ===== Submit ===== */
form.addEventListener('submit', async function(e){
  e.preventDefault();

  var miss = missingList();
  if (miss.length){
    toast('‚ö†Ô∏è Harus diisi dulu: ' + miss.join(', '));
    updateSubmitState();
    return;
  }

  var b=balai.value, p=prov.value, k=kab.value, d=di.value;

  var b64='', photo=null;
  if (selectedFile) {
    photo = await compressImage(selectedFile,{maxDim:2000,quality:0.82});
    var dt = new DataTransfer();
    dt.items.add(photo);
    fileInput.files = dt.files;
    b64 = await new Promise(function(res, rej){
      var r = new FileReader();
      r.onload=function(){res(String(r.result));};
      r.onerror=rej;
      r.readAsDataURL(photo);
    });
    var kb = (photo.size/1024).toFixed(1);
    photoMeta.textContent = 'Akan dikirim: '+photo.name+' ‚Ä¢ '+kb+' KB';
  }

  var fd = new FormData(form);
  fd.set('progress_stage', String(currentStage));
  if (b64) {
    fd.set('foto_b64', b64);
    fd.set('foto_name', photo.name);
    fd.set('foto_type', photo.type);
  }

  disableForm(true);
  setUploadingUI({show:true, percent:6});
  var xhr = new XMLHttpRequest();
  xhr.open('POST', ENDPOINT, true);
  xhr.upload.onprogress = function(ev){
    if (ev.lengthComputable)
      setUploadingUI({show:true, percent:(ev.loaded/ev.total)*100});
  };
  xhr.onloadstart = function(){ setUploadingUI({show:true, percent:5}); };
  xhr.onreadystatechange = function(){
    if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED)
      setUploadingUI({show:true, percent:95});
  };
  xhr.onerror = function(){
    setUploadingUI({show:false});
    disableForm(false);
    toast('‚ùå Gagal kirim (jaringan/proxy).');
  };
  xhr.onload = async function(){
    var data={};
    try{ data = JSON.parse(xhr.responseText||'{}'); }catch(e){}
    if (xhr.status>=200 && xhr.status<300 && data && data.ok) {
      setUploadingUI({show:true, percent:100});
      toast('‚úÖ Terkirim!');
      var hist = await fetchHistory(b, p, k, d);
      lastStageEl.textContent = (hist.maxStage||0) + '%';
      renderHistoryPhotos(hist.photos||{});
      renderStageButtons(hist.maxStage||0);
      if (hist.coords){
        setCoordLock(true, hist.coords.lat, hist.coords.lng);
        setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
      }
      setTimeout(function(){ setUploadingUI({show:false}); }, 600);
    } else {
      setUploadingUI({show:false});
      disableForm(false);
      toast('‚ùå Gagal kirim (server). ' + (data && data.error ? data.error : ''));
    }
    disableForm(false);
    updateSubmitState();
  };
  xhr.send(fd);
});

/* ===== Reset ===== */
document.getElementById('btnReset').addEventListener('click', function(){
  selectedFile=null;
  photoMeta.textContent='';
  fillSelect(prov,[], '-- pilih Provinsi --'); prov.disabled=true;
  fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  lastStageEl.textContent='0%';
  setCoordBadge('none','Koordinat: -');
  setCoordLock(false);
  if(pickedMarker){
    map.removeLayer(pickedMarker);
    pickedMarker=null;
  }
  currentStage=null;
  renderHistoryPhotos({});  
  setInfoPanelFromEntry(null);
  kecInput.value=''; desaInput.value='';
  updateSubmitState();
});

/* start */
function setCoordBadgeInit(){ setCoordBadge('none','Koordinat: -'); }
loadData();
setCoordBadgeInit();
updateSubmitState();
</script>
</body>
</html>
