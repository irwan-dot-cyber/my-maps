<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Form Tahap 3 ‚Äî INPRES 2/2025</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg0:#050914;
      --bg1:#070c1a;
      --panel: rgba(9, 16, 36, .78);
      --panel2: rgba(10, 18, 42, .62);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text:#e5e7eb;
      --muted:#a8b1c7;
      --muted2:#7f8aa5;
      --accent:#22c55e;
      --accent2:#86efac;
      --blue:#3b82f6;
      --warn:#f59e0b;
      --bad:#fb7185;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 14px;
      --hdrH: 68px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(700px 420px at 90% 0%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 40% 120%, rgba(245,158,11,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .topbar{
      position: sticky; top:0; z-index: 10;
      height: var(--hdrH);
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 22px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      background: rgba(4, 8, 20, .72);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:baseline; gap:14px; white-space:nowrap;}
    .brand .title{font-weight: 800; letter-spacing:.2px; font-size: 22px;}
    .brand .sub{font-size: 13px; color: var(--muted); font-weight: 500;}

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      background: rgba(255,255,255,.04);
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 800;
      cursor:pointer;
      transition:.15s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ filter: brightness(1.08); border-color: rgba(255,255,255,.22); }
    .btn:active{ transform: translateY(1px); }

    .wrap{ max-width: 1180px; margin: 0 auto; padding: 22px; }
    .card{
      margin-top: 18px;
      border: 1px solid var(--border);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{
      background: var(--panel);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.08);
      margin: 14px;
      padding: 18px;
    }
    .card-title{ font-size: 20px; font-weight: 800; margin: 2px 0 16px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ flex-wrap:wrap; }
      .brand .title{ font-size: 20px; }
    }

    label{ display:block; font-size: 13px; color: var(--muted); margin: 2px 0 8px; }
    .field{ position:relative; }
    select, input{
      width:100%;
      padding: 14px 14px;
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.14);
      outline: none;
      background: rgba(3, 8, 22, .55);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    select:disabled, input:disabled{ opacity:.55; cursor:not-allowed; }
    input::placeholder{ color: rgba(168,177,199,.55); }

    .chips{display:flex; gap: 12px; align-items:center; margin: 6px 0 2px; flex-wrap: wrap;}
    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
    }
    .chip small{ color: var(--muted2); font-weight: 800; font-size: 13px; }
    .dot{ width:10px; height:10px; border-radius:50%; background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.12); }
    .dot.good{ background: var(--accent); box-shadow: 0 0 0 4px rgba(34,197,94,.14); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 4px rgba(251,113,133,.14); }
    .dot.gray{ background: #94a3b8; box-shadow: 0 0 0 4px rgba(148,163,184,.12); }

    .statusline{
      margin-top: 12px;
      display:flex; gap:10px; align-items:center;
      color: var(--muted2); font-size: 12px;
    }
    .spinner{
      width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: var(--blue);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .err{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(248,113,113,.45);
      background: rgba(248,113,113,.08);
      color: #fecaca;
      display:none;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .toast{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,.28);
      background: rgba(34,197,94,.10);
      color: #bbf7d0;
      display:none;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .hint{ margin-top: 10px; color: var(--muted2); font-size: 12px; line-height: 1.45; }

    /* Map section (Tahap2-style) */
    .mapWrap{
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      position:relative;
    }
    #map{height: 420px; width: 100%;}
    .crosshair{
      position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; z-index:1000;
    }
    .crosshair .reticle{
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%);
      width:34px; height:34px;
    }
    .crosshair .reticle::before{
      content:""; position:absolute; inset:0;
      border:2px solid rgba(229,231,235,.75);
      border-radius:50%;
      box-shadow:0 0 10px rgba(0,0,0,.55);
    }
    .crosshair .reticle .h,.crosshair .reticle .v{
      position:absolute; background:rgba(229,231,235,.65);
      box-shadow:0 0 8px rgba(0,0,0,.45);
    }
    .crosshair .reticle .h{ width:16px; height:2px; left:50%; top:50%; transform:translate(-50%,-50%); }
    .crosshair .reticle .v{ width:2px; height:16px; left:50%; top:50%; transform:translate(-50%,-50%); }

    .mapBar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    .btn2{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      background: rgba(255,255,255,.04);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn2.primary{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.32), rgba(34,197,94,.12));
    }
    .btn2:hover{ filter: brightness(1.06); }
    .btn2:disabled{ opacity:.6; cursor:not-allowed; }
    .coordHint{ color: rgba(168,177,199,.9); font-size: 12px; font-weight:700; }

    .coordRow{
      display:grid; grid-template-columns: 1fr 1fr; gap: 12px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.08);
    }
    @media (max-width: 900px){
      .coordRow{ grid-template-columns: 1fr; }
    }

    /* Leaflet tweaks */
    .leaflet-control-zoom a{
      background: rgba(0,0,0,.45) !important;
      color: var(--text) !important;
      border-color: rgba(255,255,255,.14) !important;
    }
    .leaflet-control-attribution{
      background: rgba(0,0,0,.25) !important;
      color: rgba(255,255,255,.75) !important;
      border-radius: 10px;
      padding: 2px 8px !important;
      border: 1px solid rgba(255,255,255,.12);
      margin: 8px !important;
    }

    /* History / Upload */
    .sectionCard{
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .sectionHdr{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      font-weight: 900;
    }
    .sectionBody{ padding: 12px 14px; }

    .gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 12px;
    }
    .phCard{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    .phTop{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; gap:10px;
      color: rgba(229,231,235,.92);
      font-weight: 900;
      font-size: 13px;
    }
    .phTop small{ color: rgba(168,177,199,.85); font-weight: 800; }
    .phImg{
      width:100%; height: 160px; object-fit: cover; display:block;
      background: rgba(255,255,255,.02);
    }
    .phBottom{
      padding: 10px 12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color: rgba(168,177,199,.9);
      font-size: 12px;
      font-weight: 700;
    }
    .phBottom a{ color: #93c5fd; text-decoration:none; font-weight:900; }
    .phBottom a:hover{ text-decoration:underline; }

    .stageBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px; }
    .stageBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition:.15s ease;
    }
    .stageBtn.primary{
      border-color: rgba(34,197,94,.40);
      background: linear-gradient(180deg, rgba(34,197,94,.32), rgba(34,197,94,.12));
    }
    .stageBtn:disabled{ opacity:.5; cursor:not-allowed; }

    .uploadRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .uploadRow input[type=file]{ display:none; }

    .btnSend{
      appearance:none;
      border:0;
      background: var(--accent);
      color: #01250f;
      padding: 12px 18px;
      border-radius: 14px;
      font-weight: 1000;
      cursor:pointer;
    }
    .btnGhost{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 18px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .btnSend:disabled{ opacity:.55; cursor:not-allowed; }

    /* Info Proyek */
    .collapseBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      background: rgba(255,255,255,.04);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition:.15s ease;
      font-size: 12px;
    }
    .infoGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .infoGrid{ grid-template-columns: 1fr; }
    }
    .kv{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.10);
    }
    .kv .k{ color: rgba(168,177,199,.9); font-size: 12px; font-weight: 900; margin-bottom: 4px; }
    .kv .v{ color: rgba(229,231,235,.95); font-size: 13px; font-weight: 800; }

    /* Upload overlay */
    #uploadOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(2,6,23,.65); backdrop-filter:blur(3px); z-index:9999;
    }
    #uploadOverlay .box{
      background:#0b1222; border:1px solid #263142; border-radius:16px;
      padding:18px 22px; min-width:300px; max-width:92vw;
    }
    #uploadOverlay .title{ font-weight:900; margin-bottom:6px; }
    #uploadOverlay .barWrap{
      height:10px; border:1px solid #263142; border-radius:999px; overflow:hidden;
      margin-top:10px; background:#0b1222;
    }
    #uploadOverlay .bar{
      height:100%; width:0%;
      background:linear-gradient(90deg,#22c55e,#86efac);
    }
    #uploadOverlay .hint{ font-size:12px; color:#a1a1aa; margin-top:8px; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">Form Tahap 3</div>
      <div class="sub">INPRES 2/2025 ¬∑ Pelaksanaan Tahap 3</div>
    </div>
    <a class="btn" id="btnHome" href="https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html">Beranda</a>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="card-inner">
        <div class="card-title">Data Survey</div>

        <div class="grid">
          <div class="field">
            <label for="bws">B/BWS</label>
            <select id="bws" title="Pilih B/BWS" aria-label="Pilih B/BWS">
              <option value="">-- pilih B/BWS --</option>
            </select>
          </div>

          <div class="field">
            <label for="prov">Provinsi</label>
            <select id="prov" title="Pilih Provinsi" aria-label="Pilih Provinsi" disabled>
              <option value="">-- pilih Provinsi --</option>
            </select>
          </div>

          <div class="field">
            <label for="kab">Kabupaten/Kota</label>
            <select id="kab" title="Pilih Kabupaten/Kota" aria-label="Pilih Kabupaten/Kota" disabled>
              <option value="">-- pilih Kabupaten/Kota --</option>
            </select>
          </div>

          <div class="field">
            <label for="di">Daerah Irigasi (DI)</label>
            <select id="di" title="Pilih Daerah Irigasi" aria-label="Pilih Daerah Irigasi" disabled>
              <option value="">-- pilih Daerah Irigasi --</option>
            </select>
          </div>
        </div>

        <div class="chips" style="margin-top:14px">
          <div class="chip">
            <span class="dot good" id="dotProg"></span>
            Progres terakhir: <span id="progVal">0%</span>
          </div>
          <div class="chip">
            <span class="dot gray" id="dotKoord"></span>
            Koordinat: <small id="koordVal">-</small>
          </div>
        </div>

        <div class="grid" style="margin-top:14px">
          <div class="field">
            <label for="kec">Kecamatan</label>
            <input id="kec" placeholder="(otomatis/isi manual)" title="Kecamatan" aria-label="Kecamatan"/>
          </div>
          <div class="field">
            <label for="desa">Desa/Kelurahan</label>
            <input id="desa" placeholder="(otomatis/isi manual)" title="Desa/Kelurahan" aria-label="Desa/Kelurahan"/>
          </div>
        </div>

        <!-- Informasi Proyek -->
        <div class="sectionCard" id="infoCard" style="margin-top:16px">
          <div class="sectionHdr">
            <div>Informasi Paket</div>
            <button class="collapseBtn" id="btnInfoToggle" type="button">Ciutkan</button>
          </div>
          <div class="sectionBody" id="infoBody">
            <div class="hint" id="infoHint">Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.</div>
            <div class="infoGrid" id="infoGrid" style="display:none"></div>
          </div>
        </div>

        <!-- MAP -->
        <div class="mapWrap">
          <div id="map"></div>
          <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>

          <div class="mapBar">
            <button class="btn2" id="btnLocate" type="button">üìç Lokasi saya</button>
            <button class="btn2 primary" id="btnPick" type="button">‚úÖ Pilih lokasi (ambil dari tanda +)</button>
            <button class="btn2" id="btnPan" type="button">üß≠ Pan ke koordinat</button>
            <span class="coordHint" id="coordsTxt">Lat: -, Lng: -</span>
          </div>

          <div class="coordRow">
            <div class="field">
              <label for="lat">Latitude</label>
              <input id="lat" inputmode="decimal" placeholder="Klik 'Pilih lokasi' atau isi manual" title="Latitude" aria-label="Latitude"/>
            </div>
            <div class="field">
              <label for="lng">Longitude</label>
              <input id="lng" inputmode="decimal" placeholder="Longitude" title="Longitude" aria-label="Longitude"/>
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="sectionCard" id="historyCard">
          <div class="sectionHdr">Riwayat Foto Progres</div>
          <div class="sectionBody" id="historyBody">
            <div class="hint" id="historyHint">Belum ada foto progres untuk kombinasi terpilih.</div>
            <div class="gallery" id="historyGrid" style="display:none"></div>
          </div>
        </div>

        <!-- Upload -->
        <div class="sectionCard">
          <div class="sectionHdr">Upload Foto Progres</div>
          <div class="sectionBody">
            <div class="stageBtns" id="stageBtns"></div>

            <div class="uploadRow">
              <button class="btn2" id="btnCamera" type="button">üì∑ Kamera</button>
              <button class="btn2" id="btnGallery" type="button">üñºÔ∏è Galeri</button>
              <span class="hint" id="photoMeta"></span>
              <input type="file" accept="image/*" id="fileInput">
            </div>
            <div class="hint">Foto dikompresi otomatis. Timestamp juga ditempel di foto sebelum dikirim.</div>

            <div class="grid" style="margin-top:14px">
              <div class="field">
                <label for="nama">Nama Pengirim</label>
                <input id="nama" placeholder="Nama lengkap" title="Nama Pengirim" aria-label="Nama Pengirim"/>
              </div>
              <div class="field">
                <label for="telepon">Nomor WA/HP</label>
                <input id="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxxxx" pattern="[0-9+]{8,15}" title="Nomor WA/HP" aria-label="Nomor WA/HP"/>
              </div>
            </div>

            <div class="uploadRow" style="margin-top:14px">
              <button class="btnSend" id="btnSubmit" type="button" disabled>Kirim</button>
              <button class="btnGhost" id="btnReset" type="button">Reset</button>
            </div>

            <div class="toast" id="toast"></div>
            <div class="err" id="errBox"></div>

            <div class="statusline" id="statusline">
              <span class="spinner" id="spin"></span>
              <span id="statusText">Mengambil data‚Ä¶</span>
            </div>
          </div>
        </div>

        <div class="hint">
          GPS hanya jalan kalau dibuka via HTTPS (GitHub Pages aman). Koordinat DI bisa terkunci otomatis kalau sudah ada upload sebelumnya.
        </div>

      </div>
    </section>
  </main>

  <!-- Overlay Upload -->
  <div id="uploadOverlay">
    <div class="box" role="alert" aria-live="assertive">
      <div class="title" id="uploadTitle">Mengunggah data‚Ä¶</div>
      <div class="barWrap"><div class="bar" id="progressBar"></div></div>
      <div class="hint" id="uploadHint">Jangan tutup halaman ini.</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= CONFIG ================= */
const DATA_URL = "https://gas-proxy3.tuic1677.workers.dev/?fn=baseline";
const HISTORY_URL = "https://gas-proxy3.tuic1677.workers.dev/?fn=history";
const ENDPOINT_POST = "https://gas-proxy3.tuic1677.workers.dev/"; // POST ke worker (proxy -> GAS)
/* ========================================= */

const $ = (id) => document.getElementById(id);
const toastEl = $("toast");
const errBox = $("errBox");
const statusLine = $("statusline");
const statusText = $("statusText");
const spin = $("spin");

function showToast(msg){
  toastEl.style.display = "block";
  toastEl.textContent = msg;
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> toastEl.style.display="none", 4200);
}
function showError(msg){
  errBox.style.display = "block";
  errBox.textContent = msg;
}
function hideError(){
  errBox.style.display = "none";
  errBox.textContent = "";
}
function setStatus(msg, loading=true){
  statusText.textContent = msg;
  spin.style.display = loading ? "inline-block" : "none";
  statusLine.style.opacity = msg ? 1 : 0;
}
function disableAll(b){
  document.querySelectorAll("input,select,button").forEach(el=>{
    if(el.id === "btnHome") return;
    el.disabled = !!b;
  });
}

/* ===== Utils data ===== */
const norm = (s)=> String(s ?? "").trim();
const uniq = (arr)=> Array.from(new Set(arr));
const byAlpha = (a,b)=> norm(a).localeCompare(norm(b),"id");

function pickVal(row, keys){
  for(const k of keys){
    const v = row?.[k];
    if(v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}
function titleCase(s){
  s = String(s||"").trim();
  if(!s) return "";
  return s.split(/(\s+|[-/])/).map(tok=>{
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok;
    const up = tok.toUpperCase();
    if (up==='BBWS'||up==='BWS') return up;
    if (/^(D\.?I\.?|DI)$/.test(up)) return 'D.I.';
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join('');
}

/* ===== DOM ===== */
const bwsSel  = $("bws");
const provSel = $("prov");
const kabSel  = $("kab");
const diSel   = $("di");
const kecInp  = $("kec");
const desaInp = $("desa");

const progVal = $("progVal");
const dotKoord = $("dotKoord");
const koordVal = $("koordVal");

const latInp = $("lat");
const lngInp = $("lng");
const coordsTxt = $("coordsTxt");
const btnLocate = $("btnLocate");
const btnPick = $("btnPick");
const btnPan = $("btnPan");

const historyHint = $("historyHint");
const historyGrid = $("historyGrid");

const stageBtnsWrap = $("stageBtns");
const btnCamera = $("btnCamera");
const btnGallery = $("btnGallery");
const fileInput = $("fileInput");
const photoMeta = $("photoMeta");

const namaInp = $("nama");
const teleponInp = $("telepon");
const btnSubmit = $("btnSubmit");
const btnReset = $("btnReset");

const infoHint = $("infoHint");
const infoGrid = $("infoGrid");
const btnInfoToggle = $("btnInfoToggle");
const infoBody = $("infoBody");

const overlay = $("uploadOverlay");
const bar = $("progressBar");
function setUploadingUI(show, percent){
  if(typeof percent === "number"){
    bar.style.width = Math.max(0,Math.min(100,Math.round(percent))) + "%";
  }
  overlay.style.display = show ? "flex" : "none";
}

/* ===== Map (Tahap2 style) ===== */
const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImg = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});

const map = L.map("map",{ zoomControl:true, layers:[baseOSM] });
L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5);

function updCenter(){
  const c = map.getCenter();
  coordsTxt.textContent = `Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;
}
map.on("move", updCenter);
map.whenReady(updCenter);

let pickedMarker = null;
const pickedIcon = L.icon({
  iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
  iconSize: [25,41],
  iconAnchor: [12,41],
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  shadowSize: [41,41]
});
function showPicked(lat,lng,{zoom=null}={}){
  if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;
  const ll = L.latLng(lat,lng);
  if(!pickedMarker) pickedMarker = L.marker(ll,{icon:pickedIcon}).addTo(map);
  else pickedMarker.setLatLng(ll);
  if(zoom!=null) map.setView(ll, zoom);
}

function isValidLatLng(lat,lng){
  return Number.isFinite(lat) && Number.isFinite(lng) && Math.abs(lat)<=90 && Math.abs(lng)<=180;
}

function setKoordChip(lat,lng){
  if(!isValidLatLng(lat,lng)){
    koordVal.textContent = "-";
    dotKoord.className = "dot gray";
    return;
  }
  koordVal.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  dotKoord.className = "dot good";
}

btnLocate.addEventListener("click", ()=>{
  map.locate({setView:true,maxZoom:17,enableHighAccuracy:true});
});
map.on("locationfound", (e)=>{
  latInp.value = e.latitude.toFixed(6);
  lngInp.value = e.longitude.toFixed(6);
  setKoordChip(e.latitude, e.longitude);
  showPicked(e.latitude, e.longitude, {zoom:17});
  updateSubmitState();
});
map.on("locationerror", ()=>{
  showToast("Izin lokasi ditolak. Geser peta manual ya.");
});

btnPick.addEventListener("click", ()=>{
  const c = map.getCenter();
  latInp.value = c.lat.toFixed(6);
  lngInp.value = c.lng.toFixed(6);
  setKoordChip(c.lat, c.lng);
  showPicked(c.lat, c.lng);
  updateSubmitState();
});

btnPan.addEventListener("click", ()=>{
  const la = parseFloat(latInp.value);
  const lo = parseFloat(lngInp.value);
  if(isValidLatLng(la,lo)){
    showPicked(la, lo, {zoom: Math.max(map.getZoom(), 16)});
  }
});

function tryUpdateFromInputs(){
  const la = parseFloat(String(latInp.value).replace(",","."));
  const lo = parseFloat(String(lngInp.value).replace(",","."));
  if(isValidLatLng(la,lo)){
    setKoordChip(la,lo);
    showPicked(la,lo);
  } else if(!latInp.value && !lngInp.value){
    setKoordChip(NaN,NaN);
  }
  updateSubmitState();
}
latInp.addEventListener("change", tryUpdateFromInputs);
lngInp.addEventListener("change", tryUpdateFromInputs);

/* ===== Data baseline + cascade ===== */
let RAW = [];
let INDEX = {};   // BWS -> Prov -> Kab -> [DI]
let ROWMAP = {};  // key(bws||prov||kab||di) -> row baseline

function resetSelect(sel, placeholder){
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  sel.value = "";
}
function fillSelect(sel, values, placeholder){
  resetSelect(sel, placeholder);
  values.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

function key4(bws,prov,kab,di){
  return [bws,prov,kab,di].map(s=>norm(s)).join("||").toLowerCase();
}

function buildIndex(){
  INDEX = {};
  ROWMAP = {};
  RAW.forEach(r=>{
    const bws = titleCase(pickVal(r, ["B/BWS","B/BWS PELAKSANA","balai","Balai","BWS","BBWS"]));
    const prov = titleCase(pickVal(r, ["PROVINSI","Provinsi","provinsi"]));
    const kab  = titleCase(pickVal(r, ["KABUPATEN","Kabupaten","Kab/Kota","kabupaten"]));
    const di   = titleCase(pickVal(r, ["NAMA DI/DIR","Nama DI","DI","di","Paket","NAMA DI"]));
    if(!bws || !prov || !kab || !di) return;

    INDEX[bws] ??= {};
    INDEX[bws][prov] ??= {};
    INDEX[bws][prov][kab] ??= [];
    if(!INDEX[bws][prov][kab].includes(di)) INDEX[bws][prov][kab].push(di);

    // simpan row pertama untuk kombinasi
    const k = key4(bws,prov,kab,di);
    if(!ROWMAP[k]) ROWMAP[k] = r;
  });

  // sort DI list
  Object.keys(INDEX).forEach(b=>{
    Object.keys(INDEX[b]).forEach(p=>{
      Object.keys(INDEX[b][p]).forEach(k=>{
        INDEX[b][p][k] = INDEX[b][p][k].sort(byAlpha);
      });
    });
  });
}

function setProgressFromSelection(){
  let p = 0;
  if (bwsSel.value) p += 25;
  if (provSel.value) p += 25;
  if (kabSel.value) p += 25;
  if (diSel.value)  p += 25;
  progVal.textContent = p + "%";
}

function setInfoFromRow(row){
  // tampilkan semua kolom kecuali yang mengandung "Total Alokasi Usulan"
  infoGrid.innerHTML = "";
  if(!row){
    infoHint.style.display = "block";
    infoGrid.style.display = "none";
    infoHint.textContent = "Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.";
    return;
  }

  const entries = Object.entries(row || {})
    .filter(([k,v]) => {
      const kk = String(k||"").trim();
      if(!kk) return false;
      if(/total\s*alokasi\s*usulan/i.test(kk)) return false;
      const vv = String(v ?? "").trim();
      return vv !== "";
    });

  if(!entries.length){
    infoHint.style.display = "block";
    infoGrid.style.display = "none";
    infoHint.textContent = "Detail paket tidak ditemukan di baseline.";
    return;
  }

  infoHint.style.display = "none";
  infoGrid.style.display = "grid";

  entries.forEach(([k,v])=>{
    const box = document.createElement("div");
    box.className = "kv";
    box.innerHTML = `<div class="k">${k}</div><div class="v">${String(v)}</div>`;
    infoGrid.appendChild(box);
  });
}

let infoCollapsed = false;
btnInfoToggle.addEventListener("click", ()=>{
  infoCollapsed = !infoCollapsed;
  infoBody.style.display = infoCollapsed ? "none" : "block";
  btnInfoToggle.textContent = infoCollapsed ? "Buka" : "Ciutkan";
});

async function loadBaseline(){
  hideError();
  setStatus("Mengambil data‚Ä¶", true);
  try{
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const json = await res.json();
    if(!json || json.ok !== true || !Array.isArray(json.items)){
      throw new Error("Format JSON tidak sesuai. Butuh { ok:true, items:[...] }");
    }

    RAW = json.items || [];
    buildIndex();

    const bwsList = Object.keys(INDEX).sort(byAlpha);
    fillSelect(bwsSel, bwsList, "-- pilih B/BWS --");

    resetSelect(provSel, "-- pilih Provinsi --"); provSel.disabled = true;
    resetSelect(kabSel, "-- pilih Kabupaten/Kota --"); kabSel.disabled = true;
    resetSelect(diSel,  "-- pilih Daerah Irigasi --"); diSel.disabled = true;

    setProgressFromSelection();
    setKoordChip(NaN,NaN);
    setInfoFromRow(null);
    renderStageButtons(0, 25);
    renderHistory(null);

    setStatus("Data siap ‚úÖ  Pilih B/BWS untuk mulai.", false);

  }catch(err){
    console.error(err);
    setStatus("Gagal mengambil data", false);
    showError(String(err.message || err));
  }
}

bwsSel.addEventListener("change", ()=>{
  setProgressFromSelection();
  resetSelect(provSel, "-- pilih Provinsi --"); provSel.disabled = true;
  resetSelect(kabSel, "-- pilih Kabupaten/Kota --"); kabSel.disabled = true;
  resetSelect(diSel,  "-- pilih Daerah Irigasi --"); diSel.disabled = true;
  setInfoFromRow(null);
  renderStageButtons(0, null);
  renderHistory(null);

  const bws = bwsSel.value;
  if(!bws) return;

  const provs = Object.keys(INDEX[bws]||{}).sort(byAlpha);
  fillSelect(provSel, provs, "-- pilih Provinsi --");
  provSel.disabled = false;
  updateSubmitState();
});

provSel.addEventListener("change", ()=>{
  setProgressFromSelection();
  resetSelect(kabSel, "-- pilih Kabupaten/Kota --"); kabSel.disabled = true;
  resetSelect(diSel,  "-- pilih Daerah Irigasi --"); diSel.disabled = true;
  setInfoFromRow(null);
  renderStageButtons(0, null);
  renderHistory(null);

  const bws = bwsSel.value;
  const prov = provSel.value;
  if(!bws || !prov) return;

  const kabs = Object.keys((INDEX[bws]||{})[prov]||{}).sort(byAlpha);
  fillSelect(kabSel, kabs, "-- pilih Kabupaten/Kota --");
  kabSel.disabled = false;
  updateSubmitState();
});

kabSel.addEventListener("change", ()=>{
  setProgressFromSelection();
  resetSelect(diSel,  "-- pilih Daerah Irigasi --"); diSel.disabled = true;
  setInfoFromRow(null);
  renderStageButtons(0, null);
  renderHistory(null);

  const bws = bwsSel.value;
  const prov = provSel.value;
  const kab = kabSel.value;
  if(!bws || !prov || !kab) return;

  const dis = ((INDEX[bws]||{})[prov]||{})[kab] || [];
  fillSelect(diSel, dis, "-- pilih Daerah Irigasi --");
  diSel.disabled = false;
  updateSubmitState();
});

/* ===== History + lock coords + stage ===== */
let currentStage = null;
let lockedCoords = false;
let selectedFile = null;

function setCoordLock(lock, la, lo){
  lockedCoords = !!lock;
  if(lock){
    if(isValidLatLng(la,lo)){
      latInp.value = Number(la).toFixed(6);
      lngInp.value = Number(lo).toFixed(6);
      setKoordChip(Number(la), Number(lo));
      showPicked(Number(la), Number(lo), {zoom:17});
      map.setView([Number(la), Number(lo)], 17);
    }
    latInp.disabled = true;
    lngInp.disabled = true;
    btnPick.disabled = true;
    btnPan.disabled = true;
    btnLocate.disabled = true;
  } else {
    latInp.disabled = false;
    lngInp.disabled = false;
    btnPick.disabled = false;
    btnPan.disabled = false;
    btnLocate.disabled = false;
  }
}

function renderHistory(hist){
  if(!hist || !hist.photos){
    historyHint.style.display = "block";
    historyGrid.style.display = "none";
    historyHint.textContent = "Belum ada foto progres untuk kombinasi terpilih.";
    historyGrid.innerHTML = "";
    return;
  }
  const photos = hist.photos || {};
  const order = [25,50,75,100];
  const cards = [];

  order.forEach(st=>{
    const p = photos[String(st)];
    if(!p || !p.url) return;
    cards.push({stage:st, ...p});
  });

  if(!cards.length){
    historyHint.style.display = "block";
    historyGrid.style.display = "none";
    historyHint.textContent = "Belum ada foto progres untuk kombinasi terpilih.";
    historyGrid.innerHTML = "";
    return;
  }

  historyHint.style.display = "none";
  historyGrid.style.display = "grid";
  historyGrid.innerHTML = "";

  cards.forEach(c=>{
    const wrap = document.createElement("div");
    wrap.className = "phCard";
    const open = c.open || c.url;
    const ts = c.ts ? ` ‚Ä¢ ${c.ts}` : "";
    wrap.innerHTML = `
      <div class="phTop">
        <div>Foto Progres ${c.stage}%</div>
        <small>${ts ? ts.replace(" ‚Ä¢ ","") : ""}</small>
      </div>
      <a href="${open}" target="_blank" rel="noopener">
        <img class="phImg" src="${c.url}" alt="Progres ${c.stage}%">
      </a>
      <div class="phBottom">
        <div>${c.name ? c.name : ""}</div>
        <a href="${open}" target="_blank" rel="noopener">Buka</a>
      </div>
    `;
    historyGrid.appendChild(wrap);
  });
}

function renderStageButtons(maxStage, nextStage){
  stageBtnsWrap.innerHTML = "";
  const stages = [25,50,75,100];

  stages.forEach(st=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "stageBtn";
    btn.textContent = `Progres ${st}%`;

    const enabled = (nextStage !== null && st === nextStage);
    btn.disabled = !enabled;
    btn.classList.toggle("primary", enabled);

    btn.addEventListener("click", ()=>{
      currentStage = st;
      showToast(`Stage dipilih: ${st}%`);
      updateSubmitState();
    });

    stageBtnsWrap.appendChild(btn);
  });

  currentStage = nextStage;
  updateSubmitState();
}

async function fetchHistory(bws, prov, kab, di){
  const qs = new URLSearchParams({bws, prov, kab, di});
  const url = HISTORY_URL + "&" + qs.toString() + "&t=" + Date.now();
  const res = await fetch(url, { cache: "no-store" });
  const j = await res.json().catch(()=>null);
  if(j && j.ok) return j;
  return {ok:false, maxStage:0, nextStage:25, coords:null, photos:{}};
}

diSel.addEventListener("change", async ()=>{
  setProgressFromSelection();
  const bws = bwsSel.value;
  const prov = provSel.value;
  const kab = kabSel.value;
  const di = diSel.value;

  setInfoFromRow(null);
  renderStageButtons(0, null);
  renderHistory(null);

  if(!bws || !prov || !kab || !di){
    updateSubmitState();
    return;
  }

  // baseline row detail + auto fill kec/desa if available
  const row = ROWMAP[key4(bws,prov,kab,di)];
  setInfoFromRow(row);

  const kec = titleCase(pickVal(row, ["KECAMATAN","Kecamatan","kecamatan","Kec"]));
  const desa = titleCase(pickVal(row, ["DESA","Desa","desa","Desa/Kelurahan","Kel"]));
  if(kec) kecInp.value = kec;
  if(desa) desaInp.value = desa;

  // history for stage + coords lock
  setStatus("Memuat riwayat‚Ä¶", true);
  const hist = await fetchHistory(bws,prov,kab,di);
  renderHistory(hist);
  const maxStage = hist.maxStage || 0;
  const nextStage = (hist.nextStage === undefined) ? (maxStage===0 ? 25 : (maxStage+25)) : hist.nextStage;
  renderStageButtons(maxStage, nextStage);

  if(hist.coords && isValidLatLng(hist.coords.lat, hist.coords.lng)){
    setCoordLock(true, hist.coords.lat, hist.coords.lng);
  } else {
    setCoordLock(false);
  }

  setStatus("Siap ‚úÖ", false);
  updateSubmitState();
});

/* ===== Upload (camera/galeri) + compress + timestamp overlay ===== */
btnCamera.addEventListener("click", ()=>{
  fileInput.setAttribute("capture","environment");
  fileInput.click();
});
btnGallery.addEventListener("click", ()=>{
  fileInput.removeAttribute("capture");
  fileInput.click();
});
fileInput.addEventListener("change", ()=>{
  selectedFile = fileInput.files?.[0] || null;
  photoMeta.textContent = selectedFile ? `Dipilih: ${selectedFile.name} ‚Ä¢ ${(selectedFile.size/1024).toFixed(1)} KB` : "";
  updateSubmitState();
});

async function compressToJpeg(file,{maxDim=2000,quality=0.82}={}){
  if(!(file && file.type && file.type.startsWith("image/"))) return file;
  const bmp = await createImageBitmap(file,{imageOrientation:"from-image"});
  const W=bmp.width,H=bmp.height;
  const s=Math.min(1, maxDim/Math.max(W,H));
  const w=Math.round(W*s), h=Math.round(H*s);
  const c=document.createElement("canvas"); c.width=w; c.height=h;
  const ctx=c.getContext("2d");
  ctx.drawImage(bmp,0,0,w,h);
  const blob = await new Promise(res=>c.toBlob(res,"image/jpeg",quality));
  const name = (file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'') || 'foto') + ".jpg";
  return new File([blob], name, {type:"image/jpeg"});
}

function fmtStamp(d=new Date()){
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

async function overlayTimestampToDataURL(file, text){
  const bmp = await createImageBitmap(file,{imageOrientation:"from-image"});
  const W=bmp.width,H=bmp.height;

  const c=document.createElement("canvas");
  c.width=W; c.height=H;
  const ctx=c.getContext("2d");
  ctx.drawImage(bmp,0,0,W,H);

  // style overlay
  const margin = Math.round(Math.min(W,H)*0.03);
  const fontSize = Math.max(22, Math.round(Math.min(W,H)*0.03));
  ctx.font = `800 ${fontSize}px Inter, system-ui, Arial`;
  ctx.textBaseline = "bottom";

  const pad = Math.round(fontSize*0.55);
  const textW = Math.ceil(ctx.measureText(text).width);
  const boxW = textW + pad*2;
  const boxH = fontSize + pad*1.4;

  const x = margin;
  const y = H - margin;

  // shadow box
  ctx.fillStyle = "rgba(0,0,0,0.55)";
  roundRect(ctx, x, y-boxH, boxW, boxH, Math.round(fontSize*0.4), true, false);

  // accent strip
  ctx.fillStyle = "rgba(34,197,94,0.85)";
  roundRect(ctx, x, y-boxH, Math.round(fontSize*0.35), boxH, Math.round(fontSize*0.25), true, false);

  // text
  ctx.fillStyle = "rgba(255,255,255,0.95)";
  ctx.fillText(text, x + pad, y - Math.round(pad*0.45));

  // export
  return c.toDataURL("image/jpeg", 0.92);
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  if(w<2*r) r=w/2;
  if(h<2*r) r=h/2;
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* ===== Submit ===== */
function missingList(){
  const m=[];
  if(!bwsSel.value) m.push("B/BWS");
  if(!provSel.value) m.push("Provinsi");
  if(!kabSel.value) m.push("Kab/Kota");
  if(!diSel.value) m.push("DI");
  if(!kecInp.value) m.push("Kecamatan");
  if(!desaInp.value) m.push("Desa/Kelurahan");
  if(!latInp.value || !lngInp.value) m.push("Koordinat");
  if(!namaInp.value) m.push("Nama");
  if(!teleponInp.value) m.push("Nomor WA/HP");
  if(!currentStage) m.push("Stage Progres");
  if(!selectedFile) m.push("Foto");
  return m;
}
function updateSubmitState(){
  const ok = missingList().length === 0;
  btnSubmit.disabled = !ok;
}
document.addEventListener("input", (e)=>{
  if(["kec","desa","nama","telepon","lat","lng"].includes(e.target?.id)) updateSubmitState();
});
document.addEventListener("change", (e)=>{
  if(["bws","prov","kab","di","fileInput","lat","lng"].includes(e.target?.id)) updateSubmitState();
});

btnSubmit.addEventListener("click", async ()=>{
  hideError();
  const miss = missingList();
  if(miss.length){
    showToast("‚ö†Ô∏è Harus diisi dulu: " + miss.join(", "));
    updateSubmitState();
    return;
  }

  const bws = bwsSel.value;
  const prov = provSel.value;
  const kab = kabSel.value;
  const di = diSel.value;

  const la = parseFloat(String(latInp.value).replace(",","."));
  const lo = parseFloat(String(lngInp.value).replace(",","."));
  if(!isValidLatLng(la,lo)){
    showToast("‚ö†Ô∏è Koordinat tidak valid.");
    return;
  }

  try{
    disableAll(true);
    setUploadingUI(true, 6);
    setStatus("Mengunggah‚Ä¶", true);

    // compress
    const comp = await compressToJpeg(selectedFile,{maxDim:2000,quality:0.82});
    setUploadingUI(true, 20);

    // overlay timestamp + identitas singkat
    const stamp = fmtStamp(new Date());
    const overlayText = `${stamp} | ${di} | ${currentStage}%`;
    const dataUrl = await overlayTimestampToDataURL(comp, overlayText);
    setUploadingUI(true, 55);

    // make form data
    const fd = new FormData();
    fd.set("balai", bws);
    fd.set("provinsi", prov);
    fd.set("kabupaten", kab);
    fd.set("di", di);
    fd.set("kecamatan", kecInp.value);
    fd.set("desa", desaInp.value);
    fd.set("lat", String(la));
    fd.set("lng", String(lo));
    fd.set("nama", namaInp.value);
    fd.set("telepon", teleponInp.value);
    fd.set("progress_stage", String(currentStage));

    // send photo as b64 + name/type
    const safeDi = (di || "DI").replace(/[^\w\-]+/g,"_");
    const fileName = `${safeDi}_${currentStage}.jpg`;
    fd.set("foto_b64", dataUrl);
    fd.set("foto_name", fileName);
    fd.set("foto_type", "image/jpeg");

    // xhr with progress
    const xhr = new XMLHttpRequest();
    xhr.open("POST", ENDPOINT_POST, true);

    xhr.upload.onprogress = (ev)=>{
      if(ev.lengthComputable){
        const p = (ev.loaded/ev.total)*100;
        setUploadingUI(true, Math.max(55, Math.min(95, p)));
      }
    };
    xhr.onerror = ()=>{
      setUploadingUI(false);
      disableAll(false);
      setStatus("Gagal upload", false);
      showError("Gagal kirim (jaringan/proxy).");
    };
    xhr.onload = async ()=>{
      let data = {};
      try{ data = JSON.parse(xhr.responseText || "{}"); }catch(e){}
      if(xhr.status>=200 && xhr.status<300 && data && data.ok){
        setUploadingUI(true, 100);
        showToast("‚úÖ Terkirim!");
        // refresh history
        const hist = await fetchHistory(bws,prov,kab,di);
        renderHistory(hist);

        // stage buttons update
        const maxStage = hist.maxStage || 0;
        const nextStage = hist.nextStage ?? (maxStage===0?25:(maxStage+25));
        renderStageButtons(maxStage, nextStage);

        // lock coords if returned
        if(hist.coords && isValidLatLng(hist.coords.lat, hist.coords.lng)){
          setCoordLock(true, hist.coords.lat, hist.coords.lng);
        }

        // clear file selection
        selectedFile = null;
        fileInput.value = "";
        photoMeta.textContent = "";
        updateSubmitState();

        setTimeout(()=> setUploadingUI(false), 600);
        setStatus("Selesai ‚úÖ", false);
      } else {
        setUploadingUI(false);
        setStatus("Gagal upload", false);
        disableAll(false);
        showError("Gagal kirim (server). " + (data?.error || ""));
      }
      disableAll(false);
      updateSubmitState();
    };

    xhr.send(fd);

  }catch(err){
    console.error(err);
    setUploadingUI(false);
    disableAll(false);
    setStatus("Gagal upload", false);
    showError(String(err.message || err));
  }
});

btnReset.addEventListener("click", ()=>{
  selectedFile = null;
  fileInput.value = "";
  photoMeta.textContent = "";
  hideError();
  showToast("Reset ‚úÖ");

  resetSelect(provSel, "-- pilih Provinsi --"); provSel.disabled = true;
  resetSelect(kabSel, "-- pilih Kabupaten/Kota --"); kabSel.disabled = true;
  resetSelect(diSel, "-- pilih Daerah Irigasi --"); diSel.disabled = true;
  bwsSel.value = "";

  kecInp.value = "";
  desaInp.value = "";
  latInp.value = "";
  lngInp.value = "";
  setKoordChip(NaN,NaN);
  setCoordLock(false);

  if(pickedMarker){ map.removeLayer(pickedMarker); pickedMarker = null; }

  setInfoFromRow(null);
  renderHistory(null);
  renderStageButtons(0, null);

  setProgressFromSelection();
  updateSubmitState();
});

/* boot */
setProgressFromSelection();
renderStageButtons(0, null);
renderHistory(null);
setInfoFromRow(null);
loadBaseline();
updateSubmitState();
</script>

</body>
</html>
