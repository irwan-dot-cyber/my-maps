<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Tahap 3 ‚Äî INPRES 2/2025</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1224;
      --panel:#0f172a;
      --panel2:#0b1224;
      --border:rgba(255,255,255,.12);
      --mut:#9aa3b2;
      --text:#e5e7eb;
      --accent:#22c55e;
      --warn:#f59e0b;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:16px;
      --r2:12px;
      --hdrH:64px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 520px at 20% -10%, rgba(34,197,94,.14), transparent 60%),
                  radial-gradient(900px 520px at 90% 0%, rgba(245,158,11,.10), transparent 60%),
                  linear-gradient(180deg,#060a16, var(--bg));
      color:var(--text);
      min-height:100vh;
    }

    header{
      height:var(--hdrH);
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px;
      background:rgba(6,10,22,.78);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .hdr-left{display:flex; flex-direction:column; gap:4px}
    .hdr-left strong{font-size:20px; letter-spacing:.2px}
    .hdr-left .sub{font-size:12px; color:var(--mut)}
    .btn-home{
      text-decoration:none;
      color:var(--text);
      font-weight:800;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      padding:10px 14px;
      border-radius:999px;
      white-space:nowrap;
    }
    .btn-home:hover{filter:brightness(1.06)}

    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{
      background:rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:16px;
    }
    form{padding:12px 14px; display:grid; gap:12px}

    label{font-size:12px; color:var(--mut); display:block; margin:0 0 8px}
    select,input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,36,.80);
      color:var(--text);
      outline:none;
    }
    select:disabled,input:disabled{opacity:.6; cursor:not-allowed}
    input::placeholder{color:rgba(154,163,178,.7)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{
      cursor:pointer;
      border:0;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
    }
    .primary{background:var(--accent); color:#032010}
    .ghost{background:rgba(255,255,255,.04); color:var(--text); border:1px solid rgba(255,255,255,.14)}
    .hint{font-size:12px; color:var(--mut)}
    .muted{opacity:.75}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:12px;
      font-weight:800;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.green{background:#22c55e}
    .dot.orange{background:#f59e0b}
    .dot.gray{background:#94a3b8}

    /* Map */
    .mapwrap{position:relative}
    #map{height:52vh; min-height:320px; border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10)}
    .crosshair{position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; z-index:500}
    .crosshair .reticle{width:28px;height:28px; position:relative}
    .crosshair .reticle:before{content:""; position:absolute; inset:0; border:2px solid rgba(229,231,235,.72); border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,.55)}
    .crosshair .h,.crosshair .v{position:absolute; background:rgba(229,231,235,.65); box-shadow:0 0 8px rgba(0,0,0,.55)}
    .crosshair .h{width:14px;height:2px; left:50%; top:50%; transform:translate(-50%,-50%)}
    .crosshair .v{width:2px;height:14px; left:50%; top:50%; transform:translate(-50%,-50%)}

    .leaflet-control-layers{
      border-radius:12px !important;
      border:1px solid rgba(0,0,0,.25) !important;
      overflow:hidden;
    }
    .leaflet-control-layers, .leaflet-control-zoom a{
      background:rgba(2,6,23,.62) !important;
      color:var(--text) !important;
      border-color:rgba(255,255,255,.14) !important;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .leaflet-control-attribution{
      background:rgba(2,6,23,.45) !important;
      color:rgba(255,255,255,.75) !important;
      border-radius:10px;
      padding:2px 8px !important;
      border:1px solid rgba(255,255,255,.12);
      margin:8px !important;
    }

    /* History cards (tanpa gambar) */
    .hist-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px}
    .hist-card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(11,18,36,.70);
      overflow:hidden;
    }
    .hist-card .hdr{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      font-size:12px; font-weight:800;
    }
    .thumb{
      height:120px;
      display:grid; place-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:radial-gradient(500px 220px at 30% 0%, rgba(34,197,94,.10), transparent 70%),
                 radial-gradient(500px 220px at 80% 30%, rgba(245,158,11,.08), transparent 70%);
    }
    .hist-card .body{padding:10px 12px; display:grid; gap:8px}
    .openlink{color:#60a5fa; font-weight:800; text-decoration:none}
    .openlink:hover{text-decoration:underline}

    /* Project info (ciutkan) */
    details.proj{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(11,18,36,.65);
      overflow:hidden;
    }
    details.proj summary{
      cursor:pointer;
      list-style:none;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:800;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    details.proj summary::-webkit-details-marker{display:none}
    .proj-body{padding:12px 14px}
    .proj-grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .kv{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
    }
    .kv .k{font-size:12px; color:var(--mut); margin-bottom:6px}
    .kv .v{font-size:13px; font-weight:800}
    @media (max-width:820px){
      .row{grid-template-columns:1fr}
      #map{height:42vh; min-height:280px}
      .proj-grid{grid-template-columns:1fr}
    }

    /* Toast */
    .toast{margin:10px 14px;padding:10px 12px;border-radius:12px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    .toast.bad{background:rgba(220,38,38,.12); border-color:rgba(248,113,113,.45); color:#fecaca}

    /* Upload overlay */
    #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px);z-index:9999}
    #uploadOverlay .box{background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
    #uploadOverlay .title{font-weight:900;margin-bottom:6px}
    #uploadOverlay .hint{color:#a1a1aa}
    #uploadOverlay .bar{height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
    #uploadOverlay .bar > div{height:100%;width:0%}
  </style>

</head>

<body>
<header>
  <div class="hdr-left">
    <strong>Form Tahap 3</strong>
    <span class="sub">INPRES 2/2025 ¬∑ Pelaksanaan Tahap 3</span>
  </div>
  <a class="btn-home" id="btnHome" href="#">Beranda</a>
</header>

<main>
  <div class="card">
    <h2>Data Survey</h2>
    <div id="toast" class="toast"></div>

```
<form id="surveyForm">
  <div class="row">
    <div>
      <label for="balai">B/BWS</label>
      <select id="balai" name="balai" required title="Pilih B/BWS"></select>
    </div>
    <div>
      <label for="prov">Provinsi</label>
      <select id="prov" name="provinsi" required disabled title="Pilih Provinsi"></select>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="kab">Kabupaten/Kota</label>
      <select id="kab" name="kabupaten" required disabled title="Pilih Kabupaten/Kota"></select>
    </div>
    <div>
      <label for="di">Daerah Irigasi (DI)</label>
      <select id="di" name="di" required disabled title="Pilih DI"></select>
    </div>
  </div>

  <div class="actions" style="margin-top:-2px">
    <span class="badge"><span class="dot green"></span>Progres terakhir: <b id="lastStage">0%</b></span>
    <span class="badge" id="coordBadge"><span class="dot gray"></span><span id="coordBadgeText">Koordinat: -</span></span>
  </div>

  <div class="row">
    <div>
      <label for="kecamatan">Kecamatan</label>
      <input id="kecamatan" name="kecamatan" placeholder="(otomatis/isi manual)" required title="Isi Kecamatan"/>
    </div>
    <div>
      <label for="desa">Desa/Kelurahan</label>
      <input id="desa" name="desa" placeholder="(otomatis/isi manual)" required title="Isi Desa/Kelurahan"/>
    </div>
  </div>

  <!-- Informasi Paket (ciutkan) -->
  <details class="proj" id="projBox" open>
    <summary>
      <span>Informasi Paket</span>
      <span class="badge" style="font-weight:900">Ciutkan</span>
    </summary>
    <div class="proj-body">
      <div class="hint muted" id="projHint">Pilih B/BWS, Provinsi, Kab/Kota, dan DI untuk melihat detail.</div>
      <div class="proj-grid" id="projGrid" style="margin-top:10px; display:none"></div>
    </div>
  </details>

  <!-- Map -->
  <div>
    <label>Peta Lokasi</label>
    <div class="mapwrap">
      <div id="map"></div>
      <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
    </div>
    <div class="actions" style="margin-top:10px">
      <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
      <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
      <button id="btnPan" type="button" class="ghost">üß≠ Pan ke koordinat</button>
      <span class="hint" id="coords">Lat: -, Lng: -</span>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="lat">Latitude</label>
      <input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required title="Latitude"/>
    </div>
    <div>
      <label for="lng">Longitude</label>
      <input type="number" step="0.000001" id="lng" name="lng" required title="Longitude"/>
    </div>
  </div>

  <!-- History -->
  <div class="card" style="border-radius:14px; background:rgba(11,18,36,.35); box-shadow:none">
    <h2 style="font-size:14px">Riwayat Foto Progres</h2>
    <div id="historyGals" style="padding:12px 14px">
      <div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>
    </div>
  </div>

  <!-- Upload -->
  <div class="card" style="border-radius:14px; background:rgba(11,18,36,.35); box-shadow:none">
    <h2 style="font-size:14px">Upload Foto Progres</h2>
    <div style="padding:12px 14px; display:grid; gap:10px">
      <div class="actions" id="stageBtns"></div>

      <div class="actions" style="gap:10px">
        <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
        <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
        <span id="photoMeta" class="hint"></span>
      </div>

      <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
      <div class="hint">Foto dikompresi otomatis & dikirim sebagai base64.</div>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="nama">Nama Pengirim</label>
      <input id="nama" name="nama" placeholder="Nama lengkap" required title="Nama Pengirim"/>
    </div>
    <div>
      <label for="telepon">Nomor WA/HP</label>
      <input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required title="Nomor WA/HP"/>
    </div>
  </div>

  <div class="actions">
    <button type="submit" class="primary" id="btnSubmit" disabled>Kirim</button>
    <button type="reset" class="ghost" id="btnReset">Reset</button>
  </div>

  <div class="hint muted">
    Catatan: Riwayat progres ditampilkan sebagai status (‚úÖ/‚¨ú) supaya stabil di semua HP (Drive sering blok hotlink gambar).
  </div>
</form>
```

  </div>
</main>

<!-- Overlay Upload -->

<div id="uploadOverlay">
  <div class="box" role="alert" aria-live="assertive">
    <div class="title" id="uploadTitle">Mengunggah data‚Ä¶</div>
    <div class="bar"><div id="progressBar" style="background:linear-gradient(90deg,#22c55e,#86efac)"></div></div>
    <div class="hint" id="uploadHint" style="margin-top:8px">Jangan tutup halaman ini.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ================= CONFIG =================
   DATA_URL: worker proxy untuk GET ke GAS (baseline & history)
   ENDPOINT: worker proxy untuk POST submit (boleh sama dengan DATA_URL kalau worker-mu forward POST juga)
*/
const DATA_URL = "https://gas-proxy3.tuic1677.workers.dev/";   // GET: ?fn=baseline / ?fn=history
const ENDPOINT = "https://gas-proxy3.tuic1677.workers.dev/";   // POST: submit (kalau beda, ganti)
const HOME_URL = "https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html";
/* ========================================= */

document.getElementById("btnHome").href = HOME_URL;

/* ===== Utils ===== */
const toastEl = document.getElementById("toast");
function toast(msg, bad=false){
  toastEl.textContent = msg;
  toastEl.classList.toggle("bad", !!bad);
  toastEl.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> toastEl.style.display="none", 4200);
}
function norm(s){ return String(s ?? "").trim(); }
function titleCase(s){
  return String(s||'').split(/(\s+|[-/])/).map(tok=>{
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok;
    const up = tok.toUpperCase();
    if (up==='BBWS'||up==='BWS') return up;
    if (/^(D\.?I\.?|DI)$/.test(up)) return 'D.I.';
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join('');
}
function fillSelect(el, items, ph){
  el.innerHTML = "";
  const o0 = document.createElement("option");
  o0.value=""; o0.textContent = ph || "-- pilih --";
  el.appendChild(o0);
  (items||[]).forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    el.appendChild(o);
  });
  el.disabled = !(items && items.length);
}
function disableForm(b){
  document.querySelectorAll("#surveyForm input, #surveyForm select, #surveyForm button").forEach(e=> e.disabled = !!b);
}
const $overlay = document.getElementById("uploadOverlay");
const $bar = document.getElementById("progressBar");
function setUploadingUI(show, percent){
  if(typeof percent === "number"){
    $bar.style.width = Math.max(0, Math.min(100, Math.round(percent))) + "%";
  }
  $overlay.style.display = show ? "flex" : "none";
}

/* ===== Map ===== */
const baseOSM = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:20, attribution:"¬© OpenStreetMap"});
const baseImg = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {maxZoom:20, attribution:"Tiles ¬© Esri/Maxar"});

const map = L.map("map", {zoomControl:true, layers:[baseOSM]});
L.control.layers({OSM:baseOSM, "Esri Imagery":baseImg}, {}, {position:"topright", collapsed:false}).addTo(map);
map.setView([-2.5, 118], 5);

const coordsTxt = document.getElementById("coords");
function updCoords(){
  const c = map.getCenter();
  coordsTxt.textContent = `Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;
}
map.on("move", updCoords);
map.whenReady(updCoords);

let pickedMarker=null;
const pickedIcon = L.icon({
  iconUrl:"https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
  iconSize:[25,41], iconAnchor:[12,41],
  shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
  shadowSize:[41,41]
});
function showPicked(lat,lng,{zoom=null}={}){
  if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;
  const ll = L.latLng(lat,lng);
  if(!pickedMarker) pickedMarker = L.marker(ll,{icon:pickedIcon}).addTo(map);
  else pickedMarker.setLatLng(ll);
  if(zoom!=null) map.setView(ll, zoom);
}

/* ===== DOM ===== */
const balai = document.getElementById("balai");
const prov  = document.getElementById("prov");
const kab   = document.getElementById("kab");
const di    = document.getElementById("di");
const lat   = document.getElementById("lat");
const lng   = document.getElementById("lng");
const btnSubmit = document.getElementById("btnSubmit");
const lastStageEl = document.getElementById("lastStage");

const coordBadge = document.getElementById("coordBadge");
const coordBadgeText = document.getElementById("coordBadgeText");

const btnPick = document.getElementById("btnPick");
const btnPan = document.getElementById("btnPan");
const btnLocate = document.getElementById("btnLocate");

const historyGals = document.getElementById("historyGals");

/* ===== Badge / Lock ===== */
function setCoordBadge(type, text){
  const dot = coordBadge.querySelector(".dot");
  dot.classList.remove("green","orange","gray");
  dot.classList.add(type==="locked"?"green":type==="none"?"orange":"gray");
  coordBadgeText.textContent = text;
}
function setCoordLock(locked, la, ln){
  if(locked){
    if(Number.isFinite(la) && Number.isFinite(ln)){
      lat.value = Number(la).toFixed(6);
      lng.value = Number(ln).toFixed(6);
      showPicked(Number(la), Number(ln), {zoom:17});
    }
    lat.disabled = true; lng.disabled = true;
    btnPick.disabled = true; btnPan.disabled = true; btnLocate.disabled = true;
    btnPick.classList.remove("primary"); btnPick.classList.add("ghost");
  }else{
    lat.disabled = false; lng.disabled = false;
    btnPick.disabled = false; btnPan.disabled = false; btnLocate.disabled = false;
    btnPick.classList.add("primary"); btnPick.classList.remove("ghost");
  }
}

/* ===== Map Buttons ===== */
btnLocate.addEventListener("click", ()=>{
  map.locate({setView:true, maxZoom:17, enableHighAccuracy:true});
});
map.on("locationfound", (e)=>{
  lat.value = e.latitude.toFixed(6);
  lng.value = e.longitude.toFixed(6);
  showPicked(e.latitude, e.longitude, {zoom:17});
  updateSubmitState();
});
map.on("locationerror", ()=>{
  toast("Izin lokasi ditolak. Geser peta manual.", true);
});

btnPick.addEventListener("click", ()=>{
  const c = map.getCenter();
  lat.value = c.lat.toFixed(6);
  lng.value = c.lng.toFixed(6);
  showPicked(c.lat, c.lng);
  updateSubmitState();
});
btnPan.addEventListener("click", ()=>{
  const la = +lat.value, lo = +lng.value;
  if(!Number.isNaN(la) && !Number.isNaN(lo)){
    showPicked(la, lo, {zoom:Math.max(map.getZoom(),16)});
  }
});
function tryUpdateFromInputs(){
  const la = parseFloat(lat.value), lo = parseFloat(lng.value);
  if(Number.isFinite(la) && Number.isFinite(lo)) showPicked(la, lo);
}
lat.addEventListener("change", tryUpdateFromInputs);
lng.addEventListener("change", tryUpdateFromInputs);

/* ===== Data & Cascade ===== */
let RAW = [];
let INDEX = {};  // INDEX[bws][prov][kab][di] = row baseline (first match)
function buildIndex(items){
  INDEX = {};
  items.forEach(row=>{
    const BWS = titleCase(row["B/BWS PELAKSANA"] || row["B/BWS"] || row["Balai"] || row["BWS"] || row["bws"]);
    const PROV= titleCase(row["PROVINSI"] || row["Provinsi"] || row["provinsi"]);
    const KAB = titleCase(row["KABUPATEN"] || row["Kabupaten"] || row["Kab/Kota"] || row["kabupaten"]);
    const DI  = titleCase(row["NAMA DI/DIR"] || row["Nama DI"] || row["DI"] || row["di"]);
    if(!(BWS && PROV && KAB && DI)) return;

    INDEX[BWS] ??= {};
    INDEX[BWS][PROV] ??= {};
    INDEX[BWS][PROV][KAB] ??= {};
    if(!INDEX[BWS][PROV][KAB][DI]) INDEX[BWS][PROV][KAB][DI] = row; // simpan first match
  });
}

async function loadBaseline(){
  try{
    const url = DATA_URL + (DATA_URL.includes("?")?"&":"?") + "fn=baseline&t=" + Date.now();
    const res = await fetch(url, {cache:"no-store"});
    const j = await res.json();
    if(!j || j.ok !== true || !Array.isArray(j.items)) throw new Error("Baseline invalid (butuh {ok:true, items:[...]})");
    RAW = j.items;
    buildIndex(RAW);

    fillSelect(balai, Object.keys(INDEX).sort(), "-- pilih B/BWS --");
    fillSelect(prov, [], "-- pilih Provinsi --"); prov.disabled = true;
    fillSelect(kab,  [], "-- pilih Kab/Kota --"); kab.disabled = true;
    fillSelect(di,   [], "-- pilih DI --"); di.disabled = true;

    toast("Baseline siap ‚úÖ");
  }catch(err){
    console.error(err);
    toast("Gagal memuat baseline: " + (err.message || err), true);
  }
}

balai.addEventListener("change", ()=>{
  const b = balai.value;
  fillSelect(prov, b ? Object.keys(INDEX[b]||{}).sort() : [], "-- pilih Provinsi --");
  prov.disabled = !b;
  fillSelect(kab, [], "-- pilih Kab/Kota --"); kab.disabled = true;
  fillSelect(di,  [], "-- pilih DI --"); di.disabled = true;
  clearProjectInfo();
  updateSubmitState();
});
prov.addEventListener("change", ()=>{
  const b = balai.value, p = prov.value;
  fillSelect(kab, (b && p) ? Object.keys((INDEX[b]||{})[p]||{}).sort() : [], "-- pilih Kab/Kota --");
  kab.disabled = !(b && p);
  fillSelect(di, [], "-- pilih DI --"); di.disabled = true;
  clearProjectInfo();
  updateSubmitState();
});
kab.addEventListener("change", ()=>{
  const b=balai.value, p=prov.value, k=kab.value;
  fillSelect(di, (b&&p&&k) ? Object.keys((((INDEX[b]||{})[p]||{})[k]||{})).sort() : [], "-- pilih DI --");
  di.disabled = !(b&&p&&k);
  clearProjectInfo();
  updateSubmitState();
});

/* ===== Project Info (ciutkan) ===== */
const projHint = document.getElementById("projHint");
const projGrid = document.getElementById("projGrid");
function clearProjectInfo(){
  projGrid.style.display = "none";
  projGrid.innerHTML = "";
  projHint.style.display = "block";
}
function setProjectInfoFromRow(row){
  // Referensi kolom (kecuali Total Alokasi Usulan)
  const fields = [
    "Jenis Usulan Kegiatan",
    "Urutan Prioritas",
    "IP Padi Semula (%)",
    "IP Padi Menjadi (%)",
    "Outcome (Ha)",
    "Masa Pelaksanaan",
    "B/??" // kalau ada kolom ‚ÄúB/...‚Äù di baseline, nanti otomatis ketarik via fallback below
  ];

  // kumpulin nilai dari row dengan cara fleksibel (case-insensitive)
  const keys = Object.keys(row||{});
  const pick = (wanted)=>{
    const w = wanted.toLowerCase();
    // cari exact-ish
    let k = keys.find(x=> String(x).toLowerCase() === w);
    if(!k){
      // cari contains
      k = keys.find(x=> String(x).toLowerCase().includes(w));
    }
    return k ? row[k] : "";
  };

  const out = [];

  // isi kolom referensi utama
  fields.forEach(f=>{
    if(f === "B/??"){
      const k = keys.find(x=> String(x).trim().toLowerCase().startsWith("b/"));
      if(k){
        out.push([k, row[k]]);
      }
      return;
    }
    const v = pick(f);
    if(norm(v) !== "") out.push([f, v]);
  });

  // fallback tambahan kalau kolomnya beda penamaan tapi masih relevan
  // (tetap skip Total Alokasi Usulan)
  const skip = (k)=> String(k).toLowerCase().includes("total alokasi usulan");
  keys.forEach(k=>{
    if(skip(k)) return;
    const lk = String(k).toLowerCase();
    const isRelevant =
      lk.includes("jenis usulan") ||
      lk.includes("urutan prioritas") ||
      (lk.includes("ip") && lk.includes("padi")) ||
      lk.includes("outcome") ||
      lk.includes("masa pelaksanaan") ||
      lk.startsWith("b/");
    if(isRelevant){
      const already = out.some(([kk])=> kk.toLowerCase() === String(k).toLowerCase());
      if(!already && norm(row[k]) !== "") out.push([k, row[k]]);
    }
  });

  if(out.length === 0){
    clearProjectInfo();
    return;
  }

  projHint.style.display = "none";
  projGrid.style.display = "grid";
  projGrid.innerHTML = out.map(([k,v])=>`
    <div class="kv">
      <div class="k">${k}</div>
      <div class="v">${String(v)}</div>
    </div>
  `).join("");
}

let currentRow = null;

/* ===== History / Stage ===== */
let currentStage = null;

function renderStageButtons(maxStage){
  const wrap = document.getElementById("stageBtns");
  wrap.innerHTML = "";
  const stages = [25,50,75,100];
  const nextStage = (maxStage >= 100) ? null : (maxStage === 0 ? 25 : (maxStage + 25));

  stages.forEach(st=>{
    const btn = document.createElement("button");
    btn.type = "button";
    btn.textContent = `Progres ${st}%`;
    const enabled = (st === nextStage);
    btn.className = enabled ? "primary" : "ghost";
    btn.disabled = !enabled;
    btn.addEventListener("click", ()=>{
      currentStage = st;
      toast(`Stage dipilih: ${st}%`);
      updateSubmitState();
    });
    wrap.appendChild(btn);
  });

  currentStage = nextStage;
  updateSubmitState();
}

function renderHistoryStatus(photos){
  const order=[25,50,75,100];
  const cards = order.map(st=>{
    const p = photos[String(st)];
    const done = !!(p && p.url);
    const openUrl = done ? p.url : "#";
    const pill = done
      ? `<span class="pill" style="border-color:rgba(34,197,94,.35)"><span class="dot green"></span>Sudah upload</span>`
      : `<span class="pill"><span class="dot gray"></span>Belum ada</span>`;
    const icon = done ? "‚úÖ" : "‚¨ú";
    const nm = done ? (p.name || `Stage ${st}`) : "Belum ada upload untuk stage ini";
    return `
      <div class="hist-card">
        <div class="hdr">
          <div style="font-weight:900">Foto Progres ${st}%</div>
          ${pill}
        </div>
        <div class="thumb"><div style="font-size:44px;line-height:1">${icon}</div></div>
        <div class="body">
          <div class="hint muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${nm}</div>
          <div class="actions" style="justify-content:flex-end">
            ${done ? `<a class="openlink" href="${openUrl}" target="_blank" rel="noopener">Buka</a>` : `<span class="hint muted">Buka</span>`}
          </div>
        </div>
      </div>
    `;
  }).join("");
  historyGals.innerHTML = `<div class="hist-grid">${cards}</div>`;
}

async function fetchHistory(bws, p, k, d){
  const qs = new URLSearchParams({fn:"history", bws, prov:p, kab:k, di:d});
  const url = DATA_URL + (DATA_URL.includes("?")?"&":"?") + qs.toString() + "&t=" + Date.now();
  const res = await fetch(url, {cache:"no-store"});
  try{
    const j = await res.json();
    return (j && j.ok) ? j : {ok:false, maxStage:0, coords:null, photos:{}};
  }catch{
    return {ok:false, maxStage:0, coords:null, photos:{}};
  }
}

/* DI selected: isi kec/desa, ambil history, lock koordinat, tampilkan info paket */
di.addEventListener("change", async ()=>{
  const b=balai.value, p=prov.value, k=kab.value, d=di.value;
  if(!(b&&p&&k&&d)) return;

  const row = ((((INDEX[b]||{})[p]||{})[k]||{})[d]) || null;
  currentRow = row;

  // auto kec/desa (kalau ada)
  const kecVal = row ? (row["KECAMATAN"] || row["Kecamatan"] || row["kecamatan"] || "") : "";
  const desaVal = row ? (row["DESA"] || row["Desa"] || row["desa"] || row["Desa/Kelurahan"] || "") : "";
  if(norm(kecVal)) document.getElementById("kecamatan").value = titleCase(kecVal);
  if(norm(desaVal)) document.getElementById("desa").value = titleCase(desaVal);

  // info paket
  if(row) setProjectInfoFromRow(row);
  else clearProjectInfo();

  // history
  const hist = await fetchHistory(b,p,k,d);
  lastStageEl.textContent = (hist.maxStage||0) + "%";
  renderHistoryStatus(hist.photos||{});
  renderStageButtons(hist.maxStage||0);

  const hasCoord = hist.coords && Number.isFinite(hist.coords.lat) && Number.isFinite(hist.coords.lng);
  if(hasCoord){
    setCoordLock(true, hist.coords.lat, hist.coords.lng);
    setCoordBadge("locked","Koordinat: terkunci (pakai entri sebelumnya)");
    map.setView([hist.coords.lat, hist.coords.lng], 17);
  }else{
    setCoordLock(false);
    setCoordBadge("none","Koordinat: belum ada, silakan pilih titik");
  }

  updateSubmitState();
});

/* ===== Foto + kompres ===== */
let selectedFile=null;
const fileInput=document.getElementById("fileInput");
const photoMeta=document.getElementById("photoMeta");

document.getElementById("btnCamera").addEventListener("click", ()=>{
  fileInput.setAttribute("capture","environment");
  fileInput.click();
});
document.getElementById("btnGallery").addEventListener("click", ()=>{
  fileInput.removeAttribute("capture");
  fileInput.click();
});
fileInput.addEventListener("change", ()=>{
  selectedFile = fileInput.files?.[0] || null;
  photoMeta.textContent = selectedFile ? `Dipilih: ${selectedFile.name} ‚Ä¢ ${(selectedFile.size/1024).toFixed(1)} KB` : "";
});

async function compressImage(file,{maxDim=2000,quality=0.82,mime="image/jpeg"}={}){
  try{
    if(!(file && file.type && file.type.startsWith("image/"))) return file;
    const bitmap = await createImageBitmap(file, {imageOrientation:"from-image"});
    const W=bitmap.width, H=bitmap.height;
    const s=Math.min(1, maxDim/Math.max(W,H));
    const w=Math.round(W*s), h=Math.round(H*s);
    if(s===1 && file.type==="image/jpeg" && file.size<700*1024) return file;

    const c=document.createElement("canvas"); c.width=w; c.height=h;
    const ctx=c.getContext("2d"); ctx.drawImage(bitmap,0,0,w,h);

    const blob = await new Promise(r=> c.toBlob(r, mime, quality));
    if(!blob || blob.size >= file.size) return file;

    const name = (file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,"") || "foto") + ".jpg";
    return new File([blob], name, {type:mime});
  }catch(e){
    console.warn("compress fail", e);
    return file;
  }
}

/* ===== Submit enable/disable ===== */
function missingList(){
  const m=[];
  if(!balai.value) m.push("B/BWS");
  if(!prov.value)  m.push("Provinsi");
  if(!kab.value)   m.push("Kab/Kota");
  if(!di.value)    m.push("DI");
  if(!document.getElementById("kecamatan").value) m.push("Kecamatan");
  if(!document.getElementById("desa").value)      m.push("Desa/Kelurahan");
  if(!lat.value || !lng.value)                    m.push("Koordinat");
  if(!document.getElementById("nama").value)      m.push("Nama");
  if(!document.getElementById("telepon").value)   m.push("Nomor WA/HP");
  if(!currentStage)                               m.push("Stage Progres");
  if(!selectedFile)                               m.push("Foto");
  return m;
}
function updateSubmitState(){
  btnSubmit.disabled = missingList().length !== 0;
}
document.getElementById("surveyForm").addEventListener("input", updateSubmitState);
document.getElementById("surveyForm").addEventListener("change", updateSubmitState);

/* ===== Submit ===== */
document.getElementById("surveyForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const miss = missingList();
  if(miss.length){
    toast("Harus diisi: " + miss.join(", "), true);
    updateSubmitState();
    return;
  }

  let photo = await compressImage(selectedFile, {maxDim:2000, quality:0.82});
  const b64 = await new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(String(r.result));
    r.onerror = rej;
    r.readAsDataURL(photo);
  });

  // rename file on server: NamaDI_Progres.jpg (server akan handle, tapi kita kirim juga nama yang rapi)
  const diName = (di.value || "DI").replace(/[^\w\-]+/g,"_");
  const fname  = `${diName}_${currentStage}.jpg`;

  const fd = new FormData(document.getElementById("surveyForm"));
  fd.set("progress_stage", String(currentStage));
  fd.set("foto_b64", b64);
  fd.set("foto_name", fname);
  fd.set("foto_type", photo.type || "image/jpeg");

  disableForm(true);
  setUploadingUI(true, 6);

  try{
    const xhr = new XMLHttpRequest();
    xhr.open("POST", ENDPOINT, true);
    xhr.upload.onprogress = (ev)=>{
      if(ev.lengthComputable) setUploadingUI(true, (ev.loaded/ev.total)*100);
    };
    xhr.onloadstart = ()=> setUploadingUI(true, 5);
    xhr.onreadystatechange = ()=>{ if(xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) setUploadingUI(true, 95); };

    xhr.onerror = ()=>{
      setUploadingUI(false);
      disableForm(false);
      toast("Gagal kirim (jaringan/proxy).", true);
    };

    xhr.onload = async ()=>{
      let data={}; try{ data = JSON.parse(xhr.responseText||"{}"); }catch{}
      if(xhr.status>=200 && xhr.status<300 && data && data.ok){
        setUploadingUI(true, 100);
        toast("Terkirim ‚úÖ");

        // refresh history
        const b=balai.value, p=prov.value, k=kab.value, d=di.value;
        const hist = await fetchHistory(b,p,k,d);
        lastStageEl.textContent = (hist.maxStage||0) + "%";
        renderHistoryStatus(hist.photos||{});
        renderStageButtons(hist.maxStage||0);

        if(hist.coords){
          setCoordLock(true, hist.coords.lat, hist.coords.lng);
          setCoordBadge("locked","Koordinat: terkunci (pakai entri sebelumnya)");
        }
        // reset file selection (biar next stage foto baru)
        selectedFile = null;
        fileInput.value = "";
        photoMeta.textContent = "";

        setTimeout(()=> setUploadingUI(false), 500);
      }else{
        setUploadingUI(false);
        toast("Gagal kirim (server): " + (data && data.error ? data.error : ""), true);
      }
      disableForm(false);
      updateSubmitState();
    };

    xhr.send(fd);
  }catch(err){
    setUploadingUI(false);
    disableForm(false);
    toast("Error submit: " + (err.message || err), true);
  }
});

/* ===== Reset ===== */
document.getElementById("btnReset").addEventListener("click", ()=>{
  selectedFile=null; photoMeta.textContent="";
  fillSelect(prov, [], "-- pilih Provinsi --"); prov.disabled=true;
  fillSelect(kab,  [], "-- pilih Kab/Kota --"); kab.disabled=true;
  fillSelect(di,   [], "-- pilih DI --"); di.disabled=true;
  lastStageEl.textContent = "0%";
  setCoordBadge("none", "Koordinat: -");
  setCoordLock(false);
  if(pickedMarker){ map.removeLayer(pickedMarker); pickedMarker=null; }
  historyGals.innerHTML = `<div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>`;
  clearProjectInfo();
  currentStage = null;
  updateSubmitState();
});

/* ===== Init ===== */
function setCoordBadgeInit(){ setCoordBadge("none","Koordinat: -"); }
setCoordBadgeInit();
loadBaseline();
updateSubmitState();
</script>

</body>
</html>
