<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Survey AIR ‚Äî GAS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px} .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600} .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    .hint{font-size:12px;color:var(--mut)} #map{height:60vh}
    .mapwrap{position:relative} .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)} .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999}
    .u-box{background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
    .u-title{font-weight:800;margin-bottom:6px}.u-progress{height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
    #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)} .u-hint{font-size:12px;color:#a1a1aa;margin-top:8px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header><strong>Form Survey AIR</strong>
    <span class="hint"> ‚Ä¢ BALAI ‚Üí SNVT ‚Üí PAKET, Prov/Kab otomatis, peta untuk koordinat.</span>
  </header>

  <main>
    <div class="card">
      <h2>Data Survei</h2>
      <div id="toast" class="toast"></div>

      <!-- Same-origin: action = URL web app ini -->
      <form id="surveyForm"
            action="<?= WEBAPP_URL ?>"
            method="POST" enctype="multipart/form-data"
            target="uploadFrame">

        <div class="row">
          <div><label>BALAI</label><select id="balai" name="balai" required></select></div>
          <div><label>SNVT</label><select id="snvt" name="snvt" required disabled></select></div>
        </div>

        <div><label>PAKET</label><select id="paket" name="paket" required disabled></select></div>

        <div class="row">
          <div><label>Provinsi (otomatis)</label><input id="provinsi" name="provinsi" readonly/></div>
          <div><label>Kabupaten/Kota (otomatis)</label>
            <select id="kabupaten" name="kabupaten" disabled><option value="">-- pilih Kabupaten/Kota --</option></select>
          </div>
        </div>

        <div class="row">
          <div><label>Kecamatan</label><input id="kecamatan" name="kecamatan" required/></div>
          <div><label>Desa/Kelurahan</label><input id="desa" name="desa" required/></div>
        </div>

        <div>
          <label>Peta Lokasi</label>
          <div class="mapwrap"><div id="map"></div>
            <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
            <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi</button>
            <span class="hint" id="coords">Lat: -, Lng: -</span>
          </div>
        </div>

        <div class="row">
          <div><label>Latitude</label><input type="number" step="0.000001" id="lat" name="lat" required/></div>
          <div><label>Longitude</label><input type="number" step="0.000001" id="lng" name="lng" required/></div>
        </div>
        <div class="actions" style="margin-top:4px"><button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button></div>

        <div>
          <label>Foto Lokasi</label>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <input type="file" accept="image/*" capture="environment" id="fileCamera" style="display:none">
          <input type="file" accept="image/*" id="fileGallery" style="display:none">
          <input type="file" id="hiddenFoto" name="foto" style="display:none">
          <div class="hint">Foto dikompresi otomatis.</div>
        </div>

        <div class="row">
          <div><label>Nama Pengirim</label><input id="nama" name="nama" required/></div>
          <div><label>Nomor WA/HP</label><input id="telepon" name="telepon" pattern="[0-9+]{8,15}" required/></div>
        </div>

        <div class="actions">
          <button type="submit" class="primary">Kirim</button>
          <button type="reset" class="ghost" id="btnReset">Reset</button>
        </div>
      </form>

      <!-- target iframe: same-origin sekarang, jadi tidak 403 -->
      <iframe name="uploadFrame" id="uploadFrame" style="display:none"></iframe>
    </div>
  </main>

  <!-- Overlay Upload -->
  <div id="uploadOverlay">
    <div class="u-box"><div class="u-title" id="uploadTitle">Mengunggah data‚Ä¶</div>
      <div class="u-msg" id="uploadMsg">Menyiapkan berkas‚Ä¶</div>
      <div class="u-progress"><div id="progressBar"></div></div>
      <div class="u-hint" id="uploadHint">Jangan tutup halaman ini.</div>
    </div>
  </div>

<script>
/* ===== Utils & UI ===== */
const toast = (m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',4000);};
function fillSelect(el, items, ph='-- pilih --'){el.innerHTML=''; if(ph&&!el.multiple){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);} (items||[]).forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);}); el.disabled=!(items&&items.length);}
const uniq = a => [...new Set((a||[]).filter(Boolean))];
const $overlay=document.getElementById('uploadOverlay'),$ut=document.getElementById('uploadTitle'),$um=document.getElementById('uploadMsg'),$uh=document.getElementById('uploadHint'),$bar=document.getElementById('progressBar');
let sim=null,p=0; function setUI({show,title,msg,percent,hint}){if(title)$ut.textContent=title; if(msg)$um.textContent=msg; if(hint)$uh.textContent=hint; if(typeof percent==='number'){$bar.style.width=Math.max(0,Math.min(100,Math.round(percent)))+'%';} $overlay.style.display=show?'flex':'none';}
function simStart(){clearInterval(sim); p=8; setUI({show:true,msg:'Mengirim ke server‚Ä¶',percent:p}); sim=setInterval(()=>{if(p<92)p+=Math.max(1,Math.round((96-p)/10)); setUI({show:true,percent:p});},300);} function simStop(){clearInterval(sim); sim=null;}
function disableForm(b){document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button').forEach(e=>e.disabled=!!b);}

/* ===== DOM ===== */
const balai=balaiEl=document.getElementById('balai'), snvt=document.getElementById('snvt'), paket=document.getElementById('paket');
const prov=document.getElementById('provinsi'), kab=document.getElementById('kabupaten');
const lat=document.getElementById('lat'), lng=document.getElementById('lng'), form=document.getElementById('surveyForm');

/* ===== Map ===== */
const baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImg=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
const map=L.map('map',{zoomControl:true,layers:[baseOSM]}); L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5); const coords=document.getElementById('coords'); function upd(){const c=map.getCenter(); coords.textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;} map.on('move',upd); map.whenReady(upd);
document.getElementById('btnLocate').addEventListener('click',()=>map.locate({setView:true,maxZoom:17,enableHighAccuracy:true}));
map.on('locationerror',()=>alert('Izin lokasi ditolak. Geser peta manual.'));
document.getElementById('btnPick').addEventListener('click',()=>{const c=map.getCenter(); lat.value=c.lat.toFixed(6); lng.value=c.lng.toFixed(6);});
document.getElementById('btnPan').addEventListener('click',()=>{const la=+lat.value,lo=+lng.value; if(!Number.isNaN(la)&&!Number.isNaN(lo)) map.setView([la,lo],Math.max(map.getZoom(),16));});

/* ===== Load JSON (encode +) ===== */
let BBWS={};
(async()=>{
  const cands=['./balai_snvt_paket%2Bwilayah.kab_array.json','./balai_snvt_paket+wilayah.json','./balai_snvt_paket.json'];
  let data=null,last=null; for(const u of cands){ try{const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status+' '+u); data=await r.json(); console.log('Loaded',u); break;}catch(e){last=e;} }
  if(!data){toast('‚ö†Ô∏è Data BALAI tidak bisa dimuat.'); console.error(last); fillSelect(balai,[], '-- gagal memuat BALAI --'); return;}
  BBWS=data; fillSelect(balai,Object.keys(BBWS).sort(),'-- pilih BALAI --');
})();

/* ===== Prov/Kab Auto ===== */
const parseKab=k=>Array.isArray(k)?uniq(k.map(s=>String(s).trim())):uniq(String(k||'').split(/\r?\n/).map(s=>s.replace(/^\s*-\s*/,'').trim()).filter(Boolean));
function collectMeta({b=null,s=null,p=null}){ if(!b||!BBWS[b]) return{provinsi:'',kabList:[]}; let entries=[];
  if(s&&BBWS[b][s]){const arr=BBWS[b][s]||[]; if(p){const ch=arr.find(x=>(typeof x==='string'?x:(x.paket))===p); entries=ch?[ch]:arr;} else entries=arr;}
  else{Object.values(BBWS[b]).forEach(arr=>entries=entries.concat(arr||[]));}
  const provs=uniq(entries.map(e=>typeof e==='object'?(e.provinsi||''):'').filter(Boolean));
  const kabAll=uniq(entries.flatMap(e=>typeof e==='object'?parseKab(e.kabupaten||e.kab||[]):[]));
  return{provinsi:provs.length? (provs.length===1?provs[0]:'(beragam)'):'', kabList:kabAll};
}
balai.addEventListener('change',()=>{const b=balai.value; if(!b){fillSelect(snvt,[], '-- pilih SNVT --'); fillSelect(paket,[], '-- pilih PAKET --'); snvt.disabled=paket.disabled=true; prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true; return;}
  fillSelect(snvt,Object.keys(BBWS[b]||{}).sort(),'-- pilih SNVT --'); snvt.disabled=false; const m=collectMeta({b}); prov.value=m.provinsi||''; fillSelect(kab,m.kabList,'-- pilih Kabupaten/Kota --'); kab.disabled=m.kabList.length===0; fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;});
snvt.addEventListener('change',()=>{const b=balai.value,s=snvt.value; if(!s){fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true; const m=collectMeta({b}); prov.value=m.provinsi||''; fillSelect(kab,m.kabList,'-- pilih Kabupaten/Kota --'); kab.disabled=m.kabList.length===0; return;}
  const arr=(BBWS[b]||{})[s]||[]; const names=arr.map(x=>typeof x==='string'?x:(x.paket||'')).filter(Boolean); fillSelect(paket,names,'-- pilih PAKET --'); paket.disabled=names.length===0;
  const m=collectMeta({b,s}); prov.value=m.provinsi||''; fillSelect(kab,m.kabList,'-- pilih Kabupaten/Kota --'); kab.disabled=m.kabList.length===0;});
paket.addEventListener('change',()=>{const m=collectMeta({b:balai.value,s:snvt.value,p:paket.value}); if(m.provinsi||m.kabList.length){prov.value=m.provinsi||prov.value; fillSelect(kab,m.kabList,'-- pilih Kabupaten/Kota --'); kab.disabled=m.kabList.length===0;}});

/* ===== Foto (kamera/galeri) + kompresi ===== */
let selectedFile=null; const fileCam=document.getElementById('fileCamera'), fileGal=document.getElementById('fileGallery'), metaEl=document.getElementById('photoMeta');
document.getElementById('btnCamera').addEventListener('click',()=>fileCam.click());
document.getElementById('btnGallery').addEventListener('click',()=>fileGal.click());
function showMeta(f){ if(!f){metaEl.textContent=''; return;} const kb=(f.size/1024).toFixed(1); metaEl.textContent=`Dipilih: ${f.name} ‚Ä¢ ${kb} KB`; }
fileCam.addEventListener('change',()=>{selectedFile=fileCam.files?.[0]||null; showMeta(selectedFile);});
fileGal.addEventListener('change',()=>{selectedFile=fileGal.files?.[0]||null; showMeta(selectedFile);});
async function compressImage(file,{maxDim=2000,quality=0.82,mime='image/jpeg'}={}){ try{
  if(!(file&&file.type&&file.type.startsWith('image/'))) return file; let bitmap; if(window.createImageBitmap){bitmap=await createImageBitmap(file,{imageOrientation:'from-image'});}
  const dims=f=>new Promise((res,rej)=>{const i=new Image(); i.onload=()=>res({w:i.width,h:i.height}); i.onerror=rej; i.src=URL.createObjectURL(f);});
  const {w:W,h:H}=bitmap?{w:bitmap.width,h:bitmap.height}:await dims(file); const s=Math.min(1,maxDim/Math.max(W,H)); const w=Math.round(W*s), h=Math.round(H*s);
  if(s===1 && file.type==='image/jpeg' && file.size<700*1024) return file; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  if(bitmap) ctx.drawImage(bitmap,0,0,w,h); else {const i=new Image(); await new Promise((r,j)=>{i.onload=r;i.onerror=j;i.src=URL.createObjectURL(file)}); ctx.drawImage(i,0,0,w,h);}
  const blob=await new Promise(r=>c.toBlob(r,mime,quality)); if(!blob||blob.size>=file.size) return file; const name=(file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto')+'.jpg'; return new File([blob],name,{type:mime});
}catch(e){console.warn('compress fail',e); return file;}}

/* ===== Reset ===== */
document.getElementById('btnReset').addEventListener('click',()=>{selectedFile=null; showMeta(null); fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true; fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true; prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;});

/* ===== Submit (same-origin; iframe OK) ===== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!balai.value||!snvt.value||!paket.value){toast('Lengkapi BALAI, SNVT, PAKET.'); return;}
  if(!lat.value||!lng.value){toast('Koordinat belum diisi.'); return;}

  setUI({show:true,title:'Menyiapkan berkas‚Ä¶',msg:'Kompresi foto‚Ä¶',percent:5});
  const hidden=document.getElementById('hiddenFoto');
  if(selectedFile){ const photo=await compressImage(selectedFile,{maxDim:2000,quality:0.82}); const dt=new DataTransfer(); dt.items.add(photo); hidden.files=dt.files; const kb=(photo.size/1024).toFixed(1); metaEl.textContent=`Akan dikirim: ${photo.name} ‚Ä¢ ${kb} KB`; }
  else { hidden.files=(new DataTransfer()).files; }

  balai.disabled=snvt.disabled=paket.disabled=false; // pastikan terkirim
  setUI({show:true,title:'Mengunggah data‚Ä¶',msg:'Mengirim ke server‚Ä¶',percent:12}); simStart();

  const iframe=document.getElementById('uploadFrame');
  const done=()=>{ simStop(); setUI({show:true,title:'Berhasil terkirim!',msg:'Server menerima data.',percent:100,hint:'Kamu bisa menutup dialog ini.'});
    setTimeout(()=>{ setUI({show:false}); form.reset(); selectedFile=null; metaEl.textContent=''; fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true; fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true; prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true; disableForm(false); },700);
    iframe.removeEventListener('load',done);
  };
  iframe.addEventListener('load',done);
  disableForm(true);
  form.submit(); // same-origin ‚Üí tidak 403
});
</script>
</body>
</html>
