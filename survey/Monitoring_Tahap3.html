<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitoring Tahap 3 ‚Äî log_progres3 (Peta)</title>

  <!-- Leaflet -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(15,23,42,.92); --text:#e5e7eb; --muted:#a7b0c0;
      --line:rgba(255,255,255,.12); --accent:#1d5fd1; --yellow:#ffb300;
      --good:#27b06e; --bad:#ff5c7a; --hdrH:64px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:var(--bg)}
    header{
      position:fixed; inset:0 0 auto 0; height:var(--hdrH);
      display:flex; align-items:center; gap:12px; padding:0 16px;
      background:linear-gradient(90deg, rgba(13,71,161,.95), rgba(10,58,133,.92));
      border-bottom:1px solid rgba(255,255,255,.12); z-index:1000;
    }
    header .title{font-weight:900; letter-spacing:.2px}
    header .badge{
      margin-left:auto; font-size:12px; color:#111827; background:var(--yellow);
      padding:6px 10px; border-radius:999px; font-weight:900;
    }

    .wrap{padding-top:var(--hdrH); display:grid; grid-template-columns: 390px 1fr; height:calc(100vh - var(--hdrH));}
    aside{
      border-right:1px solid var(--line);
      background:rgba(11,18,34,.65);
      padding:14px;
      overflow:auto;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted); font-size:12px}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; font-weight:800;
    }
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:rgba(29,95,209,.22); border-color:rgba(29,95,209,.55)}
    input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(167,176,192,.8)}
    .stat{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      font-size:12px; font-weight:900;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--good)}
    .dot.bad{background:var(--bad)}
    #list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:14px; padding:10px;
      cursor:pointer;
    }
    .item:hover{border-color:rgba(255,255,255,.28)}
    .item .h{font-weight:900; font-size:13px}
    .item .s{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.25}
    .item .k{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tag{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text);
    }
    #map{height:100%; width:100%}
    .toast{
      position:fixed; left:16px; bottom:16px; z-index:2000;
      max-width:min(640px, calc(100vw - 32px));
      background:rgba(15,23,42,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:none;
    }
    .toast.show{display:block}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; grid-template-rows: 380px 1fr}
      aside{border-right:none; border-bottom:1px solid var(--line)}
    }
  </style>

</head>

<body>
<header>
  <div class="title">Monitoring Tahap 3 ‚Ä¢ <span class="muted">Sheet:</span> log_progres3</div>
  <div class="badge" id="badgeStatus">READY</div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">Sumber Data</div>
          <div class="muted">GViz / JSON Proxy ‚Üí Peta</div>
        </div>
        <button class="btn primary" id="btnReload">Reload</button>
      </div>

```
  <div style="height:10px"></div>

  <div class="muted" style="margin-bottom:6px">Cari</div>
  <input id="q" placeholder="ketik kata kunci (nama / desa / status / dll)..." />

  <div style="height:10px"></div>

  <div class="stat">
    <div class="pill"><span class="dot"></span> Titik tampil: <span id="nShown">0</span></div>
    <div class="pill"><span class="dot bad"></span> Koordinat invalid: <span id="nBad">0</span></div>
  </div>

  <div style="height:10px"></div>

  <div class="muted">
    Mode data: <span class="mono" id="mode">-</span><br/>
    Kolom koordinat: <span class="mono" id="coordKeys">-</span>
  </div>

  <div style="height:10px"></div>

  <div class="muted">
    Kalau CORS/login, pakai PROXY atau set DATA_URL ke endpoint JSON kamu.
  </div>
</div>

<div class="card">
  <div style="font-weight:900; margin-bottom:8px">Daftar Titik</div>
  <div id="list"></div>
</div>
```

  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  CONFIG (EDIT INI SAJA)
 *  ========================= */

// Google Sheet
const SHEET_ID   = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY";
const SHEET_NAME = "log_progres3";

/**
 * PILIH SALAH SATU SUMBER:
 * A) DATA_URL (langsung endpoint JSON yang return {ok:true, items:[...]})
 *    Isi kalau kamu sudah punya endpoint seperti itu (dari GAS/Worker).
 *
 * B) Kalau DATA_URL kosong, script akan pakai GViz (docs.google.com/.../gviz/tq)
 *    Kalau GViz kena CORS, isi PROXY untuk forward request.
 */
const DATA_URL = "https://script.google.com/macros/s/AKfycbwixAzu4MFs8Ms-K1sWMqCYmesje762mPYRW9uxkBCxbiTswKiaykXzD-D76naKlPWa/exec?sheet=log_progres3"; // contoh: "https://script.google.com/macros/s/XXXXX/exec?sheet=log_progres3"
const PROXY    = ""; // contoh: "https://gas-proxy3.tuic1677.workers.dev/?url="

// Pusat peta awal
const MAP_INIT = { center: [-2.5, 118.0], zoom: 5 };

/** =========================
 *  UTIL
 *  ========================= */
const $ = (s)=>document.querySelector(s);

function setBadge(text, kind="info"){
  $("#badgeStatus").textContent = text;
  if (kind==="error"){
    $("#badgeStatus").style.background = "var(--bad)";
    $("#badgeStatus").style.color = "#fff";
  } else if (kind==="ok"){
    $("#badgeStatus").style.background = "var(--good)";
    $("#badgeStatus").style.color = "#fff";
  } else {
    $("#badgeStatus").style.background = "var(--yellow)";
    $("#badgeStatus").style.color = "#111827";
  }
}
function toast(msg, kind="info"){
  const t = $("#toast");
  t.innerHTML = msg;
  t.classList.add("show");
  setBadge(kind.toUpperCase(), kind==="error" ? "error" : "info");
  setTimeout(()=>t.classList.remove("show"), 5200);
}

function norm(s){ return (s??"").toString().trim(); }
function normKey(s){
  return norm(s).toLowerCase()
    .replace(/\s+/g,"_")
    .replace(/[^\w]/g,"");
}
function parseCoord(v){
  if (v===null || v===undefined) return NaN;
  if (typeof v === "number") return v;
  const s = norm(v).replace(",", ".");
  const n = parseFloat(s);
  return n;
}

function pickLatKey(keys){
  const candidates = ["lat","latitude","lintang","y","koord_y","koordinat_y"];
  const k = keys.find(k => candidates.includes(k));
  if (k) return k;
  return keys.find(k => k.includes("lat") || k.includes("lintang"));
}
function pickLngKey(keys){
  const candidates = ["lng","lon","long","longitude","bujur","x","koord_x","koordinat_x"];
  const k = keys.find(k => candidates.includes(k));
  if (k) return k;
  return keys.find(k => k.includes("lng") || k.includes("lon") || k.includes("long") || k.includes("bujur"));
}

function bestTitle(obj){
  const keys = Object.keys(obj);
  const prefs = ["nama","name","judul","lokasi","nama_di","namadi","daerah_irigasi","di","nama_daerah_irigasi","kabupaten","kecamatan","desa"];
  for (const p of prefs){
    const k = keys.find(k=>k===p);
    if (k && norm(obj[k])) return norm(obj[k]);
  }
  for (const k of keys){
    const v = obj[k];
    if (typeof v==="string" && norm(v)) return norm(v);
  }
  return "Titik";
}
function bestSubtitle(obj){
  const keys = Object.keys(obj);
  const prefs = ["keterangan","ket","catatan","progress","status","uraian","tanggal_usulan","tanggal","timestamp","waktu","pengusul"];
  for (const p of prefs){
    const k = keys.find(k=>k===p);
    if (k && norm(obj[k])) return norm(obj[k]);
  }
  return "";
}

function escapeHtml(s){
  return norm(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function maybeLinkify(v){
  const s = norm(v);
  if (!s) return "";
  if (/^https?:\/\/\S+/i.test(s)) {
    return `<a href="${escapeHtml(s)}" target="_blank" rel="noopener">Buka Link</a>`;
  }
  return escapeHtml(s);
}

/** =========================
 *  MAP INIT
 *  ========================= */
const map = L.map("map").setView(MAP_INIT.center, MAP_INIT.zoom);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const cluster = L.markerClusterGroup({ chunkedLoading:true, chunkInterval:150, chunkDelay:20 });
map.addLayer(cluster);

let allRows = [];
let markers = [];
let latKey = null;
let lngKey = null;

/** =========================
 *  DATA FETCH + PARSE
 *  ========================= */
function gvizUrl(){
  const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
  const params = new URLSearchParams({
    tqx: "out:json",
    sheet: SHEET_NAME,
    t: Date.now().toString()
  });
  return `${base}?${params.toString()}`;
}

function parseGVizText(rawText){
  const s = (rawText || "").trim();
  const m = s.match(/setResponse\(([\s\S]+)\)\s*;?\s*$/);
  if (!m) {
    throw new Error("Respon bukan format GViz. Potongan awal: " + s.slice(0, 160));
  }
  let data;
  try { data = JSON.parse(m[1]); }
  catch(e){ throw new Error("GViz ketemu tapi JSON gagal diparse. Potongan: " + m[1].slice(0, 160)); }
  if (!data || !data.table) throw new Error("GViz ter-parse tapi tidak ada data.table. Cek izin sheet / sheet name.");
  return data.table;
}

function itemsToTable(items){
  const keys = Array.from(new Set(items.flatMap(o => Object.keys(o || {}))));
  return {
    cols: keys.map(k => ({ label: k, id: k })),
    rows: items.map(o => ({
      c: keys.map(k => {
        const v = (o && Object.prototype.hasOwnProperty.call(o, k)) ? o[k] : null;
        return (v === null || v === undefined) ? null : ({ v });
      })
    }))
  };
}

async function fetchTable(){
  // Prioritas 1: endpoint JSON langsung (kalau diisi)
  if (DATA_URL){
    $("#mode").textContent = "DATA_URL (JSON)";
    const res = await fetch(DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "t=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const j = await res.json();

    // support {ok:true, items:[...]} atau array langsung
    if (Array.isArray(j)) return itemsToTable(j);
    if (j && j.ok === true && Array.isArray(j.items)) return itemsToTable(j.items);
    if (j && j.table) return j.table;

    throw new Error("DATA_URL JSON tidak sesuai. Harus array / {ok:true,items:[...]} / {table:...}");
  }

  // Prioritas 2: GViz (dengan optional proxy)
  const url = gvizUrl();
  const finalUrl = PROXY ? (PROXY + encodeURIComponent(url)) : url;

  $("#mode").textContent = PROXY ? "GViz via PROXY" : "GViz direct";

  const res = await fetch(finalUrl, { cache:"no-store" });
  const txt = await res.text();

  // kalau HTML login/error page
  const head = (txt || "").slice(0, 300).toLowerCase();
  if (head.includes("<html") || head.includes("<!doctype html")) {
    throw new Error("Yang kebaca HTML (login/redirect/error). Sheet belum publik atau proxy nge-redirect.");
  }

  // coba parse JSON langsung (kalau proxy bungkus)
  let maybe = null;
  try { maybe = JSON.parse(txt); } catch(e) {}

  if (maybe && maybe.table) return maybe.table;
  if (maybe && maybe.data && maybe.data.table) return maybe.data.table;

  // format {ok:true, items:[...]} dari proxy
  if (maybe && maybe.ok === true && Array.isArray(maybe.items)) {
    $("#mode").textContent += " (ok/items)";
    return itemsToTable(maybe.items);
  }

  // wrapper string contents/body/data
  if (maybe && (typeof maybe.contents === "string" || typeof maybe.body === "string" || typeof maybe.data === "string")) {
    const inner = (maybe.contents || maybe.body || maybe.data || "").toString();
    return parseGVizText(inner);
  }

  // default GViz text
  return parseGVizText(txt);
}

/** =========================
 *  TABLE ‚Üí OBJECTS
 *  ========================= */
function tableToObjects(table){
  const cols = (table.cols||[]).map(c => normKey(c.label || c.id || ""));
  const rows = table.rows || [];
  const out = [];
  for (const r of rows){
    const o = {};
    (r.c||[]).forEach((cell, i)=>{
      const key = cols[i] || `col_${i+1}`;
      let v = cell ? (cell.f ?? cell.v) : null;
      if (typeof v === "string") v = v.trim();
      o[key] = v;
    });
    const hasAny = Object.values(o).some(v => v !== null && v !== "");
    if (hasAny) out.push(o);
  }
  return out;
}

/** =========================
 *  RENDER
 *  ========================= */
function clearMap(){
  cluster.clearLayers();
  markers = [];
}

function buildPopup(obj){
  const title = escapeHtml(bestTitle(obj));
  const sub = escapeHtml(bestSubtitle(obj));

  const keys = Object.keys(obj).filter(k => k !== "__id" && k !== latKey && k !== lngKey);

  // prioritas field penting (kalau ada)
  const priority = [
    "no","no.","nomor","tanggal_usulan","tanggal","timestamp","waktu",
    "pengusul","nama_di","nama_di_","namadi","nama_di__","nama_di",
    "jenis_di","status","progress","keterangan","ket","catatan",
    "desa","kecamatan","kabupaten","provinsi","bws",
    "foto","photo","image","url","link"
  ].map(normKey);

  const ordered = [];
  const used = new Set();

  for (const p of priority){
    const k = keys.find(x => x === p);
    if (k && !used.has(k)) { ordered.push(k); used.add(k); }
  }
  for (const k of keys){
    if (!used.has(k)) { ordered.push(k); used.add(k); }
  }

  function row(k){
    const v = obj[k];
    if (v===null || v===undefined || v==="") return "";
    const s = norm(v);
    const isImg = /^https?:\/\/\S+\.(png|jpg|jpeg|webp|gif)(\?\S*)?$/i.test(s);
    const val = isImg
      ? `<div style="margin-top:6px"><img src="${escapeHtml(s)}" alt="foto" style="width:100%;max-width:360px;border-radius:12px;border:1px solid rgba(255,255,255,.12)"></div>`
      : `<span>${maybeLinkify(v)}</span>`;

    return `
      <div style="padding:6px 0;border-top:1px solid rgba(255,255,255,.10)">
        <div style="font-size:11px;color:#a7b0c0;font-weight:900">${escapeHtml(k.toUpperCase())}</div>
        <div style="font-size:12px;line-height:1.25">${val}</div>
      </div>`;
  }

  let html = `
    <div style="min-width:240px;max-width:380px">
      <div style="font-weight:900;font-size:14px">${title}</div>
      ${sub ? `<div style="font-size:12px;color:#a7b0c0;margin-top:4px">${sub}</div>` : ""}
  `;
  for (const k of ordered){
    html += row(k);
  }
  html += `</div>`;
  return html;
}

function renderList(rows){
  const list = $("#list");
  list.innerHTML = "";
  if (!rows.length){
    list.innerHTML = `<div class="muted">Tidak ada data yang cocok.</div>`;
    return;
  }

  for (const r of rows){
    const title = bestTitle(r);
    const sub = bestSubtitle(r);
    const lat = parseCoord(r[latKey]);
    const lng = parseCoord(r[lngKey]);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="h">${escapeHtml(title)}</div>
      <div class="s">${escapeHtml(sub || "‚Äî")}</div>
      <div class="k">
        <span class="tag">Lat: ${isFinite(lat) ? lat.toFixed(6) : "-"}</span>
        <span class="tag">Lng: ${isFinite(lng) ? lng.toFixed(6) : "-"}</span>
      </div>
    `;
    div.onclick = ()=>{
      if (!isFinite(lat) || !isFinite(lng)) return;
      map.setView([lat,lng], 18, { animate:true });
      const m = markers.find(mm => mm.__id === r.__id);
      if (m) m.openPopup();
    };
    list.appendChild(div);
  }
}

function renderMap(rows){
  clearMap();
  let bad = 0, ok = 0;

  for (const r of rows){
    const lat = parseCoord(r[latKey]);
    const lng = parseCoord(r[lngKey]);

    if (!isFinite(lat) || !isFinite(lng) || Math.abs(lat)>90 || Math.abs(lng)>180){
      bad++; continue;
    }

    ok++;
    const m = L.marker([lat,lng]);
    m.__id = r.__id;
    m.bindPopup(buildPopup(r), { maxWidth: 420 });
    cluster.addLayer(m);
    markers.push(m);
  }

  $("#nShown").textContent = ok.toString();
  $("#nBad").textContent = bad.toString();

  if (ok>0){
    const b = cluster.getBounds();
    if (b.isValid()) map.fitBounds(b.pad(0.15));
  }
}

function applyFilter(){
  const q = norm($("#q").value).toLowerCase();
  if (!q){
    renderMap(allRows);
    renderList(allRows);
    return;
  }
  const filtered = allRows.filter(r=>{
    const hay = Object.values(r).map(v=>norm(v)).join(" ").toLowerCase();
    return hay.includes(q);
  });
  renderMap(filtered);
  renderList(filtered);
}

/** =========================
 *  LOAD
 *  ========================= */
async function load(){
  setBadge("LOADING");
  toast(`Ambil data <b>${escapeHtml(SHEET_NAME)}</b>...`, "info");

  try{
    const table = await fetchTable();
    const objs = tableToObjects(table);

    allRows = objs.map((o, idx)=>({ __id: idx+1, ...o }));

    const keys = Object.keys(allRows[0] || {}).filter(k=>k!=="__id");
    latKey = pickLatKey(keys);
    lngKey = pickLngKey(keys);

    $("#coordKeys").textContent = (latKey && lngKey) ? `${latKey}, ${lngKey}` : "-";

    if (!latKey || !lngKey){
      toast(
        `Gak nemu kolom koordinat üòµ‚Äçüí´<br>
         Header kebaca: <span class="mono">${escapeHtml(keys.join(", ") || "(kosong)")}</span><br>
         Pastikan ada kolom lat/lng (misal: <b>lat</b> & <b>lng</b> / <b>latitude</b> & <b>longitude</b>).`,
        "error"
      );
      setBadge("ERROR", "error");
      return;
    }

    toast(`OK. Total baris: <b>${allRows.length}</b> ‚Ä¢ Kolom: <b>${latKey}</b>/<b>${lngKey}</b>`, "ok");
    renderMap(allRows);
    renderList(allRows);

    setBadge("OK", "ok");

  }catch(err){
    console.error(err);
    toast(
      `<b>Gagal load</b> ‚ö†Ô∏è<br>${escapeHtml((err && err.message) ? err.message : String(err))}<br><br>
       <span class="muted">Kalau mode GViz ke-login, set sheet jadi publik atau pakai DATA_URL / PROXY yang benar.</span>`,
      "error"
    );
    setBadge("ERROR", "error");
  }
}

$("#btnReload").addEventListener("click", load);
$("#q").addEventListener("input", ()=>{ window.requestAnimationFrame(applyFilter); });

load();
</script>

</body>
</html>
