<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitoring Tahap 3 ‚Äî Log Progres (log_progres3)</title>

  <!-- Leaflet -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (biar titik banyak tetap enteng) -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(15,23,42,.92); --text:#e5e7eb; --muted:#a7b0c0;
      --line:rgba(255,255,255,.12); --accent:#1d5fd1; --yellow:#ffb300;
      --good:#27b06e; --bad:#ff5c7a;
      --hdrH:64px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:var(--bg)}
    header{
      position:fixed; inset:0 0 auto 0; height:var(--hdrH);
      display:flex; align-items:center; gap:12px; padding:0 16px;
      background:linear-gradient(90deg, rgba(13,71,161,.95), rgba(10,58,133,.92));
      border-bottom:1px solid rgba(255,255,255,.12); z-index:1000;
    }
    header .title{font-weight:800; letter-spacing:.2px}
    header .badge{
      margin-left:auto; font-size:12px; color:#111827; background:var(--yellow);
      padding:6px 10px; border-radius:999px; font-weight:800;
    }

    .wrap{padding-top:var(--hdrH); display:grid; grid-template-columns: 380px 1fr; height:calc(100vh - var(--hdrH));}
    aside{
      border-right:1px solid var(--line);
      background:rgba(11,18,34,.65);
      padding:14px;
      overflow:auto;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted); font-size:12px}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; font-weight:700;
    }
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:rgba(29,95,209,.22); border-color:rgba(29,95,209,.55)}
    input, select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(167,176,192,.8)}
    .stat{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      font-size:12px; font-weight:800;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--good)}
    .dot.bad{background:var(--bad)}
    #list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:14px; padding:10px;
      cursor:pointer;
    }
    .item:hover{border-color:rgba(255,255,255,.28)}
    .item .h{font-weight:800; font-size:13px}
    .item .s{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.25}
    .item .k{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tag{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text);
    }
    #map{height:100%; width:100%}
    .toast{
      position:fixed; left:16px; bottom:16px; z-index:2000;
      max-width:min(560px, calc(100vw - 32px));
      background:rgba(15,23,42,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:none;
    }
    .toast.show{display:block}
    .toast b{color:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; grid-template-rows: 380px 1fr}
      aside{border-right:none; border-bottom:1px solid var(--line)}
    }
  </style>

</head>
<body>
<header>
  <div class="title">Monitoring Tahap 3 ‚Ä¢ <span class="muted">Sheet:</span> log_progres3</div>
  <div class="badge" id="badgeStatus">READY</div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">Sumber Data</div>
          <div class="muted">Google Sheets (GViz) ‚Üí Peta</div>
        </div>
        <button class="btn primary" id="btnReload">Reload</button>
      </div>

```
  <div style="height:10px"></div>

  <div class="muted" style="margin-bottom:6px">Cari</div>
  <input id="q" placeholder="ketik nama / desa / keterangan..." />

  <div style="height:10px"></div>

  <div class="stat">
    <div class="pill"><span class="dot" id="dotOk"></span> Titik tampil: <span id="nShown">0</span></div>
    <div class="pill"><span class="dot bad"></span> Koordinat invalid: <span id="nBad">0</span></div>
  </div>

  <div style="height:10px"></div>
  <div class="muted">
    Tips: kalau CORS nabrak, aktifin PROXY di konfigurasi (lihat bagian CONFIG).
  </div>
</div>

<div class="card">
  <div style="font-weight:900; margin-bottom:8px">Daftar Titik</div>
  <div id="list"></div>
</div>
```

  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  CONFIG (EDIT INI AJA BRO)
 *  ========================= */
const SHEET_ID   = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY";
const SHEET_NAME = "log_progres3";

/**
 * Kalau fetch langsung ke docs.google.com kena CORS,
 * isi PROXY dengan endpoint yang lo punya (Cloudflare Worker / Apps Script proxy).
 *
 * Contoh:
 * const PROXY = "https://gas-proxy3.tuic1677.workers.dev/?url=";
 *
 * Format yang dipakai: PROXY + encodeURIComponent(gvizUrl)
 */
const PROXY = "https://gas-proxy3.tuic1677.workers.dev/?url="; // <- isi kalau perlu, kalau gak: biarin "".

/** Pusat peta awal (Indonesia) */
const MAP_INIT = { center: [-2.5, 118.0], zoom: 5 };

/** =========================
 *  UTIL
 *  ========================= */
const $ = (s)=>document.querySelector(s);
function toast(msg, kind="info"){
  const t = $("#toast");
  t.innerHTML = msg;
  t.classList.add("show");
  $("#badgeStatus").textContent = kind.toUpperCase();
  $("#badgeStatus").style.background = kind==="error" ? "var(--bad)" : "var(--yellow)";
  $("#badgeStatus").style.color = kind==="error" ? "#fff" : "#111827";
  setTimeout(()=>t.classList.remove("show"), 5200);
}
function norm(s){ return (s??"").toString().trim(); }
function normKey(s){
  return norm(s).toLowerCase()
    .replace(/\s+/g,"_")
    .replace(/[^\w]/g,"");
}
function isNum(x){ return typeof x==="number" && isFinite(x); }

function pickLatKey(keys){
  const candidates = ["lat","latitude","lintang","y","koord_y","koordinat_y"];
  const k = keys.find(k => candidates.includes(k));
  if (k) return k;
  // fallback fuzzy
  return keys.find(k => k.includes("lat") || k.includes("lintang"));
}
function pickLngKey(keys){
  const candidates = ["lng","lon","long","longitude","bujur","x","koord_x","koordinat_x"];
  const k = keys.find(k => candidates.includes(k));
  if (k) return k;
  return keys.find(k => k.includes("lng") || k.includes("lon") || k.includes("long") || k.includes("bujur"));
}

function bestTitle(obj){
  const keys = Object.keys(obj);
  const prefs = ["nama","name","judul","lokasi","desa","kecamatan","kabupaten","di","daerah_irigasi","bws","balai"];
  for (const p of prefs){
    const k = keys.find(k=>k===p);
    if (k && norm(obj[k])) return norm(obj[k]);
  }
  // fallback: first non-empty string field
  for (const k of keys){
    const v = obj[k];
    if (typeof v==="string" && norm(v)) return norm(v);
  }
  return "Titik";
}
function bestSubtitle(obj){
  const keys = Object.keys(obj);
  const prefs = ["keterangan","ket","catatan","progress","uraian","status","tanggal","waktu","timestamp"];
  for (const p of prefs){
    const k = keys.find(k=>k===p);
    if (k && norm(obj[k])) return norm(obj[k]);
  }
  return "";
}

function maybeLinkify(v){
  const s = norm(v);
  if (!s) return "";
  // url
  if (/^https?:\/\/\S+/i.test(s)) {
    return `<a href="${s}" target="_blank" rel="noopener">Buka Link</a>`;
  }
  // drive file id patterns not handled; keep plain
  return s.replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/** =========================
 *  MAP INIT
 *  ========================= */
const map = L.map("map", { zoomControl:true }).setView(MAP_INIT.center, MAP_INIT.zoom);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const cluster = L.markerClusterGroup({
  chunkedLoading:true,
  chunkInterval: 150,
  chunkDelay: 20
});
map.addLayer(cluster);

let allRows = [];
let markers = [];
let latKey = null;
let lngKey = null;

/** =========================
 *  GViz FETCH + PARSE
 *  ========================= */
async function fetchGViz(){
const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
const finalUrl = PROXY ? (PROXY + encodeURIComponent(url)) : url;

const res = await fetch(finalUrl, { cache:"no-store" });
const txt = await res.text();
// ...lanjutin isi fetchGViz lo yang patch kemarin...
}

// 1) Kalau yang balik HTML (login / error page), kasih error jelas
const head = (txt || "").slice(0, 300).toLowerCase();
if (head.includes("<html") || head.includes("<!doctype html")) {
throw new Error(
"Yang kebaca HTML (login/redirect/error page), bukan GViz. " +
"Biasanya karena sheet belum publik atau proxy nge-redirect."
);
}

// 2) Coba parse sebagai JSON langsung (beberapa proxy ngembaliin JSON wrapper)
//    Contoh wrapper umum: { contents: "...." } / { body: "...." } / { data: "...." }
let maybe = null;
try { maybe = JSON.parse(txt); } catch(e) {}

// Kalau sudah bentuk GViz JSON: { table: {...} }
if (maybe && maybe.table) return maybe.table;

// Kalau bentuk: { data: { table: {...} } }
if (maybe && maybe.data && maybe.data.table) return maybe.data.table;

// Kalau wrapper string: { contents/body/data: "google.visualization..." }
if (maybe && (typeof maybe.contents === "string" || typeof maybe.body === "string" || typeof maybe.data === "string")) {
const inner = (maybe.contents || maybe.body || maybe.data || "").toString();
return parseGVizText(inner);
}

// 3) Kalau bukan JSON wrapper, anggap GViz text normal
return parseGVizText(txt);
}

function parseGVizText(rawText){
const s = (rawText || "").trim();

// format GViz: google.visualization.Query.setResponse({...});
const m = s.match(/setResponse(([\s\S]+))\s*;?\s*$/);
if (!m) {
// bantu debug: tunjukin potongan awal response
throw new Error("Respon bukan format GViz. Potongan awal: " + s.slice(0, 160));
}

let data;
try {
data = JSON.parse(m[1]);
} catch(e){
throw new Error("GViz ketemu tapi JSON-nya gagal diparse. Potongan: " + m[1].slice(0, 160));
}

if (!data || !data.table) {
throw new Error("GViz ter-parse tapi tidak ada data.table. Cek izin sheet / sheet name.");
}
return data.table;
}


/** =========================
 *  RENDER
 *  ========================= */
function clearMap(){
  cluster.clearLayers();
  markers = [];
}
function buildPopup(obj){
  const title = bestTitle(obj);
  const sub = bestSubtitle(obj);
  const keys = Object.keys(obj);

  // tampilkan field penting dulu (kalau ada)
  const priority = ["timestamp","waktu","tanggal","status","progress","keterangan","desa","kecamatan","kabupaten","provinsi","bws","di","daerah_irigasi","foto","photo","image","url","link"];
  const shown = new Set();

  function row(k){
    const v = obj[k];
    if (v===null || v===undefined || v==="") return "";
    shown.add(k);
    // gambar jika kelihatan seperti url image
    const s = norm(v);
    const isImg = /^https?:\/\/\S+\.(png|jpg|jpeg|webp|gif)(\?\S*)?$/i.test(s);
    const val = isImg
      ? `<div style="margin-top:6px"><img src="${s}" alt="foto" style="width:100%;max-width:360px;border-radius:12px;border:1px solid rgba(255,255,255,.12)"></div>`
      : `<span>${maybeLinkify(v)}</span>`;
    return `<div style="padding:6px 0;border-top:1px solid rgba(255,255,255,.10)">
      <div style="font-size:11px;color:#a7b0c0;font-weight:800">${k.toUpperCase()}</div>
      <div style="font-size:12px;line-height:1.25">${val}</div>
    </div>`;
  }

  let html = `
    <div style="min-width:240px;max-width:380px">
      <div style="font-weight:900;font-size:14px">${title}</div>
      ${sub ? `<div style="font-size:12px;color:#a7b0c0;margin-top:4px">${sub}</div>` : ""}
  `;

  for (const p of priority){
    if (obj[p]!==undefined) html += row(p);
  }
  // sisanya
  for (const k of keys){
    if (shown.has(k)) continue;
    if (k===latKey || k===lngKey) continue;
    html += row(k);
  }

  html += `</div>`;
  return html;
}

function renderList(rows){
  const list = $("#list");
  list.innerHTML = "";
  if (!rows.length){
    list.innerHTML = `<div class="muted">Tidak ada data yang cocok.</div>`;
    return;
  }

  for (const r of rows){
    const title = bestTitle(r);
    const sub = bestSubtitle(r);
    const lat = parseCoord(r[latKey]);
    const lng = parseCoord(r[lngKey]);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="h">${title}</div>
      <div class="s">${sub || "‚Äî"}</div>
      <div class="k">
        <span class="tag">Lat: ${isFinite(lat) ? lat.toFixed(6) : "-"}</span>
        <span class="tag">Lng: ${isFinite(lng) ? lng.toFixed(6) : "-"}</span>
      </div>
    `;
    div.onclick = ()=>{
      if (!isFinite(lat) || !isFinite(lng)) return;
      map.setView([lat,lng], 18, { animate:true });
      const m = markers.find(mm => mm.__id === r.__id);
      if (m) m.openPopup();
    };
    list.appendChild(div);
  }
}

function renderMap(rows){
  clearMap();

  let bad = 0, ok = 0;

  for (const r of rows){
    const lat = parseCoord(r[latKey]);
    const lng = parseCoord(r[lngKey]);
    if (!isFinite(lat) || !isFinite(lng) || Math.abs(lat)>90 || Math.abs(lng)>180){
      bad++; continue;
    }
    ok++;
    const m = L.marker([lat,lng]);
    m.__id = r.__id;
    m.bindPopup(buildPopup(r), { maxWidth: 420 });
    cluster.addLayer(m);
    markers.push(m);
  }

  $("#nShown").textContent = ok.toString();
  $("#nBad").textContent = bad.toString();

  if (ok>0){
    const b = cluster.getBounds();
    if (b.isValid()) map.fitBounds(b.pad(0.15));
  }
}

/** =========================
 *  FILTER
 *  ========================= */
function applyFilter(){
  const q = norm($("#q").value).toLowerCase();
  if (!q){
    renderMap(allRows);
    renderList(allRows);
    return;
  }
  const filtered = allRows.filter(r=>{
    const hay = Object.values(r).map(v=>norm(v)).join(" ").toLowerCase();
    return hay.includes(q);
  });
  renderMap(filtered);
  renderList(filtered);
}

/** =========================
 *  LOAD
 *  ========================= */
async function load(){
  $("#badgeStatus").textContent = "LOADING";
  $("#badgeStatus").style.background = "var(--yellow)";
  $("#badgeStatus").style.color = "#111827";
  toast(`Ambil data sheet <b>${SHEET_NAME}</b>...`, "info");

  try{
    const table = await fetchGViz();
    const objs = tableToObjects(table);

    // add id
    allRows = objs.map((o, idx)=>({ __id: idx+1, ...o }));

    // detect lat/lng
    const keys = Object.keys(allRows[0] || {}).filter(k=>k!=="__id");
    latKey = pickLatKey(keys);
    lngKey = pickLngKey(keys);

    if (!latKey || !lngKey){
      toast(
        `Gak nemu kolom koordinat üòµ‚Äçüí´<br>
         Header yang kebaca: <span class="mono">${keys.join(", ") || "(kosong)"}</span><br>
         Pastikan ada kolom lat/lng (misal: <b>lat</b> & <b>lng</b> / <b>latitude</b> & <b>longitude</b>).`,
        "error"
      );
      $("#badgeStatus").textContent = "ERROR";
      return;
    }

    toast(`OK. Deteksi kolom: <b>${latKey}</b> & <b>${lngKey}</b>. Total baris: <b>${allRows.length}</b>`, "info");

    renderMap(allRows);
    renderList(allRows);

    $("#badgeStatus").textContent = "OK";
    $("#badgeStatus").style.background = "var(--good)";
    $("#badgeStatus").style.color = "#fff";

  }catch(err){
    console.error(err);
    toast(
      `<b>Gagal load</b> ‚ö†Ô∏è<br>${(err && err.message) ? err.message : err}<br><br>
       Kalau ini CORS/redirect login, aktifkan <b>PROXY</b> di CONFIG.`,
      "error"
    );
  }
}

$("#btnReload").addEventListener("click", load);
$("#q").addEventListener("input", ()=>{ window.requestAnimationFrame(applyFilter); });

load();
</script>

</body>
</html>
