<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monitoring Tahap 3 - INPRES 2/2025</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
body{
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Roboto;
  background:#0b1224;
  color:#e5e7eb;
}
header{
  padding:14px 16px;
  background:#0c1326;
  border-bottom:1px solid #1f2937;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header h1{
  font-size:16px;
  margin:0;
}
header span{
  font-size:12px;
  color:#94a3b8;
}
#toolbar{
  padding:10px;
  background:#0f172a;
  border-bottom:1px solid #1f2937;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
select{
  padding:8px 10px;
  background:#020617;
  border:1px solid #334155;
  color:#e5e7eb;
  border-radius:10px;
}
#map{
  height: calc(100vh - 112px);
  width:100%;
}
.popup h3{
  margin:0 0 6px;
  font-size:14px;
}
.popup small{
  color:#94a3b8;
}
.popup a{
  display:inline-block;
  margin-top:6px;
  color:#60a5fa;
  font-weight:700;
  text-decoration:none;
}
.popup a:hover{ text-decoration:underline; }
</style>
</head>

<body>

<header>
  <div>
    <h1>Monitoring Tahap 3</h1>
    <span>INPRES 2/2025 · Peta Progres Lapangan</span>
  </div>
  <a href="Form_Tahap3.html" style="color:#93c5fd;text-decoration:none;font-weight:700">Form</a>
</header>

<div id="toolbar">
  <select id="bws">
    <option value="">Semua B/BWS</option>
  </select>
  <select id="prov">
    <option value="">Semua Provinsi</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const API = "https://gas-proxy3.tuic1677.workers.dev/";
const $ = id=>document.getElementById(id);

const map = L.map('map').setView([-2.5,118],5);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'© OpenStreetMap'
}).addTo(map);

const esri = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'© Esri' }
);

L.control.layers({OSM:osm,"Esri Imagery":esri}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

function iconByStage(stage){
  let color = "#94a3b8";
  if(stage>=100) color="#22c55e";
  else if(stage>=75) color="#f97316";
  else if(stage>=50) color="#3b82f6";
  else if(stage>=25) color="#facc15";

  return L.divIcon({
    className:'',
    html:`<div style="
      width:14px;height:14px;
      background:${color};
      border-radius:50%;
      border:2px solid #020617;
      "></div>`
  });
}

let raw=[];

function fillFilters(){
  const bws=[...new Set(raw.map(r=>r.balai))].sort();
  const prov=[...new Set(raw.map(r=>r.provinsi))].sort();
  bws.forEach(v=>$('#bws').append(new Option(v,v)));
  prov.forEach(v=>$('#prov').append(new Option(v,v)));
}

function render(){
  cluster.clearLayers();

  const fbws=$('#bws').value;
  const fprov=$('#prov').value;

  raw.filter(r=>{
    if(fbws && r.balai!==fbws) return false;
    if(fprov && r.provinsi!==fprov) return false;
    return true;
  }).forEach(r=>{
    if(!r.coords) return;

    const lastPhoto =
      r.photos["100"] || r.photos["75"] || r.photos["50"] || r.photos["25"];

    const m=L.marker(
      [r.coords.lat, r.coords.lng],
      {icon:iconByStage(r.maxStage)}
    );

    m.bindPopup(`
      <div class="popup">
        <h3>${r.di}</h3>
        <small>${r.balai}<br>${r.provinsi} · ${r.kabupaten}</small><br>
        <b>Progres: ${r.maxStage}%</b><br>
        ${lastPhoto ? `<a href="${lastPhoto.url}" target="_blank">Buka Foto</a>` : '<small>Belum ada foto</small>'}
      </div>
    `);

    cluster.addLayer(m);
  });
}

async function load(){
  const res=await fetch(API+'?fn=monitor&t='+Date.now());
  const json=await res.json();
  raw=json.items||[];
  fillFilters();
  render();
}

$('#bws').onchange=render;
$('#prov').onchange=render;

load();
</script>
</body>
</html>
