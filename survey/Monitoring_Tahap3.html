<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Monitoring Tahap 3 — log_progres3 (Peta)</title>

  <!-- Leaflet -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(15,23,42,.92); --text:#e5e7eb; --muted:#a7b0c0;
      --line:rgba(255,255,255,.12); --yellow:#ffb300; --good:#27b06e; --bad:#ff5c7a;
      --hdrH:64px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:var(--bg)}
    header{
      position:fixed; inset:0 0 auto 0; height:var(--hdrH);
      display:flex; align-items:center; gap:12px; padding:0 16px;
      background:linear-gradient(90deg, rgba(13,71,161,.95), rgba(10,58,133,.92));
      border-bottom:1px solid rgba(255,255,255,.12); z-index:1000;
    }
    header .title{font-weight:900; letter-spacing:.2px}
    header .badge{
      margin-left:auto; font-size:12px; color:#111827; background:var(--yellow);
      padding:6px 10px; border-radius:999px; font-weight:900;
    }

    .wrap{padding-top:var(--hdrH); display:grid; grid-template-columns: 390px 1fr; height:calc(100vh - var(--hdrH));}
    aside{
      border-right:1px solid var(--line);
      background:rgba(11,18,34,.65);
      padding:14px;
      overflow:auto;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted); font-size:12px}
    .btn{
      cursor:pointer; border:1px solid var(--line); background:rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px; font-weight:900;
    }
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:rgba(29,95,209,.22); border-color:rgba(29,95,209,.55)}
    input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:rgba(255,255,255,.06); color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(167,176,192,.8)}
    .stat{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.06);
      font-size:12px; font-weight:900;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:var(--good)}
    .dot.bad{background:var(--bad)}
    #list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      border-radius:14px; padding:10px;
      cursor:pointer;
    }
    .item:hover{border-color:rgba(255,255,255,.28)}
    .item .h{font-weight:900; font-size:13px}
    .item .s{font-size:12px; color:var(--muted); margin-top:4px; line-height:1.25}
    .item .k{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tag{
      font-size:11px; padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text);
    }
    #map{height:100%; width:100%}
    .toast{
      position:fixed; left:16px; bottom:16px; z-index:2000;
      max-width:min(720px, calc(100vw - 32px));
      background:rgba(15,23,42,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:none;
    }
    .toast.show{display:block}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; grid-template-rows: 380px 1fr}
      aside{border-right:none; border-bottom:1px solid var(--line)}
    }
  </style>

</head>

<body>
<header>
  <div class="title">Monitoring Tahap 3 • <span class="muted">Sheet:</span> log_progres3</div>
  <div class="badge" id="badgeStatus">READY</div>
</header>

<div class="wrap">
  <aside>
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:900">Sumber Data</div>
          <div class="muted">Kolom fixed sesuai sheet</div>
        </div>
        <button class="btn primary" id="btnReload">Reload</button>
      </div>

```
  <div style="height:10px"></div>

  <div class="muted" style="margin-bottom:6px">Cari</div>
  <input id="q" placeholder="contoh: Piji / Sragen / 75 / Irwan ..." />

  <div style="height:10px"></div>

  <div class="stat">
    <div class="pill"><span class="dot"></span> Titik tampil: <span id="nShown">0</span></div>
    <div class="pill"><span class="dot bad"></span> Koordinat invalid: <span id="nBad">0</span></div>
  </div>

  <div style="height:10px"></div>

  <div class="muted">
    Mode: <span class="mono" id="mode">-</span><br/>
    Kolom koordinat: <span class="mono">lat, lng</span>
  </div>

  <div style="height:10px"></div>
  <div class="muted">
    Kalau kamu pakai endpoint JSON yang return <span class="mono">{ok:true, items:[...]}</span>, isi <b>DATA_URL</b>.
    Kalau mau GViz, kosongkan DATA_URL lalu isi PROXY bila perlu.
  </div>
</div>

<div class="card">
  <div style="font-weight:900; margin-bottom:8px">Daftar Titik</div>
  <div id="list"></div>
</div>
```

  </aside>

  <main>
    <div id="map"></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/** =========================
 *  CONFIG (EDIT INI SAJA)
 *  ========================= */

// Google Sheet
const SHEET_ID   = "1YkNmEcQw1_1_xL0BTxYXl1f4Tkk2-22tXuQB-IoEeuY";
const SHEET_NAME = "log_progres3";

/**
 * PILIH SALAH SATU SUMBER:
 * 1) DATA_URL: endpoint JSON kamu (misal GAS/Worker) yang mengembalikan:
 *    { ok:true, items:[ {timestamp,key,balai,...,lat,lng,...} ] }
 *
 * 2) Jika DATA_URL kosong, script akan coba GViz:
 *    https://docs.google.com/spreadsheets/d/<ID>/gviz/tq?tqx=out:json&sheet=log_progres3
 *    Kalau GViz kena CORS/login, isi PROXY.
 */
const DATA_URL = "https://script.google.com/macros/s/AKfycbwixAzu4MFs8Ms-K1sWMqCYmesje762mPYRW9uxkBCxbiTswKiaykXzD-D76naKlPWa/exec"; // <-- isi ini kalau sudah punya endpoint JSON {ok:true,items:[...]}
const PROXY    = ""; // <-- contoh: "https://gas-proxy3.tuic1677.workers.dev/?url="

// Pusat peta awal
const MAP_INIT = { center: [-2.5, 118.0], zoom: 5 };

/** =========================
 *  KOLom yang ditampilkan (fixed)
 *  ========================= */
const FIELDS = [
  "timestamp","key","balai","provinsi","kabupaten","di","kecamatan","desa",
  "lat","lng","nama","telepon","progress","foto_url"
];

/** =========================
 *  UTIL
 *  ========================= */
const $ = (s)=>document.querySelector(s);

function setBadge(text, kind="info"){
  $("#badgeStatus").textContent = text;
  if (kind==="error"){
    $("#badgeStatus").style.background = "var(--bad)";
    $("#badgeStatus").style.color = "#fff";
  } else if (kind==="ok"){
    $("#badgeStatus").style.background = "var(--good)";
    $("#badgeStatus").style.color = "#fff";
  } else {
    $("#badgeStatus").style.background = "var(--yellow)";
    $("#badgeStatus").style.color = "#111827";
  }
}
function toast(msg, kind="info"){
  const t = $("#toast");
  t.innerHTML = msg;
  t.classList.add("show");
  setBadge(kind.toUpperCase(), kind==="error" ? "error" : "info");
  setTimeout(()=>t.classList.remove("show"), 5200);
}

function norm(s){ return (s??"").toString().trim(); }
function escapeHtml(s){
  return norm(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function maybeLinkify(v){
  const s = norm(v);
  if (!s) return "";
  if (/^https?:\/\/\S+/i.test(s)) return `<a href="${escapeHtml(s)}" target="_blank" rel="noopener">Buka Link</a>`;
  return escapeHtml(s);
}
function parseCoord(v){
  if (v===null || v===undefined) return NaN;
  if (typeof v === "number") return v;
  const s = norm(v).replace(",", ".");
  return parseFloat(s);
}

/** =========================
 *  MAP INIT
 *  ========================= */
const map = L.map("map").setView(MAP_INIT.center, MAP_INIT.zoom);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const cluster = L.markerClusterGroup({ chunkedLoading:true, chunkInterval:150, chunkDelay:20 });
map.addLayer(cluster);

let allRows = [];
let markers = [];

/** =========================
 *  FETCH: JSON (ok/items) atau GViz
 *  ========================= */
function gvizUrl(){
  const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
  return `${base}?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
}
function parseGVizText(rawText){
  const s = (rawText || "").trim();
  const m = s.match(/setResponse\(([\s\S]+)\)\s*;?\s*$/);
  if (!m) throw new Error("Respon bukan format GViz. Potongan awal: " + s.slice(0, 160));
  const data = JSON.parse(m[1]);
  if (!data || !data.table) throw new Error("GViz ter-parse tapi tidak ada data.table.");
  return data.table;
}
function tableToObjects(table){
  const cols = (table.cols||[]).map(c => norm(c.label || c.id || "").toLowerCase().replace(/\s+/g,"_"));
  const rows = table.rows || [];
  const out = [];
  for (const r of rows){
    const o = {};
    (r.c||[]).forEach((cell, i)=>{
      const key = cols[i] || `col_${i+1}`;
      let v = cell ? (cell.f ?? cell.v) : null;
      if (typeof v === "string") v = v.trim();
      o[key] = v;
    });
    // hanya ambil field yang kita butuhkan
    const filtered = {};
    for (const f of FIELDS){
      filtered[f] = (o[f]!==undefined) ? o[f] : null;
    }
    const hasAny = Object.values(filtered).some(v => v !== null && v !== "");
    if (hasAny) out.push(filtered);
  }
  return out;
}

async function fetchRows(){
  // 1) DATA_URL (JSON ok/items)
  if (DATA_URL){
    $("#mode").textContent = "DATA_URL (JSON ok/items)";
    const res = await fetch(DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "t=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    const j = await res.json();

    let items = null;
    if (Array.isArray(j)) items = j;
    else if (j && j.ok === true && Array.isArray(j.items)) items = j.items;

    if (!items) throw new Error("DATA_URL harus mengembalikan array atau {ok:true, items:[...]}");

    // normalize + ambil field fixed
    return items.map(it=>{
      const o = {};
      for (const f of FIELDS){
        o[f] = (it && Object.prototype.hasOwnProperty.call(it, f)) ? it[f] : null;
      }
      return o;
    });
  }

  // 2) GViz direct / via PROXY
  const url = gvizUrl();
  const finalUrl = PROXY ? (PROXY + encodeURIComponent(url)) : url;
  $("#mode").textContent = PROXY ? "GViz via PROXY" : "GViz direct";

  const res = await fetch(finalUrl, { cache:"no-store" });
  const txt = await res.text();

  const head = (txt || "").slice(0, 300).toLowerCase();
  if (head.includes("<html") || head.includes("<!doctype html")) {
    throw new Error("Yang kebaca HTML login/redirect. Sheet belum publik atau proxy salah.");
  }

  // kalau proxy ngembaliin JSON (misal ok/items)
  let maybe = null;
  try { maybe = JSON.parse(txt); } catch(e) {}

  if (maybe && maybe.ok === true && Array.isArray(maybe.items)) {
    $("#mode").textContent += " (ok/items)";
    return maybe.items.map(it=>{
      const o = {};
      for (const f of FIELDS){
        o[f] = (it && Object.prototype.hasOwnProperty.call(it, f)) ? it[f] : null;
      }
      return o;
    });
  }

  const table = parseGVizText(txt);
  return tableToObjects(table);
}

/** =========================
 *  RENDER
 *  ========================= */
function clearMap(){
  cluster.clearLayers();
  markers = [];
}

function buildPopup(r){
  const title = escapeHtml(norm(r.di) || "DI (tanpa nama)");
  const sub = escapeHtml([r.desa, r.kecamatan, r.kabupaten, r.provinsi].filter(Boolean).join(" • "));

  function row(label, value){
    if (value===null || value===undefined || value==="") return "";

    const v = norm(value);

    if (label === "foto_url" && /^https?:\/\/\S+/i.test(v)){
      const isImg = /^https?:\/\/\S+\.(png|jpg|jpeg|webp|gif)(\?\S*)?$/i.test(v);
      return `
        <div style="padding:6px 0;border-top:1px solid rgba(255,255,255,.10)">
          <div style="font-size:11px;color:#a7b0c0;font-weight:900">FOTO</div>
          <div style="margin-top:6px">
            <a href="${escapeHtml(v)}" target="_blank" rel="noopener">Buka Foto</a>
            ${isImg ? `<div style="margin-top:8px">
              <img src="${escapeHtml(v)}" alt="foto" style="width:100%;max-width:360px;border-radius:12px;border:1px solid rgba(255,255,255,.12)">
            </div>` : ``}
          </div>
        </div>`;
    }

    return `
      <div style="padding:6px 0;border-top:1px solid rgba(255,255,255,.10)">
        <div style="font-size:11px;color:#a7b0c0;font-weight:900">${escapeHtml(label.toUpperCase())}</div>
        <div style="font-size:12px;line-height:1.25">${maybeLinkify(v)}</div>
      </div>`;
  }

  let html = `
    <div style="min-width:240px;max-width:380px">
      <div style="font-weight:900;font-size:14px">${title}</div>
      ${sub ? `<div style="font-size:12px;color:#a7b0c0;margin-top:4px">${sub}</div>` : ""}
  `;

  // urutan sesuai request
  for (const f of FIELDS){
    html += row(f, r[f]);
  }

  html += `</div>`;
  return html;
}

function renderList(rows){
  const list = $("#list");
  list.innerHTML = "";
  if (!rows.length){
    list.innerHTML = `<div class="muted">Tidak ada data yang cocok.</div>`;
    return;
  }

  for (const r of rows){
    const diName = norm(r.di) || "DI (tanpa nama)";
    const lokasi = [r.desa, r.kecamatan, r.kabupaten, r.provinsi].filter(Boolean).join(" • ");
    const prog = (r.progress!==null && r.progress!==undefined && r.progress!=="") ? `${r.progress}%` : "-";

    const lat = parseCoord(r.lat);
    const lng = parseCoord(r.lng);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="h">${escapeHtml(diName)}</div>
      <div class="s">${escapeHtml(lokasi || "—")}</div>
      <div class="k">
        <span class="tag">Progress: ${escapeHtml(prog)}</span>
        <span class="tag">Nama: ${escapeHtml(norm(r.nama) || "-")}</span>
      </div>
    `;

    div.onclick = ()=>{
      if (!isFinite(lat) || !isFinite(lng)) return;
      map.setView([lat,lng], 18, { animate:true });
      const m = markers.find(mm => mm.__id === r.__id);
      if (m) m.openPopup();
    };

    list.appendChild(div);
  }
}

function renderMap(rows){
  clearMap();
  let bad = 0, ok = 0;

  for (const r of rows){
    const lat = parseCoord(r.lat);
    const lng = parseCoord(r.lng);

    if (!isFinite(lat) || !isFinite(lng) || Math.abs(lat)>90 || Math.abs(lng)>180){
      bad++; continue;
    }

    ok++;
    const m = L.marker([lat,lng]);
    m.__id = r.__id;
    m.bindPopup(buildPopup(r), { maxWidth: 420 });
    cluster.addLayer(m);
    markers.push(m);
  }

  $("#nShown").textContent = ok.toString();
  $("#nBad").textContent = bad.toString();

  if (ok>0){
    const b = cluster.getBounds();
    if (b.isValid()) map.fitBounds(b.pad(0.15));
  }
}

function applyFilter(){
  const q = norm($("#q").value).toLowerCase();
  if (!q){
    renderMap(allRows);
    renderList(allRows);
    return;
  }
  const filtered = allRows.filter(r=>{
    const hay = FIELDS.map(f => norm(r[f])).join(" ").toLowerCase();
    return hay.includes(q);
  });
  renderMap(filtered);
  renderList(filtered);
}

/** =========================
 *  LOAD
 *  ========================= */
async function load(){
  setBadge("LOADING");
  toast(`Ambil data <b>${escapeHtml(SHEET_NAME)}</b>...`, "info");

  try{
    const rows = await fetchRows();
    allRows = rows.map((o, idx)=>({ __id: idx+1, ...o }));

    toast(`OK. Total baris: <b>${allRows.length}</b> • Kolom: <b>lat/lng</b>`, "ok");
    renderMap(allRows);
    renderList(allRows);

    setBadge("OK", "ok");

  }catch(err){
    console.error(err);
    toast(`<b>Gagal load</b> ⚠️<br>${escapeHtml((err && err.message) ? err.message : String(err))}`, "error");
    setBadge("ERROR", "error");
  }
}

$("#btnReload").addEventListener("click", load);
$("#q").addEventListener("input", ()=>{ window.requestAnimationFrame(applyFilter); });

load();
</script>

</body>
</html>
