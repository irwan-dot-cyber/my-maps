<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoring Tahap 3 ‚Äî INPRES 2/2025</title>

  <style>
    :root{
      --bg:#0b1224; --panel:#0f172a; --border:#1f2937;
      --text:#e5e7eb; --mut:#9aa3b2;
      --good:#22c55e; --warn:#f59e0b; --bad:#fb7185; --accent:#3b82f6;
      --r:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:#0c1326; position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .hdr-left{display:flex;flex-direction:column;gap:2px}
    .hdr-left strong{font-size:16px;line-height:1.2}
    .hdr-left span{font-size:12px;color:var(--mut)}
    .btn-home{
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
      padding:9px 12px; border-radius:999px;
      background:#0b1224; color:var(--text); border:1px solid #334155;
      font-weight:700; font-size:13px;
    }
    .btn-home:hover{filter:brightness(1.05)}
    main{max-width:1200px;margin:0 auto;padding:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
    .body{padding:12px 14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--mut);display:block;margin:2px 0 6px}
    select,input{
      width:100%; padding:10px 12px;border-radius:12px;border:1px solid #334155;
      background:#0b1224;color:var(--text); outline:none;
    }
    select:disabled{opacity:.6}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .btn{
      cursor:pointer;border:1px solid #334155;background:#0b1224;color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:800;font-size:13px;
    }
    .btn.primary{background:var(--accent);border-color:transparent;color:#081225}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:var(--mut);margin-top:8px;line-height:1.4}
    .toast{
      margin:10px 14px;padding:10px 12px;border-radius:12px;
      background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none;
      font-size:13px;
    }
    .toast.bad{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.35);color:#fecaca}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid #334155;border-radius:999px;background:#0b1224;
      font-size:12px;color:var(--text);font-weight:800;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)} .dot.gray{background:#94a3b8}

    /* Table */
    .tablewrap{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    table{width:100%;border-collapse:collapse;background:#0b1224}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:middle}
    th{font-size:12px;color:var(--mut);text-align:left;background:rgba(255,255,255,.03);position:sticky;top:0;z-index:1}
    td{font-size:13px}
    .mono{font-variant-numeric:tabular-nums}
    .nowrap{white-space:nowrap}
    .muted{color:var(--mut)}
    .mini{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:34px;height:28px;border-radius:10px;border:1px solid #334155;background:rgba(255,255,255,.02);
      font-weight:900;font-size:12px;
    }
    .ok{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.10);color:#bbf7d0}
    .no{border-color:rgba(148,163,184,.25);background:rgba(148,163,184,.06);color:#cbd5e1}
    .warn{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.10);color:#fde68a}
    .actions a{
      color:#93c5fd;text-decoration:none;font-weight:800
    }
    .actions a:hover{text-decoration:underline}
    .stickyHead{position:sticky;top:0}

    /* Mobile: lebih simpel */
    @media (max-width:600px){
      th:nth-child(3), td:nth-child(3){display:none;}  /* Prov hide */
      th:nth-child(4), td:nth-child(4){display:none;}  /* Kab hide */
      th:nth-child(2), td:nth-child(2){max-width:190px}
    }
  </style>
</head>
<body>
<header>
  <div class="hdr-left">
    <strong>Monitoring Tahap 3</strong>
    <span>INPRES 2/2025 ¬∑ Rekap upload progres Tahap 3</span>
  </div>
  <a class="btn-home" href="https://irwan-dot-cyber.github.io/my-maps/landingpage/beranda.html">Beranda</a>
</header>

<main>
  <div class="card">
    <h2>Filter</h2>
    <div id="toast" class="toast"></div>

    <div class="body">
      <div class="row">
        <div>
          <label>B/BWS</label>
          <select id="bws" title="Pilih B/BWS"></select>
        </div>
        <div>
          <label>Provinsi</label>
          <select id="prov" title="Pilih Provinsi" disabled></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Kabupaten/Kota</label>
          <select id="kab" title="Pilih Kabupaten/Kota" disabled></select>
        </div>
        <div>
          <label>Cari DI (opsional)</label>
          <input id="q" placeholder="ketik nama DI‚Ä¶" title="Cari DI"/>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn primary" id="btnRefresh">üîÑ Ambil data monitoring</button>
        <button class="btn" id="btnReset">‚Ü©Ô∏è Reset filter</button>
        <span class="hint" id="stat">Siap.</span>
      </div>

      <div class="chips" id="chips" style="display:none">
        <span class="chip"><span class="dot good"></span> 100%</span>
        <span class="chip"><span class="dot warn"></span> ada sebagian</span>
        <span class="chip"><span class="dot gray"></span> belum upload</span>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:52px">No</th>
              <th>DI</th>
              <th>Prov</th>
              <th>Kab</th>
              <th class="nowrap">25%</th>
              <th class="nowrap">50%</th>
              <th class="nowrap">75%</th>
              <th class="nowrap">100%</th>
              <th class="nowrap">Terakhir</th>
              <th class="nowrap">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="muted">Belum ada data. Klik ‚ÄúAmbil data monitoring‚Äù.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="hint">
        Data diambil dari <span class="mono">log_tahap3</span> (GAS) via Worker <span class="mono">gas-proxy3</span>.
        Kalau jaringan HP lagi rewel (QUIC timeout), klik refresh lagi.
      </div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const API_BASE = "https://gas-proxy3.tuic1677.workers.dev/";

/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
const toast = (msg, bad=false)=>{
  const t=$("toast");
  t.textContent=msg;
  t.classList.toggle("bad", !!bad);
  t.style.display="block";
  clearTimeout(window.__to);
  window.__to=setTimeout(()=>t.style.display="none", 4200);
};
const norm = (s)=>String(s??"").trim();
const uniq = (arr)=>Array.from(new Set(arr));
const byAlpha = (a,b)=>norm(a).localeCompare(norm(b),"id");

function fillSelect(sel, items, ph){
  sel.innerHTML="";
  const opt=document.createElement("option");
  opt.value=""; opt.textContent=ph;
  sel.appendChild(opt);
  (items||[]).forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
  sel.disabled = !(items && items.length);
}

/* fetch with timeout + retry */
async function apiGet(params, {timeoutMs=12000, retries=2}={}){
  const url = new URL(API_BASE);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v!==undefined && v!==null && String(v)!=="") url.searchParams.set(k,String(v));
  });
  url.searchParams.set("t", Date.now());

  let lastErr=null;
  for(let i=0;i<=retries;i++){
    const ctrl=new AbortController();
    const timer=setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const res = await fetch(url.toString(), {cache:"no-store", signal:ctrl.signal});
      clearTimeout(timer);
      if(!res.ok) throw new Error("HTTP "+res.status);
      const j = await res.json();
      return j;
    }catch(e){
      clearTimeout(timer);
      lastErr=e;
      // small backoff
      await new Promise(r=>setTimeout(r, 400 + i*500));
    }
  }
  throw lastErr || new Error("Failed to fetch");
}

/* ===== UI / Data ===== */
let baselineItems = [];
let monitorItems = []; // aggregated from fn=monitor

const bwsSel=$("bws"), provSel=$("prov"), kabSel=$("kab"), qInp=$("q");
const tbody=$("tbody"), stat=$("stat"), chips=$("chips");

function resetAll(){
  baselineItems=[];
  monitorItems=[];
  fillSelect(bwsSel, [], "-- pilih B/BWS --");
  fillSelect(provSel, [], "-- pilih Provinsi --"); provSel.disabled=true;
  fillSelect(kabSel, [], "-- pilih Kab/Kota --"); kabSel.disabled=true;
  qInp.value="";
  tbody.innerHTML=`<tr><td colspan="10" class="muted">Belum ada data. Klik ‚ÄúAmbil data monitoring‚Äù.</td></tr>`;
  chips.style.display="none";
  stat.textContent="Siap.";
}

function buildBaselineIndexes(){
  const bwsList = uniq(baselineItems.map(r=>norm(r["B/BWS"]||r["B/BWS PELAKSANA"]||r["Balai"]||"")).filter(Boolean)).sort(byAlpha);
  fillSelect(bwsSel, bwsList, "-- pilih B/BWS --");
  provSel.disabled=true; kabSel.disabled=true;
}

function onBwsChange(){
  const bws=bwsSel.value;
  fillSelect(provSel, [], "-- pilih Provinsi --"); provSel.disabled=true;
  fillSelect(kabSel, [], "-- pilih Kab/Kota --"); kabSel.disabled=true;
  if(!bws) return;

  const rows = baselineItems.filter(r=>norm(r["B/BWS"]||r["B/BWS PELAKSANA"]||r["Balai"]||"")===bws);
  const provs = uniq(rows.map(r=>norm(r["Provinsi"]||r["PROVINSI"]||"")).filter(Boolean)).sort(byAlpha);
  fillSelect(provSel, provs, "-- pilih Provinsi --");
  provSel.disabled=false;
}
function onProvChange(){
  const bws=bwsSel.value, prov=provSel.value;
  fillSelect(kabSel, [], "-- pilih Kab/Kota --"); kabSel.disabled=true;
  if(!bws || !prov) return;

  const rows = baselineItems.filter(r=>
    norm(r["B/BWS"]||r["B/BWS PELAKSANA"]||r["Balai"]||"")===bws &&
    norm(r["Provinsi"]||r["PROVINSI"]||"")===prov
  );
  const kabs = uniq(rows.map(r=>norm(r["Kab/Kota"]||r["KABUPATEN"]||r["Kabupaten"]||"")).filter(Boolean)).sort(byAlpha);
  fillSelect(kabSel, kabs, "-- pilih Kab/Kota --");
  kabSel.disabled=false;
}

function badgeCell(has){
  return has
    ? `<span class="mini ok" title="Sudah upload">‚úì</span>`
    : `<span class="mini no" title="Belum upload">‚Äì</span>`;
}

function stageLabel(maxStage){
  if(maxStage>=100) return `<span class="mini ok">${maxStage}%</span>`;
  if(maxStage>0)    return `<span class="mini warn">${maxStage}%</span>`;
  return `<span class="mini no">0%</span>`;
}

function applyFilterAndRender(){
  const bws=bwsSel.value, prov=provSel.value, kab=kabSel.value, q=norm(qInp.value).toLowerCase();

  let rows = monitorItems.slice();

  if(bws) rows = rows.filter(x=>norm(x.balai)===bws);
  if(prov) rows = rows.filter(x=>norm(x.provinsi)===prov);
  if(kab) rows = rows.filter(x=>norm(x.kabupaten)===kab);
  if(q) rows = rows.filter(x=>norm(x.di).toLowerCase().includes(q));

  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="10" class="muted">Tidak ada data yang cocok.</td></tr>`;
    stat.textContent = "0 baris.";
    return;
  }

  tbody.innerHTML = rows.map((x,i)=>{
    const p=x.photos||{};
    const a25=p["25"]?.url ? p["25"].url : "";
    const a50=p["50"]?.url ? p["50"].url : "";
    const a75=p["75"]?.url ? p["75"].url : "";
    const a100=p["100"]?.url ? p["100"].url : "";

    // Aksi: buka foto terakhir (yang ada) paling tinggi
    const lastUrl = a100 || a75 || a50 || a25 || "";
    const aksi = lastUrl ? `<a href="${lastUrl}" target="_blank" rel="noopener">Buka</a>` : `<span class="muted">-</span>`;

    return `
      <tr>
        <td class="mono">${i+1}</td>
        <td><b>${x.di||"-"}</b></td>
        <td class="muted">${x.provinsi||"-"}</td>
        <td class="muted">${x.kabupaten||"-"}</td>
        <td>${badgeCell(!!a25)}</td>
        <td>${badgeCell(!!a50)}</td>
        <td>${badgeCell(!!a75)}</td>
        <td>${badgeCell(!!a100)}</td>
        <td class="nowrap">${stageLabel(Number(x.maxStage||0))}</td>
        <td class="actions nowrap">${aksi}</td>
      </tr>
    `;
  }).join("");

  stat.textContent = rows.length + " baris.";
}

async function loadBaseline(){
  const j = await apiGet({fn:"baseline"});
  if(!j || j.ok!==true || !Array.isArray(j.items)) throw new Error("Baseline invalid");
  baselineItems = j.items;
  buildBaselineIndexes();
}

async function loadMonitor(){
  // ambil semua dulu (backend sudah agregasi per DI)
  const j = await apiGet({fn:"monitor"});
  if(!j || j.ok!==true || !Array.isArray(j.items)) throw new Error("Monitor invalid (pastikan Code.gs sudah ada fn=monitor)");
  monitorItems = j.items;

  chips.style.display="flex";
  applyFilterAndRender();
}

$("btnRefresh").addEventListener("click", async ()=>{
  try{
    stat.textContent="Mengambil data‚Ä¶";
    toast("Mengambil data monitoring‚Ä¶");
    if(!baselineItems.length) await loadBaseline();
    await loadMonitor();
    toast("Data monitoring siap ‚úÖ");
  }catch(e){
    console.error(e);
    toast("Gagal ambil data: " + (e?.message||e), true);
    stat.textContent="Gagal ambil data.";
  }
});

$("btnReset").addEventListener("click", ()=>{
  bwsSel.value=""; provSel.value=""; kabSel.value=""; qInp.value="";
  provSel.disabled=true; kabSel.disabled=true;
  applyFilterAndRender();
});

bwsSel.addEventListener("change", ()=>{
  onBwsChange();
  applyFilterAndRender();
});
provSel.addEventListener("change", ()=>{
  onProvChange();
  applyFilterAndRender();
});
kabSel.addEventListener("change", applyFilterAndRender);
qInp.addEventListener("input", ()=>{
  // debounced render
  clearTimeout(window.__q);
  window.__q=setTimeout(applyFilterAndRender, 120);
});

/* boot */
resetAll();
(async ()=>{
  try{
    stat.textContent="Mengambil baseline‚Ä¶";
    await loadBaseline();
    stat.textContent="Siap. Klik Ambil data monitoring.";
  }catch(e){
    console.error(e);
    toast("Baseline gagal: " + (e?.message||e), true);
    stat.textContent="Baseline gagal.";
  }
})();
</script>
</body>
</html>
