<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Monitoring Tahap 3 ‚Äî Log Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="icon" href="../../assets/LogoPUPR.png" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg:#0b1222;
      --panel:#0f172a;
      --panelSoft:rgba(15,23,42,.96);
      --border:rgba(148,163,184,.35);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#1d4ed8;
      --accentSoft:#1d5fd1;
      --accentDim:#0b275f;
      --yellow:#facc15;
      --danger:#ef4444;
      --success:#22c55e;
      --radius:18px;
      --shadow:0 18px 40px rgba(0,0,0,.6);
      --hdrH:64px;
    }

    *{box-sizing:border-box;}

    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:radial-gradient(circle at top,#111827 0,#020617 45%,#020617 100%);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--text);
    }

    body{
      display:flex;
      flex-direction:column;
    }

    /* HEADER */
    header{
      height:var(--hdrH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px 0 16px;
      border-bottom:1px solid rgba(148,163,184,.3);
      background:linear-gradient(90deg,#020617 0,#020617 40%,#0b1120 100%);
      position:relative;
      z-index:10;
    }
    header-left{
      display:flex;
      align-items:center;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:38px;
      height:38px;
      border-radius:9px;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 10px 24px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .brand-logo img{
      width:90%;
      height:90%;
      object-fit:contain;
    }
    .brand-text{
      line-height:1.1;
    }
    .brand-text .top{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .brand-text .mid{
      font-size:13px;
      font-weight:600;
    }
    .brand-text .bot{
      font-size:11px;
      color:var(--muted);
    }

    .tag-tahap{
      margin-left:18px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(59,130,246,.6);
      color:#bfdbfe;
      background:radial-gradient(circle at top,#1d4ed8 0,rgba(15,23,42,.9) 55%);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      padding:4px 9px;
      display:flex;
      align-items:center;
      gap:6px;
      background:rgba(15,23,42,.85);
    }
    .pill-dot{
      width:7px;height:7px;border-radius:999px;
      background:radial-gradient(circle,#4ade80 0,#22c55e 50%,#166534 100%);
      box-shadow:0 0 12px rgba(34,197,94,.8);
    }

    /* LAYOUT MAIN */
    .main{
      flex:1;
      display:flex;
      gap:10px;
      padding:10px;
      min-height:0;
    }

    .sidebar{
      width:380px;
      max-width:420px;
      min-width:260px;
      background:var(--panelSoft);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:12px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .map-wrapper{
      flex:1;
      min-width:0;
      background:var(--panelSoft);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    #map{
      flex:1;
      width:100%;
    }

    /* KARTU STATS */
    .stats{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
      font-size:11px;
    }
    .stat-card{
      background:radial-gradient(circle at top,#020617 0,#020617 30%,#020617 100%);
      border-radius:12px;
      border:1px solid rgba(148,163,184,.45);
      padding:7px 8px 6px;
      position:relative;
      overflow:hidden;
    }
    .stat-label{
      color:var(--muted);
      font-size:10px;
    }
    .stat-value{
      font-size:16px;
      font-weight:600;
      margin-top:2px;
    }
    .stat-chip{
      position:absolute;
      right:6px;
      top:6px;
      font-size:9px;
      padding:2px 5px;
      border-radius:999px;
      background:rgba(30,64,175,.4);
      border:1px solid rgba(129,140,248,.6);
      color:rgba(191,219,254,.9);
    }

    /* FILTERS */
    .panel-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-top:4px;
      margin-bottom:2px;
    }
    .filters{
      display:grid;
      grid-template-columns:1fr;
      gap:6px;
      font-size:11px;
    }
    .filter-row{
      display:flex;
      gap:6px;
    }
    .filter-row > *{
      flex:1;
    }
    label small{
      display:block;
      margin-bottom:2px;
      color:var(--muted);
      font-size:10px;
    }
    select,input[type="text"],input[type="number"]{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:#020617;
      color:var(--text);
      padding:5px 9px;
      font-size:11px;
      outline:none;
    }
    select:focus,input:focus{
      border-color:rgba(59,130,246,.9);
      box-shadow:0 0 0 1px rgba(37,99,235,.6);
    }
    .filter-inline{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:10px;
      color:var(--muted);
    }

    /* TABLE */
    .table-wrap{
      margin-top:4px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.45);
      background:radial-gradient(circle at top,#020617 0,#020617 40%,#020617 100%);
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .table-header{
      padding:6px 8px 4px;
      border-bottom:1px solid rgba(55,65,81,.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:11px;
      color:var(--muted);
    }
    .table-header strong{
      color:var(--text);
      font-size:11px;
    }
    .table-body{
      flex:1;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      position:sticky;
      top:0;
      background:#020617;
      z-index:2;
    }
    th,td{
      padding:4px 6px;
      white-space:nowrap;
    }
    th{
      text-align:left;
      border-bottom:1px solid rgba(55,65,81,.9);
      color:var(--muted);
      font-size:10px;
    }
    tbody tr{
      cursor:pointer;
    }
    tbody tr:nth-child(odd){
      background:rgba(15,23,42,.85);
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,.75);
    }
    tbody tr:hover{
      background:rgba(37,99,235,.25);
    }
    tbody tr.selected{
      background:rgba(59,130,246,.35);
    }
    .badge-progress{
      border-radius:999px;
      padding:1px 6px;
      font-size:10px;
      border:1px solid rgba(96,165,250,.9);
      color:#bfdbfe;
      background:rgba(37,99,235,.35);
    }
    .badge-foto{
      border-radius:999px;
      padding:1px 6px;
      font-size:10px;
      border:1px solid rgba(52,211,153,.9);
      color:#a7f3d0;
      background:rgba(4,120,87,.45);
    }

    /* MAP HEADER */
    .map-header{
      padding:6px 10px 5px;
      border-bottom:1px solid rgba(55,65,81,.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:11px;
      color:var(--muted);
    }
    .map-header-left strong{
      color:var(--text);
    }
    .map-legend{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:10px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:radial-gradient(circle,#60a5fa 0,#2563eb 60%,#1d4ed8 100%);
    }
    .map-footer{
      position:absolute;
      left:10px;
      bottom:8px;
      font-size:10px;
      color:var(--muted);
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(75,85,99,.9);
    }

    @media (max-width:960px){
      .main{
        flex-direction:column;
      }
      .sidebar{
        width:100%;
        max-width:none;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-logo">
      <img src="../../assets/LogoPUPR.png" alt="PUPR">
    </div>
    <div class="brand-text">
      <div class="top">Direktorat Jenderal Sumber Daya Air</div>
      <div class="mid">Direktorat Irigasi &amp; Rawa</div>
      <div class="bot">Monitoring Pelaksanaan Inpres 2/2025</div>
    </div>
    <span class="tag-tahap">Tahap 3 ¬∑ Log Survey Lapangan</span>
  </div>

  <div class="header-right">
    <div class="pill">
      <span class="pill-dot"></span>
      <span>Realtime dari Google Sheet ¬∑ <span id="last-updated">‚Äì</span></span>
    </div>
  </div>
</header>

<div class="main">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Total Titik</div>
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-chip">log_tahap3</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Balai Terlapor</div>
        <div class="stat-value" id="stat-balai">0</div>
        <div class="stat-chip">Balai</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Rata-rata Progress</div>
        <div class="stat-value" id="stat-progress">0%</div>
        <div class="stat-chip">Progress</div>
      </div>
    </div>

    <div class="panel-title">Filter</div>
    <div class="filters">
      <div class="filter-row">
        <label>
          <small>Balai</small>
          <select id="filter-balai">
            <option value="">Semua Balai</option>
          </select>
        </label>
        <label>
          <small>Provinsi</small>
          <select id="filter-prov">
            <option value="">Semua Provinsi</option>
          </select>
        </label>
      </div>

      <div class="filter-row">
        <label>
          <small>Kabupaten / Desa</small>
          <input type="text" id="filter-kabkec" placeholder="Ketik kabupaten / desa..." />
        </label>
      </div>

      <div class="filter-inline">
        <label style="flex:1;">
          <small>Min. progress (%)</small>
          <input type="number" id="filter-progress" value="0" min="0" max="100" />
        </label>
        <button id="btn-reset" type="button" style="
          margin-top:14px;
          border-radius:999px;
          border:1px solid rgba(148,163,184,.6);
          background:#020617;
          color:var(--muted);
          font-size:10px;
          padding:5px 9px;
          cursor:pointer;
        ">Reset</button>
      </div>
    </div>

    <div class="table-wrap">
      <div class="table-header">
        <div>
          <strong>Daftar Log</strong>
          <span id="table-count">(0 baris)</span>
        </div>
        <div style="font-size:10px;color:var(--muted);">
          Klik baris untuk zoom ke peta
        </div>
      </div>
      <div class="table-body">
        <table>
          <thead>
          <tr>
            <th>Waktu</th>
            <th>Balai</th>
            <th>Prov</th>
            <th>Kab / Desa</th>
            <th>Petugas</th>
            <th>Prog</th>
            <th>Foto</th>
          </tr>
          </thead>
          <tbody id="table-body">
          <!-- rows via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </aside>

  <!-- MAP AREA -->
  <section class="map-wrapper">
    <div class="map-header">
      <div class="map-header-left">
        <strong>Peta Lokasi Log Tahap 3</strong><br/>
        <span>Data: Sheet <code>In_Tahap3_cleaned / log_tahap3</code></span>
      </div>
      <div class="map-legend">
        <span class="dot"></span> Titik log
      </div>
    </div>
    <div id="map"></div>
    <div class="map-footer">
      Klik marker atau baris tabel untuk detail log. üìç
    </div>
  </section>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
  // ==============================
  // 1. KONFIGURASI SHEET
  // ==============================
  const SHEET_ID   = "1YkNmEcQw1_1_xL0BTxYX1f4Tkk2-22tXuQB-IoEeuY"; // In_Tahap3_cleaned
  const SHEET_NAME = "log_tahap3";                                   // nama sheet
  const SHEET_URL  =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;

  // ==============================
  // 2. INISIALISASI PETA
  // ==============================
  const map = L.map("map", {
    center: [-2, 118],
    zoom: 5,
    worldCopyJump: true
  });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  const markerLayer = L.layerGroup().addTo(map);

  // ==============================
  // 3. GLOBAL STATE
  // ==============================
  let rawData = [];
  let filteredData = [];

  const elStatTotal    = document.getElementById("stat-total");
  const elStatBalai    = document.getElementById("stat-balai");
  const elStatProgress = document.getElementById("stat-progress");
  const elLastUpdated  = document.getElementById("last-updated");
  const elFilterBalai  = document.getElementById("filter-balai");
  const elFilterProv   = document.getElementById("filter-prov");
  const elFilterKabKec = document.getElementById("filter-kabkec");
  const elFilterProg   = document.getElementById("filter-progress");
  const elTableBody    = document.getElementById("table-body");
  const elTableCount   = document.getElementById("table-count");
  const elBtnReset     = document.getElementById("btn-reset");

  // ==============================
  // 4. PARSER CSV SIMPLE
  // ==============================
  function parseCSV(text){
    const rows = text.trim().split("\n").map(r => r.split(","));
    const headers = rows[0].map(h => h.trim());
    return rows.slice(1).map(r => {
      const obj = {};
      headers.forEach((h, i) => {
        obj[h] = (r[i] || "").trim();
      });
      return obj;
    });
  }

  // ==============================
  // 5. HELPERS
  // ==============================
  function formatTime(ts){
    if(!ts) return "";
    // ts dari form sudah berupa string "MM/DD/YYYY HH:MM:SS"
    // kita tampilkan apa adanya saja
    return ts;
  }

  function uniqueList(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort();
  }

  function toNumber(val, def=0){
    const n = parseFloat(val);
    return isNaN(n) ? def : n;
  }

  // ==============================
  // 6. RENDER STAT
  // ==============================
  function renderStats(data){
    const total = data.length;
    elStatTotal.textContent = total.toString();

    const balaiSet = uniqueList(data.map(r => r.balai || r.key || ""));
    elStatBalai.textContent = balaiSet.length.toString();

    const nums = data.map(r => toNumber(r.progress_ || r.progress));
    const avg = nums.length ? (nums.reduce((a,b)=>a+b,0)/nums.length) : 0;
    elStatProgress.textContent = avg.toFixed(0) + "%";

    // last updated pakai timestamp maksimum
    const times = uniqueList(rawData.map(r => r.timestamp || ""));
    if(times.length){
      elLastUpdated.textContent = times[times.length-1];
    }else{
      elLastUpdated.textContent = "‚Äì";
    }
  }

  // ==============================
  // 7. RENDER FILTER OPTIONS
  // ==============================
  function initFilters(data){
    const balaiList = uniqueList(data.map(r => r.balai || r.key || ""));
    balaiList.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      elFilterBalai.appendChild(opt);
    });

    const provList = uniqueList(data.map(r => r.provinsi || ""));
    provList.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      elFilterProv.appendChild(opt);
    });
  }

  // ==============================
  // 8. FILTER DATA
  // ==============================
  function applyFilters(){
    const balaiVal  = elFilterBalai.value.trim();
    const provVal   = elFilterProv.value.trim();
    const kabkecVal = elFilterKabKec.value.trim().toLowerCase();
    const progMin   = toNumber(elFilterProg.value,0);

    filteredData = rawData.filter(r => {
      const balai = (r.balai || r.key || "").trim();
      const prov  = (r.provinsi || "").trim();
      const kab   = (r["kabupate di"] || r["kabupaten di"] || "").trim();
      const kec   = (r["kecamata desa"] || "").trim();
      const progress = toNumber(r.progress_ || r.progress, 0);

      if(balaiVal && balai !== balaiVal) return false;
      if(provVal && prov !== provVal) return false;

      const fullKabKec = (kab + " " + kec).toLowerCase();
      if(kabkecVal && !fullKabKec.includes(kabkecVal)) return false;

      if(progress < progMin) return false;

      return true;
    });

    renderStats(filteredData);
    renderTable(filteredData);
    renderMarkers(filteredData);
  }

  // ==============================
  // 9. RENDER TABEL
  // ==============================
  function renderTable(data){
    elTableBody.innerHTML = "";
    elTableCount.textContent = `(${data.length} baris)`;

    data.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.dataset.index = String(idx);

      const kab = row["kabupate di"] || row["kabupaten di"] || "";
      const kec = row["kecamata desa"] || "";
      const prov = row.provinsi || "";
      const balai = row.balai || row.key || "";
      const nama  = row.nama || "";
      const progress = toNumber(row.progress_ || row.progress,0);
      const hasFoto = !!(row.foto_url || "").trim();

      tr.innerHTML = `
        <td>${formatTime(row.timestamp || "")}</td>
        <td>${balai}</td>
        <td>${prov}</td>
        <td>${kab} / ${kec}</td>
        <td>${nama}</td>
        <td><span class="badge-progress">${progress}%</span></td>
        <td>${hasFoto ? '<span class="badge-foto">Foto</span>' : ''}</td>
      `;

      tr.addEventListener("click", () => {
        document
          .querySelectorAll("#table-body tr.selected")
          .forEach(x => x.classList.remove("selected"));
        tr.classList.add("selected");

        const marker = row._marker;
        if(marker){
          map.setView(marker.getLatLng(), 14);
          marker.openPopup();
        }else{
          const lat = toNumber(row.lat);
          const lng = toNumber(row.lng);
          if(!isNaN(lat) && !isNaN(lng)){
            map.setView([lat,lng],14);
          }
        }
      });

      elTableBody.appendChild(tr);
    });
  }

  // ==============================
  // 10. RENDER MARKERS
  // ==============================
  function renderMarkers(data){
    markerLayer.clearLayers();

    const bounds = [];

    data.forEach(row => {
      const lat = toNumber(row.lat);
      const lng = toNumber(row.lng);
      if(isNaN(lat) || isNaN(lng)) return;

      const prov      = row.provinsi || "";
      const kab       = row["kabupate di"] || row["kabupaten di"] || "";
      const kecdesa   = row["kecamata desa"] || "";
      const nama      = row.nama || "";
      const telepon   = row.telepon || "";
      const balai     = row.balai || row.key || "";
      const progress  = toNumber(row.progress_ || row.progress,0);
      const fotoUrl   = row.foto_url || "";
      const ts        = row.timestamp || "";

      const popupHtml = `
        <div style="min-width:220px;">
          <div style="font-weight:600;margin-bottom:4px;">
            ${prov} ¬∑ ${kab}
            <span class="badge-progress" style="float:right;">${progress}%</span>
          </div>
          <div style="font-size:12px;">
            <div><span style="color:${"var(--muted)"};">Balai</span> : <b>${balai}</b></div>
            <div><span style="color:${"var(--muted)"};">Desa</span>  : <b>${kecdesa}</b></div>
            <div><span style="color:${"var(--muted)"};">Petugas</span> : ${nama}</div>
            <div><span style="color:${"var(--muted)"};">Telp</span>    : ${telepon}</div>
            <div style="margin-top:4px;font-size:11px;color:#9ca3af;">${ts}</div>
            ${fotoUrl ? `<div style="margin-top:6px;"><a href="${fotoUrl}" target="_blank">üì∑ Buka foto di Drive</a></div>` : ""}
          </div>
        </div>
      `;

      const marker = L.marker([lat,lng]).bindPopup(popupHtml);
      marker.addTo(markerLayer);
      row._marker = marker;
      bounds.push([lat,lng]);
    });

    if(bounds.length){
      const latLngBounds = L.latLngBounds(bounds);
      map.fitBounds(latLngBounds, {padding:[30,30]});
    }
  }

  // ==============================
  // 11. LOAD DATA
  // ==============================
  async function loadData(){
    try{
      const res  = await fetch(SHEET_URL);
      const text = await res.text();
      rawData = parseCSV(text);
      if(!rawData.length){
        alert("Sheet kosong atau gagal dibaca. Cek izin share dan nama sheet (log_tahap3).");
        return;
      }

      initFilters(rawData);
      applyFilters(); // ini akan panggil renderStats, renderTable, renderMarkers
    }catch(err){
      console.error("Gagal load data:", err);
      alert("Gagal memuat data dari Google Sheet.\nPastikan file sudah di-share publik (Anyone with the link - Viewer).");
    }
  }

  // ==============================
  // 12. EVENT LISTENER FILTER
  // ==============================
  elFilterBalai.addEventListener("change", applyFilters);
  elFilterProv.addEventListener("change", applyFilters);
  elFilterKabKec.addEventListener("input", () => {
    // sedikit debounce manual sederhana
    clearTimeout(elFilterKabKec._t);
    elFilterKabKec._t = setTimeout(applyFilters, 250);
  });
  elFilterProg.addEventListener("input", applyFilters);
  elBtnReset.addEventListener("click", () => {
    elFilterBalai.value  = "";
    elFilterProv.value   = "";
    elFilterKabKec.value = "";
    elFilterProg.value   = "0";
    applyFilters();
  });

  // Start
  loadData();
</script>
</body>
</html>
