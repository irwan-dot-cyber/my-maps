<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Survey ‚Äî BALAI ‚Üí SNVT ‚Üí PAKET + Peta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{display:grid;grid-template-columns:1.1fr 1fr;gap:14px;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:10px}
    label{font-size:12px;color:var(--mut)}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .col3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600}
    .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    #map{height:60vh}
    .mapwrap{position:relative}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .hint{font-size:12px;color:var(--mut)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    @media (max-width:980px){main{grid-template-columns:1fr}.col3{grid-template-columns:1fr 1fr}.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <strong>Form Survey</strong>
    <span class="hint"> &nbsp;‚Ä¢ Pilih <b>BALAI ‚Üí SNVT ‚Üí PAKET</b>, isi data, pilih koordinat dari peta.</span>
  </header>

  <main>
    <!-- PETA -->
    <div class="card">
      <h2>Peta Lokasi</h2>
      <div class="mapwrap">
        <div id="map"></div>
        <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
      </div>
      <div style="padding:10px 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnLocate" class="ghost">üìç Lokasi saya</button>
        <button id="btnPick" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
        <span class="hint" id="coords">Lat: -, Lng: -</span>
      </div>
    </div>

    <!-- FORM -->
    <div class="card">
      <h2>Data Survei</h2>
      <div id="toast" class="toast"></div>
      <form id="surveyForm">
        <!-- BALAI ‚Üí SNVT ‚Üí PAKET -->
        <div class="row">
          <div>
            <label>BALAI</label>
            <select id="balai" name="balai" required></select>
          </div>
          <div>
            <label>SNVT</label>
            <select id="snvt" name="snvt" required disabled></select>
          </div>
        </div>
        <div>
          <label>PAKET</label>
          <select id="paket" name="paket" required disabled></select>
        </div>

        <!-- Info lokasi administratif tambahan (opsional) -->
        <div class="row">
          <div>
            <label>Kecamatan</label>
            <input name="kecamatan" placeholder="Nama kecamatan" />
          </div>
          <div>
            <label>Desa/Kelurahan</label>
            <input name="desa" placeholder="Nama desa/kelurahan" />
          </div>
        </div>

        <!-- Koordinat -->
        <div class="row">
          <div>
            <label>Latitude</label>
            <input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required />
          </div>
          <div>
            <label>Longitude</label>
            <input type="number" step="0.000001" id="lng" name="lng" required />
          </div>
        </div>
        <div class="actions" style="margin-top:4px">
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
        </div>

        <!-- Foto -->
        <div>
          <label>Foto Lokasi</label>
          <input type="file" accept="image/*" capture="environment" name="foto" />
          <div class="hint">Bisa ambil kamera langsung atau pilih dari gallery.</div>
        </div>

        <!-- Identitas -->
        <div class="row">
          <div>
            <label>Nama Pengirim</label>
            <input name="nama" placeholder="Nama lengkap" required />
          </div>
          <div>
            <label>Nomor WA/HP</label>
            <input name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required />
          </div>
        </div>

        <!-- Aksi -->
        <div class="actions">
          <button type="submit" class="primary">Kirim</button>
          <button type="reset" class="ghost">Reset</button>
        </div>
      </form>
    </div>
  </main>

  <script>
  // ======== PETA + CROSSHAIR ========
  const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap contributors'});
  const baseCarto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',{maxZoom:20, attribution:'¬© OpenStreetMap, ¬© CARTO'});
  const baseImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri ‚Äî Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'});

  const map = L.map('map', { zoomControl:true, layers:[baseOSM] });
  map.createPane('labels');
  map.getPane('labels').style.zIndex = 650;
  map.getPane('labels').style.pointerEvents = 'none';
  const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',{pane:'labels', attribution:'¬© CARTO'});

  L.control.layers(
    { 'OSM Standard': baseOSM, 'Carto Light': baseCarto, 'Esri Imagery': baseImagery },
    { 'Labels (CARTO)': labels },
    { position:'topright', collapsed:false }
  ).addTo(map);
  labels.addTo(map);
  map.setView([-2.5,118], 5);

  const $coords = document.getElementById('coords');
  const $lat = document.getElementById('lat');
  const $lng = document.getElementById('lng');

  function updateCenterLabel(){
    const c = map.getCenter();
    $coords.textContent = `Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;
  }
  map.on('move', updateCenterLabel);
  map.whenReady(updateCenterLabel);

  document.getElementById('btnLocate').addEventListener('click', ()=>{
    map.locate({setView:true, maxZoom:17, enableHighAccuracy:true});
  });
  map.on('locationerror', ()=> alert('Izin lokasi ditolak. Geser peta manual.'));

  document.getElementById('btnPick').addEventListener('click', ()=>{
    const c = map.getCenter();
    $lat.value = c.lat.toFixed(6);
    $lng.value = c.lng.toFixed(6);
  });

  function panIfValid(){
    const la = parseFloat($lat.value), lo = parseFloat($lng.value);
    if(!Number.isNaN(la) && !Number.isNaN(lo)) map.setView([la,lo], Math.max(map.getZoom(), 16));
  }
  $lat.addEventListener('change', panIfValid);
  $lng.addEventListener('change', panIfValid);
  document.getElementById('btnPan').addEventListener('click', panIfValid);

  // ======== BALAI ‚Üí SNVT ‚Üí PAKET (dari JSON) ========
  const $balai = document.getElementById('balai');
  const $snvt  = document.getElementById('snvt');
  const $paket = document.getElementById('paket');

  function fillSelect(el, items, placeholder='-- pilih --'){
    el.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = placeholder; el.appendChild(opt);
    items.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); });
  }

  let BBWS_MAP = {}; // { BALAI: { SNVT: [PAKET, ...] } }

  // Ganti path ini jika file JSON disimpan di lokasi lain:
  fetch('./balai_snvt_paket.json')
    .then(r => r.json())
    .then(data => {
      BBWS_MAP = data;
      fillSelect($balai, Object.keys(BBWS_MAP).sort(), '-- pilih BALAI --');
    })
    .catch(err => {
      console.error('Gagal load balai_snvt_paket.json:', err);
      alert('Gagal memuat data BALAI. Pastikan file balai_snvt_paket.json tersedia.');
    });

  $balai.addEventListener('change', ()=>{
    const b = $balai.value;
    if(!b){ $snvt.innerHTML=''; $snvt.disabled=true; $paket.innerHTML=''; $paket.disabled=true; return; }
    const snvts = Object.keys(BBWS_MAP[b] || {});
    fillSelect($snvt, snvts.sort(), '-- pilih SNVT --');
    $snvt.disabled = false;
    $paket.innerHTML=''; $paket.disabled=true;
  });

  $snvt.addEventListener('change', ()=>{
    const b = $balai.value;
    const s = $snvt.value;
    if(!s){ $paket.innerHTML=''; $paket.disabled=true; return; }
    const pakets = (BBWS_MAP[b] || {})[s] || [];
    fillSelect($paket, pakets, '-- pilih PAKET --'); // kalau cuma 1 paket, tetap tampil satu pilihan
    $paket.disabled = false;
  });

  // ======== SUBMIT (DEMO) ========
  const form = document.getElementById('surveyForm');
  const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',4000); };
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!$lat.value || !$lng.value){ toast('Koordinat belum diisi. Klik "Pilih lokasi" atau isi manual.'); return; }
    if(!$balai.value || !$snvt.value || !$paket.value){ toast('Lengkapi pilihan BALAI, SNVT, dan PAKET.'); return; }

    const fd = new FormData(form);
    const payload = Object.fromEntries(fd.entries());
    payload.hasFoto = !!fd.get('foto') && fd.get('foto').name;

    console.log('Payload terkirim (demo):', payload);
    toast('‚úÖ Data siap kirim (demo). Lihat console.');

    // TODO: kirim ke Google Apps Script / API kamu
    // fetch('URL_SCRIPT_APP', { method:'POST', body: fd })
    //  .then(r => r.json()).then(resp => toast('‚úÖ Terkirim')).catch(()=>toast('‚ùå Gagal kirim'));

    form.reset();
  });
  </script>
</body>
</html>
