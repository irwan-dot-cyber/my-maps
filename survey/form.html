<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Survey A.I.R ‚Äî Direktorat Irigasi & Rawa</title>
<style>
  :root{--bg:#0b1222;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--line:#263142;--ok:#22c55e}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Inter,Arial;background:linear-gradient(180deg,#0b1222,#0f172a);color:var(--text)}
  header{position:sticky;top:0;background:rgba(11,18,34,.7);backdrop-filter:blur(5px);border-bottom:1px solid #1f2937;padding:12px 16px;z-index:10}
  header h1{margin:0;font-size:18px}
  main{max-width:920px;margin:18px auto;padding:16px}
  .card{background:rgba(17,24,39,.9);border:1px solid #1f2937;border-radius:16px;padding:18px}
  .grid{display:grid;gap:12px}
  @media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr}}
  label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px 2px}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0b1222;color:var(--text)}
  input:focus,select:focus,textarea:focus{outline:none;border-color:#334155;box-shadow:0 0 0 4px rgba(59,130,246,.15)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 14px;font-weight:600}
  .btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#052e16}
  .btn-muted{background:#0b1222;border:1px solid var(--line);color:#d1d5db}
  .hint{font-size:12px;color:var(--muted)}
  .preview{display:flex;align-items:center;gap:10px;border:1px dashed #334155;border-radius:14px;padding:10px;background:#0b1222}
  .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px}
  /* Overlay Upload */
  #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999}
  .u-box{background:#0b1222;border:1px solid var(--line);border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
  .u-title{font-weight:800;margin-bottom:6px}
  .u-msg{opacity:.95}
  .u-hint{font-size:12px;color:#a1a1aa;margin-top:8px}
  .u-progress{height:10px;border:1px solid var(--line);border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
  #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)}
  /* Toast */
  #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;border:1px solid #374151;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:10000}
</style>
</head>
<body>
<header>
  <h1>Form Survey A.I.R</h1>
  <div class="hint">Asisten Irigasi &amp; Rawa ‚Ä¢ PUPR</div>
</header>

<main>
  <form id="surveyForm" class="card" autocomplete="on">
    <div class="grid grid-2">
      <div>
        <label for="nama">Nama Petugas *</label>
        <input id="nama" name="nama" required>
      </div>
      <div>
        <label for="hp">No. HP (WA) *</label>
        <input id="hp" name="hp" placeholder="08xx atau +62‚Ä¶" required>
        <div class="hint">Format ID: 08xxxxxxxxxx atau +628xxxxxxxxx</div>
      </div>

      <div>
        <label for="balai">Balai *</label>
        <select id="balai" name="balai" required>
          <option value="">-- pilih BALAI --</option>
          <option>BWS VI CITARUM</option>
          <option>BWS VII CIMANUK‚ÄìCISOKAN</option>
          <option>BWS VIII CITANDUY</option>
        </select>
      </div>
      <div>
        <label for="snvt">SNVT *</label>
        <select id="snvt" name="snvt" disabled required>
          <option value="">-- pilih SNVT --</option>
        </select>
      </div>

      <div>
        <label for="paket">PAKET *</label>
        <select id="paket" name="paket" disabled required>
          <option value="">-- pilih PAKET --</option>
        </select>
      </div>
      <div>
        <label for="alamat">Alamat / Nama Lokasi</label>
        <input id="alamat" name="alamat" placeholder="Nama desa/ruas/DSA, dst.">
      </div>

      <div>
        <label for="prov">Provinsi *</label>
        <input id="prov" name="prov" required>
      </div>
      <div>
        <label for="kab">Kabupaten/Kota *</label>
        <select id="kab" name="kab" disabled required>
          <option value="">-- pilih Kabupaten/Kota --</option>
        </select>
      </div>

      <div>
        <label for="lat">Latitude *</label>
        <input id="lat" name="lat" inputmode="decimal" placeholder="-6.2" required>
      </div>
      <div>
        <label for="lng">Longitude *</label>
        <input id="lng" name="lng" inputmode="decimal" placeholder="106.8" required>
      </div>
    </div>

    <div class="row" style="align-items:center;margin-top:6px">
      <button type="button" id="btnLoc" class="btn btn-muted">üìç Ambil Lokasi</button>
    </div>

    <hr style="border:none;border-top:1px solid #1f2937;margin:16px 0">

    <div class="grid">
      <label>Foto Lokasi (JPG/PNG) *</label>
      <div class="row">
        <button type="button" class="btn btn-muted" id="btnKamera">üì∑ Pakai Kamera</button>
        <button type="button" class="btn btn-muted" id="btnGaleri">üñºÔ∏è Ambil dari Galeri</button>
        <label class="hint" style="margin-left:auto">
          <input type="checkbox" id="compress" checked> Kompres sebelum upload
        </label>
      </div>
      <input id="foto" name="foto" type="file" accept="image/*" style="display:none" required>
      <div id="preview" class="preview" hidden>
        <img id="thumb" alt="Preview">
        <div>
          <div id="imgmeta" class="hint">‚Äî</div>
          <div class="hint">Pastikan foto jelas dan tidak buram.</div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn btn-primary" type="submit">üìù Kirim Survey</button>
      <button class="btn btn-muted" type="reset" id="btnReset">Reset</button>
    </div>
  </form>
</main>

<!-- Overlay Upload -->
<div id="uploadOverlay">
  <div class="u-box" role="alert" aria-live="assertive">
    <div class="u-title" id="uploadTitle">Mengunggah data‚Ä¶</div>
    <div class="u-msg" id="uploadMsg">Menyiapkan berkas‚Ä¶</div>
    <div class="u-progress"><div id="progressBar"></div></div>
    <div class="u-hint" id="uploadHint">Jangan tutup halaman ini.</div>
  </div>
</div>

<div id="toast"></div>

<script>
/* ====== KONFIG ====== */
const ENDPOINT = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_GAS_ID/exec";

/* ====== helper kecil ====== */
function toast(msg, ms=2200){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=>{ t.style.display='none'; }, ms);
}
function fillSelect(sel, arr, placeholder='-- pilih --'){
  sel.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.textContent = placeholder; opt0.value='';
  sel.appendChild(opt0);
  (arr||[]).forEach(v=>{
    const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o);
  });
  sel.disabled = !(arr && arr.length);
}
const validHP = (v)=>{
  const s = (v||'').replace(/\s+/g,'');
  return /^(?:\+62|62|0)8[1-9][0-9]{7,11}$/.test(s);
};

/* ====== Upload notifier (punya lo) ====== */
const $overlay = document.getElementById('uploadOverlay');
const $utitle  = document.getElementById('uploadTitle');
const $umsg    = document.getElementById('uploadMsg');
const $uhint   = document.getElementById('uploadHint');
const $ubar    = document.getElementById('progressBar');
function setUploadingUI({show, title, msg, percent, hint}){
  if (typeof title==='string') $utitle.textContent = title;
  if (typeof msg==='string')   $umsg.textContent   = msg;
  if (typeof hint==='string')  $uhint.textContent  = hint;
  if (typeof percent==='number'){
    const p = Math.max(0, Math.min(100, Math.round(percent)));
    $ubar.style.width = p + '%';
  }
  $overlay.style.display = show ? 'flex' : 'none';
}
function disableForm(disabled){
  document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button')
    .forEach(el => el.disabled = !!disabled);
}

/* ====== DOM refs ====== */
const form  = document.getElementById('surveyForm');
const nama  = document.getElementById('nama');
const hp    = document.getElementById('hp');
const balai = document.getElementById('balai');
const snvt  = document.getElementById('snvt');
const paket = document.getElementById('paket');
const prov  = document.getElementById('prov');
const kab   = document.getElementById('kab');
const lat   = document.getElementById('lat');
const lng   = document.getElementById('lng');
const btnLoc= document.getElementById('btnLoc');
const fileInput = document.getElementById('foto');

/* ====== Cascading contoh ====== */
const SNVT_BY_BALAI = {
  "BWS VI CITARUM": ["SNVT PJPA Citarum","SNVT OP SDA Citarum"],
  "BWS VII CIMANUK‚ÄìCISOKAN": ["SNVT PJPA Cimanuk","SNVT OP SDA Cimanuk"],
  "BWS VIII CITANDUY": ["SNVT PJPA Citanduy","SNVT OP SDA Citanduy"]
};
const PAKET_BY_SNVT = {
  "SNVT PJPA Citarum": ["Rehab Jaringan Irigasi","Pengendalian Banjir"],
  "SNVT OP SDA Citarum": ["OP Bendung","OP Saluran"],
  "SNVT PJPA Cimanuk": ["DAK Irigasi","Pembangunan Rawa"],
  "SNVT OP SDA Cimanuk": ["OP Waduk","OP Saluran Sekunder"],
  "SNVT PJPA Citanduy": ["Normalisasi Sungai","Peningkatan Saluran"],
  "SNVT OP SDA Citanduy": ["OP Bendung","OP Embung"]
};
balai.addEventListener('change', ()=>{
  fillSelect(snvt, SNVT_BY_BALAI[balai.value]||[], '-- pilih SNVT --');
  fillSelect(paket, [], '-- pilih PAKET --');
});
snvt.addEventListener('change', ()=>{
  fillSelect(paket, PAKET_BY_SNVT[snvt.value]||[], '-- pilih PAKET --');
});

/* ====== Kabupaten contoh dari Prov ====== */
prov.addEventListener('input', ()=>{
  const v = (prov.value||'').trim().toLowerCase();
  if(!v){ fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); return; }
  // Stub contoh ‚Äî ganti dengan sumber data lo
  let list=[];
  if(v.includes('jawa barat')) list=['Bandung','Kab. Bandung','Cimahi','Garut','Ciamis'];
  if(v.includes('jawa tengah')) list=['Cilacap','Banyumas','Purbalingga'];
  fillSelect(kab, list, '-- pilih Kabupaten/Kota --');
});

/* ====== Kamera / Galeri + Preview ====== */
document.getElementById('btnKamera').addEventListener('click', ()=>{
  fileInput.removeAttribute('multiple');
  fileInput.setAttribute('capture','environment'); // minta kamera belakang
  fileInput.click();
});
document.getElementById('btnGaleri').addEventListener('click', ()=>{
  fileInput.removeAttribute('capture');
  fileInput.click();
});
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files?.[0];
  const prev = document.getElementById('preview');
  if(!f){ prev.hidden = true; return; }
  prev.hidden = false;
  document.getElementById('imgmeta').textContent = `${f.name} ‚Ä¢ ${f.type||'image'} ‚Ä¢ ${(f.size/1024).toFixed(1)} KB`;
  const url = URL.createObjectURL(f);
  document.getElementById('thumb').src = url;
});

/* ====== Ambil lokasi ====== */
btnLoc.addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast('Geolokasi tidak didukung'); return; }
  btnLoc.disabled = true; btnLoc.textContent = '‚è≥ Mendapatkan‚Ä¶';
  navigator.geolocation.getCurrentPosition(pos=>{
    lat.value = pos.coords.latitude.toFixed(6);
    lng.value = pos.coords.longitude.toFixed(6);
    btnLoc.textContent = 'üìç Ambil Lagi'; btnLoc.disabled = false;
  }, err=>{
    toast('Gagal ambil lokasi: '+err.message);
    btnLoc.textContent = 'üìç Ambil Lokasi'; btnLoc.disabled = false;
  }, {enableHighAccuracy:true, timeout:15000});
});

/* ====== Kompresi gambar (opsional) ====== */
const MAX_DIM = 2000; const JPEG_QUALITY = 0.82;
async function maybeCompress(file){
  const doCompress = document.getElementById('compress').checked;
  if(!doCompress) return file;
  if(!/^image\/(jpeg|png|webp)$/i.test(file.type)) return file;

  const img = new Image();
  const blobUrl = URL.createObjectURL(file);
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=blobUrl; });

  const {width, height} = img;
  const scale = Math.min(1, MAX_DIM / Math.max(width, height));
  const w = Math.round(width*scale), h = Math.round(height*scale);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  const mime = 'image/jpeg';
  const dataUrl = canvas.toDataURL(mime, JPEG_QUALITY);
  const outBlob = await (await fetch(dataUrl)).blob();
  URL.revokeObjectURL(blobUrl);
  return new File([outBlob], (file.name.replace(/\.(png|webp)$/i,'')||'foto')+'.jpg', {type:mime});
}

/* ====== Reset ====== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  document.getElementById('preview').hidden = true;
  fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true;
  fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
  fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;
});

/* ====== Submit ‚Üí GAS pakai XHR (progress) ====== */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  // Validasi kunci
  if(!nama.value.trim()){ toast('Isi nama petugas.'); return; }
  if(!validHP(hp.value)){ toast('Nomor HP tidak valid (gunakan 08‚Ä¶ atau +62‚Ä¶).'); return; }
  if(!balai.value || !snvt.value || !paket.value){ toast('Lengkapi BALAI, SNVT, PAKET.'); return; }
  if(!lat.value || !lng.value){ toast('Koordinat belum diisi.'); return; }
  if(!(fileInput.files && fileInput.files[0])){ toast('Foto wajib diisi.'); return; }

  // Siapkan FormData (+ kompres foto jika dipilih)
  const fd = new FormData(form);
  const rawFile = fileInput.files[0];
  setUploadingUI({show:true, title:'Mengunggah data‚Ä¶', msg:'Menyiapkan berkas‚Ä¶', percent:3, hint:'Jangan tutup halaman ini.'});
  disableForm(true);

  const fotoCompressed = await maybeCompress(rawFile);
  if(fotoCompressed !== rawFile){
    fd.delete('foto');
    fd.append('foto', fotoCompressed, fotoCompressed.name);
  }

  // Kirim
  const xhr = new XMLHttpRequest();
  xhr.open('POST', ENDPOINT, true);

  // Progress
  xhr.upload.onprogress = (ev)=>{
    if (ev.lengthComputable){
      const percent = (ev.loaded/ev.total)*100;
      setUploadingUI({show:true, msg:'Mengunggah ke server‚Ä¶', percent});
    } else {
      const cur = parseInt($ubar.style.width||'0',10) || 0;
      if (cur < 90) setUploadingUI({show:true, percent: cur+1});
    }
  };
  xhr.onloadstart = ()=> setUploadingUI({show:true, msg:'Mengunggah dimulai‚Ä¶', percent:5});
  xhr.onreadystatechange = ()=>{
    if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) {
      setUploadingUI({show:true, msg:'Diproses server‚Ä¶', percent:95});
    }
  };

  xhr.onerror = ()=>{
    setUploadingUI({show:false});
    disableForm(false);
    toast('‚ùå Gagal kirim (jaringan).');
  };

  xhr.onload = ()=>{
    let data = {};
    try { data = JSON.parse(xhr.responseText||'{}'); } catch(e){}
    if (xhr.status >= 200 && xhr.status < 300 && (data.ok===true || data.status==='ok')){
      setUploadingUI({show:true, title:'Berhasil terkirim!', msg: data.fileUrl ? 'URL foto tersimpan.' : 'Data tersimpan.', percent:100, hint:'Kamu bisa menutup dialog ini.'});
      toast('‚úÖ Terkirim ke Google Sheet!');
      setTimeout(()=>{
        setUploadingUI({show:false});
        form.reset();
        document.getElementById('preview').hidden = true;
        fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true;
        fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
        fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;
        disableForm(false);
      }, 700);
      console.log('GAS response:', data);
    } else {
      setUploadingUI({show:false});
      disableForm(false);
      toast('‚ùå Gagal kirim (server). Cek console.');
      console.error('GAS error:', xhr.status, xhr.responseText);
    }
  };

  xhr.send(fd);
});
</script>
</body>
</html>
