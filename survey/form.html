<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Survey AIR ‚Äî GAS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600}
    .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    .hint{font-size:12px;color:var(--mut)}
    #map{height:60vh}
    .mapwrap{position:relative}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    /* Overlay upload */
    #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999}
    .u-box{background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
    .u-title{font-weight:800;margin-bottom:6px}
    .u-msg{opacity:.95}
    .u-hint{font-size:12px;color:#a1a1aa;margin-top:8px}
    .u-progress{height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
    #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <strong>Form Survey AIR</strong>
    <span class="hint"> ‚Ä¢ BALAI ‚Üí SNVT ‚Üí PAKET, Prov/Kab otomatis, peta untuk koordinat.</span>
  </header>

  <main>
    <div class="card">
      <h2>Data Survei</h2>
      <div id="toast" class="toast"></div>
      <form id="surveyForm">
        <!-- BALAI ‚Üí SNVT -->
        <div class="row">
          <div>
            <label>BALAI</label>
            <select id="balai" name="balai" required></select>
          </div>
          <div>
            <label>SNVT</label>
            <select id="snvt" name="snvt" required disabled></select>
          </div>
        </div>

        <!-- PAKET -->
        <div>
          <label>PAKET</label>
          <select id="paket" name="paket" required disabled></select>
        </div>

        <!-- Prov/Kab (auto) -->
        <div class="row">
          <div>
            <label>Provinsi (otomatis)</label>
            <input id="provinsi" name="provinsi" readonly placeholder="‚Äî otomatis dari BALAI ‚Äî"/>
          </div>
          <div>
            <label>Kabupaten/Kota (otomatis)</label>
            <select id="kabupaten" name="kabupaten" disabled>
              <option value="">-- pilih Kabupaten/Kota --</option>
            </select>
          </div>
        </div>

        <!-- Kecamatan & Desa -->
        <div class="row">
          <div>
            <label>Kecamatan</label>
            <input id="kecamatan" name="kecamatan" placeholder="Nama kecamatan" required/>
          </div>
          <div>
            <label>Desa/Kelurahan</label>
            <input id="desa" name="desa" placeholder="Nama desa/kelurahan" required/>
          </div>
        </div>

        <!-- Peta -->
        <div>
          <label>Peta Lokasi</label>
          <div class="mapwrap">
            <div id="map"></div>
            <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
            <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
            <span class="hint" id="coords">Lat: -, Lng: -</span>
          </div>
        </div>

        <!-- Lat/Lng -->
        <div class="row">
          <div>
            <label>Latitude</label>
            <input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required/>
          </div>
          <div>
            <label>Longitude</label>
            <input type="number" step="0.000001" id="lng" name="lng" required/>
          </div>
        </div>
        <div class="actions" style="margin-top:4px">
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
        </div>

        <!-- Foto: Kamera & Galeri -->
        <div>
          <label>Foto Lokasi</label>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <!-- dua input file hidden untuk kompatibilitas mobile -->
          <input type="file" accept="image/*" capture="environment" id="fileCamera" style="display:none">
          <input type="file" accept="image/*" id="fileGallery" style="display:none">
          <div class="hint">Pilih dari kamera atau galeri. Ukuran besar bisa memakan waktu saat upload.</div>
        </div>

        <!-- Identitas -->
        <div class="row">
          <div>
            <label>Nama Pengirim</label>
            <input id="nama" name="nama" placeholder="Nama lengkap" required/>
          </div>
          <div>
            <label>Nomor WA/HP</label>
            <input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required/>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="primary">Kirim</button>
          <button type="reset" class="ghost" id="btnReset">Reset</button>
        </div>
      </form>
    </div>
  </main>

  <!-- Overlay Upload -->
  <div id="uploadOverlay">
    <div class="u-box" role="alert" aria-live="assertive">
      <div class="u-title" id="uploadTitle">Mengunggah data‚Ä¶</div>
      <div class="u-msg" id="uploadMsg">Menyiapkan berkas‚Ä¶</div>
      <div class="u-progress"><div id="progressBar"></div></div>
      <div class="u-hint" id="uploadHint">Jangan tutup halaman ini.</div>
    </div>
  </div>

  <script>
  /* ====== KONFIGURASI GAS ====== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxAw7-7LRa92ibF3JpJDSFiljDRha8lQpz19TdxvkATi5bZUwVgWF6p0_aCAUwAB8CYtQ/exec'; // ganti ke /exec

  /* ====== UTIL ====== */
  const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>t.style.display='none',4000); };
  function fillSelect(el, items, placeholder='-- pilih --'){
    el.innerHTML = '';
    if (placeholder && !el.multiple) {
      const opt = document.createElement('option');
      opt.value = ''; opt.textContent = placeholder; el.appendChild(opt);
    }
    (items||[]).forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); });
    el.disabled = !(items && items.length);
  }
  const uniq = arr => [...new Set((arr||[]).filter(Boolean))];

  /* ====== DOM ====== */
  const balai = document.getElementById('balai');
  const snvt  = document.getElementById('snvt');
  const paket = document.getElementById('paket');
  const prov  = document.getElementById('provinsi');
  const kab   = document.getElementById('kabupaten');
  const lat   = document.getElementById('lat');
  const lng   = document.getElementById('lng');
  const form  = document.getElementById('surveyForm');

  /* ====== INISIALISASI PETA ====== */
  const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
  const baseImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
  const map = L.map('map', { zoomControl:true, layers:[baseOSM] });
  L.control.layers({ 'OSM': baseOSM, 'Esri Imagery': baseImagery }, {}, { position:'topright', collapsed:false }).addTo(map);
  map.setView([-2.5,118], 5);
  const coords = document.getElementById('coords');
  function updateCenter(){ const c=map.getCenter(); coords.textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`; }
  map.on('move', updateCenter); map.whenReady(updateCenter);
  document.getElementById('btnLocate').addEventListener('click', ()=> map.locate({setView:true,maxZoom:17,enableHighAccuracy:true}));
  map.on('locationerror', ()=> alert('Izin lokasi ditolak. Geser peta manual.'));
  document.getElementById('btnPick').addEventListener('click', ()=>{ const c=map.getCenter(); lat.value=c.lat.toFixed(6); lng.value=c.lng.toFixed(6); });
  document.getElementById('btnPan').addEventListener('click', ()=>{ const la=parseFloat(lat.value), lo=parseFloat(lng.value); if(!Number.isNaN(la)&&!Number.isNaN(lo)) map.setView([la,lo], Math.max(map.getZoom(),16)); });

  /* ====== Upload Notifier (overlay + progress) ====== */
  const $overlay = document.getElementById('uploadOverlay');
  const $utitle  = document.getElementById('uploadTitle');
  const $umsg    = document.getElementById('uploadMsg');
  const $uhint   = document.getElementById('uploadHint');
  const $ubar    = document.getElementById('progressBar');
  function setUploadingUI({show, title, msg, percent, hint}){
    if (typeof title==='string') $utitle.textContent = title;
    if (typeof msg==='string')   $umsg.textContent   = msg;
    if (typeof hint==='string')  $uhint.textContent  = hint;
    if (typeof percent==='number'){
      const p = Math.max(0, Math.min(100, Math.round(percent)));
      $ubar.style.width = p + '%';
    }
    $overlay.style.display = show ? 'flex' : 'none';
  }
  function disableForm(disabled){
    document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button')
      .forEach(el => el.disabled = !!disabled);
  }

  /* ====== DATA LOADER (prioritas file JSON kamu) ====== */
  let BBWS = {};
  (async function loadJSON(){
    try{
      const candidates = [
        './balai_snvt_paket+wilayah.kab_array.json',
        './balai_snvt_paket+wilayah.json',
        './balai_snvt_paket.json'
      ].map(u => encodeURI(u));
      let data=null, lastErr=null;
      for (const url of candidates){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(!r.ok) throw new Error(r.status+' '+url);
          data = await r.json();
          console.log('Loaded:', url);
          break;
        }catch(e){ lastErr=e; }
      }
      if(!data){
        toast('‚ö†Ô∏è Data BALAI tidak bisa dimuat. Cek path/hosting.');
        console.error(lastErr);
        fillSelect(balai, [], '-- gagal memuat BALAI --');
        return;
      }
      BBWS = data;
      fillSelect(balai, Object.keys(BBWS).sort(), '-- pilih BALAI --');
    }catch(err){
      toast('‚ö†Ô∏è Error parsing JSON. Cek console.');
      console.error('JSON error:', err);
      fillSelect(balai, [], '-- gagal memuat BALAI --');
    }
  })();

  /* ====== Auto Prov/Kab (support kab_array & string) ====== */
  function parseKabFlexible(kabField){
    if (!kabField) return [];
    if (Array.isArray(kabField)) return uniq(kabField.map(s=>String(s).trim()).filter(Boolean));
    return uniq(String(kabField).split(/\r?\n/).map(s=>s.replace(/^\s*-\s*/,'').trim()).filter(Boolean));
  }
  function collectMeta({b=null,s=null,p=null}){
    if (!b || !BBWS[b]) return {provinsi:'', kabList:[]};
    let entries=[];
    if (s && BBWS[b][s]) {
      const arr = BBWS[b][s] || [];
      if (p){
        const chosen = arr.find(x => (typeof x==='string'? x : x.paket) === p);
        entries = chosen ? [chosen] : arr;
      } else entries = arr;
    } else {
      Object.values(BBWS[b]).forEach(arr => entries = entries.concat(arr||[]));
    }
    const provs = uniq(entries.map(e => typeof e==='object' ? (e.provinsi||'') : '').filter(Boolean));
    const kabAll = uniq(entries.flatMap(e => typeof e==='object' ? parseKabFlexible(e.kabupaten||e.kab||[]) : []));
    return { provinsi: provs.length===0 ? '' : (provs.length===1 ? provs[0] : '(beragam)'), kabList: kabAll };
  }

  /* ====== Cascading ====== */
  balai.addEventListener('change', ()=>{
    const b = balai.value;
    if(!b){
      fillSelect(snvt,[], '-- pilih SNVT --'); fillSelect(paket,[], '-- pilih PAKET --');
      snvt.disabled = paket.disabled = true;
      prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;
      return;
    }
    fillSelect(snvt, Object.keys(BBWS[b]||{}).sort(), '-- pilih SNVT --');
    snvt.disabled = false;
    const meta = collectMeta({b});
    prov.value = meta.provinsi || '';
    fillSelect(kab, meta.kabList, '-- pilih Kabupaten/Kota --');
    kab.disabled = meta.kabList.length===0;
    fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
  });

  snvt.addEventListener('change', ()=>{
    const b = balai.value, s = snvt.value;
    if(!s){
      fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
      const meta = collectMeta({b});
      prov.value = meta.provinsi || '';
      fillSelect(kab, meta.kabList, '-- pilih Kabupaten/Kota --'); kab.disabled = meta.kabList.length===0;
      return;
    }
    const arr = (BBWS[b]||{})[s] || [];
    const paketNames = arr.map(x => typeof x==='string' ? x : (x.paket||'')).filter(Boolean);
    fillSelect(paket, paketNames, '-- pilih PAKET --'); paket.disabled = paketNames.length===0;
    const meta = collectMeta({b, s});
    prov.value = meta.provinsi || '';
    fillSelect(kab, meta.kabList, '-- pilih Kabupaten/Kota --'); kab.disabled = meta.kabList.length===0;
  });

  paket.addEventListener('change', ()=>{
    const b = balai.value, s = snvt.value, p = paket.value;
    const meta = collectMeta({b, s, p});
    if (meta.provinsi || meta.kabList.length){
      prov.value = meta.provinsi || prov.value;
      fillSelect(kab, meta.kabList, '-- pilih Kabupaten/Kota --');
      kab.disabled = meta.kabList.length===0;
    }
  });

  /* ====== Kamera/Galeri ====== */
  let selectedFile = null;
  const fileCam = document.getElementById('fileCamera');
  const fileGal = document.getElementById('fileGallery');
  const metaEl  = document.getElementById('photoMeta');
  document.getElementById('btnCamera').addEventListener('click', ()=> fileCam.click());
  document.getElementById('btnGallery').addEventListener('click', ()=> fileGal.click());
  function showMeta(file){
    if(!file){ metaEl.textContent = ''; return; }
    const kb = (file.size/1024).toFixed(1);
    metaEl.textContent = `Dipilih: ${file.name} ‚Ä¢ ${kb} KB`;
  }
  fileCam.addEventListener('change', ()=>{ selectedFile = fileCam.files?.[0]||null; showMeta(selectedFile); });
  fileGal.addEventListener('change', ()=>{ selectedFile = fileGal.files?.[0]||null; showMeta(selectedFile); });

  /* ====== Kompresi Foto ====== */
  async function compressImage(file, {maxDim=2000, quality=0.82, mime='image/jpeg'} = {}){
    try{
      if (!(file && file.type && file.type.startsWith('image/'))) return file;

      // baca gambar (hormati EXIF orientation bila didukung)
      let bitmap;
      if (window.createImageBitmap){
        bitmap = await createImageBitmap(file, { imageOrientation: 'from-image' });
      }

      const imgW = bitmap ? bitmap.width : await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=> resolve(img.width);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
      const imgH = bitmap ? bitmap.height : await new Promise((resolve, reject)=>{
        const img = new Image();
        img.onload = ()=> resolve(img.height);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });

      const scale = Math.min(1, maxDim / Math.max(imgW, imgH));
      const w = Math.round(imgW * scale);
      const h = Math.round(imgH * scale);

      // jika tidak perlu resize dan sudah jpeg kecil, bisa langsung return
      if (scale === 1 && file.type === 'image/jpeg' && file.size < 700*1024) return file;

      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');

      if (bitmap){
        ctx.drawImage(bitmap, 0, 0, w, h);
      } else {
        const img = new Image();
        await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=URL.createObjectURL(file); });
        ctx.drawImage(img, 0, 0, w, h);
      }

      const blob = await new Promise(res => canvas.toBlob(res, mime, quality));
      if (!blob) return file;

      // jika hasil lebih besar, pakai file asli
      if (blob.size >= file.size) return file;

      const outName = (file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'') || 'foto') + '.jpg';
      return new File([blob], outName, { type: mime });
    }catch(err){
      console.warn('compressImage failed, using original:', err);
      return file;
    }
  }

  /* ====== Reset ====== */
  document.getElementById('btnReset').addEventListener('click', ()=>{
    selectedFile = null; showMeta(null);
    fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true;
    fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
    prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;
  });

  /* ====== SUBMIT ‚Üí GAS dgn XHR + overlay progress & kompresi ====== */
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!balai.value || !snvt.value || !paket.value){ toast('Lengkapi BALAI, SNVT, PAKET.'); return; }
    if(!lat.value || !lng.value){ toast('Koordinat belum diisi.'); return; }

    disableForm(true);
    setUploadingUI({show:true, title:'Mengunggah data‚Ä¶', msg:'Menyiapkan berkas‚Ä¶', percent:3, hint:'Jangan tutup halaman ini.'});

    // KOMpresi jika ada file
    let photoToSend = selectedFile;
    if (selectedFile){
      setUploadingUI({show:true, msg:'Mengompresi foto‚Ä¶', percent:8});
      photoToSend = await compressImage(selectedFile, {maxDim:2000, quality:0.82});
      // update meta supaya user lihat ukuran baru
      if (photoToSend){
        const kb = (photoToSend.size/1024).toFixed(1);
        metaEl.textContent = `Akan dikirim: ${photoToSend.name} ‚Ä¢ ${kb} KB`;
      }
    }

    const fd = new FormData();
    fd.append('balai', balai.value);
    fd.append('snvt', snvt.value);
    fd.append('paket', paket.value);
    fd.append('provinsi', prov.value);
    fd.append('kabupaten', kab.value || '');
    fd.append('kecamatan', document.getElementById('kecamatan').value || '');
    fd.append('desa', document.getElementById('desa').value || '');
    fd.append('lat', lat.value);
    fd.append('lng', lng.value);
    fd.append('nama', document.getElementById('nama').value);
    fd.append('telepon', document.getElementById('telepon').value);
    if (photoToSend) fd.append('foto', photoToSend, photoToSend.name);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', ENDPOINT, true);

    xhr.upload.onprogress = (ev)=>{
      if (ev.lengthComputable){
        const percent = (ev.loaded / ev.total) * 100;
        setUploadingUI({show:true, msg:'Mengunggah ke server‚Ä¶', percent});
      } else {
        const cur = parseInt($ubar.style.width||'0',10) || 0;
        if (cur < 90) setUploadingUI({show:true, percent: cur+1});
      }
    };
    xhr.onloadstart = ()=> setUploadingUI({show:true, msg:'Mengunggah dimulai‚Ä¶', percent:12});
    xhr.onreadystatechange = ()=>{
      if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) setUploadingUI({show:true, msg:'Diproses server‚Ä¶', percent:95});
    };
    xhr.onerror = ()=>{
      setUploadingUI({show:false}); disableForm(false);
      toast('‚ùå Gagal kirim (jaringan).');
    };
    xhr.onload = ()=>{
      let data = {};
      try { data = JSON.parse(xhr.responseText||'{}'); } catch(e){}
      if (xhr.status >= 200 && xhr.status < 300 && (data.ok===true || data.status==='ok')){
        setUploadingUI({show:true, title:'Berhasil terkirim!', msg: data.fileUrl ? 'URL foto tersimpan.' : 'Data tersimpan.', percent:100, hint:'Kamu bisa menutup dialog ini.'});
        toast('‚úÖ Terkirim!');
        setTimeout(()=>{
          setUploadingUI({show:false});
          form.reset(); selectedFile = null; showMeta(null);
          fillSelect(snvt,[], '-- pilih SNVT --'); snvt.disabled=true;
          fillSelect(paket,[], '-- pilih PAKET --'); paket.disabled=true;
          prov.value=''; fillSelect(kab,[], '-- pilih Kabupaten/Kota --'); kab.disabled=true;
          disableForm(false);
        }, 700);
        console.log('GAS response:', data);
      } else {
        setUploadingUI({show:false}); disableForm(false);
        toast('‚ùå Gagal kirim (server). Cek console.');
        console.error('GAS error:', xhr.status, xhr.responseText);
      }
    };
    xhr.send(fd);
  });
  </script>
</body>
</html>
