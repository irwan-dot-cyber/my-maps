<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Tahap 2 (Auto-Lock) ‚Äî Sheet Baseline</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600}
    .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    .hint{font-size:12px;color:var(--mut)}
    #map{height:56vh}
    .mapwrap{position:relative}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #334155;border-radius:999px;background:#0b1224;font-size:12px}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:#22c55e}.dot.orange{background:#f59e0b}.dot.gray{background:#94a3b8}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .gallery a{display:block;border:1px solid #1f2937;border-radius:10px;overflow:hidden;background:#0b1224}
    .gallery img{display:block;width:100%;height:140px;object-fit:cover}
    .muted{opacity:.7}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <strong>Form Tahap 2</strong>
  <span class="hint"> INPRES 2/2025 ‚Ä¢ Pelaksanaan Tahap 2</span>
</header>

<main>
  <div class="card">
    <h2>Data Survey</h2>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <form id="surveyForm">
      <div class="row">
        <div><label>B/BWS</label><select id="balai" name="balai" required></select></div>
        <div><label>Provinsi</label><select id="prov" name="provinsi" required disabled></select></div>
      </div>

      <div class="row">
        <div><label>Kabupaten/Kota</label><select id="kab" name="kabupaten" required disabled></select></div>
        <div><label>Daerah Irigasi (DI)</label><select id="di" name="di" required disabled></select></div>
      </div>

      <div class="actions" id="statusBar" style="gap:10px;margin-top:-4px">
        <span class="badge"><span class="dot green"></span>Progres terakhir: <b id="lastStage">0%</b></span>
        <span class="badge" id="coordBadge"><span class="dot gray"></span><span id="coordBadgeText">Koordinat: -</span></span>
      </div>

      <div class="row">
        <div><label>Kecamatan</label><input id="kecamatan" name="kecamatan" placeholder="(otomatis/isi manual)" required/></div>
        <div><label>Desa/Kelurahan</label><input id="desa" name="desa" placeholder="(otomatis/isi manual)" required/></div>
      </div>

      <div>
        <label>Peta Lokasi</label>
        <div class="mapwrap">
          <div id="map"></div>
          <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
          <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
          <span class="hint" id="coords">Lat: -, Lng: -</span>
        </div>
      </div>

      <div class="row">
        <div><label>Latitude</label><input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required/></div>
        <div><label>Longitude</label><input type="number" step="0.000001" id="lng" name="lng" required/></div>
      </div>

      <div id="historyBlock" class="card" style="border-radius:12px;margin-top:6px">
        <h2 style="font-size:14px">Riwayat Foto Progres</h2>
        <div id="historyGals" style="padding:12px 14px">
          <div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>
        </div>
      </div>

      <div class="card" style="border-radius:12px">
        <h2 style="font-size:14px">Upload Foto Progres</h2>
        <div style="padding:12px 14px; display:grid; gap:10px">
          <div class="actions" id="stageBtns"></div>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
          <div class="hint">Semua field wajib. Foto dikompresi otomatis.</div>
        </div>
      </div>

      <div class="row">
        <div><label>Nama Pengirim</label><input id="nama" name="nama" placeholder="Nama lengkap" required/></div>
        <div><label>Nomor WA/HP</label><input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required/></div>
      </div>

      <div class="actions">
        <button type="submit" class="primary" id="btnSubmit" disabled>Kirim</button>
        <button type="reset" class="ghost" id="btnReset">Reset</button>
      </div>
    </form>
  </div>
</main>

<!-- Overlay Upload -->
<div id="uploadOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999">
  <div class="u-box" role="alert" aria-live="assertive" style="background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw">
    <div class="u-title" id="uploadTitle" style="font-weight:800;margin-bottom:6px">Mengunggah data‚Ä¶</div>
    <div class="u-progress" style="height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222">
      <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)"></div>
    </div>
    <div class="u-hint" id="uploadHint" style="font-size:12px;color:#a1a1aa;margin-top:8px">Jangan tutup halaman ini.</div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
/* Upload/History via GAS (kalau nggak pakai history, set USE_HISTORY=false) */
const USE_HISTORY = true;
const ENDPOINT = 'https://gas-proxy2.tuic1677.workers.dev/';
const DATA_URL = 'https://script.google.com/macros/s/AKfycbwWe8SY1T51LL3yp_OlLlOORuMLjcVkbaL1td5pOm1EX0-POztzV-6CUl-tQo91OMzT/exec';

/* Baseline via Google Sheets (opensheet) ‚Äî dari link lo */
const SHEET_ID = '1LrRWGns6d68uQ7sNy2F7ecGsBrBgGbiO9S4lVXEkpXQ';
/* Cocokkan gid=>tab name. Ganti "NamaTabKamu" sesuai label tab yang pakai gid=674582970 */
const SHEET_TAB_BY_GID = { '674582970':'NamaTabKamu' };
const SHEET_TAB = SHEET_TAB_BY_GID['674582970'] || 'Sheet1';

/* ===== Utils & Normalizer ===== */
const toast = (m)=>{const t=document.getElementById('toast');t.textContent=String(m);t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',4200);};
function fillSelect(el, items, ph='-- pilih --'){ el.innerHTML=''; if(ph&&!el.multiple){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);} (items||[]).forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);}); el.disabled=!(items&&items.length); }
const $overlay=document.getElementById('uploadOverlay'), $bar=document.getElementById('progressBar');
function setUploadingUI({show,percent}){ if(typeof percent==='number') $bar.style.width=Math.max(0,Math.min(100,Math.round(percent)))+'%'; $overlay.style.display=show?'flex':'none'; }
function disableForm(b){document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button').forEach(e=>e.disabled=!!b);}
function debounce(fn, ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)};}
async function fetchWithRetry(url, {tries=3, timeout=9000}={}){ for (let i=0;i<tries;i++){ const ctrl=new AbortController(); const tid=setTimeout(()=>ctrl.abort(),timeout); try{ const res=await fetch(url,{cache:'no-store', signal:ctrl.signal}); clearTimeout(tid); if(!res.ok) throw new Error('HTTP '+res.status); return res; }catch(e){ if(i===tries-1) throw e; await new Promise(r=>setTimeout(r, 600*(i+1))); } }}

/* Aliases untuk header (biar fleksibel) + normalizer key */
const alias = {
  bws: ['B/BWS PELAKSANA','Balai','BWS','BBWS','B/BWS'],
  prov: ['PROVINSI','Provinsi'],
  kab: ['KABUPATEN','Kabupaten','Kabupaten/Kota','Kab/Kota'],
  di: ['NAMA DI/DIR','nama di','DI','Paket','Daerah Irigasi','Daerah_Irigasi'],
  kec: ['KECAMATAN','Kecamatan','Kec.','Kec'],
  desa: ['DESA','Desa','DESA/KEL','Desa/Kel','Desa/Kelurahan','Kelurahan','KELURAHAN','Desa/Kel.']
};
const norm = s => String(s??'').trim().replace(/\s+/g,' ').replace(/D\.?\s*I\.?/gi,'DI');
const titleCase = s => norm(s).split(/(\s+|[-/])/).map(tok=>{ if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok; const up=tok.toUpperCase(); if(up==='BBWS'||up==='BWS') return up; if(/^DI$/.test(up)) return 'D.I.'; return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase(); }).join('');
function pick(obj, keys){ for(const k of keys){ if(obj && obj[k]!=null && obj[k]!=='') return obj[k]; } return ''; }

/* ===== Map ===== */
const baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImg=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
const map=L.map('map',{zoomControl:true,layers:[baseOSM]}); L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5);
const coordsTxt=document.getElementById('coords'); map.on('move', debounce(()=>{const c=map.getCenter(); coordsTxt.textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;}, 80));

/* ===== DOM ===== */
const balai=document.getElementById('balai'), prov=document.getElementById('prov'), kab=document.getElementById('kab'), di=document.getElementById('di');
const lat=document.getElementById('lat'), lng=document.getElementById('lng'), form=document.getElementById('surveyForm'), btnSubmit=document.getElementById('btnSubmit');
const coordBadge=document.getElementById('coordBadge'), coordBadgeText=document.getElementById('coordBadgeText');
const btnPick = document.getElementById('btnPick'); const btnPan  = document.getElementById('btnPan'); const btnLocate = document.getElementById('btnLocate');
const tel = document.getElementById('telepon'); const lastStageEl=document.getElementById('lastStage'); const historyGals=document.getElementById('historyGals');

/* ===== Validasi Wajib ===== */
function checkMenus(required=['balai','prov','kab','di']){
  const mapEl = { balai, prov, kab, di };
  const msg   = { balai:'Pilih B/BWS dulu.', prov:'Pilih Provinsi dulu.', kab:'Pilih Kabupaten/Kota dulu.', di:'Pilih Daerah Irigasi dulu.' };
  for (const k of required){ if (!mapEl[k].value){ toast('‚ö†Ô∏è ' + msg[k]); mapEl[k].focus(); return false; } }
  return true;
}
function listMissing(){
  const miss=[]; if(!balai.value) miss.push('B/BWS'); if(!prov.value) miss.push('Provinsi'); if(!kab.value) miss.push('Kab/Kota'); if(!di.value) miss.push('DI');
  if(!document.getElementById('kecamatan').value) miss.push('Kecamatan'); if(!document.getElementById('desa').value) miss.push('Desa/Kelurahan');
  if(!lat.value||!lng.value) miss.push('Koordinat'); if(!currentStage) miss.push('Stage Progres');
  if(!document.getElementById('nama').value) miss.push('Nama'); if(!document.getElementById('telepon').value) miss.push('Nomor WA/HP'); return miss;
}
function setCoordBadge(type, text){
  coordBadge.querySelector('.dot')?.classList.remove('green','orange','gray');
  const dot = coordBadge.querySelector('.dot') || document.createElement('span');
  dot.className = 'dot ' + (type==='locked' ? 'green' : type==='none' ? 'orange' : 'gray');
  if (!coordBadge.contains(dot)) coordBadge.prepend(dot);
  coordBadgeText.textContent = text;
}
function setCoordLock(locked, la, ln){
  if (locked) { if (Number.isFinite(la) && Number.isFinite(ln)) { lat.value = Number(la).toFixed(6); lng.value = Number(ln).toFixed(6); }
    lat.disabled = true; lng.disabled = true; btnPick.disabled = true; btnPan.disabled = true; btnLocate.disabled = true; btnPick.classList.remove('primary'); btnPick.classList.add('ghost');
  } else { lat.disabled = false; lng.disabled = false; btnPick.disabled = false; btnPan.disabled = false; btnLocate.disabled = false; btnPick.classList.add('primary'); btnPick.classList.remove('ghost'); }
}

/* tombol map guarded */
btnLocate.addEventListener('click', ()=>{ if (!checkMenus(['balai','prov','kab','di'])) return; map.locate({setView:true,maxZoom:17,enableHighAccuracy:true}); });
map.on('locationerror',()=>toast('Izin lokasi ditolak. Geser peta manual.'));
let pickMarker=null;
btnPick.addEventListener('click', ()=>{ if (!checkMenus(['balai','prov','kab','di'])) return;
  const c=map.getCenter(); lat.value=c.lat.toFixed(6); lng.value=c.lng.toFixed(6);
  if (pickMarker) pickMarker.remove(); pickMarker = L.marker([c.lat, c.lng], {opacity:0.9}).addTo(map);
  setCoordBadge('locked','Koordinat: dipilih dari peta'); updateSubmitState();
});
btnPan.addEventListener('click', ()=>{ if (!checkMenus(['balai','prov','kab','di'])) return;
  const la=+lat.value, lo=+lng.value; if(!Number.isFinite(la)||!Number.isFinite(lo)||la<-90||la>90||lo<-180||lo>180){ return toast('Koordinat tidak valid.'); }
  map.setView([la,lo], Math.max(map.getZoom(),16));
});

/* ====== Baseline dari Google Sheets (opensheet) ====== */
async function loadBaselineFromSheet(sheetId, sheetTab){
  const url = `https://opensheet.elk.sh/${sheetId}/${encodeURIComponent(sheetTab)}`;
  const res = await fetchWithRetry(url);
  return await res.json(); // array of objects (header‚Üívalue)
}

/* ===== Baseline ‚Üí INDEX (normalisasi kunci) ===== */
let INDEX={};
async function loadData(){
  try{
    const rows = await loadBaselineFromSheet(SHEET_ID, SHEET_TAB);
    if(!Array.isArray(rows) || !rows.length){ toast('‚ö†Ô∏è Baseline kosong/invalid (sheet).'); return; }

    INDEX={};
    rows.forEach(row=>{
      const BWS = titleCase(pick(row, alias.bws));
      const PROV= titleCase(pick(row, alias.prov));
      const KAB = titleCase(pick(row, alias.kab));
      const DI  = titleCase(pick(row, alias.di));
      const KECs= String(pick(row, alias.kec)||'').split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean).map(titleCase);
      const DESAs=String(pick(row, alias.desa)||'').split(/\s*[,;/]\s*|[\r\n]+/).filter(Boolean).map(titleCase);
      if(!(BWS&&PROV&&KAB&&DI)) return;
      const kB=norm(BWS), kP=norm(PROV), kK=norm(KAB), kD=norm(DI);
      INDEX[kB] ??= {}; INDEX[kB][kP] ??= {}; INDEX[kB][kP][kK] ??= {};
      INDEX[kB][kP][kK][kD] ??= {kecamatan:new Set(), desa:new Set(), label:{BWS,PROV,KAB,DI}};
      KECs.forEach(k=>INDEX[kB][kP][kK][kD].kecamatan.add(k));
      DESAs.forEach(d=>INDEX[kB][kP][kK][kD].desa.add(d));
    });

    const balaiList = Object.keys(INDEX).map(titleCase).sort((a,b)=>a.localeCompare(b,'id'));
    fillSelect(balai, balaiList, '-- pilih B/BWS --');
    prov.disabled=kab.disabled=di.disabled=true;
  }catch(e){ console.error(e); toast('‚ö†Ô∏è Gagal memuat baseline (sheet/CORS).'); }
}

/* ===== Cascade (pakai norm() untuk lookup) ===== */
balai.addEventListener('change', ()=>{
  const bK = norm(balai.value);
  if(!bK || !INDEX[bK]){
    fillSelect(prov,[], '-- pilih Provinsi --'); prov.disabled=true;
    fillSelect(kab,[], '-- pilih Kab/Kota --');  kab.disabled=true;
    fillSelect(di,[],  '-- pilih DI --');        di.disabled=true;
    updateSubmitState(); return;
  }
  const provs = Object.keys(INDEX[bK]).map(titleCase).sort((a,b)=>a.localeCompare(b,'id'));
  fillSelect(prov, provs, '-- pilih Provinsi --'); prov.disabled=false;
  fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  updateSubmitState();
});
prov.addEventListener('change', ()=>{
  if (!balai.value){ toast('‚ö†Ô∏è Pilih B/BWS dulu.'); balai.focus(); prov.value=''; return; }
  const bK=norm(balai.value), pK=norm(prov.value);
  if(!pK || !INDEX[bK]?.[pK]){
    fillSelect(kab,[], '-- pilih Kab/Kota --'); kab.disabled=true;
    fillSelect(di,[],  '-- pilih DI --');       di.disabled=true;
    updateSubmitState(); return;
  }
  const kabs = Object.keys(INDEX[bK][pK]).map(titleCase).sort((a,b)=>a.localeCompare(b,'id'));
  fillSelect(kab, kabs, '-- pilih Kab/Kota --'); kab.disabled=false;
  fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
  updateSubmitState();
});
kab.addEventListener('change', ()=>{
  if (!prov.value){ toast('‚ö†Ô∏è Pilih Provinsi dulu.'); prov.focus(); kab.value=''; return; }
  const bK=norm(balai.value), pK=norm(prov.value), kK=norm(kab.value);
  if(!kK || !INDEX[bK]?.[pK]?.[kK]){
    fillSelect(di,[], '-- pilih DI --'); di.disabled=true;
    updateSubmitState(); return;
  }
  const dis = Object.keys(INDEX[bK][pK][kK]).map(titleCase).sort((a,b)=>a.localeCompare(b,'id'));
  fillSelect(di, dis, '-- pilih DI --'); di.disabled=false;
  updateSubmitState();
});

/* ===== History / Stage (opsional via GAS) ===== */
let currentStage=null;
function renderStageButtons(maxStage){
  const wrap=document.getElementById('stageBtns'); wrap.innerHTML='';
  const stages=[25,50,75,100]; const nextStage = (maxStage>=100) ? null : (maxStage===0 ? 25 : (maxStage+25));
  stages.forEach(st=>{ const btn=document.createElement('button'); btn.type='button'; btn.textContent=`Progres ${st}%`;
    const enabled = (st===nextStage); btn.className = enabled ? 'primary' : 'ghost'; btn.disabled = !enabled;
    btn.addEventListener('click', ()=>{ currentStage=st; toast(`Stage dipilih: ${st}%`); updateSubmitState(); });
    wrap.appendChild(btn);
  });
  currentStage = nextStage; updateSubmitState();
}
function renderHistoryPhotos(photos){
  const order=[25,50,75,100]; let html='', has=false;
  order.forEach(st=>{const p=photos[String(st)]; if(p&&p.url){has=true; html+=`
    <div style="margin-bottom:10px">
      <div class="hint">Foto Progres ${st}%:</div>
      <div class="gallery"><a href="${p.url}" target="_blank" title="${p.name||('Stage '+st)}"><img loading="lazy" src="${p.url}" alt="Progres ${st}%"/></a></div>
    </div>`; }});
  document.getElementById('historyGals').innerHTML = has ? html : `<div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>`;
}
async function fetchHistory(bws, p, k, d){
  if (!USE_HISTORY) return {ok:false,maxStage:0,coords:null,photos:{}};
  const qs = new URLSearchParams({fn:'history', bws, prov:p, kab:k, di:d});
  const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + qs.toString() + '&t=' + Date.now();
  try{ const res = await fetchWithRetry(url); const j = await res.json(); return j && j.ok ? j : {ok:false,maxStage:0,coords:null,photos:{}}; }catch{ return {ok:false,maxStage:0,coords:null,photos:{}}; }
}

/* === DI selected: kec/desa dari INDEX; history + lock koordinat === */
di.addEventListener('change', async ()=>{
  if (!kab.value){ toast('‚ö†Ô∏è Pilih Kab/Kota dulu.'); kab.focus(); di.value=''; return; }

  const bK=norm(balai.value), pK=norm(prov.value), kK=norm(kab.value), dK=norm(di.value);
  const node = INDEX[bK]?.[pK]?.[kK]?.[dK];

  const kecEl = document.getElementById('kecamatan');
  const desaEl = document.getElementById('desa');

  const kecs  = node ? [...node.kecamatan] : [];
  const desas = node ? [...node.desa] : [];

  kecEl.value  = (kecs[0]  || '');
  desaEl.value = (desas[0] || '');

  kecEl.placeholder  = kecs.length  > 1 ? `Opsi: ${kecs.join(', ')}`  : '(otomatis/isi manual)';
  desaEl.placeholder = desas.length > 1 ? `Opsi: ${desas.join(', ')}` : '(otomatis/isi manual)';

  if (!kecs.length && !desas.length){ toast('‚ÑπÔ∏è Kecamatan/Desa tidak ada di baseline untuk DI ini ‚Äî silakan isi manual (wajib).'); }

  const hist = await fetchHistory(balai.value, prov.value, kab.value, di.value);
  document.getElementById('lastStage').textContent = (hist.maxStage||0) + '%';
  renderHistoryPhotos(hist.photos||{});
  renderStageButtons(hist.maxStage||0);

  const hasCoord = hist.coords && Number.isFinite(hist.coords.lat) && Number.isFinite(hist.coords.lng);
  if (hasCoord){
    setCoordLock(true, hist.coords.lat, hist.coords.lng);
    setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
    map.setView([hist.coords.lat, hist.coords.lng], 17);
    if (pickMarker) pickMarker.remove();
    pickMarker = L.marker([hist.coords.lat, hist.coords.lng], {opacity:0.9}).addTo(map);
  } else {
    setCoordLock(false);
    setCoordBadge('none','Koordinat: belum ada, silakan pilih titik');
  }
  updateSubmitState();
});

/* ===== Foto + kompresi ===== */
let selectedFile=null; const fileInput=document.getElementById('fileInput'); const photoMeta=document.getElementById('photoMeta');
document.getElementById('btnCamera').addEventListener('click', ()=>{ if (!checkMenus(['balai','prov','kab','di'])) return; fileInput.setAttribute('capture','environment'); fileInput.click(); });
document.getElementById('btnGallery').addEventListener('click', ()=>{ if (!checkMenus(['balai','prov','kab','di'])) return; fileInput.removeAttribute('capture'); fileInput.click(); });
fileInput.addEventListener('change',()=>{ selectedFile = fileInput.files?.[0] || null; photoMeta.textContent = selectedFile ? `Dipilih: ${selectedFile.name} ‚Ä¢ ${(selectedFile.size/1024).toFixed(1)} KB` : ''; updateSubmitState(); });
async function compressImage(file,{maxDim=2000,quality=0.82,mime='image/jpeg'}={}){ try{
  if(!(file&&file.type&&file.type.startsWith('image/'))) return file;
  if (window.createImageBitmap) {
    const bitmap = await createImageBitmap(file,{imageOrientation:'from-image'});
    const W=bitmap.width,H=bitmap.height; const s=Math.min(1,maxDim/Math.max(W,H)); const w=Math.round(W*s), h=Math.round(H*s);
    if(s===1 && file.type==='image/jpeg' && file.size<700*1024) return file;
    const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(bitmap,0,0,w,h);
    const blob=await new Promise(r=>c.toBlob(r,mime,quality)); if(!blob||blob.size>=file.size) return file; const name=(file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto')+'.jpg'; return new File([blob],name,{type:mime});
  } else {
    const img = new Image(); img.src = URL.createObjectURL(file); await img.decode();
    const W=img.naturalWidth,H=img.naturalHeight; const s=Math.min(1,maxDim/Math.max(W,H)); const w=Math.round(W*s), h=Math.round(H*s);
    const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    const blob=await new Promise(r=>c.toBlob(r,mime,quality)); if(!blob||blob.size>=file.size) return file; const name=(file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto')+'.jpg'; return new File([blob],name,{type:mime});
  }
}catch(e){console.warn('compress fail',e); return file;}}

/* ===== Submit ===== */
function updateSubmitState(){ const ready = !!(balai.value && prov.value && kab.value && di.value && document.getElementById('kecamatan').value && document.getElementById('desa').value && currentStage && lat.value && lng.value); document.getElementById('btnSubmit').disabled = !ready; }
['change','input'].forEach(ev=>document.getElementById('surveyForm').addEventListener(ev, updateSubmitState));
document.getElementById('telepon').addEventListener('blur', ()=>{ let v = telepon.value.trim(); if (v.startsWith('0')) v = '62' + v.slice(1); telepon.value = v.replace(/[^0-9+]/g,''); });

document.getElementById('surveyForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!checkMenus(['balai','prov','kab','di'])) return;
  const missing = listMissing(); if (missing.length){ toast('‚ö†Ô∏è Harus diisi dulu: ' + missing.join(', ')); return; }

  const b=balai.value, p=prov.value, k=kab.value, d=di.value;
  let photo=null; if (selectedFile) photo = await compressImage(selectedFile,{maxDim=2000,quality=0.82});

  const fd = new FormData(surveyForm);
  fd.set('progress_stage', String(currentStage));
  if (photo) { const dt = new DataTransfer(); dt.items.add(photo); fileInput.files = dt.files; photoMeta.textContent = `Akan dikirim: ${photo.name} ‚Ä¢ ${(photo.size/1024).toFixed(1)} KB`; }

  disableForm(true); setUploadingUI({show:true, percent:6});
  const xhr = new XMLHttpRequest(); xhr.open('POST', ENDPOINT, true);
  xhr.upload.onprogress = (ev)=>{ if (ev.lengthComputable) setUploadingUI({show:true, percent:(ev.loaded/ev.total)*100}); };
  xhr.onloadstart = ()=> setUploadingUI({show:true, percent:5});
  xhr.onreadystatechange = ()=>{ if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) setUploadingUI({show:true, percent:95}); };
  xhr.onerror = ()=>{ setUploadingUI({show:false}); disableForm(false); toast('‚ùå Gagal kirim (jaringan/proxy).'); };
  xhr.onload = async ()=>{
    let data={}; try{ data = JSON.parse(xhr.responseText||'{}'); }catch(e){}
    if (xhr.status>=200 && xhr.status<300 && data && data.ok) {
      setUploadingUI({show:true, percent:100}); toast('‚úÖ Terkirim!');
      if (USE_HISTORY){
        const hist = await fetchHistory(b, p, k, d);
        lastStageEl.textContent = (hist.maxStage||0) + '%';
        renderHistoryPhotos(hist.photos||{});
        renderStageButtons(hist.maxStage||0);
        if (hist.coords){
          setCoordLock(true, hist.coords.lat, hist.coords.lng);
          setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
          if (pickMarker) pickMarker.remove(); pickMarker = L.marker([hist.coords.lat, hist.coords.lng], {opacity:0.9}).addTo(map);
        }
      }
      setTimeout(()=>{ setUploadingUI({show:false}); }, 600);
    } else { setUploadingUI({show:false}); disableForm(false); toast('‚ùå Gagal kirim (server). ' + (data && data.error ? data.error : '')); }
    disableForm(false); updateSubmitState();
  };
  xhr.send(fd);
});

/* ===== Reset ===== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  selectedFile=null; photoMeta.textContent='';
  fillSelect(prov,[], '-- pilih Provinsi --'); prov.disabled=true;
  fillSelect(kab,[], '-- pilih Kab/Kota --');  kab.disabled=true;
  fillSelect(di,[],  '-- pilih DI --');        di.disabled=true;
  document.getElementById('lastStage').textContent='0%'; setCoordBadge('none','Koordinat: -');
  setCoordLock(false); if (pickMarker) { pickMarker.remove(); pickMarker=null; } updateSubmitState();
});

/* ===== Start ===== */
loadData(); setCoordBadge('none','Koordinat: -');
</script>
</body>
</html>
