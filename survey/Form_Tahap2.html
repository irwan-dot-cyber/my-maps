<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Tahap 2 (Koordinat Auto-Lock)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600}
    .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    .hint{font-size:12px;color:var(--mut)}
    #map{height:56vh}
    .mapwrap{position:relative}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #334155;border-radius:999px;background:#0b1224;font-size:12px}
    .badge .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:#22c55e}.dot.orange{background:#f59e0b}.dot.gray{background:#94a3b8}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .gallery a{display:block;border:1px solid #1f2937;border-radius:10px;overflow:hidden;background:#0b1224}
    .gallery img{display:block;width:100%;height:140px;object-fit:cover}
    .muted{opacity:.7}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <strong>Form Tahap 2</strong>
  <span class="hint"> INPRES 2/2025 ‚Ä¢ Pelaksanaan Tahap 2</span>
</header>

<main>
  <div class="card">
    <h2>Data Survey</h2>
    <div id="toast" class="toast"></div>

    <form id="surveyForm">
      <div class="row">
        <div><label>B/BWS</label><select id="balai" name="balai" required></select></div>
        <div><label>Provinsi</label><select id="prov" name="provinsi" required disabled></select></div>
      </div>

      <div class="row">
        <div><label>Kabupaten/Kota</label><select id="kab" name="kabupaten" required disabled></select></div>
        <div><label>Daerah Irigasi (DI)</label><select id="di" name="di" required disabled></select></div>
      </div>

      <div class="actions" id="statusBar" style="gap:10px;margin-top:-4px">
        <span class="badge"><span class="dot green"></span>Progres terakhir: <b id="lastStage">0%</b></span>
        <span class="badge" id="coordBadge"><span class="dot gray"></span><span id="coordBadgeText">Koordinat: -</span></span>
      </div>

      <div class="row">
        <div><label>Kecamatan</label><input id="kecamatan" name="kecamatan" placeholder="(otomatis/isi manual)" required/></div>
        <div><label>Desa/Kelurahan</label><input id="desa" name="desa" placeholder="(otomatis/isi manual)" required/></div>
      </div>

      <div>
        <label>Peta Lokasi</label>
        <div class="mapwrap">
          <div id="map"></div>
          <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
          <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
          <span class="hint" id="coords">Lat: -, Lng: -</span>
        </div>
      </div>

      <div class="row">
        <div><label>Latitude</label><input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required/></div>
        <div><label>Longitude</label><input type="number" step="0.000001" id="lng" name="lng" required/></div>
      </div>

      <div id="historyBlock" class="card" style="border-radius:12px;margin-top:6px">
        <h2 style="font-size:14px">Riwayat Foto Progres</h2>
        <div id="historyGals" style="padding:12px 14px">
          <div class="hint muted">Belum ada foto progres untuk kombinasi terpilih.</div>
        </div>
      </div>

      <div class="card" style="border-radius:12px">
        <h2 style="font-size:14px">Upload Foto Progres</h2>
        <div style="padding:12px 14px; display:grid; gap:10px">
          <div class="actions" id="stageBtns"></div>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
          <div class="hint">Pilih kamera/galeri. Foto dikompresi otomatis & dikirim juga sebagai base64 fallback.</div>
        </div>
      </div>

      <div class="row">
        <div><label>Nama Pengirim</label><input id="nama" name="nama" placeholder="Nama lengkap" required/></div>
        <div><label>Nomor WA/HP</label><input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxx" pattern="[0-9+]{8,15}" required/></div>
      </div>

      <div class="actions">
        <button type="submit" class="primary" id="btnSubmit" disabled>Kirim</button>
        <button type="reset" class="ghost" id="btnReset">Reset</button>
      </div>
    </form>
  </div>
</main>

<!-- Overlay Upload -->
<div id="uploadOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999">
  <div class="u-box" role="alert" aria-live="assertive" style="background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw">
    <div class="u-title" id="uploadTitle" style="font-weight:800;margin-bottom:6px">Mengunggah data‚Ä¶</div>
    <div class="u-progress" style="height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222">
      <div id="progressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)"></div>
    </div>
    <div class="u-hint" id="uploadHint" style="font-size:12px;color:#a1a1aa;margin-top:8px">Jangan tutup halaman ini.</div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = 'https://gas-proxy2.tuic1677.workers.dev/';
const DATA_URL = 'https://script.google.com/macros/s/AKfycbwWe8SY1T51LL3yp_OlLlOORuMLjcVkbaL1td5pOm1EX0-POztzV-6CUl-tQo91OMzT/exec';

/* ===== Utils ===== */
const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',4200);};
function fillSelect(el,items,ph){el.innerHTML='';if(ph){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);}items.forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);});}
const uniq=a=>[...new Set((a||[]).filter(Boolean))];
const titleCase=s=>{
  s=String(s||'').trim();
  if(/^(BWS|BBWS)$/i.test(s))return 'BBWS';
  if(/^(D\.?I\.?|DI)$/i.test(s))return 'D.I.';
  return s.split(/(\s+|[-/])/).map(tok=>{
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/')return tok;
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join('');
};
function lockSelect(el){el.disabled=false;el.dataset.locked=1;el.addEventListener('mousedown',e=>{if(el.dataset.locked)e.preventDefault();});}

/* ===== Map ===== */
const map=L.map('map',{zoomControl:true}).setView([-2.5,118],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
map.on('move',()=>{const c=map.getCenter();document.getElementById('coords').textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;});

/* ===== DOM ===== */
const balai=document.getElementById('balai'),
      prov=document.getElementById('prov'),
      kab=document.getElementById('kab'),
      di=document.getElementById('di'),
      lat=document.getElementById('lat'),
      lng=document.getElementById('lng'),
      form=document.getElementById('surveyForm'),
      btnSubmit=document.getElementById('btnSubmit');

const btnLocate=document.getElementById('btnLocate'),
      btnPick=document.getElementById('btnPick'),
      btnPan=document.getElementById('btnPan');

btnLocate.addEventListener('click',()=>map.locate({setView:true,maxZoom:17}));
btnPick.addEventListener('click',()=>{const c=map.getCenter();lat.value=c.lat.toFixed(6);lng.value=c.lng.toFixed(6);});
btnPan.addEventListener('click',()=>{if(lat.value&&lng.value)map.setView([+lat.value,+lng.value],16);});

/* ===== Load baseline ===== */
let INDEX={};
async function loadData(){
  const resp=await fetch(DATA_URL+'?t='+Date.now());
  const rows=await resp.json();
  rows.forEach(r=>{
    const B=titleCase(r['B/BWS PELAKSANA']||r['Balai']);
    const P=titleCase(r['PROVINSI']||r['Provinsi']);
    const K=titleCase(r['KABUPATEN']||r['Kabupaten']);
    const D=titleCase(r['NAMA DI/DIR']||r['nama di']);
    if(!(B&&P&&K&&D))return;
    INDEX[B]??={};INDEX[B][P]??={};INDEX[B][P][K]??=[];INDEX[B][P][K].push(D);
  });
  fillSelect(balai,Object.keys(INDEX).sort(),'-- pilih BBWS/BWS --');
}
loadData();

/* ===== Cascade ===== */
balai.onchange=()=>{const b=balai.value;fillSelect(prov,b?Object.keys(INDEX[b]):[], '-- pilih Provinsi --');lockSelect(prov);};
prov.onchange=()=>{const b=balai.value,p=prov.value;fillSelect(kab,p?Object.keys(INDEX[b][p]):[], '-- pilih Kabupaten --');lockSelect(kab);};
kab.onchange=()=>{const b=balai.value,p=prov.value,k=kab.value;fillSelect(di,k?uniq(INDEX[b][p][k]).sort():[], '-- pilih DI --');lockSelect(di);};

/* ===== Koordinat Lock ===== */
function setCoordLock(locked,la,ln){
  [lat,lng,btnPick,btnPan,btnLocate].forEach(el=>el.disabled=locked);
  if(locked){lat.value=la;lng.value=ln;btnPick.classList.remove('primary');btnPick.classList.add('ghost');}
  else{btnPick.classList.add('primary');btnPick.classList.remove('ghost');}
}

/* ===== Dummy Riwayat ===== */
async function fetchHistory(){return {maxStage:0,coords:null,photos:{}};}
di.onchange=async()=>{
  const hist=await fetchHistory();
  if(hist.coords){setCoordLock(true,hist.coords.lat,hist.coords.lng);}
  else{setCoordLock(false);}
};

/* ===== Submit ===== */
form.addEventListener('submit',async e=>{
  e.preventDefault();
  btnSubmit.disabled=true;
  const fd=new FormData(form);
  const res=await fetch(ENDPOINT,{method:'POST',body:fd});
  const j=await res.json();
  toast(j.ok?'‚úÖ Data terkirim!':'‚ùå Gagal kirim');
  btnSubmit.disabled=false;
});
</script>

</body>
</html>
