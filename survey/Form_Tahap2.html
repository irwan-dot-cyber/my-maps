<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Form Survey Tahap 2</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<style>
  :root {
    --bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;
    --accent:#22c55e;--border:#1f2937;
  }
  body {margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb;}
  header {padding:14px 18px;border-bottom:1px solid var(--border);background:#0c1326;
          position:sticky;top:0;z-index:10;font-weight:700;}
  main {max-width:1000px;margin:0 auto;padding:14px;}
  .card {background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;}
  .card h2 {margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px;}
  form {padding:14px;display:grid;gap:12px;}
  label {font-size:13px;color:var(--mut);}
  select,input,textarea {width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;
                        background:#0b1224;color:#e5e7eb;}
  .row {display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .actions {display:flex;flex-wrap:wrap;gap:8px;}
  button {cursor:pointer;border:0;padding:10px 14px;border-radius:10px;font-weight:600;}
  .primary {background:var(--accent);color:#01250f;}
  .ghost {background:#0b1224;color:#e5e7eb;border:1px solid #334155;}
  #map {height:55vh;border-radius:10px;overflow:hidden;}
  .crosshair {position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000;}
  .crosshair .reticle {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
                       width:28px;height:28px;}
  .crosshair .reticle::before {content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;
                               border-radius:50%;box-shadow:0 0 8px #000a;}
  .crosshair .reticle .h,.crosshair .reticle .v {position:absolute;background:#e5e7ebaa;
                                                 box-shadow:0 0 6px #0008;}
  .crosshair .reticle .h {width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%);}
  .crosshair .reticle .v {width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%);}
  .toast {margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;
          border:1px solid #14532d;color:#bbf7d0;display:none;}
</style>
</head>
<body>
  <header>üìã FORM SURVEY TAHAP 2</header>
  <main>
    <div class="card">
      <h2>Data Survey</h2>
      <div id="toast" class="toast"></div>

      <form id="surveyForm">
        <div class="row">
          <div><label>Balai / BBWS</label><select id="balai" name="balai"></select></div>
          <div><label>Provinsi</label><select id="prov" name="provinsi" disabled></select></div>
        </div>
        <div class="row">
          <div><label>Kabupaten</label><select id="kab" name="kabupaten" disabled></select></div>
          <div><label>Daerah Irigasi (D.I.)</label><select id="di" name="di" disabled></select></div>
        </div>
        <div class="row">
          <div><label>Nama Petugas</label><input type="text" id="nama" name="nama" required></div>
          <div><label>No. Telepon</label><input type="text" id="telepon" name="telepon" required></div>
        </div>

        <div>
          <label>Peta Lokasi</label>
          <div style="position:relative;">
            <div id="map"></div>
            <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
          </div>
        </div>

        <div class="row">
          <div><label>Latitude</label><input type="number" step="any" id="lat" name="lat"></div>
          <div><label>Longitude</label><input type="number" step="any" id="lng" name="lng"></div>
        </div>

        <div class="actions">
          <button type="button" id="btnLocate" class="ghost">üìç Lokasi Saya</button>
          <button type="button" id="btnPick" class="primary">‚úÖ Pilih Lokasi dari Peta</button>
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke Koordinat</button>
        </div>

        <div>
          <label>Foto Progres</label>
          <input type="file" accept="image/*" id="foto" name="foto" required>
        </div>

        <div class="actions">
          <button type="submit" class="primary">Kirim</button>
          <button type="reset" class="ghost">Reset</button>
        </div>
      </form>
    </div>
  </main>

<script>
const ENDPOINT = 'https://gas-proxy2.tuic1677.workers.dev/';
const DATA_URL = 'https://script.google.com/macros/s/AKfycbwWe8SY1T51LL3yp_OlLlOORuMLjcVkbaL1td5pOm1EX0-POztzV-6CUl-tQo91OMzT/exec';

const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';
clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',4000);};

const titleCase=s=>{
  s=String(s||'').trim();
  if(/^(BWS|BBWS)$/i.test(s))return 'BBWS';
  if(/^(D\.?I\.?|DI)$/i.test(s))return 'D.I.';
  return s.split(/(\s+|[-/])/).map(tok=>{
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/')return tok;
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join('');
};

function fillSelect(el, items, ph){
  el.innerHTML='';
  if(ph){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);}
  (items||[]).forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);});
  el.disabled=!(items&&items.length);
}

/* MAP */
const base=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20});
const map=L.map('map',{zoomControl:true,layers:[base]}).setView([-2.5,118],5);
document.getElementById('btnLocate').onclick=()=>map.locate({setView:true,maxZoom:17});
document.getElementById('btnPick').onclick=()=>{const c=map.getCenter();lat.value=c.lat.toFixed(6);lng.value=c.lng.toFixed(6);};
document.getElementById('btnPan').onclick=()=>{if(lat.value&&lng.value)map.setView([+lat.value,+lng.value],16);};

const balai=document.getElementById('balai'),
prov=document.getElementById('prov'),
kab=document.getElementById('kab'),
di=document.getElementById('di'),
lat=document.getElementById('lat'),
lng=document.getElementById('lng'),
form=document.getElementById('surveyForm');

let INDEX={};
async function loadData(){
  const r=await fetch(DATA_URL+'?t='+Date.now());
  const data=await r.json();
  data.forEach(d=>{
    const B=titleCase(d['B/BWS PELAKSANA']);
    const P=titleCase(d['PROVINSI']);
    const K=titleCase(d['KABUPATEN']);
    const D=titleCase(d['NAMA DI/DIR']);
    if(!(B&&P&&K&&D))return;
    INDEX[B]??={};INDEX[B][P]??={};INDEX[B][P][K]??=[];INDEX[B][P][K].push(D);
  });
  fillSelect(balai,Object.keys(INDEX).sort(),'-- pilih BBWS/BWS --');
}
loadData();

/* Cascading */
balai.onchange=()=>{const b=balai.value;fillSelect(prov,b?Object.keys(INDEX[b]):[],'-- pilih Provinsi --');
fillSelect(kab,[], '-- pilih Kabupaten --');fillSelect(di,[], '-- pilih D.I. --');};
prov.onchange=()=>{const b=balai.value,p=prov.value;fillSelect(kab,p?Object.keys(INDEX[b][p]):[],'-- pilih Kabupaten --');
fillSelect(di,[], '-- pilih D.I. --');};
kab.onchange=()=>{const b=balai.value,p=prov.value,k=kab.value;fillSelect(di,k?(INDEX[b][p][k]||[]):[],'-- pilih D.I. --');};

/* History check ke GAS */
async function fetchHistory(b,p,k,d){
  const u=DATA_URL+`?fn=history&bws=${encodeURIComponent(b)}&prov=${encodeURIComponent(p)}&kab=${encodeURIComponent(k)}&di=${encodeURIComponent(d)}`;
  try{const r=await fetch(u);const j=await r.json();return j;}catch(e){return {ok:false};}
}

di.onchange=async()=>{
  const b=balai.value,p=prov.value,k=kab.value,d=di.value;
  const hist=await fetchHistory(b,p,k,d);
  if(hist.ok&&hist.coords){
    lat.value=hist.coords.lat.toFixed(6);
    lng.value=hist.coords.lng.toFixed(6);
    [lat,lng,document.getElementById('btnPick'),
     document.getElementById('btnLocate'),document.getElementById('btnPan')].forEach(e=>e.disabled=true);
    toast('Koordinat terkunci dari entri sebelumnya.');
  }else{
    [lat,lng,document.getElementById('btnPick'),
     document.getElementById('btnLocate'),document.getElementById('btnPan')].forEach(e=>e.disabled=false);
  }
};

/* Submit */
form.onsubmit=async(e)=>{
  e.preventDefault();
  const fd=new FormData(form);
  const res=await fetch(ENDPOINT,{method:'POST',body:fd});
  const j=await res.json();
  toast(j.ok?'‚úÖ Data terkirim!':'‚ùå Gagal: '+(j.error||''));
};
</script>
</body>
</html>
