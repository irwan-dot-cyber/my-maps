<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Form Survey Tahap 2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  body{font-family:sans-serif;margin:0;padding:0;background:#fafafa;}
  header{background:#FFD700;padding:10px;text-align:center;font-weight:700;}
  form{padding:15px;}
  select,input,button{padding:8px;margin:5px 0;width:100%;max-width:100%;}
  button{cursor:pointer;}
  button.primary{background:#2563eb;color:#fff;border:none;border-radius:5px;}
  button.ghost{background:#ccc;color:#444;border:none;border-radius:5px;}
  #map{height:300px;margin:10px 0;border:1px solid #ddd;}
  #toast{display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
         background:#000;color:#fff;padding:10px 20px;border-radius:6px;z-index:999;}
  #coordBadge{font-size:13px;margin-top:4px;}
  .locked{color:#22c55e;}
  .none{color:#f97316;}
</style>
</head>
<body>
<header>üìã FORM SURVEY TAHAP 2</header>

<form id="surveyForm">
  <label>Balai / BBWS:</label>
  <select id="balai" name="balai"></select>

  <label>Provinsi:</label>
  <select id="prov" name="provinsi"></select>

  <label>Kabupaten:</label>
  <select id="kab" name="kabupaten"></select>

  <label>Daerah Irigasi (D.I.):</label>
  <select id="di" name="di"></select>

  <label>Nama Petugas:</label>
  <input type="text" id="nama" name="nama" required>

  <label>No. Telepon:</label>
  <input type="text" id="telepon" name="telepon" required>

  <div id="map"></div>

  <label>Koordinat:</label>
  <div style="display:flex;gap:5px;">
    <input type="number" step="any" id="lat" name="lat" placeholder="Latitude">
    <input type="number" step="any" id="lng" name="lng" placeholder="Longitude">
  </div>
  <div id="coordBadge" class="none">Koordinat: belum ada, silakan pilih titik</div>

  <button type="button" id="btnLocate" class="primary">Lokasi Saya</button>
  <button type="button" id="btnPick" class="primary">Pilih Lokasi dari Peta</button>
  <button type="button" id="btnPan" class="primary">Pan ke Koordinat</button>

  <label>Foto Progres:</label>
  <input type="file" id="foto" name="foto" accept="image/*" required>

  <button id="btnSubmit" class="primary">Kirim Data</button>
</form>

<div id="toast"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===== CONFIG ===== */
const ENDPOINT = 'https://gas-proxy2.tuic1677.workers.dev/';
const DATA_URL = 'https://script.google.com/macros/s/AKfycbwWe8SY1T51LL3yp_OlLlOORuMLjcVkbaL1td5pOm1EX0-POztzV-6CUl-tQo91OMzT/exec';

/* ===== Utils ===== */
const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';
clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',4200);};

function fillSelect(el,items,ph){
  el.innerHTML='';
  if(ph){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);}
  items.forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);});
}
const uniq=a=>[...new Set((a||[]).filter(Boolean))];

const titleCase=s=>{
  s=String(s||'').trim();
  if(/^(BWS|BBWS)$/i.test(s))return 'BBWS';
  if(/^(D\.?I\.?|DI)$/i.test(s))return 'D.I.';
  return s.split(/(\s+|[-/])/).map(tok=>{
    if(/^\s+$/.test(tok)||tok==='-'||tok==='/')return tok;
    return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
  }).join('');
};

function lockSelect(el){el.disabled=false;el.dataset.locked=1;
  el.addEventListener('mousedown',e=>{if(el.dataset.locked)e.preventDefault();});
}

/* ===== Map ===== */
const map=L.map('map',{zoomControl:true}).setView([-2.5,118],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
map.on('move',()=>{const c=map.getCenter();});

/* ===== DOM ===== */
const balai=document.getElementById('balai'),
      prov=document.getElementById('prov'),
      kab=document.getElementById('kab'),
      di=document.getElementById('di'),
      lat=document.getElementById('lat'),
      lng=document.getElementById('lng'),
      form=document.getElementById('surveyForm'),
      btnSubmit=document.getElementById('btnSubmit'),
      coordBadge=document.getElementById('coordBadge'),
      btnLocate=document.getElementById('btnLocate'),
      btnPick=document.getElementById('btnPick'),
      btnPan=document.getElementById('btnPan');

/* ===== Fungsi lock koordinat ===== */
function setCoordBadge(type,text){
  coordBadge.textContent=text;
  coordBadge.className=type;
}
function setCoordLock(locked,la,ln){
  [lat,lng,btnPick,btnPan,btnLocate].forEach(el=>el.disabled=locked);
  if(locked){
    if(la && ln){lat.value=Number(la).toFixed(6);lng.value=Number(ln).toFixed(6);}
    btnPick.classList.remove('primary');btnPick.classList.add('ghost');
  }else{
    btnPick.classList.add('primary');btnPick.classList.remove('ghost');
  }
}

/* ===== Map tombol ===== */
btnLocate.onclick=()=>map.locate({setView:true,maxZoom:17});
btnPick.onclick=()=>{const c=map.getCenter();lat.value=c.lat.toFixed(6);lng.value=c.lng.toFixed(6);};
btnPan.onclick=()=>{if(lat.value&&lng.value)map.setView([+lat.value,+lng.value],16);};

/* ===== Load baseline ===== */
let INDEX={};
async function loadData(){
  const resp=await fetch(DATA_URL+'?t='+Date.now());
  const rows=await resp.json();
  rows.forEach(r=>{
    const B=titleCase(r['B/BWS PELAKSANA']||r['Balai']);
    const P=titleCase(r['PROVINSI']||r['Provinsi']);
    const K=titleCase(r['KABUPATEN']||r['Kabupaten']);
    const D=titleCase(r['NAMA DI/DIR']||r['nama di']);
    if(!(B&&P&&K&&D))return;
    INDEX[B]??={};INDEX[B][P]??={};INDEX[B][P][K]??=[];INDEX[B][P][K].push(D);
  });
  fillSelect(balai,Object.keys(INDEX).sort(),'-- pilih BBWS/BWS --');
}
loadData();

/* ===== Cascade dropdown ===== */
balai.onchange=()=>{const b=balai.value;fillSelect(prov,b?Object.keys(INDEX[b]):[], '-- pilih Provinsi --');lockSelect(prov);};
prov.onchange=()=>{const b=balai.value,p=prov.value;fillSelect(kab,p?Object.keys(INDEX[b][p]):[], '-- pilih Kabupaten --');lockSelect(kab);};
kab.onchange=()=>{const b=balai.value,p=prov.value,k=kab.value;fillSelect(di,k?uniq(INDEX[b][p][k]).sort():[], '-- pilih D.I. --');lockSelect(di);};

/* ===== History check dummy (bisa dihubungkan ke GAS) ===== */
async function fetchHistory(){
  return {maxStage:0,coords:null,photos:{}};
}

/* ===== Handle pilih D.I. ===== */
di.onchange=async()=>{
  const hist=await fetchHistory();
  if(hist.coords){
    setCoordLock(true,hist.coords.lat,hist.coords.lng);
    setCoordBadge('locked','Koordinat: terkunci (pakai entri sebelumnya)');
  }else{
    setCoordLock(false);
    setCoordBadge('none','Koordinat: belum ada, silakan pilih titik');
  }
};

/* ===== Submit ===== */
form.onsubmit=async e=>{
  e.preventDefault();
  btnSubmit.disabled=true;
  const fd=new FormData(form);
  const resp=await fetch(ENDPOINT,{method:'POST',body:fd});
  const j=await resp.json();
  toast(j.ok?'‚úÖ Data terkirim!':'‚ùå Gagal kirim: '+j.error);
  btnSubmit.disabled=false;
};
</script>
</body>
</html>
