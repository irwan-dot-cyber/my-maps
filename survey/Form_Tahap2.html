<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Form Survey (Tahap 2)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    form{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:10px}
    .primary{background:var(--accent);color:#01250f;font-weight:600}
    .ghost{background:#0b1224;color:#e5e7eb;border:1px solid #334155}
    .hint{font-size:12px;color:var(--mut)}
    #map{height:60vh}
    .mapwrap{position:relative}
    .crosshair{position:absolute;inset:0;pointer-events:none;display:grid;place-items:center;z-index:1000}
    .crosshair .reticle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:28px;height:28px}
    .crosshair .reticle::before{content:"";position:absolute;inset:0;border:2px solid #e5e7ebcc;border-radius:50%;box-shadow:0 0 8px #000a}
    .crosshair .reticle .h,.crosshair .reticle .v{position:absolute;background:#e5e7ebaa;box-shadow:0 0 6px #0008}
    .crosshair .reticle .h{width:14px;height:2px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .crosshair .reticle .v{width:2px;height:14px;left:50%;top:50%;transform:translate(-50%,-50%)}
    .toast{margin:10px 14px;padding:10px 12px;border-radius:10px;background:#052e1a;border:1px solid #14532d;color:#bbf7d0;display:none}
    #uploadOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.65);backdrop-filter:blur(3px);z-index:9999}
    .u-box{background:#0b1222;border:1px solid #263142;border-radius:16px;padding:18px 22px;min-width:300px;max-width:92vw}
    .u-title{font-weight:800;margin-bottom:6px}
    .u-progress{height:10px;border:1px solid #263142;border-radius:999px;overflow:hidden;margin-top:10px;background:#0b1222}
    #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#86efac)}
    .u-hint{font-size:12px;color:#a1a1aa;margin-top:8px}
    @media (max-width:820px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <strong>Form Survey</strong>
    <span class="hint"> Pelaksanaan INPRES 2/2025 Tahap 2</span>
  </header>

  <main>
    <div class="card">
      <h2>Data Survey</h2>
      <div id="toast" class="toast"></div>

      <form id="surveyForm">
        <div class="row">
          <div><label>B/BWS</label><select id="balai" name="balai" required></select></div>
          <div><label>Provinsi</label><select id="provinsi" name="provinsi" required disabled></select></div>
        </div>

        <div class="row">
          <div><label>Kabupaten/Kota</label><select id="kabupaten" name="kabupaten" required disabled></select></div>
          <div><label>Nama DI</label><select id="paket" name="paket" required disabled></select></div>
        </div>

        <div class="row">
          <div><label>Kecamatan (otomatis)</label><input id="kecamatan" name="kecamatan" placeholder="Otomatis dari DI" readonly/></div>
          <div><label>Desa/Kelurahan (otomatis)</label><input id="desa" name="desa" placeholder="Otomatis dari DI" readonly/></div>
        </div>

        <div>
          <label>Peta Lokasi</label>
          <div class="mapwrap">
            <div id="map"></div>
            <div class="crosshair"><div class="reticle"><span class="h"></span><span class="v"></span></div></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button id="btnLocate" type="button" class="ghost">üìç Lokasi saya</button>
            <button id="btnPick" type="button" class="primary">‚úÖ Pilih lokasi (ambil dari tanda Ôºã)</button>
            <span class="hint" id="coords">Lat: -, Lng: -</span>
          </div>
        </div>

        <div class="row">
          <div><label>Latitude</label><input type="number" step="0.000001" id="lat" name="lat" placeholder="Klik 'Pilih lokasi' atau isi manual" required/></div>
          <div><label>Longitude</label><input type="number" step="0.000001" id="lng" name="lng" required/></div>
        </div>
        <div class="actions" style="margin-top:4px">
          <button type="button" id="btnPan" class="ghost">üß≠ Pan ke koordinat</button>
        </div>

        <div>
          <label>Foto Lokasi</label>
          <div class="actions" style="gap:8px;margin-bottom:6px">
            <button type="button" id="btnCamera" class="ghost">üì∑ Kamera</button>
            <button type="button" id="btnGallery" class="ghost">üñºÔ∏è Galeri</button>
            <span id="photoMeta" class="hint"></span>
          </div>
          <input type="file" accept="image/*" id="fileInput" name="foto" style="display:none">
          <div class="hint">Pilih kamera/galeri. Foto dikompresi otomatis & dikirim juga sebagai base64 fallback.</div>
        </div>

        <div class="row">
          <div><label>Nama Pengirim</label><input id="nama" name="nama" placeholder="Nama lengkap" required/></div>
          <div><label>Nomor WA/HP</label><input id="telepon" name="telepon" placeholder="08xxxxxxxxxx / 628xxxxxxxxxx" pattern="[0-9+]{8,15}" required/></div>
        </div>

        <div class="actions">
          <button type="submit" class="primary">Kirim</button>
          <button type="reset" class="ghost" id="btnReset">Reset</button>
        </div>
      </form>
    </div>
  </main>

  <div id="uploadOverlay">
    <div class="u-box" role="alert" aria-live="assertive">
      <div class="u-title" id="uploadTitle">Mengunggah data‚Ä¶</div>
      <div class="u-progress"><div id="progressBar"></div></div>
      <div class="u-hint" id="uploadHint">Jangan tutup halaman ini.</div>
    </div>
  </div>

<script>
/* ===== CONFIG (Upload path tidak diubah) ===== */
const ENDPOINT = 'https://gas-proxy.tuic1677.workers.dev/'; // tetap sama
const DATA_URL = 'https://script.google.com/macros/s/AKfycbylSlXUDFGtiKh9xubcms6F6-bsKPAOFhIZo_kmilsr_6HEdsPdtxdJqP5RRrl4smGD/exec';

/* ===== Utils & UI ===== */
const toast = (m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>t.style.display='none',5000);};
function fillSelect(el, items, ph='-- pilih --'){el.innerHTML=''; if(ph&&!el.multiple){const o=document.createElement('option');o.value='';o.textContent=ph;el.appendChild(o);} (items||[]).forEach(v=>{const o=document.createElement('option');o.value=o.textContent=v;el.appendChild(o);}); el.disabled=!(items&&items.length);}
const uniq = a => [...new Set((a||[]).filter(Boolean))];
const norm = s => String(s||'').trim();
const titleCase = s => norm(s).toLowerCase().replace(/(^|\s|-|\/)\S/g, t=>t.toUpperCase());

// ambil nilai dari beberapa kemungkinan alias header
function getAlias(row, aliases){
  for(const k of aliases){
    if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== '') return row[k];
  }
  return '';
}

function splitList(val){
  return uniq(norm(val)
    .replace(/\r/g,'')
    .split(/\n|,|;|\/| dan /i)
    .map(x=>titleCase(x.replace(/^\s*-\s*/,'').trim()))
    .filter(Boolean));
}

/* ===== DOM ===== */
const $balai = document.getElementById('balai');      // BWS
const $prov  = document.getElementById('provinsi');
const $kab   = document.getElementById('kabupaten');
const $di    = document.getElementById('paket');      // Nama DI (pakai id 'paket' agar kompatibel)
const $kec   = document.getElementById('kecamatan');
const $desa  = document.getElementById('desa');

function disableChain(level){
  if(level<=0){ fillSelect($prov,[], '-- pilih Provinsi --'); $prov.disabled=true; }
  if(level<=1){ fillSelect($kab,[], '-- pilih Kabupaten/Kota --'); $kab.disabled=true; }
  if(level<=2){ fillSelect($di,[], '-- pilih Nama DI --'); $di.disabled=true; }
  if(level<=3){ $kec.value=''; $desa.value=''; }
}

/* ===== Hierarchy: BWS -> PROV -> KAB -> DI ===== */
let INDEX={};

async function fetchFlexible(url){
  const r = await fetch(url, {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const ct = r.headers.get('content-type')||'';
  if (ct.includes('application/json')){
    const js = await r.json();
    // bentuk fleksibel: bisa array langsung, atau objek dengan {records|data|rows|result}
    if (Array.isArray(js)) return js;
    const cand = js.records || js.data || js.rows || js.result || js.items;
    return Array.isArray(cand) ? cand : [];
  } else {
    // fallback CSV sederhana
    const text = await r.text();
    const lines = text.trim().split(/\r?\n/);
    if(lines.length<2) return [];
    const headers = lines[0].split(',').map(h=>h.trim());
    return lines.slice(1).map(line=>{
      const cells = line.split(',').map(v=>v.trim());
      const obj = {};
      headers.forEach((h,i)=>obj[h]=cells[i]||'');
      return obj;
    });
  }
}

async function loadData(){
  try{
    const rows = await fetchFlexible(DATA_URL);

    INDEX = {}; // {BWS:{PROV:{KAB:{DI:{kecamatan:Set, desa:Set}}}}}
    let inserted = 0;

    rows.forEach(row=>{
      const BWS  = titleCase(getAlias(row, ['BWS','B/BWS','B/BWS PELAKSANA','BALAI','BBWS']));
      const PROV = titleCase(getAlias(row, ['PROVINSI','PROV']));
      const KAB  = titleCase(getAlias(row, ['KABUPATEN','KAB/KOTA','KABUPATEN/KOTA']));
      const DI   = titleCase(getAlias(row, ['NAMA_DI','NAMA DI/DIR','DI','NAMA DI']));
      const KECV = getAlias(row, ['KECAMATAN','Kecamatan']);
      const DESV = getAlias(row, ['DESA','Desa','DESA/KEL']);

      if(!BWS || !PROV || !KAB || !DI) return; // skip baris yang gak lengkap

      const kecs = splitList(KECV);
      const desas= splitList(DESV);

      if(!INDEX[BWS]) INDEX[BWS] = {};
      if(!INDEX[BWS][PROV]) INDEX[BWS][PROV] = {};
      if(!INDEX[BWS][PROV][KAB]) INDEX[BWS][PROV][KAB] = {};
      if(!INDEX[BWS][PROV][KAB][DI]) INDEX[BWS][PROV][KAB][DI] = {kecamatan:new Set(), desa:new Set()};

      kecs.forEach(k=>INDEX[BWS][PROV][KAB][DI].kecamatan.add(k));
      desas.forEach(d=>INDEX[BWS][PROV][KAB][DI].desa.add(d));
      inserted++;
    });

    const keys = Object.keys(INDEX).sort();
    fillSelect($balai, keys, '-- pilih B/BWS --');
    disableChain(0);

    if (!keys.length){
      toast('‚ö†Ô∏è Tidak ada data BWS yang terbaca. Cek header Sheet/GAS JSON.');
      console.warn('Tidak ada BWS. Contoh row pertama:', rows[0]);
    } else {
      toast(`‚úÖ Data dimuat. BWS terdeteksi: ${keys.length}`);
    }
  }catch(e){
    console.error(e);
    toast('‚ö†Ô∏è Gagal memuat data (periksa DATA_URL / akses publik Web App).');
    fillSelect($balai, [], '-- gagal memuat BWS --');
    disableChain(0);
  }
}

/* ===== Cascading ===== */
$balai.addEventListener('change', ()=>{
  const b = $balai.value;
  if(!b){ disableChain(0); return; }
  const provs = Object.keys(INDEX[b]||{}).sort();
  fillSelect($prov, provs, '-- pilih Provinsi --'); $prov.disabled = provs.length===0;
  disableChain(1);
});

$prov.addEventListener('change', ()=>{
  const b = $balai.value, p = $prov.value;
  if(!b||!p){ disableChain(1); return; }
  const kabs = Object.keys((INDEX[b]||{})[p]||{}).sort();
  fillSelect($kab, kabs, '-- pilih Kabupaten/Kota --'); $kab.disabled = kabs.length===0;
  disableChain(2);
});

$kab.addEventListener('change', ()=>{
  const b = $balai.value, p = $prov.value, k = $kab.value;
  if(!b||!p||!k){ disableChain(2); return; }
  const dis = Object.keys((((INDEX[b]||{})[p]||{})[k]||{})).sort();
  fillSelect($di, dis, '-- pilih Nama DI --'); $di.disabled = dis.length===0;
  disableChain(3);
});

$di.addEventListener('change', ()=>{
  const b = $balai.value, p = $prov.value, k = $kab.value, d = $di.value;
  if(!b||!p||!k||!d){ $kec.value=''; $desa.value=''; return; }
  const node = (((INDEX[b]||{})[p]||{})[k]||{})[d];
  const kecs = node ? Array.from(node.kecamatan).sort() : [];
  const desas= node ? Array.from(node.desa).sort() : [];
  $kec.value  = kecs.join(', ');
  $desa.value = desas.join(', ');
});

/* ===== Map (tetap) ===== */
const baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImg=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
const map=L.map('map',{zoomControl:true,layers:[baseOSM]}); L.control.layers({OSM:baseOSM,'Esri Imagery':baseImg}, {}, {position:'topright', collapsed:false}).addTo(map);
map.setView([-2.5,118],5); const coords=document.getElementById('coords'); function upd(){const c=map.getCenter(); coords.textContent=`Lat: ${c.lat.toFixed(6)}, Lng: ${c.lng.toFixed(6)}`;} map.on('move',upd); map.whenReady(upd);
document.getElementById('btnLocate').addEventListener('click',()=>map.locate({setView:true,maxZoom:17,enableHighAccuracy:true}));
map.on('locationerror',()=>alert('Izin lokasi ditolak. Geser peta manual.'));
document.getElementById('btnPick').addEventListener('click',()=>{const c=map.getCenter(); lat.value=c.lat.toFixed(6); lng.value=c.lng.toFixed(6);});
document.getElementById('btnPan').addEventListener('click',()=>{const la=+lat.value,lo=+lng.value; if(!Number.isNaN(la)&&!Number.isNaN(lo)) map.setView([la,lo],Math.max(map.getZoom(),16));});

/* ===== Foto + kompresi + base64 fallback (tetap) ===== */
const fileInput = document.getElementById('fileInput');
const photoMeta = document.getElementById('photoMeta');
let selectedFile = null;

document.getElementById('btnCamera').addEventListener('click',()=>{ fileInput.setAttribute('capture','environment'); fileInput.click(); });
document.getElementById('btnGallery').addEventListener('click',()=>{ fileInput.removeAttribute('capture'); fileInput.click(); });

fileInput.addEventListener('change',()=>{
  selectedFile = fileInput.files?.[0] || null;
  photoMeta.textContent = selectedFile ? `Dipilih: ${selectedFile.name} ‚Ä¢ ${(selectedFile.size/1024).toFixed(1)} KB` : '';
});

async function compressImage(file,{maxDim=2000,quality=0.82,mime='image/jpeg'}={}){ try{
  if(!(file&&file.type&&file.type.startsWith('image/'))) return file; let bitmap; if(window.createImageBitmap){bitmap=await createImageBitmap(file,{imageOrientation:'from-image'});}
  const dims=f=>new Promise((res,rej)=>{const i=new Image(); i.onload=()=>res({w:i.width,h:i.height}); i.onerror=rej; i.src=URL.createObjectURL(f);});
  const {w:W,h:H}=bitmap?{w:bitmap.width,h:bitmap.height}:await dims(file); const s=Math.min(1,maxDim/Math.max(W,H)); const w=Math.round(W*s), h=Math.round(H*s);
  if(s===1 && file.type==='image/jpeg' && file.size<700*1024) return file; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
  if(bitmap) ctx.drawImage(bitmap,0,0,w,h); else {const i=new Image(); await new Promise((r,j)=>{i.onload=r;i.onerror=j;i.src=URL.createObjectURL(file)}); ctx.drawImage(i,0,0,w,h);}
  const blob=await new Promise(r=>c.toBlob(r,mime,quality)); if(!blob||blob.size>=file.size) return file; const name=(file.name.replace(/\.(jpe?g|png|webp|heic|heif)$/i,'')||'foto')+'.jpg'; return new File([blob],name,{type:mime});
}catch(e){console.warn('compress fail',e); return file;}}

function setUploadingUI({show,percent}){ if(typeof percent==='number') document.getElementById('progressBar').style.width=Math.max(0,Math.min(100,Math.round(percent)))+'%'; document.getElementById('uploadOverlay').style.display=show?'flex':'none'; }
function disableForm(b){document.querySelectorAll('#surveyForm input, #surveyForm select, #surveyForm button').forEach(e=>e.disabled=!!b);}

/* ===== Submit via XHR (tetap) ===== */
const form=document.getElementById('surveyForm'); const lat=document.getElementById('lat'); const lng=document.getElementById('lng');
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!$balai.value||!$prov.value||!$kab.value||!$di.value){toast('Lengkapi BWS, Provinsi, Kabupaten, dan DI.'); return;}
  if(!lat.value||!lng.value){toast('Koordinat belum diisi.'); return;}

  let b64 = ''; let photo = null;
  if (selectedFile) {
    photo = await compressImage(selectedFile,{maxDim:2000,quality:0.82});
    const dt = new DataTransfer(); dt.items.add(photo); fileInput.files = dt.files;
    b64 = await new Promise((res, rej) => { const r = new FileReader(); r.onload=()=>res(String(r.result)); r.onerror=rej; r.readAsDataURL(photo); });
    photoMeta.textContent = `Akan dikirim: ${photo.name} ‚Ä¢ ${(photo.size/1024).toFixed(1)} KB`;
  }

  const fd = new FormData(form);
  if (b64) { fd.set('foto_b64', b64); fd.set('foto_name', photo.name); fd.set('foto_type', photo.type); }

  disableForm(true); setUploadingUI({show:true, percent:6});

  const xhr = new XMLHttpRequest();
  xhr.open('POST', ENDPOINT, true);
  xhr.upload.onprogress = (ev)=>{ if (ev.lengthComputable) setUploadingUI({show:true, percent:(ev.loaded/ev.total)*100}); };
  xhr.onloadstart = ()=> setUploadingUI({show:true, percent:5});
  xhr.onreadystatechange = ()=>{ if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) setUploadingUI({show:true, percent:95}); };
  xhr.onerror = ()=>{ setUploadingUI({show:false}); disableForm(false); toast('‚ùå Gagal kirim (jaringan/proxy).'); };
  xhr.onload = ()=>{
    let data={}; try{ data = JSON.parse(xhr.responseText||'{}'); }catch(e){}
    if (xhr.status>=200 && xhr.status<300 && (data.ok===true || data.status==='ok')) {
      setUploadingUI({show:true, percent:100}); toast('‚úÖ Terkirim!');
      setTimeout(()=>{ setUploadingUI({show:false}); form.reset(); selectedFile=null; photoMeta.textContent='';
        fillSelect($balai, Object.keys(INDEX).sort(), '-- pilih B/BWS --');
        disableChain(0); disableForm(false);
      }, 600);
    } else {
      setUploadingUI({show:false}); disableForm(false);
      toast('‚ùå Gagal kirim (server). Cek console.');
    }
  };
  xhr.send(fd);
});

/* ===== Reset ===== */
document.getElementById('btnReset').addEventListener('click', ()=>{
  selectedFile=null; photoMeta.textContent='';
  fillSelect($balai, Object.keys(INDEX).sort(), '-- pilih B/BWS --');
  disableChain(0);
});

/* ===== Start ===== */
loadData();
</script>
</body>
</html>
