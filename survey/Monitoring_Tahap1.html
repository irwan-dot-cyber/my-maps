<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dashboard Survey — Si-Irwan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" href="../../assets/LogoPUPR.png" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  :root{
    --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted-2:#94a3b8;
    --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92); --border:rgba(255,255,255,.12);
    --hdrH:88px; --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .header{position:fixed;top:0;left:0;right:0;z-index:900;background:var(--survey);border-bottom:1px solid rgba(255,255,255,.18);padding:10px 16px;display:flex;align-items:center;gap:14px;box-shadow:0 6px 18px rgba(13,71,161,.25)}
  .header img{height:54px}
  .header .text{flex:1;color:#fff}
  .header .title{font-weight:800;font-size:14px;line-height:1.35}
  .header .subtitle{font-weight:600;font-size:12px;color:rgba(255,255,255,.9);margin-top:4px}
  .btn-home{background:#fff;color:var(--survey);font-weight:700;padding:8px 14px;border-radius:10px;text-decoration:none;font-size:13px}
  .btn-home:hover{background:#f1f5f9}
  .spacer{height:var(--hdrH)}
  #map{height:calc(100vh - var(--hdrH))}
  .dock{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--border);max-height:46vh;overflow:auto;padding:12px 14px;box-shadow:0 -10px 22px rgba(0,0,0,.28);z-index:950;backdrop-filter:blur(6px)}
  .dock h2{font-size:14px;margin:0 0 8px;font-weight:800;color:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:var(--muted)}
  select{width:100%;padding:10px 12px;font-size:14px;background:rgba(255,255,255,.06);color:#fff;border:1px solid var(--border);border-radius:var(--radius);outline:none}
  option{color:#000;background:#fff}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px;font-size:13px;color:var(--muted)}
  .row b{color:#fff}
  .meta{font-size:13px;border-collapse:collapse;width:100%;color:var(--text)}
  .meta td{border-bottom:1px dashed rgba(255,255,255,.08);padding:6px 2px}
  .key{color:var(--muted-2);width:42%}
  @media(max-width:680px){.grid{grid-template-columns:1fr}:root{--hdrH:96px}}
  .badge-irwan{position:fixed;right:12px;bottom:96px;z-index:1200;background:rgba(13,71,161,.85);border:1px solid rgba(255,255,255,.25);color:#fff;font-size:12px;font-weight:700;padding:6px 12px;border-radius:10px;box-shadow:0 0 10px rgba(13,71,161,.6);backdrop-filter:blur(6px);animation:glow 2.8s ease-in-out infinite}
  .badge-irwan span{color:#FFD700}
  @keyframes glow{0%,100%{box-shadow:0 0 8px rgba(13,71,161,.6)}50%{box-shadow:0 0 18px rgba(255,215,0,.8)}}

  /* Label DI */
  .di-label{
    background: rgba(255,255,255,.92);
    border: 1px solid #d1d5db;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 12px;
    color:#111;
    box-shadow: 0 1px 6px rgba(0,0,0,.12);
  }
</style>
</head>
<body>
<div class="header">
  <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
  <div class="text">
    <div class="title">Kementerian Pekerjaan Umum</div>
    <div class="subtitle">Direktorat Jenderal Sumber Daya Air — Direktorat Irigasi & Rawa</div>
    <div class="subtitle">Dashboard Titik Survey (CSV)</div>
  </div>
  <a href="../../si-irwan.html" class="btn-home">Beranda</a>
</div>
<div class="spacer"></div>

<div id="map"></div>

<div class="dock">
  <h2>Filter & Statistik</h2>
  <div class="grid">
    <div>
      <label>Filter BBWS</label>
      <select id="bbwsSel"><option value="">— Semua —</option></select>
    </div>
    <div>
      <label>Pilih Daerah Irigasi (nama_di)</label>
      <select id="diSel"><option value="">— Semua —</option></select>
    </div>
  </div>
  <hr style="border:none;border-top:1px solid var(--border);margin:10px 0"/>
  <div id="stats" class="row"></div>
  <div id="detail" style="margin-top:8px"></div>
</div>

<div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
  <span>Si-Irwan v1.0</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = "survey.csv";
const LABEL_ZOOM = 9; // tampilkan label saat zoom >= 9

const map = L.map('map').setView([-2.5,117.5],5);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  {attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics'}).addTo(map);

const cluster=L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:54});
map.addLayer(cluster);

// layer khusus untuk label supaya gampang di-clear/add saat refresh
const labelLayer = L.layerGroup().addTo(map);

const bbwsSel=document.getElementById('bbwsSel');
const diSel=document.getElementById('diSel');
const statsEl=document.getElementById('stats');
const detailEl=document.getElementById('detail');
let markers=[],rawRows=[],diByBbws=new Map(),allDiList=[];

function colorForStatus(s){const c={Selesai:"#22c55e",Proses:"#f59e0b",Terkendala:"#ef4444",Direncanakan:"#3b82f6"};return c[s]||"#a3a3a3";}
function circleStyle(s){return{radius:7,color:"#fff",weight:1,fillColor:colorForStatus(s),fillOpacity:.9};}
function distinct(a){return[...new Set(a.filter(v=>v!==undefined && v!==null && v!==""))];}
function normalizeLatLon(r){const k=Object.keys(r);const latKey=k.find(k=>/^(lat|latitude|y)$/i.test(k));const lonKey=k.find(k=>/^(lon|long|longitude|x)$/i.test(k));return{lat:parseFloat(r[latKey]),lon:parseFloat(r[lonKey])};}
function setOptions(sel,arr,ph){sel.innerHTML=`<option value="">— ${ph} —</option>`;arr.forEach(v=>sel.insertAdjacentHTML('beforeend',`<option value="${v}">${v}</option>`));}
function buildTable(o){
  const rows = Object.entries(o).filter(([k,v])=>v!==null && v!==undefined && String(v).trim()!=="")
               .map(([k,v])=>`<tr><td class='key'>${k}</td><td>${v}</td></tr>`).join("");
  return "<table class='meta'>"+(rows||"<tr><td>(tidak ada data)</td></tr>")+"</table>";
}
function showDetail(d,latlng){
  detailEl.innerHTML=`<h3 style="margin:6px 0;color:#fff">${d.nama_di||d.kegiatan||d.kabupaten||"Detail Survey"}</h3>
    <div style="font-size:12px;color:#cbd5e1;margin-bottom:6px">Koordinat: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}</div>
    ${buildTable(d)}`;
}

function rebuildDiOptions(){
  const b=bbwsSel.value;
  if(b){ setOptions(diSel, diByBbws.get(b)||[], "Semua DI di BBWS ini"); }
  else{ setOptions(diSel, allDiList, "Semua DI"); }
  diSel.value="";
}

function refresh(autoZoom=true){
  const b=(bbwsSel.value||"").toLowerCase(), d=(diSel.value||"").toLowerCase();
  cluster.clearLayers();
  labelLayer.clearLayers();

  let pts=[];
  markers.forEach(m=>{
    const mb=(m.data.bbws||"").toLowerCase(), md=(m.data.nama_di||"").toLowerCase();
    const ok=(!b||mb===b)&&(!d||md===d);
    if(ok){
      cluster.addLayer(m.marker);
      pts.push(m.marker.getLatLng());
      // tampilkan label saat zoom cukup
      if(map.getZoom()>=LABEL_ZOOM){
        // label berisi NAMA DI
        const title = m.data.nama_di || "Titik Survey";
        const tip = L.tooltip({permanent:true,direction:'top',className:'di-label'})
                      .setLatLng(m.marker.getLatLng())
                      .setContent(title);
        labelLayer.addLayer(tip);
      }
    }
  });

  statsEl.innerHTML=`<span>Total titik tampil</span><b>${pts.length}</b>`;
  if(autoZoom && pts.length){
    map.fitBounds(L.latLngBounds(pts).pad(0.15),{maxZoom:12});
  }
}

// Re-render label saat zoom berubah
map.on('zoomend', ()=> refresh(false));

Papa.parse(CSV_URL,{
  download:true,header:true,dynamicTyping:true,skipEmptyLines:true,
  complete:r=>{
    rawRows=r.data;
    const bbwsList=distinct(rawRows.map(x=>x.bbws)).sort((a,b)=>String(a).localeCompare(String(b)));
    setOptions(bbwsSel,bbwsList,"Semua BBWS");

    // bangun map DI per BBWS
    diByBbws=new Map();
    rawRows.forEach(row=>{
      if(row.bbws && row.nama_di){
        if(!diByBbws.has(row.bbws)) diByBbws.set(row.bbws,new Set());
        diByBbws.get(row.bbws).add(row.nama_di);
      }
    });
    diByBbws.forEach((set,key)=> diByBbws.set(key,[...set].sort((a,b)=>String(a).localeCompare(String(b)))));
    allDiList = distinct(rawRows.map(r=>r.nama_di)).sort((a,b)=>String(a).localeCompare(String(b)));
    rebuildDiOptions();

    // buat marker + popup nama DI + click handler
    markers=[];
    let skipped=0;
    rawRows.forEach(row=>{
      const {lat,lon}=normalizeLatLon(row);
      if(isFinite(lat)&&isFinite(lon)){
        const title = row.nama_di || "Titik Survey";
        const m=L.circleMarker([lat,lon],circleStyle(row.status_progres));
        m.bindPopup(`<b>${title}</b>`); // popup hanya nama DI
        m.on('click',()=> showDetail(row,m.getLatLng()));
        markers.push({marker:m,data:row});
      }else{
        skipped++;
      }
    });

    // default ke Serayu Opak kalau ada
    const so=bbwsList.find(v=>String(v).toLowerCase()==="serayu opak");
    if(so){ bbwsSel.value=so; rebuildDiOptions(); }
    refresh();
  },
  error: (err)=> console.error(err)
});

bbwsSel.addEventListener('change',()=>{rebuildDiOptions();refresh();});
diSel.addEventListener('change',()=>refresh(true));
</script>
</body>
</html>
