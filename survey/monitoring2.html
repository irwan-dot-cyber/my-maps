<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoring Survey AIR</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #header{background:#FFD700;color:#000;padding:10px;font-weight:700;display:flex;align-items:center;gap:10px}
    #header img{height:36px}
    #map{height:calc(100% - 60px)}
    .leaflet-popup-content table{border-collapse:collapse;font-size:13px}
    .leaflet-popup-content td{padding:2px 4px;vertical-align:top}
    .leaflet-popup-content td:first-child{color:#555;white-space:nowrap}
    .labels-pane { z-index: 650; pointer-events: none; }
  </style>
</head>
<body>
  <div id="header">
    <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="PU"/>
    KEMENTERIAN PEKERJAAN UMUM ‚Äî DIREKTORAT JENDERAL SUMBER DAYA AIR ‚Äî DIREKTORAT IRIGASI & RAWA
  </div>
  <div id="map"></div>

<script>
const ENDPOINT = 'https://gas-proxy.tuic1677.workers.dev'; // Worker proxy ke GAS ?mode=data

// Map init
const map = L.map('map', { zoomControl:true }).setView([-2.5,118],5);
map.createPane('labels'); map.getPane('labels').classList.add('labels-pane');

const baseOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'¬© OpenStreetMap'});
const baseImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:20, attribution:'Tiles ¬© Esri/Maxar'});
const labelsCARTO = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',{
  maxZoom:20, pane:'labels', attribution:'¬© CARTO, ¬© OpenStreetMap'
});
L.control.layers({"OSM Standard":baseOSM,"Esri Imagery":baseImagery},{"Labels (CARTO)":labelsCARTO}).addTo(map);
baseImagery.addTo(map); labelsCARTO.addTo(map);

const markersLayer = L.layerGroup().addTo(map);

function popupHTML(p) {
  const rows = [
    ['BALAI', p.balai], ['SNVT', p.snvt], ['PAKET', p.paket],
    ['Provinsi', p.provinsi], ['Kab/Kota', p.kabupaten],
    ['Kecamatan', p.kecamatan], ['Desa', p.desa],
    ['Nama', p.nama], ['Telepon', p.telepon],
    ['Koordinat', `${p.lat}, ${p.lng}`],
    ['Waktu', new Date(p.timestamp).toLocaleString('id-ID')]
  ].filter(([,v]) => v && String(v).trim().length);

  const table = rows.map(([k,v])=>`<tr><td>${k}</td><td>${String(v).replace(/</g,'&lt;')}</td></tr>`).join('');
  const img = p.fotoUrl ? `<div style="margin-top:8px"><a href="${p.fotoUrl}" target="_blank"><img src="${p.fotoUrl}" style="max-width:240px;max-height:160px;border-radius:8px;border:1px solid #ddd"/></a></div>` : '';
  const gmaps = `<div style="margin-top:8px"><a href="https://www.google.com/maps?q=${p.lat},${p.lng}" target="_blank" style="background:#22c55e;color:#01250f;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;display:inline-block">üìç Lihat di Google Maps</a></div>`;
  return `<div style="min-width:240px"><table>${table}</table>${img}${gmaps}</div>`;
}

async function loadPoints(){
  try{
    const url = ENDPOINT + (ENDPOINT.includes('?') ? '&' : '?') + 'mode=data';
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const geo = await res.json();
    markersLayer.clearLayers();
    const feats = Array.isArray(geo.features)?geo.features:[];
    const latlngs=[];
    feats.forEach(f=>{
      if(!f.geometry||f.geometry.type!=='Point')return;
      const [lng,lat]=f.geometry.coordinates||[];
      if(isNaN(lat)||isNaN(lng))return;
      const props=f.properties||{};
      L.marker([lat,lng]).bindPopup(popupHTML(props)).addTo(markersLayer);
      latlngs.push([lat,lng]);
    });
    if(latlngs.length){ map.fitBounds(L.latLngBounds(latlngs).pad(0.2),{maxZoom:16}); }
  }catch(e){console.error(e);}
}

// load awal + auto refresh tiap 1 menit
map.whenReady(()=>{
  loadPoints();
  setInterval(loadPoints, 60000); // 60.000 ms = 1 menit
});
</script>
</body>
</html>
