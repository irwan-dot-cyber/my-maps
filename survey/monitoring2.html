<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Monitoring Tahap 2 — Per Balai + Cari DI</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css" referrerpolicy="no-referrer"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js" referrerpolicy="no-referrer"></script>

  <style>
    :root{--bg:#0b1224;--card:#0f172a;--mut:#9aa3b2;--accent:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e5e7eb}
    header{padding:14px 18px;border-bottom:1px solid #1f2937;background:#0c1326;position:sticky;top:0;z-index:10}
    main{max-width:1200px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:16px}
    .section{padding:12px 14px;display:grid;gap:12px}
    label{font-size:12px;color:var(--mut)}
    select,input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1224;color:#e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hint{font-size:12px;color:#9aa3b2}
    #map{height:60vh;border-radius:12px;border:1px solid #1f2937}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px 12px;text-align:left}
    thead th{font-size:12px;color:#9aa3b2;border-bottom:1px solid #1f2937}
    tbody tr{background:#0b1224;border:1px solid #1f2937}
    tbody td{border-top:1px solid #1f2937;border-bottom:1px solid #1f2937}
    tbody tr td:first-child{border-left:1px solid #1f2937;border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid #1f2937;border-top-right-radius:10px;border-bottom-right-radius:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #334155;background:#0b1224;font-size:12px}
    .ok{border-color:#22c55e}.mid{border-color:#f59e0b}.low{border-color:#94a3b8}

    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
    .s0{background:#94a3b8}.s25{background:#fca311}.s50{background:#f59e0b}.s75{background:#22c55e}.s100{background:#16a34a}
  </style>
</head>
<body>
<header>
  <strong>Monitoring Tahap 2</strong>
  <span class="hint">INPRES 2/2025 • Per Balai + Cari DI</span>
</header>

<main>
  <!-- Filter -->
  <div class="card">
    <h2>Filter</h2>
    <div class="section">
      <div class="row">
        <div>
          <label>B/BWS</label>
          <select id="f_bws"></select>
        </div>
        <div>
          <label>Cari DI</label>
          <input id="f_search" placeholder="Ketik nama DI (mis. D.I. Ledok)"/>
        </div>
      </div>
      <div class="actions">
        <span id="info" class="hint">memuat…</span>
        <span class="hint">
          <span class="dot s0"></span>0% •
          <span class="dot s25"></span>25% •
          <span class="dot s50"></span>50% •
          <span class="dot s75"></span>75% •
          <span class="dot s100"></span>100%
        </span>
      </div>
    </div>
  </div>

  <!-- Peta -->
  <div class="card" style="margin-top:12px">
    <h2>Peta Sebaran (hasil filter)</h2>
    <div class="section">
      <div id="map"></div>
    </div>
  </div>

  <!-- Tabel (dipindah ke bawah peta) -->
  <div class="card" style="margin-top:12px">
    <h2>Ringkasan DI</h2>
    <div class="section">
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:280px">Nama DI</th>
              <th>Progres</th>
              <th>Provinsi</th>
              <th>Kabupaten</th>
            </tr>
          </thead>
          <tbody id="tb"><tr><td colspan="4" class="hint">Memuat data…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script>
/* ====== CONFIG ====== */
const DATA_URL = 'https://script.google.com/macros/s/AKfycbwWe8SY1T51LL3yp_OlLlOORuMLjcVkbaL1td5pOm1EX0-POztzV-6CUl-tQo91OMzT/exec';

/* ====== Utils ====== */
const titleCase = s => String(s||'').split(/(\s+|[-/])/).map(tok=>{
  if(/^\s+$/.test(tok)||tok==='-'||tok==='/') return tok;
  const up=tok.toUpperCase();
  if(up==='BBWS'||up==='BWS') return up;
  if(/^(D\.?I\.?|DI)$/.test(up)) return 'D.I.';
  return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
}).join('');
function fillSelect(el, items, ph){
  el.innerHTML='';
  const list = (ph? [ph] : []).concat(items||[]);
  list.forEach((v,i)=>{
    const o=document.createElement('option');
    if(i===0 && ph){ o.value=''; o.textContent=ph; }
    else { o.value=o.textContent=v; }
    el.appendChild(o);
  });
  el.disabled = !(items && items.length);
}
const sleep = ms=> new Promise(r=>setTimeout(r,ms));
async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); return r.json(); }
async function fetchBaseline(){
  const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + 't=' + Date.now();
  const txt = await (await fetch(url,{cache:'no-store'})).text();
  return JSON.parse(txt.replace(/^\)\]\}'\s*/,'')) || [];
}
async function fetchSummary(b,p,k){
  const qs = new URLSearchParams({fn:'summary', bws:b, prov:p, kab:k});
  const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + qs.toString() + '&t=' + Date.now();
  try{ const j=await fetchJSON(url); return j&&j.ok ? (j.stages||{}) : {}; }catch{ return {}; }
}
async function fetchHistoryCoord(b,p,k,d){ // hanya ambil koordinat + stage dari history
  const qs = new URLSearchParams({fn:'history', bws:b, prov:p, kab:k, di:d});
  const url = DATA_URL + (DATA_URL.includes('?')?'&':'?') + qs.toString() + '&t=' + Date.now();
  try{ const j=await fetchJSON(url); return j&&j.ok? j : {maxStage:0,coords:null}; }catch{ return {maxStage:0,coords:null}; }
}

/* ====== Map ====== */
const baseOSM=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'© OpenStreetMap'});
const map=L.map('map',{zoomControl:true,layers:[baseOSM]}).setView([-2.5,118],5);
let cluster=L.markerClusterGroup(); map.addLayer(cluster);
function stageColor(st){ if(st>=100) return '#16a34a'; if(st>=75) return '#22c55e'; if(st>=50) return '#f59e0b'; if(st>=25) return '#fca311'; return '#94a3b8'; }
function iconFor(st){ const c=stageColor(st); return L.divIcon({className:'',html:`<div style="width:14px;height:14px;border-radius:50%;background:${c};border:1px solid #0006"></div>`,iconSize:[14,14]}); }

/* ====== DOM ====== */
const fB=document.getElementById('f_bws');
const fSearch=document.getElementById('f_search');
const tb=document.getElementById('tb');
const info=document.getElementById('info');

/* ====== Data ====== */
let FLAT=[];  // baseline unique (bws,prov,kab,di)
let ALL=[];   // final list with stage (coords later)
const COORD_CACHE=new Map(); // key -> {lat,lng,stage}

/* ====== Boot: cepat dengan SUMMARY ====== */
(async function boot(){
  info.textContent='memuat baseline…';
  const raw = await fetchBaseline();

  // FLATTEN baseline
  const seen=new Set();
  FLAT=[];
  raw.forEach(r=>{
    const b=titleCase(r['B/BWS PELAKSANA']||r['Balai']||r['BWS']);
    const p=titleCase(r['PROVINSI']||r['Provinsi']);
    const k=titleCase(r['KABUPATEN']||r['Kabupaten']);
    const d=titleCase(r['NAMA DI/DIR']||r['nama di']||r['DI']||r['Paket']);
    if(!(b&&p&&k&&d)) return;
    const key=[b,p,k,d].join('|');
    if(seen.has(key)) return; seen.add(key);
    FLAT.push({bws:b,prov:p,kab:k,di:d});
  });

  // SUMMARY per (bws,prov,kab) → dapat stage semua DI sekaligus
  info.textContent='memuat progres…';
  const group = {}; // {bws|prov|kab: [{idx...}] }
  FLAT.forEach((it,i)=>{
    const g=[it.bws,it.prov,it.kab].join('|');
    (group[g] ||= []).push(i);
  });

  const keys=Object.keys(group);
  let done=0;
  const STAGE_MAP=new Map(); // key(b,p,k,d) -> stage
  for (const g of keys){
    const [b,p,k]=g.split('|');
    const stages=await fetchSummary(b,p,k);
    // stages = { "Nama DI": stage }
    (group[g]||[]).forEach(idx=>{
      const di=FLAT[idx].di;
      const st = Number(stages[di]||0);
      STAGE_MAP.set([b,p,k,di].join('|'), st);
    });
    done++; if(done%5===0 || done===keys.length) info.textContent=`progres ${done}/${keys.length} kelompok`;
    await sleep(30);
  }

  // Build ALL dengan stage cepat
  ALL = FLAT.map(it=>{
    const st=STAGE_MAP.get([it.bws,it.prov,it.kab,it.di].join('|')) || 0;
    return {...it, stage:st, lat:null, lng:null};
  });

  // Dropdown balai
  fillSelect(fB, [...new Set(ALL.map(x=>x.bws))].sort(), 'Semua B/BWS');

  // Render pertama
  applyFilters(true);
  info.textContent=`Total DI: ${ALL.length}`;
})();

/* ====== Filtering ====== */
function getFiltered(){
  const b=fB.value, q=fSearch.value.trim().toLowerCase();
  return ALL.filter(x =>
    (!b || x.bws===b) &&
    (!q || x.di.toLowerCase().includes(q))
  );
}
function renderTable(data){
  if(!data.length){ tb.innerHTML='<tr><td colspan="4" class="hint">Tidak ada data.</td></tr>'; return;}
  const rows = data.slice().sort((a,b)=> (a.prov+a.kab+a.di).localeCompare(b.prov+b.kab+b.di));
  tb.innerHTML = rows.map(r=>{
    const cls = r.stage>=75 ? 'ok' : r.stage>=25 ? 'mid' : 'low';
    return `<tr>
      <td>${r.di}</td>
      <td><span class="chip ${cls}">${r.stage}%</span></td>
      <td>${r.prov}</td>
      <td>${r.kab}</td>
    </tr>`;
  }).join('');
}
function renderMarkers(data){
  cluster.clearLayers();
  let m=0;
  data.forEach(r=>{
    if(Number.isFinite(r.lat)&&Number.isFinite(r.lng)){
      const mk=L.marker([r.lat,r.lng],{icon:iconFor(r.stage)})
        .bindPopup(`<b>${r.di}</b><br>${r.kab}, ${r.prov}<br>${r.bws}<br>Progres: ${r.stage}%`);
      cluster.addLayer(mk); m++;
    }
  });
  if(m){ map.fitBounds(cluster.getBounds().pad(0.2)); } else { map.setView([-2.5,118],5); }
}

async function ensureCoordsFor(data, limit=8){
  // ambil koordinat hanya yg belum ada (dan cache)
  const targets = data.filter(r=>{
    const key=[r.bws,r.prov,r.kab,r.di].join('|');
    if (COORD_CACHE.has(key)) { const c=COORD_CACHE.get(key); r.lat=c.lat; r.lng=c.lng; if(c.stage>r.stage) r.stage=c.stage; return false; }
    return true;
  }).slice(0,200); // batasi supaya nggak kebanyakan

  for (let i=0;i<targets.length;i+=limit){
    const batch = targets.slice(i,i+limit);
    await Promise.all(batch.map(async r=>{
      const key=[r.bws,r.prov,r.kab,r.di].join('|');
      const h = await fetchHistoryCoord(r.bws,r.prov,r.kab,r.di);
      if (h.coords && Number.isFinite(h.coords.lat) && Number.isFinite(h.coords.lng)) {
        r.lat=Number(h.coords.lat); r.lng=Number(h.coords.lng);
      }
      if (Number(h.maxStage||0)>r.stage) r.stage=Number(h.maxStage||0);
      COORD_CACHE.set(key,{lat:r.lat??null,lng:r.lng??null,stage:r.stage});
    }));
    await sleep(50);
  }
}

async function applyFilters(first=false){
  const data = getFiltered();
  renderTable(data);
  // Koordinat: lazy untuk yang terlihat
  info.textContent = `Tampil: ${data.length} DI` + (fB.value ? ` • ${fB.value}` : '');
  await ensureCoordsFor(data);
  renderMarkers(data);
  if(first) info.textContent += ' • siap';
}

/* ====== Events ====== */
fB.addEventListener('change', ()=>applyFilters());
fSearch.addEventListener('input', ()=>applyFilters());
</script>
</body>
</html>
