<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pelaksanaan Inpres 2/2025 Tahap 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #header { background:#FFD700; color:black; padding:10px; display:flex; align-items:center; font-weight:bold; font-size:14px; }
  #header img { height:40px; margin-right:10px; }
  #map { height:calc(100% - 110px); }
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc; }

  .top-controls { position:absolute; top:60px; right:10px; left:10px; display:flex; justify-content:space-between; gap:10px; z-index:1000; }
  .search-box { background:white; padding:5px; border-radius:4px; box-shadow:0 0 4px rgba(0,0,0,.3); position:relative; }
  .search-box input { width:240px; padding:6px; }
  #suggestions { position:absolute; top:40px; left:0; right:0; background:white; border:1px solid #ccc; border-top:none; max-height:220px; overflow-y:auto; display:none; z-index:2000; }
  #suggestions div { padding:6px; cursor:pointer; }
  #suggestions div:hover { background:#eee; }

  .bottom-buttons { position:absolute; bottom:40px; left:10px; display:flex; flex-direction:column; gap:6px; z-index:1000; }
  .custom-button{ position:relative; overflow:hidden; border-radius:10px; transition:.2s; box-shadow:0 6px 14px rgba(0,0,0,.12); font-weight:700; text-align:center; text-decoration:none; padding:8px 12px; cursor:pointer; color:#fff; }
  #home       { background: linear-gradient(135deg,#2196F3,#1b7ed0); }
  #reset-route{ background: linear-gradient(135deg,#ff5722,#e24a18); }
  #locate-me  { background: linear-gradient(135deg,#4CAF50,#3f8f44); }

  /* ripple & pulse */
  .custom-button::after{content:"";position:absolute;top:0;left:-150%;width:130%;height:100%;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.25) 50%,transparent 100%);transform:skewX(-20deg);transition:left .6s}
  .custom-button:hover::after{left:120%}
  #locate-me::before{content:"";position:absolute;inset:-4px;border-radius:10px;border:2px solid rgba(255,255,255,.65);opacity:0;transform:scale(.9);pointer-events:none;animation:pulse-ring 4s ease-out infinite}
  @keyframes pulse-ring{0%{opacity:0;transform:scale(.9)}8%{opacity:.9;transform:scale(1.02)}35%{opacity:.35;transform:scale(1.25)}60%{opacity:0;transform:scale(1.35)}100%{opacity:0;transform:scale(1.35)}}

  /* marker bounce */
  .leaflet-marker-icon.bounce{animation:marker-bounce 600ms cubic-bezier(.28,.84,.42,1) 1;transform-origin:bottom center}
  @keyframes marker-bounce{0%{transform:translateY(0)}25%{transform:translateY(-14px)}55%{transform:translateY(0)}75%{transform:translateY(-7px)}100%{transform:translateY(0)}}
</style>
</head>
<body>

<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  KEMENTERIAN PEKERJAAN UMUM DIREKTORAT JENDERAL SUMBER DAYA AIR ‚Äî DIREKTORAT IRIGASI & RAWA
</div>

<div class="top-controls">
  <div class="search-box">
    <input type="text" id="search" placeholder="Cari lokasi..." oninput="showSuggestions(this.value)"/>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div class="bottom-buttons">
  <a href="https://s.pu.go.id/MTI4OA/Pelaksanaan_INPRES2_Tahap1" target="_blank" id="home" class="custom-button">Beranda</a>
  <div id="reset-route" class="custom-button" onclick="resetRoute()">Reset Rute</div>
  <div id="locate-me" class="custom-button" onclick="locateMe()">Posisi Saya</div>
</div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<!-- libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// ====== KONFIG ======
const CSV_URL   = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/data/survey.csv";
const FOTO_BASE = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/data/images/";

// ====== PETA ======
const map = L.map('map').setView([-2.5,117],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// (opsi) placeholder untuk info rute meskipun tombol rute sudah dihapus
function resetRoute(){
  document.getElementById('route-info').innerHTML="Jarak &amp; Waktu tempuh akan muncul di sini";
}

function locateMe(){
  if(!navigator.geolocation) return alert("Geolocation tidak didukung di browser ini.");
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    L.marker([lat,lng],{icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[25,41],iconAnchor:[12,41]})})
      .addTo(map).bindPopup("Lokasi Anda").openPopup();
    map.setView([lat,lng],13);
  }, ()=>alert("Tidak dapat mengakses lokasi Anda."));
}

function getIcon(name){
  const url = (name && name.startsWith('D.I.R.')) ? 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
            : 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
  return L.icon({
    iconUrl:url, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png', shadowSize:[41,41]
  });
}

// ====== MARKERS dari CSV ======
const cluster = L.markerClusterGroup();
const index   = [];
const allMarkers = [];

Papa.parse(CSV_URL,{
  download:true, header:true, skipEmptyLines:true,
  complete: res=>{
    (res.data||[]).forEach(r=>{
      const nm  = (r.nama_di||r.Nama||"").toString();
      const lat = parseFloat(r.y||r.lat||r.latitude);
      const lng = parseFloat(r.x||r.lng||r.longitude);
      if(isNaN(lat)||isNaN(lng)) return;

      const prov=(r.provinsi||r.Provinsi||"-").toString();
      const kab =(r.kabupaten||r.Kabupaten||"-").toString();
      const bbws=(r.bbws||r.BBWS||"-").toString();
      const note=(r.catatan||r.Catatan||"-").toString();

      // FOTO: dukung satu atau banyak (foto_urls dipisah ;)
      const list = [];
      const f1   = (r.foto||r.Foto||"").toString().trim();
      const fmul = (r.foto_urls||r.FotoURLs||"").toString().trim();
      if(f1) list.push(f1);
      if(fmul){
        fmul.split(";").forEach(u=>{ const v=u.trim(); if(v) list.push(v); });
      }
      const fotoList = list.map(u=>/^https?:\/\//i.test(u)? u : (FOTO_BASE+encodeURIComponent(u)));
      const imgHtml = fotoList.length
        ? `<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;max-width:240px;">
             ${fotoList.slice(0,4).map(u=>`<a href="${u}" target="_blank" rel="noopener">
               <img src="${u}" alt="foto ${nm}" style="width:110px;height:80px;object-fit:cover;border:1px solid #ddd;border-radius:6px"/>
             </a>`).join("")}
           </div>` : "";

      const popupHtml = `
        <b>${nm}</b><br>
        <div style="color:#555;font-size:12px;margin:2px 0;">üìç <b>Koordinat:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
        Provinsi: ${prov}<br>
        Kabupaten: ${kab}<br>
        BBWS: ${bbws}<br>
        Catatan: ${note}<br>
        <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">Buka di Google Maps</a><br>
        <a href="sentinel.html?lat=${lat}&lng=${lng}" target="_blank" rel="noopener">Bandingkan Sentinel</a>
        ${imgHtml}
      `;

      const m = L.marker([lat,lng],{icon:getIcon(nm)}).bindPopup(popupHtml);
      m.on('popupopen',()=>{ const el=m.getElement(); if(el){ el.classList.remove('bounce'); void el.offsetWidth; el.classList.add('bounce'); }});
      cluster.addLayer(m);
      index.push({name:nm, marker:m});
      allMarkers.push(m);
    });

    map.addLayer(cluster);
    if(allMarkers.length){
      const g=L.featureGroup(allMarkers);
      map.fitBounds(g.getBounds(), {padding:[20,20]});
    }
  },
  error: ()=>alert("Gagal memuat CSV. Periksa URL/format file.")
});

// ====== PENCARIAN ======
function showSuggestions(q){
  const box=document.getElementById('suggestions');
  box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index.filter(it=>it.name.toLowerCase().includes(q.toLowerCase()));
  hits.slice(0,100).forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ document.getElementById('search').value=it.name; box.style.display="none";
      map.setView(it.marker.getLatLng(),14); it.marker.openPopup(); };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}
</script>

</body>
</html>
