<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Peta Daerah Irigasi (CSV)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
  html, body { margin:0; padding:0; height:100%; }
  #map { height: calc(100% - 60px); }
  #header { background:#FFD700; padding:10px; font-weight:bold; font-size:14px; }
  #route-info { background:#f9f9f9; padding:6px; font-size:13px; }
  .poi-info{margin-top:6px;font-size:12px;line-height:1.35}
  .btn-mini{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:6px;
            color:#fff;font-weight:700;text-decoration:none;background:#673ab7}
</style>
</head>
<body>

<div id="header">Kementerian PU — Daftar Daerah Irigasi (dari survey.csv)</div>
<div id="map"></div>
<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// URL CSV dari repo GitHub
const CSV_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/data/survey.csv";

// ID Form Survey123
const FORM_ID = "dd7945ef9e574f07a0e7c82be6bdc3cf";

// Inisialisasi peta
var map = L.map('map').setView([-2.5,117],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'© OpenStreetMap'
}).addTo(map);

// Routing control
var routingControl = L.Routing.control({
  waypoints: [], routeWhileDragging: true, show:false,
  createMarker: function(){ return null; }
}).addTo(map);

routingControl.on('routesfound', function(e){
  var route = e.routes[0];
  var dist = (route.summary.totalDistance/1000).toFixed(2);
  var time = (route.summary.totalTime/60).toFixed(0);
  document.getElementById('route-info').innerHTML =
    "<b>Jarak:</b> "+dist+" km | <b>Waktu:</b> "+time+" menit";
});

// Fungsi routing
function showRoute(lat,lng){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(function(pos){
      var from = L.latLng(pos.coords.latitude,pos.coords.longitude);
      var to   = L.latLng(lat,lng);
      routingControl.setWaypoints([from,to]);
    });
  }
}

// Load CSV dengan PapaParse
Papa.parse(CSV_URL, {
  download:true, header:true,
  complete: function(res){
    var rows = res.data.filter(r => r.Latitude && r.Longitude);
    var markers = [];
    rows.forEach(r => {
      var lat = parseFloat(r.Latitude);
      var lng = parseFloat(r.Longitude);
      var nm  = r.Nama || "Tanpa Nama";
      var gid = r.GlobalID || "";
      var latStr = lat.toFixed(6), lngStr = lng.toFixed(6);
      var gmaps = `https://www.google.com/maps?q=${lat},${lng}`;
      var tambahFotoUrl = `https://survey123.arcgis.com/share/${FORM_ID}?name=${encodeURIComponent(nm)}`;
      if(gid) tambahFotoUrl += `&parentid=${encodeURIComponent(gid)}`;

      var popup = `
        <b>${nm}</b><br>
        <button onclick='showRoute(${lat},${lng})'>Tunjukkan Rute</button>
        <div class="poi-info">
          <div><b>Koordinat:</b> ${latStr}, ${lngStr}</div>
          <div><a href="${gmaps}" target="_blank">Buka di Google Maps</a></div>
        </div>
        <a class="btn-mini" target="_blank" href="${tambahFotoUrl}">Tambah Foto</a>
      `;

      var marker = L.marker([lat,lng]).bindPopup(popup).addTo(map);
      markers.push(marker);
    });

    if(markers.length){
      var group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), {padding:[20,20]});
    }
  }
});
</script>
</body>
</html>
