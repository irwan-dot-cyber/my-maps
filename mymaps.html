<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peta Irigasi + Rute</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js"></script>

  <!-- Geocoder (search box) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <!-- Locate control (Posisi Saya) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Posisi Saya: pojok kanan bawah & warna hijau */
    .leaflet-right .leaflet-control-locate { margin-right: 10px; margin-bottom: 10px; }
    .leaflet-control-locate a {
      background: #16a34a !important;      /* hijau */
      border-color: #128a3f !important;
      color: #fff !important;
    }
    .leaflet-control-locate a:hover { filter: brightness(1.05); }

    /* Tombol reset rute (di atas Posisi Saya) */
    .reset-route-control {
      background: #ffffff;
      border: 1px solid #bbb;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 0;
    }
    .reset-route-control button {
      all: unset;
      display: block;
      padding: 8px 10px;
      cursor: pointer;
      font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .reset-route-control button:hover { background: #f2f2f2; }

    /* Pencarian di pojok kanan atas */
    .leaflet-top.leaflet-right .leaflet-control-geocoder {
      margin-top: 10px;
      margin-right: 10px;
    }

    /* Routing panel: kecilkan dan rapikan */
    .leaflet-routing-container {
      font-size: 12px;
      max-height: 50%;
      overflow: auto;
    }

    /* Toggle basemap button (kiri atas, bawah tombol zoom) */
    .basemap-toggle {
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .basemap-toggle button {
      all: unset;
      display: block;
      padding: 8px 10px;
      cursor: pointer;
      font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
    }
    .basemap-toggle button:hover { background: #f2f2f2; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  // ================== DATA KOORDINAT ==================
  // Format: ["Nama", lat, lon]
  const titik = [
["D.I. Alue Peudeung", 4.905597755, 97.07767342],
["D.I.R. Tanjung Sejaro", -2.9681421, 104.7309104],
["D.I.R. Parebok", -2.957959107, 112.9278095],
["D.I.R. Kuala Jelai", -2.954167, 110.761667],
["D.I. Paluh Manan", 3.75116, 98.57783],
["D.I. Kolam", 3.62731, 98.78792],
["D.I. Bukit Setia", 3.94227, 98.459],
["D.I. Kerpei", 3.61064, 98.38525],
["D.I. Pardomuan Nauli", 3.67036, 98.39548],
["D.I. Tanjung Keriahan", 3.577778, 98.34432],
["D.I.R. Gebang", 3.9792, 98.3569],
["D.I. Paya Tampak", 3.8679, 98.482],
["D.I. Modo", 1.447, 97.4627],
["D.I. Zumuzu", 0.94552, 97.8693],
["D.I. Sorkam Kanan", 1.89583, 98.572403],
["D.I. Sogawu", 1.44805, 97.468518],
["D.I. Aran Dalu", 3.711865, 98.584492],
["D.I.R. Sisir Gunting", 3.801718, 98.615082],
["D.I. Kota Datar", 3.746665, 98.54839],
["D.I. Amplas", 3.556636, 98.757803],
["D.I. Kota Rantang", 3.727766, 98.565113],
["D.I.R. Pudak", -1.550833, 103.671944],
["D.I. Cubo/Trienggadeng", 5.196371934, 96.07510222],
["D.I.R. Sei Duren", -1.6021812, 103.5480243],
["D.I. Beuracan", 5.214147677, 96.22157012],
["D.I. Tanah Merah", -0.424566771, 117.2204237],
["D.I.R. Betara", 1.092778, 103.364414],
["D.I. Drien Bungong", 5.212655544, 96.32177919],
["D.I.R. Lagan Hulu", -1.272778, 103.740833],
["D.I. Kiran", 5.217401579, 96.33882577],
["D.I. Kerpei", 3.609122, 98.380253],
["D.I.R. Bram Itam", -0.856389, 103.415083],
["D.I. Alue Punti", 4.584097061, 95.90682598],
["D.I. Kuta Krueng", 5.198919148, 96.33455112],
["D.I.R. Marga Mulya", -1.212778, 104.031667],
["D.I. Meugit", 5.196770595, 96.33150224],
["D.I.R. Kayu Aro Kanan", -0.783611, 103.136203],
["D.I. Blang Jempeuk", 4.619574667, 95.62898797],
["D.I. Ule Glee", 5.163732721, 96.3176029],
["D.I.R. Rantau Rasau", -1.210556, 104.085833],
["D.I. Ulim", 5.209098386, 96.30227326],
["D.I. Kareung Ateuh", 5.015147676, 95.38882731],
["D.I.R. Rantau Rasau Desa", -1.199722, 104.135556],
["D.I. Krueng Nalan", 5.170347828, 96.49945838],
["D.I. Paya Gulungku", 5.190829522, 96.42902786],
["D.I. Pante Kuyun", 4.773486644, 95.5747921],
["D.I. Rayeuk Mamplam", 5.183997718, 96.41436348],
["D.I. Panga Pucok", 4.553488369, 95.75326781],
["D.I. Lapang Timu", 5.238154593, 96.90046219],
["D.I. Sogawu", 1.44805, 97.468518],
["D.I. Namu Mbelin", 3.535592, 98.338531],
["D.I. Cot Mane", 5.226845337, 96.86851489],
["D.I. Samalanga", 5.183021148, 96.35866925],
["D.I. Suak Lango", 4.422719031, 96.3015609],
["D.I. Krueng Peudada", 5.183688988, 96.62472864],
["D.I. Alue Peudeung", 4.306529412, 96.21655194],
["D.I. Panton", 5.153550167, 96.9831571],
["D.I. Tumpok Ladang", 4.203274677, 96.16477981],
["D.I.R. Simpang Datuk", -1.130849366, 104.301847],
["D.I. Alue Grong-Grong", 4.983461787, 97.71159792],
["D.I.R. Kayu Aro Kiri", -0.798611, 103.1265],
["D.I. Drien Caleu", 4.308055709, 96.22636758],
["D.I. Simulbas", 1.977157, 98.53152],
["D.I.R. Simpang Puding", -1.229444, 104.084167],
["D.I.R. Penganyut", -1.280556, 104.096111],
["D.I. Rogas", 1.979174, 98.516755],
["D.I.R. Kempas Jaya", -0.795833, 103.115472],
["D.I. Sipodang", 1.980033, 98.525405],
["D.I. Sihapas", 1.966825, 98.536728],
["D.I. Sipaubat", 2.02445, 98.38672],
["D.I.R. Margo Rukun", -0.825278, 103.069792],
["D.I.R. Nipah Panjang", -1.157222, 104.188333],
["D.I.R. Mekar Jati", -0.809722, 103.164622],
["D.I.R. Dendang I - II", -1.199167, 103.994167],
["D.I.R. Pasar Senin", -0.828056, 103.185283],
["D.I. Meunasah Ara", 4.218513609, 96.16767915],
["D.I. Meunasah Rayek I", 4.22044346, 96.17372794],
["D.I.R. Koto Kandis", -1.185833, 104.026944],
["D.I.R. Senyerang", -0.820556, 103.142383],
["D.I. Pasie Teungoh", 4.187348295, 96.16526],
["D.I. Paya Lumpat", 4.238445493, 96.07888864],
["D.I. Pinem", 4.247935326, 96.05721348],
["D.I. Meurandeh", 3.612904686, 96.94054771],
["D.I. Tangan-Tangan", 3.646753662, 96.9020694],
["D.I. Abah Kala", 5.528155297, 95.82297345],
["D.I. Binieb", 5.43088784, 95.87757176],
["D.I. Blang Kubu", 5.505511015, 95.82562946],
["D.I. Blang Laweung", 5.502446444, 95.84054712],
["D.I. Gintong", 5.373943557, 95.89205818],
["D.I.R. Secanggang", 3.8674, 98.5319],
["D.I. Belimau", -0.416919332, 117.177691],
["D.I. Rantau Pakam", 4.402304361, 98.20846073],
["D.I. Seunebok Bacee", 4.421285787, 98.13425588],
["D.I.R. Lambur I - II", -1.106389, 103.973056],
["D.I. Meureudu", 5.25304667, 96.24410001],
["D.I.R. Pamusiran Luar", -1.084167, 104.127222],
["D.I. Ie Rhob Timur", 5.181546995, 96.39780834],
["D.I.R. Py. Lubuk Jawi", -1.704167, 103.179444],
["D.I. Sungai Pulai", -1.693889, 103.064444],
["D.I.R. Py. Rengas Condong", -1.7125, 103.270556],
["D.I.R. Py. Senaning", -1.570556, 103.359444],
["D.I.R. Py. Pematang Pacat", -1.688611, 103.113611],
["D.I.R. Py. Pasar Terusan", -1.706389, 103.158333],
["D.I.R. Py. Sei Duo", -1.505556, 103.42],
["D.I.R. Py. Tanjung Marwo", -1.738889, 103.105833],
["D.I.R. Py. Sei Bayur", -1.671389, 102.920556],
["D.I.R. Py. Sei Dimpang", -1.673056, 103.029722],
["D.I.R. Py. Belakang Dusun", -1.674167, 102.943333],
["D.I.R. Py. Lebar Sei Lais", -1.6825, 103.185556],
["D.I.R. Py. Lebung Rimbo", -1.675278, 102.991944],
["D.I.R. Py. Lubuk Ruso", -1.548056, 103.37],
["D.I.R. Py. Napal Sisik", -1.686389, 103.213056],
["D.I.R. Py. Paku Aji", -1.707778, 103.115],
["D.I.R. Py. Pematang Temiang", -1.893094398, 102.9752207],
["D.I.R. Py. Lubang", -1.688611, 103.083889],
["D.I.R. Py. Sei Payung", -1.670278, 102.872778],
["D.I.R. Py. Pelumpung", -1.658333, 103.007222],
["D.I.R. Py. Saken Seberang", -1.655278, 102.851389],
["D.I. Sei. Keluru", -2.176944, 101.505556],
["D.I. Sei. Air Lingkat", -2.229167, 101.546111],
["D.I. Sei. Talang Aro", -2.2587, 101.541],
["D.I. Batu Lumut", -2.074167, 101.4075],
["D.I. Jembatan Serong", -2.083889, 101.425],
["D.I. Sei Bungkal", -2.043936771, 101.3895453],
["D.I. Simpang III", -2.045833, 101.411667],
["D.I.R. Pasir Putih", -1.266944, 103.802778],
["D.I. Makroman", -0.511603915, 117.2506058],
["D.I. Kutai Lama", -0.575060006, 117.3339],
["D.I.R. Sungai Rambut", -1.230278, 104.153889],
["D.I.R. Simbur Naik", -1.071667, 103.9725],
["D.I.R. Sungai Raya", -0.833611, 103.284081],
["D.I. Kutai Lama", -0.576162515, 117.3324832],
["D.I.R. Teluk Nilau", -0.856389, 103.244117],
["D.I. Sidomulyo A", -0.54979, 117.268257],
["D.I. Semangkok", -0.121249, 117.435674],
["D.I.R. Sungai Tuak", -1.91526, 116.211427],
["D.I.R. Suliliran", -1.925452, 116.255467],
["D.I.R. Jone Rantau Panjang", -1.840767, 116.254996],
["D.I. Sepaso Barat", 0.755795, 117.54005],
["D.I.R. Telago Limo", -1.263056, 104.133333],
["D.I.R. Sungai Palas", -1.167778, 104.197778],
["D.I. Selangkau", 0.839025, 117.855731],
["D.I.R. Py. Danau Embat", -1.651111, 103.175556],
["D.I.R. Py. Bencah", -1.653056, 102.802778],
["D.I.R. Py. Sei Aur", -1.669444, 103.170556],
["D.I. Karmeo", -1.796389, 103.045833],
["D.I.R. Py. Kacung", -1.687778, 103.303611],
["D.I.R. Py. Lebar", -1.654444, 102.869444],
["D.I.R. Py. Lebar Belakang Dusun", -1.664167, 102.778889],
["D.I.R. Py. Lubuk Jeramun", -1.695556, 102.876667],
["D.I.R. Py. Sei Lais II", -1.691111, 103.041667],
["D.I.R. Py. Sei Lantang", -1.704722, 103.058333],
["D.I.R. Py. Sei Napal", -1.686944, 103.003889],
["D.I.R. Py. Sei Payung", -1.670833, 102.873056],
["D.I.R. Py. Penghujan", -1.491944, 103.4225],
["D.I.R. Py. Sei Pedak", -1.675556, 103.04],
["D.I.R. Py. Sei Rumbai", -1.691944, 103.044444],
["D.I.R. Py. Tunggul Buto", -1.847222, 103.016111],
["D.I.R. Kumpeh", -1.410099133, 103.9498675],
["D.I.R. Niaso", -1.539994817, 103.6191273],
["D.I.R. Senaung", -1.551944, 103.560556],
["D.I.R. Sungai Rambai", -0.852222, 103.049722],
["D.I.R. Teluk Ketapang", -0.809722, 103.107778],
["D.I. Pagar Puding", -1.368056, 102.360833],
["D.I.R. Rawa Jone", -1.90933, 116.249843],
["D.I. Temiang Mali I", 0.118042, 110.078133],
["D.I.R. Sungai Pinyuh Komplek", 0.230857, 109.112629],
["D.I.R. Tebas sungai", 1.202027, 109.159984],
["D.I. Sebandang", -0.122557, 110.111473],
["D.I. Madong", -0.843565, 111.540924],
["D.I.R. Tekarang Komplek", 1.260324, 109.122352],
["D.I. Tambak Rawang", -1.217111, 109.933711],
["D.I. Tolang", 1.9837, 98.5149],
["D.I.R. Selakau Komplek", 1.071978, 109.025503],
["D.I.R. Meranti Paham", 2.384317, 100.18815],
["D.I.R. Sei Siarti", 2.26688, 100.23083],
["D.I. Nalawo", 0.9073, 97.898],
["D.I. Laehuwa", 1.456803, 97.457767],
["D.I.R. Dungun Laut", 1.296721, 109.038884],
["D.I. Tanjung", 0.089736, 110.121144],
["D.I.R. Penepat Komplek", 0.192737, 109.241036],
["D.I.R. Purun Hulu", 0.22656, 109.153931],
["D.I.R. Segedong", 0.176003, 109.173066],
["D.I. Empirang Pokok I", 0.152287, 110.125556],
["D.I.R. Siduk", -1.348694, 110.0779],
["D.I.R. Sepinggan", 1.1315, 109.0814],
["D.I. Kaubun", 1.033041, 117.848371],
["D.I.R. Tebas Komplek", 1.194254, 109.145455],
["D.I. Empu Engkiyang", 0.17147, 110.090432],
["D.I.R. Purun Hulu", 0.225427, 109.152196],
["D.I. Sebandang", -0.122974, 110.111594],
["D.I.R. Sungai Paduan", -1.011899, 109.792826],
["D.I.R. Samustida", 1.567322, 109.23924],
["D.I. Tekang", 0.091904, 111.639442],
["D.I. Dusun Petai", 0.282105, 109.636667],
["D.I. Mungguk Pelancar", -0.023653, 110.954369],
["D.I.R. Jawai Komplek", 1.240266, 109.049136],
["D.I. Kenukut", 0.065209, 111.633352],
["D.I. Mentubang", -1.18064, 109.94285],
["D.I. Dusun Petai", 0.282906, 109.637069],
["D.I. Sei Sualang", -2.423889, 102.271111],
["D.I. Rawang Ujo", -2.290556, 102.737222],
["D.I.R. Jawai Komplek", 1.273286, 109.035771],
["D.I. Serang", -0.067077, 111.173579],
["D.I. Dusun Petai", 0.276896, 109.636809],
["D.I. Lirang", 0.61771, 109.399721],
["D.I. Mawang", -0.790934, 111.582725],
["D.I. Dano", 0.550684, 109.327302],
["D.I. Duri", -0.799049, 111.601165],
["D.I. Lancak", 0.057296, 110.071295],
["D.I.R. Jungkat Komplek", 0.081014, 109.193083],
["D.I. Suka Maju Luansara", 0.809548, 113.121646],
["D.I.R. Semelagi Komplek", 1.049922, 109.001617],
["D.I.R. Melapi Komplek", 0.827202, 112.971602],
["D.I. Selalong I", 0.01443, 110.889953],
["D.I. Sangku I", 0.20771, 109.999708],
["D.I.R. Sungai Paduan", -1.016014, 109.799439],
["D.I.R. Tanjung Baik Budi", -1.48265, 110.059861],
["D.I.R. Kuala Satong", -1.396038, 110.081515],
["D.I. Bagam", 0.058056, 110.909444],
["D.I. Setor Karya Sp.5", 0.21805, 110.956367],
["D.I. Landau Kodah I", 0.120006, 110.915618],
["D.I. Semabi", 0.1042, 110.8674],
["D.I. Nanga Pemubuh", -0.109567, 111.056775],
["D.I. Setawar", -0.13115, 110.999246],
["D.I.R. Sungai Puteri", -1.620096, 110.041155],
["D.I.R. Kuala Tolak", -1.442556, 110.06894],
["D.I. Mawan", 0.486455, 112.362723],
["D.I. Nanga Nyabau", 1.014193, 112.704878],
["D.I. Lumut", -0.180008, 110.073059],
["D.I. Lanso", 0.355879, 109.642993],
["D.I. Empirang Ujung", 0.18231, 110.135668],
["d.i. Manjang", -0.204268, 110.879511],
["D.I. Senyabang", 0.18903, 110.171071],
["D.I. Angkaras", 0.592765, 109.60604],
["D.I. Sum Sum", 0.319617, 109.470557],
["D.I. Napal", 0.602179, 109.38561],
["D.I. Pak Liung", 0.134481, 109.585671],
["D.I. Mamek Mandor", 0.313083, 109.449549],
["D.I. Kayu Ara Jelimpo", 0.292847, 110.086921],
["D.I. Bagak", 0.552098, 109.695197],
["D.I. Simpang Pana", 0.331571, 109.469232],
["D.I. Jelayan Semade Hilir", 0.72819, 109.48117],
["D.I. Ringo Hilir", 0.61613, 109.552503],
["D.I. Emparu", 0.078888, 111.824516],
["D.I. Kebong", 0.057606, 111.648],
["D.I. Manter", -0.073628, 111.489584],
["D.I. Bukit Kelam", 0.092149, 111.670843]
  ];

  // ================== PETA & LAYERS ==================
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: '&copy; OpenStreetMap'
  });

  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 20, attribution: 'Tiles &copy; Esri'
  });

  const map = L.map('map', {
    center: [-1.5, 113], // tengah Indonesia
    zoom: 5,
    layers: [osm] // default OSM (bukan satelit)
  });

  // ================== CLUSTER ==================
  const cluster = L.markerClusterGroup();

  // Routing control (global)
  const routeFormatter = new L.Routing.Formatter({
    language: 'id',
    units: 'metric'
  });
  // Override formatTime -> "x hari y jam z menit"
  routeFormatter.formatTime = function(seconds) {
    seconds = Math.round(seconds);
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const parts = [];
    if (d) parts.push(d + ' hari');
    if (h) parts.push(h + ' jam');
    if (m || (!d && !h)) parts.push(m + ' menit');
    return parts.join(' ');
  };

  const router = L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' });

  const routing = L.Routing.control({
    waypoints: [],
    router,
    show: true,
    routeWhileDragging: false,
    addWaypoints: false,
    collapsible: true,
    showAlternatives: false,
    formatter: routeFormatter
  }).addTo(map);

  function setRouteFromUserTo(latlng) {
    return getUserLocation().then((my) => {
      routing.setWaypoints([my, latlng]);
    }).catch((e) => {
      alert('Gagal mendapatkan lokasi Anda. Aktifkan GPS/izin lokasi dan coba lagi.');
      console.error(e);
    });
  }

  // Tambahkan marker ke cluster
  titik.forEach(([nama, lat, lon]) => {
    const m = L.marker([lat, lon]);
    m.bindPopup(`
      <b>${nama}</b><br/>
      <button id="btn-route-${lat}-${lon}" style="margin-top:6px;padding:6px 8px;border:1px solid #bbb;border-radius:4px;background:#fff;cursor:pointer;">
        Rute ke sini
      </button>
    `);
    m.on('popupopen', (ev) => {
      const btn = document.getElementById(`btn-route-${lat}-${lon}`);
      if (btn) btn.onclick = () => setRouteFromUserTo(L.latLng(lat, lon));
    });
    cluster.addLayer(m);
  });
  map.addLayer(cluster);

  // ================== GEOCODER (SEARCH, pojok kanan atas) ==================
  L.Control.geocoder({
    defaultMarkGeocode: false
  })
  .on('markgeocode', function(e) {
    const center = e.geocode.center;
    map.setView(center, 14);
  })
  .addTo(map);

  // ================== POSISI SAYA (pojok kanan bawah, hijau) ==================
  const locate = L.control.locate({
    position: 'bottomright',
    strings: { title: "Posisi Saya" },
    setView: 'untilPanOrZoom',
    flyTo: true,
    cacheLocation: true,
    keepCurrentZoomLevel: false,
    showPopup: false
  }).addTo(map);

  // Helper untuk dapatkan lokasi user sebagai Promise<L.LatLng>
  function getUserLocation() {
    return new Promise((resolve, reject) => {
      if (locate._event) { /* plugin internal state */
        // coba ambil dari cache plugin
      }
      map.locate({ setView: false, watch: false, enableHighAccuracy: true })
        .once('locationfound', (e) => resolve(e.latlng))
        .once('locationerror', (e) => reject(e));
    });
  }

  // ================== RESET RUTE (di atas Posisi Saya) ==================
  const ResetRouteControl = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function() {
      const div = L.DomUtil.create('div', 'reset-route-control leaflet-bar');
      div.innerHTML = '<button title="Reset Rute">Reset Rute</button>';
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.on(div, 'click', (e) => {
        routing.setWaypoints([]);
      });
      return div;
    }
  });
  map.addControl(new ResetRouteControl());

  // ================== TOGGLE BASEMAP (button, bukan layer control) ==================
  const BasemapToggle = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function() {
      const div = L.DomUtil.create('div', 'basemap-toggle leaflet-bar');
      const btn = L.DomUtil.create('button', '', div);
      btn.textContent = 'Basemap: Default';
      let satelliteOn = false;

      const toggle = () => {
        if (!satelliteOn) {
          map.removeLayer(osm);
          esriSat.addTo(map);
          btn.textContent = 'Basemap: Satelit';
        } else {
          map.removeLayer(esriSat);
          osm.addTo(map);
          btn.textContent = 'Basemap: Default';
        }
        satelliteOn = !satelliteOn;
      };

      L.DomEvent.on(btn, 'click', toggle);
      L.DomEvent.disableClickPropagation(div);
      return div;
    }
  });
  map.addControl(new BasemapToggle());

  // Fit bounds ke semua titik
  const allLatLng = titik.map(d => L.latLng(d[1], d[2]));
  if (allLatLng.length) {
    map.fitBounds(L.latLngBounds(allLatLng).pad(0.1));
  }
</script>
</body>
</html>
