<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pelaksanaan Inpres 2/2025 Tahap 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #header {
    background-color: #FFD700; color: black; padding: 10px;
    display: flex; align-items: center; font-weight: bold; font-size: 14px;
  }
  #header img { height: 40px; margin-right: 10px; }
  #map { height: calc(100% - 110px); }
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc; }

  .top-controls {
    position:absolute; top:60px; right:10px; left:10px;
    display:flex; justify-content:space-between; z-index:1000;
  }
  .search-box {
    background:white; padding:5px; border-radius:4px; box-shadow:0 0 4px rgba(0,0,0,0.3); position:relative;
  }
  .search-box input { width: 240px; padding: 6px; }
  #suggestions {
    position:absolute; top:40px; left:0; right:0; background:white;
    border:1px solid #ccc; border-top:none; max-height:220px; overflow-y:auto;
    display:none; z-index:2000;
  }
  #suggestions div { padding:6px; cursor:pointer; }
  #suggestions div:hover { background:#eee; }

  .bottom-buttons {
    position:absolute; bottom:40px; left:10px;
    display:flex; flex-direction:column; gap:6px; z-index:1000;
  }

  /* ====== Animasi tombol bawah ====== */
  .custom-button{
    position: relative; overflow: hidden; border-radius: 10px;
    transition: transform .15s ease, box-shadow .2s ease, opacity .3s ease;
    box-shadow: 0 6px 14px rgba(0,0,0,.12); will-change: transform;
    animation: btn-enter .5s ease both; color:#fff; font-weight:700;
    text-align:center; text-decoration:none; padding:8px 12px; cursor:pointer;
  }
  .custom-button:hover{ transform: translateY(-2px); box-shadow: 0 10px 18px rgba(0,0,0,.18); }
  .custom-button:active{ transform: translateY(0) scale(.98); box-shadow: 0 4px 10px rgba(0,0,0,.16); }

  /* stagger & gradient */
  #home       { animation-delay: .05s; background: linear-gradient(135deg,#2196F3,#1b7ed0); }
  #reset-route{ animation-delay: .15s; background: linear-gradient(135deg,#ff5722,#e24a18); }
  #locate-me  { animation-delay: .25s; background: linear-gradient(135deg,#4CAF50,#3f8f44); }

  /* sheen hover */
  .custom-button::after{
    content:""; position:absolute; top:0; left:-150%; width:130%; height:100%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.25) 50%, transparent 100%);
    transform: skewX(-20deg); transition: left .6s ease;
  }
  .custom-button:hover::after{ left:120%; }

  /* ripple circle */
  .ripple{
    position:absolute; border-radius:50%; transform: scale(0);
    background: rgba(255,255,255,.45); animation: ripple .5s ease-out forwards; pointer-events:none;
  }
  @keyframes ripple{ to{ transform: scale(12); opacity: 0; } }
  @keyframes btn-enter{ from{ opacity:0; transform: translateY(8px) scale(.98); } to{ opacity:1; transform: translateY(0) scale(1); } }

  /* Pulse lembut khusus tombol Posisi Saya */
  #locate-me { position: relative; }
  #locate-me::before{
    content:""; position:absolute; inset:-4px; border-radius:10px; border:2px solid rgba(255,255,255,.65);
    opacity:0; transform: scale(.9); pointer-events:none; animation: pulse-ring 4s ease-out infinite;
  }
  #locate-me:hover::before, #locate-me:active::before{ animation-play-state: paused; }
  @keyframes pulse-ring{
    0% { opacity:0; transform: scale(.9); }
    8% { opacity:.9; transform: scale(1.02); }
    35%{ opacity:.35; transform: scale(1.25); }
    60%{ opacity:0; transform: scale(1.35); }
    100%{ opacity:0; transform: scale(1.35); }
  }

  /* ===== Marker bounce via CSS ===== */
  .leaflet-marker-icon.bounce {
    animation: marker-bounce 600ms cubic-bezier(.28,.84,.42,1) 1;
    transform-origin: bottom center;
  }
  @keyframes marker-bounce {
    0%   { transform: translateY(0); }
    25%  { transform: translateY(-14px); }
    55%  { transform: translateY(0); }
    75%  { transform: translateY(-7px); }
    100% { transform: translateY(0); }
  }
</style>
</head>
<body>

<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  KEMENTERIAN PEKERJAAN UMUM DIREKTORAT JENDERAL SUMBER DAYA AIR  DIREKTORAT IRIGASI DAN RAWA
</div>

<div class="top-controls">
  <div id="top-left"></div>
  <div class="search-box">
    <input type="text" id="search" placeholder="Cari lokasi..." oninput="showSuggestions(this.value)"/>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div class="bottom-buttons">
  <a href="https://s.pu.go.id/MTI4OA/Pelaksanaan_INPRES2_Tahap1" target="_blank" id="home" class="custom-button">Beranda</a>
  <div id="reset-route" class="custom-button" onclick="resetRoute()">Reset Rute</div>
  <div id="locate-me" class="custom-button" onclick="locateMe()">Posisi Saya</div>
</div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<!-- Libs -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
// ===== KONFIGURASI =====
// Ganti ke raw CSV repo kamu kalau beda:
const CSV_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/data/survey.csv";

// ===== PETA & ROUTING =====
var map = L.map('map').setView([-2.5, 117], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

var routingControl = L.Routing.control({
  waypoints: [], routeWhileDragging: true, show:false,
  createMarker: function(){ return null; }
}).addTo(map);

function formatTime(seconds){
  const days = Math.floor(seconds/86400);
  const hours = Math.floor((seconds%86400)/3600);
  const minutes = Math.floor((seconds%3600)/60);
  let str = "";
  if(days>0) str += days+" hari ";
  if(hours>0) str += hours+" jam ";
  str += minutes+" menit";
  return str;
}
routingControl.on('routesfound', function(e){
  const r = e.routes[0];
  const dist = (r.summary.totalDistance/1000).toFixed(2);
  const time = formatTime(r.summary.totalTime);
  document.getElementById('route-info').innerHTML = `<b>Jarak:</b> ${dist} km &nbsp; | &nbsp; <b>Waktu Tempuh:</b> ${time}`;
});

function showRoute(lat,lng){
  if(!navigator.geolocation) return alert("Geolocation tidak didukung di browser ini.");
  navigator.geolocation.getCurrentPosition(function(pos){
    const from = L.latLng(pos.coords.latitude, pos.coords.longitude);
    const to   = L.latLng(lat, lng);
    routingControl.setWaypoints([from, to]);
  }, ()=>alert("Tidak dapat mengakses lokasi Anda."));
}

function locateMe(){
  if(!navigator.geolocation) return alert("Geolocation tidak didukung di browser ini.");
  navigator.geolocation.getCurrentPosition(function(pos){
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    L.marker([lat,lng], {icon:L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34]})})
      .addTo(map).bindPopup("Lokasi Anda").openPopup();
    map.setView([lat,lng], 13);
  }, ()=>alert("Tidak dapat mengakses lokasi Anda."));
}

function resetRoute(){
  routingControl.setWaypoints([]);
  document.getElementById('route-info').innerHTML = "Jarak &amp; Waktu tempuh akan muncul di sini";
}

function getIcon(name){
  let iconUrl = '';
  if(name && name.startsWith('D.I.R.')) iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
  else if(name && name.startsWith('D.I.')) iconUrl = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
  else iconUrl = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
  return L.icon({
    iconUrl, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34],
    shadowUrl:'https://unpkg.com/leaflet/dist/images/marker-shadow.png', shadowSize:[41,41]
  });
}

// ===== MARKERS dari CSV =====
var markersCluster = L.markerClusterGroup();
var featuresIndex = []; // untuk pencarian
var allMarkers = [];    // untuk fitBounds

Papa.parse(CSV_URL, {
  download:true, header:true, skipEmptyLines:true,
  complete: function(res){
    const rows = res.data || [];
    rows.forEach(function(r){
      const nm  = (r.nama_di || r.Nama || r.name || "").toString() || "(Tanpa Nama)";
      const lat = parseFloat(r.y || r.lat || r.latitude);
      const lng = parseFloat(r.x || r.lng || r.longitude);
      if (isNaN(lat) || isNaN(lng)) return;

      const prov = (r.provinsi || r.Provinsi || "-").toString();
      const kab  = (r.kabupaten || r.Kabupaten || "-").toString();
      const bbws = (r.bbws || r.BBWS || "-").toString();
      const note = (r.catatan || r.Catatan || "-").toString();

      const marker = L.marker([lat, lng], {icon:getIcon(nm)}).bindPopup(`
        <b>${nm}</b><br>
        <div style="color:#555;font-size:12px;margin:2px 0;">
          üìç <b>Koordinat:</b> ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </div>
        Provinsi: ${prov}<br>
        Kabupaten: ${kab}<br>
        BBWS: ${bbws}<br>
        Catatan: ${note}<br>
        <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" rel="noopener">Buka di Google Maps</a><br>
        <button onclick='showRoute(${lat}, ${lng})'>Tunjukkan Rute</button>
      `);

      // bounce saat popup dibuka
      marker.on('popupopen', function(){
        const el = marker.getElement();
        if(el){ el.classList.remove('bounce'); void el.offsetWidth; el.classList.add('bounce'); }
      });

      markersCluster.addLayer(marker);
      featuresIndex.push({name:nm, marker});
      allMarkers.push(marker);
    });

    map.addLayer(markersCluster);

    // Fit ke semua marker
    if(allMarkers.length){
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds(), { padding:[20,20] });
    }
  },
  error: function(){ alert("Gagal memuat CSV. Cek URL atau format file."); }
});

// ===== PENCARIAN =====
function showSuggestions(query){
  const box = document.getElementById("suggestions");
  box.innerHTML = "";
  if(!query){ box.style.display="none"; return; }
  const matches = featuresIndex.filter(m => m.name.toLowerCase().includes(query.toLowerCase()));
  matches.slice(0,100).forEach(m=>{
    const div = document.createElement("div");
    div.textContent = m.name;
    div.onclick = function(){
      document.getElementById("search").value = m.name;
      box.style.display="none";
      map.setView(m.marker.getLatLng(), 14);
      m.marker.openPopup();
    };
    box.appendChild(div);
  });
  box.style.display = matches.length ? "block" : "none";
}

// ===== Ripple tombol bawah =====
document.querySelector('.bottom-buttons')?.addEventListener('click', function(e){
  const btn = e.target.closest('.custom-button');
  if(!btn) return;
  const rect = btn.getBoundingClientRect();
  const span = document.createElement('span');
  span.className = 'ripple';
  const size = Math.max(rect.width, rect.height);
  span.style.width = span.style.height = size + 'px';
  span.style.left = (e.clientX - rect.left - size/2) + 'px';
  span.style.top  = (e.clientY - rect.top  - size/2) + 'px';
  btn.appendChild(span);
  setTimeout(()=> span.remove(), 500);
});
</script>

</body>
</html>
