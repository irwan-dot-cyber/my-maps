<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PMTiles Nasional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
#map{height:100%;width:100%}

/* ===== Legend (3 toggle only) ===== */
.legend{
  position:absolute;top:10px;left:50%;transform:translateX(-50%);
  z-index:1000;background:#0f172acc;color:#e5e7eb;
  border-radius:12px;padding:8px 12px;
  display:flex;gap:12px;align-items:center;
  font-size:12px;font-weight:800;
  box-shadow:0 10px 25px rgba(0,0,0,.35)
}
.legend label{display:flex;gap:6px;align-items:center;white-space:nowrap}
.legend input{transform:translateY(1px)}
.dot{width:10px;height:10px;border-radius:50%}
.baku{background:#3b82f6}
.pots{background:#f59e0b}
.fung{background:#10b981}

/* ===== Loading ===== */
#loading{
  position:absolute;inset:0;z-index:2000;
  background:rgba(15,23,42,.62);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  color:#fff;text-align:center
}
.spinner{
  width:44px;height:44px;border:4px solid rgba(255,255,255,.25);
  border-top-color:#22d3ee;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
.barWrap{width:min(340px,82vw);height:10px;
  background:rgba(255,255,255,.15);border-radius:999px;
  overflow:hidden;margin-top:14px}
.barFill{height:100%;width:0%;
  background:linear-gradient(90deg,#22d3ee,#a78bfa)}
.pct{margin-top:8px;font-weight:900;font-size:13px}

/* ===== Zoom Hint ===== */
.zoomHint{
  position:absolute;left:50%;bottom:16px;transform:translateX(-50%);
  z-index:1500;background:rgba(15,23,42,.88);
  color:#e5e7eb;border-radius:999px;
  padding:10px 12px;font-size:12px;font-weight:900;
  display:none;box-shadow:0 10px 25px rgba(0,0,0,.35)
}

/* ===== Home control ===== */
.leaflet-control-home{
  background:#fff;border-radius:4px;
  width:34px;height:34px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 1px 5px rgba(0,0,0,.35)
}
.leaflet-control-home:hover{background:#f3f4f6}
.leaflet-control-home span{font-weight:900;font-size:16px;line-height:1}
</style>
</head>

<body>
<div id="map"></div>

<!-- Legend -->
<div class="legend">
  <label><span class="dot baku"></span><input type="checkbox" id="baku">BAKU</label>
  <label><span class="dot pots"></span><input type="checkbox" id="pots">POTENSIAL</label>
  <label><span class="dot fung"></span><input type="checkbox" id="fung" checked>FUNGSIONAL</label>
</div>

<!-- Zoom hint -->
<div id="zoomHint" class="zoomHint">üîç Perbesar peta untuk melihat DI</div>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div class="barWrap"><div class="barFill" id="barFill"></div></div>
  <div class="pct" id="pct">0%</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
<script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

<script>
/* ===== Map ===== */
const map = L.map("map",{preferCanvas:true}).setView([-2.5,118],5);
L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:20}
).addTo(map);

/* ===== Groups ===== */
const groups={
  BAKU:L.layerGroup(),
  POTENSIAL:L.layerGroup(),
  FUNGSIONAL:L.layerGroup().addTo(map)
};

function fillColor(cat){
  if(cat==="BAKU")return"rgba(59,130,246,.35)";
  if(cat==="POTENSIAL")return"rgba(245,158,11,.35)";
  return"rgba(16,185,129,.35)";
}

/* ===== Global extent ===== */
let allBounds = null;
function extendBounds(minLat,minLon,maxLat,maxLon){
  const b = L.latLngBounds([minLat,minLon],[maxLat,maxLon]);
  allBounds = allBounds ? allBounds.extend(b) : b;
}

/* ===== Admin layers (always ON) ===== */
const adminLine = protomapsL.leafletLayer({
  url:"Batas_Prov_Line.pmtiles",
  paintRules:[{
    dataLayer:"batas_prov_line",
    symbolizer:new protomapsL.LineSymbolizer({
      color:"rgba(255,255,255,.95)",
      width:1.6,
      dash:[10,6,10,6,2,6,10,6,10,6],
      lineCap:"round",lineJoin:"round"
    })
  }],
  labelRules:[]
}).addTo(map);

/*
  LABEL NOTE:
  - Kalau sumber label masih polygon/multipart, viewer bisa munculin label dobel (beda tile).
  - Workaround di sini: label hanya muncul pada zoom kecil (nasional) biar dobelnya minimal.
  - Solusi paling bersih: bikin layer label sebagai POINT centroid 1 provinsi = 1 fitur.
*/
const adminLabel = protomapsL.leafletLayer({
  url:"Batas_Prov_Label.pmtiles",
  paintRules:[],
  labelRules:[{
    dataLayer:"batas_prov_label",
    symbolizer:new protomapsL.TextSymbolizer({
      labelProps:["WADMPR"],
      font:"800 12px system-ui",
      fill:"rgba(255,255,255,.96)",
      stroke:"rgba(15,23,42,.90)",
      width:3,
      minZoom:4,
      maxZoom:6    // <= bikin label nasional saja (kurangi double)
    })
  }]
}).addTo(map);

/* ===== Loading & data ===== */
const bar=document.getElementById("barFill");
const pct=document.getElementById("pct");
const loading=document.getElementById("loading");
const zoomHint=document.getElementById("zoomHint");

let minVisibleZoomF = 7; // fallback

function updateHint(){
  // Hint muncul kalau FUNGSIONAL nyala tapi zoom belum cukup
  const fungOn = map.hasLayer(groups.FUNGSIONAL);
  zoomHint.style.display = (fungOn && map.getZoom() < minVisibleZoomF) ? "block" : "none";
}

async function loadAll(){
  const res=await fetch("manifest.json?v="+Date.now(),{cache:"no-store"});
  const json=await res.json();
  const items=(json.layers||json).filter(i=>groups[i.category]);

  let done=0;

  // extend bounds admin (biar home juga masuk Indonesia)
  // kalau pmtiles admin punya header, kita ambil juga:
  try{
    const p1=new pmtiles.PMTiles("Batas_Prov_Line.pmtiles");
    const h1=await p1.getHeader();
    extendBounds(h1.minLat,h1.minLon,h1.maxLat,h1.maxLon);

    const p2=new pmtiles.PMTiles("Batas_Prov_Label.pmtiles");
    const h2=await p2.getHeader();
    extendBounds(h2.minLat,h2.minLon,h2.maxLat,h2.maxLon);
  }catch(e){ console.warn("Admin header skip:", e); }

  for(const it of items){
    try{
      const p=new pmtiles.PMTiles(it.file);
      const h=await p.getHeader();
      const m=await p.getMetadata();

      extendBounds(h.minLat,h.minLon,h.maxLat,h.maxLon);

      // penting: supaya ‚Äúlihat DI‚Äù muncul sebelum minzoom efektif
      if(it.category==="FUNGSIONAL"){
        const mz = (h.minZoom ?? 0);
        minVisibleZoomF = Math.max(minVisibleZoomF, mz + 1); // +1 biar lebih aman
      }

      const rules=(m.vector_layers||[]).map(v=>({
        dataLayer:v.id,
        symbolizer:new protomapsL.PolygonSymbolizer({
          fill:fillColor(it.category),
          stroke:"rgba(0,0,0,0)",width:0
        })
      }));

      protomapsL.leafletLayer({
        url:it.file,paintRules:rules,labelRules:[]
      }).addTo(groups[it.category]);

    }catch(e){ console.error("Gagal:", it.file, e); }
    finally{
      done++;
      const p=Math.round(done/items.length*100);
      bar.style.width=p+"%";
      pct.textContent=p+"%";
    }
  }

  loading.style.display="none";
  updateHint();
}

loadAll();

/* ===== Toggles ===== */
baku.onchange=()=>baku.checked?map.addLayer(groups.BAKU):map.removeLayer(groups.BAKU);
pots.onchange=()=>pots.checked?map.addLayer(groups.POTENSIAL):map.removeLayer(groups.POTENSIAL);
fung.onchange=()=>fung.checked?map.addLayer(groups.FUNGSIONAL):map.removeLayer(groups.FUNGSIONAL);

/* ===== Home button (fit extent) ===== */
const HomeControl = L.Control.extend({
  options:{ position:"topleft" },
  onAdd:function(){
    const div=L.DomUtil.create("div","leaflet-control-home leaflet-bar");
    div.title="Home (Zoom extent)";
    div.innerHTML="<span>‚åÇ</span>";
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.on(div,"click",()=>{
      if(allBounds) map.fitBounds(allBounds, {padding:[18,18]});
      else map.setView([-2.5,118],5);
      updateHint();
    });
    return div;
  }
});
map.addControl(new HomeControl());

map.on("zoomend",updateHint);
map.on("layeradd",updateHint);
map.on("layerremove",updateHint);
</script>
</body>
</html>
