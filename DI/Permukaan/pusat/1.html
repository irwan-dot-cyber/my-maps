<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PMTiles Nasional + Batas Provinsi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
#map{height:100%;width:100%}

/* === Toggle mini top bar === */
.legend{
  position:absolute;
  top:10px;left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:#0f172acc;
  color:#e5e7eb;
  border-radius:12px;
  padding:8px 12px;
  display:flex;
  gap:12px;
  align-items:center;
  font-size:12px;
  font-weight:800;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
  max-width: min(980px, 96vw);
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.legend label{display:flex;gap:6px;align-items:center;user-select:none;white-space:nowrap}
.legend input{transform:translateY(1px)}
.dot{width:10px;height:10px;border-radius:50%}
.baku{background:#3b82f6}
.pots{background:#f59e0b}
.fung{background:#10b981}
.adm {background:#ffffff}
.lbl {background:#a78bfa}

/* === Loading overlay + spinner + progress === */
#loading{
  position:absolute;
  inset:0;
  z-index:2000;
  background:rgba(15,23,42,.62);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  text-align:center;
  padding:24px;
}
.spinner{
  width:44px;height:44px;
  border:4px solid rgba(255,255,255,.22);
  border-top-color:#22d3ee;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loadText{margin-top:14px;font-size:16px;font-weight:900;letter-spacing:.3px}
.loadSub{margin-top:6px;font-size:12px;opacity:.85}
.barWrap{
  width:min(340px, 82vw);
  margin-top:14px;
  background:rgba(255,255,255,.14);
  border-radius:999px;
  overflow:hidden;
  height:10px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
}
.barFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22d3ee,#a78bfa);
  border-radius:999px;
  transition:width .18s ease;
}
.pct{margin-top:10px;font-size:13px;font-weight:900;opacity:.95}

/* === Zoom hint === */
.zoomHint{
  position:absolute;
  left:50%;
  bottom:16px;
  transform:translateX(-50%);
  z-index:1500;
  background:rgba(15,23,42,.88);
  color:#e5e7eb;
  border:1px solid rgba(148,163,184,.35);
  padding:10px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  max-width:min(520px,92vw);
  text-align:center;
  display:none;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- Toggle -->
<div class="legend">
  <label><span class="dot baku"></span><input type="checkbox" id="baku">BAKU</label>
  <label><span class="dot pots"></span><input type="checkbox" id="pots">POTENSIAL</label>
  <label><span class="dot fung"></span><input type="checkbox" id="fung" checked>FUNGSIONAL</label>
  <label><span class="dot adm"></span><input type="checkbox" id="adm">BATAS</label>
  <label><span class="dot lbl"></span><input type="checkbox" id="lbl">LABEL</label>
</div>

<!-- Zoom hint -->
<div id="zoomHint" class="zoomHint">üîç Perbesar peta untuk melihat data</div>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div class="loadText" id="loadText">Loading data‚Ä¶</div>
  <div class="loadSub" id="loadSub">Menyiapkan layer PMTiles</div>
  <div class="barWrap" aria-hidden="true"><div class="barFill" id="barFill"></div></div>
  <div class="pct" id="pct">0%</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
<script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

<script>
/* ===================== MAP ===================== */
const map = L.map("map",{preferCanvas:true, zoomControl:true}).setView([-2.5,118],5);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:20}
).addTo(map);

/* ===================== UI ===================== */
const loadingEl = document.getElementById("loading");
const loadTextEl = document.getElementById("loadText");
const loadSubEl  = document.getElementById("loadSub");
const barFillEl  = document.getElementById("barFill");
const pctEl      = document.getElementById("pct");
const zoomHintEl = document.getElementById("zoomHint");

function setProgress(done,total){
  const pct = total ? Math.round((done/total)*100) : 0;
  barFillEl.style.width = pct + "%";
  pctEl.textContent = pct + "%";
  loadSubEl.textContent = `Memuat ${done} dari ${total} layer`;
}

/* ===================== GROUPS (DI nasional) ===================== */
const groups = {
  BAKU: L.layerGroup(),
  POTENSIAL: L.layerGroup(),
  FUNGSIONAL: L.layerGroup().addTo(map) // default ON
};

function fillColor(cat){
  if(cat==="BAKU") return "rgba(59,130,246,.35)";
  if(cat==="POTENSIAL") return "rgba(245,158,11,.35)";
  return "rgba(16,185,129,.35)";
}

/* ===================== ADMIN LAYERS ===================== */
/* Batas prov line: putih dash dash dot dash dash */
const adminLineLayer = protomapsL.leafletLayer({
  url: "Batas_Prov_Line.pmtiles",
  paintRules: [{
    dataLayer: "batas_prov_line",
    symbolizer: new protomapsL.LineSymbolizer({
      color: "rgba(255,255,255,0.95)",
      width: 1.6,
      dash: [10,6, 10,6, 2,6, 10,6, 10,6],
      lineJoin: "round",
      lineCap: "round"
    })
  }],
  labelRules: []
});

/* Label prov: dari WADMPR, polygon tidak digambar */
const adminLabelLayer = protomapsL.leafletLayer({
  url: "Batas_Prov_Label.pmtiles",
  paintRules: [], // jangan gambar polygonnya
  labelRules: [{
    dataLayer: "batas_prov_label",
    symbolizer: new protomapsL.TextSymbolizer({
      labelProps: ["WADMPR"],
      font: "700 12px system-ui",
      fill: "rgba(255,255,255,0.95)",
      stroke: "rgba(15,23,42,0.85)",
      width: 3,
      wrap: 16,
      minZoom: 4
    })
  }]
});

/* ===================== STATE ===================== */
let unionBounds = null;
let activeMinZoomRequired = 0; // minZoom FUNGSIONAL (dipakai untuk hint)
const layerCountByCategory = { BAKU:0, POTENSIAL:0, FUNGSIONAL:0 };

function normalizeManifest(json){
  let arr = [];
  if (Array.isArray(json)) arr = json;
  else if (json && Array.isArray(json.layers)) arr = json.layers;
  else if (json && Array.isArray(json.items)) arr = json.items;

  return arr.map((raw) => {
    const file = raw.file || raw.path || raw.pmtiles || raw.url || "";
    const category = (raw.category || raw.cat || raw.group || "").toString().toUpperCase();
    return { file, category };
  }).filter(x => x.file && /\.pmtiles$/i.test(x.file) && groups[x.category]);
}

async function readHeaderAndMeta(url){
  const p = new pmtiles.PMTiles(url);
  const header = await p.getHeader();
  const meta = await p.getMetadata();
  const bounds = L.latLngBounds([header.minLat, header.minLon], [header.maxLat, header.maxLon]);
  const vectorLayers = (meta && meta.vector_layers) ? meta.vector_layers.map(v => v.id) : [];
  return { header, bounds, vectorLayers };
}

/* polygon rules: no outline */
function polygonOnlyRules(vectorLayers, cat){
  const fill = fillColor(cat);
  return vectorLayers.map(name => ({
    dataLayer: name,
    symbolizer: new protomapsL.PolygonSymbolizer({
      fill,
      stroke: "rgba(0,0,0,0)",
      width: 0
    })
  }));
}

function updateZoomHint(){
  const z = map.getZoom();
  const req = activeMinZoomRequired || 5; // fallback
  // tampilkan hint jika FUNGSIONAL ada dan zoom belum cukup
  const hasF = layerCountByCategory.FUNGSIONAL > 0;
  zoomHintEl.style.display = (hasF && z < req) ? "block" : "none";
}

/* ===================== LOAD ALL ===================== */
async function loadAll(){
  try{
    const res = await fetch("manifest.json?v=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("manifest.json HTTP " + res.status);

    const json = await res.json();
    const items = normalizeManifest(json);
    const total = items.length;
    let done = 0;

    setProgress(done,total);
    loadTextEl.textContent = "Loading data‚Ä¶";

    for(const it of items){
      try{
        const { header, bounds, vectorLayers } = await readHeaderAndMeta(it.file);

        unionBounds = unionBounds ? unionBounds.extend(bounds) : bounds;

        // ambil minZoom requirement khusus FUNGSIONAL (yang default ON)
        if(it.category === "FUNGSIONAL"){
          activeMinZoomRequired = Math.max(activeMinZoomRequired, header.minZoom || 0);
          layerCountByCategory.FUNGSIONAL++;
        }else if(it.category === "BAKU"){
          layerCountByCategory.BAKU++;
        }else if(it.category === "POTENSIAL"){
          layerCountByCategory.POTENSIAL++;
        }

        const layer = protomapsL.leafletLayer({
          url: it.file,
          paintRules: polygonOnlyRules(vectorLayers, it.category),
          labelRules: []
        });

        // add to group (default yang nempel ke map cuma FUNGSIONAL)
        layer.addTo(groups[it.category]);

      }catch(e){
        console.error("Skip:", it.file, e);
      }finally{
        done++;
        setProgress(done,total);
      }
    }

    // fit ke seluruh data
    if(unionBounds){
      map.invalidateSize(true);
      map.fitBounds(unionBounds, {padding:[30,30], animate:true});
    }

  }catch(e){
    console.error(e);
    loadTextEl.textContent = "Gagal memuat data";
    loadSubEl.textContent = "Cek manifest.json & console";
  }finally{
    setTimeout(() => {
      loadingEl.style.display = "none";
      updateZoomHint();
    }, 250);
  }
}

loadAll();

/* ===================== DEFAULT TOGGLES ===================== */
baku.checked = false;
pots.checked = false;
fung.checked = true;
adm.checked  = false;
lbl.checked  = false;

// default: hanya FUNGSIONAL tampil
map.removeLayer(groups.BAKU);
map.removeLayer(groups.POTENSIAL);
map.addLayer(groups.FUNGSIONAL);

// toggle DI categories
baku.onchange = () => baku.checked ? map.addLayer(groups.BAKU) : map.removeLayer(groups.BAKU);
pots.onchange = () => pots.checked ? map.addLayer(groups.POTENSIAL) : map.removeLayer(groups.POTENSIAL);
fung.onchange = () => fung.checked ? map.addLayer(groups.FUNGSIONAL) : map.removeLayer(groups.FUNGSIONAL);

// toggle admin line & label
adm.onchange = () => adm.checked ? adminLineLayer.addTo(map) : map.removeLayer(adminLineLayer);
lbl.onchange = () => lbl.checked ? adminLabelLayer.addTo(map) : map.removeLayer(adminLabelLayer);

// zoom hint refresh
map.on("zoomend moveend", updateZoomHint);
</script>
</body>
</html>
