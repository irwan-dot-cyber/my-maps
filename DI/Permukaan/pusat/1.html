<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DI Permukaan - Nasional (PMTiles)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{height:100%;width:100%}

    /* ===== Top legend bar (compact) ===== */
    .legendbar{
      position:absolute;z-index:9999;
      top:10px;left:50%;transform:translateX(-50%);
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;
      background:#0b1220cc;color:#e5e7eb;
      border:1px solid #334155;border-radius:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      max-width:calc(100vw - 20px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .lg-item{display:flex;align-items:center;gap:8px;white-space:nowrap;font-weight:800;font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;flex:0 0 auto}
    .dot.baku{background:#3b82f6}
    .dot.pots{background:#f59e0b}
    .dot.fung{background:#22c55e}
    .lg-item input{transform:scale(1.05);accent-color:#60a5fa}

    /* ===== Loading overlay ===== */
    .overlay{
      position:absolute;inset:0;z-index:9998;
      display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
      pointer-events:none;
      opacity:0;transition:opacity .2s ease;
    }
    .overlay.show{opacity:1;pointer-events:auto}
    .card{
      background:#0b1220ee;color:#e5e7eb;
      border:1px solid #334155;border-radius:16px;
      padding:16px 18px;min-width:min(320px, calc(100vw - 44px));
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      text-align:center;
    }
    .spinner{
      width:42px;height:42px;border-radius:999px;
      border:4px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.95);
      margin:0 auto 10px auto;
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .pct{font-weight:900;font-size:18px;margin-top:6px}
    .hint{font-size:12px;color:#cbd5e1;margin-top:6px}

    /* ===== Small helper text bottom ===== */
    .helper{
      position:absolute;z-index:9997;
      left:50%;transform:translateX(-50%);
      bottom:14px;
      padding:8px 12px;
      background:#0b1220cc;color:#e5e7eb;
      border:1px solid #334155;border-radius:999px;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
      font-weight:700;font-size:12px;
      backdrop-filter: blur(10px);
      display:none;
      max-width:calc(100vw - 24px);
      text-align:center;
    }
    .helper.show{display:block}

    /* ===== Leaflet custom home button ===== */
    .leaflet-bar a.homebtn{
      font-weight:900;
      text-align:center;
      line-height:26px;
      font-size:16px;
    }

    /* ===== Label style (Leaflet divIcon) ===== */
    .prov-label{
      color:#fff;
      font-weight:900;
      font-size:12px;
      text-shadow:
        -1px -1px 0 rgba(0,0,0,.85),
         1px -1px 0 rgba(0,0,0,.85),
        -1px  1px 0 rgba(0,0,0,.85),
         1px  1px 0 rgba(0,0,0,.85),
         0px  2px 6px rgba(0,0,0,.7);
      white-space:nowrap;
      pointer-events:none;
      transform:translate(-50%,-50%);
    }

    /* Mobile: make top legend even slimmer */
    @media (max-width:520px){
      .legendbar{padding:8px 10px;border-radius:12px;gap:8px}
      .lg-item{font-size:12px}
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Compact legend -->
  <div class="legendbar" id="legend">
    <label class="lg-item">
      <span class="dot baku"></span>
      <input type="checkbox" id="cbBaku">
      BAKU
    </label>

    <label class="lg-item">
      <span class="dot pots"></span>
      <input type="checkbox" id="cbPots">
      POTENSIAL
    </label>

    <label class="lg-item">
      <span class="dot fung"></span>
      <input type="checkbox" id="cbFung" checked>
      FUNGSIONAL
    </label>
  </div>

  <!-- Loading overlay -->
  <div class="overlay" id="overlay">
    <div class="card">
      <div class="spinner"></div>
      <div style="font-weight:900">Loading data…</div>
      <div class="pct" id="pct">0%</div>
      <div class="hint" id="hint">Mengambil PMTiles & label…</div>
    </div>
  </div>

  <!-- Helper -->
  <div class="helper" id="helper">Perbesar peta untuk melihat DI</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
  <script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

  <script>
    // ===== Map init =====
    const map = L.map("map", { zoomControl:true, preferCanvas:true })
      .setView([-2.5, 118], 5);

    // Imagery basemap
    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom:20, attribution:"Tiles © Esri" }
    ).addTo(map);

    // ===== UI =====
    const overlay = document.getElementById("overlay");
    const pctEl   = document.getElementById("pct");
    const hintEl  = document.getElementById("hint");
    const helper  = document.getElementById("helper");

    const cbBaku = document.getElementById("cbBaku");
    const cbPots = document.getElementById("cbPots");
    const cbFung = document.getElementById("cbFung");

    function showOverlay(msg){
      if (msg) hintEl.textContent = msg;
      overlay.classList.add("show");
    }
    function hideOverlay(){
      overlay.classList.remove("show");
    }
    function setPct(p){
      pctEl.textContent = Math.max(0, Math.min(100, Math.round(p))) + "%";
    }

    // ===== Home extent (Indonesia-ish) =====
    const HOME_BOUNDS = L.latLngBounds(
      [-11.5, 94.0],   // SW
      [  7.5, 141.5]   // NE
    );

    // Custom HOME button under zoom
    const HomeControl = L.Control.extend({
      options:{ position:"topleft" },
      onAdd: function(){
        const container = L.DomUtil.create("div", "leaflet-bar");
        const a = L.DomUtil.create("a", "homebtn", container);
        a.href="#";
        a.title="Home";
        a.innerHTML="⌂";
        L.DomEvent.on(a, "click", (e)=>{
          L.DomEvent.stop(e);
          map.fitBounds(HOME_BOUNDS, { padding:[20,20] });
        });
        return container;
      }
    });
    map.addControl(new HomeControl());

    // ===== Helpers: hide/show text based on zoom =====
    const DI_MIN_VISIBLE_ZOOM = 5; // from your test: minZoom: 5
    function updateHelper(){
      // Show hint if zoom too small (many DI pmtiles won't render below minZoom)
      if (map.getZoom() < DI_MIN_VISIBLE_ZOOM) helper.classList.add("show");
      else helper.classList.remove("show");
    }
    map.on("zoomend", updateHelper);
    updateHelper();

    // ===== PMTiles helpers =====
    async function readHeader(url){
      const p = new pmtiles.PMTiles(url);
      return await p.getHeader();
    }

    // No outline polygon rules (fill only)
    function makePolygonOnlyRules(vectorLayers, fillRGBA){
      return vectorLayers.map(layerName => ({
        dataLayer: layerName,
        symbolizer: new protomapsL.PolygonSymbolizer({
          fill: fillRGBA,
          stroke: "rgba(0,0,0,0)",
          width: 0
        })
      }));
    }

    // ===== DI layer manager =====
    const DI = {
      layersAll: [], // from manifest
      layerEntries: [], // {layerObj, category}
      boundsUnion: null
    };

    const CATEGORY_STYLE = {
      "BAKU": "rgba(59,130,246,0.35)",
      "POTENSIAL": "rgba(245,158,11,0.35)",
      "FUNGSIONAL": "rgba(34,197,94,0.30)"
    };

    function categoryFromItem(item){
      // prefer explicit category field
      if (item.category) return String(item.category).toUpperCase();
      // fallback from name
      const t = (item.title || item.name || "").toUpperCase();
      if (t.includes("BAKU")) return "BAKU";
      if (t.includes("POTS") || t.includes("POTENS")) return "POTENSIAL";
      if (t.includes("FUNG")) return "FUNGSIONAL";
      return "FUNGSIONAL";
    }

    async function addOneDI(item){
      const url = item.file;
      const p = new pmtiles.PMTiles(url);
      const meta = await p.getMetadata();
      const header = await p.getHeader();

      const bounds = L.latLngBounds([header.minLat, header.minLon],[header.maxLat, header.maxLon]);
      DI.boundsUnion = DI.boundsUnion ? DI.boundsUnion.extend(bounds) : bounds;

      const vectorLayers = (meta && meta.vector_layers) ? meta.vector_layers.map(v => v.id) : [];
      const cat = categoryFromItem(item);
      const fill = CATEGORY_STYLE[cat] || CATEGORY_STYLE["FUNGSIONAL"];
      const paintRules = makePolygonOnlyRules(vectorLayers, fill);

      const layer = protomapsL.leafletLayer({ url, paintRules, labelRules: [] });
      layer.addTo(map);

      DI.layerEntries.push({ layer, category: cat, bounds });
    }

    function setCategoryVisible(cat, visible){
      DI.layerEntries.forEach(e=>{
        if (e.category !== cat) return;
        if (visible){
          if (!map.hasLayer(e.layer)) e.layer.addTo(map);
        } else {
          if (map.hasLayer(e.layer)) map.removeLayer(e.layer);
        }
      });
    }

    // ===== Province boundary line (always ON) =====
    // Adjust path if needed
    const PROV_LINE_PM = "../../Provinsi/Batas_Prov_Line.pmtiles"; // change if your file is elsewhere
    async function addProvLine(){
      try{
        const p = new pmtiles.PMTiles(PROV_LINE_PM);
        const meta = await p.getMetadata();
        const v = (meta && meta.vector_layers) ? meta.vector_layers.map(x=>x.id) : [];

        const rules = v.map(layerName => ({
          dataLayer: layerName,
          symbolizer: new protomapsL.LineSymbolizer({
            color: "rgba(255,255,255,0.90)",
            width: 2,
            // Dash pattern approximation (dash dash dot dash dash)
            // Protomaps line dash is supported as 'dash' in some builds,
            // if yours ignores it, it will render solid (still OK).
            dash: [10,6,2,6,10,6]
          })
        }));

        const layer = protomapsL.leafletLayer({ url: PROV_LINE_PM, paintRules: rules, labelRules: [] });
        layer.addTo(map);
      }catch(e){
        console.warn("Prov line failed:", e);
      }
    }

    // ===== Province labels (GeoJSON points, always ON) =====
    // You saved in DI root: DI/Point_Label.geojson
    // This HTML is inside DI/Permukaan/pusat/ so relative path:
    const PROV_LABEL_GJ = "../../Point_Label.geojson"; // adjust if needed

    let labelLayer = null;

    function makeLabelMarker(latlng, text){
      return L.marker(latlng, {
        interactive:false,
        icon: L.divIcon({
          className:"",
          html:`<div class="prov-label">${text}</div>`,
          iconSize:[0,0]
        })
      });
    }

    async function addProvLabels(){
      try{
        const res = await fetch(PROV_LABEL_GJ, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const gj = await res.json();

        const group = L.layerGroup();
        const used = new Set(); // prevent doubles by name
        (gj.features || []).forEach(f=>{
          const g = f.geometry;
          if(!g || g.type !== "Point") return;

          const props = f.properties || {};
          const name = (props.WADMPR || props.NAMA || props.NAME || props.nama || "").toString().trim();
          if(!name) return;
          if(used.has(name)) return;
          used.add(name);

          const [x,y] = g.coordinates; // [lon,lat]
          group.addLayer(makeLabelMarker([y,x], name));
        });

        group.addTo(map);
        labelLayer = group;

      }catch(e){
        console.warn("Prov labels failed:", e);
      }
    }

    // ===== Load manifest and bootstrap =====
    async function loadAll(){
      showOverlay("Loading data…");
      setPct(0);

      // 1) fetch manifest
      let manifest;
      try{
        const res = await fetch("manifest.json?v=" + Date.now(), { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        manifest = await res.json();
      }catch(e){
        console.error(e);
        showOverlay("Gagal baca manifest.json");
        setPct(0);
        return;
      }

      // normalize manifest -> array
      let items = [];
      if (Array.isArray(manifest)) items = manifest;
      else if (manifest && Array.isArray(manifest.layers)) items = manifest.layers;
      else if (manifest && Array.isArray(manifest.items)) items = manifest.items;

      // map to {file,title,category}
      items = items.map((raw,i)=>{
        const file = raw.file || raw.path || raw.pmtiles || raw.url || "";
        const title = raw.title || raw.name || file.replace(/\.pmtiles$/i,"") || ("Layer " + (i+1));
        const category = raw.category || raw.kategori || null;
        return { file, title, category };
      }).filter(x=>x.file && /\.pmtiles$/i.test(x.file));

      DI.layersAll = items;

      // 2) always-on province line + labels (don’t count them for %)
      addProvLine();
      addProvLabels();

      // 3) load all DI pmtiles (we need them on map to be toggleable)
      const total = items.length || 1;
      let done = 0;

      for(const it of items){
        try{
          await addOneDI(it);
        }catch(e){
          console.warn("Skip layer:", it.file, e);
        }
        done++;
        setPct((done/total)*100);
      }

      // 4) Apply default visibility: FUNGSIONAL ON, others OFF
      cbFung.checked = true;
      cbBaku.checked = false;
      cbPots.checked = false;

      setCategoryVisible("FUNGSIONAL", true);
      setCategoryVisible("BAKU", false);
      setCategoryVisible("POTENSIAL", false);

      // 5) Try fit to union bounds (but many DI are minZoom 5, so still show hint)
      if (DI.boundsUnion){
        map.fitBounds(DI.boundsUnion, { padding:[20,20] });
      } else {
        map.fitBounds(HOME_BOUNDS, { padding:[20,20] });
      }

      hideOverlay();
      updateHelper();
    }

    // ===== Toggle handlers =====
    cbBaku.addEventListener("change", ()=> setCategoryVisible("BAKU", cbBaku.checked));
    cbPots.addEventListener("change", ()=> setCategoryVisible("POTENSIAL", cbPots.checked));
    cbFung.addEventListener("change", ()=> setCategoryVisible("FUNGSIONAL", cbFung.checked));

    loadAll();
  </script>
</body>
</html>
