<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMTiles Viewer | DI Permukaan (Pusat)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --headerH: 72px;
      --panelW: 420px;
      --bg: #0b1220;
      --card: rgba(11, 18, 32, .92);
      --border: #2a3b4f;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #0b4fa3;
    }

    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{
      position: fixed;
      top: var(--headerH);
      left: 0; right: 0; bottom: 0;
      width: 100%;
      height: calc(100% - var(--headerH));
    }

    /* Header */
    .app-header{
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--headerH);
      background: var(--primary);
      color: #fff;
      z-index: 5000;
      display: flex;
      align-items: center;
      padding: 0 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .brand{
      display: flex;
      align-items: center;
      gap: 14px;
      width: 100%;
    }
    .brand img{height: 44px; width:auto;}
    .brand-text .title{font-weight: 700; font-size: 14px; letter-spacing:.2px;}
    .brand-text .subtitle{font-size: 13px;}
    .brand-text .subsubtitle{font-size: 12px; opacity: .88;}

    /* Panel */
    .panel{
      position: fixed;
      top: calc(var(--headerH) + 12px);
      left: 12px;
      width: min(var(--panelW), calc(100vw - 24px));
      background: rgba(15, 23, 42, .92);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, .18);
      border-radius: 16px;
      overflow: hidden;
      z-index: 4000;
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .panel header{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, .18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .panel header b{font-size: 14px;}
    .pill{
      font-size: 12px;
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, .18);
      background: rgba(2, 6, 23, .35);
    }

    .panel .content{padding: 10px 12px;}
    .row{display:flex; gap:8px; align-items:center; margin-bottom: 10px;}
    .row label{font-size: 12px; color: var(--muted); min-width: 80px;}
    select{
      width: 100%;
      background: rgba(2, 6, 23, .55);
      color: #fff;
      border: 1px solid rgba(148, 163, 184, .18);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
    }
    .btnbar{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      background: rgba(2, 6, 23, .55);
      color: #fff;
      border: 1px solid rgba(148, 163, 184, .18);
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 650;
      cursor: pointer;
    }
    button:hover{border-color: rgba(148, 163, 184, .35);}

    .status{
      margin-top: 8px;
      padding: 10px 12px;
      border-top: 1px solid rgba(148, 163, 184, .18);
      font-size: 12px;
      color: var(--muted);
      background: rgba(2, 6, 23, .35);
    }

    /* Legend */
    .legend{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(15, 23, 42, .92);
      color: #fff;
      border: 1px solid rgba(148, 163, 184, .18);
      border-radius: 14px;
      padding: 10px 12px;
      z-index: 4000;
      font-size: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
    }
    .legend .item{display:flex; align-items:center; gap:8px; margin: 5px 0;}
    .swatch{width: 14px; height: 14px; border-radius: 4px;}

    .swatch.baku{background:#20c4d8;}
    .swatch.fung{background:#3cb371;}
    .swatch.pots{background:#f4c430;}
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="app-header">
    <div class="brand">
      <!-- Ganti ke logo kamu (pastikan ada di folder assets) -->
      <img src="assets/logo-pupr.png" alt="PUPR" />
      <div class="brand-text">
        <div class="title">KEMENTERIAN PEKERJAAN UMUM</div>
        <div class="subtitle">Direktorat Jenderal Sumber Daya Air</div>
        <div class="subsubtitle">Direktorat Irigasi & Rawa</div>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <!-- PANEL -->
  <div class="panel">
    <header>
      <b>ðŸ§© PMTiles Viewer</b>
      <span class="pill" id="pillInfo">0 BWS</span>
    </header>

    <div class="content">
      <div class="row">
        <label>BWS / BBWS</label>
        <select id="bwsSelect">
          <option value="ALL">Memuatâ€¦</option>
        </select>
      </div>

      <div class="btnbar">
        <button id="btnZoom">Zoom BWS</button>
        <button id="btnAll">Semua BWS ON</button>
        <button id="btnOff">All OFF</button>
      </div>
    </div>

    <div class="status" id="status">Memuat manifestâ€¦</div>
  </div>

  <!-- LEGEND -->
  <div class="legend">
    <div class="item"><span class="swatch baku"></span> BAKU</div>
    <div class="item"><span class="swatch fung"></span> FUNGSIONAL</div>
    <div class="item"><span class="swatch pots"></span> POTENSIAL</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
  <script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const PMTILES_MAXZOOM = 18;

    // Cache buster: ganti nilainya tiap kamu update pmtiles di GitHub (biar ga ketahan cache)
    // contoh: "20260129-1138"
    const CACHE_BUST = "v1";

    const statusEl = document.getElementById("status");
    const pillInfo = document.getElementById("pillInfo");
    const bwsSelect = document.getElementById("bwsSelect");

    function setStatus(t){ statusEl.textContent = t; }

    // =========================
    // MAP + IMAGERY
    // =========================
    const map = L.map("map", {
      zoomControl: true,
      preferCanvas: true,
      maxZoom: PMTILES_MAXZOOM
    }).setView([-2.5, 118], 5);

    const imagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: PMTILES_MAXZOOM, attribution: "Tiles Â© Esri" }
    ).addTo(map);

    // =========================
    // HELPERS
    // =========================
    function normalizeManifest(json){
      let arr = [];
      if (Array.isArray(json)) arr = json;
      else if (json && Array.isArray(json.layers)) arr = json.layers;
      else if (json && Array.isArray(json.items)) arr = json.items;

      return arr.map((raw, i) => {
        const file = raw.file || raw.path || raw.pmtiles || raw.url || "";
        const title = raw.title || raw.name || file.replace(/\.pmtiles$/i,"");
        const id = raw.id || (i + ":" + file);
        return { id, file, title };
      }).filter(x => x.file && /\.pmtiles$/i.test(x.file));
    }

    // Ambil label BWS/BBWS dari judul:
    // Contoh:
    // "Aceh Pusat - BWS Sumatera I - BAKU"
    // "Banten Pusat - BBWS Cidanauâ€“Ciujungâ€“Cidurian - FUNGSIONAL"
    function getBwsLabel(titleOrFile){
      const s = String(titleOrFile || "");
      const m = s.match(/\b(BBWS|BWS)\b[^-]*?(?=\s*-\s*(BAKU|FUNG|FUNGSIONAL|POTS|POTENSIAL)\b)/i);
      if (m && m[0]) return m[0].trim();
      // fallback: coba cari "BWS ..." atau "BBWS ..."
      const m2 = s.match(/\b(BBWS|BWS)\b.+$/i);
      return (m2 && m2[0]) ? m2[0].trim() : "LAINNYA";
    }

    function getType(titleOrFile){
      const s = String(titleOrFile || "").toUpperCase();
      if (s.includes("BAKU")) return "BAKU";
      if (s.includes("FUNG")) return "FUNG";
      if (s.includes("FUNGSIONAL")) return "FUNG";
      if (s.includes("POTS")) return "POTS";
      if (s.includes("POTENSIAL")) return "POTS";
      return "OTHER";
    }

    function colorByType(type){
      if (type === "BAKU") return "rgba(32,196,216,0.45)";
      if (type === "FUNG") return "rgba(60,179,113,0.45)";
      if (type === "POTS") return "rgba(244,196,48,0.45)";
      return "rgba(32,196,216,0.35)";
    }

    // Polygon only, tanpa outline, tanpa node merah
    function makePolygonOnlyRules(vectorLayers, type){
      const fill = colorByType(type);
      const rules = [];
      for (const layerName of vectorLayers){
        rules.push({
          dataLayer: layerName,
          symbolizer: new protomapsL.PolygonSymbolizer({
            fill,
            stroke: "rgba(0,0,0,0)",
            width: 0
          })
        });
      }
      return rules;
    }

    async function readPmtilesInfo(url){
      const p = new pmtiles.PMTiles(url);
      const meta = await p.getMetadata();
      const header = await p.getHeader();

      const bounds = L.latLngBounds(
        [header.minLat, header.minLon],
        [header.maxLat, header.maxLon]
      );

      let vectorLayers = [];
      if (meta) {
        try{
          const j = JSON.parse(new TextDecoder().decode(meta));
          vectorLayers = (j.vector_layers || []).map(v => v.id).filter(Boolean);
        }catch(e){
          vectorLayers = [];
        }
      }
      return { bounds, vectorLayers };
    }

    // =========================
    // STATE
    // =========================
    const state = {
      items: [],
      groups: new Map(),      // bws -> items[]
      layers: new Map(),      // item.id -> { leafletLayer, bounds, type, bws }
      groupBounds: new Map(), // bws -> LatLngBounds
      currentBws: "ALL"
    };

    function clearAllLayers(){
      for (const entry of state.layers.values()){
        map.removeLayer(entry.leafletLayer);
      }
      state.layers.clear();
    }

    async function addItemLayer(item){
      if (state.layers.has(item.id)) return;

      const type = getType(item.title || item.file);
      const bws = getBwsLabel(item.title || item.file);

      const url = item.file + "?v=" + encodeURIComponent(CACHE_BUST);

      const info = await readPmtilesInfo(url);
      const paintRules = makePolygonOnlyRules(info.vectorLayers, type);

      const leafletLayer = protomapsL.leafletLayer({
        url,
        paintRules,
        labelRules: []
      });

      leafletLayer.addTo(map);

      state.layers.set(item.id, { leafletLayer, bounds: info.bounds, type, bws });

      // simpan bounds per group
      const existing = state.groupBounds.get(bws);
      state.groupBounds.set(bws, existing ? existing.extend(info.bounds) : info.bounds);
    }

    async function showBws(bws){
      clearAllLayers();
      state.currentBws = bws;

      if (bws === "ALL"){
        setStatus("Menyalakan semua BWS (bisa agak berat)â€¦");
        const all = state.items.slice();
        for (const it of all){
          try{ await addItemLayer(it); }catch(e){ console.error(e); }
        }
        setStatus("Semua BWS ON.");
        pillInfo.textContent = `${state.groups.size} BWS`;
        return;
      }

      const list = state.groups.get(bws) || [];
      setStatus(`Memuat: ${bws} (BAKU/FUNG/POTS)â€¦`);
      for (const it of list){
        try{ await addItemLayer(it); }catch(e){ console.error(e); }
      }
      setStatus(`Tampil: ${bws} (total ${list.length} layer).`);
    }

    function zoomCurrentBws(){
      const bws = state.currentBws;
      if (bws === "ALL"){
        // fit semua layer yg sedang ON
        let b = null;
        for (const entry of state.layers.values()){
          b = b ? b.extend(entry.bounds) : entry.bounds;
        }
        if (b) map.fitBounds(b, { padding:[30,30] });
        return;
      }
      const gb = state.groupBounds.get(bws);
      if (gb) map.fitBounds(gb, { padding:[30,30] });
    }

    // =========================
    // UI EVENTS
    // =========================
    document.getElementById("btnZoom").addEventListener("click", zoomCurrentBws);
    document.getElementById("btnAll").addEventListener("click", () => showBws("ALL"));
    document.getElementById("btnOff").addEventListener("click", () => {
      clearAllLayers();
      setStatus("All OFF.");
    });

    bwsSelect.addEventListener("change", () => {
      const bws = bwsSelect.value;
      showBws(bws);
    });

    // =========================
    // LOAD MANIFEST + BUILD DROPDOWN
    // =========================
    async function init(){
      try{
        // manifest juga di-cache bust kecil
        const res = await fetch("manifest.json?v=" + Date.now(), { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();

        state.items = normalizeManifest(json);
        if (!state.items.length){
          setStatus("manifest.json kebaca tapi tidak ada file .pmtiles.");
          return;
        }

        // group by BWS/BBWS
        state.groups.clear();
        for (const it of state.items){
          const bws = getBwsLabel(it.title || it.file);
          if (!state.groups.has(bws)) state.groups.set(bws, []);
          state.groups.get(bws).push(it);
        }

        // build dropdown
        const bwsList = Array.from(state.groups.keys()).sort((a,b)=>a.localeCompare(b, "id"));
        pillInfo.textContent = `${bwsList.length} BWS`;

        bwsSelect.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "ALL";
        optAll.textContent = "Semua BWS";
        bwsSelect.appendChild(optAll);

        for (const bws of bwsList){
          const opt = document.createElement("option");
          opt.value = bws;
          opt.textContent = bws;
          bwsSelect.appendChild(opt);
        }

        setStatus("Pilih BWS/BBWS untuk menampilkan layer.");
        // default: jangan auto load semua, biar ringan
        bwsSelect.value = bwsList[0] ? bwsList[0] : "ALL";
        await showBws(bwsSelect.value);
        zoomCurrentBws();
      }catch(e){
        console.error(e);
        setStatus("Gagal baca manifest.json (cek lokasi & format JSON).");
      }
    }

    init();
  </script>
</body>
</html>
