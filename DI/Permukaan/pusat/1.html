<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PMTiles Nasional</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto}
#map{height:100%;width:100%}

/* === Legend mini (mobile friendly) === */
.legend{
  position:absolute;
  top:10px;left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:#0f172acc;
  color:#e5e7eb;
  border-radius:12px;
  padding:8px 12px;
  display:flex;
  gap:12px;
  align-items:center;
  font-size:12px;
  font-weight:800;
  box-shadow:0 10px 25px rgba(0,0,0,.35)
}
.legend label{display:flex;gap:6px;align-items:center;user-select:none;white-space:nowrap}
.legend input{transform:translateY(1px)}
.dot{width:10px;height:10px;border-radius:50%}
.baku{background:#3b82f6}
.pots{background:#f59e0b}
.fung{background:#10b981}

/* === Loading overlay + spinner + progress === */
#loading{
  position:absolute;
  inset:0;
  z-index:2000;
  background:rgba(15,23,42,.62);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  text-align:center;
  padding:24px;
}
.spinner{
  width:44px;height:44px;
  border:4px solid rgba(255,255,255,.22);
  border-top-color:#22d3ee;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.loadText{
  margin-top:14px;
  font-size:16px;
  font-weight:900;
  letter-spacing:.3px;
}
.loadSub{
  margin-top:6px;
  font-size:12px;
  opacity:.85;
}

/* progress bar */
.barWrap{
  width:min(340px, 82vw);
  margin-top:14px;
  background:rgba(255,255,255,.14);
  border-radius:999px;
  overflow:hidden;
  height:10px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.10);
}
.barFill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22d3ee,#a78bfa);
  border-radius:999px;
  transition:width .18s ease;
}
.pct{
  margin-top:10px;
  font-size:13px;
  font-weight:900;
  opacity:.95;
}
</style>
</head>

<body>
<div id="map"></div>

<!-- Legend -->
<div class="legend">
  <label><span class="dot baku"></span><input type="checkbox" id="baku">BAKU</label>
  <label><span class="dot pots"></span><input type="checkbox" id="pots">POTENSIAL</label>
  <label><span class="dot fung"></span><input type="checkbox" id="fung" checked>FUNGSIONAL</label>
</div>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <div class="loadText" id="loadText">Loading data…</div>
  <div class="loadSub" id="loadSub">Menyiapkan layer PMTiles nasional</div>

  <div class="barWrap" aria-hidden="true">
    <div class="barFill" id="barFill"></div>
  </div>
  <div class="pct" id="pct">0%</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
<script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

<script>
/* === MAP INIT === */
const map = L.map("map",{preferCanvas:true, zoomControl:true}).setView([-2.5,118],5);

/* imagery */
L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {maxZoom:20}
).addTo(map);

/* === GROUPS === */
const groups = {
  BAKU: L.layerGroup(),
  POTENSIAL: L.layerGroup(),
  FUNGSIONAL: L.layerGroup().addTo(map) // default ON
};

function fillColor(cat){
  if(cat==="BAKU") return "rgba(59,130,246,.35)";
  if(cat==="POTENSIAL") return "rgba(245,158,11,.35)";
  return "rgba(16,185,129,.35)";
}

/* === LOADING UI === */
const loadingEl = document.getElementById("loading");
const loadTextEl = document.getElementById("loadText");
const loadSubEl  = document.getElementById("loadSub");
const barFillEl  = document.getElementById("barFill");
const pctEl      = document.getElementById("pct");

function setProgress(done, total){
  const pct = total ? Math.round((done/total)*100) : 0;
  barFillEl.style.width = pct + "%";
  pctEl.textContent = pct + "%";
  loadSubEl.textContent = `Memuat ${done} dari ${total} layer`;
}

/* === STATE === */
let unionBounds = null;
/* minZoom “wajib” untuk kategori yang ON saat awal */
let activeMinZoomRequired = 0; // karena default ON hanya FUNGSIONAL

async function buildRulesAndHeader(url, cat){
  const p = new pmtiles.PMTiles(url);

  // header untuk bounds & minZoom/maxZoom
  const h = await p.getHeader();

  // metadata untuk vector_layers
  const m = await p.getMetadata();

  const b = L.latLngBounds([h.minLat, h.minLon], [h.maxLat, h.maxLon]);
  unionBounds = unionBounds ? unionBounds.extend(b) : b;

  // kalau layer ini termasuk yang aktif di awal (FUNGSIONAL), kita pakai minZoom-nya
  if (cat === "FUNGSIONAL") {
    // kalau ada banyak file FUNGSIONAL, ambil yang paling “ketat” (minZoom terbesar)
    activeMinZoomRequired = Math.max(activeMinZoomRequired, h.minZoom || 0);
  }

  const layers = (m && m.vector_layers) ? m.vector_layers.map(v => v.id) : [];
  if(!layers.length) throw new Error("vector_layers kosong: " + url);

  const fill = fillColor(cat);

  // NO OUTLINE: stroke transparan + width 0
  const rules = layers.map(name => ({
    dataLayer: name,
    symbolizer: new protomapsL.PolygonSymbolizer({
      fill,
      stroke: "rgba(0,0,0,0)",
      width: 0
    })
  }));

  return { rules, bounds: b, header: h };
}

/* === LOAD ALL PMTILES === */
async function loadAll(){
  try{
    const res = await fetch("manifest.json?v=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("manifest.json HTTP " + res.status);

    const json  = await res.json();
    const items = Array.isArray(json) ? json : json.layers;
    if(!items || !items.length) throw new Error("manifest kosong / format salah");

    const validItems = items
      .filter(it => it && it.file && it.category)
      .map(it => ({
        file: it.file,
        category: String(it.category).toUpperCase()
      }))
      .filter(it => groups[it.category]);

    const total = validItems.length;
    let done = 0;
    setProgress(done, total);

    // load satu-satu biar progress smooth dan aman di HP
    for(const it of validItems){
      const cat = it.category;
      const file = it.file;

      try{
        const { rules } = await buildRulesAndHeader(file, cat);
        const layer = protomapsL.leafletLayer({
          url: file,
          paintRules: rules,
          labelRules: []
        });
        layer.addTo(groups[cat]);
      }catch(e){
        console.error("Skip:", file, e);
      }finally{
        done++;
        setProgress(done, total);
        loadTextEl.textContent = "Loading data…";
      }
    }

    // === AUTO FIT + AUTO MINZOOM ===
    if(unionBounds){
      map.invalidateSize(true);

      // 1) fitBounds dulu
      map.fitBounds(unionBounds, {padding:[30,30], animate:true});

      // 2) setelah fit selesai, cek zoom hasil fit vs minZoom FUNGSIONAL
      //    (ini kunci biar langsung muncul tanpa user zoom)
      setTimeout(() => {
        const z = map.getZoom();
        const target = Math.max(z, activeMinZoomRequired || 0);

        if (target !== z) {
          // tetap di center yang sama, cuma naikkan zoom ke minZoom yang ada tile-nya
          map.setView(map.getCenter(), target, {animate:true});
        }
      }, 300);
    }

  }catch(e){
    console.error(e);
    loadTextEl.textContent = "Gagal memuat data";
    loadSubEl.textContent = "Cek manifest.json & console";
  }finally{
    // biar 100% kebaca dikit, baru hilang
    setTimeout(() => { loadingEl.style.display = "none"; }, 250);
  }
}

loadAll();

/* === TOGGLE DEFAULT: FUNGSIONAL ON, lainnya OFF === */
baku.checked = false;
pots.checked = false;
fung.checked = true;

// pastikan group BAKU & POTENSIAL tidak tampil di awal
map.removeLayer(groups.BAKU);
map.removeLayer(groups.POTENSIAL);
map.addLayer(groups.FUNGSIONAL);

baku.onchange = () => baku.checked ? map.addLayer(groups.BAKU) : map.removeLayer(groups.BAKU);
pots.onchange = () => pots.checked ? map.addLayer(groups.POTENSIAL) : map.removeLayer(groups.POTENSIAL);
fung.onchange = () => fung.checked ? map.addLayer(groups.FUNGSIONAL) : map.removeLayer(groups.FUNGSIONAL);
</script>
</body>
</html>
