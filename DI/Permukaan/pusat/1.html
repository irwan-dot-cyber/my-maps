<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMTiles Nasional - DI Permukaan</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --headerH: 82px;
      --panelW: min(360px, calc(100vw - 24px));
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1220;}
    #map{
      position:absolute;
      top:var(--headerH);
      left:0; right:0; bottom:0;
    }

    /* ===== HEADER ===== */
    .app-header{
      position:absolute; z-index:12000;
      top:0; left:0; right:0;
      height:var(--headerH);
      background:#0b4ea2; /* biru mirip contoh */
      display:flex; align-items:center;
      padding:10px 14px;
      box-sizing:border-box;
      box-shadow:0 10px 28px rgba(0,0,0,.25);
    }
    .brand{
      display:flex; align-items:center; gap:14px;
      min-width: 320px;
    }
    .brand img{
      height:52px; width:auto;
      display:block;
      border-radius:6px;
      background:transparent;
    }
    .brand .txt{
      line-height:1.12;
      color:#fff;
    }
    .brand .txt .l1{font-weight:900; letter-spacing:.3px; font-size:18px;}
    .brand .txt .l2{font-weight:800; font-size:20px; margin-top:2px;}
    .brand .txt .l3{font-weight:650; font-size:16px; opacity:.95; margin-top:2px;}

    .header-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
      color:#e5e7eb;
      font-weight:700;
      white-space:nowrap;
      user-select:none;
      opacity:.95;
      font-size:13px;
    }

    /* ===== Right panel (filter + legend) ===== */
    .right-panel{
      position:absolute; z-index:11000;
      top: calc(var(--headerH) + 10px);
      right: 10px;
      width: var(--panelW);
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:auto;
    }

    .card{
      background:#0f172ae6;
      color:#e5e7eb;
      border:1px solid #334155;
      border-radius:16px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .filter{
      padding:12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .filter .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .filter .lbl{
      font-size:12px;
      color:#cbd5e1;
      font-weight:800;
      letter-spacing:.2px;
    }
    select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      outline:none;
      font-weight:800;
      font-size:13px;
    }
    .btn{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #334155;
      background:#111c33;
      color:#e5e7eb;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter:brightness(1.07); }

    /* ===== Compact legend (now under filter) ===== */
    .legendbar{
      padding:10px 12px;
      display:flex; gap:12px; align-items:center;
      overflow:auto;
      white-space:nowrap;
    }
    .legendbar label{
      display:flex; align-items:center; gap:8px;
      font-weight:900; font-size:12px;
      letter-spacing:.2px;
      user-select:none;
    }
    .legendbar input{ accent-color:#60a5fa; transform:translateY(1px); }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.baku{background:#3b82f6}
    .dot.pots{background:#f59e0b}
    .dot.fung{background:#22c55e}

    /* ===== Hint text ===== */
    .hint{
      position:absolute; z-index:9998;
      left:50%; transform:translateX(-50%);
      bottom:16px;
      background:#0b1220e6;
      color:#e5e7eb;
      border:1px solid #334155;
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.28);
      display:none;
      max-width:calc(100vw - 24px);
      text-align:center;
    }

    /* ===== Loading overlay ===== */
    .overlay{
      position:absolute; inset:0; z-index:20000;
      background:rgba(2,6,23,.55);
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(2px);
    }
    .loader{
      width:min(360px, calc(100vw - 40px));
      background:#0f172ae6;
      border:1px solid #334155;
      border-radius:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      padding:18px 16px;
      color:#e5e7eb;
      text-align:center;
    }
    .spinner{
      width:44px; height:44px;
      margin:0 auto 10px auto;
      border-radius:50%;
      border:4px solid rgba(148,163,184,.35);
      border-top-color:#60a5fa;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    .loadtitle{ font-weight:900; font-size:14px; }
    .loadsub{ margin-top:6px; font-size:12px; color:#94a3b8; }
    .pct{ margin-top:10px; font-weight:900; font-size:18px; letter-spacing:.5px; }

    /* Home button style */
    .leaflet-control-home a{
      width:34px; height:34px; line-height:34px;
      text-align:center; display:block;
      background:#fff; color:#111827;
      text-decoration:none;
      font-weight:900;
      border-radius:4px;
    }
    .leaflet-control-home a:hover{ background:#f3f4f6; }

    /* Province label */
    .prov-label{
      color:#fff;
      font-weight:900;
      font-size:13px;
      text-shadow: 0 1px 0 rgba(0,0,0,.55), 0 2px 6px rgba(0,0,0,.55);
      white-space:nowrap;
      pointer-events:none;
    }

    /* Mobile: stack header text smaller */
    @media (max-width:520px){
      :root{ --headerH: 74px; }
      .brand img{ height:46px; }
      .brand .txt .l1{ font-size:14px; }
      .brand .txt .l2{ font-size:16px; }
      .brand .txt .l3{ font-size:13px; }
      .header-right{ display:none; }
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="app-header">
    <div class="brand">
      <!-- Pakai gambar header kamu sendiri kalau mau.
           Ini pakai file image dari repo: taruh misal /assets/logo_pupr.png lalu ganti src -->
      <img src="https://irwan-dot-cyber.github.io/my-maps/assets/LogoPUPR.png" alt="Logo"
           id="logoPUPR" />
      <div class="txt">
        <div class="l1">KEMENTERIAN PEKERJAAN UMUM</div>
        <div class="l2">Direktorat Jenderal Sumber Daya Air</div>
        <div class="l3">Direktorat Irigasi &amp; Rawa</div>
      </div>
    </div>
    <div class="header-right">
      PMTiles Viewer Nasional
    </div>
  </div>

  <div id="map"></div>

  <!-- Right side panel (Filter + Legend) -->
  <div class="right-panel">
    <div class="card filter">
      <div class="lbl">Zoom by BWS / BBWS</div>
      <div class="row">
        <select id="bwsSelect">
          <option value="__NATIONAL__">NASIONAL</option>
        </select>
        <button class="btn" id="btnZoom">Zoom</button>
      </div>
    </div>

    <div class="card legendbar" id="legendbar">
      <label><span class="dot baku"></span><input id="tglBAKU" type="checkbox">BAKU</label>
      <label><span class="dot pots"></span><input id="tglPOTS" type="checkbox">POTENSIAL</label>
      <label><span class="dot fung"></span><input id="tglFUNG" type="checkbox" checked>FUNGSIONAL</label>
    </div>
  </div>

  <!-- Hint -->
  <div class="hint" id="hint">Perbesar peta untuk melihat DI</div>

  <!-- Loading overlay -->
  <div class="overlay" id="overlay">
    <div class="loader">
      <div class="spinner"></div>
      <div class="loadtitle">Loading data…</div>
      <div class="loadsub" id="loadsub">Menyiapkan layer</div>
      <div class="pct" id="pct">0%</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
  <script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

  <script>
    // ==========================
    // MAP INIT
    // ==========================
    const map = L.map("map", { zoomControl:true, preferCanvas:true }).setView([-2.5, 118], 5);

    // Esri World Imagery
    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 20, attribution: "Tiles © Esri" }
    ).addTo(map);

    // ==========================
    // UI refs
    // ==========================
    const overlay = document.getElementById("overlay");
    const pctEl = document.getElementById("pct");
    const loadsub = document.getElementById("loadsub");
    const hint = document.getElementById("hint");

    const tglBAKU = document.getElementById("tglBAKU");
    const tglPOTS = document.getElementById("tglPOTS");
    const tglFUNG = document.getElementById("tglFUNG");

    const bwsSelect = document.getElementById("bwsSelect");
    const btnZoom = document.getElementById("btnZoom");

    // ==========================
    // STATE
    // ==========================
    const state = {
      items: [],
      byCat: { BAKU:[], POTENSIAL:[], FUNGSIONAL:[] },
      active: new Map(),
      adminLine: null,
      adminLineBounds: null,
      provLabels: null,
      unionBounds: null,
      totalToLoad: 0,
      loadedCount: 0,

      // filter index
      bwsIndex: new Map(), // key -> array of items
      bwsBoundsCache: new Map() // key -> LatLngBounds
    };

    function setProgress(text){
      const p = state.totalToLoad ? Math.round((state.loadedCount/state.totalToLoad)*100) : 0;
      pctEl.textContent = Math.min(100, Math.max(0, p)) + "%";
      if (text) loadsub.textContent = text;
    }
    function incProgress(text){
      state.loadedCount++;
      setProgress(text);
    }

    // ==========================
    // HOME BUTTON
    // ==========================
    const HomeControl = L.Control.extend({
      options: { position: "topleft" },
      onAdd: function(){
        const div = L.DomUtil.create("div", "leaflet-control leaflet-control-home");
        const a = L.DomUtil.create("a", "", div);
        a.href = "#";
        a.title = "Home (Fit extent)";
        a.innerHTML = "⌂";
        L.DomEvent.on(a, "click", (e) => {
          L.DomEvent.stop(e);
          fitHome();
        });
        return div;
      }
    });
    map.addControl(new HomeControl());

    function fitHome(){
      const b = state.unionBounds || state.adminLineBounds;
      if (b) map.fitBounds(b, { padding:[30,30] });
      else map.setView([-2.5,118],5);
    }

    // ==========================
    // Hint visibility
    // ==========================
    const DI_HINT_ZOOM = 7;
    function updateHint(){
      hint.style.display = (map.getZoom() < DI_HINT_ZOOM) ? "block" : "none";
    }
    map.on("zoomend", updateHint);
    updateHint();

    // ==========================
    // Manifest helpers
    // ==========================
    function normalizeManifest(json){
      let arr = [];
      if (Array.isArray(json)) arr = json;
      else if (json && Array.isArray(json.layers)) arr = json.layers;
      else if (json && Array.isArray(json.items)) arr = json.items;

      return arr.map((raw, i) => {
        const file = raw.file || raw.path || raw.pmtiles || raw.url || "";
        const title = raw.title || raw.name || file.replace(/\.pmtiles$/i,"");
        const cat = (raw.category || "").toUpperCase();
        const id = raw.id || (i + ":" + file);
        return { id, file, title, category: cat };
      }).filter(x => x.file && /\.pmtiles$/i.test(x.file));
    }

    function bucketByCategory(){
      state.byCat = { BAKU:[], POTENSIAL:[], FUNGSIONAL:[] };
      for (const it of state.items){
        const f = it.file.toUpperCase();
        const cat =
          it.category === "BAKU" || f.includes("_BAKU.PMTILES") ? "BAKU" :
          it.category === "POTENSIAL" || it.category === "POTS" || f.includes("_POTS.PMTILES") ? "POTENSIAL" :
          it.category === "FUNGSIONAL" || it.category === "FUNG" || f.includes("_FUNG.PMTILES") ? "FUNGSIONAL" :
          null;
        if (cat) state.byCat[cat].push({...it, category: cat});
      }
    }

    // Ambil nama "BWS ..." atau "BBWS ..." dari title
    function extractBwsKey(title){
      // contoh title: "Aceh - BWS Sumatera I (FUNGSIONAL)"
      // ambil: "BWS Sumatera I" / "BBWS Cidanau Cijung Cidurian"
      const clean = String(title || "").replace(/\s+/g," ").trim();
      const m = clean.match(/\b(BBWS|BWS)\s+([^\(\)]+?)\s*(?:\(|$)/i);
      if (!m) return null;
      const tipe = m[1].toUpperCase();
      const nama = m[2].trim().replace(/\s+/g," ");
      return `${tipe} ${nama}`;
    }

    function buildBwsIndexAndUI(){
      state.bwsIndex.clear();

      for (const it of state.items){
        const key = extractBwsKey(it.title);
        if (!key) continue;
        if (!state.bwsIndex.has(key)) state.bwsIndex.set(key, []);
        state.bwsIndex.get(key).push(it);
      }

      // isi dropdown
      // simpan pilihan sekarang dulu (biar gak reset tiba-tiba)
      const cur = bwsSelect.value;
      const keys = Array.from(state.bwsIndex.keys()).sort((a,b)=>a.localeCompare(b));

      bwsSelect.innerHTML = `<option value="__NATIONAL__">NASIONAL</option>` +
        keys.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");

      // restore if possible
      if (cur && Array.from(bwsSelect.options).some(o=>o.value===cur)) bwsSelect.value = cur;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[ch]));
    }

    // ==========================
    // PMTiles metadata read
    // ==========================
    async function readPmtilesInfo(url){
      const p = new pmtiles.PMTiles(url);
      const header = await p.getHeader();
      const meta = await p.getMetadata().catch(()=>null);
      const bounds = L.latLngBounds(
        [header.minLat, header.minLon],
        [header.maxLat, header.maxLon]
      );
      const vectorLayers = (meta && meta.vector_layers) ? meta.vector_layers.map(v => v.id) : [];
      return { bounds, vectorLayers, header };
    }

    // ==========================
    // Paint rules (NO polygon outline)
    // ==========================
    function rulesForCategory(vectorLayers, category){
      const fill =
        category === "BAKU" ? "rgba(59,130,246,0.32)" :
        category === "POTENSIAL" ? "rgba(245,158,11,0.30)" :
        "rgba(34,197,94,0.30)";

      return vectorLayers.map(layerName => ({
        dataLayer: layerName,
        symbolizer: new protomapsL.PolygonSymbolizer({
          fill,
          stroke: "rgba(0,0,0,0)",
          width: 0
        })
      }));
    }

    // Admin line (pmtiles) rules
    function rulesForAdminLine(vectorLayers){
      const dash = [8,6,1,6,8,6];
      return vectorLayers.map(layerName => ({
        dataLayer: layerName,
        symbolizer: new protomapsL.LineSymbolizer({
          color: "rgba(255,255,255,0.90)",
          width: 2,
          dash
        })
      }));
    }

    // ==========================
    // Layer add/remove
    // ==========================
    async function addItemLayer(item){
      if (state.active.has(item.id)) return;

      const url = item.file;
      setProgress("Baca: " + item.title);

      const info = await readPmtilesInfo(url);
      const paintRules = rulesForCategory(info.vectorLayers, item.category);

      const layer = protomapsL.leafletLayer({
        url, paintRules, labelRules: []
      });
      layer.addTo(map);

      state.active.set(item.id, { layer, bounds: info.bounds });
      state.unionBounds = state.unionBounds ? state.unionBounds.extend(info.bounds) : info.bounds;
      incProgress("OK: " + item.title);
    }

    function removeItemLayer(item){
      const entry = state.active.get(item.id);
      if (!entry) return;
      map.removeLayer(entry.layer);
      state.active.delete(item.id);
    }

    async function loadMany(items, limit=4){
      const queue = items.slice();
      const workers = Array.from({length: limit}, async () => {
        while(queue.length){
          const it = queue.shift();
          try { await addItemLayer(it); }
          catch(e){ console.error("Fail load:", it.file, e); incProgress("Skip: " + it.title); }
        }
      });
      await Promise.all(workers);
    }

    // ==========================
    // Always-on: Admin line + GeoJSON labels
    // ==========================
    async function loadAdminLine(){
      const url = "Batas_Prov_Line.pmtiles";
      setProgress("Loading batas prov…");

      const info = await readPmtilesInfo(url);
      const paintRules = rulesForAdminLine(info.vectorLayers);

      const layer = protomapsL.leafletLayer({ url, paintRules, labelRules: [] });
      layer.addTo(map);

      state.adminLine = layer;
      state.adminLineBounds = info.bounds;
      state.unionBounds = state.unionBounds ? state.unionBounds.extend(info.bounds) : info.bounds;

      incProgress("Batas prov OK");
    }

    async function loadProvLabelsGeoJSON(){
      const url = "../../Point_Label.geojson";
      setProgress("Loading label prov…");

      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Label geojson HTTP " + res.status);
      const gj = await res.json();

      // de-dup by WADMPR
      const seen = new Set();
      const features = (gj.features || []).filter(f => {
        const n = (f.properties && (f.properties.WADMPR || f.properties.nama || f.properties.NAME)) || "";
        const key = String(n).trim().toLowerCase();
        if(!key) return false;
        if(seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      const layer = L.geoJSON({ type:"FeatureCollection", features }, {
        pointToLayer: (feat, latlng) => {
          const name = (feat.properties && (feat.properties.WADMPR || feat.properties.nama || feat.properties.NAME)) || "";
          const icon = L.divIcon({
            className: "",
            html: `<div class="prov-label">${escapeHtml(name)}</div>`,
            iconSize: null
          });
          return L.marker(latlng, { icon, interactive:false });
        }
      }).addTo(map);

      state.provLabels = layer;
      incProgress("Label prov OK");
    }

    // ==========================
    // Toggle categories
    // ==========================
    function itemsFor(cat){ return state.byCat[cat] || []; }

    async function setCategory(cat, enabled){
      const list = itemsFor(cat);
      if (!list.length) return;

      if (enabled) await loadMany(list, 4);
      else for (const it of list) removeItemLayer(it);
    }

    tglBAKU.addEventListener("change", async () => {
      overlay.style.display = "flex";
      try{
        state.loadedCount = 0;
        state.totalToLoad = itemsFor("BAKU").length || 1;
        setProgress("Toggle BAKU…");
        await setCategory("BAKU", tglBAKU.checked);
      }finally{
        overlay.style.display = "none";
        updateHint();
      }
    });

    tglPOTS.addEventListener("change", async () => {
      overlay.style.display = "flex";
      try{
        state.loadedCount = 0;
        state.totalToLoad = itemsFor("POTENSIAL").length || 1;
        setProgress("Toggle POTENSIAL…");
        await setCategory("POTENSIAL", tglPOTS.checked);
      }finally{
        overlay.style.display = "none";
        updateHint();
      }
    });

    tglFUNG.addEventListener("change", async () => {
      overlay.style.display = "flex";
      try{
        state.loadedCount = 0;
        state.totalToLoad = itemsFor("FUNGSIONAL").length || 1;
        setProgress("Toggle FUNGSIONAL…");
        await setCategory("FUNGSIONAL", tglFUNG.checked);
      }finally{
        overlay.style.display = "none";
        updateHint();
      }
    });

    // ==========================
    // Filter: Zoom by BWS/BBWS
    // ==========================
    async function getBoundsForBwsKey(key){
      if (key === "__NATIONAL__"){
        return state.unionBounds || state.adminLineBounds || null;
      }
      if (state.bwsBoundsCache.has(key)) return state.bwsBoundsCache.get(key);

      const items = state.bwsIndex.get(key) || [];
      if (!items.length) return null;

      // baca header pmtiles untuk semua file terkait key ini
      let b = null;

      // concurrency kecil biar aman
      const queue = items.slice();
      const limit = 4;
      const workers = Array.from({length: limit}, async () => {
        while(queue.length){
          const it = queue.shift();
          try{
            const info = await readPmtilesInfo(it.file);
            b = b ? b.extend(info.bounds) : info.bounds;
          }catch(e){
            console.warn("Skip bounds:", it.file, e);
          }
        }
      });
      await Promise.all(workers);

      if (b) state.bwsBoundsCache.set(key, b);
      return b;
    }

    async function doZoomSelected(){
      const key = bwsSelect.value || "__NATIONAL__";
      overlay.style.display = "flex";
      try{
        state.loadedCount = 0;
        state.totalToLoad = 6; // kecil aja, sekadar animasi
        setProgress("Menentukan extent…");

        const b = await getBoundsForBwsKey(key);
        incProgress("Extent siap");

        if (b){
          map.fitBounds(b, { padding:[40,40] });
        }else{
          // fallback
          fitHome();
        }
      }finally{
        setTimeout(()=> overlay.style.display="none", 200);
        updateHint();
      }
    }

    btnZoom.addEventListener("click", doZoomSelected);
    bwsSelect.addEventListener("change", () => {
      // auto-zoom saat ganti dropdown (lebih enak)
      doZoomSelected();
    });

    // ==========================
    // BOOT
    // ==========================
    async function boot(){
      overlay.style.display = "flex";
      state.loadedCount = 0;

      try{
        setProgress("Baca manifest…");
        const res = await fetch("manifest.json?v=" + Date.now(), { cache:"no-store" });
        if (!res.ok) throw new Error("manifest HTTP " + res.status);
        const json = await res.json();

        state.items = normalizeManifest(json);
        bucketByCategory();
        buildBwsIndexAndUI();

        incProgress("Manifest OK");

        const nF = itemsFor("FUNGSIONAL").length;
        state.totalToLoad = 1 + 1 + 1 + nF;

        await loadAdminLine();
        await loadProvLabelsGeoJSON();

        // Default: FUNGSIONAL ON, lainnya off
        tglFUNG.checked = true;
        tglBAKU.checked = false;
        tglPOTS.checked = false;

        await loadMany(itemsFor("FUNGSIONAL"), 4);

        // Fit nasional
        fitHome();

      }catch(e){
        console.error(e);
        loadsub.textContent = "Gagal load data. Cek console / path file.";
      }finally{
        setTimeout(() => { overlay.style.display = "none"; }, 250);
        updateHint();
      }
    }

    boot();

    // OPTIONAL: kalau kamu punya file logo beneran di repo,
    // ganti src di #logoPUPR (biar gak transparan kosong).
    // contoh:
    // document.getElementById("logoPUPR").src = "../../assets/logo_pupr.png";
  </script>
</body>
</html>
