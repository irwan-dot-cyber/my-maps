<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMTiles Viewer Nasional — Direktorat Irigasi & Rawa</title>

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- PMTiles protocol -->
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

  <style>
    :root{
      --bg:#07101c;
      --panel:#0b1626ee;
      --panel2:#0b1626d8;
      --stroke:#1f334e;
      --text:#eaf2ff;
      --muted:#b6c7e6;
      --brand:#0b4fa3;
      --brand2:#0a3f86;
      --chip:#0f2037;
      --shadow:0 14px 40px rgba(0,0,0,.35);
      --r:16px;
    }
    html,body{height:100%;margin:0;background:#0b1220;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{height:100%;display:flex;flex-direction:column}
    /* HEADER */
    .header{
      height:86px;flex:0 0 auto;
      background:linear-gradient(0deg,var(--brand2),var(--brand));
      display:flex;align-items:center;gap:16px;
      padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.12);
    }
    .logo{
      width:58px;height:58px;border-radius:10px;flex:0 0 auto;
      display:grid;place-items:center;
      background:#0a2f66;
      overflow:hidden;
    }
    .logo svg{width:54px;height:54px}
    .htext{color:#fff;line-height:1.05}
    .htext .l1{font-weight:800;font-size:20px;letter-spacing:.4px}
    .htext .l2{font-weight:800;font-size:24px;margin-top:2px}
    .htext .l3{font-weight:700;font-size:16px;opacity:.95;margin-top:2px}
    .htitle-right{
      margin-left:auto;
      color:#eaf2ff;
      font-weight:700;
      opacity:.9;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    /* MAP */
    #map{height:calc(100vh - 86px);width:100%}

    /* RIGHT PANEL */
    .right{
      position:absolute;right:16px;top:104px;z-index:5;
      width:min(420px, calc(100vw - 32px));
      display:flex;flex-direction:column;gap:12px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .cap{
      padding:14px 16px 10px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
    }
    .row{display:flex;gap:10px;padding:0 16px 16px;align-items:center}
    select,button{
      border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);color:var(--text);
      padding:12px 14px;font-weight:800;font-size:16px;
      outline:none;
    }
    select{flex:1}
    button{cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .legend{
      padding:12px 14px;
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
    }
    .lg{
      display:flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;border-radius:14px;
      color:var(--text);font-weight:900;
      user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .chk{
      width:18px;height:18px;border-radius:6px;
      border:1px solid rgba(255,255,255,.25);
      display:grid;place-items:center;
      background:rgba(0,0,0,.18);
    }
    .chk svg{width:14px;height:14px;display:none}
    .lg.on .chk{background:rgba(255,255,255,.14)}
    .lg.on .chk svg{display:block}
    .help{
      margin:0 16px 14px;
      color:rgba(234,242,255,.85);
      font-weight:700;
      font-size:13px;
      opacity:.9;
    }

    /* LOADING OVERLAY */
    .loading{
      position:absolute;inset:0;z-index:10;
      display:none;align-items:center;justify-content:center;
      backdrop-filter: blur(6px);
      background:rgba(2,8,18,.35);
    }
    .loading.show{display:flex}
    .loadbox{
      background:rgba(9,18,32,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:22px;
      padding:18px 18px 14px;
      width:min(340px, calc(100vw - 40px));
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      text-align:center;color:var(--text);
    }
    .spinner{
      width:46px;height:46px;border-radius:50%;
      border:4px solid rgba(255,255,255,.18);
      border-top-color: rgba(255,255,255,.92);
      animation:spin 1s linear infinite;
      margin:6px auto 10px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .pct{font-weight:900;font-size:18px}
    .sub{margin-top:4px;color:rgba(234,242,255,.78);font-weight:700;font-size:13px}

    /* ZOOM MESSAGE */
    .zoomhint{
      position:absolute;left:50%;top:120px;transform:translateX(-50%);
      z-index:6;
      background:rgba(10,18,34,.92);
      border:1px solid rgba(255,255,255,.14);
      color:rgba(234,242,255,.92);
      padding:10px 14px;border-radius:999px;
      font-weight:900;letter-spacing:.2px;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      display:none;
    }
    .zoomhint.show{display:block}

    /* HOME BUTTON (left under nav) */
    .homeBtn{
      width:34px;height:34px;
      border-radius:8px;
      background:#fff;
      border:1px solid rgba(0,0,0,.2);
      display:grid;place-items:center;
      cursor:pointer;
      margin-top:6px;
    }
    .homeBtn svg{width:18px;height:18px}
    .maplibregl-ctrl-group{box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .maplibregl-popup-content{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      border-radius:14px;
      padding:12px 12px 10px;
    }

    /* Province label style via MapLibre symbol */
    /* (text halo built in style JSON below) */

    @media (max-width: 560px){
      .header{height:auto;flex-wrap:wrap;gap:10px;padding:10px 12px}
      .htitle-right{margin-left:0;width:100%;opacity:.85}
      #map{height:calc(100vh - 118px)}
      .right{left:12px;right:12px;top:132px;width:auto}
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo" aria-hidden="true">
      <!-- simple DI-like mark -->
      <svg viewBox="0 0 64 64" fill="none">
        <rect x="6" y="6" width="52" height="52" rx="10" fill="#0A2F66"/>
        <path d="M18 14h14v36H18V14Z" fill="#F7B500"/>
        <path d="M32 14h14v14H32V14Z" fill="#F7B500"/>
        <path d="M32 32h14v18H32V32Z" fill="#F7B500"/>
      </svg>
    </div>
    <div class="htext">
      <div class="l1">KEMENTERIAN PEKERJAAN UMUM</div>
      <div class="l2">Direktorat Jenderal Sumber Daya Air</div>
      <div class="l3">Direktorat Irigasi &amp; Rawa</div>
    </div>
    <div class="htitle-right">PMTiles Viewer Nasional</div>
  </div>

  <div style="position:relative;flex:1 1 auto;">
    <div id="map"></div>

    <div class="right">
      <div class="card">
        <div class="cap">Zoom by BWS / BBWS</div>
        <div class="row">
          <select id="wsSelect" aria-label="Zoom by BWS / BBWS">
            <option value="NASIONAL">NASIONAL</option>
          </select>
          <button id="wsZoomBtn">Zoom</button>
        </div>
      </div>

      <div class="card">
        <div class="legend" id="legend">
          <div class="lg" data-cat="BAKU" id="lgBAKU">
            <span class="dot" style="background:#3b82f6"></span>
            <span>BAKU</span>
            <span class="chk" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 13l4 4L19 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
          <div class="lg" data-cat="POTENSIAL" id="lgPOTS">
            <span class="dot" style="background:#f59e0b"></span>
            <span>POTENSIAL</span>
            <span class="chk" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 13l4 4L19 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
          <div class="lg on" data-cat="FUNGSIONAL" id="lgFUNG">
            <span class="dot" style="background:#22c55e"></span>
            <span>FUNGSIONAL</span>
            <span class="chk" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M5 13l4 4L19 7" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
          </div>
        </div>
        <div class="help">Label DI muncul mulai zoom <b>10</b> (field: <b>Nm_Inf</b>).</div>
      </div>
    </div>

    <div class="zoomhint" id="zoomHint">Perbesar peta untuk melihat DI</div>

    <div class="loading" id="loading">
      <div class="loadbox">
        <div class="spinner"></div>
        <div class="pct" id="pct">0%</div>
        <div class="sub">Loading data…</div>
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  // ---------------------------
  // PMTiles protocol for MapLibre
  // ---------------------------
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // ---------------------------
  // Helpers
  // ---------------------------
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function stripCategoryFromName(name){
    // "Aceh - BWS Sumatera I (FUNGSIONAL)" -> "BWS Sumatera I"
    // "Banten - BBWS Ciliwung Cisadane (BAKU)" -> "BBWS Ciliwung Cisadane"
    let s = name || "";
    s = s.replace(/\s*\((BAKU|FUNGSIONAL|POTENSIAL)\)\s*$/i, "").trim();
    const parts = s.split(" - ");
    if (parts.length >= 2) return parts.slice(1).join(" - ").trim();
    return s.trim();
  }

  function getCategoryFromFile(file){
    const f = (file||"").toUpperCase();
    if (f.includes("_BAKU")) return "BAKU";
    if (f.includes("_FUNG")) return "FUNGSIONAL";
    if (f.includes("_POTS")) return "POTENSIAL";
    return "OTHER";
  }

  function colorByCat(cat){
    if (cat === "BAKU") return "#3b82f6";
    if (cat === "POTENSIAL") return "#f59e0b";
    return "#22c55e"; // FUNGSIONAL
  }

  // ---------------------------
  // Base Map Style (Esri World Imagery)
  // ---------------------------
  const baseStyle = {
    "version": 8,
    "sources": {
      "esri": {
        "type": "raster",
        "tiles": [
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
        ],
        "tileSize": 256,
        "attribution": "Tiles © Esri"
      }
    },
    "layers": [
      { "id": "esri", "type": "raster", "source": "esri" }
    ]
  };

  // Indonesia-ish default bounds (loose)
  const IND_BOUNDS = [[94.5, -11.5], [141.5, 6.8]]; // [minLng,minLat] [maxLng,maxLat]

  // ---------------------------
  // Create map
  // ---------------------------
  const map = new maplibregl.Map({
    container: "map",
    style: baseStyle,
    center: [118, -2],
    zoom: 4,
    maxZoom: 18
  });

  // Nav control (+/-)
  map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-left");

  // Add HOME button under nav
  class HomeControl {
    onAdd(map){
      this._map = map;
      const container = document.createElement("div");
      container.className = "maplibregl-ctrl maplibregl-ctrl-group";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.title = "Home (Nasional)";
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 10.5L12 4l8 6.5" stroke="#0b1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 10.5V20h10v-9.5" stroke="#0b1220" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      btn.onclick = () => map.fitBounds(IND_BOUNDS, { padding: 60, duration: 650 });
      container.appendChild(btn);
      return container;
    }
    onRemove(){
      this._container?.parentNode?.removeChild(this._container);
      this._map = undefined;
    }
  }
  map.addControl(new HomeControl(), "top-left");

  // UI refs
  const loadingEl = document.getElementById("loading");
  const pctEl = document.getElementById("pct");
  const zoomHintEl = document.getElementById("zoomHint");
  const wsSelect = document.getElementById("wsSelect");
  const wsZoomBtn = document.getElementById("wsZoomBtn");

  // ---------------------------
  // Load manifest.json
  // ---------------------------
  async function fetchJSON(url){
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`Gagal load ${url}: ${r.status}`);
    return await r.json();
  }

  let manifest;
  try {
    manifest = await fetchJSON("manifest.json");
  } catch (e) {
    alert("manifest.json tidak ditemukan di folder yang sama.\nPastikan file manifest.json ada di folder ini.");
    throw e;
  }

  const layers = Array.isArray(manifest.layers) ? manifest.layers : [];
  if (!layers.length){
    alert("manifest.json terbaca tapi 'layers' kosong.");
    return;
  }

  // Group by WS/BBWS name (dropdown)
  const wsMap = new Map(); // key -> { key,label, entries:[{name,file,cat}] }
  for (const it of layers){
    const file = it.file;
    const cat = it.category || getCategoryFromFile(file);
    const wsLabel = stripCategoryFromName(it.name || it.title || file);
    const key = wsLabel || file;
    if (!wsMap.has(key)) wsMap.set(key, { key, label: key, entries: [] });
    wsMap.get(key).entries.push({ ...it, file, cat });
  }

  // Build dropdown (no BAKU/FUNG/POTS)
  const wsList = Array.from(wsMap.values()).sort((a,b)=>a.label.localeCompare(b.label,"id"));
  for (const ws of wsList){
    const opt = document.createElement("option");
    opt.value = ws.key;
    opt.textContent = ws.label;
    wsSelect.appendChild(opt);
  }

  // ---------------------------
  // Add DI sources & layers
  // ---------------------------
  // Track sources for loading %
  const trackedSources = new Set();
  const enabledCats = new Set(["FUNGSIONAL"]); // default ON
  // Use stable IDs
  const srcIdFor = (file) => "src_" + file.replace(/[^a-z0-9]+/gi,"_");
  const fillIdFor = (file) => "fill_" + file.replace(/[^a-z0-9]+/gi,"_");
  const lineIdFor = (file) => "line_" + file.replace(/[^a-z0-9]+/gi,"_");
  const labelIdFor = (file) => "label_" + file.replace(/[^a-z0-9]+/gi,"_");

  // cache header bounds by ws for zoom
  const wsBounds = new Map(); // wsKey -> {bounds:[[minLng,minLat],[maxLng,maxLat]], minZoom,maxZoom}
  async function headerFromFile(file){
    const url = file; // same folder
    const p = new pmtiles.PMTiles(url);
    const h = await p.getHeader();
    return h;
  }

  // Add once style ready
  await new Promise(res => map.once("load", res));

  // 1) Province boundary line (pmtiles) always ON
  //    expects: Batas_Prov_Line.pmtiles in same folder, with a single line layer
  try {
    const provLineFile = "Batas_Prov_Line.pmtiles";
    const provSrcId = "src_prov_line";
    map.addSource(provSrcId, {
      type: "vector",
      tiles: [`pmtiles://${provLineFile}/{z}/{x}/{y}`]
    });
    trackedSources.add(provSrcId);

    map.addLayer({
      id: "prov_line",
      type: "line",
      source: provSrcId,
      "source-layer": "Batas_Prov_Line", // kalau beda, aman: MapLibre akan error; kita fallback di bawah
      paint: {
        "line-color": "#ffffff",
        "line-width": 1.6,
        "line-opacity": 0.95,
        "line-dasharray": [4,2,1,2] // dash dash dot dash dash
      }
    });

    // fallback: kalau source-layer beda, kita coba autodetect via tilejson metadata (tidak selalu ada)
    // jadi: kalau layer tidak tampil, ubah "source-layer" di atas sesuai nama layer vector di pmtiles.
  } catch (e) {
    console.warn("Gagal load batas prov line:", e);
  }

  // 2) Province labels from Point_Label.geojson always ON
  try {
    const labelGeo = await fetchJSON("../Point_Label.geojson").catch(()=>fetchJSON("Point_Label.geojson"));
    map.addSource("prov_points", {
      type: "geojson",
      data: labelGeo
    });

    // try to guess field name for province label
    const props = (labelGeo.features?.[0]?.properties) || {};
    const candidateFields = ["WADMPR","wadmpr","Provinsi","provinsi","NAME","name","NAMA","Nama"];
    const provField = candidateFields.find(k => k in props) || Object.keys(props)[0] || "WADMPR";

    map.addLayer({
      id: "prov_labels",
      type: "symbol",
      source: "prov_points",
      layout: {
        "text-field": ["to-string", ["get", provField]],
        "text-size": [
          "interpolate", ["linear"], ["zoom"],
          4, 10,
          6, 12,
          8, 14
        ],
        "text-font": ["Open Sans Bold","Arial Unicode MS Bold"],
        "text-allow-overlap": false,
        "text-ignore-placement": false,
        "symbol-placement": "point"
      },
      paint: {
        "text-color": "#ffffff",
        "text-halo-color": "rgba(0,0,0,.60)",
        "text-halo-width": 2
      }
    });
  } catch (e) {
    console.warn("Gagal load Point_Label.geojson:", e);
  }

  // 3) Add all DI pmtiles sources + layers (fill + outline + labels @ z>=10)
  //    NOTE: we hide outlines (no border) as requested earlier; keep subtle fill only.
  for (const it of layers){
    const file = it.file;
    const cat = (it.category || getCategoryFromFile(file));
    const srcId = srcIdFor(file);

    // Add source
    if (!map.getSource(srcId)){
      map.addSource(srcId, {
        type: "vector",
        tiles: [`pmtiles://${file}/{z}/{x}/{y}`]
      });
      trackedSources.add(srcId);
    }

    // Determine layer name (source-layer) guess: usually equals file basename without extension
    // BUT on your console you saw layer id like "Aceh_Pusat_-_BWS_Sumatera_I_FUNG"
    // So we set source-layer = basename without ".pmtiles" by default.
    const guessedSourceLayer = file.replace(/\.pmtiles$/i, "");

    // Fill layer
    const fillId = fillIdFor(file);
    if (!map.getLayer(fillId)){
      map.addLayer({
        id: fillId,
        type: "fill",
        source: srcId,
        "source-layer": guessedSourceLayer,
        layout: {
          visibility: enabledCats.has(cat) ? "visible" : "none"
        },
        paint: {
          "fill-color": colorByCat(cat),
          "fill-opacity": 0.45
        }
      });
    }

    // No polygon border (requested: garis pinggir polygon hapus)
    // If you later want thin border: add line layer with opacity low.

    // DI labels only from FUNGSIONAL, field Nm_Inf, minzoom 10
    if (cat === "FUNGSIONAL"){
      const labelId = labelIdFor(file);
      if (!map.getLayer(labelId)){
        map.addLayer({
          id: labelId,
          type: "symbol",
          source: srcId,
          "source-layer": guessedSourceLayer,
          minzoom: 10,
          layout: {
            "text-field": ["to-string", ["get", "Nm_Inf"]],
            "text-size": [
              "interpolate", ["linear"], ["zoom"],
              10, 11,
              12, 13,
              14, 15
            ],
            "text-font": ["Open Sans Bold","Arial Unicode MS Bold"],
            "text-allow-overlap": false,
            "text-ignore-placement": false,
            "symbol-placement": "point"
          },
          paint: {
            "text-color": "#ffffff",
            "text-halo-color": "rgba(0,0,0,.55)",
            "text-halo-width": 2
          }
        });
      }
    }
  }

  // ---------------------------
  // Click popup for DI (any category)
  // ---------------------------
  function buildPopupHTML(props){
    const safe = (v) => (v===null||v===undefined) ? "" : String(v);
    const nm = safe(props.Nm_Inf || props.nm_inf || props.NM_INF || "");
    let html = `<div style="font-weight:900;font-size:14px;margin-bottom:6px">${nm || "Info DI"}</div>`;
    const rows = [
      ["Nama WS", props.Nama_WS],
      ["Nama DAS", props.Nama_DAS],
      ["Tahun Data", props.Thn_Dat],
      ["Status", props.Status],
      ["Jenis DI", props.Jenis_DI],
      ["Irigasi", props.Irigasi],
      ["Provinsi", props.Provinsi]
    ].filter(r => r[1] !== undefined && r[1] !== null && String(r[1]).trim() !== "");
    if (rows.length){
      html += `<div style="font-size:12px;line-height:1.25">`;
      for (const [k,v] of rows){
        html += `<div><b>${k}:</b> ${safe(v)}</div>`;
      }
      html += `</div>`;
    }
    return html;
  }

  // collect all fill layer ids for queryRenderedFeatures
  const allFillLayerIds = layers.map(it => fillIdFor(it.file));

  map.on("click", (e) => {
    const feats = map.queryRenderedFeatures(e.point, { layers: allFillLayerIds });
    if (!feats || !feats.length) return;
    const f = feats[0];
    const props = f.properties || {};
    new maplibregl.Popup({ closeButton: true, closeOnClick: true })
      .setLngLat(e.lngLat)
      .setHTML(buildPopupHTML(props))
      .addTo(map);
  });

  map.on("mousemove", (e) => {
    const feats = map.queryRenderedFeatures(e.point, { layers: allFillLayerIds });
    map.getCanvas().style.cursor = (feats && feats.length) ? "pointer" : "";
  });

  // ---------------------------
  // Legend toggles (category)
  // ---------------------------
  function setCategoryVisibility(cat, visible){
    for (const it of layers){
      const file = it.file;
      const c = (it.category || getCategoryFromFile(file));
      if (c !== cat) continue;
      const fillId = fillIdFor(file);
      if (map.getLayer(fillId)){
        map.setLayoutProperty(fillId, "visibility", visible ? "visible" : "none");
      }
      // label layer only exists for FUNGSIONAL; we let it follow fill visibility implicitly by zoom.
      // If you want labels off when FUNGSIONAL off, we also toggle them:
      if (cat === "FUNGSIONAL"){
        const labelId = labelIdFor(file);
        if (map.getLayer(labelId)){
          map.setLayoutProperty(labelId, "visibility", visible ? "visible" : "none");
        }
      }
    }
  }

  function toggleCat(cat){
    if (enabledCats.has(cat)) enabledCats.delete(cat); else enabledCats.add(cat);
    const isOn = enabledCats.has(cat);
    setCategoryVisibility(cat, isOn);

    document.getElementById(cat==="BAKU" ? "lgBAKU" : cat==="POTENSIAL" ? "lgPOTS" : "lgFUNG")
      .classList.toggle("on", isOn);
  }

  document.getElementById("lgBAKU").onclick = () => toggleCat("BAKU");
  document.getElementById("lgPOTS").onclick = () => toggleCat("POTENSIAL");
  document.getElementById("lgFUNG").onclick = () => toggleCat("FUNGSIONAL");

  // Ensure default visual matches enabledCats
  setCategoryVisibility("BAKU", false);
  setCategoryVisibility("POTENSIAL", false);
  setCategoryVisibility("FUNGSIONAL", true);

  // ---------------------------
  // Zoom hint: show when zoom < 10 (DI labels minzoom 10)
  // ---------------------------
  function updateZoomHint(){
    const z = map.getZoom();
    zoomHintEl.classList.toggle("show", z < 10);
  }
  map.on("zoom", updateZoomHint);
  map.on("load", updateZoomHint);
  updateZoomHint();

  // ---------------------------
  // Zoom by WS/BBWS (dropdown)
  // ---------------------------
  async function computeWsBounds(wsKey){
    if (wsBounds.has(wsKey)) return wsBounds.get(wsKey);
    const ws = wsMap.get(wsKey);
    if (!ws) return null;

    // pilih file untuk bounds: prioritas FUNGSIONAL > BAKU > POTENSIAL
    const pick = (cat) => ws.entries.find(e => (e.category||getCategoryFromFile(e.file)) === cat)?.file;
    const file = pick("FUNGSIONAL") || pick("BAKU") || pick("POTENSIAL") || ws.entries[0]?.file;
    if (!file) return null;

    const h = await headerFromFile(file);
    const b = [[h.minLon, h.minLat],[h.maxLon, h.maxLat]];
    const obj = { bounds: b, minZoom: h.minZoom, maxZoom: h.maxZoom, file };
    wsBounds.set(wsKey, obj);
    return obj;
  }

  wsZoomBtn.onclick = async () => {
    const v = wsSelect.value;
    if (v === "NASIONAL"){
      map.fitBounds(IND_BOUNDS, { padding: 60, duration: 650 });
      return;
    }
    const info = await computeWsBounds(v);
    if (!info) return;
    map.fitBounds(info.bounds, { padding: 70, duration: 650 });
  };

  // ---------------------------
  // Loading spinner + percent (approx based on source loaded state)
  // ---------------------------
  let loadingTimer = null;

  function recomputeLoading(){
    // We consider "loading" if any tracked source not fully loaded
    // MapLibre exposes areTilesLoaded() global; and per-source in events.
    const allLoaded = map.areTilesLoaded();
    if (allLoaded){
      loadingEl.classList.remove("show");
      pctEl.textContent = "100%";
      return;
    }
    loadingEl.classList.add("show");

    // percent estimate: use map._style.sourceCaches if available (best-effort)
    try {
      const caches = map.style && map.style._sourceCaches ? map.style._sourceCaches : null;
      if (!caches){ pctEl.textContent = "…"; return; }

      const ids = Array.from(trackedSources);
      let loaded = 0;
      let total = 0;
      for (const id of ids){
        const c = caches[id];
        if (!c) continue;
        total++;
        if (c.loaded()) loaded++;
      }
      if (total === 0){ pctEl.textContent = "…"; return; }
      const pct = clamp(Math.round((loaded/total)*100), 1, 99);
      pctEl.textContent = pct + "%";
    } catch {
      pctEl.textContent = "…";
    }
  }

  // Throttle updates
  function scheduleLoadingUpdate(){
    if (loadingTimer) return;
    loadingTimer = setTimeout(() => {
      loadingTimer = null;
      recomputeLoading();
    }, 120);
  }

  map.on("dataloading", scheduleLoadingUpdate);
  map.on("data", scheduleLoadingUpdate);
  map.on("render", scheduleLoadingUpdate);

  // initial show
  loadingEl.classList.add("show");
  pctEl.textContent = "1%";
  // hide after a bit when stable
  (async () => {
    for (let i=0;i<120;i++){
      recomputeLoading();
      if (map.areTilesLoaded()){
        await sleep(200);
        recomputeLoading();
        break;
      }
      await sleep(200);
    }
  })();

  // ---------------------------
  // IMPORTANT NOTE (source-layer names)
  // ---------------------------
  // Jika ada layer yang tidak tampil, biasanya karena "source-layer" di PMTiles berbeda dari nama file.
  // Kamu sudah punya cara cek lewat console (FIELDS, Layer ID). Kalau ada kasus begitu, bilang aja,
  // nanti gue bikin versi auto-detect layer name per pmtiles (lebih canggih).
})();
</script>
</body>
</html>
