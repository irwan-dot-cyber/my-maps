<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMTiles Viewer | DI Permukaan (Pusat)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --headerH: 72px;
      --panelW: 440px;
      --primary: #0b4fa3;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: rgba(148, 163, 184, .18);
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{
      position: fixed;
      top: var(--headerH);
      left: 0; right: 0; bottom: 0;
      width: 100%;
      height: calc(100% - var(--headerH));
    }

    /* Header */
    .app-header{
      position: fixed; top:0; left:0; right:0;
      height: var(--headerH);
      background: var(--primary);
      color:#fff;
      z-index: 5000;
      display:flex;
      align-items:center;
      padding:0 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
    .brand{display:flex;align-items:center;gap:14px;width:100%;}
    .brand img{height:44px;width:auto;}
    .brand-text .title{font-weight:700;font-size:14px;letter-spacing:.2px;}
    .brand-text .subtitle{font-size:13px;}
    .brand-text .subsubtitle{font-size:12px;opacity:.88;}

    /* Panel */
    .panel{
      position: fixed;
      top: calc(var(--headerH) + 12px);
      left: 12px;
      width: min(var(--panelW), calc(100vw - 24px));
      background: rgba(15, 23, 42, .92);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      z-index: 4000;
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .panel header{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel header b{font-size:14px;}
    .pill{
      font-size:12px;color:var(--muted);
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);
      background: rgba(2,6,23,.35);
      white-space:nowrap;
    }
    .panel .content{padding:10px 12px;}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;}
    .row label{font-size:12px;color:var(--muted);min-width:92px;}
    select, input[type="text"]{
      width:100%;
      background: rgba(2,6,23,.55);
      color:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
    }
    button{
      background: rgba(2,6,23,.55);
      color:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:9px 10px;
      font-weight:650;
      cursor:pointer;
      white-space:nowrap;
    }
    button:hover{border-color: rgba(148,163,184,.35);}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

    .status{
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      font-size:12px;
      color: var(--muted);
      background: rgba(2,6,23,.35);
    }

    /* Legend toggles */
    .legend{
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: rgba(15, 23, 42, .92);
      color: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      z-index: 4000;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      backdrop-filter: blur(8px);
      min-width: 180px;
    }
    .legend .title{font-size:12px;color:var(--muted);margin-bottom:8px;}
    .legend .item{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:6px 0;font-size:13px;}
    .swatch{width:14px;height:14px;border-radius:4px;display:inline-block;}
    .swatch.baku{background:#20c4d8;}
    .swatch.fung{background:#3cb371;}
    .swatch.pots{background:#f4c430;}
    .left{display:flex;align-items:center;gap:8px;}

    .toggle{
      appearance:none;
      width: 44px; height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(148,163,184,.25);
      position: relative;
      cursor: pointer;
      outline: none;
    }
    .toggle:checked{ background: rgba(59,130,246,.45); }
    .toggle::after{
      content:"";
      width: 18px; height: 18px;
      border-radius: 50%;
      background: #fff;
      position:absolute;
      top: 2px; left: 2px;
      transition: transform .18s ease;
    }
    .toggle:checked::after{ transform: translateX(20px); }
  </style>
</head>

<body>
  <header class="app-header">
    <div class="brand">
      <img src="assets/logo-pupr.png" alt="PUPR" onerror="this.style.display='none'"/>
      <div class="brand-text">
        <div class="title">KEMENTERIAN PEKERJAAN UMUM</div>
        <div class="subtitle">Direktorat Jenderal Sumber Daya Air</div>
        <div class="subsubtitle">Direktorat Irigasi & Rawa</div>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <div class="panel">
    <header>
      <b>ðŸ§© PMTiles Viewer</b>
      <span class="pill" id="pillInfo">Memuatâ€¦</span>
    </header>

    <div class="content">
      <div class="row">
        <label>BWS / BBWS</label>
        <select id="bwsSelect">
          <option value="ALL">Semua BWS</option>
        </select>
      </div>

      <div class="row">
        <label>Cari</label>
        <input id="q" type="text" placeholder="ketik nama BWS/BBWS (opsional)"/>
      </div>

      <div class="btnbar">
        <button id="btnZoom">Zoom BWS</button>
        <button id="btnAll">Semua ON</button>
        <button id="btnOff">All OFF</button>
      </div>
    </div>

    <div class="status" id="status">Inisialisasiâ€¦</div>
  </div>

  <div class="legend">
    <div class="title">ON/OFF Status</div>

    <div class="item">
      <div class="left"><span class="swatch baku"></span> BAKU</div>
      <input id="togBAKU" class="toggle" type="checkbox" checked />
    </div>
    <div class="item">
      <div class="left"><span class="swatch fung"></span> FUNGSIONAL</div>
      <input id="togFUNG" class="toggle" type="checkbox" checked />
    </div>
    <div class="item">
      <div class="left"><span class="swatch pots"></span> POTENSIAL</div>
      <input id="togPOTS" class="toggle" type="checkbox" checked />
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
  <script src="https://unpkg.com/protomaps-leaflet@4.0.1/dist/protomaps-leaflet.js"></script>

  <script>
    // =========================
    // 0) ISI LIST FILE PMTILES DI SINI (nama persis seperti di folder /pusat/)
    // =========================
    const PMTILES_FILES = [
      "Aceh_Pusat_-_BWS_Sumatera_I_BAKU.pmtiles",
      "Aceh_Pusat_-_BWS_Sumatera_I_FUNG.pmtiles",
      "Aceh_Pusat_-_BWS_Sumatera_I_POTS.pmtiles",

      "Banten_Pusat_-_BBWS_Cidanau_Ciujung_Cidurian_BAKU.pmtiles",
      "Banten_Pusat_-_BBWS_Cidanau_Ciujung_Cidurian_FUNG.pmtiles",
      "Banten_Pusat_-_BBWS_Cidanau_Ciujung_Cidurian_POTS.pmtiles",

      "Banten_Pusat_-_BBWS_Ciliwung_Cisadane_BAKU.pmtiles",
      "Banten_Pusat_-_BBWS_Ciliwung_Cisadane_FUNG.pmtiles",
      "Banten_Pusat_-_BBWS_Ciliwung_Cisadane_POTS.pmtiles",

      "Bengkulu_Pusat_-_BWS_Sumatera_VII_BAKU.pmtiles",
      "Bengkulu_Pusat_-_BWS_Sumatera_VII_FUNG.pmtiles",
      "Bengkulu_Pusat_-_BWS_Sumatera_VII_POTS.pmtiles",

      "Daerah_Istimewa_Yogyakarta_Pusat_-_BBWS_Serayu_Opak_BAKU.pmtiles",
      "Daerah_Istimewa_Yogyakarta_Pusat_-_BBWS_Serayu_Opak_FUNG.pmtiles"
      // tambah sisanya broâ€¦
    ];

    // =========================
    // CONFIG
    // =========================
    const BASE_PATH = "./";         // pmtiles ada di folder yang sama dengan HTML
    const CACHE_BUST = "v3";        // ganti kalau update file
    const PMTILES_MAXZOOM = 18;

    // =========================
    // UI
    // =========================
    const statusEl = document.getElementById("status");
    const pillInfo = document.getElementById("pillInfo");
    const bwsSelect = document.getElementById("bwsSelect");
    const qEl = document.getElementById("q");

    const togBAKU = document.getElementById("togBAKU");
    const togFUNG = document.getElementById("togFUNG");
    const togPOTS = document.getElementById("togPOTS");

    function setStatus(t){ statusEl.textContent = t; }

    // =========================
    // MAP
    // =========================
    const map = L.map("map", {
      zoomControl: true,
      preferCanvas: true,
      maxZoom: PMTILES_MAXZOOM
    }).setView([-2.5, 118], 5);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: PMTILES_MAXZOOM, attribution: "Tiles Â© Esri" }
    ).addTo(map);

    // =========================
    // PARSING BWS/TYPE from filename
    // filename example:
    // Bengkulu_Pusat_-_BWS_Sumatera_VII_BAKU.pmtiles
    // Banten_Pusat_-_BBWS_Ciliwung_Cisadane_POTS.pmtiles
    // =========================
    function getTypeFromName(name){
      const u = name.toUpperCase();
      if (u.includes("_BAKU")) return "BAKU";
      if (u.includes("_FUNG")) return "FUNG";
      if (u.includes("_POTS")) return "POTS";
      return "OTHER";
    }

    function getBwsFromName(name){
      // ambil bagian setelah "_-_" sampai sebelum "_BAKU/_FUNG/_POTS"
      // contoh: "BWS_Sumatera_VII" atau "BBWS_Ciliwung_Cisadane"
      const core = name.replace(/\.pmtiles$/i, "");
      const m = core.match(/_-_([^]+?)_(BAKU|FUNG|POTS)$/i);
      if (m && m[1]) {
        return m[1].replace(/_/g, " ").trim(); // jadi "BWS Sumatera VII"
      }
      return "LAINNYA";
    }

    function humanTitle(file){
      const prov = file.split("_Pusat_-_")[0].replace(/_/g," ");
      const bws = getBwsFromName(file);
      const t = getTypeFromName(file);
      const typeLabel = (t==="FUNG") ? "FUNGSIONAL" : (t==="POTS") ? "POTENSIAL" : t;
      return `${prov} - ${bws} - ${typeLabel}`;
    }

    function fillByType(type){
      if (type==="BAKU") return "rgba(32,196,216,0.45)";
      if (type==="FUNG") return "rgba(60,179,113,0.45)";
      if (type==="POTS") return "rgba(244,196,48,0.45)";
      return "rgba(32,196,216,0.35)";
    }

    function isTypeEnabled(type){
      if (type==="BAKU") return togBAKU.checked;
      if (type==="FUNG") return togFUNG.checked;
      if (type==="POTS") return togPOTS.checked;
      return true;
    }

    async function readPmtilesInfo(url){
      const p = new pmtiles.PMTiles(url);
      const meta = await p.getMetadata();
      const header = await p.getHeader();

      const bounds = L.latLngBounds(
        [header.minLat, header.minLon],
        [header.maxLat, header.maxLon]
      );

      let vectorLayers = [];
      if (meta) {
        try{
          const j = JSON.parse(new TextDecoder().decode(meta));
          vectorLayers = (j.vector_layers || []).map(v => v.id).filter(Boolean);
        }catch(e){ vectorLayers = []; }
      }
      return { bounds, vectorLayers };
    }

    function polygonOnlyRules(vectorLayers, type){
      const fill = fillByType(type);
      const rules = [];
      for (const layerName of vectorLayers){
        rules.push({
          dataLayer: layerName,
          symbolizer: new protomapsL.PolygonSymbolizer({
            fill,
            stroke: "rgba(0,0,0,0)",
            width: 0
          })
        });
      }
      return rules;
    }

    // =========================
    // Build items
    // =========================
    const items = PMTILES_FILES.map(file => ({
      file,
      title: humanTitle(file),
      bws: getBwsFromName(file),
      type: getTypeFromName(file),
      id: file
    }));

    // groups bws -> items
    const groups = new Map();
    for (const it of items){
      if (!groups.has(it.bws)) groups.set(it.bws, []);
      groups.get(it.bws).push(it);
    }

    // =========================
    // Layers cache
    // =========================
    const layers = new Map();      // id -> {layer, bounds, bws, type}
    const groupBounds = new Map(); // bws -> bounds
    let currentBws = "ALL";

    async function ensureLayer(it){
      if (layers.has(it.id)) return;

      const url = BASE_PATH + it.file + "?v=" + encodeURIComponent(CACHE_BUST);

      const info = await readPmtilesInfo(url);
      const paintRules = polygonOnlyRules(info.vectorLayers, it.type);

      const layer = protomapsL.leafletLayer({
        url,
        paintRules,
        labelRules: []
      });

      layers.set(it.id, { layer, bounds: info.bounds, bws: it.bws, type: it.type });

      const ex = groupBounds.get(it.bws);
      groupBounds.set(it.bws, ex ? ex.extend(info.bounds) : info.bounds);
    }

    function clearMapLayers(){
      for (const v of layers.values()){
        if (map.hasLayer(v.layer)) map.removeLayer(v.layer);
      }
    }

    async function applyView(){
      const q = (qEl.value || "").trim().toLowerCase();

      const list = (currentBws === "ALL") ? items : (groups.get(currentBws) || []);

      // optionally filter by search text (BWS)
      const filtered = q
        ? list.filter(x => x.bws.toLowerCase().includes(q))
        : list;

      setStatus(`Memuatâ€¦ (${filtered.length} file)`);
      // ensure layers exist
      for (const it of filtered){
        try{
          await ensureLayer(it);
        }catch(e){
          console.error("Gagal load:", it.file, e);
        }
      }

      // show/hide based on type toggles and bws selection + q
      clearMapLayers();

      let onCount = 0;
      for (const it of filtered){
        if (!isTypeEnabled(it.type)) continue;
        const v = layers.get(it.id);
        if (!v) continue;
        v.layer.addTo(map);
        onCount++;
      }

      pillInfo.textContent = `${groups.size} BWS â€¢ ON ${onCount}`;
      setStatus(`Tampil: ${currentBws === "ALL" ? "Semua BWS" : currentBws} (ON ${onCount}).`);
    }

    function zoomCurrent(){
      if (currentBws === "ALL"){
        let b = null;
        for (const v of layers.values()){
          if (!isTypeEnabled(v.type)) continue;
          b = b ? b.extend(v.bounds) : v.bounds;
        }
        if (b) map.fitBounds(b, { padding:[30,30] });
        return;
      }
      const gb = groupBounds.get(currentBws);
      if (gb) map.fitBounds(gb, { padding:[30,30] });
    }

    // =========================
    // UI init
    // =========================
    function initDropdown(){
      bwsSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "Semua BWS";
      bwsSelect.appendChild(optAll);

      const bwsList = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b,"id"));
      for (const bws of bwsList){
        const opt = document.createElement("option");
        opt.value = bws;
        opt.textContent = bws;
        bwsSelect.appendChild(opt);
      }
      pillInfo.textContent = `${bwsList.length} BWS`;
    }

    document.getElementById("btnZoom").addEventListener("click", zoomCurrent);
    document.getElementById("btnAll").addEventListener("click", async () => {
      currentBws = "ALL";
      bwsSelect.value = "ALL";
      await applyView();
      zoomCurrent();
    });
    document.getElementById("btnOff").addEventListener("click", () => {
      clearMapLayers();
      setStatus("All OFF.");
      pillInfo.textContent = `${groups.size} BWS â€¢ OFF`;
    });

    bwsSelect.addEventListener("change", async ()=>{
      currentBws = bwsSelect.value;
      await applyView();
      zoomCurrent();
    });

    [togBAKU, togFUNG, togPOTS].forEach(t=>{
      t.addEventListener("change", applyView);
    });

    qEl.addEventListener("input", () => {
      // debounce kecil
      clearTimeout(qEl._t);
      qEl._t = setTimeout(applyView, 200);
    });

    // =========================
    // START: default semua ON
    // =========================
    initDropdown();
    applyView().then(()=>zoomCurrent());
  </script>
</body>
</html>
