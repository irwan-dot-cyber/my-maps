<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS DI Pusat - Aceh & Banten</title>
    
    <script src="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.x/dist/maplibre-gl.css" rel="stylesheet" />
    
    <script src="https://unpkg.com/pmtiles@2.11.0/dist/index.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Legend UI */
        .map-overlay {
            position: absolute;
            bottom: 30px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1;
            min-width: 180px;
            border: 1px solid #ccc;
        }
        .map-overlay h3 { margin: 0 0 12px; font-size: 14px; color: #333; text-transform: uppercase; letter-spacing: 1px; }
        .layer-item { margin-bottom: 10px; display: flex; align-items: center; font-size: 13px; color: #444; cursor: pointer; }
        .layer-item:hover { color: #000; }
        .layer-item input { margin-right: 10px; cursor: pointer; }
        .legend-key {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="map-overlay">
    <h3>Legenda & Layer</h3>
    <div class="layer-item">
        <input type="checkbox" id="layer-baku" checked>
        <span class="legend-key" style="background-color: #00ff00;"></span>
        <label for="layer-baku">Data Baku</label>
    </div>
    <div class="layer-item">
        <input type="checkbox" id="layer-fung" checked>
        <span class="legend-key" style="background-color: #0000ff;"></span>
        <label for="layer-fung">Data Fungsional</label>
    </div>
    <div class="layer-item">
        <input type="checkbox" id="layer-pots" checked>
        <span class="legend-key" style="background-color: #ffff00;"></span>
        <label for="layer-pots">Data Potensial</label>
    </div>
</div>

<script>
    // 1. Perbaikan: Tambah 'new' untuk memperbaiki error TypeError
    const p = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", p.tile);

    // Pastikan URL ini mengarah ke root GitHub Pages kamu
    const BASE_URL = "https://irwan-dot-cyber.github.io/my-maps/DI/Permukaan/pusat/";

    const map = maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'esri-imagery': {
                    'type': 'raster',
                    'tiles': ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                    'tileSize': 256,
                    'attribution': 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }
            },
            layers: [
                { 'id': 'basemap', 'type': 'raster', 'source': 'esri-imagery' }
            ]
        },
        center: [96.7, 4.4], // Fokus awal ke Aceh
        zoom: 7
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    map.on('load', () => {
        // --- KONFIGURASI DATA ---
        const layersConfig = [
            { id: 'baku', file: 'Aceh_Pusat_-_BWS_Sumatera_I_BAKU.pmtiles', color: '#00ff00' },
            { id: 'fung', file: 'Aceh_Pusat_-_BWS_Sumatera_I_FUNG.pmtiles', color: '#0000ff' },
            { id: 'pots', file: 'Aceh_Pusat_-_BWS_Sumatera_I_POTS.pmtiles', color: '#ffff00' }
        ];

        layersConfig.forEach(config => {
            const layerId = `layer-${config.id}-viz`;
            const sourceName = `source-${config.id}`;

            map.addSource(sourceName, {
                type: 'vector',
                url: `pmtiles://${BASE_URL}${config.file}`
            });

            map.addLayer({
                'id': layerId,
                'type': 'fill', // Ganti 'line' jika data anda berupa garis/irigasi
                'source': sourceName,
                'source-layer': config.file.replace('.pmtiles', ''), // Nama layer internal pmtiles
                'paint': {
                    'fill-color': config.color,
                    'fill-opacity': 0.6,
                    'fill-outline-color': '#000'
                }
            });

            // Toggle On/Off
            document.getElementById(`layer-${config.id}`).addEventListener('change', (e) => {
                map.setLayoutProperty(layerId, 'visibility', e.target.checked ? 'visible' : 'none');
            });

            // Fitur Click Popup
            map.on('click', layerId, (e) => {
                const props = e.features[0].properties;
                // Ambil semua data atribut yang ada di pmtiles
                let content = `<div style="padding:5px"><strong>Detail Info:</strong><br><ul>`;
                for (const key in props) {
                    content += `<li><b>${key}:</b> ${props[key]}</li>`;
                }
                content += `</ul></div>`;

                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(content)
                    .addTo(map);
            });

            // Ganti kursor saat hover
            map.on('mouseenter', layerId, () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', layerId, () => map.getCanvas().style.cursor = '');
        });
    });
</script>

</body>
</html>
