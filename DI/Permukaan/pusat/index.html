<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard PMTiles — DI Permukaan (Pusat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(11,18,34,.92); --text:#e5e7eb; --muted:#94a3b8;
      --brand:#0d47a1; --accent:#2563eb; --border:rgba(255,255,255,.12);
      --ok:#10b981; --err:#ef4444; --warn:#f59e0b; --hdrH:72px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .header{
      position:fixed;top:0;left:0;right:0;z-index:999;
      background:var(--brand);
      border-bottom:1px solid rgba(255,255,255,.18);
      height:var(--hdrH);
      display:flex;align-items:center;gap:12px;
      padding:0 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff; overflow:hidden;
    }
    .logo img{width:44px;height:44px;object-fit:contain}
    .hdrText{flex:1;min-width:0}
    .hdrText .t1{font-weight:900;font-size:14px;line-height:1.2;color:#fff}
    .hdrText .t2{font-weight:700;font-size:12px;color:rgba(255,255,255,.9)}
    .hdrText .t3{font-weight:700;font-size:11px;color:rgba(255,255,255,.8)}
    .home{
      background:#fff;color:var(--brand);
      font-weight:900;text-decoration:none;
      padding:8px 14px;border-radius:12px;font-size:12px;white-space:nowrap;
    }
    #map{ position:absolute; top:var(--hdrH); left:0; right:0; bottom:0; }

    .dock{
      position:absolute; left:12px; right:12px; bottom:12px; z-index:1001;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 18px 42px rgba(0,0,0,.35);
      backdrop-filter:blur(8px);
      padding:10px 12px;
      max-height:46vh;
      display:flex; flex-direction:column; gap:8px;
    }
    .dockTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dockTop h2{margin:0;font-size:14px;font-weight:900;display:flex;align-items:center;gap:8px}
    .pill{
      display:inline-block;font-size:11px;font-weight:900;
      padding:2px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(15,23,42,.75);
      color:#e5e7eb; white-space:nowrap;
    }
    .pill.ok{border-color:rgba(16,185,129,.45);background:rgba(16,185,129,.14);color:#bbf7d0}
    .pill.err{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.14);color:#fecaca}
    .pill.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.14);color:#fde68a}

    .btnRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);
      color:#fff; font-weight:900;
      padding:8px 12px; border-radius:999px;
      cursor:pointer; font-size:12px;
    }
    .btn.primary{background:var(--accent);border-color:rgba(37,99,235,.35)}
    .btn:hover{background:rgba(255,255,255,.14)}
    .btn.primary:hover{background:#1d4ed8}

    .list{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.82);
      border-radius:14px;
      overflow:auto; max-height:240px;
    }
    .item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:9px 10px;border-bottom:1px dashed rgba(148,163,184,.22);
      font-size:12px;
    }
    .item:last-child{border-bottom:none}
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .nm{font-weight:800;color:#e5e7eb;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:62vw}
    .errline{font-size:12px;color:#fca5a5;font-weight:800}
    input[type="checkbox"]{width:16px;height:16px;margin:0}
    .note{font-size:11px;color:var(--muted);line-height:1.35}
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">
      <img src="LogoPUPR.png" alt="Logo"
        onerror="const p=this.parentNode; this.remove(); if(p){p.textContent='PU';}">
    </div>
    <div class="hdrText">
      <div class="t1">Kementerian PU</div>
      <div class="t2">Ditjen SDA · Dit. Irigasi & Rawa</div>
      <div class="t3">Dashboard PMTiles (Auto tampil semua)</div>
    </div>
    <a class="home" href="../../../../index.html">Beranda</a>
  </div>

  <div id="map">
    <div class="dock">
      <div class="dockTop">
        <h2>Layer PMTiles (Pusat) <span class="pill" id="pillStatus">Memuat…</span></h2>
        <span class="pill" id="pillBackend" style="display:none"></span>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="btnFitData" type="button">Fit ke Data</button>
        <button class="btn" id="btnFitID" type="button">Fit Indonesia</button>
        <button class="btn" id="btnOnAll" type="button">ON semua</button>
        <button class="btn" id="btnOffAll" type="button">OFF semua</button>
      </div>

      <div class="errline" id="errLine" style="display:none"></div>

      <div class="list" id="layerList">
        <div style="padding:10px;color:#94a3b8;font-size:12px">Memuat manifest.json…</div>
      </div>

      <div class="note">
        Jika muncul error <b>Content-Length / Byte Serving</b>, berarti server tidak mengirim header yang diperlukan untuk PMTiles.
        Pada GitHub Pages normalnya aman, tapi bisa gagal jika URL file kena redirect/proxy atau file tidak tersaji sebagai file statis murni.
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

  <script>
    const IND_BOUNDS = [[94.0,-11.5],[141.0,6.5]];

    const pillStatus = document.getElementById('pillStatus');
    const pillBackend= document.getElementById('pillBackend');
    const errLine    = document.getElementById('errLine');
    const layerListEl= document.getElementById('layerList');

    const btnFitData = document.getElementById('btnFitData');
    const btnFitID   = document.getElementById('btnFitID');
    const btnOnAll   = document.getElementById('btnOnAll');
    const btnOffAll  = document.getElementById('btnOffAll');

    function setPill(el, kind, text){
      el.className = 'pill ' + (kind||'');
      el.textContent = text;
      el.style.display = 'inline-block';
    }
    function setError(msg){
      errLine.style.display = msg ? 'block' : 'none';
      errLine.textContent = msg || '';
      setPill(pillStatus, 'err', 'Error');
    }
    function setOK(){
      errLine.style.display='none';
      setPill(pillStatus, 'ok', 'PMTiles OK');
    }

    // PMTiles protocol
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          esri: {
            type: 'raster',
            tiles: [
              'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            ],
            tileSize: 256,
            attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics'
          }
        },
        layers: [{ id:'basemap', type:'raster', source:'esri' }]
      },
      center: [118.0, -2.2],
      zoom: 4
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch:true }), 'top-left');

    const layersMeta = [];
    let boundsAll = null;

    function unionBounds(a, b){
      if(!a) return b;
      if(!b) return a;
      return [
        Math.min(a[0], b[0]),
        Math.min(a[1], b[1]),
        Math.max(a[2], b[2]),
        Math.max(a[3], b[3]),
      ];
    }
    function validBounds(b){
      if(!b || b.length!==4) return false;
      const [w,s,e,n]=b;
      if(!isFinite(w)||!isFinite(s)||!isFinite(e)||!isFinite(n)) return false;
      if(e<=w || n<=s) return false;
      return true;
    }
    function safeId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }

    async function headCheck(url){
      const r = await fetch(url, { method:'HEAD', cache:'no-store' });
      const cl = r.headers.get('content-length');
      const ar = r.headers.get('accept-ranges'); // biasanya "bytes"
      return { ok:r.ok, status:r.status, contentLength:cl, acceptRanges:ar };
    }

    async function loadManifest(){
      const res = await fetch('./manifest.json?v=' + Date.now(), { cache:'no-store' });
      if(!res.ok) throw new Error('manifest.json tidak ditemukan (HTTP '+res.status+')');
      const json = await res.json();
      return (json.items || []);
    }

    async function firstVectorLayerId(pm){
      const md = await pm.getMetadata();
      const j = md && md.json ? md.json : null;
      const vls = j && Array.isArray(j.vector_layers) ? j.vector_layers : [];
      return (vls[0] && vls[0].id) ? vls[0].id : null;
    }

    function renderList(){
      layerListEl.innerHTML='';
      if(!layersMeta.length){
        layerListEl.innerHTML='<div style="padding:10px;color:#94a3b8;font-size:12px">Tidak ada item di manifest.</div>';
        return;
      }

      for(const meta of layersMeta){
        const row = document.createElement('div');
        row.className='item';

        const left = document.createElement('div');
        left.className='left';

        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.checked=meta.visible;
        cb.addEventListener('change', ()=>{
          meta.visible = cb.checked;
          const v = meta.visible ? 'visible' : 'none';
          map.setLayoutProperty(meta.fillId,'visibility',v);
          map.setLayoutProperty(meta.lineId,'visibility',v);
        });

        const nm = document.createElement('div');
        nm.className='nm';
        nm.textContent = meta.item.title || meta.item.file;

        left.appendChild(cb);
        left.appendChild(nm);

        row.appendChild(left);
        layerListEl.appendChild(row);
      }
    }

    btnOnAll.addEventListener('click', ()=>{
      layersMeta.forEach(m=>{
        m.visible = true;
        map.setLayoutProperty(m.fillId,'visibility','visible');
        map.setLayoutProperty(m.lineId,'visibility','visible');
      });
      renderList();
    });
    btnOffAll.addEventListener('click', ()=>{
      layersMeta.forEach(m=>{
        m.visible = false;
        map.setLayoutProperty(m.fillId,'visibility','none');
        map.setLayoutProperty(m.lineId,'visibility','none');
      });
      renderList();
    });

    btnFitID.addEventListener('click', ()=>{
      map.fitBounds(IND_BOUNDS, { padding: 40, duration: 900 });
    });

    btnFitData.addEventListener('click', ()=>{
      if(validBounds(boundsAll)){
        const b = [[boundsAll[0], boundsAll[1]],[boundsAll[2], boundsAll[3]]];
        map.fitBounds(b, { padding: 60, duration: 900, maxZoom: 10 });
      }else{
        btnFitID.click();
      }
    });

    async function addPM(item){
      const url = new URL(item.file, window.location.href).toString();
      const idBase = safeId(item.file);

      const pm = new pmtiles.PMTiles(url);
      protocol.add(pm);

      const md = await pm.getMetadata();
      if(md && Array.isArray(md.bounds) && validBounds(md.bounds)){
        boundsAll = unionBounds(boundsAll, md.bounds);
      }

      const srcLayer = await firstVectorLayerId(pm) || 'layer0';
      const srcId = 'src_'+idBase;

      map.addSource(srcId, { type:'vector', url:'pmtiles://'+url });

      const fillId = 'fill_'+idBase;
      const lineId = 'line_'+idBase;

      map.addLayer({
        id: fillId,
        type: 'fill',
        source: srcId,
        'source-layer': srcLayer,
        layout: { visibility:'visible' },
        paint: { 'fill-color': '#22c55e', 'fill-opacity': 0.25 }
      });

      map.addLayer({
        id: lineId,
        type: 'line',
        source: srcId,
        'source-layer': srcLayer,
        layout: { visibility:'visible' },
        paint: { 'line-color': '#22c55e', 'line-width': 1.3, 'line-opacity': 0.95 }
      });

      layersMeta.push({ item, visible:true, fillId, lineId });
    }

    map.on('load', async ()=>{
      try{
        setPill(pillStatus, '', 'Memuat…');

        const items = await loadManifest();
        if(!items.length){
          setError('manifest.json terbaca, tapi items kosong.');
          return;
        }

        // cek HEAD content-length + accept-ranges dari file pertama
        const firstUrl = new URL(items[0].file, window.location.href).toString();
        const h = await headCheck(firstUrl);

        const hasCL = !!h.contentLength;
        const hasAR = (h.acceptRanges || '').toLowerCase().includes('bytes');

        if(!hasCL || !hasAR){
          setPill(pillBackend, 'err', 'Byte Serving Gagal');
          setError(
            'Server tidak mengirim header yang dibutuhkan PMTiles (butuh Content-Length + Accept-Ranges: bytes). ' +
            'Ini penyebab data tidak bisa tampil. Pastikan URL PMTiles benar-benar file statis GitHub Pages (bukan redirect).'
          );
          return;
        } else {
          setPill(pillBackend, 'ok', 'Byte Serving OK');
        }

        // load semua
        for(const it of items){
          await addPM(it);
        }

        setOK();
        renderList();
        btnFitData.click();

      }catch(e){
        console.error(e);
        setError(e.message || String(e));
      }
    });
  </script>
</body>
</html>
