<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard PMTiles — DI Permukaan (Pusat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(11,18,34,.92); --text:#e5e7eb; --muted:#94a3b8;
      --brand:#0d47a1; --accent:#2563eb; --border:rgba(255,255,255,.12);
      --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
      --hdrH:72px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .header{
      position:fixed;top:0;left:0;right:0;z-index:999;
      background:var(--brand);
      border-bottom:1px solid rgba(255,255,255,.18);
      height:var(--hdrH);
      display:flex;align-items:center;gap:12px;
      padding:0 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      background:rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;
      overflow:hidden;
    }
    .logo img{width:44px;height:44px;object-fit:contain}
    .hdrText{flex:1;min-width:0}
    .hdrText .t1{font-weight:900;font-size:14px;line-height:1.2;color:#fff}
    .hdrText .t2{font-weight:700;font-size:12px;color:rgba(255,255,255,.9)}
    .hdrText .t3{font-weight:700;font-size:11px;color:rgba(255,255,255,.8)}
    .home{
      background:#fff;color:var(--brand);
      font-weight:900;text-decoration:none;
      padding:8px 14px;border-radius:12px;font-size:12px;
      white-space:nowrap;
    }
    .home:hover{background:#f1f5f9}

    #map{
      position:absolute;
      top:var(--hdrH); left:0; right:0; bottom:0;
    }

    .legend{
      position:absolute; right:14px; top:14px; z-index:1000;
      background:rgba(15,23,42,.92);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      backdrop-filter:blur(6px);
      min-width:160px;
    }
    .legend .row{display:flex;align-items:center;gap:8px;font-size:12px;margin:6px 0}
    .sw{width:12px;height:12px;border-radius:4px;border:1px solid rgba(255,255,255,.6)}
    .sw.baku{background:#22c55e}
    .sw.fung{background:#3b82f6}
    .sw.pots{background:#f59e0b}
    .sw.fallback{background:#a855f7}

    .dock{
      position:absolute; left:12px; right:12px; bottom:12px; z-index:1001;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 18px 42px rgba(0,0,0,.35);
      backdrop-filter:blur(8px);
      padding:10px 12px;
      max-height:46vh;
      display:flex; flex-direction:column; gap:8px;
    }
    .dockTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dockTop h2{margin:0;font-size:14px;font-weight:900;display:flex;align-items:center;gap:8px}
    .pill{
      display:inline-block;
      font-size:11px;font-weight:900;
      padding:2px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(15,23,42,.75);
      color:#e5e7eb;
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(16,185,129,.45);background:rgba(16,185,129,.14);color:#bbf7d0}
    .pill.err{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.14);color:#fecaca}
    .pill.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.14);color:#fde68a}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.10);
      color:#fff;
      font-weight:900;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{background:rgba(255,255,255,.14)}
    .btn.primary{background:var(--accent);border-color:rgba(37,99,235,.35)}
    .btn.primary:hover{background:#1d4ed8}

    .list{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,23,42,.82);
      border-radius:14px;
      overflow:auto;
      max-height:240px;
    }
    .item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:9px 10px;
      border-bottom:1px dashed rgba(148,163,184,.22);
      font-size:12px;
    }
    .item:last-child{border-bottom:none}
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .nm{
      font-weight:800;color:#e5e7eb;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:62vw;
    }
    .tag{
      font-size:11px;font-weight:900;
      padding:2px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.baku{border-color:rgba(34,197,94,.55)}
    .tag.fung{border-color:rgba(59,130,246,.55)}
    .tag.pots{border-color:rgba(245,158,11,.6)}
    .tag.fallback{border-color:rgba(168,85,247,.6)}
    input[type="checkbox"]{width:16px;height:16px;margin:0}
    .note{font-size:11px;color:var(--muted);line-height:1.35}
    .errline{font-size:12px;color:#fca5a5;font-weight:800}
    .warnline{font-size:12px;color:#fde68a;font-weight:800}
  </style>
</head>

<body>
  <div class="header">
    <div class="logo">
      <!-- kalau kamu punya logo di folder lain, ubah path-nya -->
      <img src="LogoPUPR.png" alt="Logo" onerror="this.remove(); this.parentNode.textContent='PU';">
    </div>
    <div class="hdrText">
      <div class="t1">Kementerian PU</div>
      <div class="t2">Ditjen SDA · Dit. Irigasi & Rawa</div>
      <div class="t3">Dashboard PMTiles (Auto tampil semua)</div>
    </div>
    <a class="home" href="../../../../index.html">Beranda</a>
  </div>

  <div id="map">
    <div class="legend">
      <div class="row"><span class="sw baku"></span> BAKU</div>
      <div class="row"><span class="sw fung"></span> Fungsional</div>
      <div class="row"><span class="sw pots"></span> Potensial</div>
      <div class="row"><span class="sw fallback"></span> Fallback</div>
    </div>

    <div class="dock">
      <div class="dockTop">
        <h2>Layer PMTiles (Pusat) <span class="pill" id="pillStatus">Memuat…</span></h2>
        <span class="pill" id="pillRange" style="display:none"></span>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="btnFitData" type="button">Fit ke Data</button>
        <button class="btn" id="btnFitID" type="button">Fit Indonesia</button>
        <button class="btn" id="btnOnAll" type="button">ON semua</button>
        <button class="btn" id="btnOffAll" type="button">OFF semua</button>
        <span class="pill ok" id="pillAll" style="display:none">Semua layer ON</span>
      </div>

      <div class="errline" id="errLine" style="display:none"></div>
      <div class="warnline" id="warnLine" style="display:none"></div>

      <div class="list" id="layerList">
        <div style="padding:10px;color:#94a3b8;font-size:12px">Memuat manifest.json…</div>
      </div>

      <div class="note">
        Wajib: <b>manifest.json</b> 1 folder dengan <b>index.html</b> ini dan semua <b>.pmtiles</b> juga di folder yang sama.
        PMTiles butuh server support <b>HTTP Range</b>. Kalau Range gagal, layer “OK” tapi data tidak akan muncul.
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.6/dist/pmtiles.js"></script>

  <script>
    const TYPE_COLOR = {
      BAKU: '#22c55e',
      FUNG: '#3b82f6',
      FUNGSIONAL: '#3b82f6',
      POTS: '#f59e0b',
      POTENSIAL: '#f59e0b',
      DEFAULT: '#a855f7'
    };

    const IND_BOUNDS = [[94.0,-11.5],[141.0,6.5]]; // [ [W,S], [E,N] ] in lng/lat for maplibre fitBounds

    const pillStatus = document.getElementById('pillStatus');
    const pillRange  = document.getElementById('pillRange');
    const pillAll    = document.getElementById('pillAll');
    const errLine    = document.getElementById('errLine');
    const warnLine   = document.getElementById('warnLine');
    const layerListEl= document.getElementById('layerList');

    const btnFitData = document.getElementById('btnFitData');
    const btnFitID   = document.getElementById('btnFitID');
    const btnOnAll   = document.getElementById('btnOnAll');
    const btnOffAll  = document.getElementById('btnOffAll');

    function setPill(el, kind, text){
      el.className = 'pill ' + (kind||'');
      el.textContent = text;
      el.style.display = 'inline-block';
    }
    function setError(msg){
      errLine.style.display = msg ? 'block' : 'none';
      errLine.textContent = msg || '';
      setPill(pillStatus, 'err', 'Error');
    }
    function setWarn(msg){
      warnLine.style.display = msg ? 'block' : 'none';
      warnLine.textContent = msg || '';
    }
    function setOK(){
      errLine.style.display='none'; errLine.textContent='';
      setPill(pillStatus, 'ok', 'PMTiles OK');
    }

    function tagClass(type){
      const t=(type||'').toUpperCase();
      if(t==='BAKU') return 'baku';
      if(t==='FUNG' || t==='FUNGSIONAL') return 'fung';
      if(t==='POTS' || t==='POTENSIAL') return 'pots';
      return 'fallback';
    }
    function safeId(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }

    // ===== MapLibre init (raster basemap + vector overlays) =====
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          esri: {
            type: 'raster',
            tiles: [
              'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            ],
            tileSize: 256,
            attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics'
          }
        },
        layers: [
          { id:'basemap', type:'raster', source:'esri' }
        ]
      },
      center: [118.0, -2.2],
      zoom: 4
    });

    map.addControl(new maplibregl.NavigationControl({ visualizePitch:true }), 'top-left');

    // ===== Helpers: read PMTiles metadata bounds + vector layer name =====
    function unionBounds(a, b){
      // a/b: [minLon, minLat, maxLon, maxLat]
      if(!a) return b;
      if(!b) return a;
      return [
        Math.min(a[0], b[0]),
        Math.min(a[1], b[1]),
        Math.max(a[2], b[2]),
        Math.max(a[3], b[3]),
      ];
    }
    function validBounds(b){
      if(!b || b.length!==4) return false;
      const [w,s,e,n]=b;
      if(!isFinite(w)||!isFinite(s)||!isFinite(e)||!isFinite(n)) return false;
      if(w===0 && s===0 && e===0 && n===0) return false;
      if(e<=w || n<=s) return false;
      return true;
    }

    async function firstVectorLayerId(pm){
      const md = await pm.getMetadata();
      const j = md && md.json ? md.json : null;
      const vls = j && Array.isArray(j.vector_layers) ? j.vector_layers : [];
      return (vls[0] && vls[0].id) ? vls[0].id : null;
    }

    // ===== Range test (PMTiles needs HTTP Range) =====
    async function rangeTest(url){
      try{
        const r = await fetch(url, { headers: { 'Range': 'bytes=0-31' }});
        // OK is 206 Partial Content. Some servers return 200 and still allow full, but pmtiles REALLY expects range.
        return { ok: (r.status===206), status: r.status };
      }catch(e){
        return { ok:false, status: 0, err: String(e) };
      }
    }

    // ===== Layer registry =====
    const layersMeta = []; // {item, visible, sourceId, fillId, lineId}
    let boundsAll = null;

    function setVisible(meta, visible){
      meta.visible = visible;
      const v = visible ? 'visible' : 'none';
      if(map.getLayer(meta.fillId)) map.setLayoutProperty(meta.fillId,'visibility',v);
      if(map.getLayer(meta.lineId)) map.setLayoutProperty(meta.lineId,'visibility',v);
    }
    function updateAllPill(){
      const allOn = layersMeta.length && layersMeta.every(m=>m.visible);
      pillAll.style.display = allOn ? 'inline-block' : 'none';
    }

    function renderList(){
      layerListEl.innerHTML='';
      if(!layersMeta.length){
        layerListEl.innerHTML='<div style="padding:10px;color:#94a3b8;font-size:12px">Tidak ada item di manifest.</div>';
        return;
      }

      for(const meta of layersMeta){
        const item = meta.item;

        const row = document.createElement('div');
        row.className='item';

        const left = document.createElement('div');
        left.className='left';

        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.checked=meta.visible;
        cb.addEventListener('change', ()=>{
          setVisible(meta, cb.checked);
          updateAllPill();
        });

        const sw = document.createElement('span');
        sw.className='sw '+tagClass(item.type);

        const nm = document.createElement('div');
        nm.className='nm';
        nm.textContent = item.title || item.file;

        left.appendChild(cb);
        left.appendChild(sw);
        left.appendChild(nm);

        const right = document.createElement('div');
        const tag = document.createElement('span');
        tag.className='tag '+tagClass(item.type);
        tag.textContent = (item.type||'Fallback').toUpperCase();
        right.appendChild(tag);

        row.appendChild(left);
        row.appendChild(right);
        layerListEl.appendChild(row);
      }
    }

    btnOnAll.addEventListener('click', ()=>{
      layersMeta.forEach(m=>setVisible(m,true));
      renderList();
      updateAllPill();
    });
    btnOffAll.addEventListener('click', ()=>{
      layersMeta.forEach(m=>setVisible(m,false));
      renderList();
      updateAllPill();
    });

    btnFitID.addEventListener('click', ()=>{
      map.fitBounds(IND_BOUNDS, { padding: 40, duration: 900 });
    });

    btnFitData.addEventListener('click', ()=>{
      if(validBounds(boundsAll)){
        const b = [[boundsAll[0], boundsAll[1]],[boundsAll[2], boundsAll[3]]];
        map.fitBounds(b, { padding: 60, duration: 900, maxZoom: 10 });
      }else{
        map.fitBounds(IND_BOUNDS, { padding: 40, duration: 900 });
      }
    });

    async function loadManifest(){
      const res = await fetch('./manifest.json?v=' + Date.now());
      if(!res.ok) throw new Error('manifest.json tidak ditemukan (HTTP '+res.status+')');
      const json = await res.json();
      return (json.items || []);
    }

    async function addPMTilesLayer(item){
      const url = new URL(item.file, window.location.href).toString();
      const idBase = safeId(item.file);

      const pm = new pmtiles.PMTiles(url);
      protocol.add(pm);

      // metadata bounds (buat fit data)
      const md = await pm.getMetadata();
      if(md && Array.isArray(md.bounds) && validBounds(md.bounds)){
        boundsAll = unionBounds(boundsAll, md.bounds);
      }

      const srcLayer = await firstVectorLayerId(pm) || 'layer0';
      const srcId = 'src_'+idBase;

      map.addSource(srcId, { type:'vector', url:'pmtiles://'+url });

      const color = TYPE_COLOR[(item.type||'').toUpperCase()] || TYPE_COLOR.DEFAULT;
      const fillId = 'fill_'+idBase;
      const lineId = 'line_'+idBase;

      // Fill
      map.addLayer({
        id: fillId,
        type: 'fill',
        source: srcId,
        'source-layer': srcLayer,
        paint: {
          'fill-color': color,
          'fill-opacity': 0.30
        }
      });

      // Outline
      map.addLayer({
        id: lineId,
        type: 'line',
        source: srcId,
        'source-layer': srcLayer,
        paint: {
          'line-color': color,
          'line-width': 1.4,
          'line-opacity': 0.95
        }
      });

      const meta = { item, visible:true, sourceId:srcId, fillId, lineId };
      layersMeta.push(meta);
    }

    map.on('load', async ()=>{
      try{
        setPill(pillStatus, '', 'Memuat…');

        const items = await loadManifest();
        if(!items.length){
          setError('manifest.json terbaca, tapi items kosong.');
          return;
        }

        // Range test 1 file saja (paling pertama) untuk indikator cepat
        const firstUrl = new URL(items[0].file, window.location.href).toString();
        const rt = await rangeTest(firstUrl);
        if(rt.ok){
          setPill(pillRange, 'ok', 'Range OK (206)');
          setWarn('');
        }else{
          setPill(pillRange, 'warn', 'Range GAGAL ('+(rt.status||'?')+')');
          setWarn('Server tidak support HTTP Range. PMTiles bisa “OK” tapi data tidak tampil. (GitHub Pages biasanya OK, tapi kalau lewat proxy/redirect bisa gagal.)');
        }

        // Add all layers
        for(const item of items){
          await addPMTilesLayer(item);
        }

        setOK();
        renderList();
        updateAllPill();

        // Auto fit to data bounds
        if(validBounds(boundsAll)){
          btnFitData.click();
        }else{
          btnFitID.click();
        }

      }catch(e){
        console.error(e);
        setError(e.message || String(e));
      }
    });

    // Debug capture: kalau ada error tile/vector, tampilkan singkat
    map.on('error', (ev)=>{
      if(ev && ev.error){
        console.warn('Map error:', ev.error);
      }
    });
  </script>
</body>
</html>
