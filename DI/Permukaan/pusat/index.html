<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard DI — PMTiles (Pusat)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../../../assets/LogoPUPR.png" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted-2:#94a3b8;
      --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:80px; --radius:12px;
    }
    html, body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text) }

    .header{
      position:fixed; top:0; left:0; right:0; z-index:900;
      background:var(--survey);
      border-bottom:1px solid rgba(255,255,255,.18);
      padding:8px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:44px}
    .header .text{flex:1; color:#fff}
    .header .title{font-weight:800; font-size:13px; line-height:1.3}
    .header .subtitle{font-weight:600; font-size:11px; color:rgba(255,255,255,.9); margin-top:2px}
    .btn-home{
      background:#fff; color:var(--survey);
      font-weight:800; padding:6px 12px;
      border-radius:10px; text-decoration:none; font-size:11px;
      white-space:nowrap;
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{ height:calc(100vh - var(--hdrH)); position:relative; z-index:1; }

    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--panel); border-top:1px solid var(--border);
      max-height:46vh; padding:8px 12px;
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      z-index:950; backdrop-filter:blur(6px);
      display:flex; flex-direction:column; gap:6px;
      transition:max-height .2s ease, padding .2s ease;
    }
    .dock-header{ display:flex; align-items:center; justify-content:space-between; }
    .dock-header h2{ font-size:14px; margin:0; font-weight:900; color:#fff; }
    .dock-toggle{
      background:rgba(15,23,42,.9);
      border:1px solid var(--border);
      border-radius:999px;
      color:#e5e7eb;
      font-size:11px;
      padding:2px 10px;
      cursor:pointer;
    }
    .dock-toggle:hover{background:#111827}
    .dock-body{font-size:12px;}
    .dock.collapsed{ max-height:40px; padding-top:6px; padding-bottom:6px; }
    .dock.collapsed .dock-body{display:none;}

    .row{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .btn{
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      color:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{ background:var(--accent); border-color:rgba(255,255,255,.2); }
    .btn:hover{ filter:brightness(1.08); }

    .status{
      margin-left:auto;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.15);
    }
    .status.ok{ color:#4ade80; }
    .status.err{ color:#f87171; }

    .list{
      margin-top:6px;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      background:rgba(15,23,42,.55);
    }
    .item{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-bottom:1px dashed rgba(148,163,184,.35);
      font-size:12px;
    }
    . ОС item:last-child{border-bottom:none;}
    .swatch{ width:12px; height:12px; border-radius:4px; border:1px solid rgba(255,255,255,.65); }
    .name{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .hint{ font-size:11px; color:var(--muted-2); margin-top:6px; }

    @media(max-width:680px){
      :root{--hdrH:88px}
    }
  </style>
</head>

<body>
  <div class="header">
    <img src="../../../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian PU</div>
      <div class="subtitle">Ditjen SDA · Dit. Irigasi &amp; Rawa</div>
      <div class="subtitle">Dashboard PMTiles (Auto tampil semua)</div>
    </div>
    <a href="../../../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <div id="map"></div>

  <div class="dock" id="dock">
    <div class="dock-header">
      <h2>Layer PMTiles (Pusat)</h2>
      <button id="dockToggle" class="dock-toggle">Ciutkan</button>
    </div>
    <div class="dock-body">
      <div class="row">
        <button class="btn primary" id="btnFitID">Fit Indonesia</button>
        <button class="btn" id="btnOnAll">ON semua</button>
        <button class="btn" id="btnOffAll">OFF semua</button>
        <span id="status" class="status">Memuat manifest.json…</span>
      </div>

      <div class="list" id="layerList">
        <div class="item" style="color:#94a3b8">Menunggu manifest.json…</div>
      </div>

      <div class="hint">
        Catatan: <b>manifest.json harus 1 folder</b> dengan file HTML ini dan semua <code>.pmtiles</code>.
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PMTiles + Protomaps Leaflet -->
  <script src="https://unpkg.com/pmtiles@latest/dist/index.js"></script>
  <script src="https://unpkg.com/protomaps-leaflet@latest/dist/protomaps-leaflet.min.js"></script>

  <script>
  (function(){
    const MANIFEST = "./manifest.json"; // wajib sefolder

    // === Map init
    const map = L.map('map', { zoomControl:true }).setView([-2.5, 118], 5);

    const imagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics' }
    ).addTo(map);

    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'© OpenStreetMap contributors' }
    );

    L.control.layers({ "Imagery": imagery, "OSM": osm }, null, { collapsed:true, position:'topright' }).addTo(map);

    // panes biar urutan rapi
    map.createPane('paneBAKU'); map.getPane('paneBAKU').style.zIndex = 420;
    map.createPane('paneFUNG'); map.getPane('paneFUNG').style.zIndex = 430;
    map.createPane('panePOTS'); map.getPane('panePOTS').style.zIndex = 440;
    map.createPane('paneETC');  map.getPane('paneETC').style.zIndex = 410;

    const $status = document.getElementById('status');
    const $list   = document.getElementById('layerList');
    const $dock   = document.getElementById('dock');
    const $dockToggle = document.getElementById('dockToggle');

    let dockCollapsed = false;
    $dockToggle.addEventListener('click',()=>{
      dockCollapsed = !dockCollapsed;
      $dock.classList.toggle('collapsed', dockCollapsed);
      $dockToggle.textContent = dockCollapsed ? 'Tampilkan' : 'Ciutkan';
    });

    function setStatusOk(msg){
      $status.className = 'status ok';
      $status.textContent = msg;
    }
    function setStatusErr(msg){
      $status.className = 'status err';
      $status.textContent = msg;
    }

    // simpan layer
    const layers = []; // {meta, leafletLayer, checkbox}

    function typeColor(type){
      const t = String(type||'').toUpperCase();
      if(t==='BAKU') return '#22c55e';
      if(t==='FUNG') return '#60a5fa';
      if(t==='POTS') return '#f59e0b';
      return '#a78bfa';
    }

    function paneFor(type){
      const t = String(type||'').toUpperCase();
      if(t==='BAKU') return 'paneBAKU';
      if(t==='FUNG') return 'paneFUNG';
      if(t==='POTS') return 'panePOTS';
      return 'paneETC';
    }

    function paintRulesFor(color){
      // Protomaps: aturan render untuk polygon/line/point sekaligus
      return [
        { symbolizer: new protomapsL.PolygonSymbolizer({ fill: color, opacity: 0.22 }) },
        { symbolizer: new protomapsL.LineSymbolizer({ color: color, width: 2 }) },
        { symbolizer: new protomapsL.CircleSymbolizer({ fill: color, radius: 4, opacity: 0.9 }) }
      ];
    }

    function addOne(item){
      const title = item.title || item.file || 'PMTiles';
      const color = typeColor(item.type);
      const pane  = paneFor(item.type);

      // Leaflet layer dari PMTiles (tanpa addProtocol)
      const lyr = protomapsL.leafletLayer({
        url: "./" + item.file,
        pane: pane,
        paintRules: paintRulesFor(color)
      });

      lyr.addTo(map);

      // UI row
      const row = document.createElement('div');
      row.className = 'item';

      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = color;

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = title;

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.title = 'ON/OFF layer';
      cb.addEventListener('change', ()=>{
        if(cb.checked) map.addLayer(lyr);
        else map.removeLayer(lyr);
      });

      row.appendChild(sw);
      row.appendChild(name);
      row.appendChild(cb);
      $list.appendChild(row);

      layers.push({ meta:item, leafletLayer:lyr, checkbox:cb });
    }

    function fitIndonesia(){
      // bounding box kasar Indonesia
      const bounds = L.latLngBounds(
        L.latLng(-11.2, 94.5),
        L.latLng(  6.5, 141.5)
      );
      map.fitBounds(bounds);
    }

    document.getElementById('btnFitID').addEventListener('click', fitIndonesia);
    document.getElementById('btnOnAll').addEventListener('click', ()=>{
      layers.forEach(o=>{ o.checkbox.checked = true; map.addLayer(o.leafletLayer); });
    });
    document.getElementById('btnOffAll').addEventListener('click', ()=>{
      layers.forEach(o=>{ o.checkbox.checked = false; map.removeLayer(o.leafletLayer); });
    });

    // load manifest + auto tampil semua
    async function boot(){
      try{
        $list.innerHTML = '';
        const res = await fetch(MANIFEST, { cache:'no-store' });
        if(!res.ok) throw new Error('manifest.json tidak terbaca (HTTP ' + res.status + ')');

        const mf = await res.json();
        const items = mf.items || [];
        if(!items.length) throw new Error('manifest.json kosong (items=[])');

        items.forEach(addOne);
        setStatusOk('PMTiles OK · ' + items.length + ' layer tampil');

        // start view
        fitIndonesia();
      }catch(err){
        console.error(err);
        setStatusErr(String(err.message || err));
        $list.innerHTML = '<div class="item" style="color:#fca5a5">Gagal load manifest.json. Pastikan file ada di folder yang sama & JSON valid.</div>';
      }
    }

    boot();
  })();
  </script>
</body>
</html>
