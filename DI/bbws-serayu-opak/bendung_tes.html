<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Preview Bendung ‚Äî Street View Embed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{ --bg:#0b1222; --text:#e5e7eb; --panel:rgba(11,18,34,.92); --border:rgba(255,255,255,.12); --hdrH:64px; --svH:320px; }
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .header{position:fixed;left:0;right:0;top:0;height:var(--hdrH);display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0d47a1;color:#fff;z-index:900}
    .title{font-weight:800;font-size:14px;line-height:1.2}
    .subtitle{font-size:12px;opacity:.9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH) - var(--svH) - 170px)}
    .dock{position:fixed;left:0;right:0;bottom:var(--svH);background:var(--panel);border-top:1px solid var(--border);padding:12px 14px;z-index:950}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .btn{background:#1d5fd1;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#cbd5e1;margin-top:6px}
    .svwrap{position:fixed;left:0;right:0;bottom:0;height:var(--svH);background:#000;border-top:1px solid var(--border);z-index:940;display:grid;grid-template-columns:1fr 320px;gap:10px}
    .svwrap iframe{width:100%;height:100%;border:0}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:12px;padding:10px}
    .small{font-size:12px;color:#cbd5e1}
    .kv{font-size:12px;color:#cbd5e1}
    .kv b{color:#fff}
    @media(max-width:900px){
      #map{height:calc(100vh - var(--hdrH) - var(--svH) - 190px)}
      .svwrap{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div class="title">Preview Bendung</div>
      <div class="subtitle">Klik titik ‚Üí Street View tampil di panel bawah</div>
    </div>
  </div>
  <div class="spacer"></div>

  <div id="map"></div>

  <!-- Panel info -->
  <div class="dock">
    <div class="row">
      <div id="info"><i class="small">Belum ada bendung dipilih.</i></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnSV" class="btn" disabled>üëÅÔ∏è Buka di Street View</button>
        <button id="btnCopy" class="btn" disabled>üîó Copy Link</button>
      </div>
    </div>
    <div class="hint">Data: <code>contoh_bendung.geojson</code> ‚Äî kolom dipakai: <code>NAMA/N_ASET</code>, <code>N_DI</code>, <code>KEWENANGAN</code></div>
  </div>

  <!-- Panel Street View embed + detail ringkas -->
  <div class="svwrap">
    <iframe id="svFrame" title="Street View" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    <div class="card" id="detailCard">
      <div style="font-weight:800;margin-bottom:6px">Detail Bendung</div>
      <div class="kv" id="kvNama"><b>Nama</b>: -</div>
      <div class="kv" id="kvDI"><b>DI</b>: -</div>
      <div class="kv" id="kvKew"><b>Kewenangan</b>: -</div>
      <div class="kv" id="kvKoord"><b>Koordinat</b>: -</div>
      <div class="small" style="margin-top:8px">Gunakan tombol ‚ÄúBuka di Street View‚Äù jika iframe kosong (butuh Google Maps Embed API key).</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ======= KONFIG ======= */
    const DATA_URL = './contoh_bendung.geojson';
    // Opsional: isi API key agar Street View EMBED tampil di iframe (resmi & sesuai ToS)
    const EMBED_API_KEY = ""; // <-- isi kalau ada, contoh: "AIzaSyA..."; kosong = fallback hanya tombol

    /* ======= PETA ======= */
    const map = L.map('map', { preferCanvas:true }).setView([-7.8,110.3], 10);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      attribution:'Tiles ¬© Esri ‚Äî Source: Esri, Maxar'
    }).addTo(map);

    const infoEl = document.getElementById('info');
    const btnSV  = document.getElementById('btnSV');
    const btnCopy= document.getElementById('btnCopy');
    const svFrame= document.getElementById('svFrame');

    const kvNama = document.getElementById('kvNama');
    const kvDI   = document.getElementById('kvDI');
    const kvKew  = document.getElementById('kvKew');
    const kvKoord= document.getElementById('kvKoord');

    let lastSVUrl = null;

    // Link Street View ‚Äúopen in new tab‚Äù (tanpa API key, aman)
    function svLink(lat, lon, heading=0){
      return `https://www.google.com/maps?layer=c&cbll=${lat},${lon}&cbp=12,${heading},0,0,0`;
    }

    // URL embed Street View (butuh Embed API Key)
    function svEmbed(lat, lon, heading=0, pitch=0, fov=80){
      // doc: https://developers.google.com/maps/documentation/embed/embedding-map#street-view
      return `https://www.google.com/maps/embed/v1/streetview?key=${encodeURIComponent(EMBED_API_KEY)}&location=${lat},${lon}&heading=${heading}&pitch=${pitch}&fov=${fov}`;
    }

    function setDetail(props, lat, lon){
      const nama = props?.NAMA && props.NAMA!=="Bendung" ? props.NAMA : (props?.N_ASET || "Bendung");
      const di   = props?.N_DI || "-";
      const kew  = props?.KEWENANGAN || "-";

      infoEl.innerHTML = `
        <div style="font-size:14px"><b>${nama}</b></div>
        <div class="small">DI: ${di} ‚Ä¢ Kewenangan: ${kew}</div>
      `;
      kvNama.innerHTML  = `<b>Nama</b>: ${nama}`;
      kvDI.innerHTML    = `<b>DI</b>: ${di}`;
      kvKew.innerHTML   = `<b>Kewenangan</b>: ${kew}`;
      kvKoord.innerHTML = `<b>Koordinat</b>: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;

      // simpan link SV (tanpa key)
      lastSVUrl = svLink(lat, lon);

      // update iframe kalau ada API key
      if (EMBED_API_KEY && EMBED_API_KEY.trim().length > 0){
        svFrame.src = svEmbed(lat, lon);
      } else {
        svFrame.removeAttribute('src'); // kosongkan biar gak error
      }

      btnSV.disabled   = false;
      btnCopy.disabled = false;
    }

    btnSV.addEventListener('click', () => {
      if(lastSVUrl) window.open(lastSVUrl, '_blank');
    });
    btnCopy.addEventListener('click', async () => {
      if(!lastSVUrl) return;
      try {
        await navigator.clipboard.writeText(lastSVUrl);
        btnCopy.textContent = "‚úÖ Copied!";
        setTimeout(()=> btnCopy.textContent = "üîó Copy Link", 1200);
      } catch (e) {
        alert(lastSVUrl);
      }
    });

    /* ======= LOAD GEOJSON ======= */
    fetch(DATA_URL)
      .then(async r=>{
        if(!r.ok) throw new Error('Gagal memuat GeoJSON');
        const ct=r.headers.get('content-type')||'';
        if(ct.includes('application/json')) return r.json();
        const txt=await r.text(); const s=txt.indexOf('{'), e=txt.lastIndexOf('}');
        return JSON.parse(txt.slice(s,e+1));
      })
      .then(gj=>{
        const feats = (gj && gj.features) ? gj.features : [];
        if(!feats.length){
          infoEl.innerHTML='<span style="color:#fca5a5">Tidak ada fitur di file.</span>';
          return;
        }

        const layer = L.geoJSON(gj, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 7, color:'#0d9488', weight:1.5, fillColor:'#22c55e', fillOpacity:.95
          }),
          onEachFeature: (f, l) => {
            const [lon, lat] = f.geometry.coordinates;
            const p = f.properties || {};
            const nama = p.NAMA && p.NAMA!=="Bendung" ? p.NAMA : (p.N_ASET || "Bendung");
            const di   = p.N_DI || "-";
            const link = svLink(lat, lon);
            l.bindPopup(`
              <div style="font-size:13px">
                <b>${nama}</b><br/>
                <span style="color:#94a3b8">${di}</span><br/>
                ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/>
                <a href="${link}" target="_blank" style="color:#1d5fd1;font-weight:700">üëÅÔ∏è Buka di Street View</a>
              </div>
            `);
            l.on('click', ()=> setDetail(p, lat, lon));
          }
        }).addTo(map);

        try{
          map.fitBounds(layer.getBounds(), { maxZoom: 14 });
        }catch(e){
          const f0 = feats[0]; const [lon,lat]=f0.geometry.coordinates;
          map.setView([lat,lon], 16); setDetail(f0.properties||{}, lat, lon);
        }
      })
      .catch(err=>{
        console.error(err);
        infoEl.innerHTML = '<span style="color:#fca5a5">Gagal memuat <code>contoh_bendung.geojson</code>.</span>';
      });
  });
  </script>
</body>
</html>
