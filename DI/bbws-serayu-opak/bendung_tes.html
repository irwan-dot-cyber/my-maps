<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Preview Bendung ‚Äî Street View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{ --bg:#0b1222; --text:#e5e7eb; --panel:rgba(11,18,34,.92); --border:rgba(255,255,255,.12); --hdrH:64px; }
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .header{position:fixed;left:0;right:0;top:0;height:var(--hdrH);display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0d47a1;color:#fff;z-index:900}
    .title{font-weight:800;font-size:14px;line-height:1.2}
    .subtitle{font-size:12px;opacity:.9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH) - 160px)}
    .dock{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--border);padding:12px 14px;z-index:950}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .btn{background:#1d5fd1;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#cbd5e1;margin-top:6px}
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div class="title">Preview Bendung</div>
      <div class="subtitle">Klik titik ‚Üí buka Google Street View</div>
    </div>
  </div>
  <div class="spacer"></div>

  <div id="map"></div>

  <div class="dock">
    <div class="row">
      <div id="info"><i style="color:#cbd5e1">Belum ada bendung dipilih.</i></div>
      <button id="btnSV" class="btn" disabled>üëÅÔ∏è Lihat Street View</button>
    </div>
    <div class="hint">Data: <code>contoh_bendung.geojson</code> ‚Äî kolom dipakai: <code>N_DI</code>, <code>N_ASET</code>, <code>KEWENANGAN</code></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DATA_URL = './contoh_bendung.geojson';
    const map = L.map('map', { preferCanvas:true }).setView([-7.8,110.3], 10);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      attribution:'Tiles ¬© Esri ‚Äî Source: Esri, Maxar'
    }).addTo(map);

    const infoEl = document.getElementById('info');
    const btnSV  = document.getElementById('btnSV');
    let lastSVUrl = null;

    // ‚úÖ format aman (nggak nyasar ke "Space")
    function svUrl(lat, lon){
      return `https://www.google.com/maps?layer=c&cbll=${lat},${lon}&cbp=11,0,0,0,0`;
    }

    function setDetail(p, lat, lon){
      const nama = p?.NAMA && p.NAMA!=="Bendung" ? p.NAMA : (p?.N_ASET || "Bendung");
      const di   = p?.N_DI || "-";
      const kew  = p?.KEWENANGAN || "-";
      infoEl.innerHTML = `
        <div style="font-size:14px"><b>${nama}</b></div>
        <div style="font-size:12px;color:#cbd5e1">DI: ${di}</div>
        <div style="font-size:12px;color:#cbd5e1">Kewenangan: ${kew}</div>
        <div style="font-size:12px;color:#cbd5e1">Koord: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
      `;
      lastSVUrl = svUrl(lat, lon);
      btnSV.disabled = false;
    }

    btnSV.addEventListener('click', () => {
      if(lastSVUrl) window.open(lastSVUrl, '_blank');
    });

    // Load & render
    fetch(DATA_URL)
      .then(async r=>{
        if(!r.ok) throw new Error('Gagal memuat GeoJSON');
        const ct=r.headers.get('content-type')||'';
        if(ct.includes('application/json')) return r.json();
        const txt=await r.text(); const s=txt.indexOf('{'), e=txt.lastIndexOf('}');
        return JSON.parse(txt.slice(s,e+1));
      })
      .then(gj=>{
        const feats = (gj && gj.features) ? gj.features : [];
        if(!feats.length){ infoEl.innerHTML='<span style="color:#fca5a5">Tidak ada fitur di file.</span>'; return; }

        const layer = L.geoJSON(gj, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 7, color:'#0d9488', weight:1.5, fillColor:'#22c55e', fillOpacity:.95
          }),
          onEachFeature: (f, l) => {
            const [lon, lat] = f.geometry.coordinates;
            const p = f.properties || {};
            const nama = p.NAMA && p.NAMA!=="Bendung" ? p.NAMA : (p.N_ASET || "Bendung");
            const di   = p.N_DI || "-";
            const link = svUrl(lat, lon);
            l.bindPopup(`
              <div style="font-size:13px">
                <b>${nama}</b><br/>
                <span style="color:#94a3b8">${di}</span><br/>
                ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/>
                <a href="${link}" target="_blank" style="color:#1d5fd1;font-weight:700">üëÅÔ∏è Lihat Street View</a>
              </div>
            `);
            l.on('click', ()=> setDetail(p, lat, lon));
          }
        }).addTo(map);

        try{
          map.fitBounds(layer.getBounds(), { maxZoom: 14 });
        }catch(e){
          const f0 = feats[0]; const [lon,lat]=f0.geometry.coordinates;
          map.setView([lat,lon], 16); setDetail(f0.properties||{}, lat, lon);
        }
      })
      .catch(err=>{
        console.error(err);
        infoEl.innerHTML = '<span style="color:#fca5a5">Gagal memuat <code>contoh_bendung.geojson</code>.</span>';
      });
  });
  </script>
</body>
</html>
