<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard DI â€” BBWS Serayu Opak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../assets/LogoPUPR.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted-2:#94a3b8;
      --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:80px; --radius:12px;
    }
    html, body {
      height:100%; margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text)
    }

    /* Header ringkas */
    .header{
      position:fixed; top:0; left:0; right:0; z-index:900;
      background:var(--survey);
      border-bottom:1px solid rgba(255,255,255,.18);
      padding:8px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:44px}
    .header .text{flex:1; color:#fff}
    .header .title{font-weight:800; font-size:13px; line-height:1.3}
    .header .subtitle{font-weight:600; font-size:11px; color:rgba(255,255,255,.9); margin-top:2px}
    .btn-home{
      background:#fff; color:var(--survey);
      font-weight:700; padding:6px 12px;
      border-radius:10px; text-decoration:none; font-size:11px;
      white-space:nowrap;
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH))}

    /* Dock + collapsible */
    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--panel); border-top:1px solid var(--border);
      max-height:46vh; padding:8px 12px;
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      z-index:950; backdrop-filter:blur(6px);
      display:flex; flex-direction:column; gap:6px;
      transition:max-height .2s ease, padding .2s ease;
    }
    .dock-header{
      display:flex; align-items:center; justify-content:space-between;
    }
    .dock-header h2{
      font-size:14px; margin:0; font-weight:800; color:#fff;
    }
    .dock-toggle{
      background:rgba(15,23,42,.9);
      border:1px solid var(--border);
      border-radius:999px;
      color:#e5e7eb;
      font-size:11px;
      padding:2px 10px;
      cursor:pointer;
    }
    .dock-toggle:hover{background:#111827}
    .dock-body{font-size:12px;}
    .dock.collapsed{
      max-height:40px;
      padding-top:6px;
      padding-bottom:6px;
    }
    .dock.collapsed .dock-body{display:none;}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    label{font-size:11px; color:var(--muted)}
    select{
      width:100%; padding:8px 10px; font-size:13px;
      background:rgba(255,255,255,.06); color:#fff;
      border:1px solid var(--border); border-radius:var(--radius);
      outline:none; appearance:none
    }
    option{color:#000; background:#fff}
    .meta{font-size:12px; border-collapse:collapse; width:100%; color:var(--text)}
    .meta td{border-bottom:1px dashed rgba(255,255,255,.08); padding:4px 2px}
    .key{color:var(--muted-2); width:42%}
    .row{
      display:grid; grid-template-columns:1fr auto 1fr auto;
      gap:8px; font-size:12px; color:var(--muted)
    }
    .row b{color:#fff}
    .err{color:#fca5a5; font-size:11px; margin-top:4px}
    .di-label{
      background:rgba(255,255,255,.9);
      border:1px solid #d1d5db;
      padding:2px 6px; border-radius:6px;
      font-size:11px; color:#111
    }
    @media(max-width:680px){
      .grid{grid-template-columns:1fr}
      :root{--hdrH:88px}
    }

    /* Badge */
    .badge-irwan{
      position:fixed; right:12px; bottom:92px; z-index:1200;
      background:rgba(13,71,161,.85);
      border:1px solid rgba(255,255,255,.25);
      color:#fff; font-size:11px; font-weight:700;
      padding:5px 10px; border-radius:10px;
      box-shadow:0 0 10px rgba(13,71,161,.6);
      backdrop-filter:blur(6px);
      animation:glow 2.8s ease-in-out infinite
    }
    .badge-irwan span{color:#FFD700}
    .badge-irwan:hover{transform:scale(1.03); transition:transform .2s ease}
    @keyframes glow{
      0%,100%{box-shadow:0 0 8px rgba(13,71,161,.6)}
      50%{box-shadow:0 0 18px rgba(255,215,0,.8)}
    }

    /* Upload card */
    .upload-card{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.92);
    }
    .upload-card label{
      display:block;
      margin-bottom:4px;
      font-size:11px;
      color:var(--muted);
    }
    .upload-card input[type="file"]{
      width:100%;
      font-size:11px;
      margin-bottom:6px;
      color:var(--muted-2);
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-primary:hover{background:#2563eb}
    #uploadMsg{
      font-size:11px;
      margin-top:4px;
      color:#e5e7eb;
    }

    /* Leaflet custom controls */
    .myloc-btn{
      width:32px;
      height:32px;
      border:none;
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      font-size:16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
    }
    .myloc-btn:hover{background:#111827}

    .layer-legend{
      background:rgba(15,23,42,.95);
      color:#f9fafb;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid rgba(148,163,184,.6);
      font-size:11px;
      min-width:130px;
    }
    .layer-legend-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .layer-legend-title{
      font-weight:700;
    }
    .layer-toggle-btn{
      background:transparent;
      border:1px solid rgba(148,163,184,.8);
      color:#e5e7eb;
      border-radius:999px;
      font-size:10px;
      padding:0 6px;
      cursor:pointer;
    }
    .layer-legend-body .item{
      display:flex;
      align-items:center;
      gap:4px;
      margin:3px 0;
    }
    .layer-legend .swatch{
      width:12px; height:12px;
      border-radius:3px;
      border:1px solid rgba(255,255,255,.7);
    }
    .swatch-di{background:#3388ff}
    .swatch-saluran{background:#10b981}
    .swatch-bendung{background:#f59e0b}
    .layer-legend input[type="checkbox"]{
      margin:0;
      width:12px;
      height:12px;
    }
    .layer-legend.collapsed .layer-legend-body{
      display:none;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian PUPR</div>
      <div class="subtitle">Ditjen SDA Â· Dir. Irigasi &amp; Rawa</div>
      <div class="subtitle">DI Kewenangan <b>BBWS Serayu Opak</b></div>
    </div>
    <a href="../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- DOCK (collapsible) -->
  <div class="dock" id="dock">
    <div class="dock-header">
      <h2>Dashboard Daerah Irigasi</h2>
      <button id="dockToggle" class="dock-toggle">Ciutkan</button>
    </div>
    <div class="dock-body" id="dockBody">
      <div class="grid">
        <div>
          <label>Pilih Daerah Irigasi</label>
          <select id="diSel"><option value="">â€” Semua â€”</option></select>
        </div>
        <div>
          <label>Cluster Informasi (GAS)</label>
          <select id="clusterSel"><option value="__ALL__">â€” Semua â€”</option></select>
        </div>
      </div>
      <div id="msg" class="err"></div>
      <hr style="border:none;border-top:1px solid var(--border);margin:8px 0"/>
      <div id="stats" class="row"></div>
      <div id="detail" style="margin-top:6px;font-size:12px"></div>

      <!-- UPLOAD GEOJSON/JSON -->
      <div class="upload-card">
        <label for="geojsonFile">Upload GeoJSON / JSON â†’ simpan ke Google Drive</label>
        <input type="file" id="geojsonFile" accept=".geojson,.json,application/json"/>
        <button type="button" id="btnUpload" class="btn-primary">Upload &amp; Simpan</button>
        <div id="uploadMsg"></div>
      </div>
    </div>
  </div>

  <!-- BADGE -->
  <div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
    <span>Si-Irwan v1.0</span>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ========= PATH DATA ========= */
    const PATHS = {
      DI: "./LuasBaku_SerayuOpak_3.geojson",
      SALURAN: "./Saluran_SerayuOpak.geojson",
      BENDUNG: "./contoh_bendung.geojson",
    };

    // Fallback contoh bendung bila file belum tersedia
    const BENDUNG_SAMPLE = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nama":"Bendung Papah","Kd_Inf":"SO-0001","sungai":"Opak","heading":120,"pitch":-5,"fov":80},
         "geometry":{"type":"Point","coordinates":[110.4472,-7.9074]}},
        {"type":"Feature","properties":{"nama":"Bendung Progo Hilir","Kd_Inf":"SO-0002","sungai":"Progo","heading":40,"pitch":0,"fov":80},
         "geometry":{"type":"Point","coordinates":[110.2340,-7.6550]}}
      ]
    };

    // GAS (Google Apps Script) â€” integrasi tabel info
    const GAS_URL = "https://script.google.com/macros/s/AKfycbybsLoQu-8S-MlR_kB2989FZV0C-c1gRzUqcIZWBWuYb-_We03B_BShX8Q3AQqWhOTvzg/exec?sheet=SO_Integrasi&t=" + Date.now();

    // URL Web App upload ke Google Drive
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbzmMWkf3M4Hk8clh9tI19ClAcID5xsVpRc_tDVGldJv1JDGsuSDQaaP8kDQTqaqBfb8Mg/exec";

    const diSel       = document.getElementById('diSel');
    const clusterSel  = document.getElementById('clusterSel');
    const statsEl     = document.getElementById('stats');
    const detailEl    = document.getElementById('detail');
    const msgEl       = document.getElementById('msg');
    const uploadInput = document.getElementById('geojsonFile');
    const uploadBtn   = document.getElementById('btnUpload');
    const uploadMsg   = document.getElementById('uploadMsg');
    const dock        = document.getElementById('dock');
    const dockToggle  = document.getElementById('dockToggle');
    const note        = (m)=>msgEl.textContent=m||"";

    // Map
    const map = L.map('map',{preferCanvas:true}).setView([-7.8,110.3],8);

    // Basemaps
    const imagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution:'Tiles Â© Esri â€” Source: Esri, Maxar, Earthstar Geographics' }
    ).addTo(map);

    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'Â© OpenStreetMap contributors' }
    );

    const baseLayers = {
      "Imagery": imagery,
      "OSM": osm
    };

    let layerCtl = L.control.layers(baseLayers, null, { collapsed:true, position:'topright' }).addTo(map);

    // panes
    map.createPane('diPane');      map.getPane('diPane').style.zIndex = 410;
    map.createPane('saluranPane'); map.getPane('saluranPane').style.zIndex = 420;
    map.createPane('bendungPane'); map.getPane('bendungPane').style.zIndex = 430;

    let lookup={},rows=[],groups={},headers=[];
    const labelLayer=L.layerGroup().addTo(map);
    let diLayer,saluranLayer,bendungLayer;
    let diIndex=[];
    let myLocMarker = null;
    let myLocCircle = null;

    const getNamaDI=(o)=>o?.Nama_DI||o?.["Nama Aset"]||o?.["Nama DI"]||o?.nama_infrastruktur||"";
    const addLabel=(latlng,text)=>{
      if(!latlng)return;
      L.tooltip({permanent:true,direction:'center',className:'di-label'})
        .setLatLng(latlng).setContent(text).addTo(labelLayer);
    };

    function buildTable(obj,fields){
      const keys=fields&&fields.length?fields:Object.keys(obj||{});
      const html=(keys||[]).filter(k=>k&&k!=="Kd_Inf").map(k=>{
        const v=obj[k]; if(v==null||v==="")return"";
        return `<tr><td class="key">${k}</td><td>${v}</td></tr>`;
      }).join("");
      return `<table class="meta">${html||'<tr><td>(tidak ada data)</td></tr>'}</table>`;
    }

    function normalizeGas(json){
      if(json&&json.lookup&&json.rows)return json;
      let _rows=Array.isArray(json)?json:(json?.rows||Object.values(json.lookup||{}));
      const _headers=_rows.length?Object.keys(_rows[0]):[];
      return{rows:_rows,headers:_headers,lookup:Object.fromEntries(_rows.map(r=>[r.Kd_Inf,r]))};
    }

    function buildFixedGroups(headers){
      const g={};
      g["__ALL__"]=headers;
      g["Informasi"]=headers.slice(1,14);
      g["Area"]=headers.slice(14,19);
      g["Teknis"]=headers.slice(19,24);
      g["Saluran Primer"]=headers.slice(24,33);
      g["Saluran Sekunder"]=headers.slice(33,40);
      g["Hidrologi"]=headers.slice(40,42);
      g["Organisasi Petani"]=headers.slice(42,45);
      g["Manfaat"]=headers.slice(45,49);
      g["Tanggal Perubahan"]=headers.slice(49,50);
      return g;
    }

    function updateStats(){
      const diCount=diLayer&&map.hasLayer(diLayer)?diLayer.getLayers().length:0;
      const saluranCount=saluranLayer&&map.hasLayer(saluranLayer)?saluranLayer.getLayers().length:0;
      const bendungCount=bendungLayer&&map.hasLayer(bendungLayer)?bendungLayer.getLayers().length:0;
      statsEl.innerHTML=`<span>DI</span><b>${diCount}</b><span>Saluran</span><b>${saluranCount}</b><span>Bendung</span><b>${bendungCount}</b>`;
    }

    function svLink(lat, lng, heading=0, pitch=0, fov=75){
      const q = new URLSearchParams({
        api: 1,
        map_action: 'pano',
        viewpoint: `${lat},${lng}`,
        heading, pitch, fov
      });
      return `https://www.google.com/maps/@?${q.toString()}`;
    }

    /* ============ Dock toggle ============ */
    let dockCollapsed = false;
    dockToggle.addEventListener('click',()=>{
      dockCollapsed = !dockCollapsed;
      dock.classList.toggle('collapsed', dockCollapsed);
      dockToggle.textContent = dockCollapsed ? 'Tampilkan' : 'Ciutkan';
    });

    /* ============ My Location Control (Leaflet) ============ */
    const MyLocationControl = L.Control.extend({
      position: 'topright',
      onAdd: function(map){
        const container = L.DomUtil.create('div','leaflet-bar');
        const btn = L.DomUtil.create('button','myloc-btn',container);
        btn.type='button';
        btn.innerHTML='ðŸ“';
        btn.title='Lokasi saya';
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(btn,'click',function(e){
          if (!navigator.geolocation) {
            note('Browser tidak mendukung geolokasi.');
            return;
          }
          note('Mencari lokasi Anda...');
          navigator.geolocation.getCurrentPosition(
            (pos)=>{
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;
              const acc = pos.coords.accuracy || 0;
              const latlng=[lat,lng];

              if (!myLocMarker) {
                myLocMarker = L.marker(latlng).addTo(map).bindPopup('Lokasi saya');
              } else {
                myLocMarker.setLatLng(latlng);
              }

              if (acc && !isNaN(acc)) {
                if (!myLocCircle) {
                  myLocCircle = L.circle(latlng,{
                    radius:acc,
                    color:'#38bdf8',
                    weight:1,
                    fillOpacity:0.15
                  }).addTo(map);
                } else {
                  myLocCircle.setLatLng(latlng);
                  myLocCircle.setRadius(acc);
                }
              }

              map.setView(latlng, Math.max(map.getZoom(), 15));
              note('');
              if (myLocMarker) myLocMarker.openPopup();
            },
            (err)=>{
              note('Gagal mendapatkan lokasi: ' + err.message);
            },
            { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
          );
        });
        return container;
      }
    });
    map.addControl(new MyLocationControl());

    /* ============ UPLOAD GEOJSON â†’ DRIVE ============ */
    if (uploadBtn) {
      uploadBtn.addEventListener('click', () => {
        uploadMsg.style.color = '#e5e7eb';
        uploadMsg.textContent = '';

        const file = uploadInput.files[0];
        if (!file) {
          uploadMsg.style.color = '#f87171';
          uploadMsg.textContent = 'Pilih dulu file GeoJSON / JSON yang mau diupload.';
          return;
        }

        const reader = new FileReader();
        reader.onload = async (evt) => {
          const content = evt.target.result;
          const bbwsName = 'BBWS Serayu Opak';

          const payload = {
            filename: file.name,
            mimeType: file.type || 'application/json',
            content: content,
            bbwsName: bbwsName
          };

          uploadMsg.textContent = 'Mengunggah & menyimpan ke Drive...';

          try {
            const res = await fetch(UPLOAD_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data = null;
            try { data = JSON.parse(text); } catch (e) {}

            if (!res.ok || !data) {
              uploadMsg.style.color = '#f87171';
              uploadMsg.textContent = 'Upload gagal: ' + (res.statusText || 'respons tidak valid');
              return;
            }

            if (data.ok) {
              uploadMsg.style.color = '#4ade80';
              if (data.webViewLink) {
                uploadMsg.innerHTML = 'Berhasil tersimpan di folder <b>' + (data.folderName || bbwsName) +
                  '</b>. <a href="' + data.webViewLink +
                  '" target="_blank" rel="noopener" style="color:#93c5fd;text-decoration:underline">Buka file</a>';
              } else {
                uploadMsg.textContent = 'Berhasil tersimpan di Google Drive (folder: ' +
                  (data.folderName || bbwsName) + ').';
              }
            } else {
              uploadMsg.style.color = '#f97316';
              uploadMsg.textContent = 'Server balas error: ' + (data.error || 'tidak diketahui');
            }
          } catch (err) {
            uploadMsg.style.color = '#f87171';
            uploadMsg.textContent = 'Gagal menghubungi server upload: ' + err;
          }
        };

        reader.readAsText(file);
      });
    }

    /* ============ LOAD DATA ============ */
    Promise.allSettled([
      fetch(GAS_URL).then(r=>r.json()),
      fetch(PATHS.DI).then(r=>r.json()),
      fetch(PATHS.SALURAN).then(r=>r.json()),
      fetch(PATHS.BENDUNG).then(r=>r.json())
    ]).then(results=>{
      const [gasRes,diRes,salRes,bendungRes]=results;

      if(gasRes.status==='fulfilled'){
        const norm=normalizeGas(gasRes.value);
        lookup=norm.lookup;rows=norm.rows;headers=norm.headers;groups=buildFixedGroups(headers);
        Object.keys(groups).filter(k=>k!=='__ALL__')
          .forEach(k=>clusterSel.insertAdjacentHTML('beforeend',`<option value="${k}">${k}</option>`));
        const diNames=[...new Set(rows.map(r=>getNamaDI(r)).filter(Boolean))].sort();
        diNames.forEach(nm=>diSel.insertAdjacentHTML('beforeend',`<option value="${nm}">${nm}</option>`));
      }

      // DI (polygon)
      if(diRes.status==='fulfilled'){
        const fc={type:'FeatureCollection',features:diRes.value?.features||[]};
        diLayer=L.geoJSON(fc,{
          pane: 'diPane',
          style:()=>({color:'#1d5fd1',weight:1,fillColor:'#3388ff',fillOpacity:0.30}),
          onEachFeature:(f,layer)=>{
            const key=String(f.properties?.Kd_Inf||"").trim();
            const info=lookup[key]||{};
            const title=getNamaDI(info)||key||'DI';
            const center=layer.getBounds().getCenter();
            const lat = center.lat.toFixed(6);
            const lng = center.lng.toFixed(6);
            const svURL = svLink(lat,lng,0,0,75);

            diIndex.push({layer,key,title,nama:title.toLowerCase(),dataObj:info,center});

            const popupHtml = `
              <div style="min-width:220px">
                <div style="font-weight:800;margin-bottom:4px">${title}</div>
                <div style="font-size:12px;color:#64748b;margin-bottom:6px">
                  <div><b>Kd_Inf:</b> ${key||'-'}</div>
                  <div><b>Centroid:</b> ${lat}, ${lng}</div>
                </div>
                <a href="${svURL}" target="_blank" rel="noopener"
                   style="background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Street View DI
                </a>
              </div>
            `;
            layer.bindPopup(popupHtml);

            layer.on('click',()=>{
              renderDetailDI(info,title,key);
              layer.bringToFront();
            });
          }
        }).addTo(map);
        if(layerCtl) layerCtl.addOverlay(diLayer,'DI (Polygon)');
        if(diLayer.getLayers().length){map.fitBounds(diLayer.getBounds());}
      }

      // Saluran (line)
      if(salRes.status==='fulfilled'){
        const fc={type:'FeatureCollection',features:salRes.value?.features||[]};
        saluranLayer=L.geoJSON(fc,{
          pane: 'saluranPane',
          style:()=>({color:'#10b981',weight:2,opacity:.95}),
          onEachFeature:(f,layer)=>{
            const p=f.properties||{};
            const nm = p.nama || p.NAMA || p.NM_SALURAN || p.Name || 'Saluran';
            const kd = p.Kd_Inf || p.KD_INF || '-';
            const center = layer.getBounds().getCenter();
            const lat = center.lat.toFixed(6);
            const lng = center.lng.toFixed(6);
            const svURL = svLink(lat,lng,0,0,75);

            const popupHtml = `
              <div style="min-width:220px">
                <div style="font-weight:800;margin-bottom:4px">${nm}</div>
                <div style="font-size:12px;color:#64748b;margin-bottom:6px">
                  <div><b>Kd_Inf:</b> ${kd}</div>
                  <div><b>Posisi (tengah):</b> ${lat}, ${lng}</div>
                </div>
                <a href="${svURL}" target="_blank" rel="noopener"
                   style="background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Street View saluran
                </a>
              </div>
            `;
            layer.bindPopup(popupHtml);
          }
        }).addTo(map);
        if(layerCtl) layerCtl.addOverlay(saluranLayer,'Saluran (Line)');
        saluranLayer.bringToFront();
      }

      // Bendung (point)
      let bendungData = (bendungRes.status==='fulfilled' && bendungRes.value) ? bendungRes.value : BENDUNG_SAMPLE;
      bendungLayer=L.geoJSON(bendungData,{
        pane:'bendungPane',
        pointToLayer:(feat,latlng)=>L.circleMarker(latlng,{radius:6,weight:2,opacity:1,fillOpacity:.9,color:'#f59e0b',fillColor:'#f59e0b'}),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const nm=p.nama||'Bendung';
          const sungai=p.sungai||'-';
          const kd=p.Kd_Inf||'-';
          const lat = l.getLatLng().lat.toFixed(6);
          const lng = l.getLatLng().lng.toFixed(6);
          const heading = Number(p.heading || 0);
          const pitch = Number(p.pitch || 0);
          const fov = Number(p.fov || 75);
          const svURL = svLink(lat, lng, heading, pitch, fov);
          const gmapsURL = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

          const html = `
            <div style="min-width:220px">
              <div style="font-weight:800;margin-bottom:4px">${nm}</div>
              <div style="font-size:12px;color:#64748b;margin-bottom:6px">
                <div><b>Sungai:</b> ${sungai}</div>
                <div><b>Kd_Inf:</b> ${kd}</div>
                <div><b>Koordinat:</b> ${lat}, ${lng}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <a href="${svURL}" target="_blank" rel="noopener"
                   style="background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Buka Street View
                </a>
                <a href="${gmapsURL}" target="_blank" rel="noopener"
                   style="background:#111827;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Buka di Google Maps
                </a>
              </div>
            </div>
          `;
          l.bindPopup(html);
        }
      }).addTo(map);
      if(layerCtl) layerCtl.addOverlay(bendungLayer,'Bendung (Point)');
      bendungLayer.bringToFront();

      /* ============ Custom Legend + on/off + collapse ============ */
      const LayerLegendControl = L.Control.extend({
        position:'topright',
        onAdd:function(map){
          const container = L.DomUtil.create('div','layer-legend');
          container.innerHTML = `
            <div class="layer-legend-header">
              <span class="layer-legend-title">Layer</span>
              <button type="button" class="layer-toggle-btn">Ciut</button>
            </div>
            <div class="layer-legend-body">
              <div class="item">
                <input type="checkbox" id="chk-di" checked>
                <span class="swatch swatch-di"></span>
                <label for="chk-di">DI (Polygon)</label>
              </div>
              <div class="item">
                <input type="checkbox" id="chk-saluran" checked>
                <span class="swatch swatch-saluran"></span>
                <label for="chk-saluran">Saluran (Line)</label>
              </div>
              <div class="item">
                <input type="checkbox" id="chk-bendung" checked>
                <span class="swatch swatch-bendung"></span>
                <label for="chk-bendung">Bendung (Point)</label>
              </div>
            </div>
          `;
          L.DomEvent.disableClickPropagation(container);

          const chkDi       = container.querySelector('#chk-di');
          const chkSaluran  = container.querySelector('#chk-saluran');
          const chkBendung  = container.querySelector('#chk-bendung');
          const toggleBtn   = container.querySelector('.layer-toggle-btn');
          const body        = container.querySelector('.layer-legend-body');

          if(!diLayer){ chkDi.disabled=true; }
          if(!saluranLayer){ chkSaluran.disabled=true; }
          if(!bendungLayer){ chkBendung.disabled=true; }

          chkDi.addEventListener('change',()=>{
            if(diLayer){
              if(chkDi.checked){ map.addLayer(diLayer); }
              else { map.removeLayer(diLayer); }
              refreshLabelsAndStats();
            }
          });
          chkSaluran.addEventListener('change',()=>{
            if(saluranLayer){
              if(chkSaluran.checked){ map.addLayer(saluranLayer); }
              else { map.removeLayer(saluranLayer); }
              refreshLabelsAndStats();
            }
          });
          chkBendung.addEventListener('change',()=>{
            if(bendungLayer){
              if(chkBendung.checked){ map.addLayer(bendungLayer); }
              else { map.removeLayer(bendungLayer); }
              refreshLabelsAndStats();
            }
          });

          let collapsed=false;
          toggleBtn.addEventListener('click',()=>{
            collapsed=!collapsed;
            if(collapsed){
              container.classList.add('collapsed');
              toggleBtn.textContent='Tampil';
            }else{
              container.classList.remove('collapsed');
              toggleBtn.textContent='Ciut';
            }
          });

          return container;
        }
      });
      map.addControl(new LayerLegendControl());

      refreshLabelsAndStats();
      detailEl.innerHTML='<i style="color:#cbd5e1">Klik poligon DI atau objek di peta untuk lihat popup + Street View. Dock & legend bisa diciutkan.</i>';
    });

    function renderDetailDI(info,title,key){
      const g=clusterSel.value||"__ALL__";
      const table=(lookup[key])
        ?buildTable(info,(g==="__ALL__")?headers:(groups[g]||headers))
        :`<div style="color:#cbd5e1;font-size:12px">Data GAS tidak ditemukan.</div>`;
      detailEl.innerHTML=`<h3 style="margin:4px 0;color:#fff">${title}</h3>
      <div style="font-size:11px;color:#cbd5e1;margin-bottom:4px">Kd_Inf: ${key}</div>${table}`;
    }

    function refreshLabelsAndStats(){
      labelLayer.clearLayers();
      if(diIndex.length && diLayer && map.hasLayer(diLayer) && map.getZoom()>=10){
        diIndex.forEach(o=>addLabel(o.center,o.title));
      }
      updateStats();
    }

    map.on('zoomend',refreshLabelsAndStats);
  });
  </script>
</body>
</html>
