<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard DI — BBWS Serayu Opak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../assets/LogoPUPR.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted-2:#94a3b8;
      --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:88px; --radius:12px;
    }
    html, body {
      height:100%; margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text)
    }

    /* Header */
    .header{
      position:fixed; top:0; left:0; right:0; z-index:900;
      background:var(--survey);
      border-bottom:1px solid rgba(255,255,255,.18);
      padding:10px 16px;
      display:flex; align-items:center; gap:14px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:54px}
    .header .text{flex:1; color:#fff}
    .header .title{font-weight:800; font-size:14px; line-height:1.35}
    .header .subtitle{font-weight:600; font-size:12px; color:rgba(255,255,255,.9); margin-top:4px}
    .btn-home{
      background:#fff; color:var(--survey);
      font-weight:700; padding:8px 14px;
      border-radius:10px; text-decoration:none; font-size:13px
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH))}

    /* Dock */
    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--panel); border-top:1px solid var(--border);
      max-height:46vh; overflow:auto; padding:12px 14px;
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      z-index:950; backdrop-filter:blur(6px)
    }
    .dock h2{font-size:14px; margin:0 0 8px; font-weight:800; color:#fff}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    label{font-size:12px; color:var(--muted)}
    select{
      width:100%; padding:10px 12px; font-size:14px;
      background:rgba(255,255,255,.06); color:#fff;
      border:1px solid var(--border); border-radius:var(--radius);
      outline:none; appearance:none
    }
    option{color:#000; background:#fff}
    .meta{font-size:13px; border-collapse:collapse; width:100%; color:var(--text)}
    .meta td{border-bottom:1px dashed rgba(255,255,255,.08); padding:6px 2px}
    .key{color:var(--muted-2); width:42%}
    .row{
      display:grid; grid-template-columns:1fr auto 1fr auto;
      gap:12px; font-size:13px; color:var(--muted)
    }
    .row b{color:#fff}
    .err{color:#fca5a5; font-size:12px; margin-top:6px}
    .di-label{
      background:rgba(255,255,255,.9);
      border:1px solid #d1d5db;
      padding:2px 6px; border-radius:6px;
      font-size:12px; color:#111
    }
    @media(max-width:680px){
      .grid{grid-template-columns:1fr}
      :root{--hdrH:96px}
    }

    /* Badge */
    .badge-irwan{
      position:fixed; right:12px; bottom:96px; z-index:1200;
      background:rgba(13,71,161,.85);
      border:1px solid rgba(255,255,255,.25);
      color:#fff; font-size:12px; font-weight:700;
      padding:6px 12px; border-radius:10px;
      box-shadow:0 0 10px rgba(13,71,161,.6);
      backdrop-filter:blur(6px);
      animation:glow 2.8s ease-in-out infinite
    }
    .badge-irwan span{color:#FFD700}
    .badge-irwan:hover{transform:scale(1.03); transition:transform .2s ease}
    @keyframes glow{
      0%,100%{box-shadow:0 0 8px rgba(13,71,161,.6)}
      50%{box-shadow:0 0 18px rgba(255,215,0,.8)}
    }

    /* Legend */
    .legend{
      position: fixed; left: 12px; bottom: 148px; z-index: 1200;
      background: rgba(0,0,0,.4); color: #fff; font-size:12px;
      border:1px solid var(--border);
      border-radius:10px; padding:8px 10px;
      backdrop-filter: blur(6px)
    }
    .legend .item{display:flex; align-items:center; gap:8px; margin:4px 0}
    .legend .swatch{
      width:16px; height:16px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,.6)
    }
    .swatch-di{background:#3388ff}
    .swatch-saluran{background:#10b981}
    .swatch-bendung{background:#f59e0b}

    /* Upload card */
    .upload-card{
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.92);
    }
    .upload-card label{
      display:block;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
    }
    .upload-card input[type="file"]{
      width:100%;
      font-size:12px;
      margin-bottom:8px;
      color:var(--muted-2);
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-primary:hover{background:#2563eb}
    #uploadMsg{
      font-size:12px;
      margin-top:4px;
      color:#e5e7eb;
    }

    /* My Location button */
    .loc-btn{
      position:fixed;
      right:14px;
      top:110px;
      z-index:1200;
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.45);
    }
    .loc-btn:hover{background:#111827}
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian Pekerjaan Umum</div>
      <div class="subtitle">Direktorat Jenderal Sumber Daya Air — Direktorat Irigasi dan Rawa</div>
      <div class="subtitle">Daerah Irigasi Kewenangan <b>BBWS Serayu Opak</b></div>
    </div>
    <a href="../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- MY LOCATION BUTTON -->
  <button id="locBtn" class="loc-btn" title="Lokasi saya">◎</button>

  <!-- DOCK -->
  <div class="dock">
    <h2>Dashboard Daerah Irigasi</h2>
    <div class="grid">
      <div>
        <label>Pilih Daerah Irigasi</label>
        <select id="diSel"><option value="">— Semua —</option></select>
      </div>
      <div>
        <label>Cluster Informasi (GAS)</label>
        <select id="clusterSel"><option value="__ALL__">— Semua —</option></select>
      </div>
    </div>
    <div id="msg" class="err"></div>
    <hr style="border:none;border-top:1px solid var(--border);margin:10px 0"/>
    <div id="stats" class="row"></div>
    <div id="detail" style="margin-top:8px"></div>

    <!-- UPLOAD GEOJSON/JSON -->
    <div class="upload-card">
      <label for="geojsonFile">Upload GeoJSON / JSON → simpan ke Google Drive</label>
      <input type="file" id="geojsonFile" accept=".geojson,.json,application/json"/>
      <button type="button" id="btnUpload" class="btn-primary">Upload &amp; Simpan</button>
      <div id="uploadMsg"></div>
    </div>
  </div>

  <!-- LEGEND -->
  <div class="legend">
    <div class="item"><span class="swatch swatch-di"></span> DI (Polygon)</div>
    <div class="item"><span class="swatch swatch-saluran"></span> Saluran (Line)</div>
    <div class="item"><span class="swatch swatch-bendung"></span> Bendung (Point)</div>
  </div>

  <!-- BADGE -->
  <div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
    <span>Si-Irwan v1.0</span>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ========= PATH DATA ========= */
    const PATHS = {
      DI: "./LuasBaku_SerayuOpak_3.geojson",
      SALURAN: "./Saluran_SerayuOpak.geojson",
      BENDUNG: "./contoh_bendung.geojson",
    };

    // Fallback contoh bendung bila file belum tersedia
    const BENDUNG_SAMPLE = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"nama":"Bendung Papah","Kd_Inf":"SO-0001","sungai":"Opak","heading":120,"pitch":-5,"fov":80},
         "geometry":{"type":"Point","coordinates":[110.4472,-7.9074]}},
        {"type":"Feature","properties":{"nama":"Bendung Progo Hilir","Kd_Inf":"SO-0002","sungai":"Progo","heading":40,"pitch":0,"fov":80},
         "geometry":{"type":"Point","coordinates":[110.2340,-7.6550]}}
      ]
    };

    // GAS (Google Apps Script) — integrasi tabel info
    const GAS_URL = "https://script.google.com/macros/s/AKfycbybsLoQu-8S-MlR_kB2989FZV0C-c1gRzUqcIZWBWuYb-_We03B_BShX8Q3AQqWhOTvzg/exec?sheet=SO_Integrasi&t=" + Date.now();

    // URL Web App upload ke Google Drive
    const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbzmMWkf3M4Hk8clh9tI19ClAcID5xsVpRc_tDVGldJv1JDGsuSDQaaP8kDQTqaqBfb8Mg/exec";

    const diSel     = document.getElementById('diSel');
    const clusterSel= document.getElementById('clusterSel');
    const statsEl   = document.getElementById('stats');
    const detailEl  = document.getElementById('detail');
    const msgEl     = document.getElementById('msg');
    const uploadInput = document.getElementById('geojsonFile');
    const uploadBtn   = document.getElementById('btnUpload');
    const uploadMsg   = document.getElementById('uploadMsg');
    const locBtn      = document.getElementById('locBtn');

    const note = (m)=>msgEl.textContent=m||"";

    // Map
    const map = L.map('map',{preferCanvas:true}).setView([-7.8,110.3],8);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      attribution:'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics'
    }).addTo(map);

    // panes
    map.createPane('diPane');      map.getPane('diPane').style.zIndex = 410;
    map.createPane('saluranPane'); map.getPane('saluranPane').style.zIndex = 420;
    map.createPane('bendungPane'); map.getPane('bendungPane').style.zIndex = 430;

    let lookup={},rows=[],groups={},headers=[];
    const labelLayer=L.layerGroup().addTo(map);
    let diLayer,saluranLayer,bendungLayer;
    let diIndex=[],activeKey=null,activeTitle=null;

    const getNamaDI=(o)=>o?.Nama_DI||o?.["Nama Aset"]||o?.["Nama DI"]||o?.nama_infrastruktur||"";
    const addLabel=(latlng,text)=>{
      if(!latlng)return;
      L.tooltip({permanent:true,direction:'center',className:'di-label'})
        .setLatLng(latlng).setContent(text).addTo(labelLayer);
    };

    function buildTable(obj,fields){
      const keys=fields&&fields.length?fields:Object.keys(obj||{});
      const html=(keys||[]).filter(k=>k&&k!=="Kd_Inf").map(k=>{
        const v=obj[k]; if(v==null||v==="")return"";
        return `<tr><td class="key">${k}</td><td>${v}</td></tr>`;
      }).join("");
      return `<table class="meta">${html||'<tr><td>(tidak ada data)</td></tr>'}</table>`;
    }

    function normalizeGas(json){
      if(json&&json.lookup&&json.rows)return json;
      let _rows=Array.isArray(json)?json:(json?.rows||Object.values(json.lookup||{}));
      const _headers=_rows.length?Object.keys(_rows[0]):[];
      return{rows:_rows,headers:_headers,lookup:Object.fromEntries(_rows.map(r=>[r.Kd_Inf,r]))};
    }

    function buildFixedGroups(headers){
      const g={};
      g["__ALL__"]=headers;
      g["Informasi"]=headers.slice(1,14);
      g["Area"]=headers.slice(14,19);
      g["Teknis"]=headers.slice(19,24);
      g["Saluran Primer"]=headers.slice(24,33);
      g["Saluran Sekunder"]=headers.slice(33,40);
      g["Hidrologi"]=headers.slice(40,42);
      g["Organisasi Petani"]=headers.slice(42,45);
      g["Manfaat"]=headers.slice(45,49);
      g["Tanggal Perubahan"]=headers.slice(49,50);
      return g;
    }

    function updateStats(){
      const diCount=diLayer?diLayer.getLayers().length:0;
      const saluranCount=saluranLayer?saluranLayer.getLayers().length:0;
      const bendungCount=bendungLayer?bendungLayer.getLayers().length:0;
      statsEl.innerHTML=`<span>DI</span><b>${diCount}</b><span>Saluran</span><b>${saluranCount}</b><span>Bendung</span><b>${bendungCount}</b>`;
    }

    // Helper Street View link
    function svLink(lat, lng, heading=0, pitch=0, fov=75){
      const q = new URLSearchParams({
        api: 1,
        map_action: 'pano',
        viewpoint: `${lat},${lng}`,
        heading, pitch, fov
      });
      return `https://www.google.com/maps/@?${q.toString()}`;
    }

    /* ============ UPLOAD GEOJSON → DRIVE ============ */
    if (uploadBtn) {
      uploadBtn.addEventListener('click', () => {
        uploadMsg.style.color = '#e5e7eb';
        uploadMsg.textContent = '';

        const file = uploadInput.files[0];
        if (!file) {
          uploadMsg.style.color = '#f87171';
          uploadMsg.textContent = 'Pilih dulu file GeoJSON / JSON yang mau diupload.';
          return;
        }

        const reader = new FileReader();
        reader.onload = async (evt) => {
          const content = evt.target.result;

          const bbwsName = 'BBWS Serayu Opak'; // folder BBWS di Drive

          const payload = {
            filename: file.name,
            mimeType: file.type || 'application/json',
            content: content,
            bbwsName: bbwsName
          };

          uploadMsg.textContent = 'Mengunggah & menyimpan ke Drive...';

          try {
            const res = await fetch(UPLOAD_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const text = await res.text();
            let data = null;
            try { data = JSON.parse(text); } catch (e) {}

            if (!res.ok || !data) {
              uploadMsg.style.color = '#f87171';
              uploadMsg.textContent = 'Upload gagal: ' + (res.statusText || 'respons tidak valid');
              return;
            }

            if (data.ok) {
              uploadMsg.style.color = '#4ade80';
              if (data.webViewLink) {
                uploadMsg.innerHTML = 'Berhasil tersimpan di folder <b>' + (data.folderName || bbwsName) +
                  '</b>. <a href="' + data.webViewLink +
                  '" target="_blank" rel="noopener" style="color:#93c5fd;text-decoration:underline">Buka file</a>';
              } else {
                uploadMsg.textContent = 'Berhasil tersimpan di Google Drive (folder: ' +
                  (data.folderName || bbwsName) + ').';
              }
            } else {
              uploadMsg.style.color = '#f97316';
              uploadMsg.textContent = 'Server balas error: ' + (data.error || 'tidak diketahui');
            }

          } catch (err) {
            uploadMsg.style.color = '#f87171';
            uploadMsg.textContent = 'Gagal menghubungi server upload: ' + err;
          }
        };

        reader.readAsText(file);
      });
    }

    /* ============ MY LOCATION BUTTON ============ */
    let myLocMarker = null;
    let myLocCircle = null;

    if (locBtn) {
      locBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          note('Browser tidak mendukung geolokasi.');
          return;
        }

        note('Mencari lokasi Anda...');
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const acc = pos.coords.accuracy || 0;

            const latlng = [lat, lng];

            if (!myLocMarker) {
              myLocMarker = L.marker(latlng).addTo(map).bindPopup('Lokasi saya');
            } else {
              myLocMarker.setLatLng(latlng);
            }

            if (acc && !isNaN(acc)) {
              if (!myLocCircle) {
                myLocCircle = L.circle(latlng, { radius: acc, color:'#38bdf8', weight:1, fillOpacity:0.15 })
                  .addTo(map);
              } else {
                myLocCircle.setLatLng(latlng);
                myLocCircle.setRadius(acc);
              }
            }

            map.setView(latlng, Math.max(map.getZoom(), 15));
            note('');
            if (myLocMarker) myLocMarker.openPopup();
          },
          (err) => {
            note('Gagal mendapatkan lokasi: ' + err.message);
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      });
    }

    /* ============ LOAD DATA ============ */
    Promise.allSettled([
      fetch(GAS_URL).then(r=>r.json()),
      fetch(PATHS.DI).then(r=>r.json()),
      fetch(PATHS.SALURAN).then(r=>r.json()),
      fetch(PATHS.BENDUNG).then(r=>r.json())
    ]).then(results=>{
      const [gasRes,diRes,salRes,bendungRes]=results;

      if(gasRes.status==='fulfilled'){
        const norm=normalizeGas(gasRes.value);
        lookup=norm.lookup;rows=norm.rows;headers=norm.headers;groups=buildFixedGroups(headers);
        Object.keys(groups).filter(k=>k!=='__ALL__')
          .forEach(k=>clusterSel.insertAdjacentHTML('beforeend',`<option value="${k}">${k}</option>`));
        const diNames=[...new Set(rows.map(r=>getNamaDI(r)).filter(Boolean))].sort();
        diNames.forEach(nm=>diSel.insertAdjacentHTML('beforeend',`<option value="${nm}">${nm}</option>`));
      }

      // DI (polygon)
      if(diRes.status==='fulfilled'){
        const fc={type:'FeatureCollection',features:diRes.value?.features||[]};
        diLayer=L.geoJSON(fc,{
          pane: 'diPane',
          style:()=>({color:'#1d5fd1',weight:1,fillColor:'#3388ff',fillOpacity:0.30}),
          onEachFeature:(f,layer)=>{
            const key=String(f.properties?.Kd_Inf||"").trim();
            const info=lookup[key]||{};
            const title=getNamaDI(info)||key||'DI';
            const center=layer.getBounds().getCenter();
            diIndex.push({layer,key,title,nama:title.toLowerCase(),dataObj:info,center});
            layer.on('click',()=>{
              activeKey=key;activeTitle=title;
              renderDetailDI(info,title,key);
              layer.bringToFront();
            });
          }
        }).addTo(map);
        if(diLayer.getLayers().length){map.fitBounds(diLayer.getBounds());}
      }

      // Saluran (line)
      if(salRes.status==='fulfilled'){
        const fc={type:'FeatureCollection',features:salRes.value?.features||[]};
        saluranLayer=L.geoJSON(fc,{
          pane: 'saluranPane',
          style:()=>({color:'#10b981',weight:2,opacity:.95})
        }).addTo(map);
        saluranLayer.bringToFront();
      }

      // Bendung (point)
      let bendungData = (bendungRes.status==='fulfilled' && bendungRes.value) ? bendungRes.value : BENDUNG_SAMPLE;
      bendungLayer=L.geoJSON(bendungData,{
        pane:'bendungPane',
        pointToLayer:(feat,latlng)=>L.circleMarker(latlng,{radius:6,weight:2,opacity:1,fillOpacity:.9,color:'#f59e0b',fillColor:'#f59e0b'}),
        onEachFeature:(f,l)=>{
          const p=f.properties||{};
          const nm=p.nama||'Bendung';
          const sungai=p.sungai||'-';
          const kd=p.Kd_Inf||'-';
          const lat = l.getLatLng().lat.toFixed(6);
          const lng = l.getLatLng().lng.toFixed(6);
          const heading = Number(p.heading || 0);
          const pitch = Number(p.pitch || 0);
          const fov = Number(p.fov || 75);
          const svURL = svLink(lat, lng, heading, pitch, fov);
          const gmapsURL = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

          const html = `
            <div style="min-width:220px">
              <div style="font-weight:800;margin-bottom:4px">${nm}</div>
              <div style="font-size:12px;color:#64748b;margin-bottom:6px">
                <div><b>Sungai:</b> ${sungai}</div>
                <div><b>Kd_Inf:</b> ${kd}</div>
                <div><b>Koordinat:</b> ${lat}, ${lng}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap">
                <a href="${svURL}" target="_blank" rel="noopener"
                   style="background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Buka Street View
                </a>
                <a href="${gmapsURL}" target="_blank" rel="noopener"
                   style="background:#111827;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:700;font-size:12px">
                   Buka di Google Maps
                </a>
              </div>
            </div>
          `;
          l.bindPopup(html);
        }
      }).addTo(map);
      bendungLayer.bringToFront();

      const overlays={};
      if(diLayer)overlays['DI (Polygon)']=diLayer;
      if(saluranLayer)overlays['Saluran (Line)']=saluranLayer;
      if(bendungLayer)overlays['Bendung (Point)']=bendungLayer;
      L.control.layers(null,overlays,{collapsed:true}).addTo(map);

      refreshLabelsAndStats();
      detailEl.innerHTML='<i style="color:#cbd5e1">Klik poligon DI atau pilih DI untuk lihat detail.</i>';
    });

    function renderDetailDI(info,title,key){
      const g=clusterSel.value||"__ALL__";
      const table=(lookup[key])
        ?buildTable(info,(g==="__ALL__")?headers:(groups[g]||headers))
        :`<div style="color:#cbd5e1;font-size:12px">Data GAS tidak ditemukan.</div>`;
      detailEl.innerHTML=`<h3 style="margin:6px 0;color:#fff">${title}</h3>
      <div style="font-size:12px;color:#cbd5e1;margin-bottom:6px">Kd_Inf: ${key}</div>${table}`;
    }

    function refreshLabelsAndStats(){
      labelLayer.clearLayers();
      if(diIndex.length&&map.getZoom()>=10){
        diIndex.forEach(o=>addLabel(o.center,o.title));
      }
      updateStats();
    }

    map.on('zoomend',refreshLabelsAndStats);
  });
  </script>
</body>
</html>
