<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard DI — BWS/BBWS (BAKU · FUNG · POTS) dari Drive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../assets/LogoPUPR.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted2:#94a3b8;
      --pu:#0d47a1; --accent:#2563eb; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:78px; --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .header{
      position:fixed;top:0;left:0;right:0;z-index:900;
      background:var(--pu);border-bottom:1px solid rgba(255,255,255,.18);
      padding:8px 12px;display:flex;align-items:center;gap:10px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:44px}
    .header .text{flex:1;color:#fff}
    .header .title{font-weight:800;font-size:13px;line-height:1.2}
    .header .subtitle{font-weight:600;font-size:11px;color:rgba(255,255,255,.9);margin-top:2px}
    .btn-home{
      background:#fff;color:var(--pu);font-weight:800;padding:6px 12px;border-radius:10px;
      text-decoration:none;font-size:11px;white-space:nowrap
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH));position:relative;z-index:1}

    /* Dock */
    .dock{
      position:fixed;left:0;right:0;bottom:0;z-index:950;
      background:var(--panel);border-top:1px solid var(--border);
      max-height:40vh;padding:10px 12px;backdrop-filter:blur(6px);
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      display:flex;flex-direction:column;gap:8px;
      transition:max-height .2s ease,padding .2s ease;
    }
    .dock-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dock-title{font-size:14px;margin:0;font-weight:800;color:#fff}
    .dock-toggle{
      background:rgba(15,23,42,.9);border:1px solid var(--border);border-radius:999px;
      color:#e5e7eb;font-size:11px;padding:2px 10px;cursor:pointer
    }
    .dock-toggle:hover{background:#111827}
    .dock.collapsed{max-height:42px;padding-top:6px;padding-bottom:6px}
    .dock.collapsed .dock-body{display:none}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;align-items:start}
    .box{
      border:1px solid var(--border);border-radius:14px;background:rgba(15,23,42,.7);
      padding:10px 12px
    }
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:12px;color:var(--muted)}
    .kv b{color:#fff}
    .rowbtn{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{
      background:rgba(255,255,255,.06);border:1px solid var(--border);color:#fff;
      border-radius:999px;padding:8px 12px;font-size:12px;font-weight:800;cursor:pointer
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.primary:hover{background:#1d4ed8}
    .msg{font-size:12px;color:#cbd5e1;margin-top:8px;white-space:pre-wrap}
    .msg.err{color:#fca5a5}
    .msg.ok{color:#4ade80}
    .hint{font-size:11px;color:#94a3b8;margin-top:8px}

    /* Legend */
    .legend{
      background:rgba(15,23,42,.92);color:#e5e7eb;padding:8px 10px;border-radius:12px;
      border:1px solid rgba(148,163,184,.5);min-width:180px
    }
    .legend .top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
    .legend .ttl{font-weight:900;font-size:12px}
    .legend button{
      background:transparent;border:1px solid rgba(148,163,184,.7);color:#e5e7eb;
      border-radius:999px;font-size:10px;padding:1px 8px;cursor:pointer
    }
    .legend .item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:12px}
    .sw{width:14px;height:14px;border-radius:4px;border:1px solid rgba(255,255,255,.7)}
    .sw-baku{background:#22c55e}
    .sw-fung{background:#3b82f6}
    .sw-pots{background:#f59e0b}
    .legend.collapsed .body{display:none}

    /* Badge */
    .badge-irwan{
      position:fixed;right:12px;bottom:92px;z-index:1200;
      background:rgba(13,71,161,.85);border:1px solid rgba(255,255,255,.25);
      color:#fff;font-size:11px;font-weight:800;padding:6px 10px;border-radius:10px;
      box-shadow:0 0 10px rgba(13,71,161,.6);backdrop-filter:blur(6px)
    }
    .badge-irwan span{color:#FFD700}

    @media(max-width:720px){
      :root{--hdrH:88px}
      .grid{grid-template-columns:1fr}
      .kv{grid-template-columns:120px 1fr}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian PU</div>
      <div class="subtitle">Ditjen SDA · Dit. Irigasi &amp; Rawa</div>
      <div class="subtitle"><b>Dashboard DI (BAKU · FUNG · POTS)</b> dari Google Drive</div>
    </div>
    <a href="../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- DOCK -->
  <div class="dock" id="dock">
    <div class="dock-header">
      <h2 class="dock-title" id="dockTitle">Dashboard BWS/BBWS</h2>
      <button class="dock-toggle" id="dockToggle">Ciutkan</button>
    </div>

    <div class="dock-body">
      <div class="grid">
        <div class="box">
          <div class="kv">
            <div>Folder Drive (jenisId)</div><div><b id="jenisIdView">-</b></div>
            <div>Key BWS</div><div><b id="bwsView">-</b></div>
            <div>Deteksi file</div><div><b id="foundView">-</b></div>
          </div>

          <div class="rowbtn">
            <button class="btn primary" id="btnLoad">Muat dari Drive</button>
            <button class="btn" id="btnFit">Fit ke Layer</button>
            <button class="btn" id="btnClear">Clear Layer</button>
          </div>

          <div class="msg" id="msg"></div>
          <div class="hint">
            Tips: `jenisId` = ID folder “DI Permukaan/DI Rawa/DI Tambak”.<br/>
            `bws` dipakai buat nyari file: <i>..._BWS_Sumatera_VII_BAKU/FUNG/POTS.geojson</i>
          </div>
        </div>

        <div class="box">
          <div class="kv">
            <div>Jumlah fitur BAKU</div><div><b id="cntBaku">0</b></div>
            <div>Jumlah fitur FUNG</div><div><b id="cntFung">0</b></div>
            <div>Jumlah fitur POTS</div><div><b id="cntPots">0</b></div>
          </div>
          <div class="hint" style="margin-top:10px">
            Popup otomatis tampil saat klik polygon/line/point.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
    <span>Si-Irwan v1.0</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    // ====== WAJIB: URL GAS PROXY kamu ======
    const GAS_URL = "https://script.google.com/macros/s/AKfycbySxkY9zUGZZGNhkpzsbY6WrF7YClIriaDfdkw2b6Zen6y0J-wTPv8Mtv8oOz_3gX_-/exec";

    // ====== Query param ======
    const qs = new URLSearchParams(location.search);
    const jenisId = (qs.get("jenisId") || "").trim();
    const bwsKey  = (qs.get("bws") || "").trim();

    // ====== UI ======
    const $ = (id)=>document.getElementById(id);
    const msgEl = $("msg");
    const jenisIdView = $("jenisIdView");
    const bwsView = $("bwsView");
    const foundView = $("foundView");
    const dockTitle = $("dockTitle");
    const cntBaku = $("cntBaku");
    const cntFung = $("cntFung");
    const cntPots = $("cntPots");

    function setMsg(text, kind){
      msgEl.className = "msg" + (kind ? " " + kind : "");
      msgEl.textContent = text || "";
    }

    jenisIdView.textContent = jenisId || "(kosong)";
    bwsView.textContent = bwsKey || "(kosong)";
    dockTitle.textContent = bwsKey ? ("Dashboard " + bwsKey) : "Dashboard BWS/BBWS";

    // ====== Map ======
    const map = L.map("map").setView([-2.5,118.0],5);

    const imagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution:"Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics" }
    ).addTo(map);

    // ====== Layer groups ======
    const gBaku = L.layerGroup().addTo(map);
    const gFung = L.layerGroup().addTo(map);
    const gPots = L.layerGroup().addTo(map);

    const state = {
      files: { BAKU:null, FUNG:null, POTS:null },
      layers: { BAKU:gBaku, FUNG:gFung, POTS:gPots },
      loaded: { BAKU:false, FUNG:false, POTS:false },
    };

    function clearAll(){
      gBaku.clearLayers(); gFung.clearLayers(); gPots.clearLayers();
      state.loaded = { BAKU:false, FUNG:false, POTS:false };
      state.files = { BAKU:null, FUNG:null, POTS:null };
      updateCounts();
      foundView.textContent = "-";
      setMsg("Layer dibersihkan.", "");
    }

    function updateCounts(){
      cntBaku.textContent = countFeaturesInGroup(gBaku);
      cntFung.textContent = countFeaturesInGroup(gFung);
      cntPots.textContent = countFeaturesInGroup(gPots);
    }
    function countFeaturesInGroup(group){
      let n = 0;
      group.eachLayer(l=>{
        if (l && l.getLayers) n += l.getLayers().length;
        else n += 1;
      });
      return n;
    }

    function styleByType(type){
      if(type==="BAKU") return { color:"#22c55e", weight:2, fillOpacity:0.18 };
      if(type==="FUNG") return { color:"#3b82f6", weight:2, fillOpacity:0.18 };
      return { color:"#f59e0b", weight:2, fillOpacity:0.18 }; // POTS
    }

    function bindPopup(feature, layer){
      const p = feature.properties || {};
      const title =
        p["Nama DI"] || p["Nama_DI"] || p["Nama Aset"] || p["NAMA_ASET"] ||
        p.nama || p.Name || p.NAMOBJ || "Fitur";

      // Cari koordinat sederhana (untuk link maps)
      let lat=null,lng=null;
      if(feature.geometry && feature.geometry.type==="Point" && Array.isArray(feature.geometry.coordinates)){
        lng = feature.geometry.coordinates[0];
        lat = feature.geometry.coordinates[1];
      }

      const rows = Object.keys(p).slice(0,18).map(k=>{
        const v = p[k];
        if(v==null || v==="") return "";
        return `<tr><td style="padding:2px 4px;color:#64748b">${k}</td><td style="padding:2px 4px">${String(v)}</td></tr>`;
      }).join("");

      let links = "";
      if(lat!=null && lng!=null && !isNaN(lat) && !isNaN(lng)){
        const la = Number(lat).toFixed(6), lo = Number(lng).toFixed(6);
        const gmaps = `https://www.google.com/maps/search/?api=1&query=${la},${lo}`;
        links = `<div style="margin-top:8px">
          <a href="${gmaps}" target="_blank" rel="noopener"
             style="background:#111827;color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none;font-weight:800;font-size:12px">
            Buka di Google Maps
          </a>
        </div>`;
      }

      layer.bindPopup(`
        <div style="min-width:240px">
          <div style="font-weight:900;margin-bottom:6px">${title}</div>
          <table style="border-collapse:collapse;font-size:12px">${rows || "<tr><td style='color:#94a3b8'>(atribut kosong)</td></tr>"}</table>
          ${links}
        </div>
      `);
    }

    function addGeoJSONToGroup(gj, type){
      const group = state.layers[type];
      const layer = L.geoJSON(gj,{
        style: ()=>styleByType(type),
        pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
          radius:5, weight:2, opacity:1,
          color: styleByType(type).color,
          fillColor: styleByType(type).color,
          fillOpacity: 0.85
        }),
        onEachFeature: bindPopup
      });
      layer.addTo(group);
      state.loaded[type] = true;
    }

    function fitToLoaded(){
      const fg = L.featureGroup();
      [gBaku,gFung,gPots].forEach(g=>g.eachLayer(l=>fg.addLayer(l)));
      if(fg.getLayers().length){
        try{ map.fitBounds(fg.getBounds(), { padding:[20,20] }); }catch(e){}
      }
    }

    // ====== GAS calls ======
    async function gasList(jenisId, bws){
      const url = `${GAS_URL}?action=list&jenisId=${encodeURIComponent(jenisId)}&bws=${encodeURIComponent(bws)}&t=${Date.now()}`;
      const res = await fetch(url);
      const data = await res.json();
      return data; // {ok, items:[{id,name,type}]}
    }
    async function gasGet(fileId){
      const url = `${GAS_URL}?action=get&fileId=${encodeURIComponent(fileId)}&t=${Date.now()}`;
      const res = await fetch(url);
      return await res.json(); // GeoJSON
    }

    async function loadFromDrive(){
      if(!jenisId || !bwsKey){
        setMsg("Param kosong.\nBuka URL dengan:\n?jenisId=ID_FOLDER_JENIS&bws=BWS_Sumatera_VII", "err");
        return;
      }

      setMsg("Listing file di Drive...\n" + bwsKey, "");
      let list;
      try{
        list = await gasList(jenisId, bwsKey);
      }catch(e){
        setMsg("Gagal list dari GAS proxy:\_attach error_\n" + e, "err");
        return;
      }

      if(!list || !list.ok){
        setMsg("List gagal: " + (list && list.error ? list.error : "unknown"), "err");
        return;
      }

      // deteksi file
      const items = Array.isArray(list.items) ? list.items : [];
      const pick = { BAKU:null, FUNG:null, POTS:null };

      for(const it of items){
        if(it.type === "BAKU") pick.BAKU = it;
        if(it.type === "FUNG") pick.FUNG = it;
        if(it.type === "POTS") pick.POTS = it;
      }

      state.files = pick;

      const found = [
        pick.BAKU ? "BAKU✅" : "BAKU❌",
        pick.FUNG ? "FUNG✅" : "FUNG❌",
        pick.POTS ? "POTS✅" : "POTS❌",
      ].join("  ");
      foundView.textContent = found;

      const missing = Object.keys(pick).filter(k=>!pick[k]);
      if(missing.length){
        setMsg(
          "List OK, tapi ada file yang belum ketemu:\n- " + missing.join(", ") +
          "\n\nPastikan nama file mengandung:\n_" + bwsKey + "_BAKU / _FUNG / _POTS\n(dan ext .geojson)",
          "err"
        );
        // tetap lanjut load yang ada
      } else {
        setMsg("List OK. Mengambil GeoJSON (BAKU/FUNG/POTS)...", "");
      }

      // clear dulu biar gak dobel
      gBaku.clearLayers(); gFung.clearLayers(); gPots.clearLayers();
      state.loaded = {BAKU:false,FUNG:false,POTS:false};
      updateCounts();

      // load satu-satu
      for(const type of ["BAKU","FUNG","POTS"]){
        const meta = pick[type];
        if(!meta) continue;

        setMsg(`Mengambil ${type}: ${meta.name}`, "");
        try{
          const gj = await gasGet(meta.id);
          addGeoJSONToGroup(gj, type);
        }catch(e){
          setMsg(`Gagal get ${type}:\n${e}`, "err");
        }
      }

      updateCounts();
      fitToLoaded();

      // status akhir
      const okTypes = ["BAKU","FUNG","POTS"].filter(t=>state.loaded[t]);
      if(okTypes.length){
        setMsg("Selesai ✅\nLayer aktif: " + okTypes.join(", "), "ok");
      }else{
        setMsg("Tidak ada layer yang berhasil dimuat.", "err");
      }
    }

    // ====== Legend control (checkbox on/off) ======
    const LegendControl = L.Control.extend({
      options: { position:"topright" },
      onAdd: function(){
        const div = L.DomUtil.create("div","legend");
        div.innerHTML = `
          <div class="top">
            <div class="ttl">Legenda</div>
            <button type="button" id="legBtn">Ciut</button>
          </div>
          <div class="body">
            <div class="item">
              <input type="checkbox" id="chkBAKU" checked />
              <span class="sw sw-baku"></span>
              <label for="chkBAKU">BAKU</label>
            </div>
            <div class="item">
              <input type="checkbox" id="chkFUNG" checked />
              <span class="sw sw-fung"></span>
              <label for="chkFUNG">Fungsional</label>
            </div>
            <div class="item">
              <input type="checkbox" id="chkPOTS" checked />
              <span class="sw sw-pots"></span>
              <label for="chkPOTS">Potensial</label>
            </div>
          </div>
        `;
        L.DomEvent.disableClickPropagation(div);

        const chkBAKU = div.querySelector("#chkBAKU");
        const chkFUNG = div.querySelector("#chkFUNG");
        const chkPOTS = div.querySelector("#chkPOTS");
        const legBtn  = div.querySelector("#legBtn");

        chkBAKU.addEventListener("change", ()=> chkBAKU.checked ? map.addLayer(gBaku) : map.removeLayer(gBaku));
        chkFUNG.addEventListener("change", ()=> chkFUNG.checked ? map.addLayer(gFung) : map.removeLayer(gFung));
        chkPOTS.addEventListener("change", ()=> chkPOTS.checked ? map.addLayer(gPots) : map.removeLayer(gPots));

        let collapsed = false;
        legBtn.addEventListener("click", ()=>{
          collapsed = !collapsed;
          div.classList.toggle("collapsed", collapsed);
          legBtn.textContent = collapsed ? "Tampil" : "Ciut";
        });

        return div;
      }
    });
    map.addControl(new LegendControl());

    // ====== Dock collapse ======
    const dock = $("dock");
    const dockToggle = $("dockToggle");
    let dockCollapsed = false;
    dockToggle.addEventListener("click", ()=>{
      dockCollapsed = !dockCollapsed;
      dock.classList.toggle("collapsed", dockCollapsed);
      dockToggle.textContent = dockCollapsed ? "Tampilkan" : "Ciutkan";
    });

    // ====== Buttons ======
    $("btnLoad").addEventListener("click", loadFromDrive);
    $("btnFit").addEventListener("click", fitToLoaded);
    $("btnClear").addEventListener("click", clearAll);

    // ====== Auto load kalau param ada ======
    if(jenisId && bwsKey){
      setMsg("Auto-load aktif...\nMemuat data dari Drive.", "");
      loadFromDrive();
    }else{
      setMsg("Siap.\nTambahkan query param:\n?jenisId=ID_FOLDER_JENIS&bws=BWS_Sumatera_VII", "");
    }
  })();
  </script>
</body>
</html>
