<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peta DI (BAKU/FUNG/POTS) — from Drive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../../assets/LogoPUPR.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted2:#94a3b8;
      --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:80px; --radius:12px;
      --ok:#4ade80; --warn:#f59e0b; --bad:#f87171;
    }
    html, body {height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    .header{
      position:fixed; inset:0 0 auto 0; z-index:900;
      background:var(--survey);
      border-bottom:1px solid rgba(255,255,255,.18);
      padding:8px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:44px}
    .header .text{flex:1; color:#fff}
    .header .title{font-weight:800; font-size:13px; line-height:1.25}
    .header .subtitle{font-weight:600; font-size:11px; color:rgba(255,255,255,.9); margin-top:2px}
    .btn-home{
      background:#fff; color:var(--survey);
      font-weight:800; padding:6px 12px;
      border-radius:10px; text-decoration:none; font-size:11px; white-space:nowrap;
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH)); position:relative; z-index:1}

    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--panel); border-top:1px solid var(--border);
      max-height:42vh; padding:10px 12px;
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      z-index:950; backdrop-filter:blur(6px);
      display:flex; flex-direction:column; gap:8px;
      transition:max-height .2s ease, padding .2s ease;
    }
    .dock.collapsed{max-height:40px; padding-top:6px; padding-bottom:6px}
    .dock.collapsed .dock-body{display:none}
    .dock-header{display:flex; align-items:center; justify-content:space-between}
    .dock-header h2{font-size:14px; margin:0; font-weight:900; color:#fff}
    .dock-toggle{
      background:rgba(15,23,42,.9);
      border:1px solid var(--border);
      border-radius:999px;
      color:#e5e7eb;
      font-size:11px;
      padding:2px 10px;
      cursor:pointer;
    }
    .dock-toggle:hover{background:#111827}
    .dock-body{font-size:12px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius:999px;
      color:#e5e7eb;
      font-size:12px;
      flex-wrap:wrap;
    }
    .pill b{color:#fff}
    .msg{font-size:12px; color:var(--muted)}
    .msg .ok{color:var(--ok); font-weight:800}
    .msg .bad{color:var(--bad); font-weight:800}
    .msg .warn{color:var(--warn); font-weight:800}

    .meta{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:12px;
      padding:10px;
    }
    .meta .k{color:var(--muted2); font-size:11px}
    .meta .v{color:#fff; font-weight:800}

    .badge-irwan{
      position:fixed; right:12px; bottom:92px; z-index:1200;
      background:rgba(13,71,161,.85);
      border:1px solid rgba(255,255,255,.25);
      color:#fff; font-size:11px; font-weight:800;
      padding:6px 10px; border-radius:10px;
      box-shadow:0 0 10px rgba(13,71,161,.6);
      backdrop-filter:blur(6px);
      animation:glow 2.8s ease-in-out infinite
    }
    .badge-irwan span{color:#FFD700}
    @keyframes glow{
      0%,100%{box-shadow:0 0 8px rgba(13,71,161,.6)}
      50%{box-shadow:0 0 18px rgba(255,215,0,.8)}
    }

    .legend{
      background:rgba(15,23,42,.95);
      color:#f9fafb;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.6);
      font-size:12px;
      min-width:170px;
    }
    .legend .hdr{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
    .legend .ttl{font-weight:900}
    .legend button{
      background:transparent;
      border:1px solid rgba(148,163,184,.8);
      color:#e5e7eb;
      border-radius:999px;
      font-size:10px;
      padding:0 8px;
      cursor:pointer;
    }
    .legend.collapsed .body{display:none}
    .item{display:flex; align-items:center; gap:8px; margin:6px 0}
    .sw{width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.7)}
    .sw-baku{background:#3388ff}
    .sw-fung{background:#10b981}
    .sw-pots{background:#f59e0b}

    @media(max-width:680px){
      :root{--hdrH:88px}
    }
  </style>
</head>

<body>
  <div class="header">
    <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian PU</div>
      <div class="subtitle">Ditjen SDA · Dit. Irigasi &amp; Rawa</div>
      <div class="subtitle">Peta DI (BAKU/FUNG/POTS) <b>dari Google Drive</b></div>
    </div>
    <a href="../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <div id="map"></div>

  <div class="dock" id="dock">
    <div class="dock-header">
      <h2>Info Dataset</h2>
      <button id="dockToggle" class="dock-toggle">Ciutkan</button>
    </div>

    <div class="dock-body">
      <div class="pill" id="pill">
        Memuat parameter…
      </div>

      <div class="msg" id="statusMsg" style="margin-top:6px"></div>

      <div class="meta" style="margin-top:8px">
        <div class="k">File match (hasil pencarian nama di folder Drive):</div>
        <div style="display:grid; grid-template-columns:1fr; gap:6px; margin-top:8px">
          <div><span class="k">BAKU:</span> <span class="v" id="mBaku">-</span></div>
          <div><span class="k">FUNG:</span> <span class="v" id="mFung">-</span></div>
          <div><span class="k">POTS:</span> <span class="v" id="mPots">-</span></div>
        </div>
      </div>

      <div class="meta" style="margin-top:8px">
        <div class="k">Tips cepat:</div>
        <div style="margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35">
          1) Pastikan file di Drive <b>shared / bisa diakses publik</b> kalau pakai API key.<br>
          2) Kalau ketemu 403 (referrer), set restriction API key ke domain GitHub Pages kamu.<br>
          3) Format nama file yang dipakai: <b>Provinsi_Scope__Wilayah_TIPE.geojson</b> (kab pakai __).
        </div>
      </div>
    </div>
  </div>

  <div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
    <span>Si-Irwan v1.0</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (function(){
    // =========================
    // 1) KONFIG WAJIB
    // =========================
    // ⚠️ Jangan lupa: batasi API key ke referrer GitHub Pages kamu.
    const DRIVE_API_KEY = "AIzaSyDlpSnNEI__Z5OWinbf24BGJ4_U6JucNMs";

    // =========================
    // 2) PARAM URL
    // =========================
    // Contoh:
    // prov_kab_map.html?jenisId=1tt-ITiWsqh54OaJgZOkaqqIElf6lI1kc&prov=Aceh&scope=Kabupaten&wil=Simeulue
    const q = new URLSearchParams(location.search);
    const jenisId = (q.get("jenisId") || "").trim();      // folder Drive: DI Permukaan / DI Tambak / dsb
    const prov    = (q.get("prov") || "").trim();         // Aceh
    const scope   = (q.get("scope") || "").trim();        // Kabupaten | Kota | Provinsi | Pusat
    const wil     = (q.get("wil") || "").trim();          // Simeulue | Langsa | Aceh | BWS Sumatera I (dll)

    const pill = document.getElementById("pill");
    const statusMsg = document.getElementById("statusMsg");

    const mBaku = document.getElementById("mBaku");
    const mFung = document.getElementById("mFung");
    const mPots = document.getElementById("mPots");

    pill.innerHTML = `
      <b>jenisId</b>: ${jenisId || "-"} ·
      <b>prov</b>: ${prov || "-"} ·
      <b>scope</b>: ${scope || "-"} ·
      <b>wil</b>: ${wil || "-"}
    `;

    // =========================
    // 3) MAP INIT
    // =========================
    const map = L.map("map").setView([-2.5, 118.0], 5);

    const imagery = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution:"Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics" }
    ).addTo(map);

    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution:"© OpenStreetMap contributors" }
    );

    const layerCtl = L.control.layers({"Imagery": imagery, "OSM": osm}, null, {collapsed:true, position:"topright"}).addTo(map);

    // Panes
    map.createPane("bakuPane"); map.getPane("bakuPane").style.zIndex = 410;
    map.createPane("fungPane"); map.getPane("fungPane").style.zIndex = 420;
    map.createPane("potsPane"); map.getPane("potsPane").style.zIndex = 430;

    let layerBAKU = null;
    let layerFUNG = null;
    let layerPOTS = null;

    // =========================
    // 4) UI: DOCK COLLAPSE
    // =========================
    const dock = document.getElementById("dock");
    const dockToggle = document.getElementById("dockToggle");
    let dockCollapsed = false;
    dockToggle.addEventListener("click", ()=>{
      dockCollapsed = !dockCollapsed;
      dock.classList.toggle("collapsed", dockCollapsed);
      dockToggle.textContent = dockCollapsed ? "Tampilkan" : "Ciutkan";
    });

    // =========================
    // 5) LEGEND TOGGLE (BAKU/FUNG/POTS)
    // =========================
    const LegendControl = L.Control.extend({
      position:"topright",
      onAdd: function(){
        const el = L.DomUtil.create("div", "legend");
        el.innerHTML = `
          <div class="hdr">
            <span class="ttl">Layer DI</span>
            <button type="button" id="btnLeg">Ciut</button>
          </div>
          <div class="body" id="legBody">
            <div class="item">
              <input id="chkBaku" type="checkbox" checked />
              <span class="sw sw-baku"></span>
              <label for="chkBaku">BAKU</label>
            </div>
            <div class="item">
              <input id="chkFung" type="checkbox" checked />
              <span class="sw sw-fung"></span>
              <label for="chkFung">Fungsional</label>
            </div>
            <div class="item">
              <input id="chkPots" type="checkbox" checked />
              <span class="sw sw-pots"></span>
              <label for="chkPots">Potensial</label>
            </div>
          </div>
        `;
        L.DomEvent.disableClickPropagation(el);

        let collapsed = false;
        el.querySelector("#btnLeg").addEventListener("click", ()=>{
          collapsed = !collapsed;
          el.classList.toggle("collapsed", collapsed);
          el.querySelector("#btnLeg").textContent = collapsed ? "Tampil" : "Ciut";
        });

        el.querySelector("#chkBaku").addEventListener("change", (e)=>{
          if(!layerBAKU) return;
          e.target.checked ? map.addLayer(layerBAKU) : map.removeLayer(layerBAKU);
        });
        el.querySelector("#chkFung").addEventListener("change", (e)=>{
          if(!layerFUNG) return;
          e.target.checked ? map.addLayer(layerFUNG) : map.removeLayer(layerFUNG);
        });
        el.querySelector("#chkPots").addEventListener("change", (e)=>{
          if(!layerPOTS) return;
          e.target.checked ? map.addLayer(layerPOTS) : map.removeLayer(layerPOTS);
        });

        return el;
      }
    });
    map.addControl(new LegendControl());

    // =========================
    // 6) DRIVE HELPERS
    // =========================
    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function setStatus(html, kind){
      const cls = kind === "ok" ? "ok" : (kind === "bad" ? "bad" : "warn");
      statusMsg.innerHTML = `<span class="${cls}">${html}</span>`;
    }

    function driveFilesList(folderId){
      const url = new URL("https://www.googleapis.com/drive/v3/files");
      // q: list file dalam folder
      url.searchParams.set("q", `'${folderId}' in parents and trashed=false`);
      url.searchParams.set("fields", "files(id,name,mimeType,modifiedTime,webViewLink)");
      url.searchParams.set("pageSize", "1000");
      url.searchParams.set("key", DRIVE_API_KEY);
      return fetch(url.toString()).then(r => r.json());
    }

    function driveDownloadGeoJSON(fileId){
      // alt=media -> isi file mentah
      const url = new URL(`https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}`);
      url.searchParams.set("alt", "media");
      url.searchParams.set("key", DRIVE_API_KEY);
      return fetch(url.toString()).then(r => {
        if(!r.ok) throw new Error("Download gagal: HTTP " + r.status);
        return r.json();
      });
    }

    // Normalisasi string buat matching nama file
    function normName(s){
      return String(s||"").trim().toLowerCase()
        .replace(/\s+/g,"_")
        .replace(/-+/g,"_")
        .replace(/__+/g,"__");
    }

    // =========================
    // 7) MATCH FILE BERDASARKAN FORMAT NAMA KAMU
    // =========================
    function findMatch(files, type){
      // type: BAKU/FUNG/POTS
      const t = type.toLowerCase();

      // Kandidat pattern utama:
      // - prov_scope__wil_type.geojson  (Kabupaten pakai __ sebelum wilayah)
      // - prov_scope_wil_type.geojson   (Kota/Provinsi sering single underscore)
      // Kita bikin flexible: cukup cek token prov + scope + wil + _TYPE
      const nProv  = normName(prov);
      const nScope = normName(scope);
      const nWil   = normName(wil);

      const scored = [];
      for(const f of files){
        const n = normName(f.name);

        // wajib: ekstensi geojson/json
        if(!(n.endsWith(".geojson") || n.endsWith(".json"))) continue;

        // wajib: ada type
        if(!n.includes("_" + t)) continue;

        // wajib: ada prov
        if(nProv && !n.startsWith(nProv + "_")) continue;

        // optional: scope & wilayah
        let score = 0;
        if(nProv && n.startsWith(nProv + "_")) score += 3;
        if(nScope && n.includes("_" + nScope + "_")) score += 3;
        if(nWil && (n.includes("__" + nWil + "_") || n.includes("_" + nWil + "_"))) score += 4;

        // bonus: match “provinsi_aceh” style
        if(nScope === "provinsi" && nWil && n.includes("_provinsi_" + nWil + "_")) score += 2;

        scored.push({f, score});
      }

      scored.sort((a,b)=>b.score - a.score);
      return scored.length ? scored[0].f : null;
    }

    // =========================
    // 8) LAYER STYLE + POPUP
    // =========================
    function popupForFeature(feat){
      const p = feat.properties || {};
      const title =
        p["Nama DI"] || p["Nama_DI"] || p["NAMA_DI"] ||
        p["Nama Aset"] || p["NAMA_ASET"] ||
        p["NAMOBJ"] || p["name"] || "Fitur";

      const rows = Object.keys(p).slice(0, 18).map(k=>{
        const v = p[k];
        if(v == null || v === "") return "";
        return `<tr><td style="padding:2px 6px;color:#64748b">${esc(k)}</td><td style="padding:2px 6px">${esc(v)}</td></tr>`;
      }).join("");

      return `
        <div style="min-width:220px">
          <div style="font-weight:900;margin-bottom:6px">${esc(title)}</div>
          <table style="border-collapse:collapse;font-size:12px">${rows || "<tr><td style='color:#94a3b8'>(atribut kosong)</td></tr>"}</table>
        </div>
      `;
    }

    function makeLayer(gj, type){
      if(!gj || !gj.features) throw new Error("GeoJSON tidak valid");

      const isBAKU = type === "BAKU";
      const isFUNG = type === "FUNG";
      const isPOTS = type === "POTS";

      return L.geoJSON(gj, {
        pane: isBAKU ? "bakuPane" : (isFUNG ? "fungPane" : "potsPane"),
        style: () => ({
          color: isBAKU ? "#3388ff" : (isFUNG ? "#10b981" : "#f59e0b"),
          weight: 2,
          fillColor: isBAKU ? "#3388ff" : (isFUNG ? "#10b981" : "#f59e0b"),
          fillOpacity: isBAKU ? 0.18 : (isFUNG ? 0.18 : 0.18)
        }),
        onEachFeature: (feat, layer) => layer.bindPopup(popupForFeature(feat))
      });
    }

    // =========================
    // 9) MAIN FLOW
    // =========================
    async function main(){
      if(!DRIVE_API_KEY || DRIVE_API_KEY.includes("PASTE_API_KEY")){
        setStatus("API key belum diisi. Edit DRIVE_API_KEY di file HTML ini.", "bad");
        return;
      }
      if(!jenisId || !prov || !scope || !wil){
        setStatus("Parameter URL kurang. Wajib: jenisId, prov, scope, wil.", "bad");
        return;
      }

      setStatus("Mengambil daftar file dari Drive…", "warn");

      const data = await driveFilesList(jenisId);
      if(data.error){
        setStatus("Drive API error: " + esc(data.error.message || "unknown"), "bad");
        console.error(data);
        return;
      }

      const files = data.files || [];
      if(!files.length){
        setStatus("Folder Drive kosong atau tidak bisa diakses (cek sharing folder).", "bad");
        return;
      }

      const fBaku = findMatch(files, "BAKU");
      const fFung = findMatch(files, "FUNG");
      const fPots = findMatch(files, "POTS");

      mBaku.textContent = fBaku ? fBaku.name : "(tidak ketemu)";
      mFung.textContent = fFung ? fFung.name : "(tidak ketemu)";
      mPots.textContent = fPots ? fPots.name : "(tidak ketemu)";

      if(!fBaku && !fFung && !fPots){
        setStatus("Tidak ada file BAKU/FUNG/POTS yang match. Cek format nama di Drive.", "bad");
        console.log("FILES:", files.map(f=>f.name));
        return;
      }

      setStatus("Download GeoJSON & render layer…", "warn");

      // download paralel (yang ada saja)
      const tasks = [];
      if(fBaku) tasks.push(driveDownloadGeoJSON(fBaku.id).then(gj => ({type:"BAKU", gj})));
      if(fFung) tasks.push(driveDownloadGeoJSON(fFung.id).then(gj => ({type:"FUNG", gj})));
      if(fPots) tasks.push(driveDownloadGeoJSON(fPots.id).then(gj => ({type:"POTS", gj})));

      let anyBounds = null;

      const results = await Promise.allSettled(tasks);
      for(const r of results){
        if(r.status !== "fulfilled"){
          console.warn("Download fail:", r.reason);
          continue;
        }
        const {type, gj} = r.value;
        const layer = makeLayer(gj, type).addTo(map);

        if(type === "BAKU"){ layerBAKU = layer; layerCtl.addOverlay(layerBAKU, "BAKU"); }
        if(type === "FUNG"){ layerFUNG = layer; layerCtl.addOverlay(layerFUNG, "Fungsional"); }
        if(type === "POTS"){ layerPOTS = layer; layerCtl.addOverlay(layerPOTS, "Potensial"); }

        try{
          const b = layer.getBounds();
          if(b && b.isValid()){
            anyBounds = anyBounds ? anyBounds.extend(b) : b;
          }
        }catch(e){}
      }

      if(anyBounds){
        map.fitBounds(anyBounds, {padding:[20,20]});
        setStatus("Selesai ✅ Layer BAKU/FUNG/POTS tampil dan bisa ON/OFF di legenda.", "ok");
      }else{
        setStatus("Layer tampil, tapi bounds tidak valid (mungkin GeoJSON kosong).", "warn");
      }
    }

    // jalan
    main().catch(err=>{
      console.error(err);
      setStatus("Gagal: " + esc(err.message || String(err)), "bad");
    });

  })();
  </script>
</body>
</html>
