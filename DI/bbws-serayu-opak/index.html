<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ========= KONFIG ========= */
/* Ganti path ini sesuai lokasi file di repo kamu */
const GEOJSON_URL = "../bbws-serayu-opak/Bendung.geojson";

/* (Opsional) Tetap pakai GAS kalau mau join ke tabel integrasi.
   Kalau nggak ada match, panel akan fallback ke atribut GeoJSON. */
const GAS_URL = "https://script.google.com/macros/s/AKfycbybsLoQu-8S-MlR_kB2989FZV0C-c1gRzUqcIZWBWuYb-_We03B_BShX8Q3AQqWhOTvzg/exec?sheet=SO_Integrasi&t=" + Date.now();

const diSel = document.getElementById('diSel');
const clusterSel = document.getElementById('clusterSel');
const statsEl = document.getElementById('stats');
const detailEl = document.getElementById('detail');
const msgEl = document.getElementById('msg');
function note(msg){ msgEl.textContent = msg || ""; }

const map = L.map('map').setView([-7.5,110.3], 8);
L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics' }
).addTo(map);

let lookup={}, rows=[], groups={}, headers=[];
let geoLayer, joined=[];
const labelLayer = L.layerGroup().addTo(map);
let activeKey=null, activeTitle=null;

/* ===== Util ===== */
function getNamaDI(obj){return obj?.Nama_DI||obj?.["Nama Aset"]||obj?.["Nama DI"]||obj?.nama_infrastruktur||"";}
function addLabel(latlng,text){
  if(!latlng) return;
  L.tooltip({permanent:true,direction:'top',className:'di-label'})
   .setLatLng(latlng).setContent(text).addTo(labelLayer);
}
function cleanMaybeWrappedJSON(txt){
  // jika file GeoJSON tak sengaja ada teks tambahan (mis. "... ] bro tolong pelajari ini")
  // potong dari '[' pertama sampai ']' terakhir
  try{
    const s = txt.indexOf('['), e = txt.lastIndexOf(']');
    if(s>=0 && e>=0 && e>s) return JSON.parse(txt.slice(s, e+1));
    return JSON.parse(txt); // normal
  }catch(e){ throw e; }
}

function buildTableFromObj(obj, fields){
  const keys = fields && fields.length ? fields : Object.keys(obj||{});
  const html = (keys||[]).filter(k => k && k!=="Kd_Inf").map(k=>{
    const v=obj[k]; if(v==null || v==="") return "";
    return `<tr><td class="key">${k}</td><td>${v}</td></tr>`;
  }).join("");
  return `<table class="meta">${html || '<tr><td>(tidak ada data)</td></tr>'}</table>`;
}

function normalizeGas(json){
  if(json && json.lookup && json.rows) return json;
  let _rows = Array.isArray(json)? json : (json?.rows || Object.values(json.lookup||{}));
  const _headers = _rows.length ? Object.keys(_rows[0]) : [];
  return { rows:_rows, headers:_headers, lookup:Object.fromEntries(_rows.map(r=>[r.Kd_Inf, r])) };
}
function buildFixedGroups(headers){
  const g={};
  g["__ALL__"]=headers;
  g["Informasi"]=headers.slice(1,14);
  g["Area"]=headers.slice(14,19);
  g["Teknis"]=headers.slice(19,24);
  g["Saluran Primer"]=headers.slice(24,33);
  g["Saluran Sekunder"]=headers.slice(33,40);
  g["Hidrologi"]=headers.slice(40,42);
  g["Organisasi Petani"]=headers.slice(42,45);
  g["Manfaat"]=headers.slice(45,49);
  g["Tanggal Perubahan"]=headers.slice(49,50);
  return g;
}

/* ===== Load Data ===== */
Promise.all([
  fetch(GEOJSON_URL).then(async r=>{
    const ct = r.headers.get('content-type')||"";
    if(ct.includes('application/json')) return r.json();
    const txt = await r.text();
    return cleanMaybeWrappedJSON(txt); // handle file yang ada “noise”
  }),
  fetch(GAS_URL).then(r=>r.json()).catch(()=>null)
]).then(([gj, data])=>{
  // GAS optional
  if(data){
    const norm = normalizeGas(data);
    lookup=norm.lookup; rows=norm.rows; headers=norm.headers; groups=buildFixedGroups(headers);

    // Hindari duplikasi opsi "__ALL__" (sudah ada di HTML)
    Object.keys(groups)
      .filter(k => k !== '__ALL__')
      .forEach(k=>{
        clusterSel.insertAdjacentHTML('beforeend', `<option value="${k}">${k}</option>`);
      });

    const diNames=[...new Set(rows.map(r=>getNamaDI(r)).filter(Boolean))].sort();
    diNames.forEach(nm=>diSel.insertAdjacentHTML('beforeend',`<option value="${nm}">${nm}</option>`));
  }else{
    // Jika GAS gagal, sembunyikan filter cluster agar gak bingung
    clusterSel.innerHTML = `<option value="__ALL__">— Semua —</option>`;
  }

  // ==== Layer Bendung (Point) ====
  geoLayer = L.geoJSON(gj, {
    pointToLayer: (f, latlng) => L.circleMarker(latlng, {
      radius: 6,
      color: '#0d9488',
      weight: 1,
      fillColor: '#22c55e',
      fillOpacity: 0.9
    }),
    onEachFeature:(f, layer)=>{
      // ambil identitas
      const props = f.properties || {};
      // kunci join kalau ada (sesuaikan jika suatu saat bendung punya Kd_Inf)
      const key = String(props.Kd_Inf || props.id || '').trim();
      const title = getNamaDI(props) || key || 'Bendung';
      const latlng = layer.getLatLng?.();

      // simpan index
      joined.push({ layer, key, title, nama:title.toLowerCase(), dataObj: props, latlng });

      // popup ringkas
      const kab = props.kota_kabupaten || props.kabupaten || '';
      const prov = props.provinsi || '';
      layer.bindPopup(`
        <div style="font-size:13px">
          <b>${title}</b><br/>
          ${kab ? kab+', ' : ''}${prov}
        </div>
      `);

      // klik => buka detail
      layer.on('click', ()=>{
        activeKey = key || null;
        activeTitle = title;
        renderDetail();
      });
    }
  }).addTo(map);

  if(geoLayer.getLayers().length){
    try{
      map.fitBounds(geoLayer.getBounds());
    }catch(e){
      // kalau semua point sama, fitBounds bisa error — abaikan
    }
  }

  refreshView();
  detailEl.innerHTML='<i style="color:#cbd5e1">Klik titik bendung atau pilih DI untuk lihat detail.</i>';
}).catch(e=>{
  console.error(e);
  note('Gagal load data.');
});

/* ===== Renderers ===== */
function renderDetail(){
  // Prioritas: kalau ada join GAS berdasarkan activeKey, tampilkan grup cluster; kalau tidak, tampilkan atribut GeoJSON.
  const g = clusterSel.value || "__ALL__";

  // cari feature aktif
  let f = null;
  if(activeTitle){
    f = joined.find(o => o.title === activeTitle) || null;
  }
  const geoProps = f?.dataObj || {};

  // data GAS (join by Kd_Inf) kalau ada
  const infoGAS = (activeKey && lookup[activeKey]) ? lookup[activeKey] : null;

  const title = activeTitle || getNamaDI(infoGAS) || getNamaDI(geoProps) || (activeKey||'Detail');
  const keyLine = (activeKey ? `Kd_Inf: ${activeKey}` : (geoProps.id ? `ID: ${geoProps.id}` : ''));

  let tableHTML = '';
  if(infoGAS){
    const fields = (g==="__ALL__") ? headers : (groups[g]||headers);
    tableHTML = buildTableFromObj(infoGAS, fields);
  }else{
    // fallback: tampilkan atribut penting dari GeoJSON bendung
    const prefer = [
      'nama_infrastruktur','kewenangan','kode_balai','provinsi','kota_kabupaten',
      'kondisi_bangunan','status_infrastruktur','status_pemeliharaan',
      'tipe_infrastruktur','lebar_tubuh_bendung_m','tinggi_tubuh_bendung_m',
      'debit_andalan_m3dt','op_oleh'
    ].filter(k => k in geoProps);
    tableHTML = buildTableFromObj(geoProps, prefer);
  }

  detailEl.innerHTML = `
    <h3 style="margin:6px 0;color:#fff">${title}</h3>
    ${keyLine ? `<div style="font-size:12px;color:#cbd5e1;margin-bottom:6px">${keyLine}</div>` : ''}
    ${tableHTML}
  `;

  // center ke titik aktif
  if(f?.layer?.getLatLng){
    map.setView(f.layer.getLatLng(), Math.max(map.getZoom(), 12), { animate:true });
  }
}

function refreshView(){
  const sel = (diSel.value||"").toLowerCase();
  labelLayer.clearLayers();
  let total = 0;

  joined.forEach(o=>{
    // filter by DI (kalau dropdown kosong, tampilkan semua)
    const match = !sel || (o.nama === sel);
    const styleOn = { opacity:1, fillOpacity:0.9 };
    const styleOff = { opacity:0, fillOpacity:0 };

    if(o.layer.setStyle) o.layer.setStyle(match? styleOn : styleOff);
    if(match){
      total++;
      if (map.getZoom() >= 11) {
        addLabel(o.latlng, o.title);
      }
    }
  });

  statsEl.innerHTML = `<span>Total bendung tampil</span><b>${total}</b>`;
}

map.on('zoomend', refreshView);

/* ===== Events (Filter) ===== */
diSel.addEventListener('change', ()=>{
  const sel = (diSel.value||"").toLowerCase();
  refreshView();
  if(!sel){
    activeKey=null; activeTitle=null;
    detailEl.innerHTML='<i style="color:#cbd5e1">Pilih DI untuk lihat detail.</i>';
    map.fitBounds(geoLayer.getBounds());
    return;
  }
  const hit = joined.find(o => o.nama === sel);
  if(hit){
    activeKey = hit.key || null;
    activeTitle = hit.title;
    if(hit.layer.getLatLng){
      map.setView(hit.layer.getLatLng(), 12, { animate:true });
    }
    renderDetail();
  }
});

clusterSel.addEventListener('change', ()=>{
  renderDetail();
});
</script>
