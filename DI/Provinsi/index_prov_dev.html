<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Si-Irwan ‚Äî Daftar Provinsi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../assets/LogoPUPR.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1222; --panel:rgba(15,23,42,.92); --border:rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#94a3b8; --muted2:#cbd5e1;
      --brand:#0d47a1; --accent:#1d5fd1; --good:#22c55e; --bad:#f87171;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, rgba(11,18,34,.92), rgba(11,18,34,.65));
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px 14px;
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
      box-shadow:0 16px 40px rgba(0,0,0,.35);
    }
    .toprow{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btnBack{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--text);
      text-decoration:none;
      font-weight:900;
      cursor:pointer;
    }
    .btnBack:hover{background:rgba(255,255,255,.10)}
    .ttl{font-weight:900;font-size:16px;line-height:1.15}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .search{
      min-width:280px; flex:1;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted2);
      max-width:420px;
    }
    .search input{
      width:100%;
      border:none;outline:none;background:transparent;color:var(--text);
      font-size:13px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      color:var(--muted2);font-size:12px;font-weight:800;
      white-space:nowrap;
    }
    .state{margin-top:10px;color:var(--muted);font-size:12px}
    .state .err{color:var(--bad);font-weight:900}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:620px){.grid{grid-template-columns:1fr}.search{max-width:none}}
    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(2,6,23,.8));
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 48px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-40px -60px auto auto;
      width:160px;height:160px;
      background:radial-gradient(circle at 30% 30%, rgba(29,95,209,.55), rgba(29,95,209,0));
      transform:rotate(18deg);
    }
    .k1{color:var(--muted);font-size:12px;font-weight:800;position:relative}
    .k2{font-size:22px;font-weight:900;margin-top:6px;position:relative}
    .k3{display:flex;align-items:center;justify-content:space-between;margin-top:14px;gap:10px;position:relative}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(29,95,209,.15);
      border:1px solid rgba(29,95,209,.55);
      color:#dbeafe;
      padding:10px 12px;
      border-radius:12px;
      text-decoration:none;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{background:rgba(29,95,209,.24)}
    .muted{color:var(--muted);font-size:12px}
    .footerBadge{
      position:fixed; right:14px; bottom:14px; z-index:99;
      background:rgba(13,71,161,.85);
      border:1px solid rgba(255,255,255,.22);
      color:#fff; font-size:12px; font-weight:900;
      padding:8px 12px;border-radius:999px;
      box-shadow:0 0 18px rgba(13,71,161,.55);
      backdrop-filter:blur(8px);
      -webkit-backdrop-filter:blur(8px);
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="topbar">
      <div class="toprow">
        <div class="left">
          <a class="btnBack" href="../index.html">‚Üê Landing</a>
          <div>
            <div class="ttl" id="pageTitle">Daftar Provinsi</div>
            <div class="sub" id="pageSub">Memuat‚Ä¶</div>
            <div class="sub" id="debugParams" style="font-size:11px;color:#94a3b8;margin-top:4px"></div>
          </div>
        </div>

        <div class="search" title="Cari provinsi">
          üîé <input id="q" type="text" placeholder="Cari provinsi (misal: Aceh)" />
        </div>

        <div class="pill" id="pill">0 provinsi</div>
      </div>

      <div class="state" id="state"></div>
    </div>

    <div class="grid" id="grid">
      <!-- kartu provinsi -->
    </div>

  </div>

  <div class="footerBadge">Si-Irwan v1.0</div>

<script>
/* =============================
   KONFIGURASI
============================= */
const API_KEY = "AIzaSyDlpSnNEI__Z5OWinbf24BGJ4_U6JucNMs";

// next step nanti ke kabupaten (belum kita bikin sekarang)
// const KAB_PAGE = "../Kabupaten/index_kab_dev.html";

const $grid = document.getElementById("grid");
const $state = document.getElementById("state");
const $q = document.getElementById("q");
const $pill = document.getElementById("pill");
const $pageTitle = document.getElementById("pageTitle");
const $pageSub = document.getElementById("pageSub");
const $debug = document.getElementById("debugParams");

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function setState(msg, isErr=false){
  $state.innerHTML = isErr ? `<span class="err">${esc(msg)}</span>` : esc(msg);
}

function provCardHTML({name, id}){
  const prov = String(name || "").trim() || "Provinsi";
  // nanti link ke kabupaten:
  // const href = `${KAB_PAGE}?jenisId=${encodeURIComponent(jenisId)}&jenis=${encodeURIComponent(jenisName)}&provId=${encodeURIComponent(id)}&prov=${encodeURIComponent(prov)}`;
  const href = "#";
  return `
    <div class="card" data-name="${esc(prov.toLowerCase())}">
      <div class="k1">${esc(jenisName)}</div>
      <div class="k2">${esc(prov)}</div>
      <div class="k3">
        <a class="btn" href="${href}" onclick="alert('Next: halaman kabupaten + peta.'); return false;">Buka kabupaten ‚Üí</a>
        <div class="muted">Folder</div>
      </div>
    </div>
  `;
}

async function listFolders(parentId){
  const q = `('${parentId}' in parents) and trashed=false and mimeType='application/vnd.google-apps.folder'`;
  const url = "https://www.googleapis.com/drive/v3/files"
    + `?q=${encodeURIComponent(q)}`
    + "&fields=files(id,name,mimeType,modifiedTime)"
    + "&orderBy=name"
    + "&supportsAllDrives=true&includeItemsFromAllDrives=true"
    + `&key=${encodeURIComponent(API_KEY)}`;

  const res = await fetch(url);
  const json = await res.json();
  if(!res.ok){
    const msg = json?.error?.message || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return json.files || [];
}

/* ===== ambil parameter ===== */
const qs = new URLSearchParams(location.search);
const jenisId   = qs.get("jenisId") || qs.get("jenisID") || qs.get("jenis_id") || "";
const jenisName = qs.get("jenis")   || qs.get("jenisName") || "Jenis DI";

$debug.textContent = `jenisId=${jenisId || "(kosong)"} | jenis=${jenisName || "(kosong)"}`;

/* kalau param kosong ‚Üí redirect */
if(!jenisId){
  $pageTitle.textContent = "Daftar Provinsi";
  $pageSub.textContent = "Parameter kosong";
  setState("Parameter jenisId kosong. Anda akan diarahkan kembali ke landing‚Ä¶", true);
  setTimeout(()=>{ location.href = "../index.html"; }, 2000);
  throw new Error("jenisId kosong");
}

$pageTitle.textContent = "Daftar Provinsi";
$pageSub.textContent = `Jenis dipilih: ${jenisName}`;

let ALL = [];

function render(list){
  $grid.innerHTML = list.map(provCardHTML).join("");
  $pill.textContent = `${list.length} provinsi`;
}

function applyFilter(){
  const term = ($q.value || "").trim().toLowerCase();
  if(!term){
    render(ALL);
    return;
  }
  const filtered = ALL.filter(x => (x.name || "").toLowerCase().includes(term));
  render(filtered);
}

$q.addEventListener("input", applyFilter);

(async ()=>{
  try{
    setState("Mengambil folder provinsi dari Google Drive‚Ä¶");
    const items = await listFolders(jenisId);
    ALL = items;

    if(!items.length){
      setState("Folder jenis terbaca, tapi tidak ada subfolder provinsi. Cek struktur Drive di dalam jenis ini.", true);
      render([]);
      return;
    }

    setState(`Sukses. Pilih provinsi untuk lanjut ke kabupaten (next step).`);
    render(items);
  }catch(err){
    console.error(err);
    setState("Gagal memuat provinsi: " + err.message, true);
    render([]);
  }
})();
</script>

</body>
</html>
