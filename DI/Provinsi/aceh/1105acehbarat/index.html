<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DI Aceh Barat – PMTiles (BAKU/FUNG/POTS)</title>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <!-- PMTiles (global: pmtiles.*) -->
  <script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(10,16,28,.86);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf1ff;
      --muted:rgba(234,241,255,.7);
      --baku:#2dd36f;
      --fung:#3b82f6;
      --pots:#f59e0b;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    #map{position:fixed;inset:0}

    .panel{
      position:fixed; left:16px; bottom:16px;
      width:min(380px, calc(100vw - 32px));
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px 14px 12px;
      color:var(--text);
      box-shadow:0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .title{font-weight:800;font-size:18px;margin:0 0 2px}
    .subtitle{margin:0 0 12px;color:var(--muted);font-size:12.5px;line-height:1.35}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0}
    .chk{
      display:flex;align-items:center;gap:10px;font-weight:650;
      user-select:none;
    }
    .chk input{width:18px;height:18px;accent-color:#60a5fa}
    .pill{
      font-size:12px;font-weight:800;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:#0b1220;
    }
    .pill.baku{background:var(--baku)}
    .pill.fung{background:var(--fung); color:white}
    .pill.pots{background:var(--pots)}

    .btn{
      width:100%;
      margin-top:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.95));
      color:white;
      font-weight:850;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .status{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.4}
    .status b{color:var(--text)}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <p class="title" id="titleText">DI Aceh Barat</p>
    <p class="subtitle">PMTiles vector tiles (zoom max 14). Basemap: Esri World Imagery.</p>

    <div class="row">
      <label class="chk">
        <input id="chkBaku" type="checkbox" checked />
        BAKU
      </label>
      <span class="pill baku">Baku</span>
    </div>

    <div class="row">
      <label class="chk">
        <input id="chkFung" type="checkbox" checked />
        Fungsional
      </label>
      <span class="pill fung">FUNG</span>
    </div>

    <div class="row">
      <label class="chk">
        <input id="chkPots" type="checkbox" checked />
        Potensial
      </label>
      <span class="pill pots">POTS</span>
    </div>

    <button class="btn" id="btnFit">Fit ke Layer</button>

    <div class="status" id="statusBox">
      Status: <b>menyiapkan…</b>
      <div style="margin-top:6px">
        Pastikan file ada 1 folder dengan HTML ini:
        <br><b>aceh_barat_baku.pmtiles</b>, <b>aceh_barat_fung.pmtiles</b>, <b>aceh_barat_pots.pmtiles</b>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- CONFIG (ubah ini buat template provinsi lain) ----------
  const CFG = {
    title: "DI Aceh Barat",
    maxZoom: 14,
    // file pmtiles relatif 1 folder dengan index.html
    pmtiles: {
      baku: { url: "aceh_barat_baku.pmtiles", sourceLayer: "baku" },
      fung: { url: "aceh_barat_fung.pmtiles", sourceLayer: "fung" },
      pots: { url: "aceh_barat_pots.pmtiles", sourceLayer: "pots" },
    }
  };

  document.getElementById("titleText").textContent = CFG.title;

  const statusBox = document.getElementById("statusBox");
  const setStatus = (html) => { statusBox.innerHTML = html; };

  // ---------- PMTiles Protocol for MapLibre ----------
  // pmtiles docs: Protocol + addProtocol('pmtiles', ...)
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol("pmtiles", protocol.tile);

  // ---------- MapLibre Style (Imagery basemap + 3 vector sources) ----------
  const style = {
    version: 8,
    sources: {
      // Esri World Imagery (raster)
      esri: {
        type: "raster",
        tiles: [
          "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
        ],
        tileSize: 256,
        attribution: "Tiles © Esri"
      },

      baku: { type: "vector", url: "pmtiles://" + new URL(CFG.pmtiles.baku.url, location.href).href },
      fung: { type: "vector", url: "pmtiles://" + new URL(CFG.pmtiles.fung.url, location.href).href },
      pots: { type: "vector", url: "pmtiles://" + new URL(CFG.pmtiles.pots.url, location.href).href },
    },
    layers: [
      { id: "esri", type: "raster", source: "esri" },

      // BAKU
      {
        id: "baku-fill",
        type: "fill",
        source: "baku",
        "source-layer": CFG.pmtiles.baku.sourceLayer,
        paint: { "fill-color": "#2dd36f", "fill-opacity": 0.25 }
      },
      {
        id: "baku-line",
        type: "line",
        source: "baku",
        "source-layer": CFG.pmtiles.baku.sourceLayer,
        paint: { "line-color": "#2dd36f", "line-width": 1.2, "line-opacity": 0.9 }
      },

      // FUNG
      {
        id: "fung-fill",
        type: "fill",
        source: "fung",
        "source-layer": CFG.pmtiles.fung.sourceLayer,
        paint: { "fill-color": "#3b82f6", "fill-opacity": 0.25 }
      },
      {
        id: "fung-line",
        type: "line",
        source: "fung",
        "source-layer": CFG.pmtiles.fung.sourceLayer,
        paint: { "line-color": "#3b82f6", "line-width": 1.2, "line-opacity": 0.9 }
      },

      // POTS
      {
        id: "pots-fill",
        type: "fill",
        source: "pots",
        "source-layer": CFG.pmtiles.pots.sourceLayer,
        paint: { "fill-color": "#f59e0b", "fill-opacity": 0.25 }
      },
      {
        id: "pots-line",
        type: "line",
        source: "pots",
        "source-layer": CFG.pmtiles.pots.sourceLayer,
        paint: { "line-color": "#f59e0b", "line-width": 1.2, "line-opacity": 0.9 }
      },
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [96.05, 4.45],
    zoom: 8,
    maxZoom: CFG.maxZoom,
    attributionControl: true
  });

  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), "top-left");

  // ---------- Helpers ----------
  function setVisible(layerIds, visible){
    for(const id of layerIds){
      if(!map.getLayer(id)) continue;
      map.setLayoutProperty(id, "visibility", visible ? "visible" : "none");
    }
  }

  function hookToggle(chkId, layerIds){
    const el = document.getElementById(chkId);
    el.addEventListener("change", ()=> setVisible(layerIds, el.checked));
  }

  hookToggle("chkBaku", ["baku-fill","baku-line"]);
  hookToggle("chkFung", ["fung-fill","fung-line"]);
  hookToggle("chkPots", ["pots-fill","pots-line"]);

  // Fit bounds dari header PMTiles (pakai BAKU sebagai acuan)
  async function fitToData(){
    try{
      const p = new pmtiles.PMTiles(new URL(CFG.pmtiles.baku.url, location.href).href);
      // protocol pakai cache internal, tapi aman register juga:
      protocol.add(p);

      const h = await p.getHeader();
      const bounds = [[h.minLon, h.minLat],[h.maxLon, h.maxLat]];
      map.fitBounds(bounds, { padding: 60, duration: 600, maxZoom: CFG.maxZoom });
    }catch(e){
      console.warn(e);
      // fallback: jangan crash
      map.easeTo({ zoom: 8, duration: 300 });
    }
  }

  document.getElementById("btnFit").addEventListener("click", fitToData);

  map.on("load", async ()=>{
    try{
      await fitToData();
      setStatus(`Status: <b>siap (PMTiles OK)</b>
        <div style="margin-top:6px">Layer aktif: BAKU, FUNG, POTS</div>`);
    }catch(e){
      setStatus(`Status: <b>error</b><div style="margin-top:6px">${String(e)}</div>`);
    }
  });

})();
</script>
</body>
</html>
