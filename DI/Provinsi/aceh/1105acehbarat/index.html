<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DI Aceh Barat (PMTiles)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- VectorGrid (for protobuf vector tiles) -->
  <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:rgba(10,18,35,.82); --line:rgba(255,255,255,.10);
      --text:#e7eefc; --muted:#a9b7d3;
      --baku:#22c55e; --fung:#3b82f6; --pots:#f59e0b;
    }
    html,body{height:100%;margin:0;background:#050a14;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #map{height:100%;width:100%}

    /* Panel */
    .panel{
      position:absolute; left:18px; bottom:18px;
      width:min(360px, calc(100% - 36px));
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px 12px;
      color:var(--text);
      box-shadow:0 16px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .title{font-weight:800;font-size:18px;letter-spacing:.2px;margin:2px 2px 10px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 2px}
    .left{display:flex;align-items:center;gap:10px}
    .badge{font-weight:800;font-size:12px;padding:3px 10px;border-radius:999px;color:#06101f}
    .badge.baku{background:var(--baku)}
    .badge.fung{background:var(--fung)}
    .badge.pots{background:var(--pots)}
    .chk{width:18px;height:18px;accent-color:#4f8cff}
    .name{font-size:14px;color:var(--text)}
    .btn{
      margin-top:10px; width:100%;
      background:linear-gradient(135deg,#2b6fff,#1d4ed8);
      color:white; border:none; padding:12px 14px;
      border-radius:12px; font-weight:800;
      cursor:pointer;
    }
    .btn:active{transform: translateY(1px);}
    .note{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status b{color:var(--text)}
    .topbar{
      position:absolute; left:18px; top:18px;
      background:rgba(10,18,35,.65);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      z-index: 9999;
      backdrop-filter: blur(10px);
      max-width:min(520px, calc(100% - 36px));
    }
    .topbar .small{font-size:12px;color:var(--muted)}
    .leaflet-control-attribution{opacity:.85}
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="topbar">
    <div style="font-weight:800">DI Aceh Barat</div>
    <div class="small">PMTiles vector tiles (zoom max 14). Basemap: Esri World Imagery.</div>
  </div>

  <div class="panel">
    <div class="title">DI Aceh Barat</div>

    <div class="row">
      <div class="left">
        <input id="chkBAKU" class="chk" type="checkbox" checked>
        <div class="name">BAKU</div>
      </div>
      <span class="badge baku">Baku</span>
    </div>

    <div class="row">
      <div class="left">
        <input id="chkFUNG" class="chk" type="checkbox" checked>
        <div class="name">Fungsional</div>
      </div>
      <span class="badge fung">FUNG</span>
    </div>

    <div class="row">
      <div class="left">
        <input id="chkPOTS" class="chk" type="checkbox" checked>
        <div class="name">Potensial</div>
      </div>
      <span class="badge pots">POTS</span>
    </div>

    <button id="btnFit" class="btn">Fit ke Layer</button>

    <div class="note">
      Pastikan file ada 1 folder dengan HTML ini:
      <b>aceh_barat_baku.pmtiles</b>, <b>aceh_barat_fung.pmtiles</b>, <b>aceh_barat_pots.pmtiles</b>
    </div>

    <div id="status" class="status">Status: <b>siap</b></div>
  </div>

  <!-- IMPORTANT: use type="module" to avoid "Unexpected token export" -->
  <script type="module">
    import { Protocol } from "https://unpkg.com/pmtiles@3.0.6/dist/index.js";

    // ---- 1) Map
    const map = L.map("map", { zoomControl: true, preferCanvas: true })
      .setView([4.45, 96.05], 9);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Leaflet | Â© Esri" }
    ).addTo(map);

    // ---- 2) PMTiles protocol => we convert pmtiles:// URL into tile endpoint for VectorGrid
    // pmtiles Protocol exposes a tile handler; easiest approach: create a small local tile URL wrapper.
    const protocol = new Protocol();

    // A tiny "virtual" tile URL endpoint: VectorGrid will call this URL,
    // we intercept via fetch override. We'll just build a URL that we can recognize.
    const PMT_PREFIX = "pmt://";

    const statusEl = document.getElementById("status");
    function setStatus(msg){ statusEl.innerHTML = "Status: <b>" + msg + "</b>"; }

    // Intercept fetch so leaflet-vectorgrid can request "pmt://..." URLs
    // and we answer them with pmtiles bytes.
    const realFetch = window.fetch.bind(window);
    window.fetch = async (input, init) => {
      const url = (typeof input === "string") ? input : input.url;

      if (url.startsWith(PMT_PREFIX)) {
        // format: pmt://<pmtiles-file>|<z>/<x>/<y>.pbf
        // example: pmt://./aceh_barat_baku.pmtiles|12/3456/2345.pbf
        try {
          const [pmtUrl, zxy] = url.slice(PMT_PREFIX.length).split("|");
          const parts = zxy.replace(".pbf","").split("/");
          const z = parseInt(parts[0],10), x = parseInt(parts[1],10), y = parseInt(parts[2],10);

          const resp = await protocol.tile(pmtUrl, z, x, y);
          // protocol.tile returns a Response already in recent versions
          // but if it returns bytes, wrap it.
          if (resp instanceof Response) return resp;

          return new Response(resp.data || resp, {
            status: 200,
            headers: { "Content-Type":"application/x-protobuf" }
          });
        } catch (e) {
          return new Response("tile error", { status: 404 });
        }
      }

      return realFetch(input, init);
    };

    // helper: build tile URL for a given pmtiles file
    function pmtTileUrl(pmtilesFile){
      // leaflet-vectorgrid will replace {z}/{x}/{y}
      return `${PMT_PREFIX}${pmtilesFile}|{z}/{x}/{y}.pbf`;
    }

    // ---- 3) Build VectorGrid layers
    function makeLayer({pmtilesFile, layerName, style}){
      return L.vectorGrid.protobuf(pmtTileUrl(pmtilesFile), {
        maxNativeZoom: 14,   // your request
        maxZoom: 19,
        interactive: true,
        vectorTileLayerStyles: {
          [layerName]: style
        },
        getFeatureId: f => {
          // stable id (optional)
          return f.properties?.ID || f.properties?.id || JSON.stringify(f.properties);
        }
      });
    }

    // Styles (poligon only)
    const styleBAKU = { weight: 1, color: "#22c55e", fill: true, fillOpacity: 0.45 };
    const styleFUNG = { weight: 1, color: "#3b82f6", fill: true, fillOpacity: 0.45 };
    const stylePOTS = { weight: 1, color: "#f59e0b", fill: true, fillOpacity: 0.45 };

    // IMPORTANT: layerName MUST match tippecanoe -l value
    // If you built with -l baku / -l fung / -l pots, keep these exactly.
    const lyrBAKU = makeLayer({
      pmtilesFile: "./aceh_barat_baku.pmtiles",
      layerName: "baku",
      style: styleBAKU
    });
    const lyrFUNG = makeLayer({
      pmtilesFile: "./aceh_barat_fung.pmtiles",
      layerName: "fung",
      style: styleFUNG
    });
    const lyrPOTS = makeLayer({
      pmtilesFile: "./aceh_barat_pots.pmtiles",
      layerName: "pots",
      style: stylePOTS
    });

    // Popup on click
    function bindPopup(layer, label){
      layer.on("click", (e) => {
        const p = e.layer?.properties || {};
        const title = p.Nm_Inf || p.Nama_DI || p.NAMA || label;
        const rows = Object.keys(p).slice(0, 20).map(k => `<tr><td style="padding:4px 8px;color:#9fb0d0">${k}</td><td style="padding:4px 8px;color:#e7eefc">${String(p[k])}</td></tr>`).join("");
        const html = `
          <div style="min-width:260px">
            <div style="font-weight:800;margin:0 0 6px">${title}</div>
            <div style="font-size:12px;color:#9fb0d0;margin-bottom:8px">${label}</div>
            <div style="max-height:220px;overflow:auto;border:1px solid rgba(0,0,0,.12);border-radius:10px">
              <table style="border-collapse:collapse;width:100%">${rows}</table>
            </div>
          </div>
        `;
        L.popup({ maxWidth: 520 }).setLatLng(e.latlng).setContent(html).openOn(map);
      });
    }
    bindPopup(lyrBAKU, "BAKU");
    bindPopup(lyrFUNG, "FUNG");
    bindPopup(lyrPOTS, "POTS");

    // ---- 4) Toggle UI
    const chkBAKU = document.getElementById("chkBAKU");
    const chkFUNG = document.getElementById("chkFUNG");
    const chkPOTS = document.getElementById("chkPOTS");
    const btnFit  = document.getElementById("btnFit");

    function applyToggles(){
      const wantBAKU = chkBAKU.checked;
      const wantFUNG = chkFUNG.checked;
      const wantPOTS = chkPOTS.checked;

      if (wantBAKU && !map.hasLayer(lyrBAKU)) lyrBAKU.addTo(map);
      if (!wantBAKU && map.hasLayer(lyrBAKU)) map.removeLayer(lyrBAKU);

      if (wantFUNG && !map.hasLayer(lyrFUNG)) lyrFUNG.addTo(map);
      if (!wantFUNG && map.hasLayer(lyrFUNG)) map.removeLayer(lyrFUNG);

      if (wantPOTS && !map.hasLayer(lyrPOTS)) lyrPOTS.addTo(map);
      if (!wantPOTS && map.hasLayer(lyrPOTS)) map.removeLayer(lyrPOTS);
    }

    chkBAKU.addEventListener("change", applyToggles);
    chkFUNG.addEventListener("change", applyToggles);
    chkPOTS.addEventListener("change", applyToggles);

    // default on
    applyToggles();

    // ---- 5) Fit Bounds (when tiles already loaded, bounds estimation is tricky)
    // We'll fit to an approximate area by listening for first tile load and then use bounds from clicked features.
    // Better: store bbox in a small JSON file or hardcode for the region.
    // For now, we use a safe initial bbox around Aceh Barat.
    const fallbackBounds = L.latLngBounds(
      L.latLng(4.00, 95.40),
      L.latLng(4.85, 96.55)
    );

    btnFit.addEventListener("click", () => {
      setStatus("fit bounds");
      map.fitBounds(fallbackBounds, { padding: [30, 30] });
      setTimeout(()=>setStatus("siap"), 600);
    });

    // Quick sanity check: try fetch a single tile (won't crash if 404 at some zoom)
    (async () => {
      try {
        setStatus("cek file PMTiles...");
        // request one likely tile at current view
        const z = Math.min(12, map.getZoom());
        const c = map.getCenter();
        // fake request just to ensure fetch interception works
        await fetch(`${PMT_PREFIX}./aceh_barat_baku.pmtiles|${z}/0/0.pbf`);
        setStatus("siap (PMTiles OK)");
      } catch (e) {
        setStatus("PMTiles belum kebaca (cek nama file / lokasi)");
      }
    })();
  </script>
</body>
</html>
