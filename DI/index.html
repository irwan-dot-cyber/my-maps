<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard DI â€” PMTiles (Template)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="../../assets/LogoPUPR.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --muted:#cbd5e1; --muted-2:#94a3b8;
      --survey:#0d47a1; --accent:#1d5fd1; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:80px; --radius:12px;
    }
    html, body {
      height:100%; margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text)
    }

    .header{
      position:fixed; top:0; left:0; right:0; z-index:900;
      background:var(--survey);
      border-bottom:1px solid rgba(255,255,255,.18);
      padding:8px 12px;
      display:flex; align-items:center; gap:10px;
      box-shadow:0 6px 18px rgba(13,71,161,.25)
    }
    .header img{height:44px}
    .header .text{flex:1; color:#fff}
    .header .title{font-weight:800; font-size:13px; line-height:1.3}
    .header .subtitle{font-weight:600; font-size:11px; color:rgba(255,255,255,.9); margin-top:2px}
    .btn-home{
      background:#fff; color:var(--survey);
      font-weight:700; padding:6px 12px;
      border-radius:10px; text-decoration:none; font-size:11px;
      white-space:nowrap;
    }
    .btn-home:hover{background:#f1f5f9}
    .spacer{height:var(--hdrH)}
    #map{
      height:calc(100vh - var(--hdrH));
      position:relative;
      z-index:1;
    }

    .dock{
      position:fixed; left:0; right:0; bottom:0;
      background:var(--panel); border-top:1px solid var(--border);
      max-height:46vh; padding:8px 12px;
      box-shadow:0 -10px 22px rgba(0,0,0,.28);
      z-index:950; backdrop-filter:blur(6px);
      display:flex; flex-direction:column; gap:6px;
      transition:max-height .2s ease, padding .2s ease;
    }
    .dock-header{
      display:flex; align-items:center; justify-content:space-between;
    }
    .dock-header h2{
      font-size:14px; margin:0; font-weight:800; color:#fff;
    }
    .dock-toggle{
      background:rgba(15,23,42,.9);
      border:1px solid var(--border);
      border-radius:999px;
      color:#e5e7eb;
      font-size:11px;
      padding:2px 10px;
      cursor:pointer;
    }
    .dock-toggle:hover{background:#111827}
    .dock-body{font-size:12px;}
    .dock.collapsed{
      max-height:40px;
      padding-top:6px;
      padding-bottom:6px;
    }
    .dock.collapsed .dock-body{display:none;}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    label{font-size:11px; color:var(--muted)}
    select{
      width:100%; padding:8px 10px; font-size:13px;
      background:rgba(255,255,255,.06); color:#fff;
      border:1px solid var(--border); border-radius:var(--radius);
      outline:none; appearance:none
    }
    option{color:#000; background:#fff}
    .meta{font-size:12px; border-collapse:collapse; width:100%; color:var(--text)}
    .meta td{border-bottom:1px dashed rgba(255,255,255,.08); padding:4px 2px}
    .key{color:var(--muted-2); width:42%}
    .row{
      display:grid; grid-template-columns:1fr auto 1fr auto;
      gap:8px; font-size:12px; color:var(--muted)
    }
    .row b{color:#fff}
    .err{color:#fca5a5; font-size:11px; margin-top:4px}

    @media(max-width:680px){
      .grid{grid-template-columns:1fr}
      :root{--hdrH:88px}
    }

    .badge-irwan{
      position:fixed; right:12px; bottom:92px; z-index:1200;
      background:rgba(13,71,161,.85);
      border:1px solid rgba(255,255,255,.25);
      color:#fff; font-size:11px; font-weight:700;
      padding:5px 10px; border-radius:10px;
      box-shadow:0 0 10px rgba(13,71,161,.6);
      backdrop-filter:blur(6px);
      animation:glow 2.8s ease-in-out infinite
    }
    .badge-irwan span{color:#FFD700}
    .badge-irwan:hover{transform:scale(1.03); transition:transform .2s ease}
    @keyframes glow{
      0%,100%{box-shadow:0 0 8px rgba(13,71,161,.6)}
      50%{box-shadow:0 0 18px rgba(255,215,0,.8)}
    }

    .myloc-btn{
      width:32px;
      height:32px;
      border:none;
      background:rgba(15,23,42,.96);
      color:#e5e7eb;
      font-size:16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:4px;
    }
    .myloc-btn:hover{background:#111827}

    .layer-legend{
      background:rgba(15,23,42,.95);
      color:#f9fafb;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid rgba(148,163,184,.6);
      font-size:11px;
      min-width:160px;
    }
    .layer-legend-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .layer-legend-title{font-weight:800;}
    .layer-toggle-btn{
      background:transparent;
      border:1px solid rgba(148,163,184,.8);
      color:#e5e7eb;
      border-radius:999px;
      font-size:10px;
      padding:0 6px;
      cursor:pointer;
    }
    .layer-legend-body .item{
      display:flex;
      align-items:center;
      gap:6px;
      margin:4px 0;
    }
    .layer-legend .swatch{
      width:12px; height:12px;
      border-radius:3px;
      border:1px solid rgba(255,255,255,.7);
    }
    .swatch-baku{background:#22c55e}
    .swatch-fung{background:#60a5fa}
    .swatch-pots{background:#fbbf24}
    .swatch-di{background:#a855f7}
    .layer-legend input[type="checkbox"]{
      margin:0;
      width:12px;
      height:12px;
    }
    .layer-legend.collapsed .layer-legend-body{display:none;}

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-size:11px;
      color:#e5e7eb;
      margin-left:6px;
    }
    .btn-primary{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn-primary:hover{background:#2563eb}
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <img src="../../assets/LogoPUPR.png" alt="Logo PU"/>
    <div class="text">
      <div class="title">Kementerian PU</div>
      <div class="subtitle">Ditjen SDA Â· Dit. Irigasi &amp; Rawa</div>
      <div class="subtitle">Dashboard PMTiles <b>(1 Template)</b></div>
    </div>
    <a href="../../si-irwan.html" class="btn-home">Beranda</a>
  </div>
  <div class="spacer"></div>

  <!-- MAP -->
  <div id="map"></div>

  <!-- DOCK -->
  <div class="dock" id="dock">
    <div class="dock-header">
      <h2>Dashboard Daerah Irigasi <span class="pill" id="pillStatus">PMTiles</span></h2>
      <button id="dockToggle" class="dock-toggle">Ciutkan</button>
    </div>

    <div class="dock-body" id="dockBody">
      <div class="grid">
        <div>
          <label for="diSel">Pilih Paket / Area (group dari manifest)</label>
          <select id="diSel">
            <option value="">Memuat manifestâ€¦</option>
          </select>
        </div>
        <div>
          <label for="clusterSel">Filter Type</label>
          <select id="clusterSel">
            <option value="__ALL__">â€” Semua â€”</option>
            <option value="BAKU">BAKU</option>
            <option value="FUNG">Fungsional</option>
            <option value="POTS">Potensial</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button class="btn-primary" id="btnShow">Tampilkan</button>
        <button class="btn-primary" id="btnFit" style="background:#0ea5e9">Fit to Layer</button>
      </div>

      <div id="msg" class="err"></div>

      <hr style="border:none;border-top:1px solid var(--border);margin:8px 0"/>

      <div id="stats" class="row"></div>
      <div id="detail" style="margin-top:6px;font-size:12px"></div>
    </div>
  </div>

  <!-- BADGE -->
  <div class="badge-irwan" title="Sistem Informasi Irigasi & Rawa Nasional">
    <span>Si-Irwan v1.0</span>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/protomaps@latest/dist/protomaps.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // ====== KONFIG ======
    const MANIFEST_URL = "./manifest.json";   // harus satu folder dengan HTML ini
    const DEFAULT_VIEW = { lat: -2.5, lng: 118, zoom: 5 };

    // ====== ELEMEN UI ======
    const diSel      = document.getElementById('diSel');
    const clusterSel = document.getElementById('clusterSel');
    const statsEl    = document.getElementById('stats');
    const detailEl   = document.getElementById('detail');
    const msgEl      = document.getElementById('msg');
    const pillStatus = document.getElementById('pillStatus');
    const btnShow    = document.getElementById('btnShow');
    const btnFit     = document.getElementById('btnFit');

    const dock        = document.getElementById('dock');
    const dockToggle  = document.getElementById('dockToggle');

    const note = (m)=>{ msgEl.textContent = m || ""; };

    // ====== MAP ======
    const map = L.map('map').setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);

    const imagery = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution:'Tiles Â© Esri â€” Source: Esri, Maxar, Earthstar Geographics' }
    ).addTo(map);

    const osm = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution:'Â© OpenStreetMap contributors' }
    );

    L.control.layers({"Imagery": imagery, "OSM": osm}, null, { collapsed:true, position:'topright' }).addTo(map);

    // ====== DOCK TOGGLE ======
    let dockCollapsed = false;
    dockToggle.addEventListener('click', () => {
      dockCollapsed = !dockCollapsed;
      dock.classList.toggle('collapsed', dockCollapsed);
      dockToggle.textContent = dockCollapsed ? 'Tampilkan' : 'Ciutkan';
    });

    // ====== MY LOCATION CONTROL ======
    let myLocMarker = null;
    let myLocCircle = null;

    const MyLocationControl = L.Control.extend({
      position: 'topright',
      onAdd: function(map){
        const container = L.DomUtil.create('div','leaflet-bar');
        const btn = L.DomUtil.create('button','myloc-btn',container);
        btn.type='button';
        btn.innerHTML='ðŸ“';
        btn.title='Lokasi saya';
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(btn,'click',function(){
          if (!navigator.geolocation) {
            note('Browser tidak mendukung geolokasi.');
            return;
          }
          note('Mencari lokasi Anda...');
          navigator.geolocation.getCurrentPosition(
            (pos)=>{
              const lat = pos.coords.latitude;
              const lng = pos.coords.longitude;
              const acc = pos.coords.accuracy || 0;
              const latlng=[lat,lng];

              if (!myLocMarker) myLocMarker = L.marker(latlng).addTo(map).bindPopup('Lokasi saya');
              else myLocMarker.setLatLng(latlng);

              if (acc && !isNaN(acc)) {
                if (!myLocCircle) {
                  myLocCircle = L.circle(latlng,{ radius:acc, color:'#38bdf8', weight:1, fillOpacity:0.15 }).addTo(map);
                } else {
                  myLocCircle.setLatLng(latlng);
                  myLocCircle.setRadius(acc);
                }
              }

              map.setView(latlng, Math.max(map.getZoom(), 15));
              note('');
              myLocMarker.openPopup();
            },
            (err)=> note('Gagal mendapatkan lokasi: ' + err.message),
            { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
          );
        });
        return container;
      }
    });
    map.addControl(new MyLocationControl());

    // ====== PMTILES LAYER MANAGER ======
    const activeLayers = [];
    let lastBounds = null;

    function clearLayers(){
      lastBounds = null;
      while(activeLayers.length){
        const lyr = activeLayers.pop();
        map.removeLayer(lyr);
      }
    }

    // style per type (warna beda)
    function paintRulesForType(type){
      // protomaps style: symbolizer polygon untuk beberapa kemungkinan dataLayer
      // dataLayer default tippecanoe = layer name (-l). Kalau kamu pakai -l baku/fung/pots (lowercase) ini aman.
      // Kalau layer name beda, tetap kebaca tapi styling bisa default. Jadi konsistenin layer name waktu konversi.
      let fill = "#a855f7", stroke = "#c084fc"; // fallback (ungu)
      if (type === "BAKU") { fill = "#22c55e"; stroke = "#16a34a"; }
      if (type === "FUNG") { fill = "#60a5fa"; stroke = "#2563eb"; }
      if (type === "POTS") { fill = "#fbbf24"; stroke = "#f59e0b"; }

      return [
        { dataLayer: "baku", symbolizer: new protomaps.PolygonSymbolizer({ fill, opacity: 0.35, stroke, width: 1 }) },
        { dataLayer: "fung", symbolizer: new protomaps.PolygonSymbolizer({ fill, opacity: 0.35, stroke, width: 1 }) },
        { dataLayer: "pots", symbolizer: new protomaps.PolygonSymbolizer({ fill, opacity: 0.35, stroke, width: 1 }) },

        // fallback layer name kalau ternyata layer bukan baku/fung/pots
        { dataLayer: "di",   symbolizer: new protomaps.PolygonSymbolizer({ fill, opacity: 0.35, stroke, width: 1 }) },
      ];
    }

    function addPmtilesLayer(fileUrl, type, label){
      const layer = protomaps.leafletLayer({
        url: fileUrl,
        paint_rules: paintRulesForType(type)
      });

      // simpan bounds saat tile pertama load (biar Fit to Layer enak)
      layer.on("tileload", (e) => {
        // protomaps leaflet layer expose bounds internal? nggak standar.
        // kita ambil bounds dari map view + tile, jadi pendekatan praktis: set lastBounds = map.getBounds() setelah load awal.
        if (!lastBounds) lastBounds = map.getBounds();
      });

      layer.addTo(map);
      activeLayers.push(layer);

      detailEl.innerHTML = `
        <div style="font-weight:800; margin-bottom:4px; color:#fff">${label}</div>
        <div style="font-size:12px; color:#cbd5e1">
          Sumber: <b>PMTiles</b> Â· File: <code style="color:#93c5fd">${fileUrl}</code> Â· Type: <b>${type}</b>
        </div>
        <div style="font-size:11px; color:#94a3b8; margin-top:6px">
          Tips: kalau warna belum kena, pastikan waktu konversi kamu pakai layer name <b>-l baku / fung / pots</b> (lowercase).
        </div>
      `;
    }

    function updateStats(){
      statsEl.innerHTML = `
        <span>Aktif layer</span><b>${activeLayers.length}</b>
        <span>Mode</span><b>PMTiles</b>
      `;
    }

    // ====== LEGEND CONTROL ======
    const LayerLegendControl = L.Control.extend({
      position:'topright',
      onAdd:function(map){
        const container = L.DomUtil.create('div','layer-legend');
        container.innerHTML = `
          <div class="layer-legend-header">
            <span class="layer-legend-title">Legend</span>
            <button type="button" class="layer-toggle-btn">Ciut</button>
          </div>
          <div class="layer-legend-body">
            <div class="item">
              <span class="swatch swatch-baku"></span><span>BAKU</span>
            </div>
            <div class="item">
              <span class="swatch swatch-fung"></span><span>Fungsional</span>
            </div>
            <div class="item">
              <span class="swatch swatch-pots"></span><span>Potensial</span>
            </div>
            <div class="item" style="margin-top:6px; opacity:.9">
              <span class="swatch swatch-di"></span><span>Fallback</span>
            </div>
          </div>
        `;
        L.DomEvent.disableClickPropagation(container);

        const toggleBtn = container.querySelector('.layer-toggle-btn');
        let collapsed=false;
        toggleBtn.addEventListener('click',()=>{
          collapsed=!collapsed;
          if(collapsed){
            container.classList.add('collapsed');
            toggleBtn.textContent='Tampil';
          }else{
            container.classList.remove('collapsed');
            toggleBtn.textContent='Ciut';
          }
        });

        return container;
      }
    });
    map.addControl(new LayerLegendControl());

    // ====== LOAD MANIFEST ======
    let items = [];
    try{
      pillStatus.textContent = "Load manifestâ€¦";
      const res = await fetch(MANIFEST_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      items = (data && data.items) ? data.items : [];
      if(!items.length) throw new Error("manifest kosong");
      pillStatus.textContent = "PMTiles OK";
    }catch(e){
      pillStatus.textContent = "Error";
      note("Gagal load manifest.json. Pastikan manifest.json ada di folder yang sama dan valid JSON.");
      diSel.innerHTML = `<option value="">(manifest.json tidak terbaca)</option>`;
      detailEl.innerHTML = `<i style="color:#cbd5e1">Taruh <b>manifest.json</b> di folder yang sama dengan HTML ini.</i>`;
      updateStats();
      return;
    }

    // isi dropdown group
    const groups = [...new Set(items.map(x => x.group).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    diSel.innerHTML = `<option value="">â€” Pilih Paket â€”</option>` + groups
      .map(g => `<option value="${g}">${g.replaceAll("_"," ")}</option>`)
      .join("");

    // ====== RENDER FUNCTION ======
    function render(){
      note("");
      clearLayers();

      const group = diSel.value;
      const type  = clusterSel.value;

      if(!group){
        detailEl.innerHTML = `<i style="color:#cbd5e1">Pilih paket/area dulu (dropdown kiri).</i>`;
        updateStats();
        return;
      }

      const selected = items.filter(x =>
        x.group === group && (type === "__ALL__" || x.type === type)
      );

      if(!selected.length){
        note("Tidak ada PMTiles yang cocok untuk pilihan ini.");
        detailEl.innerHTML = `<i style="color:#cbd5e1">Coba ganti filter type atau cek manifest.json.</i>`;
        updateStats();
        return;
      }

      // tampilkan semua file yang match (mis. BAKU+FUNG+POTS)
      selected.forEach(it => {
        const fileUrl = "./" + it.file; // karena satu folder
        const label = it.title || it.file;
        addPmtilesLayer(fileUrl, it.type || "OTHER", label);
      });

      updateStats();
    }

    // Fit to Layer (best-effort)
    btnFit.addEventListener('click', () => {
      if (lastBounds) {
        map.fitBounds(lastBounds);
        note("");
        return;
      }
      // fallback kalau bounds belum kebaca
      note("Belum ada bounds. Coba zoom/geser dulu setelah layer tampil.");
    });

    btnShow.addEventListener('click', render);
    diSel.addEventListener('change', render);
    clusterSel.addEventListener('change', render);

    // initial
    detailEl.innerHTML = `
      <i style="color:#cbd5e1">
        Pilih paket/area untuk menampilkan PMTiles.
        <br/>Sumber data diambil dari <b>manifest.json</b> (folder yang sama).
      </i>
    `;
    updateStats();
  });
  </script>
</body>
</html>
