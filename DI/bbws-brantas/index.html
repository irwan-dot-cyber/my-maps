<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>BBWS Brantas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#0b1222; --text:#e5e7eb; --panel:rgba(11,18,34,.92);
      --border:rgba(255,255,255,.12); --hdrH:64px; --brand:#0d47a1; --brand2:#123b88;
    }
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    /* Header seperti landing page */
    .header{
      position:fixed;left:0;right:0;top:0;height:var(--hdrH);z-index:900;
      display:flex;align-items:center;gap:12px;padding:10px 14px;
      background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;
      border-bottom:1px solid rgba(255,255,255,.12)
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px;object-fit:contain;filter:drop-shadow(0 2px 2px rgba(0,0,0,.2))}
    .title{font-weight:800;font-size:14px;line-height:1.2}
    .subtitle{font-size:12px;opacity:.9}
    .spacer{height:var(--hdrH)}
    #map{height:calc(100vh - var(--hdrH) - 160px)}
    .dock{position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--border);padding:12px 14px;z-index:950}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .btn{background:#1d5fd1;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#cbd5e1;margin-top:6px}
    /* Label nama bendung (tanpa background, halo) */
    .lbl{pointer-events:none}
    .lbl span{
      font-size:12px;font-weight:800;letter-spacing:.1px;color:#f8fafc;
      text-shadow:
        0 0 2px rgba(0,0,0,.6),
        0 1px 2px rgba(0,0,0,.6),
        -1px 0 2px rgba(0,0,0,.6),
        1px 0 2px rgba(0,0,0,.6);
      white-space:nowrap
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <img src="assets/LogoPUPR.png" alt="PUPR"/>
      <div>
        <div class="title">BBWS Brantas Bendung</div>
        <div class="subtitle">Klik titik ‚Üí Street View (fallback: tampak atas)</div>
      </div>
    </div>
  </div>
  <div class="spacer"></div>

  <div id="map"></div>

  <div class="dock">
    <div class="row">
      <div id="info"><i style="color:#cbd5e1">Belum ada bendung dipilih.</i></div>
      <button id="btnSV" class="btn" disabled>üëÅÔ∏è Buka Google</button>
    </div>
    <div class="hint">Data: <code>bendung_brantas.geojson</code> ‚Äî kolom: <code>NAMA/N_ASET</code>, <code>N_DI</code>, <code>KEWENANGAN</code></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DATA_URL = './bendung_brantas.geojson';
    const map = L.map('map', { preferCanvas:true }).setView([-7.8,112.0], 9);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
      attribution:'Tiles ¬© Esri ‚Äî Source: Esri, Maxar'
    }).addTo(map);

    const infoEl = document.getElementById('info');
    const btnSV  = document.getElementById('btnSV');
    let lastLat = null, lastLon = null;

    // URL builders
    function svUrl(lat, lon){
      // Street View langsung (kalau ada)
      return `https://www.google.com/maps?layer=c&cbll=${lat},${lon}`;
    }
    function mapTopDownUrl(lat, lon){
      // Tampilan atas (satellite), zoom 18
      return `https://www.google.com/maps?q=${lat},${lon}&t=k&z=18`;
    }

    // Cek ketersediaan Street View (tanpa API key).
    // Jika gagal (CORS/time out) ‚Üí anggap tidak ada & fallback ke tampak atas.
    async function probeStreetView(lat, lon, timeoutMs = 2000){
      const u = `https://cbks0.googleapis.com/cbk?output=json&ll=${lat},${lon}`;
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), timeoutMs);
        const r = await fetch(u, { signal: ctrl.signal });
        clearTimeout(t);
        if(!r.ok) return false;
        const j = await r.json();
        // Ada panoId ‚Üí Street View tersedia
        return !!(j && j.Location && j.Location.panoId);
      }catch(e){
        return false;
      }
    }

    async function openBestView(lat, lon){
      // Prioritaskan Street View jika ada; kalau tidak, buka tampak atas
      const hasSV = await probeStreetView(lat, lon);
      const url = hasSV ? svUrl(lat, lon) : mapTopDownUrl(lat, lon);
      window.open(url, '_blank');
    }

    function pickName(p){
      return (p?.NAMA && p.NAMA !== "Bendung") ? p.NAMA : (p?.N_ASET || "Bendung");
    }

    function setDetail(p, lat, lon){
      const nama = pickName(p);
      const di   = p?.N_DI || "-";
      const kew  = p?.KEWENANGAN || "-";
      infoEl.innerHTML = `
        <div style="font-size:14px"><b>${nama}</b></div>
        <div style="font-size:12px;color:#cbd5e1">DI: ${di}</div>
        <div style="font-size:12px;color:#cbd5e1">Kewenangan: ${kew}</div>
        <div style="font-size:12px;color:#cbd5e1">Koord: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
      `;
      lastLat = lat; lastLon = lon;
      btnSV.disabled = false;
    }

    btnSV.addEventListener('click', () => {
      if(lastLat!=null && lastLon!=null) openBestView(lastLat, lastLon);
    });

    // ===== Layers =====
    let pointLayer = null;
    const labelsLayer = L.layerGroup().addTo(map);
    let feats = []; // cache fitur buat label refresh

    // ===== Label refresher (declutter) =====
    function refreshLabels(){
      labelsLayer.clearLayers();
      const z = map.getZoom();
      if(z < 11) return;

      const items = feats.map(f=>{
        const [lon, lat] = f.geometry.coordinates;
        return { lat, lon, nama: pickName(f.properties||{}) };
      });

      if(z >= 15){
        for(const it of items){
          labelsLayer.addLayer(L.marker([it.lat, it.lon], {
            icon: L.divIcon({ className:'lbl', html:`<span>${it.nama}</span>`, iconSize:[0,0], iconAnchor:[-6,-6]}),
            interactive:false
          }));
        }
        return;
      }

      const cellSize = (z >= 14) ? 80 : (z >= 13 ? 110 : 140);
      const used = new Set();
      const ctr = map.getCenter();
      items.sort((a,b)=>{
        const da = Math.abs(a.lat-ctr.lat)+Math.abs(a.lon-ctr.lng);
        const db = Math.abs(b.lat-ctr.lat)+Math.abs(b.lon-ctr.lng);
        return da - db;
      });

      for(const it of items){
        const pt = map.latLngToContainerPoint([it.lat, it.lon]);
        const cx = Math.floor(pt.x / cellSize);
        const cy = Math.floor(pt.y / cellSize);
        const key = cx + ',' + cy;
        if(used.has(key)) continue;
        used.add(key);
        labelsLayer.addLayer(L.marker([it.lat, it.lon], {
          icon: L.divIcon({ className:'lbl', html:`<span>${it.nama}</span>`, iconSize:[0,0], iconAnchor:[-6,-6]}),
          interactive:false
        }));
      }
    }

    map.on('zoomend moveend', refreshLabels);

    // ===== Load GeoJSON & render =====
    fetch(DATA_URL)
      .then(async r=>{
        if(!r.ok) throw new Error('Gagal memuat GeoJSON');
        const ct=r.headers.get('content-type')||'';
        if(ct.includes('application/json')) return r.json();
        const txt=await r.text(); const s=txt.indexOf('{'), e=txt.lastIndexOf('}');
        return JSON.parse(txt.slice(s,e+1));
      })
      .then(gj=>{
        feats = (gj && gj.features) ? gj.features : [];
        if(!feats.length){
          infoEl.innerHTML='<span style="color:#fca5a5">Tidak ada fitur di file.</span>';
          return;
        }

        pointLayer = L.geoJSON(gj, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng, {
            radius: 7, color:'#0d9488', weight:1.5, fillColor:'#22c55e', fillOpacity:.95
          }),
          onEachFeature: (f, l) => {
            const [lon, lat] = f.geometry.coordinates;
            const p = f.properties || {};
            const nama = pickName(p);
            const di   = p?.N_DI || "-";
            l.bindPopup(`
              <div style="font-size:13px">
                <b>${nama}</b><br/>
                <span style="color:#94a3b8">${di}</span><br/>
                ${lat.toFixed(6)}, ${lon.toFixed(6)}<br/>
                <a href="#" class="sv-link" data-lat="${lat}" data-lon="${lon}" style="color:#1d5fd1;font-weight:700">üëÅÔ∏è Buka Google</a>
              </div>
            `);
            l.on('click', ()=> setDetail(p, lat, lon));
          }
        }).addTo(map);

        try{
          map.fitBounds(pointLayer.getBounds(), { maxZoom: 13, padding:[20,20] });
        }catch(e){
          const f0 = feats[0]; const [lon,lat]=f0.geometry.coordinates;
          map.setView([lat,lon], 14); setDetail(f0.properties||{}, lat, lon);
        }

        refreshLabels();
      })
      .catch(err=>{
        console.error(err);
        infoEl.innerHTML = '<span style="color:#fca5a5">Gagal memuat <code>bendung_brantas.geojson</code>.</span>';
      });

    // Delegasi klik link popup ‚Üí openBestView
    document.addEventListener('click', (ev)=>{
      const a = ev.target.closest('.sv-link');
      if(!a) return;
      ev.preventDefault();
      const lat = parseFloat(a.dataset.lat);
      const lon = parseFloat(a.dataset.lon);
      if(Number.isFinite(lat) && Number.isFinite(lon)) openBestView(lat, lon);
    });
  });
  </script>
</body>
</html>
