<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dashboard DI — SO_Integrasi × GeoJSON (Kd_Inf)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0; font-family: system-ui, Arial}
  #map {height: 100%}

  /* Bottom dock */
  .dock {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: #fff; border-top: 1px solid #ddd;
    max-height: 45vh; overflow: auto; padding: 10px 12px;
    box-shadow: 0 -8px 16px rgba(0,0,0,.06); z-index: 500;
  }
  .dock h2 {font-size: 14px; margin: 0 0 6px; font-weight: 700}
  .grid {display: grid; grid-template-columns: 1fr 1fr; gap: 8px}
  label {font-size: 12px; color:#333}
  select, input {width:100%; padding:8px; font-size: 14px}
  .meta {font-size: 13px; border-collapse: collapse; width: 100%}
  .meta td {border-bottom: 1px dashed #eee; padding: 4px 2px; vertical-align: top}
  .key {color:#666; width: 40%}
  .row {display:grid; grid-template-columns:1fr auto; gap:6px; font-size:13px}
  .err {color:#b00020; font-size:12px; margin-top:6px}
</style>
</head>
<body>
<div id="map"></div>

<div class="dock">
  <h2>Dashboard Daerah Irigasi</h2>

  <div class="grid">
    <div>
      <label>Pilih Daerah Irigasi</label>
      <select id="diSel"><option value="">— Semua —</option></select>
    </div>
    <div>
      <label>Cluster Informasi</label>
      <select id="clusterSel"><option value="__ALL__">— Semua —</option></select>
    </div>
  </div>

  <div id="msg" class="err"></div>
  <hr/>
  <div id="stats" class="row"></div>
  <div id="detail"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ========= KONFIG =========
const GEOJSON_URL = "LuasBaku_SerayuOpak_3.geojson";
const GAS_URL = "https://script.google.com/macros/s/AKfycbybsLoQu-8S-MlR_kB2989FZV0C-c1gRzUqcIZWBWuYb-_We03B_BShX8Q3AQqWhOTvzg/exec?sheet=SO_Integrasi&t=" + Date.now();

const diSel = document.getElementById('diSel');
const clusterSel = document.getElementById('clusterSel');
const statsEl = document.getElementById('stats');
const detailEl = document.getElementById('detail');
const msgEl = document.getElementById('msg');
function note(msg){ msgEl.textContent = msg || ""; }

const map = L.map('map').setView([-2,118], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);

let lookup={}, rows=[], groups={}, headers=[];
let geoLayer, joined=[];

// Tabel detail
function buildTable(obj, activeGroup){
  const useAll = (activeGroup==="__ALL__");
  const fields = useAll ? headers : (groups[activeGroup]||[]);
  const html = (fields||[])
    .filter(k => k && k!=="Kd_Inf")
    .map(k => {
      const v = obj[k];
      if (v===null || v===undefined || v==="") return "";
      return `<tr><td class="key">${k}</td><td>${v}</td></tr>`;
    }).join("");
  return `<table class="meta">${html || '<tr><td>(tidak ada data)</td></tr>'}</table>`;
}

// Normalisasi JSON GAS
function normalizeGas(json){
  if (json && json.lookup && json.rows && json.headers && json.groups) return json;
  let _rows = [];
  if (Array.isArray(json)) _rows = json;
  else if (json && Array.isArray(json.rows)) _rows = json.rows;
  else if (json && json.lookup) _rows = Object.values(json.lookup);
  const _headers = _rows.length ? Object.keys(_rows[0]) : [];
  const _groups  = {"Semua Kolom": _headers};
  return { rows:_rows, headers:_headers, groups:_groups, lookup:(json.lookup||makeLookup(_rows)) };
}
function makeLookup(arr){
  const out={}; (arr||[]).forEach(o=>{
    const key = String((o.Kd_Inf||"")).trim();
    if (key) out[key] = o;
  }); return out;
}

// ====== LOAD ======
Promise.all([
  fetch(GEOJSON_URL).then(r=>r.json()),
  fetch(GAS_URL).then(r=>r.json())
]).then(([gj, data])=>{
  const norm = normalizeGas(data);
  lookup = norm.lookup || {};
  rows   = norm.rows   || [];
  headers= norm.headers|| [];
  groups = norm.groups || {};

  // Cluster dropdown
  Object.keys(groups).forEach(g=>{
    clusterSel.insertAdjacentHTML('beforeend', `<option value="${g}">${g}</option>`);
  });

  // Isi Daerah Irigasi dropdown
  rows.forEach(o=>{
    if(o.Nama_DI){
      diSel.insertAdjacentHTML('beforeend', `<option value="${o.Nama_DI}">${o.Nama_DI}</option>`);
    }
  });

  // Layer
  geoLayer = L.geoJSON(gj, {
    style: f=>{
      const key = String((f.properties?.Kd_Inf||"")).trim();
      return { color:"#333", weight:1, fillColor:"#3388ff", fillOpacity:0.5 };
    },
   onEachFeature:(f,layer)=>{
  const key  = String((f.properties?.Kd_Inf||"")).trim();
  const info = lookup[key] || {};
  const title = info.Nama_DI || key || "(tanpa nama)";

  // POPUP: hanya Nama DI + Kd_Inf
  layer.bindPopup(`<b>${title}</b><br/>Kd_Inf: ${key}`);

  joined.push({ layer, key, nama:title.toLowerCase(), dataObj:info });
  layer.on('click', ()=> renderDetail(info, title, key)); // panel bawah tetap lengkap
}
  }).addTo(map);

  if (geoLayer.getLayers().length) map.fitBounds(geoLayer.getBounds());

  refreshView();
  detailEl.innerHTML = '<i>Tap/klik poligon di peta untuk lihat detail.</i>';
}).catch(err=>{
  console.error(err);
  note('Gagal load data. Cek nama sheet & Apps Script.');
});

function renderDetail(info, title, key){
  const g = clusterSel.value || "__ALL__";
  detailEl.innerHTML = `
    <h3 style="margin:6px 0">${title}</h3>
    <div style="font-size:12px;color:#666;margin-bottom:6px">Kd_Inf: ${key}</div>
    ${buildTable(info, g)}
  `;
}

function refreshView(){
  const selNama = diSel.value.toLowerCase();
  let total=0;
  joined.forEach(o=>{
    const match = !selNama || (o.nama===selNama.toLowerCase());
    o.layer.setStyle({opacity: match?1:0, fillOpacity: match?0.5:0});
    if (match) total++;
  });
  statsEl.innerHTML = `<span>Total DI tampil</span><b>${total}</b>`;
}

// Events
[diSel, clusterSel].forEach(el=>el.addEventListener('change', ()=>{
  refreshView();
  const line = detailEl.querySelector('div[style*="Kd_Inf"]');
  const key  = line ? (line.textContent.split(':').pop()||'').trim() : null;
  if (key && lookup[key]){
    renderDetail(lookup[key], lookup[key].Nama_DI || key, key);
  }
}));
</script>
</body>
</html>
