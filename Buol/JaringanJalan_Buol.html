<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Dinas Pekerjaan Umum Kabupaten Buol — Jaringan Jalan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0}
  #header { background:#FFD700; color:#000; padding:10px; display:flex; align-items:center; font-weight:700; font-size:14px }
  #header img {height:40px; margin-right:10px}
  #map {height:calc(100% - 110px)}
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc }

  /* Geser search ke kanan biar gak nabrak tombol zoom */
  .top-controls { position:absolute; top:60px; left:60px; right:10px; display:flex; gap:10px; z-index:1000 }
  .search-box { background:#fff; padding:6px 36px 6px 6px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.25); position:relative }
  .search-box input { width:300px; padding:6px 8px; border:1px solid #ddd; border-radius:4px }
  .search-box button.clear-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:22px; height:22px; border:none; border-radius:999px; cursor:pointer;
    background:#eee; font-weight:700; line-height:1; display:none;
  }
  .search-box button.clear-btn:hover{ background:#e2e2e2 }
  #suggestions { position:absolute; top:46px; left:0; right:0; background:#fff; border:1px solid #ddd; max-height:240px; overflow-y:auto; display:none; z-index:2000 }
  #suggestions div { padding:6px 8px; cursor:pointer }
  #suggestions div:hover { background:#eee }

  .legend { background:white; padding:8px 10px; line-height:1.6; font-size:12px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.2)}
  .swatch { display:inline-block; width:18px; height:0; margin-right:6px; vertical-align:middle; border-bottom: 4px solid #e53935; }

  /* Label nama jalan */
  .leaflet-tooltip.feature-label{
    font-weight:700; color:#111; background:rgba(255,255,255,.85);
    border:1px solid #ddd; padding:2px 4px;
  }
  .label-hidden{ opacity:0; pointer-events:none }
  .label-visible{ opacity:1 }

  /* geser control layers turun biar gak tabrakan dgn search */
  .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 70px; }
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  DINAS PEKERJAAN UMUM KABUPATEN BUOL — JARINGAN JALAN
</div>

<div class="top-controls">
  <div class="search-box">
    <input id="search" placeholder="Cari ruas (Nm_Ruas)..." oninput="onSearchInput(this.value)"/>
    <button id="clearBtn" class="clear-btn" title="Clear" onclick="clearSearch()">×</button>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===== KONFIG =====
const GEOJSON_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/Buol/Buol_JSon.geojson";
const DEFAULT_VIEW = [-1.5, 120.5];
const DEFAULT_ZOOM = 8;

// Label strategy:
// - zoom < SHOW_SOME_ZOOM  : hide all
// - SHOW_SOME_ZOOM..SHOW_ALL_ZOOM-1 : show subset (top N longest within view)
// - zoom >= SHOW_ALL_ZOOM : show all
const SHOW_SOME_ZOOM = 14;
const SHOW_ALL_ZOOM  = 17;
const MAX_LABELS     = 10; // berapa label yang tampil saat zoom menengah

// ===== PETA =====
const map = L.map('map', { zoomControl:true }).setView(DEFAULT_VIEW, DEFAULT_ZOOM);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap' }).addTo(map);
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'Tiles &copy; Esri — Esri, Maxar, Earthstar Geographics' });
const esriTopo    = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'Tiles &copy; Esri — World Topo Map' });
const esriLabels  = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'Labels &copy; Esri — Boundaries & Places' });

L.control.layers(
  { "OSM Standard": osm, "Esri World Imagery (Citra)": esriImagery, "Esri Topographic": esriTopo },
  { "Esri Labels (nama tempat)": esriLabels },
  { position:'topright', collapsed:false }
).addTo(map);

// ===== UTIL & STYLE =====
const prop = (o,k)=> (o&&o[k]!=null&&String(o[k]).trim()!=="")? String(o[k]).trim() : "";

/* garis merah, weight beda per Fungsi */
function weightByFungsi(f){
  if(!f) return 3.5;
  const s = f.toLowerCase();
  if(/arteri\s*primer/.test(s))      return 6;
  if(/kolektor/.test(s))             return 4.5;
  if(/lingkungan\s*primer/.test(s))  return 4;
  if(/lokal\s*sekunder/.test(s))     return 3.5;
  if(/lingkungan\s*sekunder/.test(s))return 2.8;
  return 3.5;
}
function styleLine(p){
  const fg = (p.Fungsi ?? p.fungsi ?? "").toString();
  return { color:"#e53935", weight: weightByFungsi(fg), opacity:0.95 };
}
function highlight(e){ const l=e.target; l.setStyle({weight: Math.max((l.options.weight||3.5)+2, 6.5), opacity:1}); l.bringToFront(); }
function resetHighlight(e){ const l=e.target; lines.resetStyle(l); }

// Haversine meter
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = d => d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// ===== LAYERS & INDEX =====
const index = [];
let fullBounds = null;
const labelMeta = []; // {layer, name, tooltip, lengthM}

const lines = L.geoJSON(null, {
  style: f => styleLine(f.properties||{}),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    // Nama + prefix "Jl."
    let nama = prop(p,"Nm_Ruas") || prop(p,"Nama") || prop(p,"name") || "Tanpa Nama";
    if(!/^(\s*Jl\.|\s*Jalan)/i.test(nama)) nama = "Jl. " + nama;

    const propinsi = prop(p,"Propinsi") || prop(p,"Provinsi") || "-";
    const status = prop(p,"Status") || "-";
    const fungsi = prop(p,"Fungsi") || "-";
    const panjang = prop(p,"Panjang") || prop(p,"Panjang_Km") || "";
    const thn = prop(p,"Thn_Data") || "-";
    const mendukung = prop(p,"Mendukung") || "-";
    const ura = prop(p,"Ura_Dukung") || "-";

    const popup = `
      <b>${nama}</b><br>
      Propinsi: ${propinsi}<br>
      Status: ${status}<br>
      Fungsi: ${fungsi}<br>
      Panjang: ${panjang || "-"}<br>
      Tahun Data: ${thn}<br>
      Mendukung: ${mendukung}<br>
      Uraian: ${ura}
    `;
    layer.bindPopup(popup, {maxWidth: 360});

    // Tooltip label permanent (awal disembunyikan)
    const tt = layer.bindTooltip(nama, {direction:"center", permanent:true, className:"feature-label label-hidden"}).getTooltip();

    // Hitung panjang meter kasar (untuk prioritas saat menengah)
    const coords = (feature.geometry && feature.geometry.coordinates) || [];
    let len = 0;
    function sumLine(arr){
      for(let i=1;i<arr.length;i++){
        const [lon1,lat1] = arr[i-1], [lon2,lat2] = arr[i];
        len += haversine(lat1,lon1,lat2,lon2);
      }
    }
    if(feature.geometry.type === "LineString"){
      sumLine(coords);
    } else if(feature.geometry.type === "MultiLineString"){
      coords.forEach(sumLine);
    }

    labelMeta.push({ layer, name: nama, tooltip: tt, lengthM: len });

    layer.on({
      mouseover: highlight,
      mouseout: resetHighlight,
      click: () => { try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(e){} }
    });

    index.push({ name: nama, layer });
  }
}).addTo(map);

const points = L.geoJSON(null).addTo(map);

// ===== LOAD GEOJSON =====
fetch(GEOJSON_URL)
  .then(r => { if(!r.ok) throw new Error("Gagal memuat GeoJSON"); return r.json(); })
  .then(gj => {
    const feats = (gj && gj.features) ? gj.features : [];
    const lineFeats  = feats.filter(f => ["LineString","MultiLineString"].includes((f.geometry||{}).type));
    const pointFeats = feats.filter(f => (f.geometry||{}).type==="Point");

    lines.addData({type:"FeatureCollection", features: lineFeats});
    points.addData({type:"FeatureCollection", features: pointFeats});

    const group = L.featureGroup([lines, points]);
    try { fullBounds = group.getBounds(); map.fitBounds(fullBounds, {padding:[20,20]}); }
    catch(e){ map.setView(DEFAULT_VIEW, DEFAULT_ZOOM); }

    buildLegend(lineFeats);
    updateLabelVisibility();
  })
  .catch(err => { console.error(err); alert("Gagal memuat GeoJSON. Cek URL/format file."); });

// ===== LABEL VISIBILITY (tidak numpuk) =====
map.on('zoomend moveend', updateLabelVisibility);

function updateLabelVisibility(){
  const z = map.getZoom();
  const bounds = map.getBounds();

  // helper show/hide
  const hideAll = () => labelMeta.forEach(m=>{
    const el = m.tooltip && m.tooltip.getElement(); if(el){ el.classList.add('label-hidden'); el.classList.remove('label-visible'); }
  });
  const showSet = (subset) => subset.forEach(m=>{
    const el = m.tooltip && m.tooltip.getElement(); if(el){ el.classList.remove('label-hidden'); el.classList.add('label-visible'); }
  });

  if(z < SHOW_SOME_ZOOM){
    hideAll(); // terlalu jauh
    return;
  }

  if(z >= SHOW_ALL_ZOOM){
    // tampilkan semua yang onscreen; yang di luar layar biarin hidden
    hideAll();
    const onscreen = labelMeta.filter(m=> m.layer.getBounds && bounds.intersects(m.layer.getBounds()));
    showSet(onscreen);
    return;
  }

  // zoom menengah: tampilkan sebagian (top N panjang dalam layar)
  hideAll();
  const onscreen = labelMeta.filter(m=> m.layer.getBounds && bounds.intersects(m.layer.getBounds()));
  onscreen.sort((a,b)=> b.lengthM - a.lengthM);
  showSet(onscreen.slice(0, MAX_LABELS));
}

// ===== LEGEND (tebal garis per Fungsi, semua merah) =====
function buildLegend(lineFeats){
  const list = Array.from(new Set(lineFeats.map(f => (f.properties||{}).Fungsi).filter(Boolean)));
  if(!list.length) return;
  const legend = L.control({position:"bottomright"});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<b>Fungsi</b><br/>' + list.map(fg => {
      const w = weightByFungsi(String(fg));
      return `<span class="swatch" style="border-bottom:${w}px solid #e53935"></span>${fg}`;
    }).join('<br/>');
    return div;
  };
  legend.addTo(map);
}

// ===== SEARCH (dengan tombol clear) =====
function onSearchInput(q){
  const clearBtn = document.getElementById('clearBtn');
  clearBtn.style.display = q && q.length ? 'block' : 'none';
  showSuggestions(q);
}

function clearSearch(){
  const inp = document.getElementById('search');
  const box = document.getElementById('suggestions');
  inp.value = "";
  box.innerHTML = "";
  box.style.display = "none";
  document.getElementById('clearBtn').style.display = 'none';
  if(fullBounds){ map.fitBounds(fullBounds, {padding:[20,20]}); }
}

function showSuggestions(q){
  const box=document.getElementById('suggestions');
  box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index
    .filter(it => it.name && it.name.toLowerCase().includes(q.toLowerCase()))
    .slice(0,100);

  hits.forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ 
      document.getElementById('search').value=it.name; 
      document.getElementById('clearBtn').style.display='block';
      box.style.display="none";
      try { map.fitBounds(it.layer.getBounds(), {padding:[20,20]}); }
      catch(e){ if(it.layer.getLatLng) map.setView(it.layer.getLatLng(), 14); }
      it.layer.openPopup && it.layer.openPopup();
    };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}
</script>
</body>
</html>
