<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>PDinas Pekerjaan Umum Kabupaten Buol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0}
  #header { background:#FFD700; color:#000; padding:10px; display:flex; align-items:center; font-weight:700; font-size:14px }
  #header img {height:40px; margin-right:10px}
  #map {height:calc(100% - 110px)}
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc }

  .top-controls { position:absolute; top:60px; left:10px; right:10px; display:flex; gap:10px; z-index:1000 }
  .search-box { background:#fff; padding:6px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.25); position:relative }
  .search-box input { width:280px; padding:6px 8px; border:1px solid #ddd; border-radius:4px }
  #suggestions { position:absolute; top:46px; left:0; right:0; background:#fff; border:1px solid #ddd; max-height:240px; overflow-y:auto; display:none; z-index:2000 }
  #suggestions div { padding:6px 8px; cursor:pointer }
  #suggestions div:hover { background:#eee }

  .legend { background:white; padding:8px 10px; line-height:1.4; font-size:12px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.2)}
  .legend i { width:14px; height:14px; float:left; margin-right:6px; opacity:0.9; border-radius:2px }

  /* Tooltip untuk label fitur */
  .leaflet-tooltip.feature-label{
    font-weight:700; color:#222; background:rgba(255,255,255,.85); border:1px solid #ddd
  }

  /* Pindahkan control layers sedikit turun biar gak nabrak search */
  .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 70px; }
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  Dinas Pekerjaan Umum Kabupaten Buol
</div>

<div class="top-controls">
  <div class="search-box">
    <input id="search" placeholder="Cari ruas (Nm_Ruas)..." oninput="showSuggestions(this.value)"/>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===== KONFIG =====
const GEOJSON_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/Buol_JSon.geojson"; // ganti jika perlu
const DEFAULT_VIEW = [-1.5, 120.5];
const DEFAULT_ZOOM = 8;

// ===== PETA & BASEMAPS =====
const map = L.map('map', { zoomControl:true }).setView(DEFAULT_VIEW, DEFAULT_ZOOM);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20, attribution: '&copy; OpenStreetMap'
}).addTo(map); // default on

const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 20,
  attribution: 'Tiles &copy; Esri — Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
});

const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 20,
  attribution: 'Tiles &copy; Esri — World Topo Map'
});

// Overlay label (opsional, bisa ditumpuk di atas imagery)
const esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 20,
  attribution: 'Labels &copy; Esri — World Boundaries and Places'
});

// Layers control
const baseLayers = {
  "OSM Standard": osm,
  "Esri World Imagery (Citra)": esriImagery,
  "Esri Topographic": esriTopo
};
const overlays = {
  "Esri Labels (nama tempat)": esriLabels
};
L.control.layers(baseLayers, overlays, { position:'topright', collapsed:false }).addTo(map);

function resetRoute(){ document.getElementById('route-info').innerHTML="Jarak &amp; Waktu tempuh akan muncul di sini"; }

// ===== UTIL =====
const prop = (o,k)=> (o&&o[k]!=null&&String(o[k]).trim()!=="")? String(o[k]).trim() : "";

const fungsiColors = [
  { match: /arteri|primer/i,        color: "#e53935" }, // merah
  { match: /kolektor/i,             color: "#1e88e5" }, // biru
  { match: /lokal|sekunder/i,       color: "#43a047" }, // hijau
  { match: /lingkungan|setempat/i,  color: "#8e24aa" }, // ungu
  { match: /lain|unknown|-/i,       color: "#757575" }  // abu
];
function colorByFungsi(fungsi){
  if(!fungsi) return "#757575";
  for (const r of fungsiColors){ if(r.match.test(fungsi)) return r.color; }
  return "#757575";
}
function styleLine(p){
  const fg = (p.Fungsi ?? p.fungsi ?? "").toString();
  return { color: colorByFungsi(fg), weight: 3.5, opacity: 0.95 };
}
function highlight(e){ const l=e.target; l.setStyle({weight:6, opacity:1}); l.bringToFront(); }
function resetHighlight(e){ const l=e.target; lines.resetStyle(l); }

// ===== LAYERS & INDEX =====
const index = [];

const lines = L.geoJSON(null, {
  style: f => styleLine(f.properties||{}),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    const nama = prop(p,"Nm_Ruas") || prop(p,"Nama") || prop(p,"name") || "Ruas";
    const propinsi = prop(p,"Propinsi") || prop(p,"Provinsi") || "-";
    const status = prop(p,"Status") || "-";
    const fungsi = prop(p,"Fungsi") || "-";
    const panjang = prop(p,"Panjang") || prop(p,"Panjang_Km") || "";
    const thn = prop(p,"Thn_Data") || "-";
    const mendukung = prop(p,"Mendukung") || "-";
    const ura = prop(p,"Ura_Dukung") || "-";

    const popup = `
      <b>${nama}</b><br>
      Propinsi: ${propinsi}<br>
      Status: ${status}<br>
      Fungsi: ${fungsi}<br>
      Panjang: ${panjang || "-"}<br>
      Tahun Data: ${thn}<br>
      Mendukung: ${mendukung}<br>
      Uraian: ${ura}
    `;
    layer.bindPopup(popup, {maxWidth: 360});
    layer.bindTooltip(nama, {direction:"center", permanent:false, className:"feature-label"});

    layer.on({
      mouseover: highlight,
      mouseout: resetHighlight,
      click: () => { try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(e){} }
    });

    index.push({ name: nama, layer });
  }
}).addTo(map);

const points = L.geoJSON(null, {
  pointToLayer: (feat, latlng) => L.circleMarker(latlng, {radius:6, color:"#1565c0", fillColor:"#42a5f5", fillOpacity:.85, weight:2}),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    const nm = prop(p,"nama_di") || prop(p,"Nama") || prop(p,"name") || "Lokasi";
    layer.bindPopup(`<b>${nm}</b>`);
    index.push({ name: nm, layer });
  }
}).addTo(map);

// ===== LOAD GEOJSON =====
fetch(GEOJSON_URL)
  .then(r => { if(!r.ok) throw new Error("Gagal memuat GeoJSON"); return r.json(); })
  .then(gj => {
    const feats = (gj && gj.features) ? gj.features : [];
    const lineFeats = feats.filter(f => {
      const t = (f.geometry||{}).type;
      return t==="LineString" || t==="MultiLineString";
    });
    const pointFeats = feats.filter(f => (f.geometry||{}).type==="Point");

    lines.addData({type:"FeatureCollection", features: lineFeats});
    points.addData({type:"FeatureCollection", features: pointFeats});

    const group = L.featureGroup([lines, points]);
    try { map.fitBounds(group.getBounds(), {padding:[20,20]}); }
    catch(e){ map.setView(DEFAULT_VIEW, DEFAULT_ZOOM); }

    buildLegendFromData(lineFeats);
  })
  .catch(err => { console.error(err); alert("Gagal memuat GeoJSON. Cek URL/format file."); });

// ===== LEGEND DINAMIS (berdasarkan Fungsi) =====
function buildLegendFromData(lineFeats){
  const fungsis = Array.from(new Set(
    lineFeats.map(f => (f.properties||{}).Fungsi).filter(Boolean)
  ));
  if(!fungsis.length) return;

  const legend = L.control({position:"bottomright"});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<b>Fungsi</b><br/>' + fungsis.map(fg => {
      const c = colorByFungsi(fg);
      return `<i style="background:${c}"></i>${fg}`;
    }).join('<br/>');
    return div;
  };
  legend.addTo(map);
}

// ===== SEARCH =====
function showSuggestions(q){
  const box = document.getElementById('suggestions');
  box.innerHTML = "";
  if(!q){ box.style.display="none"; return; }
  const hits = index
    .filter(it => it.name && it.name.toLowerCase().includes(q.toLowerCase()))
    .slice(0,100);

  hits.forEach(it => {
    const d = document.createElement('div');
    d.textContent = it.name;
    d.onclick = () => {
      document.getElementById('search').value = it.name;
      box.style.display="none";
      try { map.fitBounds(it.layer.getBounds(), {padding:[20,20]}); }
      catch(e){ if(it.layer.getLatLng) map.setView(it.layer.getLatLng(), 14); }
      it.layer.openPopup && it.layer.openPopup();
    };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}
</script>
</body>
</html>
