<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Jaringan Jalan Kabupaten Konawe Utara</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0}
  #header { background:#FFD700; color:#000; padding:10px; display:flex; align-items:center; font-weight:700; font-size:14px }
  #header img {height:40px; margin-right:10px}
  #map {height:calc(100% - 110px)}
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc }

  .top-controls { position:absolute; top:60px; left:60px; right:10px; display:flex; gap:10px; z-index:1000 }
  .search-box { background:#fff; padding:6px 36px 6px 6px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.25); position:relative }
  .search-box input { width:300px; padding:6px 8px; border:1px solid #ddd; border-radius:4px }
  .search-box button.clear-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:22px; height:22px; border:none; border-radius:999px; cursor:pointer;
    background:#eee; font-weight:700; line-height:1; display:none;
  }
  .search-box button.clear-btn:hover{ background:#e2e2e2 }
  #suggestions { position:absolute; top:46px; left:0; right:0; background:#fff; border:1px solid #ddd; max-height:240px; overflow-y:auto; display:none; z-index:2000 }
  #suggestions div { padding:6px 8px; cursor:pointer }
  #suggestions div:hover { background:#eee }

  .legend { background:white; padding:8px 10px; line-height:1.6; font-size:12px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.2)}
  .swatch { display:inline-block; width:18px; height:0; margin-right:6px; vertical-align:middle; border-bottom: 4px solid #e53935; }

  .leaflet-tooltip.feature-label{
    font-weight:700; color:#111; background:rgba(255,255,255,.85);
    border:1px solid #ddd; padding:2px 4px;
  }
  .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 70px; }
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  WEBGIS JARINGAN JALAN - DINAS PEKERJAAN UMUM KABUPATEN KONAWE UTARA
</div>

<div class="top-controls">
  <div class="search-box">
    <input id="search" placeholder="Cari ruas (Nm_Ruas)..." oninput="onSearchInput(this.value)"/>
    <button id="clearBtn" class="clear-btn" title="Clear" onclick="clearSearch()">Ã—</button>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ===== KONFIG =====
const GEOJSON_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/Konut/KonaweUtara_JalanKabupaten.geojson";
const DEFAULT_VIEW = [-1.5, 120.5];
const DEFAULT_ZOOM = 8;

// Label strategy (KETAT)
const SHOW_SOME_ZOOM = 14;    // < ini = 0 label
const SHOW_ALL_ZOOM  = 18;    // >= ini = lebih banyak (tetap declutter)
const MAX_LABELS     = 8;     // jumlah label saat zoom menengah
const MIN_LABEL_DIST_PX = 140; // jarak min antar label
const MIN_SCREEN_LEN_PX = 180; // ruas min panjang (px) agar layak dilabeli

// ===== PETA =====
const map = L.map('map', { zoomControl:true }).setView(DEFAULT_VIEW, DEFAULT_ZOOM);

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap' }).addTo(map);
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'&copy; Esri, Maxar' });
const esriTopo    = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'&copy; Esri' });
const esriLabels  = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom:20, attribution:'&copy; Esri' });

L.control.layers(
  { "OSM Standard": osm, "Esri World Imagery (Citra)": esriImagery, "Esri Topographic": esriTopo },
  { "Esri Labels (nama tempat)": esriLabels },
  { position:'topright', collapsed:false }
).addTo(map);

// ===== UTIL & STYLE =====
const prop = (o,k)=> (o&&o[k]!=null&&String(o[k]).trim()!=="")? String(o[k]).trim() : "";

/* garis merah, weight beda per Fungsi */
function weightByFungsi(f){
  if(!f) return 3.5;
  const s = f.toLowerCase();
  if(/arteri\s*primer/.test(s))      return 6;
  if(/kolektor/.test(s))             return 4.5;
  if(/lingkungan\s*primer/.test(s))  return 4;
  if(/lokal\s*sekunder/.test(s))     return 3.5;
  if(/lingkungan\s*sekunder/.test(s))return 2.8;
  return 3.5;
}
function styleLine(p){
  const fg = (p.Fungsi ?? p.fungsi ?? "").toString();
  return { color:"#e53935", weight: weightByFungsi(fg), opacity:0.95 };
}
function highlight(e){ const l=e.target; l.setStyle({weight: Math.max((l.options.weight||3.5)+2, 6.5), opacity:1}); l.bringToFront(); }
function resetHighlight(e){ const l=e.target; lines.resetStyle(l); }

// Haversine meter
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = d => d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// ===== LAYERS & INDEX =====
const index = [];
let fullBounds = null;

// metadata tiap ruas
const metas = []; // { layer, name, lengthM, tooltipCreated:false }

const lines = L.geoJSON(null, {
  style: f => styleLine(f.properties||{}),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    let nama = prop(p,"Nm_Ruas") || prop(p,"Nama") || prop(p,"name") || "Tanpa Nama";
    if(!/^(\s*Jl\.|\s*Jalan)/i.test(nama)) nama = "Jl. " + nama;

    const propinsi = prop(p,"Propinsi") || prop(p,"Provinsi") || "-";
    const status   = prop(p,"Status")   || "-";
    const fungsi   = prop(p,"Fungsi")   || "-";
    const panjang  = prop(p,"Panjang")  || prop(p,"Panjang_Km") || "";
    const thn      = prop(p,"Thn_Data") || "-";
    const mendukung= prop(p,"Mendukung")|| "-";
    const ura      = prop(p,"Ura_Dukung") || "-";

    const popup = `
      <b>${nama}</b><br>
      Propinsi: ${propinsi}<br>
      Status: ${status}<br>
      Fungsi: ${fungsi}<br>
      Panjang: ${panjang || "-"}<br>
      Tahun Data: ${thn}<br>
      Mendukung: ${mendukung}<br>
      Uraian: ${ura}
    `;
    layer.bindPopup(popup, {maxWidth: 360});

    // hitung panjang (prioritas)
    const coords = (feature.geometry && feature.geometry.coordinates) || [];
    let len = 0;
    function sumLine(arr){
      for(let i=1;i<arr.length;i++){
        const [lon1,lat1] = arr[i-1], [lon2,lat2] = arr[i];
        len += haversine(lat1,lon1,lat2,lon2);
      }
    }
    if(feature.geometry.type === "LineString"){ sumLine(coords); }
    else if(feature.geometry.type === "MultiLineString"){ coords.forEach(sumLine); }

    metas.push({ layer, name:nama, lengthM:len, tooltipCreated:false });

    layer.on({
      mouseover: highlight,
      mouseout: resetHighlight,
      click: () => { try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(e){} }
    });

    index.push({ name:nama, layer });
  }
}).addTo(map);

const points = L.geoJSON(null).addTo(map);

// ===== LOAD GEOJSON =====
fetch(GEOJSON_URL)
  .then(r => { if(!r.ok) throw new Error("Gagal memuat GeoJSON"); return r.json(); })
  .then(gj => {
    const feats = (gj && gj.features) ? gj.features : [];
    const lineFeats  = feats.filter(f => ["LineString","MultiLineString"].includes((f.geometry||{}).type));
    const pointFeats = feats.filter(f => (f.geometry||{}).type==="Point");

    lines.addData({type:"FeatureCollection", features: lineFeats});
    points.addData({type:"FeatureCollection", features: pointFeats});

    const group = L.featureGroup([lines, points]);
    try { fullBounds = group.getBounds(); map.fitBounds(fullBounds, {padding:[20,20]}); }
    catch(e){ map.setView(DEFAULT_VIEW, DEFAULT_ZOOM); }

    buildLegend(lineFeats);
    updateLabels(); // init
  })
  .catch(err => { console.error(err); alert("Gagal memuat GeoJSON. Cek URL/format file."); });

// ===== LABELS: CREATE/REMOVE DYNAMIC =====
map.on('zoomend moveend', updateLabels);
map.on('zoomstart', removeAllLabels);

function removeAllLabels(){
  metas.forEach(m => {
    if(m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated = false; }
  });
}

function updateLabels(){
  const z = map.getZoom();
  const bounds = map.getBounds();

  // tak ada label di zoom kecil
  if(z < SHOW_SOME_ZOOM){ removeAllLabels(); return; }

  // kandidat: on screen + cukup panjang di layar
  const candidates = metas.filter(m => {
    if(!m.layer.getBounds || !bounds.intersects(m.layer.getBounds())) return false;
    const pxLen = estimateScreenLengthPx(m.layer);
    return pxLen >= MIN_SCREEN_LEN_PX;
  }).sort((a,b)=> b.lengthM - a.lengthM);

  const chosen = [];
  const occupied = [];
  const limit = (z >= SHOW_ALL_ZOOM) ? Infinity : MAX_LABELS;

  for(const m of candidates){
    if(chosen.length >= limit) break;
    const pt = labelAnchorPx(m.layer);
    if(!pt) continue;
    let ok = true;
    for(const p of occupied){
      const dx = pt.x - p.x, dy = pt.y - p.y;
      if(Math.hypot(dx,dy) < MIN_LABEL_DIST_PX){ ok = false; break; }
    }
    if(ok){ occupied.push(pt); chosen.push(m); }
  }

  // apply: create for chosen, remove for others
  const chosenSet = new Set(chosen);
  metas.forEach(m => {
    const shouldShow = chosenSet.has(m);
    if(shouldShow && !m.tooltipCreated){
      m.layer.bindTooltip(m.name, {direction:"center", permanent:true, className:"feature-label"}); 
      m.tooltipCreated = true;
    } else if(!shouldShow && m.tooltipCreated){
      m.layer.unbindTooltip(); 
      m.tooltipCreated = false;
    }
  });
}

// Estimasi panjang ruas (px) di layar
function estimateScreenLengthPx(layer){
  const latlngs = layer.getLatLngs();
  if(!latlngs || !latlngs.length) return 0;
  const flat = flattenLatLngs(latlngs);
  let pxLen = 0;
  for(let i=1;i<flat.length;i++){
    const p1 = map.latLngToLayerPoint(flat[i-1]);
    const p2 = map.latLngToLayerPoint(flat[i]);
    pxLen += Math.hypot(p2.x - p1.x, p2.y - p1.y);
  }
  return pxLen;
}
function flattenLatLngs(arr){
  const out = [];
  (function walk(a){
    if(!a) return;
    if(Array.isArray(a) && a.length && 'lat' in a[0]){ a.forEach(v=> out.push(v)); }
    else if(Array.isArray(a)){ a.forEach(walk); }
  })(arr);
  return out;
}
function labelAnchorPx(layer){
  try{
    const c = layer.getBounds().getCenter();
    return map.latLngToLayerPoint(c);
  }catch(e){ return null; }
}

// ===== LEGEND (tebal garis per Fungsi, semua merah) =====
function buildLegend(lineFeats){
  const list = Array.from(new Set(lineFeats.map(f => (f.properties||{}).Fungsi).filter(Boolean)));
  if(!list.length) return;
  const legend = L.control({position:"bottomright"});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<b>Fungsi</b><br/>' + list.map(fg => {
      const w = weightByFungsi(String(fg));
      return `<span class="swatch" style="border-bottom:${w}px solid #e53935"></span>${fg}`;
    }).join('<br/>');
    return div;
  };
  legend.addTo(map);
}

// ===== SEARCH (dengan tombol clear) =====
function onSearchInput(q){
  document.getElementById('clearBtn').style.display = q && q.length ? 'block' : 'none';
  showSuggestions(q);
}
function clearSearch(){
  const inp = document.getElementById('search');
  const box = document.getElementById('suggestions');
  inp.value = ""; box.innerHTML = ""; box.style.display = "none";
  document.getElementById('clearBtn').style.display = 'none';
  if(fullBounds){ map.fitBounds(fullBounds, {padding:[20,20]}); }
}
function showSuggestions(q){
  const box=document.getElementById('suggestions');
  box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index
    .filter(it => it.name && it.name.toLowerCase().includes(q.toLowerCase()))
    .slice(0,100);
  hits.forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ 
      document.getElementById('search').value=it.name; 
      document.getElementById('clearBtn').style.display='block';
      box.style.display="none";
      try { map.fitBounds(it.layer.getBounds(), {padding:[20,20]}); }
      catch(e){ if(it.layer.getLatLng) map.setView(it.layer.getLatLng(), 14); }
      it.layer.openPopup && it.layer.openPopup();
    };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}
</script>
</body>
</html>
