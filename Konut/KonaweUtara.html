<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Jaringan Jalan Kabupaten Konawe Utara</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body {height:100%; margin:0}
  #header { background:#FFD700; color:#000; padding:10px; display:flex; align-items:center; font-weight:700; font-size:14px }
  #header img {height:40px; margin-right:10px}
  #map {height:calc(100% - 140px)} /* naik 30px karena ada hit counter */
  #route-info { background:#f9f9f9; padding:8px; font-size:14px; border-top:1px solid #ccc }

  .top-controls { position:absolute; top:60px; left:60px; right:10px; display:flex; gap:10px; z-index:1000 }
  .search-box { background:#fff; padding:6px 36px 6px 6px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.25); position:relative }
  .search-box input { width:300px; padding:6px 8px; border:1px solid #ddd; border-radius:4px }
  .search-box button.clear-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:22px; height:22px; border:none; border-radius:999px; cursor:pointer;
    background:#eee; font-weight:700; line-height:1; display:none;
  }
  .search-box button.clear-btn:hover{ background:#e2e2e2 }
  #suggestions { position:absolute; top:46px; left:0; right:0; background:#fff; border:1px solid #ddd; max-height:240px; overflow-y:auto; display:none; z-index:2000 }
  #suggestions div { padding:6px 8px; cursor:pointer }
  #suggestions div:hover { background:#eee }

  .legend { background:white; padding:8px 10px; line-height:1.6; font-size:12px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.2)}
  .swatch { display:inline-block; width:18px; height:0; margin-right:6px; vertical-align:middle; border-bottom: 4px solid #e53935; }

  .leaflet-tooltip.feature-label{
    font-weight:700; color:#111; background:rgba(255,255,255,.85);
    border:1px solid #ddd; padding:2px 4px;
  }
  .leaflet-top.leaflet-right .leaflet-control-layers { margin-top: 70px; }

  /* HIT COUNTER */
  #hit-counter {
    border-top:1px solid #e5e5e5; background:#fafafa; padding:10px 12px;
    font: 13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#333
  }
</style>
</head>
<body>
<div id="header">
  <img src="https://iconape.com/wp-content/png_logo_vector/pu-logo.png" alt="Logo PU">
  WEBGIS JARINGAN JALAN - DINAS PEKERJAAN UMUM KABUPATEN KONAWE UTARA
</div>

<div class="top-controls">
  <div class="search-box">
    <input id="search" placeholder="Cari ruas (Nm_Ruas)..." oninput="onSearchInput(this.value)"/>
    <button id="clearBtn" class="clear-btn" title="Clear" onclick="clearSearch()">√ó</button>
    <div id="suggestions"></div>
  </div>
</div>

<div id="map"></div>

<div id="route-info">Jarak &amp; Waktu tempuh akan muncul di sini</div>

<!-- === HIT COUNTER: tepat di bawah route-info === -->
<div id="hit-counter"><span>üëÅÔ∏è Memuat hit counter‚Ä¶</span></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ================== KONFIG ==================
const GEOJSON_URL = "https://raw.githubusercontent.com/irwan-dot-cyber/my-maps/main/Konut/KonaweUtara_JalanKabupaten.geojson";
const DEFAULT_VIEW = [-3.5, 122.0];
const DEFAULT_ZOOM = 9;

// Label strategy
const SHOW_SOME_ZOOM = 14;
const SHOW_ALL_ZOOM  = 18;
const MAX_LABELS     = 10;
const MIN_LABEL_DIST_PX = 140;
const MIN_SCREEN_LEN_PX = 180;

// ================== PETA ==================
const map = L.map('map', { zoomControl:true }).setView(DEFAULT_VIEW, DEFAULT_ZOOM);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom:20, attribution:'&copy; OpenStreetMap' }).addTo(map);
const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { maxZoom:20, attribution:'&copy; Esri, Maxar' });
const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
  { maxZoom:20, attribution:'&copy; Esri' });
const esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
  { maxZoom:20, attribution:'&copy; Esri' });

L.control.layers(
  { "OSM Standard": osm, "Esri World Imagery (Citra)": esriImagery, "Esri Topographic": esriTopo },
  { "Esri Labels (nama tempat)": esriLabels },
  { position:'topright', collapsed:false }
).addTo(map);

// ================== UTIL & STYLE ==================
const prop = (o,k)=> (o&&o[k]!=null&&String(o[k]).trim()!=="")? String(o[k]).trim() : "";

function weightByFungsi(f){
  if(!f) return 3.5;
  const s = f.toLowerCase();
  if(/arteri/.test(s))               return 6;
  if(/kolektor/.test(s))             return 4.8;
  if(/lingkungan\s*primer/.test(s))  return 4.2;
  if(/lingkungan\s*sekunder/.test(s))return 3.8;
  if(/lokal\s*primer/.test(s))       return 3.6;
  if(/lokal\s*sekunder/.test(s))     return 3.2;
  return 3.5;
}
function styleLine(p){
  const fg = prop(p,"Fungsi");
  return { color:"#e53935", weight: weightByFungsi(fg), opacity:0.95 };
}
function highlight(e){ const l=e.target; l.setStyle({weight: Math.max((l.options.weight||3.5)+2, 6.5), opacity:1}); l.bringToFront(); }
function resetHighlight(e){ const l=e.target; lines.resetStyle(l); }

// Haversine meter
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = d => d*Math.PI/180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

// ================== LAYERS & INDEX ==================
const index = [];
let fullBounds = null;
const metas = []; // { layer, name, lengthM, tooltipCreated:false }

const lines = L.geoJSON(null, {
  style: f => styleLine(f.properties||{}),
  onEachFeature: (feature, layer) => {
    const p = feature.properties || {};
    let nama = prop(p,"Nm_Ruas") || "Tanpa Nama";
    if(!/^(\s*Jl\.|\s*Jalan)/i.test(nama)) nama = "Jl. " + nama;

    const propinsi = prop(p,"Propinsi");
    const kabkot   = prop(p,"Kab_Kot");
    const kec      = prop(p,"Kecamatan");
    const desa     = prop(p,"Desa_Kel");
    const status   = prop(p,"Status");
    const fungsi   = prop(p,"Fungsi");
    const panjang  = prop(p,"Panjang");
    const thn      = prop(p,"Thn_Data");
    const mendukung= prop(p,"Mendukung");
    const ura      = prop(p,"Ura_Dukung");
    const tipeKeras= prop(p,"Tipe_Keras");
    const lhrt     = prop(p,"LHRT");
    const tipeJln  = prop(p,"Tipe_Jln");

    // Hitung panjang geodesik (fallback)
    const coords = (feature.geometry && feature.geometry.coordinates) || [];
    let len = 0;
    function sumLine(arr){
      for(let i=1;i<arr.length;i++){
        const [lon1,lat1] = arr[i-1], [lon2,lat2] = arr[i];
        len += haversine(lat1,lon1,lat2,lon2);
      }
    }
    if(feature.geometry.type === "LineString"){ sumLine(coords); }
    else if(feature.geometry.type === "MultiLineString"){ coords.forEach(sumLine); }

    const lenKmCalc = (len/1000).toFixed(3);
    const panjangShow = panjang ? `${panjang} km <small style="color:#666">(‚âà ${lenKmCalc} km kalkulasi)</small>` 
                                : `${lenKmCalc} km (kalkulasi)`;

    const popup = `
      <b>${nama}</b><br>
      Provinsi: ${propinsi || "-"}<br>
      Kab/Kota: ${kabkot || "-"}<br>
      Kecamatan: ${kec || "-"}<br>
      Desa/Kel: ${desa || "-"}<br>
      Status: ${status || "-"}<br>
      Fungsi: ${fungsi || "-"}<br>
      Tipe Permukaan: ${tipeKeras || "-"}<br>
      LHRT: ${lhrt || "-"} | Tipe_Jln: ${tipeJln || "-"}<br>
      Panjang: ${panjangShow}<br>
      Tahun Data: ${thn || "-"}<br>
      Mendukung: ${mendukung || "-"}<br>
      Uraian: ${ura || "-"}
    `;
    layer.bindPopup(popup, {maxWidth: 380});

    metas.push({ layer, name:nama, lengthM:len, tooltipCreated:false });

    layer.on({
      mouseover: highlight,
      mouseout: resetHighlight,
      click: () => { try{ map.fitBounds(layer.getBounds(), {padding:[20,20]}); }catch(e){} }
    });

    index.push({ name:nama, layer });
  }
}).addTo(map);

// ================== LOAD GEOJSON ==================
fetch(GEOJSON_URL)
  .then(r => { if(!r.ok) throw new Error("Gagal memuat GeoJSON"); return r.json(); })
  .then(gj => {
    const feats = (gj && gj.features) ? gj.features : [];
    const lineFeats  = feats.filter(f => ["LineString","MultiLineString"].includes((f.geometry||{}).type));
    lines.addData({type:"FeatureCollection", features: lineFeats});

    const group = L.featureGroup([lines]);
    try { fullBounds = group.getBounds(); map.fitBounds(fullBounds, {padding:[20,20]}); }
    catch(e){ map.setView(DEFAULT_VIEW, DEFAULT_ZOOM); }

    buildLegend(lineFeats);
    updateLabels(); // init
  })
  .catch(err => { console.error(err); alert("Gagal memuat GeoJSON. Cek URL/format file."); });

// ================== LABEL DINAMIS ==================
map.on('zoomend moveend', updateLabels);
map.on('zoomstart', removeAllLabels);

function removeAllLabels(){
  metas.forEach(m => {
    if(m.tooltipCreated){ m.layer.unbindTooltip(); m.tooltipCreated = false; }
  });
}

function updateLabels(){
  const z = map.getZoom();
  const bounds = map.getBounds();
  if(z < SHOW_SOME_ZOOM){ removeAllLabels(); return; }

  const candidates = metas.filter(m => {
    if(!m.layer.getBounds || !bounds.intersects(m.layer.getBounds())) return false;
    const pxLen = estimateScreenLengthPx(m.layer);
    return pxLen >= MIN_SCREEN_LEN_PX;
  }).sort((a,b)=> b.lengthM - a.lengthM);

  const chosen = [];
  const occupied = [];
  const limit = (z >= SHOW_ALL_ZOOM) ? Infinity : MAX_LABELS;

  for(const m of candidates){
    if(chosen.length >= limit) break;
    const pt = labelAnchorPx(m.layer);
    if(!pt) continue;
    let ok = true;
    for(const p of occupied){
      const dx = pt.x - p.x, dy = pt.y - p.y;
      if(Math.hypot(dx,dy) < MIN_LABEL_DIST_PX){ ok = false; break; }
    }
    if(ok){ occupied.push(pt); chosen.push(m); }
  }

  const chosenSet = new Set(chosen);
  metas.forEach(m => {
    const shouldShow = chosenSet.has(m);
    if(shouldShow && !m.tooltipCreated){
      m.layer.bindTooltip(m.name, {direction:"center", permanent:true, className:"feature-label"}); 
      m.tooltipCreated = true;
    } else if(!shouldShow && m.tooltipCreated){
      m.layer.unbindTooltip(); 
      m.tooltipCreated = false;
    }
  });
}

function estimateScreenLengthPx(layer){
  const latlngs = layer.getLatLngs();
  if(!latlngs || !latlngs.length) return 0;
  const flat = flattenLatLngs(latlngs);
  let pxLen = 0;
  for(let i=1;i<flat.length;i++){
    const p1 = map.latLngToLayerPoint(flat[i-1]);
    const p2 = map.latLngToLayerPoint(flat[i]);
    pxLen += Math.hypot(p2.x - p1.x, p2.y - p1.y);
  }
  return pxLen;
}
function flattenLatLngs(arr){
  const out = [];
  (function walk(a){
    if(!a) return;
    if(Array.isArray(a) && a.length && 'lat' in a[0]){ a.forEach(v=> out.push(v)); }
    else if(Array.isArray(a)){ a.forEach(walk); }
  })(arr);
  return out;
}
function labelAnchorPx(layer){
  try{
    const c = layer.getBounds().getCenter();
    return map.latLngToLayerPoint(c);
  }catch(e){ return null; }
}

// ================== LEGENDA ==================
function buildLegend(lineFeats){
  const list = Array.from(
    new Set(
      lineFeats.map(f => (f.properties||{}).Fungsi).filter(v => v!=null && String(v).trim()!=="")
    )
  ).sort();
  if(!list.length) return;
  const legend = L.control({position:"bottomright"});
  legend.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<b>Fungsi</b><br/>' + list.map(fg => {
      const w = weightByFungsi(String(fg));
      return `<span class="swatch" style="border-bottom:${w}px solid #e53935"></span>${fg}`;
    }).join('<br/>');
    return div;
  };
  legend.addTo(map);
}

// ================== SEARCH ==================
function onSearchInput(q){
  document.getElementById('clearBtn').style.display = q && q.length ? 'block' : 'none';
  showSuggestions(q);
}
function clearSearch(){
  const inp = document.getElementById('search');
  const box = document.getElementById('suggestions');
  inp.value = ""; box.innerHTML = ""; box.style.display = "none";
  document.getElementById('clearBtn').style.display = 'none';
  if(fullBounds){ map.fitBounds(fullBounds, {padding:[20,20]}); }
}
function showSuggestions(q){
  const box=document.getElementById('suggestions');
  box.innerHTML="";
  if(!q){ box.style.display="none"; return; }
  const hits=index
    .filter(it => it.name && it.name.toLowerCase().includes(q.toLowerCase()))
    .slice(0,100);
  hits.forEach(it=>{
    const d=document.createElement('div'); d.textContent=it.name;
    d.onclick=()=>{ 
      document.getElementById('search').value=it.name; 
      document.getElementById('clearBtn').style.display='block';
      box.style.display="none";
      try { map.fitBounds(it.layer.getBounds(), {padding:[20,20]}); }
      catch(e){ if(it.layer.getLatLng) map.setView(it.layer.getLatLng(), 14); }
      it.layer.openPopup && it.layer.openPopup();
    };
    box.appendChild(d);
  });
  box.style.display = hits.length ? "block" : "none";
}

// ================== HIT COUNTER (CountAPI + localStorage) ==================
(function(){
  const el = document.getElementById('hit-counter');

  const LS_KEY = 'konut_hit_local';
  const localHits = (parseInt(localStorage.getItem(LS_KEY) || '0', 10) || 0) + 1;
  localStorage.setItem(LS_KEY, String(localHits));

  const NS  = 'konut-jaringan-jalan'; // namespace bebas
  const KEY = encodeURIComponent(location.host + location.pathname);

  el.innerHTML = `üëÅÔ∏è <b>Perangkat ini:</b> ${localHits.toLocaleString('id-ID')} ‚Ä¢ <span style="color:#888">Total: memuat‚Ä¶</span>`;

  fetch(`https://api.countapi.xyz/hit/${NS}/${KEY}`)
    .then(r => r.json())
    .then(data => {
      const total = (data && typeof data.value === 'number') ? data.value : null;
      if (total !== null) {
        el.innerHTML = `üëÅÔ∏è <b>Total kunjungan:</b> ${total.toLocaleString('id-ID')} ‚Ä¢ <b>Perangkat ini:</b> ${localHits.toLocaleString('id-ID')}`;
      } else {
        throw new Error('No value');
      }
    })
    .catch(() => {
      el.innerHTML = `üëÅÔ∏è <b>Perangkat ini:</b> ${localHits.toLocaleString('id-ID')} ‚Ä¢ <span style="color:#888">Total: offline</span>`;
    });
})();
</script>
</body>
</html>
